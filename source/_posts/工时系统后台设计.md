---
title: 工时系统后台设计
date: 2024-01-24 11:17:47
tags:
password: 19980617pyr
categories: 项目
---

# 1. 需求 

E-TimeSheet是一套工时填报与管理系统, 。帮助员工轻松记录每日工作时间，同时为管理层提供实时的工时统计和分析, 开发了2个月左右。

是一个前后端分离项目，前端是用的vue2。后端是SpringCloud Netflix那一套， 数据库pgsql， mybatis plus, 使用docker进行的容器化部署。

1. 用户模块
   1. 用户AAD登录
   2. 增删改查
   3. 部门
   4. Report Group
   5. 代理 
2. 菜单模块
   1. 用户只能访问自己有权限的菜单
3. 项目模块
   1. 项⽬列表维护
   2. 项⽬⼈员维护： 每个项⽬可以增删改查下⾯的⽤户，⽤于后续⼯时填报时，只回显⾃⼰有权限的项⽬

1. 工时模块
   1. 按天填写，一天标准8小时，根据工作性质判断能否加班
   2. 项⽬列表只显示⾃⼰有权限的
   3. 根据审批状态，更新每个框状态
2. 审批模块
   1. PM审批
   2. SM审批
   3. 支持撤回，通过，拒绝
3. 报表模块

**效果预览**

![image-20250211210848941](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250211210848941.png)

![image-20250211210920432](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250211210920432.png)



![image-20250211210940255](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250211210940255.png)

# 2. 功能点

## 1. 工时审批

工程师填报工时后，PM(project manager)和SM(section manager)的审批。提前3天邮件提醒工程师填工时，以及通过拒绝后给工程师邮件（定时发邮件使用xxl job）

1. 用户每个月按天填报工时：涉及三张表

   - Hour_user: 记录用户ID以及年月，标识是哪个人哪天的工时
   - Hour_input_project: 因为填工时可以在多个项目上，与Hour_user是一对多, 需要hour_user_id, project_id, 
   - Hour_input_day: 记录不同project, 在哪一天，具体的工时数。 字段project_id, day, hour, hour_input_project_id,remark

   

![image-20250209205822170](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250209205822170.png)

2. 审批：

   我们有四个节点（明确几个节点，以及每个节点的处理人）

   - PM审批：PM
   - SM审批：SM
   - 被SM拒绝：Submitter
   - 被PM拒绝：Submitter

![image-20250209212922393](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250209212922393.png)

1. 方案一：状态机

   创建审批表记录，不同阶段的状态，以及审批人，审批时间 hour_audit， 在提交、审批后更新该表的状态

   ```
   1. hour_input_day
   
   - 工时保存
     - 改hour_input_day的状态->未提交
   - 用户提交
     - 改hour_input_day的状态->待PM审批
     - 改hour_audit的status ->待PM审批
       - 更新hour_audit 的hour_input_detail_id
       - 更新hour_audit 的approve_PM 
       - 更新hour_audit 的hour_input_id
       - 更新hour_audit 的approve_SM
   
   2. hour_audit
   
   - 状态包含: 待PM审批，待SM审批，审批通过，被PM拒绝，被SM拒绝
   - 拒绝逻辑
     - SM拒绝　－>　按人
     - PM拒绝　－>　按天
   
   - PM拒绝
   
     - 改day_hour_input的状态->被PM拒绝
   
     - 改hour_audit的status ->被PM拒绝
   
   - 查询PM to do : 
   
     - 当前status是待PM审批
     - approve PM 是current user的hour_input_detail , 同时需要join hour_input 和day_input
     - 查询的是对应年月份
   ```

   

2. 方案二：工作流

   使用camunda或idea自带的插件，绘制业务流程图，并保存为BPMN文件，在提交、审批后调用对应的方法：

   - 发起任务：aftersave 后通过消息队列发起流程 processBusinessKey : entityId
   - `taskService.complete ` 完成任务
   - `taskService.createTaskQuery` 查询任务， 如待办，已办
   - `taskService.setVariables` 设置变量: 如审批人

## 2.  组织架构变更

组织架构，人员信息等改变，影响报表统计。

创建一张 归档表：表里的字段包括user, department join的结果，包括部门名称等

当组织架构，人员等变更后，重新触发一次查询，并将结果存储

在报表的相关查询里，优先根据归档表的createTime以及选择的报表范围查询出当时的数据信息。

## 3. 日历设计

数据字典，存的是取反的日期，其余按正常工作日计算

## 3. 用户AAD 登录

1. 上microsoft 上注册APP， 获取clientId， authority， redirectUri

```typescript
export const msalConfig = {
    auth: {
        // 'Application (client) ID' of app registration in Azure portal - this value is a GUID
        clientId: "28a4bd39-37cf-49a6-bf35-57541999083f",
        // Full directory URL, in the form of https://login.microsoftonline.com/<tenant-id>
        authority: "https://login.microsoftonline.com/38ae3bcd-9579-00d4-adda-b42e1495d55a",
        // Full redirect URL, in form of http://localhost:3000
        redirectUri: "http://localhost:5001/login",
    },
};
```

2. 创建登录页面（例如：DingLogin.vue）  
      a. html: 转圈按钮（登录中）
      b. 页面初始化&前端访问/login， 跳转到microsoft 的AAD登录， 登录成功后，获得accessToken
3. 后端根据accessToken， 调用microsoft提供的接口，获取到AADUser对象
4. 后端根据email, 在我们系统中查询到user对象， 生成我们系统的jwt token， 存在redis 中
5. 前端访问带着这个jwt token，去redis查询user

⚠️ 注意：
- 后端设置 token 过期处理， 后端要是token过期，返回401
- 前端路由拦截器中清除本地数据并跳转登录页，再次触发AAD 登录
# 2. 整体表设计

![image-20250124142025094](https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250124142025094.png)

