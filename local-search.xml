<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>java中常见的数据交换对象</title>
    <link href="/java%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2%E5%AF%B9%E8%B1%A1/"/>
    <url>/java%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="1-常见的数据交换对象"><a href="#1-常见的数据交换对象" class="headerlink" title="1. 常见的数据交换对象"></a>1. 常见的数据交换对象</h1><h2 id="1-DTO"><a href="#1-DTO" class="headerlink" title="1. DTO"></a>1. DTO</h2><ol><li><strong>目的</strong>：用于服务层与外部系统（如前端、第三方服务）之间传输数据，通常是序列化的对象。</li><li><strong>特点</strong>：<ul><li>常作为 Controller 接口的请求&#x2F;响应参数</li><li>可以包含多个PO的组合数据。</li><li>字段不一定与数据库一致。</li><li>无业务逻辑</li></ul></li></ol><p>举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 用于向前端封装用户登录信息</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginDTO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 用于向前端返回用户信息（不包含密码）</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDTO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String nickName;<br>    <span class="hljs-keyword">private</span> String avatar;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">private</span> String roleName; <span class="hljs-comment">// 关联角色名</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-BO"><a href="#2-BO" class="headerlink" title="2. BO"></a>2. BO</h2><ol><li><strong>目的</strong>：封装业务逻辑或业务规则，用于服务层内部处理。</li><li><strong>特点</strong>：<ul><li>常在 Service 层中使用</li><li>可包含业务方法和业务校验逻辑</li><li>可能由多个DTO&#x2F;PO组合而成，用于Service层处理复杂业务。</li></ul></li></ol><p>举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 订单业务对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderBO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String orderId;<br>    <span class="hljs-keyword">private</span> BigDecimal amount;<br>    <span class="hljs-keyword">private</span> Integer itemCount;<br>    <span class="hljs-keyword">private</span> UserBO user; <span class="hljs-comment">// 用户信息</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderItemBO&gt; items;<br>    <span class="hljs-keyword">private</span> String discountRule;<br>    <span class="hljs-keyword">private</span> BigDecimal finalAmount;<br>    <span class="hljs-keyword">private</span> Boolean isOverdue;<br><br>    <span class="hljs-comment">// 业务方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">calculateTotal</span><span class="hljs-params">()</span> </span>&#123; ... &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyDiscount</span><span class="hljs-params">()</span> </span>&#123; ... &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// User service 接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ISysUserService</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">checkUserNameUnique</span><span class="hljs-params">(SysUserBo user)</span></span>;<br>  <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">checkPhoneUnique</span><span class="hljs-params">(SysUserBo user)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-PO"><a href="#3-PO" class="headerlink" title="3. PO"></a>3. PO</h2><ol><li><strong>目的</strong>：用于表示数据库中的实体，与表结构对应。</li><li>特点：<ul><li>一般与数据库字段一一对应</li><li>可被 ORM（如 MyBatis、JPA）直接映射</li><li>一般不包含业务逻辑。</li><li>常用于DAO层与数据库交互。</li></ul></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 对应数据库表 user</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserPO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br>    <span class="hljs-comment">// getter/setter</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>如果你的项目确实需要区分持久化对象和领域对象，可以考虑命名如 <code>UserPO</code> 或者 <code>UserEntity</code>，但更常见的做法是直接用 <code>User</code> 作为实体类名，并通过注解等方式来标记它是持久化的实体。</p></blockquote><h2 id="4-DO"><a href="#4-DO" class="headerlink" title="4. DO"></a>4. DO</h2><ol><li><p>目的：</p><ul><li><strong>DO &#x3D; Domain Object</strong>，领域对象</li><li>在<strong>领域驱动设计（DDD）</strong> 中使用，代表业务领域的核心模型，包含数据和行为。</li><li>在非DDD的项目中，PO 与 DO 有时可混用</li></ul></li><li><p>特点：</p><ul><li><p>是“充血模型”（有方法+属性）。</p></li><li><p>强调业务语义，如“下单”、“支付”等行为。</p></li><li><p>与PO可能结构不同。</p></li></ul></li></ol><blockquote><p>📌 DDD中，DO是核心，PO只是持久化载体。</p><p>通常直接命名为 <code>User</code>，因为它代表了业务领域的核心模型，包含了数据和相关的行为。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 领域对象：用户</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br>    <span class="hljs-comment">// 业务行为</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changePassword</span><span class="hljs-params">(String oldPwd, String newPwd)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!password.equals(DigestUtils.md5Hex(oldPwd))) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;原密码错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">this</span>.password = DigestUtils.md5Hex(newPwd);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isPremiumUser</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> createTime.isBefore(LocalDateTime.now().minusYears(<span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-VO"><a href="#5-VO" class="headerlink" title="5. VO"></a>5. VO</h2><ol><li><p><strong>目的</strong>：用于向前端展示数据，通常是页面展示的数据模型。</p></li><li><p><strong>特点</strong>：</p></li></ol><ul><li>通常包含经过组合或格式化的展示数据</li><li>不一定与数据库字段一一对应</li><li>有时会包含前端所需的额外字段，如状态名、格式化日期等</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserVO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> String createTimeFormatted; <span class="hljs-comment">// 格式化后的时间字符串</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-组合使用"><a href="#2-组合使用" class="headerlink" title="2. 组合使用"></a>2. 组合使用</h1><p>如果你在项目中使用的是 Spring Boot + MyBatis 或 JPA 的架构，通常会看到如下组合使用：</p><table><thead><tr><th>层级</th><th>使用对象</th><th>职责说明</th></tr></thead><tbody><tr><td>Controller</td><td><code>DTO</code>, <code>VO</code></td><td>接收请求参数（DTO）、返回响应（VO）</td></tr><tr><td>Service</td><td><code>BO</code>, <code>DTO</code></td><td>业务逻辑处理，DTO → BO → DO，DO → BO → VO</td></tr><tr><td>DAO &#x2F; Repository</td><td><code>DO</code></td><td>数据库操作，如增删改查</td></tr><tr><td>Entity (DB映射)</td><td><code>DO/PO</code></td><td>与数据库表对应的实体</td></tr></tbody></table><h2 id="1-前端提交请求（JSON）"><a href="#1-前端提交请求（JSON）" class="headerlink" title="1. 前端提交请求（JSON）"></a>1. 前端提交请求（JSON）</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /api/user/register<br>&#123;<br>  <span class="hljs-attr">&quot;username&quot;</span>: <span class="hljs-string">&quot;jack&quot;</span>,<br>  <span class="hljs-attr">&quot;email&quot;</span>: <span class="hljs-string">&quot;jack@example.com&quot;</span>,<br>  <span class="hljs-attr">&quot;password&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-Controller-层"><a href="#2-Controller-层" class="headerlink" title="2. Controller 层"></a>2. Controller 层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/register&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;UserVO&gt; <span class="hljs-title">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserRegisterDTO dto)</span> </span>&#123;<br>    UserVO vo = userService.register(dto);<br>    <span class="hljs-keyword">return</span> Result.success(vo);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>入参：<code>UserRegisterDTO</code></li><li>出参：<code>UserVO</code></li></ul><h2 id="3-Service-层"><a href="#3-Service-层" class="headerlink" title="3. Service 层"></a>3. Service 层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> UserVO <span class="hljs-title">register</span><span class="hljs-params">(UserRegisterDTO dto)</span> </span>&#123;<br>    <span class="hljs-comment">// DTO → BO</span><br>    UserBO bo = <span class="hljs-keyword">new</span> UserBO(dto.getUsername(), dto.getEmail(), dto.getPassword());<br><br>    <span class="hljs-comment">// 校验逻辑</span><br>    <span class="hljs-keyword">if</span> (!bo.isValidEmail()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BusinessException(<span class="hljs-string">&quot;邮箱不合法&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// BO → DO（保存）</span><br>    UserDO userDO = <span class="hljs-keyword">new</span> UserDO();<br>    BeanUtils.copyProperties(bo, userDO);<br>    userDao.insert(userDO);<br><br>    <span class="hljs-comment">// DO → VO（返回前端）</span><br>    UserVO vo = <span class="hljs-keyword">new</span> UserVO();<br>    BeanUtils.copyProperties(userDO, vo);<br>    <span class="hljs-keyword">return</span> vo;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-DAO-层（MyBatis-示例）"><a href="#4-DAO-层（MyBatis-示例）" class="headerlink" title="4. DAO 层（MyBatis 示例）"></a>4. DAO 层（MyBatis 示例）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDAO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(UserDO user)</span></span>;<br>    <span class="hljs-function">UserDO <span class="hljs-title">findByUsername</span><span class="hljs-params">(String username)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-UserDO-映射数据库表"><a href="#5-UserDO-映射数据库表" class="headerlink" title="5. UserDO 映射数据库表"></a>5. UserDO 映射数据库表</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDO</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> LocalDateTime createTime;<br>&#125;<br></code></pre></td></tr></table></figure><p>数据库表结构示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> (<br>    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,<br>    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),<br>    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),<br>    password <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),<br>    create_time DATETIME<br>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>LangChain4j之Embedding</title>
    <link href="/LangChain4j%E4%B9%8BEmbedding/"/>
    <url>/LangChain4j%E4%B9%8BEmbedding/</url>
    
    <content type="html"><![CDATA[<h1 id="1-什么是向量"><a href="#1-什么是向量" class="headerlink" title="1. 什么是向量"></a>1. 什么是向量</h1><p>一个二维向量可以理解为平面坐标轴中的一个坐标点(x，y)，在编程领域，一个二维向量就是一个大小为二的float类型的数组。</p><h1 id="2-文本向量化"><a href="#2-文本向量化" class="headerlink" title="2. 文本向量化"></a>2. 文本向量化</h1><p>文本向量化是指，利用大模型可以把一个字、一个词或一段话映射为一个多维向量。这样，我们可以基于向量来判断两句话之间的相似度。</p><p>我们可以直接在LangChain4j中来调用向量模型来对一句话进行向量化体验。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.data.embedding.Embedding;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.output.Response;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.zhipu.ZhipuAiEmbeddingModel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ZhipuAiEmbeddingModel embeddingModel = ZhipuAiEmbeddingModel.builder()<br>                .apiKey(<span class="hljs-string">&quot;xxx&quot;</span>)<br>                .build();<br><br>        Response&lt;Embedding&gt; embed = embeddingModel.embed(<span class="hljs-string">&quot;你好，我叫张三&quot;</span>);<br>        System.out.println(embed.content().toString());<br>        System.out.println(embed.content().vector().length);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250729195248503.png" alt="image-20250729195248503"></p><p>从结果可以知道”你好，我叫张三”这句话经过ZhipuAiEmbeddingModel向量化之后得到的一个长度为1024的float数组。</p><h1 id="3-向量数据库"><a href="#3-向量数据库" class="headerlink" title="3. 向量数据库"></a>3. 向量数据库</h1><p>对于向量模型生成出来的向量，我们可以持久化到向量数据库，并且能利用向量数据库来计算两个向量之间的相似度，或者根据一个向量查找跟这个向量最相似的向量。</p><p>在LangChain4j中，EmbeddingStore表示向量数据库，它有3个实现类：</p><ol><li><p>ChromaEmbeddingStore</p></li><li><p>InMemoryEmbeddingStore</p></li><li><p>RedisEmbeddingStore</p></li></ol><p>我们使用Redis来演示对于向量的增删查改</p><h2 id="3-1-使用Redis向量数据库"><a href="#3-1-使用Redis向量数据库" class="headerlink" title="3.1 使用Redis向量数据库"></a>3.1 使用Redis向量数据库</h2><h2 id="1-启动redis"><a href="#1-启动redis" class="headerlink" title="1. 启动redis"></a>1. 启动redis</h2><p>普通的Redis是不支持向量存储和查询的，需要额外的redisearch模块，这里直接使用docker来运行一个带有redisearch模块的redis容器的，命令为：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 6379:6379 docker.1ms.run/redis/redis-stack-server<br></code></pre></td></tr></table></figure><h2 id="2-添加依赖"><a href="#2-添加依赖" class="headerlink" title="2. 添加依赖"></a>2. 添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-代码存储"><a href="#3-代码存储" class="headerlink" title="3. 代码存储"></a>3. 代码存储</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">RedisEmbeddingStore embeddingStore = RedisEmbeddingStore.builder()<br>    .host(<span class="hljs-string">&quot;127.0.0.1&quot;</span>)<br>    .port(<span class="hljs-number">6379</span>)<br>    .dimension(<span class="hljs-number">1024</span>) <br>    .build();<br><br><span class="hljs-comment">// 生成向量</span><br>Response&lt;Embedding&gt; embed = embeddingModel.embed(<span class="hljs-string">&quot;我是张三&quot;</span>);<br><br><span class="hljs-comment">// 存储向量</span><br>embeddingStore.add(embed.content());<br></code></pre></td></tr></table></figure><blockquote><p>当你用 OpenAI、文心一言、HuggingFace 等模型生成 <strong>文本向量（embedding）</strong> 时，模型会输出一个 <strong>固定长度的浮点数组</strong>，这个数组的长度就是 <strong>向量维度dimension</strong></p><ul><li>dimension就是告诉 RedisEmbeddingStore：“我这个向量的长度是多少，存储的时候按这个维度来建索引”</li><li>可以使用以下命令来清空：<code>redis-cli FT.DROPINDEX embedding-index DD</code></li></ul></blockquote><h1 id="4-匹配向量"><a href="#4-匹配向量" class="headerlink" title="4. 匹配向量"></a>4. 匹配向量</h1><p>演示如何根据一个查询（“客服电话多少”）找到与之最相关的文本片段。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.data.embedding.Embedding;<br><span class="hljs-keyword">import</span> dev.langchain4j.data.segment.TextSegment;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.output.Response;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.zhipu.ZhipuAiEmbeddingModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.store.embedding.EmbeddingMatch;<br><span class="hljs-keyword">import</span> dev.langchain4j.store.embedding.redis.RedisEmbeddingStore;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">// 创建智谱AI的嵌入模型实例，使用提供的API密钥</span><br>        ZhipuAiEmbeddingModel embeddingModel = ZhipuAiEmbeddingModel.builder()<br>                .apiKey(<span class="hljs-string">&quot;xxx&quot;</span>)<br>                .build();<br>        <span class="hljs-comment">// 创建一个基于Redis的向量存储实例，配置为连接到本地运行的Redis服务器，端口6379，向量维度1024</span><br>        RedisEmbeddingStore embeddingStore = RedisEmbeddingStore.builder()<br>                .host(<span class="hljs-string">&quot;127.0.0.1&quot;</span>)<br>                .port(<span class="hljs-number">6379</span>)<br>                .dimension(<span class="hljs-number">1024</span>)<br>                .build();<br>        <span class="hljs-comment">// 创建三个文本片段</span><br>        TextSegment textSegment1 = TextSegment.textSegment(<span class="hljs-string">&quot;客服电话是400-8558558&quot;</span>);<br>        TextSegment textSegment2 = TextSegment.textSegment(<span class="hljs-string">&quot;客服工作时间是周一到周五&quot;</span>);<br>        TextSegment textSegment3 = TextSegment.textSegment(<span class="hljs-string">&quot;客服投诉电话是400-8668668&quot;</span>);<br>        <span class="hljs-comment">// 使用智谱AI的嵌入模型对这三个文本片段进行编码，得到它们的向量表示</span><br>        Response&lt;Embedding&gt; embed1 = embeddingModel.embed(textSegment1);<br>        Response&lt;Embedding&gt; embed2 = embeddingModel.embed(textSegment2);<br>        Response&lt;Embedding&gt; embed3 = embeddingModel.embed(textSegment3);<br>        <span class="hljs-comment">// 将这些向量及其对应的原始文本片段添加到Redis向量存储中</span><br>        embeddingStore.add(embed1.content(), textSegment1);<br>        embeddingStore.add(embed2.content(), textSegment2);<br>        embeddingStore.add(embed3.content(), textSegment3);<br>        <span class="hljs-comment">// 对查询文本“客服电话多少”也进行编码，得到其向量表示</span><br>        Response&lt;Embedding&gt; embed = embeddingModel.embed(<span class="hljs-string">&quot;客服电话多少&quot;</span>);<br>        <span class="hljs-comment">// 在Redis向量存储中查找与查询向量最相似的前5个文本片段</span><br>        List&lt;EmbeddingMatch&lt;TextSegment&gt;&gt; result = embeddingStore.findRelevant(embed.content(), <span class="hljs-number">5</span>);<br>        <span class="hljs-comment">// 输出结果：匹配的文本片段和它们的相似度分数</span><br>        <span class="hljs-keyword">for</span> (EmbeddingMatch&lt;TextSegment&gt; embeddingMatch : result) &#123;<br>            System.out.println(embeddingMatch.embedded().text() + <span class="hljs-string">&quot;,分数为：&quot;</span> + embeddingMatch.score());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出结果：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250729221221418.png" alt="image-20250729221221418" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>LangChain4j</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>LangChain4j之Tools</title>
    <link href="/LangChain4j%E4%B9%8BTools/"/>
    <url>/LangChain4j%E4%B9%8BTools/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Tools是什么？"><a href="#1-Tools是什么？" class="headerlink" title="1. Tools是什么？"></a>1. <strong>Tools是什么？</strong></h1><p>大模型Tools（工具）可以通过结构化接口将模型能力与现实世界操作连接。例如：</p><ul><li><strong>天气查询工具</strong>：封装天气API，接收城市参数后返回实时数据；</li><li><strong>数据库操作工具</strong>：将SQL查询转化为自然语言交互接口；</li><li><strong>代码执行工具</strong>：调用编译器或解释器完成代码调试。</li></ul><blockquote><p><strong>目前大模型的不足</strong>：大模型在解决问题时，是基于互联网上很多历史资料进行预测的，而且答案具有一定的随机性，那如果我问”今天是几月几号？”，大模型是大概率答错的，因为大模型肯定还没有来得及学习今天所产生的最新资料。</p></blockquote><h1 id="2-AiServices整合Tools"><a href="#2-AiServices整合Tools" class="headerlink" title="2. AiServices整合Tools"></a>2. AiServices整合Tools</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.collect.Lists;<br><span class="hljs-keyword">import</span> dev.langchain4j.agent.tool.Tool;<br><span class="hljs-keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.zhipu.ZhipuAiChatModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.AiServices;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.SystemMessage;<br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.ToString;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-meta">@ToString</span><br>    <span class="hljs-meta">@AllArgsConstructor</span><br>    <span class="hljs-meta">@NoArgsConstructor</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> String name;<br>        <span class="hljs-keyword">private</span> Integer age;<br>        <span class="hljs-keyword">private</span> String createTime;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTools</span> </span>&#123;<br><br>        <span class="hljs-meta">@Tool(&quot;用来获取今天具体日期&quot;)</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">dateUtil</span><span class="hljs-params">(String onUse)</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> LocalDateTime.now().toString();<br>        &#125;<br><br>        <span class="hljs-meta">@Tool(&quot;获取指定日期的用户信息&quot;)</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUserInfo</span><span class="hljs-params">(String date)</span> </span>&#123;<br>            User user1 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-number">88</span>, LocalDateTime.now().toLocalDate().toString());<br>            User user2 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;李四&quot;</span>, <span class="hljs-number">99</span>, <span class="hljs-string">&quot;2021-07-23&quot;</span>);<br>            <span class="hljs-keyword">return</span> Lists.newArrayList(user1, user2).stream()<br>                    .filter(u -&gt; LocalDate.parse(u.createTime).equals(LocalDate.parse(date)))<br>                    .toList().toString();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserService</span> </span>&#123;<br>        <span class="hljs-meta">@SystemMessage(&quot;先获取当前具体的日期，然后再解决用户问题&quot;)</span><br>        <span class="hljs-function">String <span class="hljs-title">getUserInfo</span><span class="hljs-params">(String desc)</span></span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;<br>        ChatLanguageModel model = ZhipuAiChatModel<br>                .builder()<br>                .apiKey(<span class="hljs-string">&quot;5b755da0b2b04a8c9ba449808b72a474.uaEUl7Tim6xXHghK&quot;</span>)<br>                .build();<br><br>        UserService userService = AiServices.builder(UserService.class).chatLanguageModel(model)<br>                .tools(<span class="hljs-keyword">new</span> MyTools())<br>                .chatMemory(MessageWindowChatMemory.withMaxMessages(<span class="hljs-number">10</span>))<br>                .build();<br><br>        String userInfo = userService.getUserInfo(<span class="hljs-string">&quot;获取今天注册的用户信息&quot;</span>);<br>        System.out.println(userInfo);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>返回结果：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250723221332643.png" alt="image-20250723221332643"></p>]]></content>
    
    
    <categories>
      
      <category>LangChain4j</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>LangChain4j之ChatMemory</title>
    <link href="/LangChain4j%E4%B9%8BChatMemory/"/>
    <url>/LangChain4j%E4%B9%8BChatMemory/</url>
    
    <content type="html"><![CDATA[<h1 id="1-ChatMemory是什么？"><a href="#1-ChatMemory是什么？" class="headerlink" title="1. ChatMemory是什么？"></a>1. <strong>ChatMemory</strong>是什么？</h1><p>ChatMemory是LangChain4j提供的用来存储历史对话的组件，并且还支持窗口限制、淘汰机制、持久化机制等等扩展功能。</p><h1 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h1><h2 id="1-基本使用"><a href="#1-基本使用" class="headerlink" title="1. 基本使用"></a>1. 基本使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.memory.ChatMemory;<br><span class="hljs-keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.zhipu.ZhipuAiChatModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.AiServices;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.UserMessage;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br><br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">NamingMaster</span> </span>&#123;<br>        <span class="hljs-function">String <span class="hljs-title">name</span><span class="hljs-params">(<span class="hljs-meta">@UserMessage</span> String desc)</span></span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        ChatLanguageModel model = ZhipuAiChatModel<br>                .builder()<br>                .apiKey(<span class="hljs-string">&quot;xxx&quot;</span>)<br>                .build();<br><br>        ChatMemory chatMemory = MessageWindowChatMemory.withMaxMessages(<span class="hljs-number">10</span>);<br><br>        NamingMaster namingMaster = AiServices.builder(NamingMaster.class).chatLanguageModel(model)<br>                .chatMemory(chatMemory)<br>                .build();<br><br>        String name = namingMaster.name(<span class="hljs-string">&quot;给我一个姓王男孩名字，不用解释&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;===========================第一次返回=====================================&quot;</span>);<br>        System.out.println(name);<br><br>        String name2 = namingMaster.name(<span class="hljs-string">&quot;换一个&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;===========================第二次返回=====================================&quot;</span>);<br>        System.out.println(name2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>返回结果：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250721202648342.png" alt="image-20250721202648342" style="zoom:50%;" /><h2 id="2-基于MemoryId"><a href="#2-基于MemoryId" class="headerlink" title="2. 基于MemoryId"></a>2. 基于MemoryId</h2><p>上面的代码，一个用户使用没有问题，但如果多个用户使用的是同一个ChatMemory，那就会出现这多个用户的对话记录混杂在一起的问题。</p><p>因此，需要改造一下AiServices中设置ChatMemory的方式，让每个不同的userId对应不同的ChatMemory对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.memory.chat.TokenWindowChatMemory;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.openai.OpenAiTokenizer;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.zhipu.ZhipuAiChatModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.AiServices;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.MemoryId;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.UserMessage;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br><br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">NamingMaster</span> </span>&#123;<br>        <span class="hljs-function">String <span class="hljs-title">name</span><span class="hljs-params">(<span class="hljs-meta">@MemoryId</span> String userId, <span class="hljs-meta">@UserMessage</span> String desc)</span></span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ChatLanguageModel model = ZhipuAiChatModel<br>                .builder()<br>                .apiKey(<span class="hljs-string">&quot;xxx&quot;</span>)<br>                .build();<br><br>        NamingMaster namingMaster = AiServices.builder(NamingMaster.class).chatLanguageModel(model)<br>                <span class="hljs-comment">//限制会话历史记录的最大token数为10000，并使用OpenAI的分词器进行token计数。</span><br>                .chatMemoryProvider(userId -&gt; TokenWindowChatMemory.builder().id(userId).maxTokens(<span class="hljs-number">10000</span>,<span class="hljs-keyword">new</span> OpenAiTokenizer()).build())<br>                .build();<br><br>        String name = namingMaster.name(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;给我一个姓王的男孩名字，不用解释&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;===========================第一次返回=====================================&quot;</span>);<br>        System.out.println(name);<br><br>        String name1 = namingMaster.name(<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;给我一个最好吃的水果名， 不用解释&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;===========================第二次返回=====================================&quot;</span>);<br>        System.out.println(name1);<br><br>        String name2 = namingMaster.name(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;换一个&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;===========================第三次返回=====================================&quot;</span>);<br>        System.out.println(name2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>返回结果：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250721203025165.png" alt="image-20250721203025165" style="zoom:50%;" /><h1 id="3-源码实现"><a href="#3-源码实现" class="headerlink" title="3. 源码实现"></a>3. 源码实现</h1><p>ChatMemory是一个接口，默认提供了两个实现类：</p><ol><li>MessageWindowChatMemory</li><li>TokenWindowChatMemory</li></ol><h2 id="1-ChatMemoryStore"><a href="#1-ChatMemoryStore" class="headerlink" title="1. ChatMemoryStore"></a>1. ChatMemoryStore</h2><p>这两个实现类内部都有一个ChatMemoryStore属性，ChatMemoryStore也是一个接口，默认有一个InMemoryChatMemoryStore实现类。</p><p>本质上就是一个ConcurrentHashMap，所以原理上我们可以自定义ChatMemoryStore的实现类来实现将ChatMessage持久化到磁盘，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InMemoryChatMemoryStore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChatMemoryStore</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Object, List&lt;ChatMessage&gt;&gt; messagesByMemoryId = <span class="hljs-keyword">new</span> ConcurrentHashMap();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InMemoryChatMemoryStore</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;ChatMessage&gt; <span class="hljs-title">getMessages</span><span class="hljs-params">(Object memoryId)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (List)<span class="hljs-keyword">this</span>.messagesByMemoryId.computeIfAbsent(memoryId, (ignored) -&gt; &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ArrayList();<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateMessages</span><span class="hljs-params">(Object memoryId, List&lt;ChatMessage&gt; messages)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.messagesByMemoryId.put(memoryId, messages);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteMessages</span><span class="hljs-params">(Object memoryId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.messagesByMemoryId.remove(memoryId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-MessageWindowChatMemory"><a href="#2-MessageWindowChatMemory" class="headerlink" title="2. MessageWindowChatMemory"></a>2. MessageWindowChatMemory</h2><p>那么MessageWindowChatMemory除开可以存储ChatMessage之外，还有淘汰机制,可以设置maxMessages，超过maxMessages会淘汰最旧的ChatMessage，SystemMessage不会被淘汰。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(ChatMessage message)</span> </span>&#123;<br>    List&lt;ChatMessage&gt; messages = <span class="hljs-keyword">this</span>.messages();<br>    <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">instanceof</span> SystemMessage) &#123;<br>        Optional&lt;SystemMessage&gt; systemMessage = findSystemMessage(messages);<br>      <span class="hljs-comment">// 替换SystemMessage</span><br>        <span class="hljs-keyword">if</span> (systemMessage.isPresent()) &#123;<br>            <span class="hljs-keyword">if</span> (((SystemMessage)systemMessage.get()).equals(message)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            messages.remove(systemMessage.get()); <br>        &#125;<br>    &#125;<br><br>    messages.add(message);<br>  <span class="hljs-comment">// 如果超过了maxMessages限制，则会淘汰List最前面的，也就是最旧的ChatMessage</span><br> <span class="hljs-comment">// 注意，SystemMessage不会被淘汰</span><br>    ensureCapacity(messages, <span class="hljs-keyword">this</span>.maxMessages);<br>    <span class="hljs-keyword">this</span>.store.updateMessages(<span class="hljs-keyword">this</span>.id, messages);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="3-TokenWindowChatMemory"><a href="#3-TokenWindowChatMemory" class="headerlink" title="3. TokenWindowChatMemory"></a>3. TokenWindowChatMemory</h2><p>TokenWindowChatMemory和MessageWindowChatMemory类似，区别在于计算容量的方式不一样，MessageWindowChatMemory直接取的是List<ChatMessage>的大小，而TokenWindowChatMemory会利用指定的Tokenizer对List<ChatMessage>对应的Token数进行估算，然后和设置的maxTokens进行比较，超过maxTokens也会进行淘汰，也是淘汰最旧的ChatMessage。</p><p>Tokenizer是一个接口，默认提供了OpenAiTokenizer实现类，是用来估算一条ChatMessage对应多少个Token的，很多大模型的API都是按使用的Token数来收费的，所以在对成本比较敏感时，建议使用TokenWindowChatMemory来对一个会话使用的总Token数进行控制。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(ChatMessage message)</span> </span>&#123;<br>    List&lt;ChatMessage&gt; messages = <span class="hljs-keyword">this</span>.messages();<br>    <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">instanceof</span> SystemMessage) &#123;<br>        Optional&lt;SystemMessage&gt; maybeSystemMessage = findSystemMessage(messages);<br>        <span class="hljs-keyword">if</span> (maybeSystemMessage.isPresent()) &#123;<br>            <span class="hljs-keyword">if</span> (((SystemMessage)maybeSystemMessage.get()).equals(message)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            messages.remove(maybeSystemMessage.get());<br>        &#125;<br>    &#125;<br><br>    messages.add(message);<br>   <span class="hljs-comment">// 如果超过了maxTokens限制，则会淘汰List最前面的</span><br>    ensureCapacity(messages, <span class="hljs-keyword">this</span>.maxTokens, <span class="hljs-keyword">this</span>.tokenizer);<br>    <span class="hljs-keyword">this</span>.store.updateMessages(<span class="hljs-keyword">this</span>.id, messages);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LangChain4j</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>LangChain4j之AiService</title>
    <link href="/LangChain4j%E4%B9%8BAiService/"/>
    <url>/LangChain4j%E4%B9%8BAiService/</url>
    
    <content type="html"><![CDATA[<h1 id="1-AiService是什么？"><a href="#1-AiService是什么？" class="headerlink" title="1. AiService是什么？"></a>1. AiService是什么？</h1><p><code>LangChain4j</code> 的 <code>AiService</code> 是一个非常方便的工具，它允许开发者通过定义接口和使用注解的方式快速创建基于语言模型的服务。这个机制极大地简化了与语言模型（如 Qwen、ChatGPT 等）交互的过程，使得开发者可以更专注于业务逻辑而非底层通信细节。</p><h3 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h3><ol><li><strong>接口定义</strong>：你首先需要定义一个接口，其中的方法代表了你希望语言模型执行的任务。</li><li><strong>注解</strong>：在方法上添加特定的注解来指导LangChain4j如何处理这些请求，例如：<ul><li><code>@SystemMessage</code>：指定系统消息或角色描述。</li><li><code>@UserMessage</code>：标记用户输入的消息。</li><li><code>@Moderate</code>：启用内容审核。</li><li><code>@V</code>：用于变量插值。</li></ul></li><li><strong>动态代理</strong>：<code>AiServices.builder()</code> 会根据你的接口定义生成一个动态代理对象，该对象会在运行时将调用转发给实际的语言模型，并返回结果。</li></ol><h1 id="2-AiService使用"><a href="#2-AiService使用" class="headerlink" title="2. AiService使用"></a>2. AiService使用</h1><ul><li><p>创建ChatLanguageModel</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.zhipu.ZhipuAiChatModel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelFactory</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ChatLanguageModel <span class="hljs-title">buildChatLanguageModel</span><span class="hljs-params">()</span> </span>&#123;<br>        String API_KEY = <span class="hljs-string">&quot;xxx&quot;</span>;<br>        <span class="hljs-keyword">return</span> ZhipuAiChatModel<br>                .builder()<br>                .apiKey(API_KEY)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="1-SystemMessage指定系统消息"><a href="#1-SystemMessage指定系统消息" class="headerlink" title="1. @SystemMessage指定系统消息"></a>1. @SystemMessage指定系统消息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.service.AiServices;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.SystemMessage;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WriterAiService</span> </span>&#123;<br><br>    <span class="hljs-meta">@SystemMessage(&quot;请扮演一名作家，根据输入的文章题目写一篇200字以内的作文&quot;)</span><br>    <span class="hljs-function">String <span class="hljs-title">write</span><span class="hljs-params">(String title)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> WriterAiService <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> AiServices.builder(WriterAiService.class)<br>                .chatLanguageModel(ModelFactory.buildChatLanguageModel())<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        WriterAiService writer = WriterAiService.create();<br>        String result = writer.write(<span class="hljs-string">&quot;我最爱的人&quot;</span>);<br>        System.out.println(result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出结果：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250720164749767.png" alt="image-20250720164749767"></p><h2 id="2-UserMessage：标记用户输入的消息。"><a href="#2-UserMessage：标记用户输入的消息。" class="headerlink" title="2. @UserMessage：标记用户输入的消息。"></a>2. <code>@UserMessage</code>：标记用户输入的消息。</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.service.AiServices;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.SystemMessage;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.UserMessage;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.V;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WriterAiService</span> </span>&#123;<br><br>    <span class="hljs-meta">@SystemMessage(&quot;请扮演一名作家，根据输入的文章题目写一篇&#123;&#123;count&#125;&#125;字以内的作文&quot;)</span><br>    <span class="hljs-function">String <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-meta">@UserMessage</span> String title, <span class="hljs-meta">@V(&quot;count&quot;)</span> Integer count)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> WriterAiService <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> AiServices.builder(WriterAiService.class)<br>                .chatLanguageModel(ModelFactory.buildChatLanguageModel())<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        WriterAiService writer = WriterAiService.create();<br>        String result = writer.write(<span class="hljs-string">&quot;我最爱的人&quot;</span>, <span class="hljs-number">30</span>);<br>        System.out.println(result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出结果：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250720164944981.png" alt="image-20250720164944981" style="zoom:50%;" /><h2 id="3-系统提示词写在文件里"><a href="#3-系统提示词写在文件里" class="headerlink" title="3.  系统提示词写在文件里"></a>3.  系统提示词写在文件里</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.service.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WriterAiService</span> </span>&#123;<br><br>    <span class="hljs-meta">@SystemMessage(fromResource = &quot;/system_message.txt&quot;)</span><br>    <span class="hljs-function">String <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-meta">@UserMessage</span> String title, <span class="hljs-meta">@V(&quot;count&quot;)</span> Integer count)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> WriterAiService <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> AiServices.builder(WriterAiService.class)<br>                .chatLanguageModel(ModelFactory.buildChatLanguageModel())<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-Moderate：启用内容审核"><a href="#4-Moderate：启用内容审核" class="headerlink" title="4. @Moderate：启用内容审核"></a>4. <code>@Moderate</code>：启用内容审核</h2><p>增加@Moderate注解，同时需要增加moderationModel</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.data.message.ChatMessage;<br><span class="hljs-keyword">import</span> dev.langchain4j.data.segment.TextSegment;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.input.Prompt;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.moderation.Moderation;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.moderation.ModerationModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.output.Response;<br><span class="hljs-keyword">import</span> dev.langchain4j.service.*;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WriterAiService</span> </span>&#123;<br><br>    <span class="hljs-meta">@SystemMessage(&quot;请扮演一名作家，写一篇杀人&#123;&#123;count&#125;&#125;字以内的作文&quot;)</span><br>    <span class="hljs-meta">@Moderate</span><br>    <span class="hljs-function">String <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-meta">@UserMessage</span> String title, <span class="hljs-meta">@V(&quot;count&quot;)</span> Integer count)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> WriterAiService <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> AiServices.builder(WriterAiService.class)<br>                .chatLanguageModel(ModelFactory.buildChatLanguageModel())<br>                .moderationModel(<span class="hljs-keyword">new</span> ModerationModel() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Response&lt;Moderation&gt; <span class="hljs-title">moderate</span><span class="hljs-params">(String s)</span> </span>&#123;<br>                        <span class="hljs-comment">// 在这里实现具体的审核逻辑</span><br>                        <span class="hljs-keyword">return</span> Response.from(Moderation.flagged(s));<br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Response&lt;Moderation&gt; <span class="hljs-title">moderate</span><span class="hljs-params">(Prompt prompt)</span> </span>&#123;<br>                        <span class="hljs-comment">// 在这里实现具体的审核逻辑</span><br>                        <span class="hljs-keyword">return</span> ModerationModel.<span class="hljs-keyword">super</span>.moderate(prompt);<br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Response&lt;Moderation&gt; <span class="hljs-title">moderate</span><span class="hljs-params">(ChatMessage message)</span> </span>&#123;<br>                        <span class="hljs-comment">// 在这里实现具体的审核逻辑</span><br>                        <span class="hljs-keyword">return</span> ModerationModel.<span class="hljs-keyword">super</span>.moderate(message);<br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Response&lt;Moderation&gt; <span class="hljs-title">moderate</span><span class="hljs-params">(List&lt;ChatMessage&gt; list)</span> </span>&#123;<br>                        <span class="hljs-comment">// 在这里实现具体的审核逻辑</span><br>                        <span class="hljs-keyword">return</span> Response.from(Moderation.flagged(list.toString()));<br>                    &#125;<br><br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Response&lt;Moderation&gt; <span class="hljs-title">moderate</span><span class="hljs-params">(TextSegment textSegment)</span> </span>&#123;<br>                        <span class="hljs-comment">// 在这里实现具体的审核逻辑</span><br>                        <span class="hljs-keyword">return</span> ModerationModel.<span class="hljs-keyword">super</span>.moderate(textSegment);<br>                    &#125;<br>                &#125;)<br>                .build();<br>    &#125;<br></code></pre></td></tr></table></figure><h1 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3. 源码分析"></a>3. 源码分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">AiServices.builder(WriterAiService.class)<br>                .chatLanguageModel(ModelFactory.buildChatLanguageModel())<br>                .build()<br></code></pre></td></tr></table></figure><p>由于AiServices是一个抽象类，源码中有一个默认的子类DefaultAiServices，核心实现源码都在DefaultAiServices中。</p><p>DefaultAiServices的build方法就是用来创建指定接口的代理对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">build</span><span class="hljs-params">()</span> </span>&#123;<br><br><span class="hljs-comment">// 验证是否配置了ChatLanguageModel</span><br>performBasicValidation();<br><br><span class="hljs-comment">// 验证接口中是否有方法上加了@Moderate，但是又没有配置ModerationModel</span><br><span class="hljs-keyword">for</span> (Method method : context.aiServiceClass.getMethods()) &#123;<br><span class="hljs-keyword">if</span> (method.isAnnotationPresent(Moderate.class) &amp;&amp; context.moderationModel == <span class="hljs-keyword">null</span>) &#123;<br><span class="hljs-keyword">throw</span> illegalConfiguration(<span class="hljs-string">&quot;The @Moderate annotation is present, but the moderationModel is not set up. &quot;</span> +<br>   <span class="hljs-string">&quot;Please ensure a valid moderationModel is configured before using the @Moderate annotation.&quot;</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// JDK动态代理创建代理对象</span><br>Object proxyInstance = Proxy.newProxyInstance(<br>context.aiServiceClass.getClassLoader(),<br><span class="hljs-keyword">new</span> Class&lt;?&gt;[]&#123;context.aiServiceClass&#125;,<br><span class="hljs-keyword">new</span> InvocationHandler() &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><span class="hljs-comment">//...</span><br>        <span class="hljs-comment">// 验证参数</span><br>         DefaultAiServices.validateParameters(method);<br>        <span class="hljs-comment">// 解析系统消息</span><br>         Optional&lt;SystemMessage&gt; systemMessage = DefaultAiServices.<span class="hljs-keyword">this</span>.prepareSystemMessage(method, args);<br>        <span class="hljs-comment">// 解析用户消息</span><br>         dev.langchain4j.data.message.UserMessage userMessage = DefaultAiServices.prepareUserMessage(method, args);<br>        <span class="hljs-comment">// 这里去使用chatModel去调用openAi, 生成返回的结果</span><br>       response = DefaultAiServices.<span class="hljs-keyword">this</span>.context.chatModel.generate((List)messages, DefaultAiServices.<span class="hljs-keyword">this</span>.context.toolSpecifications);<br><br>        <span class="hljs-comment">// ...</span><br>&#125;<br><br>&#125;);<br><br><span class="hljs-keyword">return</span> (T) proxyInstance;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以发现，其实就是用的JDK动态代理机制创建的代理对象，只不过在创建代理对象之前有两步验证：</p><ol><li>验证是否配置了ChatLanguageModel：这一步不难理解，如果代理对象没有配置ChatLanguageModel，那就利用不上大模型的能力了</li><li>验证接口中是否有方法上加了@Moderate，但是又没有配置ModerationModel</li></ol>]]></content>
    
    
    <categories>
      
      <category>LangChain4j</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>LangChain4j入门</title>
    <link href="/LangChain4j%E5%85%A5%E9%97%A8/"/>
    <url>/LangChain4j%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-什么是LangChain4j"><a href="#1-什么是LangChain4j" class="headerlink" title="1. 什么是LangChain4j"></a>1. 什么是LangChain4j</h1><p>它是Java版本的LangChain，提供了一个开发框架，使得开发者可以很容易的用来构建具有LLM能力的应用程序。如何将大模型能力和Java编程语言相结合，这就是LangChain4j所做的。</p><blockquote><p>LLM就是Large Language Model，也就是常说的大语言模型，简称大模型。</p></blockquote><h1 id="2-langchain4j集成OpenAi（Java）"><a href="#2-langchain4j集成OpenAi（Java）" class="headerlink" title="2. langchain4j集成OpenAi（Java）"></a>2. langchain4j集成OpenAi（Java）</h1><h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-普通调用"><a href="#2-普通调用" class="headerlink" title="2. 普通调用"></a>2. 普通调用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String API_KEY = <span class="hljs-string">&quot;sk-peszVtFXoLnWK45bB15370Df6f344cAa9a088eF50f9c7302&quot;</span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ChatLanguageModel model = OpenAiChatModel<br>                .builder()<br>                .apiKey(API_KEY) <span class="hljs-comment">// 需要替换成自己去open AI申请的API Key</span><br>                .modelName(<span class="hljs-string">&quot;gpt-4o-mini&quot;</span>)<br>                .build();<br><br>        String answer = model.generate(<span class="hljs-string">&quot;你好，你是谁？&quot;</span>);<br>        System.out.println(answer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><p>默认baseUrl 是<a href="https://api.openai.com/v1">https://api.openai.com/v1</a> ,具体可查看源码OpenAiChatModel</p></li><li><p>open AI 查看api key的地址：<a href="https://platform.openai.com/api-keys">https://platform.openai.com/api-keys</a></p></li></ul></blockquote><p><strong>运行结果</strong>：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250720152422613.png" alt="image-20250720152422613"></p><h2 id="3-流式调用"><a href="#3-流式调用" class="headerlink" title="3. 流式调用"></a>3. 流式调用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.data.message.AiMessage;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.StreamingResponseHandler;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.StreamingChatLanguageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.openai.OpenAiStreamingChatModel;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String API_KEY = <span class="hljs-string">&quot;sk-peszVtFXoLnWK45bB15370Df6f344cAa9a088eF50f9c7302&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        StreamingChatLanguageModel model = OpenAiStreamingChatModel.builder()<br>                .apiKey(API_KEY)<br>                .modelName(<span class="hljs-string">&quot;gpt-4o-mini&quot;</span>)<br>                .build();<br><br>        model.generate(<span class="hljs-string">&quot;你好，你是谁？&quot;</span>, <span class="hljs-keyword">new</span> StreamingResponseHandler&lt;AiMessage&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(String token)</span> </span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;当前返回的内容为：&quot;</span> + token);<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable error)</span> </span>&#123;<br>                System.out.println(error);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果（打字机效果）：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250720154157785.png" alt="image-20250720154157785" style="zoom:50%;" /><h1 id="3-langchain4j集成OpenAi（SpringBoot）"><a href="#3-langchain4j集成OpenAi（SpringBoot）" class="headerlink" title="3. langchain4j集成OpenAi（SpringBoot）"></a>3. langchain4j集成OpenAi（SpringBoot）</h1><h2 id="1-引入依赖-1"><a href="#1-引入依赖-1" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.27.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-配置api-key"><a href="#2-配置api-key" class="headerlink" title="2. 配置api-key"></a>2. 配置api-key</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">langchain4j.open-ai.chat-model.api-key</span>=<span class="hljs-string">demo</span><br></code></pre></td></tr></table></figure><blockquote><p>在底层在构造OpenAiChatModel时，会判断传入的ApiKey是否等于”demo”，如果等于会将OpenAi的原始API地址”<a href="https://api.openai.com/v1&quot;%E6%94%B9%E4%B8%BA&quot;http://langchain4j.dev/demo/openai/v1&quot;%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80%E6%98%AFlangchain4j%E4%B8%93%E9%97%A8%E4%B8%BA%E6%88%91%E4%BB%AC%E5%87%86%E5%A4%87%E7%9A%84%E4%B8%80%E4%B8%AA%E4%BD%93%E9%AA%8C%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80%E7%9B%B8%E5%BD%93%E4%BA%8E%E6%98%AF&quot;https://api.openai.com/v1&quot;%E7%9A%84%E4%BB%A3%E7%90%86%EF%BC%8C%E6%88%91%E4%BB%AC%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%90%86%E6%97%B6%EF%BC%8C%E4%BB%A3%E7%90%86%E4%BC%9A%E5%8E%BB%E8%B0%83%E7%94%A8%E7%9C%9F%E6%AD%A3%E7%9A%84OpenAi%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%8F%AA%E4%B8%8D%E8%BF%87%E4%BB%A3%E7%90%86%E4%BC%9A%E5%B0%86%E8%87%AA%E5%B7%B1%E7%9A%84ApiKey%E4%BC%A0%E8%BF%87%E5%8E%BB%EF%BC%8C%E4%BB%8E%E8%80%8C%E6%8B%BF%E5%88%B0%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E%E7%BB%99%E6%88%91%E4%BB%AC%E3%80%82">https://api.openai.com/v1&quot;改为&quot;http://langchain4j.dev/demo/openai/v1&quot;，这个地址是langchain4j专门为我们准备的一个体验地址，实际上这个地址相当于是&quot;https://api.openai.com/v1&quot;的代理，我们请求代理时，代理会去调用真正的OpenAi接口，只不过代理会将自己的ApiKey传过去，从而拿到结果返回给我们。</a> </p><p>这个key不支持流式响应，所以真正开发，还是要替换自己的Key。</p></blockquote><h2 id="3-调用"><a href="#3-调用" class="headerlink" title="3. 调用"></a>3. 调用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ChatLanguageModel chatLanguageModel;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> chatLanguageModel.generate(<span class="hljs-string">&quot;你好啊&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="4-langchain4j内容审核之Moderation"><a href="#4-langchain4j内容审核之Moderation" class="headerlink" title="4. langchain4j内容审核之Moderation"></a>4. langchain4j内容审核之Moderation</h1><p>ModerationModel能够校验输入中是否存在敏感内容。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.model.moderation.Moderation;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.moderation.ModerationModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.openai.OpenAiModerationModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.output.Response;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestModeration</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ModerationModel moderationModel = OpenAiModerationModel.withApiKey(<span class="hljs-string">&quot;demo&quot;</span>);<br>        Response&lt;Moderation&gt; response = moderationModel.moderate(<span class="hljs-string">&quot;我要杀了你&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;违反OpenAI 的使用策略: &quot;</span> + response.content().flagged());<br>        System.out.println(<span class="hljs-string">&quot;违规内容为：&quot;</span> + response.content().flaggedText());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>返回结果：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250720160406631.png" alt="image-20250720160406631" style="zoom:50%;" /><h1 id="5-langchain4j生成图片之ImageModel"><a href="#5-langchain4j生成图片之ImageModel" class="headerlink" title="5. langchain4j生成图片之ImageModel"></a>5. langchain4j生成图片之ImageModel</h1><p>默认提供的“demo”key不能用来生成图片，需要大家自己购买apiKey</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> dev.langchain4j.data.image.Image;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.image.ImageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.openai.OpenAiImageModel;<br><span class="hljs-keyword">import</span> dev.langchain4j.model.output.Response;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_01_Main</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String API_KEY = <span class="hljs-string">&quot;xxx&quot;</span>;<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ImageModel imageModel = OpenAiImageModel.builder()<br>                .apiKey(API_KEY)<br>                .build();<br>        Response&lt;Image&gt; response = imageModel.generate(<span class="hljs-string">&quot;一辆车&quot;</span>);<br>        System.out.println(response.content().url());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LangChain4j</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Vue3跨层级通信技巧</title>
    <link href="/Vue3%E8%B7%A8%E5%B1%82%E7%BA%A7%E9%80%9A%E4%BF%A1%E6%8A%80%E5%B7%A7/"/>
    <url>/Vue3%E8%B7%A8%E5%B1%82%E7%BA%A7%E9%80%9A%E4%BF%A1%E6%8A%80%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Provide-和-Inject"><a href="#1-Provide-和-Inject" class="headerlink" title="1. Provide 和 Inject"></a>1. <strong>Provide 和 Inject</strong></h1><ul><li><code>provide</code>和<code>inject</code>允许祖先组件向任意深度的后代组件提供数据，而不需要经过中间组件 props逐层传递。</li><li>祖先组件使用<code>provide</code>来提供数据，后代组件使用<code>inject</code>来接收这些数据。这种方式非常适合用于主题、用户偏好设置等全局或半全局的数据共享。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;script setup lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;<br>    <span class="hljs-keyword">import</span> &#123; provide &#125; from <span class="hljs-string">&#x27;vue&#x27;</span><br>    <span class="hljs-keyword">const</span> rules = &#123; name: <span class="hljs-string">&#x27;required&#x27;</span>, age: <span class="hljs-string">&#x27;number&#x27;</span> &#125;<br>    provide(<span class="hljs-string">&#x27;rules&#x27;</span>, rules)<br>&lt;/script&gt;<br>&lt;script setup lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;<br>    <span class="hljs-keyword">import</span> &#123; inject &#125; from <span class="hljs-string">&#x27;vue&#x27;</span><br>    <span class="hljs-keyword">const</span> rules = inject(<span class="hljs-string">&#x27;rules&#x27;</span>)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h1 id="2-Pinia"><a href="#2-Pinia" class="headerlink" title="2. Pinia"></a>2. Pinia</h1><ul><li>Pinia则是Vue 3的新一代状态管理库，它更轻量且易于使用。</li><li>实现思路：定义store存储变量，在子组件中更新store的值，在父组件监听</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java">export <span class="hljs-keyword">const</span> useModelStore = defineStore(<span class="hljs-string">&#x27;model&#x27;</span>, () =&gt; &#123;<br>  <span class="hljs-comment">// 当前模型</span><br>  <span class="hljs-keyword">const</span> currentModelInfo = ref&lt;GetSessionListVO&gt;(&lt;GetSessionListVO&gt;&#123;&#125;);<br><br>  <span class="hljs-comment">// 设置当前模型</span><br>  <span class="hljs-keyword">const</span> setCurrentModelInfo = (modelInfo: GetSessionListVO) =&gt; &#123;<br>    currentModelInfo.value = modelInfo;<br>  &#125;;<br>  <span class="hljs-keyword">return</span> &#123;<br>    currentModelInfo,<br>    setCurrentModelInfo,<br>  &#125;<br>&#125;);<br>&lt;script setup lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;<br>  <span class="hljs-function">function <span class="hljs-title">handleClick</span><span class="hljs-params">(item: GetSessionListVO)</span> </span>&#123;<br>    modelStore.setCurrentModelInfo(item);<br>  &#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;div<br>      <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;model-select&quot;</span><br>      :<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;&#123; &#x27;bg-[rgba(0,0,0,.04)] is-select&#x27;: item.modelName === currentModelName &#125;&quot;</span><br>      <span class="hljs-meta">@click</span>=<span class="hljs-string">&quot;handleClick(item)&quot;</span><br>    &gt;<br>&lt;/template&gt;<br>&lt;script setup lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;<br>  watch(<br>      () =&gt; modelStore.currentModelInfo,<br>      (val) =&gt; &#123;<br>        <span class="hljs-keyword">if</span> (val.modelName === modelStore.defaultModel.modelName) &#123;<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>        senderRef.value.openHeader();<br>      &#125;,<br>    );<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Vue</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-plus字段自动填充</title>
    <link href="/mybatis-plus%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85/"/>
    <url>/mybatis-plus%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85/</url>
    
    <content type="html"><![CDATA[<h1 id="1-主键ID生成"><a href="#1-主键ID生成" class="headerlink" title="1. 主键ID生成"></a>1. 主键ID生成</h1><h2 id="1-1-在主键上加注解"><a href="#1-1-在主键上加注解" class="headerlink" title="1.1. 在主键上加注解"></a>1.1. 在主键上加注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-meta">@TableId(type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long id;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-全局配置默认ID生成策略"><a href="#1-2-全局配置默认ID生成策略" class="headerlink" title="1.2. 全局配置默认ID生成策略"></a>1.2. 全局配置默认ID生成策略</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span> <span class="hljs-comment"># 可选值有：auto, input, assign_id, assign_uuid, none, id_worker等</span><br></code></pre></td></tr></table></figure><h2 id="1-3-定义一个全局-ID-生成器-Bean"><a href="#1-3-定义一个全局-ID-生成器-Bean" class="headerlink" title="1.3. 定义一个全局 ID 生成器 Bean"></a>1.3. 定义一个全局 ID 生成器 Bean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.incrementer.IdentifierGenerator;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.incrementer.DefaultIdentifierGenerator;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBatisPlusConfig</span> </span>&#123;<br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用网卡信息绑定雪花生成器</span><br><span class="hljs-comment">     * 防止集群雪花ID重复</span><br><span class="hljs-comment">     */</span><br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IdentifierGenerator <span class="hljs-title">idGenerator</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultIdentifierGenerator(NetUtil.getLocalhost());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-字段自动填充"><a href="#2-字段自动填充" class="headerlink" title="2. 字段自动填充"></a>2. 字段自动填充</h1><h2 id="2-1-entity加注解"><a href="#2-1-entity加注解" class="headerlink" title="2.1. entity加注解"></a>2.1. entity加注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span><br><span class="hljs-keyword">private</span> Long createBy;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建时间</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span><br><span class="hljs-keyword">private</span> Date createTime;<br></code></pre></td></tr></table></figure><h2 id="2-2-自定义实现类-InjectionMetaObjectHandler"><a href="#2-2-自定义实现类-InjectionMetaObjectHandler" class="headerlink" title="2.2. 自定义实现类 InjectionMetaObjectHandler"></a>2.2. 自定义实现类 InjectionMetaObjectHandler</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InjectionMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetaObjectHandler</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入填充方法，用于在插入数据时自动填充实体对象中的创建时间、更新时间、创建人、更新人等信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metaObject 元对象，用于获取原始对象并进行填充</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (ObjectUtil.isNotNull(metaObject) &amp;&amp; metaObject.getOriginalObject() <span class="hljs-keyword">instanceof</span> BaseEntity baseEntity) &#123;<br>                <span class="hljs-comment">// 获取当前时间作为创建时间和更新时间，如果创建时间不为空，则使用创建时间，否则使用当前时间</span><br>                Date current = ObjectUtils.notNull(baseEntity.getCreateTime(), <span class="hljs-keyword">new</span> Date());<br>                baseEntity.setCreateTime(current);<br>                baseEntity.setUpdateTime(current);<br><br>                <span class="hljs-comment">// 如果创建人为空，则填充当前登录用户的信息</span><br>                <span class="hljs-keyword">if</span> (ObjectUtil.isNull(baseEntity.getCreateBy())) &#123;<br>                    LoginUser loginUser = getLoginUser();<br>                    <span class="hljs-keyword">if</span> (ObjectUtil.isNotNull(loginUser)) &#123;<br>                        Long userId = loginUser.getUserId();<br>                        <span class="hljs-comment">// 填充创建人、更新人和创建部门信息</span><br>                        baseEntity.setCreateBy(userId);<br>                        baseEntity.setUpdateBy(userId);<br>                        baseEntity.setCreateDept(ObjectUtils.notNull(baseEntity.getCreateDept(), loginUser.getDeptId()));<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                Date date = <span class="hljs-keyword">new</span> Date();<br>                <span class="hljs-keyword">this</span>.strictInsertFill(metaObject, <span class="hljs-string">&quot;createTime&quot;</span>, Date.class, date);<br>                <span class="hljs-keyword">this</span>.strictInsertFill(metaObject, <span class="hljs-string">&quot;updateTime&quot;</span>, Date.class, date);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServiceException(<span class="hljs-string">&quot;自动注入异常 =&gt; &quot;</span> + e.getMessage(), HttpStatus.HTTP_UNAUTHORIZED);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新填充方法，用于在更新数据时自动填充实体对象中的更新时间和更新人信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metaObject 元对象，用于获取原始对象并进行填充</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (ObjectUtil.isNotNull(metaObject) &amp;&amp; metaObject.getOriginalObject() <span class="hljs-keyword">instanceof</span> BaseEntity baseEntity) &#123;<br>                <span class="hljs-comment">// 获取当前时间作为更新时间，无论原始对象中的更新时间是否为空都填充</span><br>                Date current = <span class="hljs-keyword">new</span> Date();<br>                baseEntity.setUpdateTime(current);<br><br>                <span class="hljs-comment">// 获取当前登录用户的ID，并填充更新人信息</span><br>                Long userId = LoginHelper.getUserId();<br>                <span class="hljs-keyword">if</span> (ObjectUtil.isNotNull(userId)) &#123;<br>                    baseEntity.setUpdateBy(userId);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">&quot;updateTime&quot;</span>, Date.class, <span class="hljs-keyword">new</span> Date());<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServiceException(<span class="hljs-string">&quot;自动注入异常 =&gt; &quot;</span> + e.getMessage(), HttpStatus.HTTP_UNAUTHORIZED);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>hutool好用的方法</title>
    <link href="/hutool%E5%A5%BD%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <url>/hutool%E5%A5%BD%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="1-动态获取bean对象"><a href="#1-动态获取bean对象" class="headerlink" title="1. 动态获取bean对象"></a>1. 动态获取bean对象</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ChatSessionManager chatSessionManager = SpringUtils.getBean(ChatSessionManager.class);<br></code></pre></td></tr></table></figure><h1 id="2-生成UUID"><a href="#2-生成UUID" class="headerlink" title="2. 生成UUID"></a>2. 生成UUID</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">String uuid = IdUtil.simpleUUID();<br></code></pre></td></tr></table></figure><h1 id="3-常量"><a href="#3-常量" class="headerlink" title="3. 常量"></a>3. 常量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrUtil</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SPACE = <span class="hljs-string">&quot; &quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DOT = <span class="hljs-string">&quot;.&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SLASH = <span class="hljs-string">&quot;/&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String BACKSLASH = <span class="hljs-string">&quot;\\&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EMPTY = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NULL = <span class="hljs-string">&quot;null&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CR = <span class="hljs-string">&quot;\r&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String LF = <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CRLF = <span class="hljs-string">&quot;\r\n&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String UNDERLINE = <span class="hljs-string">&quot;_&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DASHED = <span class="hljs-string">&quot;-&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String COMMA = <span class="hljs-string">&quot;,&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DELIM_START = <span class="hljs-string">&quot;&#123;&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DELIM_END = <span class="hljs-string">&quot;&#125;&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String BRACKET_START = <span class="hljs-string">&quot;[&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String BRACKET_END = <span class="hljs-string">&quot;]&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String COLON = <span class="hljs-string">&quot;:&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EMPTY_JSON = <span class="hljs-string">&quot;&#123;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Lombok之@RequiredArgsConstructor</title>
    <link href="/Lombok%E4%B9%8B-RequiredArgsConstructor/"/>
    <url>/Lombok%E4%B9%8B-RequiredArgsConstructor/</url>
    
    <content type="html"><![CDATA[<h1 id="1-RequiredArgsConstructor是什么"><a href="#1-RequiredArgsConstructor是什么" class="headerlink" title="1. @RequiredArgsConstructor是什么?"></a>1. @RequiredArgsConstructor是什么?</h1><p><code>@RequiredArgsConstructor</code> 是 Lombok 提供的一个注解，用于自动生成构造函数。这个构造函数只包含那些被声明为 <code>final</code> 或者标注了 <code>@NonNull</code> 的字段，从而确保这些字段在对象创建时必须被初始化，以避免潜在的空指针异常等问题。</p><h1 id="2-通过-RequiredArgsConstructor简化Bean注入"><a href="#2-通过-RequiredArgsConstructor简化Bean注入" class="headerlink" title="2. 通过@RequiredArgsConstructor简化Bean注入"></a>2. 通过@RequiredArgsConstructor简化Bean注入</h1><p>通过类的构造函数来注入依赖。这是最推荐的方式，尤其是在依赖是强制性的情况下。</p><p>Spring 使用构造器注入的方式将 <code>OpenAiStreamClient</code> 类型的 Bean 注入到 <code>SseServiceImpl</code> 中。将可以简化@Autowired 的书写过程， 即不需要再通过@Autowired 或者@Resource 进行Bean注入</p><p>二、@RequiredArgsConstructor的使用方式</p><p>1、引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2、代码示例"><a href="#2、代码示例" class="headerlink" title="2、代码示例"></a>2、代码示例</h3><h4 id="2-1、常规-Autowired注入："><a href="#2-1、常规-Autowired注入：" class="headerlink" title="2.1、常规 @Autowired注入："></a>2.1、常规 @Autowired注入：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/getUser&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>&#123;<br>        User user = userService.getUser(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>常规构造器注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> UserService userService;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserService</span><span class="hljs-params">(UserService userService)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.userService = userService;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/getUser&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>&#123;<br>        User user = userService.getUser(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3、lombok中的RequiredArgsConstructor注入："><a href="#2-3、lombok中的RequiredArgsConstructor注入：" class="headerlink" title="2.3、lombok中的RequiredArgsConstructor注入："></a>2.3、lombok中的RequiredArgsConstructor注入：</h4><p>可以看到，使用 <code>@RequiredArgsConstructor</code> 省去了 <code>@Autowired</code> 或 <code>@Resource</code> 注解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/getUser&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>&#123;<br>        User user = userService.getUser(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>参考：<a href="https://blog.csdn.net/q2qwert/article/details/140683375">https://blog.csdn.net/q2qwert/article/details/140683375</a></p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Java基于SSE流式返回</title>
    <link href="/Java%E5%9F%BA%E4%BA%8ESSE%E6%B5%81%E5%BC%8F%E8%BF%94%E5%9B%9E/"/>
    <url>/Java%E5%9F%BA%E4%BA%8ESSE%E6%B5%81%E5%BC%8F%E8%BF%94%E5%9B%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="1-服务器推送技术价值"><a href="#1-服务器推送技术价值" class="headerlink" title="1. 服务器推送技术价值"></a>1. 服务器推送技术价值</h1><p>传统”拉取”模式需客户端主动发起请求获取更新，而服务器推送采用”推送”机制实现实时信息传输。其核心优势体现在：</p><ol><li>实时性提升：系统自动推送最新内容，免去用户手动刷新操作</li><li>资源优化：仅在产生有效数据时建立连接，减少无效请求</li><li>用户体验升级：消息即时触达，适用于实时通信场景</li></ol><h1 id="2-服务器推送主流实现技术对比"><a href="#2-服务器推送主流实现技术对比" class="headerlink" title="2. 服务器推送主流实现技术对比"></a>2. 服务器推送主流实现技术对比</h1><h2 id="2-1-长轮询（Long-Polling）"><a href="#2-1-长轮询（Long-Polling）" class="headerlink" title="2.1. 长轮询（Long Polling）"></a>2.1. 长轮询（Long Polling）</h2><ul><li>客户端维持长连接等待服务器响应</li><li>兼容性优秀但资源消耗较高</li></ul><h2 id="2-2-服务器发送事件（SSE）"><a href="#2-2-服务器发送事件（SSE）" class="headerlink" title="2.2. 服务器发送事件（SSE）"></a>2.2. 服务器发送事件（SSE）</h2><ul><li>基于HTTP协议</li><li>单向通信</li><li>适合只需要服务器向客户端推送实时更新数据的场景，如实时新闻更新、股票行情推送等</li></ul><h2 id="2-3-WebSocket"><a href="#2-3-WebSocket" class="headerlink" title="2.3. WebSocket"></a>2.3. WebSocket</h2><ul><li><p>全双工TCP通信协议</p></li><li><p>双向通信</p></li><li><p>适合需要客户端和服务器之间进行实时双向通信的场景，如聊天室、在线游戏等</p></li></ul><h1 id="3-Java-基于okhttp请求SSE接口流式返回"><a href="#3-Java-基于okhttp请求SSE接口流式返回" class="headerlink" title="3. Java 基于okhttp请求SSE接口流式返回"></a>3. Java 基于okhttp请求SSE接口流式返回</h1><h2 id="3-1-整体结构简述"><a href="#3-1-整体结构简述" class="headerlink" title="3.1. 整体结构简述"></a>3.1. 整体结构简述</h2><p>整个流程理解为 <strong>两个 SSE 连接的“接力”传输</strong>：</p><h3 id="3-1-1-第一个-SSE-连接："><a href="#3-1-1-第一个-SSE-连接：" class="headerlink" title="3.1.1. 第一个 SSE 连接："></a>3.1.1. 第一个 SSE 连接：</h3><p><strong>前端发起， 后端给前端推数据</strong></p><ul><li>使用 <code>SseEmitter</code> 实现。</li><li>前端通过 <code>EventSource</code> 发起请求。</li><li>后端接收请求并创建 <code>SseEmitter</code>，用于向前端推送数据。</li><li>这个连接是你主动控制的，用来与用户通信。</li></ul><h3 id="3-1-2-第二个-SSE-连接："><a href="#3-1-2-第二个-SSE-连接：" class="headerlink" title="3.1.2. 第二个 SSE 连接："></a>3.1.2. 第二个 SSE 连接：</h3><p><strong>后端发起，AI 接口给后端推数据</strong></p><ul><li>使用 OkHttp 的 <code>EventSource.Factory</code> 创建。</li><li>后端向 AI 模型服务发起流式请求。</li><li>接收模型返回的逐字输出（如 AI 流式回答）。</li><li>这个连接是代理性质的，用来获取远程 AI 数据。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">[前端] <br>   ↓ (发起请求)<br>[后端 Controller]<br>   ↓ (构造请求体 + 创建 emitter)<br>[SSEEventSourceListener(listener)]<br>   ↓ (通过 OkHttp EventSource 发起 SSE 请求)<br>[调用远程 AI 接口（如 OpenAI / Ollama）]<br>   ↓ (流式返回数据)<br>[onEvent() 方法处理数据]<br>   ↓<br>[通过 emitter.send(data) 把数据推给前端]<br></code></pre></td></tr></table></figure><h2 id="3-2-核心代码"><a href="#3-2-核心代码" class="headerlink" title="3.2. 核心代码"></a>3.2. 核心代码</h2><ol><li>我们可以借助okhttp来实现，首先引入okhttp-sse的依赖：</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.10.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp-sse<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.10.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol><li>核心代码</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java">OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient<br>            .Builder()<br>            .addInterceptor(<span class="hljs-keyword">this</span>.authInterceptor)<br>            .connectTimeout(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<br>            .writeTimeout(<span class="hljs-number">50</span>, TimeUnit.SECONDS)<br>            .readTimeout(<span class="hljs-number">50</span>, TimeUnit.SECONDS)<br>            .build();<br><br> SSEEventSourceListener listener = <span class="hljs-keyword">new</span> SSEEventSourceListener(emitter,chatRequest.getUserId(),chatRequest.getSessionId());<br><br><span class="hljs-comment">// 创建事件, 使用了OkHttp的EventSource（Server-Sent Events，简称SSE）机制来发送一个 POST 请求</span><br>EventSource.Factory factory = EventSources.createFactory(okHttpClient);<br>            ObjectMapper mapper = <span class="hljs-keyword">new</span> ObjectMapper();<br>            String requestBody = mapper.writeValueAsString(chatCompletion);<br>            Request request = <span class="hljs-keyword">new</span> Request.Builder()<br>                .url(<span class="hljs-keyword">this</span>.apiHost)<br>                .post(RequestBody.create(MediaType.parse(ContentType.JSON.getValue()), requestBody))<br>                .build();<br>            factory.newEventSource(request, listener);<br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SSEEventSourceListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventSourceListener</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> SseEmitter emitter;<br><br>   <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onOpen</span><span class="hljs-params">(EventSource eventSource, Response response)</span> </span>&#123;<br>        log.info(<span class="hljs-string">&quot;OpenAI建立sse连接...&quot;</span>);<br>    &#125;<br><br>  <br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onEvent</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> EventSource eventSource, String id, String type, String data)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;[DONE]&quot;</span>.equals(data)) &#123;<br>                <span class="hljs-comment">//成功响应</span><br>                emitter.complete();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            ObjectMapper mapper = <span class="hljs-keyword">new</span> ObjectMapper();<br>            ChatCompletionResponse completionResponse = mapper.readValue(data, ChatCompletionResponse.class);<br>            <span class="hljs-keyword">if</span>(completionResponse == <span class="hljs-keyword">null</span> || CollectionUtil.isEmpty(completionResponse.getChoices()))&#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            Object content = completionResponse.getChoices().get(<span class="hljs-number">0</span>).getDelta().getContent();<br><br>            <span class="hljs-keyword">if</span>(content != <span class="hljs-keyword">null</span> )&#123;<br>                <span class="hljs-comment">// 给前端发送请求到的数据</span><br>                emitter.send(data);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage(), e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClosed</span><span class="hljs-params">(EventSource eventSource)</span> </span>&#123;<br>        log.info(<span class="hljs-string">&quot;OpenAI关闭sse连接...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(EventSource eventSource, Throwable t, Response response)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (Objects.isNull(response)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        ResponseBody body = response.body();<br>        <span class="hljs-keyword">if</span> (Objects.nonNull(body)) &#123;<br>            log.error(<span class="hljs-string">&quot;OpenAI  sse连接异常data：&#123;&#125;，异常：&#123;&#125;&quot;</span>, body.string(), t);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.error(<span class="hljs-string">&quot;OpenAI  sse连接异常data：&#123;&#125;，异常：&#123;&#125;&quot;</span>, response, t);<br>        &#125;<br>        eventSource.cancel();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="4-当前端取消请求时，通知后端也立即中断-AI-的处理流程"><a href="#4-当前端取消请求时，通知后端也立即中断-AI-的处理流程" class="headerlink" title="4. 当前端取消请求时，通知后端也立即中断 AI 的处理流程"></a>4. <strong>当前端取消请求时，通知后端也立即中断 AI 的处理流程</strong></h1><h2 id="4-1-流程"><a href="#4-1-流程" class="headerlink" title="4.1. 流程"></a>4.1. 流程</h2><p>前端取消请求时，通知后端取消对应的 AI 请求</p><ul><li>前端使用 <code>useFetchHook</code>（假设是基于 <code>fetch</code> 或 <code>axios</code>）时，可以使用 <code>AbortController</code> 来中断请求。</li><li>前端中断请求后，主动发送一个取消请求到后端，告诉后端“我不要这个请求了，请取消 AI 推理”。</li></ul><h2 id="4-2-前端实现（Vue-useFetchHook）"><a href="#4-2-前端实现（Vue-useFetchHook）" class="headerlink" title="4.2. 前端实现（Vue + useFetchHook）"></a>4.2. 前端实现（Vue + useFetchHook）</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; ref &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useFetch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@vueuse/core&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-function"><span class="hljs-title">setup</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> AbortController()<br>    <span class="hljs-keyword">const</span> signal = controller.signal<br><br>    <span class="hljs-keyword">const</span> &#123; data, error, isFetching &#125; = useFetch(<span class="hljs-string">&#x27;https://your-api.com/chat&#x27;</span>, &#123;<br>      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>      <span class="hljs-attr">headers</span>: &#123;<br>        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span><br>      &#125;,<br>      <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(&#123; <span class="hljs-attr">prompt</span>: <span class="hljs-string">&#x27;Tell me a joke&#x27;</span> &#125;),<br>      signal<br>    &#125;).json()<br><br>    <span class="hljs-keyword">const</span> cancelRequest = <span class="hljs-function">() =&gt;</span> &#123;<br>      controller.abort() <span class="hljs-comment">// 中断当前请求</span><br><br>      <span class="hljs-comment">// 可选：发送一个取消请求给后端，通知它停止处理</span><br>      fetch(<span class="hljs-string">&#x27;https://your-api.com/chat/cancel&#x27;</span>, &#123;<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-attr">headers</span>: &#123;<br>          <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span><br>        &#125;,<br>        <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(&#123;<br>          <span class="hljs-attr">userId</span>: <span class="hljs-string">&#x27;user123&#x27;</span>,<br>          <span class="hljs-attr">sessionId</span>: <span class="hljs-string">&#x27;session456&#x27;</span><br>        &#125;)<br>      &#125;)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      data,<br>      error,<br>      isFetching,<br>      cancelRequest<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-3-后端实现"><a href="#4-3-后端实现" class="headerlink" title="4.3. 后端实现"></a>4.3. 后端实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/chat&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChatController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ChatSessionManager chatSessionManager;<br>  <br>    <span class="hljs-meta">@PostMapping(&quot;/chat&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatRequest chatRequest, HttpServletRequest request)</span> </span>&#123;<br>    String sessionId = chatRequest.getSessionId();<br>    String userId = chatRequest.getUserId();<br><br>    <span class="hljs-comment">// 构造请求体</span><br>    ObjectMapper mapper = <span class="hljs-keyword">new</span> ObjectMapper();<br>    String requestBody = mapper.writeValueAsString(chatCompletion);<br><br>    Request request = <span class="hljs-keyword">new</span> Request.Builder()<br>    .url(<span class="hljs-keyword">this</span>.apiHost)<br>    .post(RequestBody.create(MediaType.parse(<span class="hljs-string">&quot;application/json&quot;</span>), requestBody))<br>    .build();<br><br>    SSEEventSourceListener listener = <span class="hljs-keyword">new</span> SSEEventSourceListener(emitter, userId, sessionId);<br>    EventSource eventSource = EventSources.createFactory(okHttpClient).newEventSource(request, listener);<br><br>    <span class="hljs-comment">// 保存 eventSource 到 session manager</span><br>    chatSessionManager.addSession(sessionId, eventSource);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/cancel&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title">cancelChat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, String&gt; payload)</span> </span>&#123;<br>        String sessionId = payload.get(<span class="hljs-string">&quot;sessionId&quot;</span>);<br>        chatSessionManager.cancelSession(sessionId);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">&quot;Chat request canceled.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChatSessionManager</span> </span>&#123;<br><br>    <span class="hljs-comment">// session ID -&gt; EventSource</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, EventSource&gt; sessions = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSession</span><span class="hljs-params">(String sessionId, EventSource eventSource)</span> </span>&#123;<br>        sessions.put(sessionId, eventSource);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeSession</span><span class="hljs-params">(String sessionId)</span> </span>&#123;<br>        sessions.remove(sessionId);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancelSession</span><span class="hljs-params">(String sessionId)</span> </span>&#123;<br>        EventSource eventSource = sessions.get(sessionId);<br>        <span class="hljs-keyword">if</span> (eventSource != <span class="hljs-keyword">null</span>) &#123;<br>            eventSource.cancel(); <span class="hljs-comment">// 取消 SSE 请求</span><br>            sessions.remove(sessionId);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注：如果使用 <strong>Redis</strong>，可以将 session 信息存入 Redis，实现分布式取消。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>gitignore文件添加</title>
    <link href="/gitignore%E6%96%87%E4%BB%B6%E6%B7%BB%E5%8A%A0/"/>
    <url>/gitignore%E6%96%87%E4%BB%B6%E6%B7%BB%E5%8A%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="1-删除缓存"><a href="#1-删除缓存" class="headerlink" title="1. 删除缓存"></a>1. 删除缓存</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git rm -r --cached .idea/<br></code></pre></td></tr></table></figure><h2 id="2-gitignore-文件示例"><a href="#2-gitignore-文件示例" class="headerlink" title="2. gitignore 文件示例"></a>2. gitignore 文件示例</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 编译产生的文件</span><br><span class="hljs-string">/target/</span><br><span class="hljs-string">/bin/</span><br><br><span class="hljs-comment"># IntelliJ IDEA IDE 配置文件（如果使用）</span><br><span class="hljs-string">/.idea/</span><br><span class="hljs-string">/*.iml</span><br><br><span class="hljs-comment"># Eclipse IDE 配译文件（如果使用）</span><br><span class="hljs-string">/.settings/</span><br><span class="hljs-string">/.classpath</span><br><span class="hljs-string">/.project</span><br><br><span class="hljs-comment"># NetBeans IDE 配置文件（如果使用）</span><br><span class="hljs-string">/nbproject/private/</span><br><span class="hljs-string">/nbbuild/</span><br><span class="hljs-string">/dist/</span><br><span class="hljs-string">/build/</span><br><br><span class="hljs-comment"># Maven 配置文件</span><br><span class="hljs-string">/target/</span><br><br><span class="hljs-comment"># Gradle 构建工具配置文件</span><br><span class="hljs-string">.gradle/</span><br><span class="hljs-string">build/</span><br><br><span class="hljs-comment"># macOS 系统文件</span><br><span class="hljs-string">.DS_Store</span><br><br><span class="hljs-comment"># Windows 系统文件</span><br><span class="hljs-string">Thumbs.db</span><br><br><span class="hljs-comment"># Linux 下的临时文件</span><br><span class="hljs-string">*~</span><br><br><span class="hljs-comment"># 日志文件</span><br><span class="hljs-string">*.log</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>oracle数据迁移</title>
    <link href="/oracle%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <url>/oracle%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="1-oracle数据库迁移"><a href="#1-oracle数据库迁移" class="headerlink" title="1. oracle数据库迁移"></a>1. oracle数据库迁移</h1><h2 id="1-导出dmp文件"><a href="#1-导出dmp文件" class="headerlink" title="1. 导出dmp文件"></a>1. 导出dmp文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">expdp mycim3_qj_new/mycim3_qj_new@//10.108.140.102:1521/ORCL schemas=MYCIM3_QJ_NEW directory=DATA_PUMP_DIR dumpfile=export.dmp logfile=export.log<br></code></pre></td></tr></table></figure><p>注：导出结束以后会显示这个文件在哪个路径下面，注意看最后几行</p><h2 id="2-创建文件夹，并上传dmp文件"><a href="#2-创建文件夹，并上传dmp文件" class="headerlink" title="2. 创建文件夹，并上传dmp文件"></a>2. 创建文件夹，并上传dmp文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -p /home/oracle/import<br></code></pre></td></tr></table></figure><h2 id="3-执行导入"><a href="#3-执行导入" class="headerlink" title="3. 执行导入"></a>3. 执行导入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sqlplus sys/WElcome_123_@//172.28.46.12:1521/mestest as sysdba<br></code></pre></td></tr></table></figure><ol><li>创建新用户，并将文件夹权限赋给他</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">CREATE USER mycim3_qj_new IDENTIFIED BY &quot;mycim3_qj_new&quot;;<br>GRANT CREATE SESSION TO mycim3_qj_new;<br>GRANT DATAPUMP_IMP_FULL_DATABASE TO mycim3_qj_new;<br>ALTER USER MYCIM3_QJ_NEW QUOTA UNLIMITED ON users; <br><br>CREATE DIRECTORY import_dir AS &#x27;/home/oracle/import&#x27;;<br>GRANT READ, WRITE ON DIRECTORY import_dir TO mycim3_qj_new;<br></code></pre></td></tr></table></figure><ol start="2"><li>创建TABLESPACE</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">CREATE TABLESPACE TBS_MYCIM<br>DATAFILE &#x27;/u01/app/oracle/oradata/MESTEST/tbs_mycim_01.dbf&#x27;<br>SIZE 1024M<br>AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;<br><br>CREATE TABLESPACE TBS_MYCIM_PARTTABLE<br>DATAFILE &#x27;/u01/app/oracle/oradata/MESTEST/tbs_mycim_parttable_01.dbf&#x27;<br>SIZE 1024M<br>AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;<br>  <br></code></pre></td></tr></table></figure><ol start="3"><li>执行导入</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">impdp mycim3_qj_new/mycim3_qj_new@//172.28.49.12:1521/mestest schemas=MYCIM3_QJ_NEW directory=import_dir dumpfile=2025.4.28EXPORT.DMP logfile=import.log<br></code></pre></td></tr></table></figure><h1 id="2-为什么-Oracle-不直接支持导出为-SQL？"><a href="#2-为什么-Oracle-不直接支持导出为-SQL？" class="headerlink" title="2.  为什么 Oracle 不直接支持导出为 SQL？"></a>2.  为什么 Oracle 不直接支持导出为 SQL？</h1><ol><li><strong>效率问题</strong>：生成包含所有数据的SQL语句文件会非常庞大，尤其是在处理大量数据时，这样的文件不仅占用更多存储空间，而且在传输和加载过程中也会消耗更多时间。</li><li><strong>复杂性管理</strong>：Oracle 支持的数据类型远比 MySQL 复杂，例如 BFILE, XMLType 等特殊类型，直接转换为 SQL 语句可能会遇到诸多挑战。</li><li><strong>事务支持</strong>：Oracle 强调事务的一致性和隔离级别，在导出过程中保证数据一致性对于企业级应用至关重要，而二进制格式在这方面提供了更好的保障。</li><li><strong>高级特性</strong>：像分区表、外部表等高级特性在转换为 SQL 时可能无法完全保留其原始属性，而二进制格式则能更好地支持这些特性。</li></ol>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes部署微服务应用</title>
    <link href="/Kubernetes%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8/"/>
    <url>/Kubernetes%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-K8s部署Java项目的步骤"><a href="#1-K8s部署Java项目的步骤" class="headerlink" title="1.  K8s部署Java项目的步骤"></a>1.  K8s部署Java项目的步骤</h1><h2 id="1-构建镜像"><a href="#1-构建镜像" class="headerlink" title="1. 构建镜像"></a>1. 构建镜像</h2><h3 id="1-增加Dockerfile"><a href="#1-增加Dockerfile" class="headerlink" title="1. 增加Dockerfile"></a>1. 增加Dockerfile</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 使用官方的 OpenJDK 镜像作为基础镜像</span><br><span class="hljs-string">FROM</span> <span class="hljs-string">docker.xuanyuan.me/openjdk:8-jdk-alpine</span><br><br><span class="hljs-comment"># 设置工作目录</span><br><span class="hljs-string">WORKDIR</span> <span class="hljs-string">/app</span><br><br><span class="hljs-comment"># 复制本地的 JAR 包到容器中</span><br><span class="hljs-string">COPY</span> <span class="hljs-string">./build/libs/micro-weather-weather-eureka-server.jar</span> <span class="hljs-string">eureka-server.jar</span><br><br><span class="hljs-string">EXPOSE</span> <span class="hljs-number">8761</span><br><br><span class="hljs-comment"># 启动应用</span><br><span class="hljs-string">ENTRYPOINT</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;eureka-server.jar&quot;</span>]<br></code></pre></td></tr></table></figure><h3 id="2-构建镜像"><a href="#2-构建镜像" class="headerlink" title="2. 构建镜像"></a>2. 构建镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 或者使用 <span class="hljs-built_in">echo</span> $(<span class="hljs-built_in">pwd</span>)</span><br>echo &quot;当前工作目录是: $(pwd)&quot;<br><br>docker build  -t eureka-server:02 .<br><br>docker images<br></code></pre></td></tr></table></figure><h2 id="2-创建Deployment"><a href="#2-创建Deployment" class="headerlink" title="2. 创建Deployment"></a>2. <strong>创建Deployment</strong></h2><h3 id="1-增加配置文件"><a href="#1-增加配置文件" class="headerlink" title="1. 增加配置文件"></a>1. 增加配置文件</h3><p>eureka-app-deployment.yaml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>                 <span class="hljs-comment"># 使用的API版本，apps/v1适用于Deployment等资源</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>                    <span class="hljs-comment"># 资源类型为Deployment，用于管理Pod副本</span><br><span class="hljs-attr">metadata:</span>                           <span class="hljs-comment"># 元数据部分，包括名称、标签等</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-app-deployment</span>       <span class="hljs-comment"># Deployment的名称</span><br>  <span class="hljs-attr">labels:</span>                           <span class="hljs-comment"># 为该Deployment打标签</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">eureka-app</span>                 <span class="hljs-comment"># 标签键为app，值为eureka-app</span><br><span class="hljs-attr">spec:</span>                               <span class="hljs-comment"># spec：定义 Deployment 的行为：如副本数、选择器、Pod 模板等</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>                       <span class="hljs-comment"># 指定运行1个Pod副本</span><br>  <span class="hljs-attr">selector:</span>                         <span class="hljs-comment"># 定义如何选择要管理的Pod</span><br>    <span class="hljs-attr">matchLabels:</span>                    <span class="hljs-comment"># 匹配具有以下标签的Pod，告诉Kubernetes，“我想要管理那些具有这些标签的所有Pod”</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">eureka-app</span>               <span class="hljs-comment"># 匹配标签app=eureka-app的Pod</span><br>  <span class="hljs-attr">template:</span>                         <span class="hljs-comment"># Pod模板，用于生成实际运行的Pod</span><br>    <span class="hljs-attr">metadata:</span>                       <span class="hljs-comment"># Pod的元数据</span><br>      <span class="hljs-attr">labels:</span>                       <span class="hljs-comment"># Pod的标签</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">eureka-app</span>             <span class="hljs-comment"># 在Pod模板部分定义，用来为新创建的Pod指定标签。当你创建一个Deployment时，它会根据这个模板创建Pod，并给这些Pod打上相应的标签</span><br>    <span class="hljs-attr">spec:</span>                           <span class="hljs-comment"># spec.template.spec：描述 Pod 应该如何创建（即 Pod 的规格）</span><br>      <span class="hljs-attr">containers:</span>                   <span class="hljs-comment"># 容器列表，描述Pod中容器组中的每个容器应该如何运行</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-app</span>          <span class="hljs-comment"># 容器名称</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">eureka-server:02</span>  <span class="hljs-comment"># 使用的镜像地址</span><br>          <span class="hljs-attr">ports:</span>                    <span class="hljs-comment"># 容器暴露的端口列表</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8761</span>   <span class="hljs-comment"># 容器监听的端口号为8761</span><br></code></pre></td></tr></table></figure><blockquote><p>app: eureka-app 在两个地方出现是为了满足不同的目的</p><ul><li>第一个app: eureka-app（在selector.matchLabels中）确保了现有的、具有该标签的Pod会被控制器所管理；</li><li>第二个app: eureka-app（在template.metadata.labels中）确保了根据此模板创建的新Pod也会拥有同样的标签，从而能够被同一个控制器继续管理。</li><li>这两者的结合使用保证了Pod的创建和管理是一致且连贯的。如果没有这两个标签的一致性，可能会导致新的Pod不会被相应的控制器管理，或者旧的Pod不会被更新或替换。</li></ul></blockquote><h3 id="2-创建Deployment-1"><a href="#2-创建Deployment-1" class="headerlink" title="2. 创建Deployment"></a>2. 创建Deployment</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>kubectl apply -f eureka-app-deployment.yaml<br><br>kubectl get deploy,pod<br></code></pre></td></tr></table></figure><h3 id="3-查看应用的启动日志"><a href="#3-查看应用的启动日志" class="headerlink" title="3 .查看应用的启动日志"></a>3 .查看应用的启动日志</h3><p>我们可以通过kubectl logs命令来查看应用的启动日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl logs -f  pod/eureka-app-deployment-5f5d6cf5ff-gfbxv<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250707200430806.png" alt="image-20250707200430806"></p><h2 id="3-创建Service"><a href="#3-创建Service" class="headerlink" title="3. 创建Service"></a>3. <strong>创建Service</strong></h2><p>如果想要从外部访问应用，需要<strong>创建Service</strong>，添加配置文件eureka-app-service.yaml用于创建</p><h3 id="1-增加配置文件-1"><a href="#1-增加配置文件-1" class="headerlink" title="1. 增加配置文件"></a>1. 增加配置文件</h3><p>eureka-app-service.yaml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-app-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span>  <span class="hljs-comment">#标签选择器，用于匹配 Pod</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">eureka-app</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8761</span>         <span class="hljs-comment"># Service 暴露的端口（集群内部访问）</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8761</span>   <span class="hljs-comment"># 容器实际监听的端口（Pod 中容器的端口）</span><br></code></pre></td></tr></table></figure><h3 id="2-创建service"><a href="#2-创建service" class="headerlink" title="2. 创建service"></a>2. 创建service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>kubectl apply -f eureka-app-service.yaml<br><br>kubectl get services<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250707200748407.png" alt="image-20250707200748407"></p><h2 id="4-测试访问"><a href="#4-测试访问" class="headerlink" title="4. 测试访问"></a>4. 测试访问</h2><p>访问<a href="http://localhost:32272/">http://localhost:32272/</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250707200822266.png" alt="image-20250707200822266"></p><h1 id="2-Kubernetes-部署需考虑的问题"><a href="#2-Kubernetes-部署需考虑的问题" class="headerlink" title="2. Kubernetes 部署需考虑的问题"></a>2. Kubernetes 部署需考虑的问题</h1><p>我们有如下微服务：</p><ul><li><p>消息服务：message-service</p></li><li><p>课程dubbo服务：course-dubbo-service</p></li><li><p>课程web服务：course-edge-service</p></li><li><p>用户thrift服务：user-thrift-service</p></li><li><p>用户web服务：user-edge-service</p></li><li><p>API网关：api-gateway</p></li></ul><h2 id="1-Pod-的划分策略"><a href="#1-Pod-的划分策略" class="headerlink" title="1. Pod 的划分策略"></a>1. Pod 的划分策略</h2><p>建议的 Pod 划分方案：</p><ul><li><strong>课程服务组合</strong>：<ul><li><code>course-dubbo-service</code> 和 <code>course-edge-service</code> 放在同一个 Pod 中。</li><li>原因：web 服务频繁调用 dubbo 服务，放在同一 Pod 内可通过 <code>localhost</code> 直接访问，减少网络开销，提高性能。</li></ul></li><li><strong>消息服务</strong>：<ul><li>单独部署为一个 Pod。</li><li>原因：与其他服务耦合度低，独立运行便于维护和扩展。</li></ul></li><li><strong>用户服务组合</strong>：<ul><li><code>user-thrift-service</code> 和 <code>user-edge-service</code> 放在同一个 Pod 中。</li><li>原因：类似课程服务的场景，web 服务主要依赖 thrift 接口。</li></ul></li><li><strong>API 网关</strong>：<ul><li>单独部署为一个 Pod。</li><li>原因：作为所有外部请求的统一入口，需要具备高可用性和负载均衡能力。</li></ul></li></ul><p><strong>小结</strong>：</p><blockquote><p>同一业务域内、调用频繁的服务建议放在同一个 Pod 中，以提升内部通信效率；对外交互频繁或职责独立的服务应单独部署。</p></blockquote><h2 id="2-同一-Pod-内服务如何互相访问"><a href="#2-同一-Pod-内服务如何互相访问" class="headerlink" title="2. 同一 Pod 内服务如何互相访问"></a>2. 同一 Pod 内服务如何互相访问</h2><p>Kubernetes 中，同一个 Pod 内的所有容器共享网络命名空间，因此可以通过 <code>localhost</code> + 端口号的方式直接访问彼此的服务</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 示例：course-edge-service 调用 course-dubbo-service</span><br><span class="hljs-attr">dubbo:</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://localhost:2181</span><br></code></pre></td></tr></table></figure><h2 id="3-如何让服务对外提供访问"><a href="#3-如何让服务对外提供访问" class="headerlink" title="3. 如何让服务对外提供访问"></a>3. 如何让服务对外提供访问</h2><p>每个对外暴露的服务都需要通过 Kubernetes 的 Service 对象来实现访问控制。</p><p><strong>推荐方式：</strong></p><ul><li>使用 <code>ClusterIP</code> 类型的 Service 供内部服务之间访问；</li><li>使用 <code>NodePort</code> 或 <code>LoadBalancer</code> 类型的 Service 对外暴露服务；</li><li>API 网关推荐使用 <code>Ingress</code> 控制器进行统一路由管理。</li></ul><h2 id="4-整个系统的入口是哪个服务？如何对外暴露？"><a href="#4-整个系统的入口是哪个服务？如何对外暴露？" class="headerlink" title="4. 整个系统的入口是哪个服务？如何对外暴露？"></a>4. 整个系统的入口是哪个服务？如何对外暴露？</h2><p>整个系统的核心入口是 <strong>API 网关（api-gateway）</strong>，它负责接收所有外部请求，并根据路由规则转发给对应的微服务。</p><p><strong>对外暴露方式：</strong></p><ul><li>使用 <code>Ingress</code> 控制器结合域名进行统一接入；</li><li>如果没有 Ingress，也可以使用 <code>LoadBalancer</code> 类型的 Service；</li><li>可结合 TLS 加密、限流熔断等机制增强安全性。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Kubernetes</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes部署Nginx</title>
    <link href="/Kubernetes%E9%83%A8%E7%BD%B2Nginx/"/>
    <url>/Kubernetes%E9%83%A8%E7%BD%B2Nginx/</url>
    
    <content type="html"><![CDATA[<h1 id="1-K8S部署Nginx"><a href="#1-K8S部署Nginx" class="headerlink" title="1. K8S部署Nginx"></a>1. <strong>K8S部署Nginx</strong></h1><p>在k8s-master机器上执行</p><h2 id="1-创建一次deployment部署"><a href="#1-创建一次deployment部署" class="headerlink" title="1. 创建一次deployment部署"></a>1. 创建一次deployment部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create deployment nginx ‐‐image=nginx<br></code></pre></td></tr></table></figure><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250703222411043.png" alt="image-20250703222411043" style="zoom:100%;" /><h2 id="2-创建-Service"><a href="#2-创建-Service" class="headerlink" title="2. 创建 Service"></a>2. 创建 Service</h2><p>使用 <code>kubectl expose</code> 来为之前创建的名为 <code>nginx</code> 的 Deployment 创建一个 Service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl expose deployment nginx ‐‐port=80 ‐‐type=NodePort<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250703222504494.png" alt="image-20250703222504494"></p><h2 id="3-访问Nginx地址"><a href="#3-访问Nginx地址" class="headerlink" title="3. 访问Nginx地址"></a>3. 访问Nginx地址</h2><p> <a href="http://localhost:30918/">http://localhost:30918/</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250703221802668.png" alt="image-20250703221802668"></p><h2 id="4-对nginx这个deployment进行扩缩容"><a href="#4-对nginx这个deployment进行扩缩容" class="headerlink" title="4. 对nginx这个deployment进行扩缩容"></a>4. <strong>对nginx这个deployment进行扩缩容</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl scale --replicas=2 deployment nginx<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250703224359533.png" alt="image-20250703224359533"></p><h2 id="5-滚动升级"><a href="#5-滚动升级" class="headerlink" title="5. 滚动升级"></a>5. 滚动升级</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl set image deployment.apps/nginx  nginx=nginx:1.28.0<br></code></pre></td></tr></table></figure><ul><li><code>deployment.apps/nginx</code>: 指定了要操作的目标资源类型（Deployment）及其名称（nginx）。</li><li><code>nginx=nginx:1.28.0</code>: 这部分指定了容器名和新的镜像名称及标签。其中 <code>nginx</code> 是 Deployment <code>nginx</code> 中容器的名字，而 <code>nginx:1.28.0</code> 是你希望更新到的新镜像。</li></ul><p>使用 <code>curl</code> 发送请求：查看响应头中的 <code>Server</code> 字段来获取 Nginx 版本信息</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705115801052.png" alt="image-20250705115801052"></p><p>查看某个pod的详细信息，发现pod里的镜像版本已经升级了</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250703230511156.png" alt="image-20250703230511156"></p><h2 id="6-版本回滚"><a href="#6-版本回滚" class="headerlink" title="6. 版本回滚"></a>6. 版本回滚</h2><h3 id="1-查看历史版本"><a href="#1-查看历史版本" class="headerlink" title="1. 查看历史版本"></a>1. 查看历史版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl rollout history deploy nginx<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705120109209.png" alt="image-20250705120109209"></p><h3 id="2-回滚到上一个版本"><a href="#2-回滚到上一个版本" class="headerlink" title="2. 回滚到上一个版本"></a>2. 回滚到上一个版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl rollout undo deploy nginx   #‐‐to‐revision 参数可以指定回退的版本<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705120156769.png" alt="image-20250705120156769"></p><p>再次使用 <code>curl</code> 访问nginx，发现版本已经回退</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705120352860.png" alt="image-20250705120352860"></p><h2 id="7-标签的使用"><a href="#7-标签的使用" class="headerlink" title="7, 标签的使用"></a>7, <strong>标签的使用</strong></h2><p>通过给资源添加Label，可以方便地管理资源（如Deployment、Pod、Service等）。</p><h3 id="1-查看Deployment中所包含的Label"><a href="#1-查看Deployment中所包含的Label" class="headerlink" title="1. 查看Deployment中所包含的Label"></a>1. 查看Deployment中所包含的Label</h3><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705120548151.png" alt="image-20250705120548151"></p><h3 id="2-通过Label查询Pod"><a href="#2-通过Label查询Pod" class="headerlink" title="2. 通过Label查询Pod"></a>2. 通过Label查询Pod</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-builtin-name">get</span> pods -l <span class="hljs-attribute">app</span>=nginx<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705155913531.png" alt="image-20250705155913531"></p><h3 id="3-通过Label查询Service"><a href="#3-通过Label查询Service" class="headerlink" title="3. 通过Label查询Service"></a>3. 通过Label查询Service</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-builtin-name">get</span> services ‐l <span class="hljs-attribute">app</span>=nginx<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705155936913.png" alt="image-20250705155936913"></p><h3 id="4-给Pod添加Label"><a href="#4-给Pod添加Label" class="headerlink" title="4. 给Pod添加Label"></a>4. 给Pod添加Label</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl label pod my‐tomcat‐685b8fd9c9‐lrwst version=test-label<br></code></pre></td></tr></table></figure><h3 id="5-通过Label查询Pod"><a href="#5-通过Label查询Pod" class="headerlink" title="5. 通过Label查询Pod"></a>5. 通过Label查询Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get pods ‐l version=test-label<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250705160210458.png" alt="image-20250705160210458"></p><h3 id="6-通过Label删除服务"><a href="#6-通过Label删除服务" class="headerlink" title="6. 通过Label删除服务"></a>6. 通过Label删除服务</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl delete<span class="hljs-built_in"> service </span>‐l <span class="hljs-attribute">app</span>=test-label<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes核心原理</title>
    <link href="/Kubernetes%E5%BF%AB%E9%80%9F%E5%AE%9E%E6%88%98%E4%B8%8E%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/"/>
    <url>/Kubernetes%E5%BF%AB%E9%80%9F%E5%AE%9E%E6%88%98%E4%B8%8E%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="1-K8s简介"><a href="#1-K8s简介" class="headerlink" title="1.  K8s简介"></a>1.  K8s简介</h1><p>Kubernetes（通常简称为K8s）是一个开源的容器编排的工具，用于<strong>自动化部署、扩展和管理容器化应用</strong>。它提供了一组丰富的功能和工具，用于简化容器化应用程序的部署、伸缩和运维。</p><p><strong>为什么出现k8s?</strong></p><p>这要容器技术兴起开始说，为了解决“一次打包，到处运行”的问题，大家引入了docker,  随着项目越来越大，一个微服务应用可能由几十个甚至上百个容器组成，这时候就出现了新的问题。</p><ol><li>容器的管理问题： 启动、停止、重启、升级很多容器很麻烦</li><li>如何自动重启失败的容器？如果某个服务挂了，怎么让它自动恢复？</li><li>如何应对流量高峰？实现自动扩容？</li><li>多个容器分布在不同机器上时，怎么通信，网络怎么配？</li><li>怎么更实现更新版本时，用户不能感知到停机？</li></ol><p>这些问题加在一起， 导致运维工作变得极其复杂。Google 看到了这个问题，开发了 Kubernetes，目标就是：提供一个统一的平台，用来自动化地部署、扩展和管理容器化应用。</p><p>你可以把他想象成一个容器管家：</p><ul><li>你告诉它：“我要运行一个服务，副本数是3个。”</li><li>它就会自动帮你启动3个容器，并确保它们一直正常运行。</li><li>如果其中一个容器坏了，它会自动重新启动一个新的。</li><li>如果访问量变多了，它可以自动增加副本数量。</li><li>所有这些都不需要你手动操作。</li></ul><h1 id="2-K8s核心特性"><a href="#2-K8s核心特性" class="headerlink" title="2. K8s核心特性"></a>2. <strong>K8s核心特性</strong></h1><ul><li>服务发现与负载均衡：无需修改你的应用程序即可使用陌生的服务发现机制。</li><li>自我修复：重新启动失败的容器，在节点死亡时替换并重新调度容器，杀死不响应用户定义的健康检查的容器。</li><li>自动化上线和回滚：Kubernetes会分步骤地将针对应用或其配置的更改上线，同时监视应用程序运行状况以确保你不会同时终止所有实例。</li><li>水平扩缩：使用一个简单的命令、一个UI或基于CPU使用情况自动对应用程序进行扩缩。</li><li>存储编排：自动挂载所选存储系统，包括本地存储。</li><li>Secret和配置管理：部署更新Secrets和应用程序的配置时不必重新构建容器镜像，且不必将软件堆栈配置中的秘密信息暴露出来。</li><li>批量执行：除了服务之外，Kubernetes还可以管理你的批处理和CI工作负载，在期望时替换掉失效的容器。</li><li>自动装箱：根据资源需求和其他约束自动放置容器，同时避免影响可用性。</li></ul><p>使用场景：快速部署应用、快速扩展应用、无缝对接新的应用功能、节省资源，优化硬件资源的使用；</p><h1 id="3-K8s核心概念"><a href="#3-K8s核心概念" class="headerlink" title="3. K8s核心概念"></a>3. K8s核心概念</h1><h2 id="1-Pod"><a href="#1-Pod" class="headerlink" title="1 Pod"></a>1 Pod</h2><h3 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h3><p>Pod 是 Kubernetes 中最小的可部署单元。一个 Pod 可以包含一个或多个容器（通常是一个），这些容器共享存储、网络和规范化的运行配置。</p><ul><li>所有的应用，服务最终都是运行在pod上</li><li>pod有一个独立的ip，pod里的容器可以共享网络，共享IP</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250713152823707.png" alt="image-20250713152823707" style="zoom:50%;" /><h3 id="2-pod的生命周期"><a href="#2-pod的生命周期" class="headerlink" title="2. pod的生命周期"></a>2. pod的生命周期</h3><p>Pending（挂起）：API server已经创建pod并保存在Etcd当中，但这个Pod里有些容器因为某种原因而不能被顺利创建。比如，正在下载镜像的过程，配置文件有误</p><p>Running（运行中）：Pod内所有的容器已经创建，且至少有一个容器处于运行状态、正在启动括正在重启状态；</p><p>Succeed（成功）：Pod内所有容器均已退出，且不会再重启；</p><p>Failed（失败）：Pod内所有容器均已退出，且至少有一个容器为退出失败状态</p><p>Unknown（未知）：某于某种原因apiserver无法获取该pod的状态，可能由于网络通行问题导致；</p><h3 id="3-pod的重启策略"><a href="#3-pod的重启策略" class="headerlink" title="3. pod的重启策略"></a>3. pod的重启策略</h3><p>通过命令<code>kubectl explain pod.spec</code>查看pod的重启策略。</p><ul><li>Always：但凡pod对象终止就重启，此为默认策略;</li><li>Never： 不重启</li><li>OnFailure：仅在pod对象出现错误时才重启;</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250713174239215.png" alt="image-20250713174239215" style="zoom:50%;" /><blockquote><p>docker 的重启策略是：</p><ul><li><p><strong>no</strong>：默认策略，容器退出后不会自动重启。适用于一次性任务或测试场景。</p></li><li><p><strong>always</strong>：无论退出原因，容器都会自动重启。即使 Docker 守护进程重启，容器也会随之启动。</p></li><li><p>**on-failure[:n]**：仅在容器异常退出（非 0 状态码）时重启。可选参数 <em>n</em> 指定最大重启次数。</p></li><li><p><strong>unless-stopped</strong>：与 <em>always</em> 类似，但如果容器被手动停止（如 <em>docker stop</em>），即使 Docker 守护进程重启，容器也不会自动启动。</p></li></ul></blockquote><h2 id="2-Deployment"><a href="#2-Deployment" class="headerlink" title="2 Deployment"></a>2 Deployment</h2><p>Deployment 是一种控制器对象，用于管理 Pod 的部署和扩展。它提供了一种声明式的方法来描述期望的应用程序状态。</p><ul><li>Deployment 负责管理其下所有 Pod 的生命周期，包括创建、更新和删除。如果某个 Pod 失败或被删除，Deployment 会自动创建新的 Pod 来替换它。</li><li>通过 Deployment，您可以定义应用程序所需的副本数量，并确保集群中始终有指定数量的 Pod 在运行。此外，Deployment 支持滚动更新（Rolling Updates）和回滚（Rollbacks），使得应用更新过程更加平滑。</li></ul><h2 id="3-service"><a href="#3-service" class="headerlink" title="3 service"></a>3 service</h2><p>Service 定义了一组逻辑 Pods 和访问这组 Pods 的策略，是真实服务的抽象。Service 提供了一个 IP 地址和 DNS 名称，用于稳定地访问这些 Pods。</p><ul><li><p>由于 Pod 是动态的，它们可能因为各种原因被销毁和重建，导致 IP 地址变化。Service 提供了一个稳定的网络端点，使得其他服务或外部用户能够可靠地与一组 Pods 进行通信，如果没有Service，pod的IP不会暴露在群集外部。</p></li><li><p>Service也可以用在ServiceSpec标记type的方式暴露，type类型如下：</p><ul><li><p>ClusterIP（默认）：在集群的内部IP上公开Service。这种类型使得Service只能从集群内访问。</p></li><li><p>NodePort：使用NAT在集群中每个选定Node的相同端口上公开Service。使用 <NodeIP>:<NodePort> 从集群外部访问Service。是ClusterIP的超集。</p></li><li><p>LoadBalancer：在当前云中创建一个外部负载均衡器(如果支持的话)，并为Service分配一个固定的外部IP。是NodePort的超集。</p></li><li><p>ExternalName：通过返回带有该名称的CNAME记录，使用任意名称（由spec中的externalName指定）公开Service。不使用代理。</p></li></ul></li></ul><blockquote><p>为什么Pod已经有了IP还需要service再包一层呢？</p><ul><li>当Pod出现意外挂掉时，这个服务无法访问，他肯定会去其他位置新启动一个服务，通过service的IP依旧可以找到这个新建的服务</li></ul></blockquote><h2 id="4-Volume"><a href="#4-Volume" class="headerlink" title="4 Volume"></a>4 <strong>Volume</strong></h2><p>Volume是Pod中能够被多个容器访问的共享目录，Kubernetes中的Volume是定义在Pod上，可以被一个或多个Pod中的容器挂载到某个目录下</p><h2 id="5-Namespace"><a href="#5-Namespace" class="headerlink" title="5 Namespace"></a>5 <strong>Namespace</strong></h2><p>Namespace用于实现多租户的资源隔离，可将集群内部的资源对象分配到不同的Namespace中，形成逻辑上的不同项目、小组或用户组，便于不同的Namespace在共享使用整个集群的资源的同时还能被分别管理；</p><h1 id="4-K8s的组件有哪些？作用是什么？"><a href="#4-K8s的组件有哪些？作用是什么？" class="headerlink" title="4. K8s的组件有哪些？作用是什么？"></a>4. <strong>K8s的组件有哪些？作用是什么？</strong></h1><p>K8s需要一个集群来运行和管理容器化应用程序。Kubernetes 集群由多个计算节点组成，其中包括主节点（Master Node）和从节点（Worker Node）。</p><ul><li><p>主节点负责管理整个集群的，安装了K8s的核心组件。</p></li><li><p>从节点是容器应用真正运行的地方。</p><ul><li>从节点（Worker Node）上的容器化环境一般是通过 Docker 运行的。</li><li>每个 Worker Node 上可以运行多个容器， 其中每个容器都可以托管一个或多个 Pod。</li></ul></li><li><p>master节点包含的组件有：kube-api-server、kube-controller-manager、kube-scheduler、etcd</p></li><li><p>node节点包含的组件有：kubelet、kube-proxy、container-runtime</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250701214938688.png" alt="image-20250701214938688"></p><h2 id="1-Master-Node的组件"><a href="#1-Master-Node的组件" class="headerlink" title="1  Master Node的组件"></a>1  <strong>Master Node</strong>的组件</h2><h3 id="1-kube-API-Server"><a href="#1-kube-API-Server" class="headerlink" title="1. kube API Server"></a>1. <strong>kube API Server</strong></h3><ul><li><p><strong>K8S 的请求入口服务</strong>。</p></li><li><p>它是k8s集群管理的统一访问入口，接收 K8S 所有请求，实现了认证、授权和准入控制等安全功能；</p></li><li><p>API Server 根据用户的具体请求，去通知其他组件干活。</p></li><li><p>api-server是其他组件之间的数据交互和通信的枢纽，其他组件彼此之间并不会直接通信，其他组件对资源对象的增、删、改、查和监听操作都是交由api-server处理后，api-server再提交给etcd数据库做持久化存储，只有api-server才能直接操作etcd数据库，其他组件都不能直接操作etcd数据库，其他组件都是通过api-server间接的读取，写入数据到etcd。</p></li></ul><h3 id="2-kube-Controller-Manager"><a href="#2-kube-Controller-Manager" class="headerlink" title="2. kube Controller Manager"></a>2. <strong>kube Controller Manager</strong></h3><ul><li><strong>k8s集群内部的管理控制中心</strong>， 他是Kubernetes的大脑，它通过apiserver监控整个集群的状态，并确保集群处于预期的工作状态。</li><li>kube-controller-manager由一系列的控制器组成，像Replication Controller控制副本，Node Controller节点控制，Deployment Controller管理deployment等等</li><li>Controller 负责监控和调整在 Worker Node 上部署的服务的状态，比如用户要求 A 服务部署 2 个副本，那么当其中一个服务挂了的时候，Controller 会马上调整，让 Scheduler 再选择一个 Worker Node 重新部署服务。</li></ul><h3 id="3-kube-Scheduler"><a href="#3-kube-Scheduler" class="headerlink" title="3. kube Scheduler"></a>3. <strong>kube Scheduler</strong></h3><ul><li><strong>K8S 负责集群资源调度的调度器</strong>。</li><li>其作用是将待调度的pod通过一系列复杂的调度算法计算出最合适的node节点，然后将pod绑定到目标节点上。当用户要部署服务时，Scheduler 会选择最合适的Worker Node（服务器）来部署。</li></ul><h3 id="4-etcd"><a href="#4-etcd" class="headerlink" title="4. etcd"></a>4. <strong>etcd</strong></h3><ul><li><strong>K8S 的存储服务， 是一个分布式的键值对存储数据库</strong>。</li><li>etcd 存储了 K8S 的关键配置和用户配置，像k8s本身的节点信息，组件信息，还有通过kubernetes运行的pod，deployment，service等等, 都需要持久化到etc。</li><li>K8S 中仅 API Server 才具备读写权限，其他组件必须通过 API Server 的接口才能读写数据。</li><li>生产环境中为了保证数据中心的高可用和数据的一致性，一般会部署最少三个节点。</li></ul><h2 id="2-Worker-Node的组件"><a href="#2-Worker-Node的组件" class="headerlink" title="2  Worker Node的组件"></a>2  <strong>Worker Node</strong>的组件</h2><h3 id="1-Kubelet"><a href="#1-Kubelet" class="headerlink" title="1.  Kubelet"></a>1.  <strong>Kubelet</strong></h3><ul><li><strong>Worker Node 的监视器，以及与 Master Node 的通讯器</strong>。</li><li>每个工作节点上都运行一个kubelet服务进程，它会定期向 Master Node 汇报自己 Node 上运行的服务的状态，并接收并执行master发来的指令，管理Pod及Pod中的容器。比如创建、更新、终止pod等任务，kubelet 即通过控制docker来创建、更新、销毁容器。</li></ul><h3 id="2-Kube-Proxy"><a href="#2-Kube-Proxy" class="headerlink" title="2. Kube-Proxy"></a>2. <strong>Kube-Proxy</strong></h3><ul><li><strong>K8S 的网络代理</strong>。Kube-Proxy 负责 Node 在 K8S 的网络通讯、以及对外部网络流量的负载均衡。</li><li>核心功能是将到某个Service的访问请求转发到后端的多个Pod实例上</li></ul><h3 id="3-Container-Runtime"><a href="#3-Container-Runtime" class="headerlink" title="3. Container Runtime"></a>3. Container Runtime</h3><ul><li><strong>Worker Node 的运行环境</strong>。即安装了容器化所需的软件环境确保容器化程序能够跑起来，比如 Docker Engine运行环境。</li></ul><h2 id="3-各组件协同工作的过程"><a href="#3-各组件协同工作的过程" class="headerlink" title="3 各组件协同工作的过程"></a>3 各组件协同工作的过程</h2><p>以用K8S部署Nginx的过程为例, <strong>我们在master节点执行一条命令要master部署一个nginx应用</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create deployment nginx --image=nginx<br></code></pre></td></tr></table></figure><ol><li>这条命令首先发到master节点的网关api server，这是matser的唯一入口</li><li>kube api server将命令请求交给kube controller mannager进行控制</li><li>kube controller mannager 进行应用部署解析.  controller mannager 会生成一次部署信息，并通过api server将信息存入etcd存储中</li><li>kube scheduler调度器通过api server从etcd存储中，拿到要部署的应用，开始调度看哪个节点有资源适合部署,   scheduler把计算出来的调度信息通过api server再放到etcd中</li><li>每一个node节点的监控组件kubelet，随时和master保持联系（给api-server发送请求不断获取最新数据），拿到master节点存储在etcd中的部署信息</li><li>假设node2的kubelet拿到部署信息，显示他自己节点要部署某某应用. kubelet就自己run一个应用在当前机器上，并随时给master汇报当前应用的状态信息,  node和master也是通过master的api-server组件联系的</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250713122653667.png" alt="image-20250713122653667"></p><h1 id="5-kubelet的功能、作用是什么？"><a href="#5-kubelet的功能、作用是什么？" class="headerlink" title="5. kubelet的功能、作用是什么？"></a>5. kubelet的功能、作用是什么？</h1><p>kubelet是部署在每个node节点上的，它主要有4个功能：</p><h2 id="1-节点管理"><a href="#1-节点管理" class="headerlink" title="1. 节点管理"></a>1. 节点管理</h2><p>kubelet启动时会向api-server进行注册，然后会定时的向api-server汇报本节点信息状态，资源使用状态等，这样master就能够知道node节点的资源剩余，节点是否失联等等相关的信息了。master知道了整个集群所有节点的资源情况，这对于 pod 的调度和正常运行至关重要。</p><h2 id="2-pod管理"><a href="#2-pod管理" class="headerlink" title="2. pod管理"></a>2. pod管理</h2><p>kubelet负责维护node节点上pod的生命周期，当kubelet监听到master的下发到自己节点的任务时，比如要创建、更新、删除一个pod，kubelet 就会通过CRI（容器运行时接口）插件来调用不同的容器运行时来创建、更新、删除容器；</p><h2 id="3-容器健康检查"><a href="#3-容器健康检查" class="headerlink" title="3. 容器健康检查"></a>3. 容器健康检查</h2><p>pod中可以定义启动探针、存活探针、就绪探针等3种，我们最常用的就是存活探针、就绪探针，kubelet 会定期调用容器中的探针来检测容器是否存活，是否就绪，如果是存活探针，则会根据探测结果对检查失败的容器进行相应的重启策略。</p><h2 id="4-Metrics-Server资源监控"><a href="#4-Metrics-Server资源监控" class="headerlink" title="4. Metrics Server资源监控"></a>4. Metrics Server资源监控</h2><p>在node节点上部署Metrics Server用于监控node节点、pod的CPU、内存、文件系统、网络使用等资源使用情况，而kubelet则通过Metrics Server获取所在节点及容器的上的数据。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT设计思维</title>
    <link href="/PPT%E8%AE%BE%E8%AE%A1%E6%80%9D%E7%BB%B4/"/>
    <url>/PPT%E8%AE%BE%E8%AE%A1%E6%80%9D%E7%BB%B4/</url>
    
    <content type="html"><![CDATA[<h1 id="1-丢掉默认"><a href="#1-丢掉默认" class="headerlink" title="1.  丢掉默认"></a>1.  丢掉默认</h1><h2 id="1-留白"><a href="#1-留白" class="headerlink" title="1. 留白"></a>1. 留白</h2><ul><li><p>面对默认的版面和模版，注意检查留白，通常都会发现留白太少</p></li><li><p>留白要适当，不是越大越好，但通常是大留白比较好驾驭，尤其内容不多的时候</p></li><li><p>不要在一页幻灯片堆砌很多的内容，不要让幻灯片看起来很满，满就是挤，眼睛里要注意的内容太多，视觉就容易紧张</p></li><li><p>甚至，一页幻灯片越少越容易设计，越空越容易排版</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624205531116.png" alt="image-20250624205531116"></p><h2 id="2-行距"><a href="#2-行距" class="headerlink" title="2. 行距"></a>2. 行距</h2><ul><li>当你插入了或者面对一段默认的文本框&#x2F;文字，注意观察行距是否拥挤</li><li>大段文字（3行以上），一般<strong>1.2-1.5</strong>的单倍行距比较舒适，根据不同的字体字号，需要自行尝试</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624211146300.png" alt="image-20250624211146300"></p><h2 id="3-段距"><a href="#3-段距" class="headerlink" title="3. 段距"></a>3. 段距</h2><ul><li>当你插入或者面对2段以上的文字，注意不同段落之间，是否过于紧凑</li><li>大段的文字，一般需要分开层次和间隔，以缓解视觉舒适</li><li>如果对内容进行了分类、分层、片区，则这些分类、层次、片区之间的间隔，通常应该明显的大于其内部的间隔分区内部靠紧一点，表示他们再关系上的相近，是“一国的”。</li><li>标题部分和内容部分天然就是不同的层次，通常应该有明显的间隔区分;</li><li>行间距&lt;分区内段落间距&lt;小标题到正文间距&lt;分区间距&lt;大标题到整体内容间距&lt;页面留白</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624212432602.png" alt="image-20250624212432602"></p><h2 id="4-距离太大"><a href="#4-距离太大" class="headerlink" title="4. 距离太大"></a>4. 距离太大</h2><ul><li>距离也有可能过大而松散、单薄或空虚，就需要反过来，适当的消减间距和版面空白，增加内容占位</li><li>方法：<ul><li>增大字体</li><li>放大内容</li><li>增补内容</li><li>衬底补位</li><li>修饰补位</li><li>图片补位</li><li>内容图形化</li></ul></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624213712962.png" alt="image-20250624213712962"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624214028136.png" alt="image-20250624214028136"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624214102485.png" alt="image-20250624214102485"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624214126758.png" alt="image-20250624214126758"></p><h2 id="5-字体"><a href="#5-字体" class="headerlink" title="5. 字体"></a>5. 字体</h2><ul><li>恰当的字体：注意收集字体的素材，各种类型的字体都可以储备一些;不确定什么样的字体合适，可以多换一下试试看;</li><li>安全的字体：一般幻灯片都可以使用微软雅黑，是非常安全的字体大段的文字，一般的印刷字体(宋体和楷体)也比较安全。2016版本新出的等线字体也非常的安全(本课件的字体就是等线)</li><li>友情提示：一页幻灯片里不要使用过多的字体，最好就只用1-2种字体越是个性的字体，越是要谨慎的少量使用，大量使用一般会比较花。</li><li>默认的大多数问题，是字体字号过大，体积占位过大，导致内部单位之间的间隔比较小，整体留白不足，产生的不协调感受。</li></ul><h2 id="6-案例对比"><a href="#6-案例对比" class="headerlink" title="6. 案例对比"></a>6. 案例对比</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250624214729393.png" alt="image-20250624214729393"></p><h1 id="2-时间轴制作要点"><a href="#2-时间轴制作要点" class="headerlink" title="2. 时间轴制作要点"></a>2. 时间轴制作要点</h1><ol><li>本质：点、线、内容</li><li>可视化：图片、图标、背景</li><li>制作要点：层级区分、不设终点、只升不降</li></ol>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT文字太少美化</title>
    <link href="/PPT%E6%96%87%E5%AD%97%E5%A4%AA%E5%B0%91%E7%BE%8E%E5%8C%96/"/>
    <url>/PPT%E6%96%87%E5%AD%97%E5%A4%AA%E5%B0%91%E7%BE%8E%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="1-根据演讲删减内容"><a href="#1-根据演讲删减内容" class="headerlink" title="1. 根据演讲删减内容"></a>1. 根据演讲删减内容</h1><p>只保留关键的内容进行排版，不重要的内容通过演讲者口述</p><ul><li>改造前：</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170127090.png" alt="image-20250622170127090" style="zoom:50%;" /><ul><li>改造后</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170228451.png" alt="image-20250622170228451" style="zoom:50%;" /><h1 id="2-无中生有"><a href="#2-无中生有" class="headerlink" title="2. 无中生有"></a>2. 无中生有</h1><h2 id="1-提炼关键的中文进行强调"><a href="#1-提炼关键的中文进行强调" class="headerlink" title="1. 提炼关键的中文进行强调"></a>1. 提炼关键的中文进行强调</h2><ul><li>改造前</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170433359.png" alt="image-20250622170433359" style="zoom:50%;" /><ul><li>改造后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170529224.png" alt="image-20250622170529224"></p><h2 id="2-增加对应内容丰富页面"><a href="#2-增加对应内容丰富页面" class="headerlink" title="2. 增加对应内容丰富页面"></a>2. 增加对应内容丰富页面</h2><ul><li>改造前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170629797.png" alt="image-20250622170629797"></p><ul><li>改造后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170711786.png" alt="image-20250622170711786"></p><h2 id="3-增加英文文案"><a href="#3-增加英文文案" class="headerlink" title="3. 增加英文文案"></a>3. 增加英文文案</h2><ul><li>改造前</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170751418.png" alt="image-20250622170751418" style="zoom:50%;" /><ul><li>改造后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170818946.png" alt="image-20250622170818946"></p><h1 id="3-提高“图版率”"><a href="#3-提高“图版率”" class="headerlink" title="3. 提高“图版率”"></a>3. 提高“图版率”</h1><h2 id="1-增加图片"><a href="#1-增加图片" class="headerlink" title="1. 增加图片"></a>1. 增加图片</h2><h2 id="2-增加色块"><a href="#2-增加色块" class="headerlink" title="2. 增加色块"></a>2. 增加色块</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170904451.png" alt="image-20250622170904451"></p><h2 id="3-增加线段"><a href="#3-增加线段" class="headerlink" title="3. 增加线段"></a>3. 增加线段</h2><p>改造完成后，线段会撑开整体内容所占面积</p><ul><li>改造前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622170927217.png" alt="image-20250622170927217"></p><ul><li>改造后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171005154.png" alt="image-20250622171005154"></p><h2 id="4-增加文字图形占比"><a href="#4-增加文字图形占比" class="headerlink" title="4. 增加文字图形占比"></a>4. 增加文字图形占比</h2><p>放大部分文字内容，改造字体样式</p><ul><li>改造前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171135415.png" alt="image-20250622171135415"></p><ul><li>改造后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171216067.png" alt="image-20250622171216067"></p><ul><li>改造前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171243083.png" alt="image-20250622171243083"></p><ul><li>改造后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171307159.png" alt="image-20250622171307159"></p><h2 id="5-认为制造视觉焦点"><a href="#5-认为制造视觉焦点" class="headerlink" title="5. 认为制造视觉焦点"></a>5. 认为制造视觉焦点</h2><h3 id="1-序号"><a href="#1-序号" class="headerlink" title="1. 序号"></a>1. 序号</h3><ul><li>前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171541209.png" alt="image-20250622171541209"></p><ul><li>后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171603487.png" alt="image-20250622171603487"></p><h3 id="2-着重色块"><a href="#2-着重色块" class="headerlink" title="2. 着重色块"></a>2. 着重色块</h3><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171636849.png" alt="image-20250622171636849"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171653273.png" alt="image-20250622171653273"></p><h3 id="3-图标"><a href="#3-图标" class="headerlink" title="3. 图标"></a>3. 图标</h3><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171704235.png" alt="image-20250622171704235"></p><h2 id="6-卡片式设计"><a href="#6-卡片式设计" class="headerlink" title="6. 卡片式设计"></a>6. 卡片式设计</h2><p>先做提炼，再做卡片式设计</p><ul><li>前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171728628.png" alt="image-20250622171728628"></p><ul><li>后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171749555.png" alt="image-20250622171749555"></p><h2 id="7-综合使用"><a href="#7-综合使用" class="headerlink" title="7. 综合使用"></a>7. 综合使用</h2><ul><li>前</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171846471.png" alt="image-20250622171846471"></p><ul><li>后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250622171915982.png" alt="image-20250622171915982"></p>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT配色的方法</title>
    <link href="/PPT%E9%85%8D%E8%89%B2%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <url>/PPT%E9%85%8D%E8%89%B2%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="1-四大配色方案"><a href="#1-四大配色方案" class="headerlink" title="1. 四大配色方案"></a>1. 四大配色方案</h1><h2 id="1-单色系"><a href="#1-单色系" class="headerlink" title="1. 单色系"></a>1. 单色系</h2><ol><li>定义：任选一个彩色与黑白灰进行搭配</li></ol><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620201957934.png" alt="image-20250620201957934" style="zoom:50%;" /><ol start="2"><li>使用：彩色一定是放在重要的位置上</li><li>具体场景</li></ol><ul><li>单纯罗列</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202918477.png" alt="image-20250620202918477" style="zoom:50%;" /><ul><li>强调某一个</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202938635.png" alt="image-20250620202938635" style="zoom:50%;" /><h2 id="2-同色系"><a href="#2-同色系" class="headerlink" title="2. 同色系"></a>2. 同色系</h2><ol><li>定义：在同色系中任选3-4个，与黑白灰进行搭配</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202048144.png" alt="image-20250620202048144"></p><h2 id="3-邻近色"><a href="#3-邻近色" class="headerlink" title="3. 邻近色"></a>3. 邻近色</h2><ol><li>定义：邻近色与黑白灰进行搭配，做渐变会比较自然</li></ol><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202126505.png" alt="image-20250620202126505" style="zoom:50%;" /><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202146858.png" alt="image-20250620202146858" style="zoom:50%;" /><h2 id="4-对比色"><a href="#4-对比色" class="headerlink" title="4. 对比色"></a>4. 对比色</h2><ol><li>定义：对比色与黑白灰进行搭配，对比色用来强调某一个内容</li></ol><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202220774.png" alt="image-20250620202220774" style="zoom:50%;" /><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620202232350.png" alt="image-20250620202232350" style="zoom:50%;" /><ol start="2"><li>使用</li></ol><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250620204215469.png" alt="image-20250620204215469" style="zoom:50%;" /><h1 id="2-Color-Claim"><a href="#2-Color-Claim" class="headerlink" title="2.  Color Claim"></a>2.  Color Claim</h1><p>网站地址:<a href="https://www.vanschneider.com/colors">https://www.vanschneider.com/colors</a></p><ul><li>比较独特的配色，搜集了较多配色，无需翻墙即可使用</li><li>配色多是两种颜色，适合PPT初学者</li><li>缺点是颜色库较少</li></ul>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT常见操作</title>
    <link href="/PPT%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C/"/>
    <url>/PPT%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="1-统一更改PPT字体"><a href="#1-统一更改PPT字体" class="headerlink" title="1. 统一更改PPT字体"></a>1. 统一更改PPT字体</h1><p>设计 -》 字体</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250619214803627.png" alt="image-20250619214803627"></p><h1 id="2-文字在图片里居中"><a href="#2-文字在图片里居中" class="headerlink" title="2. 文字在图片里居中"></a>2. 文字在图片里居中</h1><p>形状里直接可以插入文本，更改颜色，不需要在形状里再插入文本框</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250619215105165.png" alt="image-20250619215105165"></p><h1 id="3-更改形状"><a href="#3-更改形状" class="headerlink" title="3. 更改形状"></a>3. 更改形状</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250619215135658.png" alt="image-20250619215135658"></p>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>docker部署java服务踩坑记录</title>
    <link href="/docker%E9%83%A8%E7%BD%B2java%E6%9C%8D%E5%8A%A1%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    <url>/docker%E9%83%A8%E7%BD%B2java%E6%9C%8D%E5%8A%A1%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h1 id="1-java-net-UnknownHostException"><a href="#1-java-net-UnknownHostException" class="headerlink" title="1. java.net.UnknownHostException"></a>1. java.net.UnknownHostException</h1><h2 id="1-1-问题"><a href="#1-1-问题" class="headerlink" title="1.1. 问题"></a>1.1. 问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">InetAddress address = InetAddress.getLocalHost();<br></code></pre></td></tr></table></figure><p>在上述代码中，我们尝试通过 <code>InetAddress.getHostAddress()</code> 方法获取主机名对应的Host地址。如果主机名无法解析，将抛出 <code>UnknownHostException</code> 异常。</p><p><strong>错误日志日志截图</strong></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/1750210808068-80321ab6-8263-419d-a28d-42d8abae6cc6.png" alt="img"></p><h2 id="1-2-解决"><a href="#1-2-解决" class="headerlink" title="1.2. 解决"></a>1.2. 解决</h2><p>修改hosts文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">vim /etc/hosts<br>10.108.200.83 ZJ-Test-Mycim<br></code></pre></td></tr></table></figure><h1 id="2-时区提前了8小时"><a href="#2-时区提前了8小时" class="headerlink" title="2. 时区提前了8小时"></a>2. 时区提前了8小时</h1><h2 id="2-1-问题"><a href="#2-1-问题" class="headerlink" title="2.1. 问题"></a>2.1. 问题</h2><ul><li>日志时间提前了8小时</li><li>业务逻辑中使用了时间比较的会报错，时间还没到</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">String currentTime = formatTime.format(new Date());<br></code></pre></td></tr></table></figure><h2 id="2-2-解决"><a href="#2-2-解决" class="headerlink" title="2.2. 解决"></a>2.2. 解决</h2><p>增加时区映射</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">-e TZ=Asia/Shanghai \<br>-v <span class="hljs-regexp">/etc/</span>localtime:<span class="hljs-regexp">/etc/</span>localtime:ro \<br></code></pre></td></tr></table></figure><h1 id="3-No-such-file-or-directory"><a href="#3-No-such-file-or-directory" class="headerlink" title="3. No such file or directory"></a>3. No such file or directory</h1><h2 id="3-1-问题"><a href="#3-1-问题" class="headerlink" title="3.1. 问题"></a>3.1. 问题</h2><p>文件创建失败，报错&#x2F;home&#x2F;oracle&#x2F;ftp&#x2F;e2feea11-7d6e-4e51-95d0-b51fc6f16d27.txt (No such file or directory)”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">File fileOut = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/home/oracle/ftp/&quot;</span>+txtUuid+<span class="hljs-string">&quot;.txt&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="3-2-解决"><a href="#3-2-解决" class="headerlink" title="3.2. 解决"></a>3.2. 解决</h2><p>容器里创建了&#x2F;home&#x2F;oracle&#x2F;ftp&#x2F;目录，并且映射到了宿主机</p><h1 id="4-与其他系统通信失败"><a href="#4-与其他系统通信失败" class="headerlink" title="4. 与其他系统通信失败"></a>4. 与其他系统通信失败</h1><h2 id="4-1-问题"><a href="#4-1-问题" class="headerlink" title="4.1. 问题"></a>4.1. 问题</h2><p>服务调用失败， 不识别bridge下的服务IP</p><h2 id="4-2-解决"><a href="#4-2-解决" class="headerlink" title="4.2. 解决"></a>4.2. 解决</h2><p>使用host模式启动服务</p><h1 id="5-docker-in-docker-jenkins"><a href="#5-docker-in-docker-jenkins" class="headerlink" title="5. docker in docker (jenkins)"></a>5. docker in docker (jenkins)</h1><h2 id="5-1-问题"><a href="#5-1-问题" class="headerlink" title="5.1. 问题"></a>5.1. 问题</h2><p>在docker启动的Jenkins里无法识别docker命令</p><h2 id="5-2-解决"><a href="#5-2-解决" class="headerlink" title="5.2 解决"></a>5.2 解决</h2><p>增加映射</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">- <span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/docker.sock:/</span>var<span class="hljs-regexp">/run/</span>docker.sock<br>- <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/docker:/u</span>sr<span class="hljs-regexp">/bin/</span>docker<br>- <span class="hljs-regexp">/etc/</span>docker:<span class="hljs-regexp">/etc/</span>docker<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT版式设计</title>
    <link href="/PPT%E7%89%88%E5%BC%8F%E8%AE%BE%E8%AE%A1/"/>
    <url>/PPT%E7%89%88%E5%BC%8F%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="1-PPT-版式设计四大原则"><a href="#1-PPT-版式设计四大原则" class="headerlink" title="1. PPT 版式设计四大原则"></a>1. PPT 版式设计四大原则</h1><h2 id="1-对齐"><a href="#1-对齐" class="headerlink" title="1. 对齐"></a>1. 对齐</h2><ul><li><p>方式：一主多辅</p></li><li><p>常见对齐方式： 左对齐、右对齐、居中对齐、两端对齐、分散对齐</p></li></ul><h2 id="2-对比"><a href="#2-对比" class="headerlink" title="2. 对比"></a>2. 对比</h2><ul><li><p>方式： 大小、颜色、形状、位置</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250615104121566.png" alt="image-20250615104121566" style="zoom:30%;" /></li><li><p>实操</p><ul><li>美化前</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250615104507190.png" alt="image-20250615104507190" style="zoom:100%;" /> <ul><li>美化后：</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250615104620941.png" alt="image-20250615104620941" style="zoom:100%;" /></li></ul><h2 id="3-重复-统一"><a href="#3-重复-统一" class="headerlink" title="3. 重复(统一)"></a>3. 重复(统一)</h2><ul><li>统一PPT的风格：保证大方向不变、可以改变细节元素<ul><li>颜色（主题色、渐变色）</li><li>字体（字体大小、字体行距、字体颜色、位置）</li><li>标题样式</li><li>形状、形式、质感、明亮、距离</li></ul></li></ul><h2 id="4-亲密"><a href="#4-亲密" class="headerlink" title="4. 亲密"></a>4. 亲密</h2><p>关系近的离的近，远的离的远</p><ul><li>美化前：分不清哪个文案对哪个图</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250615105426079.png" alt="image-20250615105426079"></p><ul><li>美化后</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250615105540856.png" alt="image-20250615105540856"></p><h1 id="2-PPT整容美化"><a href="#2-PPT整容美化" class="headerlink" title="2.  PPT整容美化"></a>2.  PPT整容美化</h1><h2 id="2-islide-插件安装"><a href="#2-islide-插件安装" class="headerlink" title="2. islide 插件安装"></a>2. islide 插件安装</h2><ul><li>一键统一字体添加参考线</li><li>模板和主题较多丰富的图片库和色彩库补间动画等高级功能</li><li>OFFICE2013及其以上版本才能安装</li></ul>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>母版使用原理及技巧</title>
    <link href="/%E6%AF%8D%E7%89%88%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%90%86%E5%8F%8A%E6%8A%80%E5%B7%A7/"/>
    <url>/%E6%AF%8D%E7%89%88%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%90%86%E5%8F%8A%E6%8A%80%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="1-母版原理"><a href="#1-母版原理" class="headerlink" title="1. 母版原理"></a>1. 母版原理</h1><ol><li>在母版的版式中所设计的元素，使用了相同版式的PPT也会存在</li><li>在主母版的元素会影响子模版，在子模版之中的元素只会单独存在</li></ol><h1 id="2-应用技巧"><a href="#2-应用技巧" class="headerlink" title="2. 应用技巧"></a>2. 应用技巧</h1><ol><li>批量修改<ol><li>调整LOGO </li><li>调整标题</li><li>调整元素</li></ol></li><li>设置参考线：避免直接在PPT设置，容易误触编辑</li><li>插入文字&#x2F;图片占位符</li></ol><h1 id="3-操作"><a href="#3-操作" class="headerlink" title="3. 操作"></a>3. 操作</h1><ol><li>点击PPT上方的视图菜单，在弹出的菜单栏，找到幻灯片母版</li></ol><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250610214928008.png" alt="image-20250610214928008" style="zoom:100%;" /><ol start="2"><li>根据需求插入文字或图片</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250610221951888.png" alt="image-20250610221951888"></p><ol start="3"><li>在版式里可以查看幻灯片母版</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250610222201924.png" alt="image-20250610222201924"></p>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>离线安装docker</title>
    <link href="/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85docker/"/>
    <url>/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85docker/</url>
    
    <content type="html"><![CDATA[<h1 id="1-下载Docker"><a href="#1-下载Docker" class="headerlink" title="1. 下载Docker"></a>1. 下载Docker</h1><p>找到一台可以联网的 CentOS 机器：用于下载 Docker 及其依赖。</p><p>地址：<a href="https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a></p><h1 id="2-创建一个目录来存放需要的文件"><a href="#2-创建一个目录来存放需要的文件" class="headerlink" title="2. 创建一个目录来存放需要的文件"></a>2. 创建一个目录来存放需要的文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir docker-packages<br>cd docker-packages<br></code></pre></td></tr></table></figure><h1 id="3-准备需要的脚本"><a href="#3-准备需要的脚本" class="headerlink" title="3. 准备需要的脚本"></a>3. 准备需要的脚本</h1><h2 id="3-1-docker-service"><a href="#3-1-docker-service" class="headerlink" title="3.1. docker.service"></a>3.1. docker.service</h2><p>将其中的ip地址，改成您的服务器地址，其它参数不用改。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br> <br>[Service]<br>Type=notify<br><span class="hljs-meta">#</span><span class="bash"> the default is not to use systemd <span class="hljs-keyword">for</span> cgroups because the delegate issues still</span><br><span class="hljs-meta">#</span><span class="bash"> exists and systemd currently does not support the cgroup feature <span class="hljs-built_in">set</span> required</span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-keyword">for</span> containers run by docker</span><br>ExecStart=/usr/bin/dockerd --selinux-enabled=false --insecure-registry=172.28.49.13<br>ExecReload=/bin/kill -s HUP $MAINPID<br><span class="hljs-meta">#</span><span class="bash"> Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-keyword">in</span> the kernel. We recommend using cgroups to <span class="hljs-keyword">do</span> container-local accounting.</span><br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br><span class="hljs-meta">#</span><span class="bash"> Uncomment TasksMax <span class="hljs-keyword">if</span> your systemd version supports it.</span><br><span class="hljs-meta">#</span><span class="bash"> Only systemd 226 and above support this version.</span><br><span class="hljs-meta">#</span><span class="bash">TasksMax=infinity</span><br>TimeoutStartSec=0<br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-built_in">set</span> delegate yes so that systemd does not reset the cgroups of docker containers</span><br>Delegate=yes<br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-built_in">kill</span> only the docker process, not all processes <span class="hljs-keyword">in</span> the cgroup</span><br>KillMode=process<br><span class="hljs-meta">#</span><span class="bash"> restart the docker process <span class="hljs-keyword">if</span> it exits prematurely</span><br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br> <br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h2 id="3-2-一键安装脚本"><a href="#3-2-一键安装脚本" class="headerlink" title="3.2.  一键安装脚本"></a>3.2.  一键安装脚本</h2><p>install.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span><br> <br>echo &#x27;解压tar包&#x27;<br>tar -xvf $1<br>echo &#x27;将docker目录下所有文件复制到/usr/bin目录&#x27;<br>cp docker/* /usr/bin<br>echo &#x27;将docker.service 复制到/etc/systemd/system/目录&#x27;<br>cp docker.service /etc/systemd/system/<br>echo &#x27;添加文件可执行权限&#x27;<br>chmod +x /etc/systemd/system/docker.service<br>echo &#x27;重新加载配置文件&#x27;<br>systemctl daemon-reload<br>echo &#x27;启动docker&#x27;<br>systemctl start docker<br>echo &#x27;设置开机自启&#x27;<br>systemctl enable docker.service<br>echo &#x27;docker安装成功&#x27;<br>docker -v<br></code></pre></td></tr></table></figure><h2 id="3-3-一键卸载脚本"><a href="#3-3-一键卸载脚本" class="headerlink" title="3.3.  一键卸载脚本"></a>3.3.  一键卸载脚本</h2><p>uninstall.sh:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span><br> <br>echo &#x27;停止docker&#x27;<br>systemctl stop docker<br>echo &#x27;删除docker.service&#x27;<br>rm -f /etc/systemd/system/docker.service<br>echo &#x27;删除docker文件&#x27;<br>rm -rf /usr/bin/docker*<br>echo &#x27;重新加载配置文件&#x27;<br>systemctl daemon-reload<br>echo &#x27;卸载成功&#x27;<br></code></pre></td></tr></table></figure><h1 id="4-上传文件和安装包到服务器上"><a href="#4-上传文件和安装包到服务器上" class="headerlink" title="4. 上传文件和安装包到服务器上"></a>4. 上传文件和安装包到服务器上</h1><p>你可以通过 USB 设备、SCP、FTP 等方式将下载好的包及脚本传输到目标 CentOS 机器上。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/1749446823708-033483db-393b-4b2b-b37c-4d0c08c377ae.png" alt="img"></p><h1 id="5-给脚本赋予执行权限"><a href="#5-给脚本赋予执行权限" class="headerlink" title="5. 给脚本赋予执行权限"></a>5. 给脚本赋予执行权限</h1><p>分别给install.sh和uninstall.sh赋予可执行权限。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod +x install.sh<br>chmod +x uninstall.sh<br></code></pre></td></tr></table></figure><h1 id="6-执行安装"><a href="#6-执行安装" class="headerlink" title="6. 执行安装"></a>6. 执行安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sh install.sh docker-26.1.4.tgz<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT快捷键</title>
    <link href="/PPT%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <url>/PPT%E5%BF%AB%E6%8D%B7%E9%94%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="1-PPT标准姿势"><a href="#1-PPT标准姿势" class="headerlink" title="1. PPT标准姿势"></a>1. PPT标准姿势</h1><ul><li>左手 CTRL+SHIFT</li><li>右手鼠标</li></ul><h1 id="2-SHIFT家族"><a href="#2-SHIFT家族" class="headerlink" title="2. SHIFT家族"></a>2. SHIFT家族</h1><ul><li>水平&#x2F;竖直移动 ： SHIFT+鼠标移动</li><li>等比例缩小放大 ： SHIFT+鼠标推拽形状</li><li>每次旋转 15度： SHIFT+旋转</li></ul><h1 id="3-CTRL家族"><a href="#3-CTRL家族" class="headerlink" title="3. CTRL家族"></a>3. CTRL家族</h1><ul><li>快速放大：CTRL+鼠标滚轮</li><li>移动复制：CTRL + 鼠标移动</li><li>快速复制： CTRL + D</li><li>新建页面： CTRL + M</li><li>组合： CTR L +G</li><li>保存： CTRL + S</li><li>撤销&#x2F;恢复 CTRL+Z&#x2F;Y’</li><li>缩小文字： CTRL + 左括号键</li></ul><h1 id="4-CTRL-SHIFT一家亲"><a href="#4-CTRL-SHIFT一家亲" class="headerlink" title="4. CTRL + SHIFT一家亲"></a>4. CTRL + SHIFT一家亲</h1><ul><li>快速水平&#x2F;竖直方向复制： CTRL + SHIFT + 鼠标移动</li><li>等比例中心放大： CTRL + SHIFT +  ALT + 鼠标拖拽形状</li><li>复制格式&#x2F;粘贴格式：CTRL + SHIFT + C&#x2F;V</li><li>解除组合： CTRL + SHIFT + G</li></ul><h1 id="5-文本框操作"><a href="#5-文本框操作" class="headerlink" title="5. 文本框操作"></a>5. 文本框操作</h1><ul><li>文本框快速放大缩小： CTRL+A -》CTRL+[&#x2F;]</li><li>文本框快速加粗： CTRL + B</li><li>文本框快速斜体： CTRL + I</li><li>文本框快速下划线： CTRL + U</li><li>文本框快速局中&#x2F;左&#x2F;右&#x2F;对齐：CTRL + E &#x2F; L &#x2F;R</li></ul><h1 id="6-文字图片的快速插入"><a href="#6-文字图片的快速插入" class="headerlink" title="6. 文字图片的快速插入"></a>6. 文字图片的快速插入</h1><ul><li>文字的快速插入：ALT-&gt;N-&gt;X-&gt;H</li><li>图片的快速插入：ALT-&gt;N-&gt;P-&gt;D</li></ul><h1 id="7-画布处理"><a href="#7-画布处理" class="headerlink" title="7. 画布处理"></a>7. 画布处理</h1><ul><li>从头放映PPT：F5</li><li>从当前页放映：SHIFT + F5</li><li>显示隐藏参考线：ALT + F9</li><li>显示隐藏网格线：SHIFT + F9</li><li>快速缩放画布：CTRL + 滚轮</li></ul><h1 id="8-重复上一步骤操作"><a href="#8-重复上一步骤操作" class="headerlink" title="8. 重复上一步骤操作"></a>8. 重复上一步骤操作</h1><p>F4</p>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>PPT统一风格技巧</title>
    <link href="/PPT%E7%BB%9F%E4%B8%80%E9%A3%8E%E6%A0%BC/"/>
    <url>/PPT%E7%BB%9F%E4%B8%80%E9%A3%8E%E6%A0%BC/</url>
    
    <content type="html"><![CDATA[<h1 id="1-版心规划"><a href="#1-版心规划" class="headerlink" title="1.  版心规划"></a>1.  版心规划</h1><h2 id="1-通过参考线设置合理的页面距，为页面规划出放置内容的中心区域"><a href="#1-通过参考线设置合理的页面距，为页面规划出放置内容的中心区域" class="headerlink" title="1. 通过参考线设置合理的页面距，为页面规划出放置内容的中心区域"></a>1. 通过参考线设置合理的页面距，为页面规划出放置内容的中心区域</h2><p>空白区域右键 -》 增加参考线 -〉 自己拖动到合理位置</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250608155744062.png" alt="image-20250608155744062" style="zoom:30%;" /><h1 id="2-设计规范"><a href="#2-设计规范" class="headerlink" title="2. 设计规范"></a>2. 设计规范</h1><h2 id="1-配色"><a href="#1-配色" class="headerlink" title="1. 配色"></a>1. 配色</h2><h2 id="2-文字样式"><a href="#2-文字样式" class="headerlink" title="2. 文字样式"></a>2. 文字样式</h2><p>在同一套PPT中，同层级信息的文字类型、大小、粗细、颜色都是相同的。</p><p>层级：主标题、正文标题、正文</p><p>样式：类型、大小、颜色、粗细</p><p>如：</p><ul><li><p>主标题：微软雅黑、24号、加粗、白色</p></li><li><p>正文标题：微软雅黑、16号、加粗、金色</p></li><li><p>正文：微软雅黑、12号、不加粗、白色</p></li></ul><h2 id="3-版式"><a href="#3-版式" class="headerlink" title="3. 版式"></a>3. 版式</h2><p>在同一套PPT中，同层级信息的页面版式是相同的。如：大章节过渡页、大章节内目录</p>]]></content>
    
    
    <categories>
      
      <category>PPT高手之路</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>会议管理</title>
    <link href="/%E4%BC%9A%E8%AE%AE%E7%AE%A1%E7%90%86/"/>
    <url>/%E4%BC%9A%E8%AE%AE%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="1-会议时机选择"><a href="#1-会议时机选择" class="headerlink" title="1. 会议时机选择"></a>1. 会议时机选择</h1><ul><li>​    发起人想从参会者那里获取信息或建议</li><li>​    发起人起让参会者参与解决问题或制定决策</li><li>​    领导者需要听取下属的工作汇报并监督进度</li><li>​    问题需涉及不同岗位员工或多部门协调解决</li><li>​    有重要事情需要把参与人集中到一起传达</li><li>​    领导者需要公开表彰先进以激励士气等</li></ul><h1 id="2-制订会议议程"><a href="#2-制订会议议程" class="headerlink" title="2. 制订会议议程"></a>2. 制订会议议程</h1><ul><li>会议议程须以正式文件形式拟定</li><li>正式会议开始时一般需要说明会议整体流程，会议分为几项内容</li><li>议程安排时应尽量将会议时段    安排在正常工作时段内</li></ul><h1 id="3-会议召开高效秘诀"><a href="#3-会议召开高效秘诀" class="headerlink" title="3. 会议召开高效秘诀"></a>3. 会议召开高效秘诀</h1><ol><li>明确会议目的和产出</li><li>确认会议形式和流程</li><li>确定参会范围</li><li>做好会前准备</li><li>控制好会场气氛节奏</li><li>做好会议记录</li><li>及时公布会议决议</li><li>做好会后跟踪实方案执行</li></ol><h1 id="4-会议追踪"><a href="#4-会议追踪" class="headerlink" title="4. 会议追踪"></a>4. 会议追踪</h1><p>凡是散会，必有事后追踪：记住“散会不追踪，开会一场空”。建立会议事后追踪程序，会议每项</p><p>决议都要有跟踪、稽核检查，如有意外可及时发现适时调整，确保各项会议决议都能完成。</p><ul><li>开会+不落实&#x3D;零</li><li>布置工作+不检查&#x3D;零</li><li>抓住不落实的事+追究不落实的人&#x3D;落实</li></ul>]]></content>
    
    
    <categories>
      
      <category>高效工作</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>mybatis分⻚查询异步导出分⻚重复/丢失问题</title>
    <link href="/mybatis%E5%88%86%E2%BB%9A%E6%9F%A5%E8%AF%A2%E5%BC%82%E6%AD%A5%E5%AF%BC%E5%87%BA%E5%88%86%E2%BB%9A%E9%87%8D%E5%A4%8D%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/"/>
    <url>/mybatis%E5%88%86%E2%BB%9A%E6%9F%A5%E8%AF%A2%E5%BC%82%E6%AD%A5%E5%AF%BC%E5%87%BA%E5%88%86%E2%BB%9A%E9%87%8D%E5%A4%8D%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-初始状态"><a href="#1-初始状态" class="headerlink" title="1. 初始状态"></a>1. 初始状态</h1><p>我们有一个库存表 inventory，里面有 25 条记录，按 id 排序（从小到大）。</p><p>每页显示 10条记录：</p><p>第1页：LIMIT 10 OFFSET 0 → id &#x3D; 1~10</p><p>第2页：LIMIT 10 OFFSET 10 → id &#x3D; 11~20</p><p>第一页：</p><table><thead><tr><th>OFFSET</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th></tr></thead><tbody><tr><td>id</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td></tr></tbody></table><p>第二页：</p><table><thead><tr><th>OFFSET</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th></tr></thead><tbody><tr><td>id</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td></tr></tbody></table><h1 id="2-并发插入"><a href="#2-并发插入" class="headerlink" title="2. 并发插入"></a>2. 并发插入</h1><p>假设你在查完第一页后，在数据库中插入了 3条新的记录，它们的 id 是 100, 101, 102，并且这些记录会被排序排在前10条中间的位置。</p><p>比如你设置的是按 <code>name</code> 或其他字段排序，或者你用了时间戳字段排序，这三条记录插到了前面部分。</p><p>第一页已经把8、9、10 查出来并导出了，但第二页又重复查出来导出，造成<strong>数据重复</strong>（id &#x3D; 7、8、9）</p><p>第一页：</p><table><thead><tr><th>OFFSET</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th></tr></thead><tbody><tr><td>id</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td><strong>101</strong></td><td><strong>102</strong></td><td><strong>103</strong></td><td>7</td></tr></tbody></table><p>第二页：</p><table><thead><tr><th>OFFSET</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th></tr></thead><tbody><tr><td>id</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td></tr></tbody></table><h1 id="3-并发删除"><a href="#3-并发删除" class="headerlink" title="3. 并发删除"></a>3. 并发删除</h1><p>假设你在查询完第1页之后，在导出第2页之前，有人删除了第1页中的3条记录（id &#x3D; 7、8、9）。</p><p>导致原本应该在第二页的记录（id&#x3D;11、12、13）上移到了第一页，第二页查询的时候从id&#x3D;14开始查，造成<strong>数据丢失</strong>（id&#x3D;11、12、13）</p><p>第一页：</p><table><thead><tr><th>OFFSET</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th></tr></thead><tbody><tr><td>id</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>10</td><td><strong>11</strong></td><td><strong>12</strong></td><td><strong>13</strong></td></tr></tbody></table><p>第二页：</p><table><thead><tr><th>OFFSET</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th></tr></thead><tbody><tr><td>id</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td><td>121</td><td>121</td><td>123</td></tr></tbody></table><h1 id="4-问题解决"><a href="#4-问题解决" class="headerlink" title="4. 问题解决"></a>4. 问题解决</h1><p>为了解决这个问题，可以考虑以下几种方案：</p><h2 id="4-1-方法一：使用游标分页（Cursor-based-Pagination）"><a href="#4-1-方法一：使用游标分页（Cursor-based-Pagination）" class="headerlink" title="4.1. 方法一：使用游标分页（Cursor-based Pagination）"></a>4.1. 方法一：使用游标分页（Cursor-based Pagination）</h2><p>用上一页最后一条记录的 <code>id</code> 作为下一页的起点：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 第一页</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">10</span>;<br><br><span class="hljs-comment">-- 第二页（假设最后一条是 id = 10）</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>这样无论有没有新增&#x2F;删除记录，都不会影响下一页的准确性。</p><hr><h2 id="4-2-方法二：快照导出（适用于大数据导出场景）"><a href="#4-2-方法二：快照导出（适用于大数据导出场景）" class="headerlink" title="4.2. 方法二：快照导出（适用于大数据导出场景）"></a>4.2. 方法二：快照导出（适用于大数据导出场景）</h2><p>在导出前创建一个临时快照表或视图，把要导出的数据先复制一份：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> TEMPORARY <span class="hljs-keyword">TABLE</span> inventory_snapshot <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> inventory;<br></code></pre></td></tr></table></figure><p>然后对这个快照表进行分页查询，避免实时变化干扰。</p><h2 id="4-3-中间表-切面控制流程，构建了一个数据快照机制"><a href="#4-3-中间表-切面控制流程，构建了一个数据快照机制" class="headerlink" title="4.3. 中间表 + 切面控制流程，构建了一个数据快照机制"></a>4.3. 中间表 + 切面控制流程，构建了一个数据快照机制</h2><p>不直接对库存表做分页查询，而是先将本次要导出的所有库存 ID 存入一个临时表中（export_record），后续导出都基于这个临时表的 ID 列表来进行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">CREATE TABLE <span class="hljs-title">export_record</span> <span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span></span><br><span class="hljs-params"><span class="hljs-function">    source_table_id BIGINT,        -- 来源表ID（如 inventory.id）</span></span><br><span class="hljs-params"><span class="hljs-function">    batch_id VARCHAR(<span class="hljs-number">64</span>)</span>,          -- 批次ID（异步任务ID）</span><br><span class="hljs-function">    create_time DATETIME           -- 创建时间</span><br><span class="hljs-function">)</span>;<br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InventoryExportService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> InventoryMapper inventoryMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ExportRecordMapper exportRecordMapper;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startExport</span><span class="hljs-params">()</span> </span>&#123;<br>        String batchId = UUID.randomUUID().toString(); <span class="hljs-comment">// 生成唯一批次ID</span><br><br>        <span class="hljs-comment">// 获取所有需要导出的库存ID列表</span><br>        List&lt;Long&gt; allInventoryIds = getAllInventoryIds();<br><br>        <span class="hljs-comment">// 将这些ID记录到export_record表中</span><br>        saveBatchIdsToExportRecord(batchId, allInventoryIds);<br><br>        <span class="hljs-comment">// 异步执行实际导出逻辑</span><br>        asyncExportInventoryByBatchId(batchId);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;Long&gt; <span class="hljs-title">getAllInventoryIds</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> inventoryMapper.selectList(<span class="hljs-keyword">new</span> QueryWrapper&lt;&gt;())<br>        .stream()<br>        .map(Inventory::getId)<br>        .collect(Collectors.toList());<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveBatchIdsToExportRecord</span><span class="hljs-params">(String batchId, List&lt;Long&gt; ids)</span> </span>&#123;<br>        List&lt;ExportRecord&gt; records = ids.stream()<br>        .map(id -&gt; <span class="hljs-keyword">new</span> ExportRecord(<span class="hljs-keyword">null</span>, id, batchId, <span class="hljs-keyword">new</span> Date()))<br>        .collect(Collectors.toList());<br>        exportRecordMapper.insertBatch(records); <span class="hljs-comment">// 假设有一个批量插入的方法</span><br>    &#125;<br><br>    <span class="hljs-meta">@Async</span> <span class="hljs-comment">// 使用@Async注解实现异步调用</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">asyncExportInventoryByBatchId</span><span class="hljs-params">(String batchId)</span> </span>&#123;<br>        Page&lt;ExportRecord&gt; page = <span class="hljs-keyword">new</span> Page&lt;&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每次处理1000条记录</span><br>        IPage&lt;ExportRecord&gt; exportRecords;<br>        <span class="hljs-keyword">do</span> &#123;<br>            exportRecords = exportRecordMapper.selectPage(page, <span class="hljs-keyword">new</span> QueryWrapper&lt;ExportRecord&gt;()<br>                                                          .eq(<span class="hljs-string">&quot;batch_id&quot;</span>, batchId));<br><br>            <span class="hljs-keyword">if</span> (exportRecords.getRecords().isEmpty()) <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 根据export_records中的source_table_id查询inventory表</span><br>            List&lt;Long&gt; ids = exportRecords.getRecords().stream()<br>            .map(ExportRecord::getSourceTableId)<br>            .collect(Collectors.toList());<br>            List&lt;Inventory&gt; inventories = inventoryMapper.selectBatchIds(ids);<br><br>            <span class="hljs-comment">// 执行导出逻辑（例如写入Excel文件）</span><br><br>            page.setCurrent(page.getCurrent() + <span class="hljs-number">1</span>); <span class="hljs-comment">// 更新当前页码</span><br>        &#125; <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>);<br><br>        <span class="hljs-comment">// 清理中间表数据</span><br>        exportRecordMapper.delete(<span class="hljs-keyword">new</span> QueryWrapper&lt;ExportRecord&gt;().eq(<span class="hljs-string">&quot;batch_id&quot;</span>, batchId));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-实现步骤"><a href="#1-实现步骤" class="headerlink" title="1. 实现步骤"></a>1. 实现步骤</h3><h4 id="Step1：切面拦截导出请求"><a href="#Step1：切面拦截导出请求" class="headerlink" title="Step1：切面拦截导出请求"></a>Step1：切面拦截导出请求</h4><ul><li>使用 Spring AOP 拦截带有 <code>@ExcelExport</code> 注解的方法</li><li>在方法执行前，获取到本次导出的库存 ID 列表（如从参数、上下文中提取）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Long&gt; inventoryIds = getInventoryIdsFromRequest();<br></code></pre></td></tr></table></figure><h4 id="Step2：生成批次标识-batchId，并写入通用导出表"><a href="#Step2：生成批次标识-batchId，并写入通用导出表" class="headerlink" title="Step2：生成批次标识 batchId，并写入通用导出表"></a>Step2：生成批次标识 batchId，并写入通用导出表</h4><ul><li>将所有库存 ID 和 batchId 一起写入 <code>export_record</code> 表中</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">INSERT INTO <span class="hljs-title">export_record</span> <span class="hljs-params">(source_table_id, batch_id)</span> <span class="hljs-title">VALUES</span></span><br><span class="hljs-function"><span class="hljs-params">(<span class="hljs-number">1001</span>, <span class="hljs-string">&#x27;task_123&#x27;</span>)</span>,</span><br><span class="hljs-function"><span class="hljs-params">(<span class="hljs-number">1002</span>, <span class="hljs-string">&#x27;task_123&#x27;</span>)</span>,</span><br><span class="hljs-function">...</span><br></code></pre></td></tr></table></figure><p>作用：保存本次导出所涉及的所有库存 ID。</p><h4 id="Step3：导出逻辑改为根据-batchId-查询"><a href="#Step3：导出逻辑改为根据-batchId-查询" class="headerlink" title="Step3：导出逻辑改为根据 batchId 查询"></a>Step3：导出逻辑改为根据 batchId 查询</h4><ul><li>导出代码不再直接查库存表，而是查 <code>export_record</code> 表中的 source_table_id 列表，再关联库存表导出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> i.<span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> inventory i<br><span class="hljs-keyword">JOIN</span> export_record e <span class="hljs-keyword">ON</span> i.id <span class="hljs-operator">=</span> e.source_table_id<br><span class="hljs-keyword">WHERE</span> e.batch_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;task_123&#x27;</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> i.id<br>LIMIT <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>这样无论库存表如何变化，只要 <code>export_record</code> 表里的 ID 不变，导出的数据集就不会变。</p><h4 id="Step4：导出完成后清理中间数据"><a href="#Step4：导出完成后清理中间数据" class="headerlink" title="Step4：导出完成后清理中间数据"></a>Step4：导出完成后清理中间数据</h4><ul><li>在切面最后，删除该 batchId 对应的 <code>export_record</code> 数据，避免数据堆积</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> export_record <span class="hljs-keyword">WHERE</span> batch_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;task_123&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="2-核心原理"><a href="#2-核心原理" class="headerlink" title="2. 核心原理"></a>2. <strong>核心原理</strong></h3><p>核心原理：<strong>固定数据集 + 独立于源表</strong></p><table><thead><tr><th><strong>传统方式</strong></th><th><strong>你的方案</strong></th></tr></thead><tbody><tr><td>直接对库存表分页查询 → 数据会变</td><td>先把 ID 写进中间表 → 数据不变</td></tr><tr><td>分页基于偏移量（OFFSET）→ 容易因插入&#x2F;删除导致偏移错乱</td><td>分页基于固定 ID 列表 → 偏移始终准确</td></tr><tr><td>多次查询之间数据可能变动 → 导致重复或丢失</td><td>所有导出都基于同一份快照 ID → 数据一致</td></tr></tbody></table><p><strong>解决了哪些问题？</strong></p><table><thead><tr><th><strong>问题</strong></th><th><strong>是否解决</strong></th><th><strong>原理说明</strong></th></tr></thead><tbody><tr><td>数据插入导致分页偏移</td><td>✅ 解决</td><td>导出基于中间表 ID 列表，不受库存表插入影响</td></tr><tr><td>数据删除导致分页偏移</td><td>✅ 解决</td><td>同上，ID 快照已固定</td></tr><tr><td>分页重复或丢失</td><td>✅ 解决</td><td>分页只针对固定的 ID 列表，不会跳过或重复</td></tr><tr><td>支持并发导出</td><td>✅ 支持</td><td>每个任务都有独立的 batchId，互不影响</td></tr><tr><td>可复用性</td><td>✅ 支持</td><td>中间表结构通用，适用于多种导出场景</td></tr></tbody></table><hr><h3 id="3-优化建议"><a href="#3-优化建议" class="headerlink" title="3. 优化建议"></a>3. 优化建议</h3><ol><li><strong>性能优化：批量插入中间表</strong></li></ol><ul><li>如果一次导出几万条记录，插入 <code>export_record</code> 表可能会慢。</li><li>建议使用 MyBatis 的 <code>saveBatch()</code> 或数据库的批量插入语句。</li></ul><ol start="2"><li><strong>清理机制保障</strong></li></ol><ul><li>确保每次导出完成后都能删除中间数据（即使异常也要删除）</li><li>可以加定时任务清理超时未删除的 <code>batch_id</code> 记录</li></ul><ol start="3"><li><strong>可扩展性增强</strong></li></ol><ul><li>可以考虑将 <code>export_record</code> 替换为 Redis 缓存，提升性能（短期缓存即可）</li><li>或者结合两者，热数据走 Redis，冷数据落库</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Eureka注册服务IP的方式</title>
    <link href="/Eureka%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1IP%E7%9A%84%E6%96%B9%E5%BC%8F/"/>
    <url>/Eureka%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1IP%E7%9A%84%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Eureka注册服务IP的方式"><a href="#1-Eureka注册服务IP的方式" class="headerlink" title="1. Eureka注册服务IP的方式"></a>1. Eureka注册服务IP的方式</h1><p>当服务注册到Eureka、Nacos等注册中心时，它会将自己的IP地址上报。Spring Boot默认可能会使用如下几种方式来获取本机 IP:</p><ul><li><p>localhost</p></li><li><p>网卡上的IP(如:192.168.x.x ，172.17.x.x , 10.x.x.x)</p></li><li><p>如果设置了preferred-networks，则优先从这些网段中选一个作为注册地址</p><p>如果没有设置这个选项，有时会错误地将localhost或者错误的IP注册到服务中心，导致其他服务无法访问。</p></li></ul><h1 id="2-解决注册到Eureka一直显示localhost的问题"><a href="#2-解决注册到Eureka一直显示localhost的问题" class="headerlink" title="2. 解决注册到Eureka一直显示localhost的问题"></a>2. 解决注册到Eureka一直显示localhost的问题</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">-Dspring.cloud.inetutils.preferred-networks=<span class="hljs-number">172.28</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>jar包反编译</title>
    <link href="/jar%E5%8C%85%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    <url>/jar%E5%8C%85%E5%8F%8D%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h1 id="1-idea-安装插件"><a href="#1-idea-安装插件" class="headerlink" title="1. idea 安装插件"></a>1. idea 安装插件</h1><p>安装Java Decompiler</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250603215554615.png" alt="image-20250603215554615"></p><h1 id="2-执行反编译命令"><a href="#2-执行反编译命令" class="headerlink" title="2. 执行反编译命令"></a>2. 执行反编译命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -cp &quot;D:\software\JetBrains\IntelliJ IDEA 2024.3.5\plugins\java-decompiler\lib\java-decompiler.jar&quot; org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -dgs=true wms-inv-2.0.1.jingao.12.jar &quot;D:\code\wms\database\wms-inv&quot;<br></code></pre></td></tr></table></figure><h1 id="3-解压jar包"><a href="#3-解压jar包" class="headerlink" title="3. 解压jar包"></a>3. 解压jar包</h1><p>使用上述命令执行后，会在 <code>D:\code\wms\database\wms-inv</code>下生成jar包，解压缩即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">jar xf wms-inv-2.0.1.jingao.12.jar<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>后端开发规范</title>
    <link href="/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/"/>
    <url>/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Java开发规范"><a href="#1-Java开发规范" class="headerlink" title="1. Java开发规范"></a>1. Java开发规范</h1><h3 id="1-1-命名风格："><a href="#1-1-命名风格：" class="headerlink" title="1.1. 命名风格："></a>1.1. 命名风格：</h3><ol><li><p>【强制】抽象类命名以Abstract或Base开头，异常命名以Exception结尾，测试类以它要测试的类名称开始Test结束</p></li><li><p>【强制】POJO类中布尔类型的变量，都不能加is， 否则框架解析会出现序列化错误，比如：isDelete</p></li><li><p>【强制】接口中的方法和属性不要加任何修饰符号（public也不要加），保持代码整洁，并且加上有效的doc注释，尽量别在接口里定义常量</p></li><li><p>【强制】枚举类名建议加上ENUM后缀</p></li><li><p>【推荐】如果模块、类、接口使用了设计模式，在命名时需要体现出设计模式，如：OrderFactory, LoginProxy, ResourceObserver</p></li><li><p>【推荐】各层命名规范</p></li><li><ol><li>Service&#x2F;Dao命名规范</li></ol></li><li><ol><li><ol><li>获取单个对象的方法用get做前缀</li><li>获取多个对象的方法用list做前缀</li><li>获取统计值的方法用count做前缀</li></ol></li></ol></li><li><ol><li>领域层命名规范</li></ol></li><li><ol><li><ol><li>数据对象：xxxDo</li><li>数据传输对象：xxxDTO</li><li>展示对象: xxxVO</li><li>POJO 是DO、DTO、VO、BO的统称，禁止命名为xxxPOJO</li></ol></li></ol></li></ol><h3 id="1-2-常量定义："><a href="#1-2-常量定义：" class="headerlink" title="1.2. 常量定义："></a>1.2. 常量定义：</h3><ol><li>【强制】long或者Long初始赋值时，不能使用小写的l，小写的容易与数字1混淆。如：Long a &#x3D; 2l; 2l是数字21还是Long类型的2？</li><li>【强制】不要用一个常量类维护所有常量，而是应该按常量功能分类，如缓存的放在CacheConst下，系统配置的放在ConfigConst下</li></ol><h3 id="1-3-数据类型定义"><a href="#1-3-数据类型定义" class="headerlink" title="1.3. 数据类型定义"></a>1.3. 数据类型定义</h3><ol><li>【强制】所有的POJO类必须使用包装数据类型（包装类型的默认值为null，提醒使用者自己赋值）</li><li>【强制】RPC方法的返回值和参数都必须使用包装数据类型（包装类型的默认值为null，RPC调用失败时，为null可以表示额外的信息）</li><li>【推荐】所有的局部变量都使用基本数据类型（基本数据类型的默认值为对应类型的默认值）</li></ol><h3 id="1-4-其他"><a href="#1-4-其他" class="headerlink" title="1.4. 其他"></a>1.4. 其他</h3><ol><li>当一个类有多个构造方法或者同名方法时，应该按顺序放在一起（public&gt;protect&gt;private）</li><li>方法的返回值如果是“List、Set、Map”时，不允许返回null，而是返回Clollections底下的单例对象</li><li>在使用平台资源，如短信，邮件，电话，下单，支付，必须实现正确的防重放限制，如：数量限制，验证码校验，避免被滥刷</li><li>在发帖，评论，发送即时消息等用户生成内容的场景，必须实现防重刷，文本内容违禁词过滤等风控策略</li><li>不建议在循环中查询数据、新增或更新，会增加数据库查询负载，当SQL性能差时会导致长事务或锁等待，改用批量查询后使用Map匹配，批量新增和更新</li><li>声明式事务注解，注意事务的范围和传播性</li><li>非特殊情况，禁用内存分页</li><li>查询的时候尽量带上索引，来做唯一性查询</li></ol><h1 id="2-mysql数据库规范"><a href="#2-mysql数据库规范" class="headerlink" title="2. mysql数据库规范"></a>2. mysql数据库规范</h1><ol><li>表达是否概念的字段必须使用is_xxx的方式命名，数据类型为 undesigned_tinyint(1表示是， 0表示否)， 如：is_deleted, 任何字段类型为非负数必须是undesigned</li><li>小数类型为decimal禁止使用float或者dubble，避免精度损失</li><li>超过3个表禁止join</li><li>不要使用count(列名)替代count(<em>), 二者结果不同，count(</em>)会统计值为NULL的行，count(列名)不会</li></ol><h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>组件生产的工艺</title>
    <link href="/%E7%BB%84%E4%BB%B6%E7%94%9F%E4%BA%A7%E7%9A%84%E5%B7%A5%E8%89%BA/"/>
    <url>/%E7%BB%84%E4%BB%B6%E7%94%9F%E4%BA%A7%E7%9A%84%E5%B7%A5%E8%89%BA/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="289c196a73f57c979924e09ddd753f394683b4d34a541e2e0fad52792b5effaa">a497b25e6862ef932bd8b8e9634b73107fd22b7c0b6aeb86f1e0db1a2c94058e7b61913394f761f2698ff08edc83b403278cb4c4569b0971bd384485139e354f526b73ad8cae3f873fdc12a6b9f330183640544164d682e3f95921dc334ddcb98e68e515851af62631b78793eacb5bfcc05c70b28a0f2c56b86bb10b939b142c0579fbfa0aa460b88adb7349a6950bb2580dd93ed89c4875681eda39005b6524f1c7846b30ccf2643afd9fe40255cfa0ab5cc64353e34bff9b97d43f551b65d8e34f990f5546bf2aaf71b8b87bbcdf27bbc3e3ef35f66d769504b0dac3e630744a6be0735aae0c5a0ef5cedc7e5072700a06e6026312ee966180c3411138e01af1f65943cd685fc804245efd55513e5edb0302562c3194349680f395a6c29801d44c107d1d2797c4df9d8101b55074b56e1a65758cd4fd7da50174a5e2ce4392ef7360080c9fbd18e9c08358a3e7196ca4f3ee3109c006a3fd1a05aabe96b4f435c2219badf7f7a90bf6d8b82455e4c0bf5bc126acacb99193d41f63897bead845c2b353ef0d5b54d0c8be2552da5411fc4738799b1ff4a5859b94d044e5d579f01aeea0502f988bc06df377fe10d8567ea67917ef04637e5b2ef01087a79d32bf91cf03f448d0d2aada030d836951667bbf542a789c5944dec3bd3c311c75e8f9a0825ce13a45d51331b2e2a581a856a47c10b181eeb1f3a92b324ebd2bdd39d377cc40d02156d4c8bc1af1afc7e0e8ad0ce65600d7ef84202011320eb0dcfd96c7489b02f77062dcbc5f17dd7ac2b7a76e6f13ee0efdb4d576d0c4878c5b8f12f10663aafdc9e57ac797311024a7ffcbab42ebd7b9d10c5324998d5c195d42fa457cc1ede13630487b490b7ca0a7fe1d2431db110d29059fca6471a777b9005cfb7287bc594cff3c73fce9c30e3e9618ef2459a5728064c155b52eabaf237e9c51069fbf411934be59c95cba1bf906e40d99d1718969596f6a2af1d4dde4d6415b9b643f4816ca4e9b19afe453c77e243aa13168ea216de28c23cd41ffa9a0f3759f5e8af2d9d4570e5b701ab562712434494e4b563aaa001e2a9a96ca7e506da1a42e6751ec74fc2daa03e0dfad377e884b1875b2951df98dc18e509526f41239e2b415bb68541aafd35c875b61457615f39b5490096a0eeaa9e46c03afe1139bbdef4d06434a411baaf443ccad9d5a21dc5512551b5cb07d1c1d3e6b353d58c7de562cb05d07dc6f4ab5113d8363557b1765fd1e7d3c985c41083202a4005286544169c4941f0dbe2f20e89a5167912cebab965e92faed7299067901ffeac9e1202d02f595a07ad3670c1c903e9efc5fe32f1db15ab2f58a4e34f9cf9e3fcaac7604e710fa17817c5c34296732a512569bb326bfcb87f414750314f1a132ec98b10597ad8f317cdeee005ded167a5a698d5a00a4dd92b7c9dd267d26b540918ddb8bf5924a36dca85401762ad28f4838123a355b00847b16c4c9be6a0358093f30d2df3b5f9ee349f6f3847da4d0220f38959114f7ea50b7eb80c524a78c3f46c3c954ec2f5d7cfab6edf1c58894dcfd2d4307d7210566c52490ae23e33d6cd9ff1c79fde57b750fdc70710ffff5462bbb970132110d686b00de163389b7c5093f90153890254dda139c27f36878b5755c3f26f6236b9a3a1320c50e1a664682e806a345b2857a1b651fac87fcade1278b8d3dc5968febe9a8d55a2c8d7fc6dcc2bdafe4306fcabb2119f01fd87a57b2fd2397f02bfac684d8fd3680206d8d88d6fa024a8d4553a28ab98e1cab1fd49183cab43a144e2adffbbe1c686f0df207949c42c5c125b1f7a8dcde77c34aefbc9d0a707f3db0a353cd8f965f9757917e141f7c088a04cf9378d8f8ec1f51f67f946d86ede94a3a0f65dd1c677b73505c27687177cbb7d398fcacb267174c3ddbe33c28666f8a5ed1f38dc5f374995091e4ab6d1457b00636ef58242ec39c15159cafc6a8e549d146cba06baa6105a07b8f7df4b467f98a08112574968f973a37791817212b95365584be7a88a87e75ee55a2e1557ff1af93bf157927e59e7accd60cc20981e0e31df90f704c2ef1ccb4c3eb2e3c9cd310d82bf53804316806379bdbb1f55a0006f99f70afd710f9fa31a14fbfbdfd0dc8e11c560f9e3599a64c181c761fc8aecf85f6e1cc2a5f8e0b4d8db1820aaa7f35be79b9cf8c9038758a4ab24bd45f3f2b81412438fcbbbc192d053136e23422ec2c2113c41963a4f7657946c482ede73e30c42b368e5cb51e3c377ef70c82d122590cd08a64416e740a114e00d1f60daf4897903ac90c08c1f39fb6d18eec206bf24da14f0a9a880090ba8808e5eac45edcf4af21d1130edfda5118ae4d394202208b6e6b69d07acb9a80d4d0c941857498d18f1c211eea5ab927052586fd8c244c0f15ae7e7515866ad886eb9d134273a35716044959916706d3dbd885e2f8f74f74d6f1165d74f12df4c982441d94585293038eb47885e06697c5113aef9baa03d28e4742feb3526de07ed005fd961af1936973a27d920d77c2a8dd50d7da9953407d2c9e8c444d94b1373da42cfb3bc94ade3d8f925b4afd981b778684488c86ac20ca29f5bdab09748348e66a940b04b142b79962afc128c14401ab4bde426733915b556d0cd4215ae046c45cad2bb7029f01a24e99b14a63b79267f0da7ad42a96db2dd399690d65f5778e9cd30ea3c3da43cf5e226ecd7d16c1bf06ebb2312b7becd31509e7e05ed5ddba2dcb71d06efb6211727b3d92ca9e2a5bd021747ed9b6bc2f2a57b5a734c73425551d1020405be7710efcd3995d919380ad11683ee9cce72b1c873e40ab883d836f3b352da84bfe4737f23f40e611ea925ac178fe9752d2e4dc3721cbfb9e40d9453c55e94566a94bb8902c79b191c77ef9c3b42e5368b6d4b0731f48dea47193b7321407747656c1312e36d4e7827c0c7d72ef213d8f87de75fcbf3c08bea60cde391141422d04c1a0f0adaf32230eabc6ef7304a69d514b7bed783d7a523647bfb7564f000a36540f6f44f55321c9e7618633c74f5e9510f85b21c6deffeeb2f5c663d06ecfb61205b1d33e612466d6e15718bfd1c704816c57382ea65b24e19916590d671649735707534401e9d4c7735644c081ca8fecb8e02626d28da7280cbcee3c2774293db829607668ae0c17bd6ff6f75216dd9d2ba7ee0ec7191edd79a79b8a50e6ad562b217b88dd39b7f97bab5e27aa81a8a5903e2d1ce31cc0726fa8719cc1e439ecefeed0d607690436fec911b77cc6006ed4198fdfc4c56172b45731f24a25af81cb78bce626f819f7bde9e3294ccd9a09be392bca10a12d90d10c16e1830b54f4dd59fc1a4358e3658934d1a1b49a147ee60de9ed7cd941da7ebc1aabeda668cbaa91233c8d51d5f4d769d96bf0483a754b504a991f3f98b8ba9976c865998c49452a106a2f21ef9f2007017e42d5b6c48ab54127244ef1bab38e4143b582c2632d878ebf7653594abe0cf96ff373ce580bcf7fc7d7a7fc8ffb931fd19ca6e19773fae51032968d5eec697ecabdf1274a7591a55391c82b13702745edd72bb9a609c7eda01ab4867e47909ee14e349572b4aeb27a2514ab261e3c941feaa95f36ea9bf3b919dc5e315bb7db96908af11cd20bad28db227595470d0cf0da6b083aca1118b51cea692d6f7dd5a53bd3002bfa63db66d0d2cec8b193f457e0d87665e9d9525584215dd03f0e7e440c051f9340c4b3c0c3ce4ad23d5aaa554c680990d7ed1aeba682765589700f759006d90c3976d1d1ca28ab7926b658198cb1b547e4b00aa60d021c3f4b9e75746ef4d4b41f6837aa21ec074747fb26d70856ded9448bfe9f89612b61c9fc9c7959e99ee7ceca2c3a61875eae6d5fa69a56d797a0f1f1d3a467f44bfd6f33fcf3bf35e96cb50c9d13e959a1c311582c62dc9f1d0ab4aacfdcbef861cbaa1f7a8b2eb11bfe02f824f6e51954388d1c942f98ae0edc94d9f0acc90b741b4dce50d360d46a7ff29005ed088a67149cbb38efd77de35ef35626ea1f2323590cba55dc2a512388d0027a311b63056e177e98710e622d4e1c6499b175d8743f90780f20b0e634fd7379322302d19213cd284f10f55ececac18e29826bac77668b1105f2d1613fa4eeda288ba025831ab97739aab6e3dc6cfdaa8b9d4f2af7b57c8765d6ca634c9c86756506a0de3cecdd2a8fa03dc75cd4a16eb31f4bdc4cdde3b41bce8dcc814c812ffa23ba839fdec5daa12fc6414fa7ae3b34ea14b050e7e0210a2bbd47efba58d875769976d7a133c8c54f199b27264e2696ab1244c1f400e1bcb00679854f075658b6d3d6236d813961361df609a71753df3b23fef7705a8531eb89f5bcdeab893ab637946d62574781cb7d6dc725438a673c1b97b8fc0f3984148945c55f8acb1c4a2d3c859ed5bf614ff5bf8f7a44f42da61ed5144ec14dae4df0142ebce2be2364ca2492578dec9dd9b55490b5ced5168c317a01c1c29094da21bb95d64a07579847646442b2225c9f53f96ac73e8884283e2068eb24542b5be48bc7a88262ab742d39eeca1ea28cf86e70ba009be0fba8f30f54b084caa0b3e6d0025a088735b4202fe1cc1dc30d31195b2ae46c7a0c897c7a407b7396667a63734435d2ce0030c027589c513f8cdd1c69b768f9813a83f3bb08ab858938e4e5c21ba9d21d80333cd0e4b7518332238f99bf79f9c31490c0c72847ffe69b2aa0d549bc4e7f09cd236ef726f6b62288b1b192d0b32c88088e8f25df5e9ec2377d0ea86ace93eba24e4630cbcbe7f6626fa753e39b07ef0f4499cd835bcab1e9af65bbf73015b443ec39bc6c1ce31c78a14346824321ae1a24e52b6b419077bb4b4be14596ef5ceb5f56e885bbb077a05d7688351fdde31ef78fe0362a6d940d370dfbdfc072b6d5476654be17e351c1ec833eb3f1ac300e86e8a4879e03bdc989a51968a1e59d654465b459ca3df799f45fa24b844950f891bc1ec234465e675869c0cbef41e3885a6e8b50277328db4215848229bb85c47fb65f2c844b5e6a748f99fcaf74b19010d0c8319fcc3aa83d5e9488d54275011d0bc58ed7c2accd7f12588cf123dde56ca8187dd9c6bf450462b998eaa0d69f4e4725d4561a65f43087f43d4bbe51d08b91a1860e2efd727a00ae4908b12327fa776c5295fcb60c95d312b59c2d48ef1aca67d7b73f786f75c1ced5f867b8fb52e26f7706c4b963f9c4e675e659aaf19b9a843938551861dbe0d06db081f1bea8b94188ebb13ebe1521d4e3af059baa39933b43890b5fcdc4740bc0bdd84ad2de9fb90d3a833d514cba5ba7614caf94a8b28b85276d19c58fbfac5125fcdbcdca1b1df64b885a43c437d0c5fc5cfb3b72559d69a248b504531870b0433dca848e48b0d0401244154d9786102e9cda9579948cae839d1ef5364b73f20d692e7941969e3fec8d755092e6ea55b1b6118f8a56818e1c5da5f0dac9e8ca374022c975cfd82436c8df8879f1dc81bf8c106e509d856d40243b6ce1e37797797efefed6ee59be0966c2c8e4dc3f5c4fec6bc267d359a202a8c120c2a468385fafd414824e0938cededfb3e007145def112b6a380323cd27ea1fbb390de1a29dc13ba989433247b74f948307c64b731883d110529c9a1e3bb7500a9dc92abaa1d97fd6f2a275dbe85c315a21438bf8cad2899634ff7e8b51a8b8a20366922f6a72d2438e33f301be63b3fc8faa612eabe7803fd2aa39315ec17207e21da9c9addf991d6d3d372d97feb822c174a7954c968233dd22a899765f16de9573e12eacac2ba016ee7444ecbb226ce74fad11765e6ef1d321ce8c373696dc1f75804be2a2e528262bedc9a929c345d91a4832854ac07da9fcfd332f603257b187ecb33ecc731942c3a9f1bbee193a842597cbe93b5f050981d59ff8c22ca889ec0d902c7dc04f096847ff65ab913b7c66c422e7b1ee225ec62eee898617ab7c33b30b8ee51eafbfeb4e2a07e7b1f5ac0d9f0d8b52bf0f95bf3c7f7a47fcbf467f66329ad4bac03f56fb865ab4077a8088b9bd4e4b8e4a2c7a38d3d032d9cb3355ad60263576930ba93d7e193d92163cad1400c000ec930dbaa94480127c652d77588cd23eda9a200e31bed5dda9a1fc40bc599c8803b2644cbd8da989bafefa1207a5c160d9639f88dc88a7fd61d8c5d89eb98b409291fd6cb8768036906740fa8d26b2e53a1d4c6596ccbcc349a3505072e9443f9be7cf95513bbfa21dde8e07b1e3a3efc33614b1edd510271a9622cdb92c32827b4cf5c4d425175af597befb9735cbfc9efcfa0a6d43dc16677e48fe26cb99a5a1a4453cd4f69afb91310b8c4f4892b8b8f240e0e947f6a3c8a1689408afcbb99b93b94e61054141bf5f4a0211d056a966ab35d695f8cb8a8796d7d34fdc820f03ca6e72d9605c2a0b02387c83ff06208f0de7c382d616434e14d1ccf84bc21d513d2472a84830c9be393f28a4df94aace1c0d1ddf36681dd45811a19cff40e08db4152b1615d58e7f472e52431a187a87ec15569f9ae814d2ab774b7f3cdda50952a2127ac18cf87861d093edb56fff0a81f2a7b2873b5e70512b608f9ccd03b5a22b7fe3a010268f6ce806732bf5debd0b2bae699de55f31b5e5c782388b9ebc520f80d812d86d54af005f60a7bfc4cd5f25b46bd7b4a8f489bbebd2149379724819194139fbab87369c034f723b4fa48456335464c2092ac578dc95a941a39f997e9cdde08e82e4334ae9e53836ff49fac4c4e39e2d008515d372a98c0fe76d341625bb14a0f6285669897b34a28dd618fa789950e4619eb38db2db44ae9978054f16710e2ab1a6b765064eb5e3ce2b71036d3aa2463cdca5fc4eb90979085e0acadd431b8e7032052c3816e953e2227fff491622dd8bcaf6a002c32c90c18276f507a20996becf6793b5b06640d5041eb2aa3ae8ee429349980fbac5b698270d2b98efb4848983180f0636e786a60c9fd096adccd9112a3637a1eccc2ae6a3d801d450f5cb63c5702c805526929d6e5b0e70adcec9a4516997657468050ca12067c9a66941c4fc64ebe977abbe41caa5ab972a9fc11839aa5efb32d86c83180e1dfef19ec9fd2c706c5edc093788673c6868d20b0d9a091ad851946d346886c6b1b23063537fc243cc5caadba88e5601d8a1529dbc3a4d17c145c7635f0a89af369f3d6127339b5f4d8ad1c71cc8cdb387c049799e65b046d24109198947ddfe1bb2557fe3dc5e28a81fb745ea08384afd4e3595fd47613bf64052d678c6a048f491b9660534c959921aec224f1ad8d97f3a331fb209bc8751f477457479fcfa2581b5842eeb37bbab9b2154d02e440ed519897c5c09edc4141c4f9d9292996ec1a59af2f76576066774ae849b7cb3afe90e4c929d584a4e28771ab22b539e6dde8ba7f785fbf1d9c6fd0aed64e0b3c50d822fbfb8da3e2c5b95b3dd279c21a2482b0ca42d4ed1707623d036b69b0a69222c35fc98f2e98b980c0ded784f6c21cfd6a0d5b389a1d5661490b669243cb3e3e01049fc47b05949f844829d935f9e1637ee5257b194b39b24980c172f6bae7d50b95d2f4d435209c9467a66f2cf3bbfa924b687206e09451d7858daca75aa01d3c3f0f2cbf2093778f0c3e6f532264d8102a3f68b38e880f59187cbd71297a3df8973605f428ffe7ab72634dfe10d371173fed497e7b8aa7a9eda97e808d508b61dd8db0ecfb1465e4a34e46a365f97043d41939db3776aaa608624a361f934e99cfd1d372097b62386bd7a13070708104624e6092d7f32401d400b0607c19056b0fafa229bf63aec8a8ccf6fe4c777508ad5740561e3284a9e8c01a68f6d4549364d9aa72d8a63476d8f3f1e6e44b6e9ce5ce59672d07182d7905545deaeba7d15199126151e60ca195ac485b29e537d0b7ea5a5ff53fa77ca2fcc8f5b7af5e5d1386f49a914610894b64114de346c355356d7927ca3a1bffa1f55f070b775c72f99ff3a3b8ea74c237f09f6cfc39003046252928cd5b62bdb1bf2d25b0b8c414ccfd940d90d00bc564e218d3b6f956ea3abd2d162a4eb60e3e8c80b5d9da228e404b8d619538bb69f2661a683bf1e0acdd1c15dd4799b7f7053ba54f1abf3c47805107c805f0ae3b4025c47f3ca97c8af3501f24a92149c81ab7f69101a0ad7fc5b7c4b0aec9c91089084f1fe05ce58a1774f6d39c5bc6b98a2c860b42a0ecde5e82f9df13a8dd56d87ffaa4681aa1ce03293ccb5c3b82ae9885b924f1a2bb2d8494faa75931eeea012a2a007b901a9f66a93e482d607afff80b15244196d265e98eea5d528cff5f23c7aa04a19215af6c9357ff9fef71a1099692b81e8bd56fb27a7a1f94839c3bb3fd0d802d36549d04a24d372984a6ea9bffe47c85ebe29653ae3d1c5defb1024780f343fdf09462ee26e0bd0aacd46d78dd43d022261e99f9de6c4d51deab6bf714c224579e3b11c292d1666540a2381f381c49e2f8466abb2ec0fd1663b2c5632360e1fac845cc6f6c870b1d9c309057ceaae768186d56e22b7976feda0fbafaf89e5af3b380139c123c38e206a88502c89f262e745d7859ef6502663532e87ab0a9c7ea551f29e3cf7ffe05c27168c879a1a66cc553ba7fb817542b321ff8fc3fa5aff45d24162ef4b0537be1b29c56d9858c7266c278ac8d01fcf0eb3daabb8634e4956751afd0dad27f00318111f7280240b9db8f8a361cd4a002eec22958260f4fce24016271e31d2abddb1cb1e53c8e25dbf21d22e7fd52c4ae61db1361d37cdc75f4706c97584b01349e0c4b3d11bfec05372ba84533ebfad0e715878ab5bb4e21c6dcf3b46124f911f1b223a21ce910fd12ca5ac5e6435ec471182d682ec711e2b2fa43f19e8fac3f18840772fe6e8b8294e84414ecf59675a659ddd54682432c58487a92e83e25e992b84e51997c8e676fbe3db622d82229e69a1f8580d3f3ef206bcbd1b9f91bf45ffe8c5a7af5d66fd54ac1a982439b48fdd27508467080150b1e6192d94e5a1e93f5d6bb605a55b67c86179f8d95235989b757067693455459c69e8e0891e3430d08fd473a672b2cc65ea14a52aa8178db4a975fb74adf649c757d57cc9fac9a0a0dc9e963ae493e7c8d5dd945c1842cf8708a6089ac193d9cc018bfad08527258e283ff5f6167f4d178fa9e7d81f5288e0a50713b27d0ac83cff4c70bc2e8bb9e343d21315b931ffd8104a1cff2661e32cdc3da05a587dc4e47dbd08f2b1b790d71e4fd0e668bcbd8f2bb264675520b9141057d62540a62dd07b3e09fe0bf34b7976899c7c22082ad1f5d41f39321615a05638ea6c8fd9ee38eec7af1ece710bea2ed129bb017f1b3c2ce12d3037d19eb20638ca40a6934d57642e1f274de597ee47e17de90e2d1986a1f7866dd2d33a11951552ec572a1a08c74e7f21ac0cb960d568eeec27d15af7ffe561fc385ec26647a45255c59ab2f3fd48f6049c81f9f87605b1dcbd33c2607b82403c2dd29705e47c34104c18bfe7250687503a2d8670dc9a462f5a778d15fc32e35865c46bf84f23bb758a5018f514963f7aced27e64e3fbe5db55e07e0e9459a2c971e5486b580ff756d013e212d03cbb5898a0b2e1b1f27ac96875dc1cb460080d88a30c210e662cf971c694826030c79ce6b681c7d33338aa41400b00d97b0796a4ba5239863877fcffe1f59d2ecf2b4465ab37df632d10a55f736aeeddaec03d3620c4926a3d7b8834b265b91330e172f4eba67ccf76d9184d670c5ad7270f201abf7d2cd924c53123546248c89e69144f444a3b9475db86c0d03accb9be4f4804b48175aeb4ca4f9b173c5a206388da7db0d2b75917f045f8d66d175a7779f36301a852e95bc145efaa192c0e709c7c9b8833967a0c5a01e5541aa2c0bb9310885842525853454651332cfb61f54236f2ecf11aa5b72e49ee6e5983a0a05521b12c680b6bd99d10cb81ffa0a8c2370fd8cb067936778061968bd163871b3cc8a2867de1a9873ae60579c16ad8ef0c9c76ce93168d0909965eabbeb5e21e86d86ad137654f1e92370a446a887f3c8245429d4c1bbf1ebdbc78a2e11cbc04e83bb92fc4289855e9bfcf7fb4e76ffe4066cec9ffcd8894b5d99bdc436a393dc08c82594f2a56dbb20ba52ff348657e6bb13936add72789279d593d6955ef03cf797afa8acf066818a625d8c8bf2288a1afdae6fcd6f97b5bb447dad9b5f098f3a416b3cb936b254c24487156d470db89296cbb4ac048cbf140cd9367de76c92f711dff20e9fa6e8cd797cd0d298c1c8eca74356bc5cfa74ae83ae053fc63c3da5acfcfa578a4ecfacf1b7710f70bb4602669292f90dff0b36c1156f40a702562d20d1b448775fad460d23cb755c7b3f867f3852c9ad5ddb461e3fd3ffc3fba2339f99413c6d02cd7b3b1997a2f2470f3895c1e5d4b663887d0d4eafd49b22601091795eb9d03ac353bfa06ac1ac62b22d13eaead07224cfb400478a5d62ee6119fb474493377b9a56921cbf0e44f48ed1d6ecd0af37b55cb013efb1682e2c113f2819359ba14d83f0d120053ecfe1d7a21e4f7f6c742eb6d8e0aa9fed7d788bbbd31ee1d1dfd369f4f86512d4bf20fef6b63ee2795896ea84a614edd5dca16a41365032ee6d028736874b19d2f7d1ade85e50416c8c390a1d871a26958478803acaf9ee1c574abddca800cb775bbc52941fb3c31512905d6cd523535d763ed706f7e629e114b26775992f184f643002e01e7d92cc10f60fbaf1d3df75474cca88364ea83a6a20de59ef27ba051013d5670a1ef02199218e4b0dbf3e57e77bceb8d9cef2b1452a7cdda63d2672f483c25e06165131a792b9c709c17ebbac973a1ba4ad8eae7e44b0be522d186785a198a7eb5e346f5712055f7d7f5e0ab99117e3127f9b7154c43dc4537215f031e58a5fb483f46f22b98d1b45df27868e8b0982fe78f2c8a3f644a941a1fdf5950f4b426b559bbdaf3098af198c4c180116e66ba6610421e0330c41764e76c4f83652f6e766060532f237822ff6db1e895098cf86f4134270c0f441d14b3bbd079b3388a491a35769cf4695a640d4e18108361c425b7f526478b3f1187b6ff102588c44dc4e4d945b97c7a99a6336c0e3a283be5c8effad2ad5dff07644a5f7ffa86c422d38de21d42375171983ee6498de5d620306f1e442975e90b185a073c4e7606ed7955d470c1cb109cb272af1320e1b4d7f4cabef8573edd9f138c19a0078508bed5435a99dad03b1932192612d93936215115f1fedb0557347f</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>光伏小知识</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>电池生产工艺</title>
    <link href="/%E7%94%B5%E6%B1%A0%E7%94%9F%E4%BA%A7%E5%B7%A5%E8%89%BA/"/>
    <url>/%E7%94%B5%E6%B1%A0%E7%94%9F%E4%BA%A7%E5%B7%A5%E8%89%BA/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="9dca6e94ce5c3796fc57d806ecc82aa938b7f88bb21c747b40196bc08822ad84">a497b25e6862ef932bd8b8e9634b73107fd22b7c0b6aeb86f1e0db1a2c94058e7b61913394f761f2698ff08edc83b403278cb4c4569b0971bd384485139e354f526b73ad8cae3f873fdc12a6b9f330183640544164d682e3f95921dc334ddcb98e68e515851af62631b78793eacb5bfcc05c70b28a0f2c56b86bb10b939b142c0579fbfa0aa460b88adb7349a6950bb2580dd93ed89c4875681eda39005b6524f1c7846b30ccf2643afd9fe40255cfa0ab5cc64353e34bff9b97d43f551b65d83a7717c55accf9e291dc0a146ab0e2d7a617e2b28a214b78fed02a6173846117308206bfddfbf1aa01016e80b9efbab6311ba269a839fc61b294d6eef069ac34b7cf1994d8b5d4ad4f1b820de7d44b100c4bf90bfab12c05133a8357919bde46e13bde42f792da8b2e4d8f08d388ddcba4c32ec3e4bfcfc7be5461b35c3b46994a381e7f7714179628c2c1a69f6ecb68afc4e247428db5200552ac76145399dc883d9931403bec8d5f4cb7be7556bf14127fb96641567d065bda80f09fcfbaaa3577247a6e49ce5d04c59ed280f013e0d06b8a5dfcc6301ecbe62e051877920d25700e4103288dda68c5b49bd6f9f0c7551470ac3e8e06433222572fca5edbdc1c896443e69cbab4067cfc95d26368a9bfa52aa1d033131b084585082fa81aae88ee6ad4a20adbd9497e75407386f869755a2eadc0cabe43c922a6e6b6f432f011b85292f4647b9b2688bd8f359b84a5ef1717b8ba02e7e2671e5c1c806cf2057762079f5550112b13d8159fb3d3f2994eeb7529caae754a95dbce06f58ff6200ce03752d4f407394c90a094a31157ed095ed6dcd8c704abe70fd9f9015b59293bd9b6e07751a3c1daf4feea10ff8615870abaa324fc371b63394ddb8ede5dc3f851fd291fdb85991ae0e98a54eaa34d8b7c8429df9c9f0936c1cc4656ee4be535e288202f633ecea89aaaab0635186811471b1b8f2bdb501015d630f17cddf39ae42175ef33f95d6ea2a7c9801f8f4f8c32a49db03f1f3bbde8a50c100b13c13dec5c1ba4f83759c6f3868b33ccd253745b047261c01b2281d781f97c92354b6b37d5d9908028e51674c0b7785c1e6307ec08c232b626482bebae9d373a7ba479fa7ac4a464e5816a07a82f99b2b259a5a479369b2e35dda334d8b58be94f2c9e82f11908c0ca93deb1baf24748422789d2cd1d28a828eaf66af8290872d909b8dfa5995930d8a96dca076250b0fcef19c70c8ba31eb80ee8f1b49d807611228c85b8165f1408e0b0c1c6fc4a297ebb041eb4b571219acb14bdb02a8c9c54a7a021bdad8d791305e9a7d8b27ac517e12f0e8179386d2e263f6f5fcc705fe9e2f7f86bb42f9a2e580d28a944a95b34fb59ecddb07626ab1cd784ca67918e27978224db3f6a47d49f7af772a91a76c0b53faa9e6d256a6ea3eb5205a0916fe2dc11ad2c702c95470917ca9e7fe2deec0049e809a94d8a49f84d4b915532a6264e0161d134b16b68f01e6dc1d644200d3b1ece3fcb06d5c7cc3b5872018e36654fae6b7cd8813286d131297c5f25fcb7730f572088868ad04b82967093a083e57ca7c8ba1af0ec68d67fcad64679c8edba04600c3b1a89440c4e6e3488810d78d8daadd7508f1cdc4b48944015617d4d5e645fdd224ff26a35dc4aff36f58386913928e52aa4e4b1854b52e27f2dc103405c5a5119d0a72fa9ebd9bc9c8d1cd3cb3d238dbce8b36d5f69ec25bd94ab1948c6b32d324162083afca348f495f7d65bb37fe5eaff89af62a3ecc315ade8fdcbb9652ce5b63a28af8cbc58bddd588c6f259e720a4568d70539a3d825b6c7381fa6cb9b2f9c399085924b516a920456687c1b477f5518e048ea298e1fcb0870fcd63673de52b2bfa8e10c1106e661d8bd4966ccfc92c9010ebc73deb763a60c42fa7adea9e3b58be4583c218985d03b3b6aae4dac66f8309f76cf74f4edd1471067a1dd36a2baa423c613a9361bafe1218283dbd9bc278b3158b1afa1d3204c7b8363a7d6340fd0ce7ee8d25e8ee8ba855c0ad40394bcc6a0077988d37db820a730537cedb57cf6c6f5593ce1b56bf1dbc71ce3a5841395da8f1b1926c83b2bea07bcde1fd90fb2bcd2dc8e1e74091df17611f9bb499e63ce066c64456064fe8b4068819918ee5583110b56616d4a44a05b65aad8d278e7b6943f8b5e7e4588e226cb632e935034aec9b8680fb76be9c5576d724827f44cb043a5fb6241d8868265f6309ee8ccbc6522fdef1ad35fa23899161effd3d1076e46f69077e098d28438932214475188f923b4b21e272f6f029302777b731f8e5e9d36d8a57f036ffe6b329dacec6c85e20b8c1465d685db43a3b31a294c65b12463bf5cb9992f2f9b039da3cdc5232def891b1b7fc9f05fa44ea95a0ccad7baae8840f1a3947db8147b91e0852674e6c44197d79f87e5b76124b5ac01eaa3c70d53963647e704d48b9e5968bc8b49626e72a1a7fd22eedf8206059f9fc04a297001be5e7834fb0b68b805c2020cdbfd638223ecf53f62b83ee2158bab0811a45651a77d08f53ccf04154627415b8dba2859b1f0f6e9cd026f9326ff040cde5474292bb0e576b6787b15b56af03f88c82f5b862956cdf9c4aaf7d4a2f403b6d650412a1f530a7937954e7c0446b79ece76af84fcaa92d9485a61a60c11ae7cdcd61fefa05ee2303af014c7a5b838cb93fd8ad3475fb0613318e84011a0a3519b5acdd53a9da020a8a77f31babbb4358135a91a780a010e43269a2103088a64b899d3f9f4735aa9878c54e4fcf6e85e68c8340a89741b6e58dc48c2a6e30294e145d8c00f397be7a1161d9149948c8d0ae483423cc88621338b8b5d0e8ab7875bf2003697c3ec9f76c919a4b1397bbb2e7ac2af48bb08d0e4f5895e819047ee8af808c28a3b2a9adc9ef763f8d6ec744721cba3d29cb0797ddba04765e2a744a152b4f5683236b112d8e08c30fccb2b001cf15bba97e5d4972c68f757646e1e23e7a73774b6fa03e5cbe0ca591dd8c1252f17888427ec2c75644fe71dc265cdf7eafc75cfed5f0b8a4f4e2b5b895fb03dd5bd4a271f0550b2dde5dcddbc9ff2740a920d9d7762dc9d005925db354b58a0a0e9f2818c0cd0f702fe57ac1d65f40a0322ec4f38537e04711927964b1cbabe651fc50ac2a8a96633e61731fd36a4b3b359c3d1106ee2f06fd9eb7db0599b25eca794adbc1b04125a337e60c75d1538de863c7296f3b9b18a27af0e16c7294fbfe9f0eb13433c571f1f4548f2b2df6727ed88551bf20d48bf8ed8e4774173efc3f0ddc895c8557b807810d507c26fc0a8496db0a17af6872f3eed7b3619dbac71aa59ad39667405f262ccc77b697294eecb4bfe36ef6609a9a37622d89c067dea370580b23a942a8ce1deed25a8094b3e9c3b6f8eeb5b578a648dff8ea8f7e33c5f8a2f6658f98f4c2c350c3910397dd2550deeef85f962e04cea01b94c4a0c58972da5ac8bf82fe8136a3d172257b399ced78dc230f16b30fb7829a88703e5accd363861e89ee7e9637adb232e234fbb183705b108a2ea3a29b22d15b5c1ab403db4557b80a3c64e614029d836ef00a1d4454d42f484e4f6d286c2da65bf035d2e7f8bf5ac05fecd8f9a2ef37cc1065f3d2f172017e3a6457fa1399f77fabd6f6c95b44e07d92d13ddc141b7076fb94a66272892693323f6aee00b0da19d76e2acb765c9765b7e45a7a64726910fa8b67a98a3deacf848ad8969c123b3bed1922f73372df7237fed270b31e00ded208a6aede9ca5cbdfe18d631c073cdde09cac7c9171db67b4ab3d8ee4fd710d3d70657b3b9a840a9c783b037ba40be88c32816b66812b356816134ef7c061f5df0a401fdbb186fda3868f4b995bdbc7a27fb31a3de11b8acbb001e1243f792cadacd6143b9fb44d6d3d458f7e35e9b35f19a550eca2db706acf5d9179b950eff29cc3f79e031d258d6d594336b1714e36c5c75f6842cc0b09c5e2dcf8253995add2a0a878c12557668accc3b941dcc69b684964fa8ae516786dd9abecbc144aa8fc474409cdcb3bc286c77676a3897448921f125b246bd7f1051ae8386a13eb777eb60ccb375712c5c29f1c0638f6f5b932a1efd217888d2894e681745867e53b9948d07af6b4c3d48e446f4f308b39e442415ae1577e937495ac985d015e3a7ed0b5248a5bdc4de68450dd5e39f039cf4265d7e58cbe34d7eb0fe38a3d152cce6dd2a95758398284f3e53ade96f87c46fb7d69c669ddeef82b62aeb8b1112571fa8061fb20cc7872552a4176887ac0e5bd1893d6d469196651772b52eb4f9424117127e0ec20d245be97be275b8f4e470532719361fa3b60b3d7c3ea1df4074bfe018900cf150ef24033c2aeba91f5299a9f84ddd4f2510725f87138f5e7adadcd4e10612844b8d953c921ea8ba196d9b3094cefba993ce126a4f45d3b05c5d3e32cb537027030c5031389b87d856367df8f01b2841284dbf1ea13bde9bd6612b9842b8d30abf2a686fa2e5476525ffa0c0346b12abb88ef6d2ac3ebc2112844dd8ed90eb27b0ba2a5c8a180fea5dab733535919be86b3e92a951ca30a6ca9e3105ee5706cf52b0f1bddf553557b1b89bb0652266df985f0b3bfad620d35b1f36ff5f6325a1b1bd6f041f5b2b5f89cb28102049f0652f64befe9121a412d7e7233917a3df6be94850e1327e7db60951f555b3c5411b62b7276042152785a7e8873890c72aaee14c105ac6382872bc5313f2039d064f7fe14a7d54afa129e89ef876546738f290769cc564d4a58258f0094d615fdce07c55649b7fcb506a54320f496d538874864dfadd5265868188fb5bd684c87a8246e669801ca4a875baf5990347daac18065c8180e1d0e9acb8e0540739f39d4addfc38dc6cd2b2ae7dbc58e6f4d2670c44e87487526fd953938c6948674901d64c29730441b9cce69228cf9c8130db24421ed2cf38225bc6641194f9d3a133fc35154a0c0cab8572b73d4da02c12789cf8ef64c156f6883c0678b1e782b77e4ee565ea52fc66c5c3d3180f53aa0dd7ef4429648e8514712704a7901d889cf1e2ce6ce986765874adf1fb2c7a40841243f897b7e477c8e9d719a4f0dc1b57481e18a87a56b6f772ad7c4918f875564cc3373be8137b58165d489b493f48ff6e117916a406b94b17905757e4b394ab6e0ff64b513cea2a150d5a0716b637804dee92741de0cbc4e43c672b5a1d659c1dc3654fe8dfd989aa7f82bb41083955969f9fdf811fd600826eaea96fe1b6e8f29592801314141fba42c060f595544ccc58024cb2705eb611f947d63c03af758147e23c22ae9b7aca86e1d82412484ec6c1244816790a2b23ee46fc039bfbc52647e23aab0b380d5c0583ab16901bdad87836cab9335aaa6a3eaea5a1617a3e03e9330cedb85dcbb097f8bc8e4f976ed4513d08e816f803102f6fa281f3ce47230d519d43492c700ce2a84348607b9de327e8bc98f61da3ebab8bc77b06f8302d7a904946bb9f46205ced0c9c29503535704f3a77abbf2b649254e95bb078b6969c86155bb4fbaa9eddbbfc9597d8d77398a4831da0c13b6ce40e2cb3606861ebb714210db7f293c551431b02d8fb85aead4bebae0ee4ee03eb7285dab3ef1228911532d4086fe333875dd6304836776cb586fe8c398109cfa22b930b00ae4130639678c0ed436f02011e5588587ca8ebed118235ac9ba5a73aac00646228f635bc2366230be63ef791c40fa49937ac8b97cc6cb39a47b73ecf3a860e0f4b310d92d00f6e8461a1040a8f512edb221f4d0e7eeb04b61d9f7b2e237651d422d94a3ad25126f68043dbc655905105a8f7b0fbf915b7af7055b418a149d10b821a269d6600d21feefe2d44cfdca50ea198dcc2bc03db627abd7f3bae0eda9169ef86d1053653786c9d97b105edd33fde2f97993a8b853bd5ffd1d1e296137f600dd82d17c5b402ca645e60200c98036520a9ffc92cd27829c65b48b1153fe1311b428152a7a0b740b341401cd88c4966b4a78173e48b16e8005f90e752b76b9c01ac56ad7d5f2498ae96b2a4f2f185f003504e4b763ab765142cd7787395cdcbce3d8b68ce9927d7c1990ae0f475bb386391f48ac85041bd97dd1ac9e4552ddbb332d208c109944de36ba09b47dd51e03e67d28eff153da678072d9eee2a20c94afea25b24ea85744b0394f3fa946bf490c0517165d05b96767258cef585aef613f779e5dc383d3ad4e54846b3c1d6869c03985cc27c0ad5f4b088f3b4a596ae5cdb6c8b019384368ee7c2525821b3a59cf02fd8f4f8cf41816faa6255210dccbb89f0d2575686e5974f2a5480f7d98a64a2a5a7e1c472ac0c8111b9493fe55c07399944f9ed71bab83a38431b94fd648752060ac51a2765f200e43e38e782d9e2eb44c0c7ab7ea76f7ddc5a1c6114b482bb814dd22bd854bc0256f7ee593fbf402beae13e0eb8d38fe457a95a0ef6ad257241460982204dc6e74310fd2b5a4217888b07319767f137a810760f5e4f92401f95a3eac76491f81fc95037e8d0daa70b17aedff0b8b1a16e1a16f91d6cb9fc594bb4847fb00d32f1ddc9efbd818b59e4e500d0c7694ac81ab4a48bce94eafaedf5ad2f9667ac4a7fa457276998be96f867c7c725911f92c76b51ae0ba22b853a25a62c6e823b85b7ccf63b3ac4e0ddd50cb4aa07cd270cb1741e7f5b0560fb4bbf552e7320ea3566acdb7d7019af3a864c4d82cad4fd1de813825ee8153b6020e2c164889a14bdffa019d7941326bbdc59afe7a6d94c79a47d7ce81bcb2c3cc9c8354a0880369fcd4cb4e8e3027a1624ea0ea5dc47f4f0d2094df8469804a222eee6467a45a17bf0214142d19fd5fd71496b8b3c04737eb0d273d30ffedb0fd7a7bad48465357217605dee481bb0902fbe52908f8c16158bf721a310c20c7eb9249eb2603a38a51f90cf6a573d01321ac370a4ddfe4864d725e37a2fe1f2d9e3b37590a3fd676045240569a24672b7b6ff50256ac9b2cd2336e2c48eebc7e9679cc161746e4c517840aa513900d51dc22ef68f9e4e8509adb1dd6aa1d217509124f9db9a474cf80b959e7159100e51428c8db39fcf3a4ad8d42e2cbfffd1d7adcd6ff40e8330fefa97dbc061ad53abac9026bb121324858f3ae42ff0d224bb0f3fca344dffe862371db18a6974608246a003a5ed649cca29d56ccaf34d44efcfc01bc8db0ec09aad70c10a3cac943aa217a74ad1eddbcdfd0cb19321f57536e92b36f6a88317193da681fca51e2606d8187a7ed0c16634f2a759dac6d8fc51ab4b70b104294c109fc043e819724114bd6f5115888af2390fc2dc15db4d4bdaf24c06831aeb06e836b1949760a90c9391406ef84717a1e2d053b5d67be88c25b82c7b5fa6bc4cc7e7ebc3b4a0ffe514dce4972711725a888389a105603a6f2b38a684c0fb9d7d22921684e495b6abbf2e818cb80276de1485e59b88665040fd33557512058838cbc96fc63515fe8e8ad6ce1b8840fc8af8ad7112f3132225681996a270c3be0bee83dbdde456444cb8d63cc3f4b436a6a5e6dc6c5f4446245e828b03458dcec1a6f9729cd37d3d15b3cc02ecc9fe9426a1b8321e287abccf9bd46f78ec201aed3ff26c53fffaa085ee860dbe612e451286bc87aea87a50b543fc696b53074325085dcf2e1d0efe024aa46113f483d6b3deac558bae24e837d67eb80fd163e5280fcc0f5de8f92d9ba45a76006306109baf396b5b352d068285df5d11633bf757ee18eda342873e0c31b37d2108a671b0add132fee0c2a936b963c4331e8781fe462addf06af278e924b23adf464221adcb126650eb15447fe18a8291b0e9de1e16d5c8a04a120cf2df0cf748185870414644529682d0fe4f16334de5f5a55327760c62bf8924be83fa1b4aaf6506b47f1c496c9c25e70cc6b426aca9fb0a720ec95c74564ba143203372853b756f1d9a2a848f328fe31f8faa35242b3e57e03d7d9b0b700f9bdf7b9e46bbd966ab7ff1a06377a809f563ee631bd4ee73112a04c2202d0fea6078c4e5fb7eb3f018363ec2eb42d70e6e9b272f09376495b345f44fb6a7f1b01e6639d5d20edf121e24c52bc3223270ac6c4a7618f927eda70abc801ff51723f7f894235721d0462bba93ef6a468d368ea5cfc96bb3a51caf9eee82b8d898d9e1986ca325e146d5b3d1cb3933bea759ee772913d91e32dcb4f473e592ae06f9dd32b083065dcf072d7151cf3a19466108e2ec6fd0e873bc6b4af77d4a871f433e3fcebadec24b490c7b63319d712807207fe846eee7208b967054bb6ea09c83407a018530f2c1d7b85c1b058cd0d364d067e50e89d7af81f7780d088773f5d2ba934fa0b3c55a03704a9e35ce48206a50609e32601bbf469b86c572c26da119c9e51074bfc76e92852d805a0caab12dab663b86bfc86095e0020bac06d551a2c48e2e9e391e1151e86698296cdafdd4a5b39a2313cd4bd5587c33e2020c9b1a92bcb7337792073102df2a48afd75b8fed462e4cbbb90f5525e3fa8f743f372ee6d818c073b052da37660bc303a03711f5f445ede4563b90ee7105496dd7c72b083c7901d0610c1065b823337fa08e3d22c4f8e28585ff7959e21dfc6ff08bde32e8270c606a7b57b95384ed93297f378e0962e049a149f4055ea67f13c867806376bb7c15e7d28e2f54ddc9813b32305f8fb6e406b6db78ad78cbd74b2169225785ca829eef8dc3e31f489966a4ce5d8f5ffaf639fd045956812c761caf87daa4be162b07a02a7f413385ed9d35385f96adaa8a577e13909c72ad89cfc4e8dcef4c0d8abba469ce0e6e928a6c908e5716151e0a6130809098525717225b13b5a8a850a89f4e65601847d0ff1ef334a550636ce315f85547d349b6de1e56aa02421540f24e550940e94b4110927ad36d92b218092a7a782e25514cafb489e13b42e1495eeb29998023109c418bbf0a4562c610e7b08fbfef52f7f3b18a43c960cba323a0bb910bd16ce9</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>光伏小知识</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>拉晶切片工艺</title>
    <link href="/%E6%8B%89%E6%99%B6%E5%88%87%E7%89%87%E5%B7%A5%E8%89%BA/"/>
    <url>/%E6%8B%89%E6%99%B6%E5%88%87%E7%89%87%E5%B7%A5%E8%89%BA/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="641d90c7cc01e342def709f661a9d950526750d8f717a5537895d99cb89b0413">a497b25e6862ef932bd8b8e9634b73107fd22b7c0b6aeb86f1e0db1a2c94058e15d23e6fbc164af28f8f0be4de6566f46f2d7974ce66c1edbb7df13092f38080df001850e97c81e227cc53afbfc55d571ccaefdbfbbb134d59f605db3f875ea3e403ec4b660762562ad77c78adb47dd43ecf4e1b828e7e8545733e708ce2f38ddca265db32b64282e5b9776a489d0bc41b0216e389541bec8e145e872788ea98bf1ac095cf8bcc9ae0f4e8c2b13b35495f1cf392ca213cfa5079f81a1840ba2007896c0d9a04d609b4dd37a7f4ca7e164b01f760300d2e972b3c9ed9267e7849da0d2fd14f6fe7c987a223b96bf83234bd994ab3cae9e1f169de1ab05eec8605eb652412d4cec63109eb9de986ff600b871a5cccba4f21df7a5f843cc20c43497cadefeac010d60566a5f84a294d4cb117496eeeebbbb9fba71fe71c7ce3e86d8b624ba6bfe1063671acce3a89f98d8d5b329d0cbfbc10f64a050961fa0ce706ba3f46eb2d3c0805449ea89c37e6355f8a549798a5da11f180b01d6b47599389a2fcd3edb478c228aae7de052985fdca34c5a8c233e38a52a368f3073fe01ae2101b346f78989b9d8224d4e1cfa1f8be1cd0ca2d08591298347e0d93e798ae58cc8f3a54588c5ce573abfc63194a87df4147fc14e0431e30432b944e63e8e46f4a97f6de0c8a5cd0f29b8270b3cf0a14779520d805ee43e90cd32495ee70b276f63d530654191b4e6cee21d74da98b0050a49d12f3220845573aaa33fb790d1ef002ae352aff4608256bd8d5a6c49542b0ee3614724bf41025a9699c55029a78c7c7146f7fc017d0d8770350757047d3b7b4d37d298ee5300677f47422663abf6d07ef7ece8bae69bcb9a7f75755e552732fac5c75f5dba0ae2f690d9fd5fd5ceac8665f4d4348d1540fdb41f755a26050ec0c133b92134cfd2dcf26676df54db97093c01070cc7b027e5eee2a832e73418921be75c8746cb1d17660a051ac4e8ce7da83b133cde6a0b60060a814f0b09174c721fe95f98409aa77ab1d7a9a58ff4ea29348ca3d3a9c884901c30bcc7554bcbd6dab25defcb1791d955ce1ce879fc54583fe5416b08e3fbfe751f80bd343f92434b021fea4339eaa2d1eb5ae111c769997351b71b92d26937bcc9404185eaa288081df0499a6f919a4f1ef06f0894666d42a620a5875db3e4f768089451df45e3a50121e4a22ce6cee606c35e29e66c2139cf68934868308bc72ba6889cc7450de802f1e5099a3551a08f13cc83658d9947f283790894227ec293acaff9b15aa11297a895a407e9730ca3b68afbccefe56a74bdf7f09f5bdc53af07b09009f3f782abd879091c16e407edffa9e025252a7e6335166018e20ce4c00d5a63fd0cd18a00c4b27baa979d1a2539e4049b37f7c7d44dbb7595eb149b9a9c23f03f3e4b0159996c6ef9a386bbb78dde7bd037e43a5341df3da18853331edc3d46db6ae091b21d0d16ee7e46bf2e24157e189799f439666fece72c1d855dddcf6ffd9002ec456075c43829e90071abb067eff8ce2617e11dc8175d4933a475a257abce5e03a10fb3b6c717cf4eb68149ea918e9135c7cd9824e43f7fc16037495b945b9365de089443f7d241a5b26344a842ea1141e0542f8de01dfb9733407a09408b9fffcbb31fce9cdf86a47ff9cfec87309c8e5fd21a7db3e48da0bfa5e7906d93a7972729b035b2cc99140729f7ebec94c97355831629c12f9fac6a0041742fe91465cbeb55946c25095ad157e814277c9274cf05b6eb4feb17e6c63885e25662316bce27dfa46436e3f2f532a7a5f9c5289fd7548d23924abd63dffe76c2aef446b70cc52aee7e59977b1095aee5a9ea8c93ed5948cb78b9bc5cfbb14e912eb19da1f3ef98e9c2008ed3ef777b44c456cd0d7bf30a1ca88dc917ee7210362909f6746db961f4c10efb58996111bc9d5558f03e4106ea40c90157c15e4a6c0d318ca88e0e80eb6788dbb4c2e87a7fcca08643ab41e5bdc565eac1fe1dcfb4fff9b7719f507451fbaf6bf9d10a4b6cb53f6e94de2eac8ad8979320af2bcb3eea35146b5be396d4722fe309410f9f0aadb2d1c532a00ed39fa6cbf54c731049ff26ea56d0946f874876f3c5e0b7eb870a2ee28db08eaaa7a9d66eb7cff6a2d8a0ef4e6f2693263b3936cab090880dd3dcade33d6cd5a56a8f6e7b537560bae0a6b080c0f1456639120c0390461070d86712e295b3654b635456e3f09fbd91661c935a00a5fa932f2c721d9bb7fb2964b3e5760bd70535a882011d2ba895436296888791c89b34c9a4ddb6d9b74918ff326e39dc21b4c26db82b070dc9ace90a44c2825433613b0427157f2ae84bb570bd9b0beddb63c527e28d64f868e85d52c93a6335be5d76121e2988b4a7810c42a734297869da268a9e9e93d31d3437e13d8d8b83cca646cb832d61c1615e43cf01cd17378f2b2831024c9c3a6fa7586c1ecfce98043bbd1d4e78edebdd733db22bd00961add5171de5a5d9635b57341fe5b6282e813c5c2f3f2d157b30512d894d69bd6cd4bd2bdc99f03c9f26db06f704c58143ffd65ab316ae223ab7098cd72997f8af7de8e6513f3bce9fed97a7ba65c4eb11ed599390ff8ba5669ddf556548d4a663ff61a6e8142b4165c358df81bc8560c6c6cbd38d1f9f63ad9fc30e4c3f473d8692de54dc6137b4ee34084e37d9c7808b010951abe02a2c5a1f128760431d475940d2385919f6bd3168e81afc704946baf4e5018fba1fd4b1bf8aaa5f7e89018d3b06eb972a79841154e854a3ba7e7a1d452d277d471baf08efde6859e20b3fe15ff946491b4d9ff7cd15704b45b6a522037ee02414c51d543d6d1d3dfd42ce23cc20f6ea154e54289a795a8eb49ac5714570c01a7e34b229dfd803684ca7156b8d2bcbe8d94f9da5b48ba29c1d27a4722473a12789a0799037153472b8f301bf105dc293e774cd0a8e9d4e59b0decfbc92bc31f46d90ff3b4e89276e7b0b532b6969428743af6a119ad3a9033a0ab27c5f7bdebab23b9b54ca54e9090b39f82a09711c423ed6f97e47ab11e7370674ecc35b9d26c5d836531ff9de21b910358ec4694f4efca57546ef0a3bec40cd14728d39b6d9a6ca0aa00dd8a6d24d1fd7eb694ac68c809458930b786c572329c5fa94de002f2855a87eae1488865c0dc8f4296e0fa369f4529117103fa157453119777f4ad48801aa592bf04384d6d38a47f57e66e409fff7decc8c8f9747f17cb8bb2d6667ecedf03b2bdabaff7fb09d67ada4561e59e191e7b8dcf22755fbce8ab29b066fc35fe4f6d4b3f4cee7acb5cf931c9ded16b8a8e2cb62462ea2745dc87d9a55b5e0fac121940a266722ff75acdf8ca37ce9b1b41fec5e33afa8c2e6316c85ab6db2644a6e344834c2c3bc63dc83c1cc3c1eac74dc3aded5b6a3259fc930f61316da403d14b11fb10c19e9d55bcd50b94dc6053b7fe7968b5e6cda7d5a06bf88b026e1afb0941dc9c789536d2202b9b620465c1442568bf9bc34b64b54e9c7c7bab50ee8d89daf77401709df00790a4ecd12d49a1cd44b5dd43115765e581c58e39969b41caf61eef7c0917e810b2f7e8a0b3cea3657c914c5a49c6f22743c6795cc382d44bebc200e4e57cfc3f6d99e9a55bff0f6fe6bb850845b387216b209967209b3c5a1e7a7934f03b3ac0070d8e7d74f062cf619d73ddd6101f192cca2e3e3753eba91d87508148ebf159da1b047288826ff4839ea448185cd39fd9ce65d82f78bfdc8a1b06f968b758830e2eaba839a98ec73f5681bb0657d1a80ae07c4519cc0c18590f54170cf8fd8b020a1918e2445ca0dedba89e6fa997978fea251eb68c47486a35fca9b006526cc533755f1bf23ccf33413da00a0cf0894259471a80de360ec2b15e68971bdf954c50bc7865a192f2739cad913041898010b2ceccdcfb8180368482c9a74a838a7f5e37c2418e11f7631f5fe24758a744fab5824c3aaab31a67bc09174ee9ccf7942aa00f8b65a45ee9d2c16fb5f4defd42eb8c0e6b1c4c8693fb793d722ea4a18cad79b30d68aa2a2b19e6926dda3a7b666a37817276ea40865f5ccddf259fa25d59a8eef859edc427594520d37380bacb273716942cfaa15ca12e4db921252d53fd35da7e309e7fa0fde147092b98cdd212ff32c96ac5fb110326c6703cbc1e84011675dbb2e7ea8de901f7e5792e1451ce7e3f2aded99f4ccba1c8865fd047a1036ed9d4eb2b1d14387228a204da7d368d6a6bacf5f57669486f3734ef063fffd8ff586fea65deb0a0d55dfef897f50802818f58fe681473f8d58095d9c745ebc8ea7286add896a84b98686ddbb6cb2fb16429df88c257fbeb8cd85db3c538939af864426b3ca15b1e3569da14aa7e08d66c134391b443889b857662821a5970fc4cc71ad99d2a79503c9e1938f19e764b464ef534c098f0fc6f5c44204e9c5b2c5ac7ffcac394003dadd90b9aedee16905ffc2f071aeb792e35dbcfe4a2492902878f590477b4ed99bf6bab9781d36652423c3ede515ff37eb4b6cb571cd530c4297768bdf6858c9495218483a9bf0b5198a57d5a90398490ecce82ca8705c5f0a1744763d50bf2405998cbb7ac32b75b54aff3b5b614a1d797123aa1447235f0dac039990441f3a97d71937cf7c783ad7cbcf2e99d338132b34e17a6cc9eb08e08bff0ef1573fabdcbd888076213741fe497e6139eb84898d030509ffe02821e10906afcdc2655f90338cf3c27f9f61f32dcb8869c54079905a61657a184591ae1870b4ea6a437bd3fd1447a6e78a4f821e519ef9f8d97114804941bd73d63b46bf3b1f9811d9197850bf922609863c219ee8ab911abdff9b6c5fcab68933c058599a17e6d2450e9b2f546ca01c58c207c598d6c94294473ddfdb35d7f089b0c1b1a6c2cd6c1332753b6e9e7d16ed475ecdca4439ea7a563fa86f0729f8718db7c39ecd3307444d9a41d64048788a0d2007b6c5d10458d0f3b0ee7f7b88343ab1553f18542968c16ee8921a5b3e4c2d47938fe15b70f30a9497fb28a9b2f4371382cf587237fc7f99d9a2762a14a06cde0a8034cfab5020d90be6753c81441ab5771e33e2df1077a1f96b6290b9195336e1e3e365d93fa345cb08a9e033465e92d1de2e4dd58b01a141ee2799b35621610a91488ec0cecfd42f348d8106f204143f1c961ce69cfc373be73661f7f3a2ea4bade6d6dc7b7dc5f87147fb50fe0c06d5e092d109eacc3b7211be7a5c31146331d00cb383d9309c921b5b6da53eb10ccf85b75a22e24169287aa05a8327d4d33ec507c0e8190637f5578e73114f6ad3a56d774d60514b8de779b99dcca0a457115c03cafb7a980291184fa7b825ece638314b467b80bc201e46d417e39847579bb040f57f87187676100131a6e2aa5594881991f281e8c86991424afa509b1c80112bb605c100912d353870a40bdbbc5a2c799ccb72004be090bb84d536a5bc79237e768c44790ee7ed13fe68e3b220742678896136e2e1f2b66d98eddb5fde3704df37a66c594c355c377949bd9241766b7e10f8e8bf0c9e4b34538ca9dc6e9a416fba2f72f9b79f9eda73c60693f1cf39dabadc4bcc686f5018498c7a1a2434242b6ece322120bf8e2f24ad17fdb98e3ed23202bf37646004a280fafa0ba0c914364bf64c7df8420cb4c05df111738ff2752f72c8b14f692815e785afc4d3eb85c571d104f342c7cfdbc9252194bd6a4ec4f98a86a0fa74fcee6e86ad1f08e4513e34c33200b4f916adeb254f962a74db1aeb22e184a06af1b405bcd283d36a6d083407d0d6e99a5cae13800490396b034c22260eb39f0ce90c690b80234507a19f30156a424030ab6a129703a2616124e534c8f05f9985bd193162f135df71e992b6ea4ae6800a189a992262ca0c44f340719eb204b374242106cae17e35a6c839d65815d2ddd8dc62877917f7b57605f2bd86313a49ed7b888d6091688e8102f8639e16d8b5ecf62accb362eaefb0f28c4bf34b3b6ca1fcebbf979eda68bbcac8fc8fbba329000587eee0d55a79a15b509af09973e05d366a0d36b17abbf1010afb732ba526ec0e89ca917e660e15f0be8bd7bc7dd6943c4704d7fe219c2d6a7d4514f693d51bcb863de078f4218854f9231c6efcaf510a1d4bb69c6caf6dc6a0bbb2045cb0830514af4add7abbef9816cfd4104620201af9861c3f6aa90c51841b0302acf3dff64de08c68fa3f13c97e26178cc96643a7012f82f4a48bab69fa4514b7d94ee497e9c444159dd308896f496b2c90c6347c8929b1dda1ceef60c0171a4112698542fb32e790e5cc5ee9043a400f9fa515e0415046d23a9d0c6b238c1726e22e9047f35bbf2f0beed1b1b50b9668af3bcf2f1155894e4079648dfcaca3cb46f56fa5b2e6df63a4a5e0c86001e47be40fc8565212c1d5450c63fa8a23b00493309407430ceca0201041f5fcad8d0959ca8154ae1fc44b00fc17b02c99fd0ce9f7e62be844dc67f1a60acbb5a493e3dcc1d420f8b4a33e896409aa1b90397da6b1c41bb81c33351ef2e69d7f7397afec9749af0640dbe138f7aa773e9322ee03603033a7da58509743687155692a9816c0154fe92307d1ad3b18c3a6a204f8272bf7cb6f09d12800094bfaff9cc995006c6309be6ddfcefda8c2acd28e825048d66d69fc7234725bbc3824c1e03ed84d312db2cb151e75ac96a6d0587d954a2d3dd574f1161ee998331769a0bacc5e9ca1f92ff5a5a9a3bc96ac7657177da76d1d6f06817a82498cdbcf103283a04f21e24be4f36f8980d38f41027e3d171cb78b1c9ea1c057ed68fc584679988a059db5c91dd4f990e0a3a0f891f040f19fd0ae02b4928b5a2a550120efc44ceddc22250e03ebf51dbaf5095c77ecd8cd261e8f8631739b89675c180b5681713269c546165a5f399f68ed2b54c08b410f8ce063d3ae40634cfacc5293b54e0a30b2675955da3a509fb10a75b7d8cc8beb722a2e2050bb42964ab1472885853bdf74e6c43c2dfe3643fa2778bc10db22ff5839e698c5b1bd0c535cd06339e518f815f8c03f179cdc09076ba78bab04c45e51bc4858e47541cf7be7af6b39a9c4c74019b11b94adc6166c58eae1e1fa4d85075a46fe258fde77a50748a0c97b111d0cce6e20d9b9b23d18b18f8a7d1ec6493d2a07cb0db67ee0657a5c8449b6a113a7a5da7bbac0f8b53bf3f721238925ab9e7529072038bc4b5d5a5626cb0020184834500879ad577a1b259ef96f0b919c889bf14afcd746c4684493dcfb742f300fdf0b77fc8043aa18920af52581dd4f08cd340b7b69a660ff93fed123b0b535cd8970d4bcda59043fe0b907594806ad854418cbb1af88e5bdef4eb05b80e24cd1504da2f2c24e0c2e1dae6c65f721f2de9a98169b295d3bdf30f1899b8e056683be311bb356ed9d60d51e9bb3fda5658d0ac05f5154f81df269d7e639d1f03471976b7f5edc9b424c57fb12560584126bddb877a7d00bb430a9f69262b286f6ac033edb7ed08e69a40f9c170f244516b892122219451cd2a80cc704b20ea926f5644b1340c83252abbbe3c200f73e2fed5ad411c28553294fd5a4ca0b50dcd9f66c4df59a7cd9eeed084cabd5a5c62c9302d8677bbe53763d5714a231e6adb2a0eee30972d109f971b8d496cd57b89616e9327b5c33f19d10cf44678d00c44be80304a5c424f776cd3ad542f2f261603330562bb057b30a554e8b395126758c687d413f5102354823e397ca442024f3d3666e461f5acaa4815e3b8e67f36af39f8876da6681d0815626df3f4d8b210d558494a7938a24b4733d9c81c89a744f224442b4db456bc059f680ddcfa8d9b39b4cab87612ae32c5fed6f8f9f1a7bd01e85a7ccccd52f430a360ba8418890eaf61f44d6125c56eef00a3238a6fefed073d7786b233572666e85edcc9f9b1248ca3aa664faf6e2b4e0b6956bde34c715d49aefac43c4b53f8cb885d8f29bc12e69b9b17eeb34407bad972d5faa05ed12562ff23c010fc01ea2e243f540cb0206b0decdcc714e2685b8fad1b0c23744951fb0218f13c7a4b3a1b119a1ed547f241d4a8f6e3b680251771ccb51c14ef003f01f93ffbeb07155c9deeae955d3dfbaf253e49797c4b4e4d7d85db260544d7f25ae64166a16d531d2becd91d6627fadf75df7b8c13e06a65a1f6f1d5fdd8d68928e688af4fc945c9f0b8a1449c9b418b7b9809f406dcbff6bff5d9a38582f9def06c8fd20e5a249c93c8a6931cfd60111fa2e2f02988691c39b1ba0a5d70c25d446652c72b853b69142382ddb97ce5aaf132ec51c175d3e0769c0d18bf2fdb6016c40cb7bfb2359da795b9f0e498ed6ce1ab8bf7ac72adca265db3a796e94bac410e5f780fa9a634ad0ea67a179cba32951c8a22e17e405deceda49c45ae8c635af94dc9aca23217fb85ac807186e248128ef72fd254c896296efd53941af714437596bf76adce7a61f85eb37c74c3adab7701aa863a46a4ad50ab10c17b3928056b02cb74523d81091f50749134886aa023e4885606992a6706ed202eedfa189f2545330f16f83f5347ad71f90f3386a26cc688d0c7af442c4a415bb7684ac30971a0eb7fd66537d2439e09b2a3d2ac57b21a385eeeeb3e2346d2de355128b744213b352ac8c6555e5738fc370ca2e66aa13e432cfcad9cbd914a445904b71fa4d59f8a1552006ce6b5ea77cb4cd90bb4ae2bafac0db0dd5f91f0652414af47fa43af</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>光伏小知识</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>常见数据库分类</title>
    <link href="/%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E7%B1%BB/"/>
    <url>/%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="1-数据库分类"><a href="#1-数据库分类" class="headerlink" title="1. 数据库分类"></a>1. 数据库分类</h2><h3 id="1-1-按数据模型分类"><a href="#1-1-按数据模型分类" class="headerlink" title="1.1. 按数据模型分类"></a>1.1. <strong>按数据模型分类</strong></h3><table><thead><tr><th><strong>分类</strong></th><th><strong>说明</strong></th><th><strong>典型代表</strong></th></tr></thead><tbody><tr><td><strong>关系型数据库</strong></td><td>基于关系模型，数据以表格形式存储，支持 SQL 查询语言。</td><td>MySQL、PostgreSQL、Oracle、SQL Server</td></tr><tr><td><strong>NoSQL 数据库（非关系型）</strong></td><td>非关系型数据库，不依赖固定表结构，支持灵活的数据模型。</td><td>MongoDB、Redis、Neo4j、InfluxDB、Elasticsearch、ClickHouse</td></tr></tbody></table><h3 id="1-2-按存储方式分类"><a href="#1-2-按存储方式分类" class="headerlink" title="1.2. 按存储方式分类"></a>1.2. <strong>按存储方式分类</strong></h3><table><thead><tr><th><strong>分类</strong></th><th><strong>说明</strong></th><th><strong>特点</strong></th></tr></thead><tbody><tr><td><strong>行存储</strong></td><td>数据按行存储，适合事务处理和点查询。</td><td>MySQL、PostgreSQL。</td></tr><tr><td><strong>列存储</strong></td><td>数据按列存储，适合分析型查询和批量处理。</td><td>ClickHouse、</td></tr><tr><td><strong>键值存储</strong></td><td>数据以键值对形式存储，支持高速读写。</td><td>Redis、Memcached。</td></tr><tr><td><strong>文档存储</strong></td><td>数据以文档形式存储（如 JSON），支持嵌套数据结构。</td><td>MongoDB。</td></tr></tbody></table><h3 id="1-3-按开源与商业分类"><a href="#1-3-按开源与商业分类" class="headerlink" title="1.3. 按开源与商业分类"></a>1.3. <strong>按开源与商业分类</strong></h3><table><thead><tr><th><strong>分类</strong></th><th><strong>说明</strong></th><th><strong>代表</strong></th></tr></thead><tbody><tr><td><strong>开源数据库</strong></td><td>代码公开，社区驱动，免费使用。</td><td>MySQL、PostgreSQL、MongoDB</td></tr><tr><td><strong>商业数据库</strong></td><td>由公司开发，提供技术支持和高级功能，需付费。</td><td>Oracle、SQL Server、SAP HANA。</td></tr></tbody></table><h2 id="2-数据库对比"><a href="#2-数据库对比" class="headerlink" title="2. 数据库对比"></a>2. 数据库对比</h2><h3 id="2-1-关系型数据库对比"><a href="#2-1-关系型数据库对比" class="headerlink" title="2.1. 关系型数据库对比"></a>2.1. <strong>关系型数据库对比</strong></h3><p>MySQL <strong>vs</strong> PostgreSQL  <strong>vs</strong> Oracle  <strong>vs</strong> SQL Server</p><table><thead><tr><th><strong>数据库</strong></th><th><strong>设计目的</strong></th><th><strong>使用场景</strong></th><th><strong>开源 vs 商业</strong></th></tr></thead><tbody><tr><td>MySQL</td><td>面向 Web 应用和中小型项目，适合轻量级、高性能需求的场景</td><td>Web应用、电子商务、内容管理系统（CMS）、数据分析、日志处理等</td><td>开源，由 Oracle 公司维护</td></tr><tr><td>PostgreSQL</td><td>适合复杂查询、数据完整性和扩展性需求。支持复杂数据类型（如 JSON、数组、几何类型）</td><td>复杂查询、数据仓库、地理信息系统（GIS）、金融应用、科学研究等</td><td>开源，完全免费，无商业限制</td></tr><tr><td>Oracle</td><td>面向大型企业，提供全面的数据库解决方案。</td><td>企业资源规划（ERP）、客户关系管理（CRM）、银行系统、电信系统、政府机构等</td><td>商业闭源 RDBMS，由 Oracle 公司开发</td></tr><tr><td>SQL Server</td><td>面向 Windows 企业用户，提供与微软生态的深度集成。</td><td>企业级应用、商业智能（BI）、数据仓库、报表生成、与Microsoft Office的集成等</td><td>商业闭源 RDBMS，由微软开发。</td></tr></tbody></table><h3 id="2-2-非关系型数据库对比"><a href="#2-2-非关系型数据库对比" class="headerlink" title="2.2. 非关系型数据库对比"></a>2.2. <strong>非关系型数据库对比</strong></h3><p>MongoDB <strong>vs</strong> Redis <strong>vs</strong> Neo4j <strong>vs</strong> InfluxDB <strong>vs</strong> Elasticsearch <strong>vs</strong> ClickHouse</p><table><thead><tr><th><strong>数据库</strong></th><th><strong>定义</strong></th><th><strong>设计目的</strong></th><th><strong>使用场景</strong></th></tr></thead><tbody><tr><td><strong>MongoDB</strong></td><td>分布式文档数据库</td><td>基于 BSON 格式存储，提供灵活的文档模型</td><td>金数据的表单和数据结构用户配置文件存储</td></tr><tr><td><strong>Redis</strong></td><td>内存键值对数据库</td><td>基于内存存储，提供超高性能</td><td>缓存、会话存储、实时排行榜、计数器、分布式锁等。</td></tr><tr><td><strong>Neo4j</strong></td><td>图形数据库</td><td>基于<strong>图形数据结构，</strong>处理复杂的关系网络数据</td><td>社交网络分析、物联网设备关系管理等。</td></tr><tr><td><strong>InfluxDB</strong></td><td>时序数据库</td><td>专为<strong>时间序列数据</strong>设计</td><td>监控系统（CPU、内存使用情况）采集设备数据：主轴转速、倍率</td></tr><tr><td><strong>Elasticsearch</strong></td><td>分布式全文搜索引擎和分析引擎</td><td>基于<strong>倒排索引</strong>，支持实时全文搜索和复杂聚合查询</td><td>日志分析、百度搜索。</td></tr><tr><td><strong>ClickHouse</strong></td><td>列式存储数据库</td><td>基于<strong>列式存储</strong>，支持大规模数据的高效查询和分析</td><td>实时数据分析、大数据分析等。金数据表单数据平均值，最值计算</td></tr></tbody></table><h2 id="3-常见数据库介绍"><a href="#3-常见数据库介绍" class="headerlink" title="3. 常见数据库介绍"></a>3. 常见数据库介绍</h2><h3 id="3-1-MongoDB"><a href="#3-1-MongoDB" class="headerlink" title="3.1 MongoDB"></a>3.1 MongoDB</h3><h4 id="1-原理"><a href="#1-原理" class="headerlink" title="1. 原理"></a>1. <strong>原理</strong></h4><ul><li><strong>基于 BSON 格式的文档存储</strong>：数据以二进制 JSON（BSON）格式存储，支持动态模式，无需预定义结构。</li><li><strong>分布式架构</strong>：通过分片（Sharding）和副本集（Replica Set）实现数据水平扩展和高可用性。</li><li><strong>查询语言</strong>：提供类 SQL 的查询能力（MongoDB Query Language, MQL），支持复杂查询和聚合操作。</li></ul><h4 id="2-核心概念"><a href="#2-核心概念" class="headerlink" title="2. 核心概念"></a>2. <strong>核心概念</strong></h4><ul><li><strong>数据库（Database）</strong>：MongoDB 的逻辑容器，类似于关系型数据库中的数据库。</li><li><strong>集合（Collection）</strong>：类似于关系型数据库中的表，存储一组文档。</li><li><strong>文档（Document）</strong>：MongoDB 的基本数据单元，以 BSON 格式存储，支持嵌套结构。</li><li><strong>字段（Field）</strong>：文档中的键值对，类似于关系型数据库中的列。</li></ul><h4 id="3-设计目的"><a href="#3-设计目的" class="headerlink" title="3. 设计目的"></a>3. <strong>设计目的</strong></h4><ul><li>提供灵活的文档模型，适应快速变化的业务需求。</li><li>支持高并发读写，适用于内容管理系统、物联网数据存储等场景。</li></ul><h4 id="4-使用场景"><a href="#4-使用场景" class="headerlink" title="4. 使用场景"></a>4. <strong>使用场景</strong></h4><ul><li>内容管理系统（CMS）</li><li>物联网（IoT）时序数据存储</li><li>产品目录管理</li><li>用户配置文件存储</li></ul><hr><h3 id="3-2-Redis"><a href="#3-2-Redis" class="headerlink" title="3.2 Redis"></a>3.2 Redis</h3><h4 id="1-原理-1"><a href="#1-原理-1" class="headerlink" title="1. 原理"></a>1. <strong>原理</strong></h4><ul><li><strong>基于内存存储</strong>：数据存储在内存中，提供超高性能的读写能力。</li><li><strong>支持多种数据结构</strong>：包括字符串、列表、哈希、集合、有序集合等。</li><li><strong>持久化机制</strong>：支持 RDB（快照）和 AOF（追加日志）两种持久化方式。</li></ul><h4 id="2-核心概念-1"><a href="#2-核心概念-1" class="headerlink" title="2. 核心概念"></a>2. <strong>核心概念</strong></h4><ul><li><p><strong>键值对（Key-Value Pair）</strong>：Redis 的基本存储单元，键为字符串，值可以是多种数据结构。</p></li><li><p><strong>数据结构</strong>：</p></li><li><ul><li><strong>字符串（String）</strong>：简单的键值对。</li><li><strong>列表（List）</strong>：有序的字符串集合。</li><li><strong>哈希（Hash）</strong>：键值对的集合。</li><li><strong>集合（Set）</strong>：无序的字符串集合。</li><li><strong>有序集合（Sorted Set）</strong>：带分数的集合，按分数排序。</li></ul></li></ul><h4 id="3-设计目的-1"><a href="#3-设计目的-1" class="headerlink" title="3. 设计目的"></a>3. <strong>设计目的</strong></h4><ul><li>提供超高性能的内存数据结构服务器，适用于需要快速读写操作的场景。</li><li>支持持久化，确保数据不会因服务器重启而丢失。</li></ul><h4 id="4-使用场景-1"><a href="#4-使用场景-1" class="headerlink" title="4. 使用场景"></a>4. <strong>使用场景</strong></h4><ul><li>缓存</li><li>会话存储</li><li>实时排行榜</li><li>计数器</li><li>分布式锁</li><li>消息队列</li></ul><h3 id="3-3-Neo4j"><a href="#3-3-Neo4j" class="headerlink" title="3. 3 Neo4j"></a>3. 3 Neo4j</h3><h4 id="1-原理-2"><a href="#1-原理-2" class="headerlink" title="1. 原理"></a>1. <strong>原理</strong></h4><ul><li><strong>基于图形数据结构</strong>：节点表示实体，边表示实体之间的关系。</li><li><strong>属性图模型</strong>：节点和边都可以有属性，属性以键值对的形式存储。</li><li><strong>Cypher 查询语言</strong>：专为图形数据设计的查询语言，支持复杂的图形查询。</li></ul><h4 id="2-核心概念-2"><a href="#2-核心概念-2" class="headerlink" title="2. 核心概念"></a>2. <strong>核心概念</strong></h4><ul><li><strong>节点（Node）</strong>：表示实体，如用户、产品等。</li><li><strong>关系（Relationship）</strong>：表示实体之间的关系，如朋友关系、购买关系等。</li><li><strong>属性（Property）</strong>：节点和边都可以有属性，如用户的年龄、产品的价格等。</li><li><strong>标签（Label）</strong>：用于分类节点，如用户节点可以有“管理员”标签。</li></ul><h4 id="3-设计目的-2"><a href="#3-设计目的-2" class="headerlink" title="3. 设计目的"></a>3. <strong>设计目的</strong></h4><ul><li>处理复杂的关系网络数据，提供高效的图形查询和分析能力。</li><li>支持实时推荐和社交网络分析。</li></ul><h4 id="4-使用场景-2"><a href="#4-使用场景-2" class="headerlink" title="4. 使用场景"></a>4. <strong>使用场景</strong></h4><ul><li>社交网络分析</li><li>推荐系统</li><li>金融风险管理</li><li>生物信息学（基因、蛋白质关系分析）</li></ul><hr><h3 id="3-4-InfluxDB"><a href="#3-4-InfluxDB" class="headerlink" title="3.4  InfluxDB"></a>3.4  InfluxDB</h3><h4 id="1-原理-3"><a href="#1-原理-3" class="headerlink" title="1. 原理"></a>1. <strong>原理</strong></h4><ul><li><strong>专为时间序列数据设计</strong>：数据按时间戳组织，支持高写入和低查询延迟。</li><li><strong>分布式架构</strong>：通过分片和副本集实现数据水平扩展和高可用性。</li><li><strong>查询语言</strong>：支持类似 SQL 的查询语法（InfluxQL），提供强大的时间序列数据分析能力。</li></ul><h4 id="2-核心概念-3"><a href="#2-核心概念-3" class="headerlink" title="2. 核心概念"></a>2. <strong>核心概念</strong></h4><ul><li><strong>Measurement（测量值）</strong>：类似于关系型数据库中的表，存储一组相关的数据点。</li><li><strong>Tag（标签）</strong>：用于索引的键值对，通常表示静态或低基数的属性。</li><li><strong>Field（字段）</strong>：存储实际数据的键值对，通常表示动态或高基数的属性。</li><li><strong>Series（序列）</strong>：由 Measurement、Tag Set 和 Timestamp 唯一确定的一组数据。</li><li><strong>Point（数据点）</strong>：Series 中的一个单独数据记录，包含时间戳和字段值。</li></ul><h4 id="3-设计目的-3"><a href="#3-设计目的-3" class="headerlink" title="3. 设计目的"></a>3. <strong>设计目的</strong></h4><ul><li>高效存储和查询时间序列数据，适用于监控和日志分析场景。</li><li>支持实时数据写入和历史数据查询。</li></ul><h4 id="4-使用场景-3"><a href="#4-使用场景-3" class="headerlink" title="4. 使用场景"></a>4. <strong>使用场景</strong></h4><ul><li>监控系统（如 CPU、内存使用情况）</li><li>物联网设备数据</li><li>应用性能监控（APM）</li><li>日志数据存储与分析</li></ul><hr><h3 id="3-5-Elasticsearch"><a href="#3-5-Elasticsearch" class="headerlink" title="3.5 Elasticsearch"></a>3.5 Elasticsearch</h3><h4 id="1-原理-4"><a href="#1-原理-4" class="headerlink" title="1. 原理"></a>1. <strong>原理</strong></h4><ul><li><strong>基于倒排索引</strong>：数据以 JSON 格式存储，通过倒排索引加速搜索。</li><li><strong>分布式架构</strong>：通过分片和副本集实现数据水平扩展和高可用性。</li><li><strong>查询语言</strong>：支持强大的 DSL（Domain Specific Language）查询语法，提供复杂的全文搜索和聚合分析能力。</li></ul><h4 id="2-核心概念-4"><a href="#2-核心概念-4" class="headerlink" title="2. 核心概念"></a>2. <strong>核心概念</strong></h4><ul><li><strong>索引（Index）</strong>：逻辑容器，存储一组相关的文档。</li><li><strong>文档（Document）</strong>：存储的基本单元，以 JSON 格式存储。</li><li><strong>映射（Mapping）</strong>：定义字段类型，类似于关系型数据库中的表结构。</li><li><strong>倒排索引（Inverted Index）</strong>：加速搜索的关键数据结构，将词映射到包含该词的文档。</li></ul><h4 id="3-设计目的-4"><a href="#3-设计目的-4" class="headerlink" title="3. 设计目的"></a>3. <strong>设计目的</strong></h4><ul><li>提供分布式全文搜索和分析能力，适用于大规模数据检索和分析。</li><li>支持实时数据索引和查询。</li></ul><h4 id="4-使用场景-4"><a href="#4-使用场景-4" class="headerlink" title="4. 使用场景"></a>4. <strong>使用场景</strong></h4><ul><li>日志分析</li><li>安全信息和事件管理（SIEM）</li><li>应用搜索</li><li>电子商务搜索</li></ul><hr><h3 id="3-6-ClickHouse"><a href="#3-6-ClickHouse" class="headerlink" title="3.6 ClickHouse"></a>3.6 ClickHouse</h3><h4 id="1-原理-5"><a href="#1-原理-5" class="headerlink" title="1. 原理"></a>1. <strong>原理</strong></h4><ul><li><strong>基于列式存储</strong>：数据按列存储，支持高效压缩和并行处理。</li><li><strong>MergeTree 引擎</strong>：支持分区、排序键和压缩算法，优化查询性能。</li><li><strong>查询语言</strong>：支持类似 SQL 的查询语法，提供强大的数据分析能力。</li></ul><h4 id="2-核心概念-5"><a href="#2-核心概念-5" class="headerlink" title="2. 核心概念"></a>2. <strong>核心概念</strong></h4><ul><li><strong>列式存储</strong>：数据按列存储，减少磁盘 I&#x2F;O，提高查询性能。</li><li><strong>MergeTree 引擎</strong>：ClickHouse 的核心存储引擎，支持分区、排序键和压缩算法。</li><li><strong>分区（Partition）</strong>：将数据按时间或其他维度分区，提高查询效率。</li><li><strong>排序键（Ordering Key）</strong>：定义数据在列中的排序方式，影响查询性能。</li><li><strong>压缩算法</strong>：支持多种压缩算法，减少存储空间。</li></ul><h4 id="3-设计目的-5"><a href="#3-设计目的-5" class="headerlink" title="3. 设计目的"></a>3. <strong>设计目的</strong></h4><ul><li>提供高性能的 OLAP 查询能力，适用于实时数据分析场景。</li><li>支持大规模数据的高效查询和分析。</li></ul><h4 id="4-使用场景-5"><a href="#4-使用场景-5" class="headerlink" title="4. 使用场景"></a>4. <strong>使用场景</strong></h4><ul><li>实时数据分析</li><li>大数据分析</li><li>数据仓库</li><li>商业智能（BI）</li><li>用户行为分析</li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>分布式限流</title>
    <link href="/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/"/>
    <url>/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h1 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h1><p>分布式区别于单机限流的场景,它把整个分布式环境中所有服务当做一个整体来考量。比如说针对IP的限流,我们限制了1个IP每秒最多10个访问,不管来自这个IP的请求落在了哪台机器上,只要是访问了集群中的服务节点,那么都都会受到限流规则的制约。</p><p>从上面的例子不难看出,我们必须将限流信息保存在一个”中心化的组件上,这样它就可以获取到集群中所有机器的访问状态,目前前有两个比较主流的限流方案:</p><ul><li>网关层限流将限流规则应用在所有流量的入口处</li><li>中间件限流 将限流信息存储在分布式环境中某个中间件里(比如Redis缓存),每个组件都可以从这里获取到当前时刻的流量统试,从而决定是拒绝服务还是放行流量</li></ul><h1 id="2-常见的限流规则"><a href="#2-常见的限流规则" class="headerlink" title="2. 常见的限流规则"></a>2. 常见的限流规则</h1><ol><li><p>QPS和连接数控制</p><ul><li>针对连接数和QPS(querypersecond)限流来说, 我们可以设定IP维度的限流, 也可以设置基于单个服务器的限流。</li><li>在真实环境中通常会设置多个维度的限流规则, 比如设定同一个IP每秒访问频率小于10, 连接数小于5,再设定每台机器QPS最高1000,连接数最大保持200。更进一步,我们可以把某个服务器组或整个机房的服务器当做一个整体, 设置更hign-level的限流规则, 这些所有限流规则都会共同作用于洗量控制。</li></ul></li><li><p>传输速率</p><ul><li>对于”传输速率”大家都不会陌生, 比如资源的下载速度。有的网站在这方面的限流逻辑做的更细致,比如普通注册用户下载速度为100k&#x2F;s,购买会员后是10M&#x2F;S, 这背后就是基于用户组或者用户标签的限流逻辑。</li></ul></li><li><p>黑白名单</p><ul><li><p>黑白名单是各个大型企业应用里很常见的限流和放行手段, 而且黑白名单往往是动态变化的。举个例子,如果某个IP在一段时间的的访问次数过于频繁,被系统识别为机器人用户或流量攻击,那么这个IP就会被加入到黑名单,从而限制其对系统资源的访问,这就是我们俗称的”封IP”。</p><blockquote><p>我们平时见到的爬虫程序,比如说爬知乎上的美女图片,或者爬券商系统的股票分时信息,这类爬虫程序都必须实现更换IP的功能,以防被加入黑名单。有时我们还会发现公司的网络无法访问12306这类大型公共网站, 这也是因为了某些公司的出网IP是同一个地址, 因此在访问量过高的情况下,这个IP地址就被对方系统识别,进而被添加到了黑名单。使用家庭宽带的同学们应该知道,大部分网络运营商都会将用户分配到不同出网IP段,或者时不时动态更换用户的IP地址。</p></blockquote></li><li><p>白名单就更好理解了,相当于御赐金牌在身,可以自由穿梭在各种限流规则里,畅行无阻。比如某些电商公司会将超大卖家的账号加入白名单,因为这类卖家往往有自己的一套运维系统,需要对接公司的IT系统做大量的商品发布、补货等等操作。</p></li></ul></li></ol><blockquote><p>同学们肯定发现了这样一种情况,在春运抢票的时候,当你面对这么一堆验证码图片,不管你怎么选,即使你用毕生所学学选出了正确答案,提交后依然都会被告知你选 错了。要么就是让你面对一堆鬼都看不出是什么东西的图片。不要不疑自己的智商,其实,这就是网站的一种别样的限流措施。在拷问河用户智商的同时,通过这种”故 意”刁难的手段,光明正大地限制访问流量,从而大幅降低系统的访问压力,真不得不敬佩产品经理的智(良)慧(心)。</p></blockquote><h1 id="3-限流实现方案"><a href="#3-限流实现方案" class="headerlink" title="3. 限流实现方案"></a>3. 限流实现方案</h1><h2 id="1-guava-RateLimiter-客户端限流"><a href="#1-guava-RateLimiter-客户端限流" class="headerlink" title="1. guava RateLimiter 客户端限流"></a>1. guava RateLimiter 客户端限流</h2><h3 id="1-定义-1"><a href="#1-定义-1" class="headerlink" title="1. 定义"></a>1. 定义</h3><p>Guava 的 <code>RateLimiter</code> 是一个轻量级的客户端限流工具，适用于单机环境下的流量控制。它基于令牌桶算法实现，能够平滑地限制请求速率。</p><p><strong>核心特性：</strong></p><ul><li>支持固定的生成速率（QPS）。</li><li>支持突发请求（允许短时间内超出速率限制）。</li><li>非阻塞式和阻塞式两种获取令牌的方式。</li></ul><h3 id="2-原理"><a href="#2-原理" class="headerlink" title="2. 原理"></a>2. 原理</h3><p><strong>令牌桶算法</strong>：系统以固定速率生成令牌，每个请求需要消耗一个令牌。如果没有足够的令牌，则请求被阻塞或拒绝。</p><h3 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h3><ol><li>引入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>18.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>代码实战</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Controller</span> </span>&#123;<br>  RateLimiter limiter = RateLimiter.create(<span class="hljs-number">2.0</span>);<br>  <br>  <span class="hljs-comment">//场景一：非阻塞限流</span><br>  <span class="hljs-meta">@GetMapping(&quot;/tryAcquire&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">tryAcquire</span><span class="hljs-params">(Integer count)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(limiter.tryAcquire(count))&#123; <span class="hljs-comment">// count:一次占用几个令牌</span><br>      log.info(<span class="hljs-string">&quot;success, rate is &#123;&#125;&quot;</span>, limiter.getRate());<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      log.info(<span class="hljs-string">&quot;fail, rate is &#123;&#125;&quot;</span>, limiter.getRate());<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//场景二：限定时间的非阻塞限流, 如：看在指定时间内，能否满足我的调用请求</span><br>  <span class="hljs-meta">@GetMapping(&quot;/tryAcquireWithTimeout&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">tryAcquireWithTimeout</span><span class="hljs-params">(Integer countInteger timeout)</span></span>&#123;<br>    <span class="hljs-keyword">if</span> (limiter.tryAcquire(count, timeout, TimeUnit.SSECONDS))<br>      log.info(<span class="hljs-string">&quot;success, rate is &#123;&#125;&quot;</span>, limiter.getRate())<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      log.info(<span class="hljs-string">&quot;fail, rate is &#123;&#125;&quot;</span>, limiter.getRate());<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>    &#125;<br>  &#125;<br><br><br>  <span class="hljs-comment">//场景三：同步阻塞限流。能获取就获取，获取不到就阻塞</span><br>  <span class="hljs-meta">@GetMapping(&quot;/acquire&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">acquire</span><span class="hljs-params">(Integer count)</span> </span>&#123;<br>    limiter.acquire(count);<br>    log.info(<span class="hljs-string">&quot;success, rate is &#123;&#125;&quot;</span>, limiter.getRate());<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>  &#125;                                  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-基于Nginx限流"><a href="#2-基于Nginx限流" class="headerlink" title="2. 基于Nginx限流"></a>2. 基于Nginx限流</h2><h3 id="1-配置单机限流（类似IP限流）"><a href="#1-配置单机限流（类似IP限流）" class="headerlink" title="1. 配置单机限流（类似IP限流）"></a>1. 配置单机限流（类似IP限流）</h3><p>Nginx 提供了内置的限流模块，可以在网关层实现分布式限流。</p><h4 id="1-优点"><a href="#1-优点" class="headerlink" title="1. 优点"></a>1. 优点</h4><ul><li>简单高效，适合网关层限流。</li><li>不需要修改后端业务代码。</li></ul><h4 id="2-实现步骤"><a href="#2-实现步骤" class="headerlink" title="2. 实现步骤"></a>2. 实现步骤</h4><ol><li>修改nginx.conf</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml">limit_req_zone $binary_remote_addr zone=iplimit:20m rate=1r/s;<br><br>server &#123;<br>    server_name www.imooc-training.com;<br>    location /access-limit/ &#123;<br>        proxy_pass http://127.0.0.1:10086/;<br>        limit_req zone=iplimit burst=2 nodelay;<br>        limit_req_status 504;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>limit_req_zone $binary_remote_addr zone&#x3D;iplimit:20m rate&#x3D;1r&#x2F;s;</p><ul><li><p>$binary_remote_addr :  binary_目的是缩写内存占用,remote_addr表示通过IP地址来限流</p></li><li><p>zone&#x3D;iplimit:20m:   iplimit是一块内存区域(记录访问频率信息),20m是指这块内有存区域的大小为20Mb</p></li><li><p>rate&#x3D;1r&#x2F;s.:  比如100r&#x2F;m,标识访问的限流频率</p></li></ul></li><li><p>limit_req zone&#x3D;iplimit burst&#x3D;2 nodelay;</p><ul><li>zone&#x3D;iplimit:  引用limit_req_zone中的zone变量</li><li>burst&#x3D;2,设置一个大小为2的缓冲区域,当大量请求到来。请求数量超过限流频率时,将其放入缓冲区域</li><li>nodelay&#x3D;&gt;缓冲区满了以后,直接返回503异常</li></ul></li><li><p>limit_req_status 504</p><ul><li>异常情况,返回504(默认是503)</li></ul></li></ul><ol start="2"><li>测试controller</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/nginx&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">nginx</span><span class="hljs-params">()</span></span>&#123;<br>  log.info(<span class="hljs-string">&quot;Nginx success&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-基于服务器级别限流"><a href="#2-基于服务器级别限流" class="headerlink" title="2. 基于服务器级别限流"></a>2. 基于服务器级别限流</h3><p>不管什么IP加在一起不能超过某个值，通常情况下,server级别的限流速率是最大的。</p><h4 id="1-实现步骤"><a href="#1-实现步骤" class="headerlink" title="1. 实现步骤"></a>1. 实现步骤</h4><ol><li>改niginx.conf</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">limit_req_zone <span class="hljs-variable">$server_name</span> <span class="hljs-attribute">zone</span>=serverlimit:10m <span class="hljs-attribute">rate</span>=1r/s;<br>limit_req <span class="hljs-attribute">zone</span>=serverlimit <span class="hljs-attribute">burst</span>=1 nodeelay;<br></code></pre></td></tr></table></figure><h3 id="3-基于连接数"><a href="#3-基于连接数" class="headerlink" title="3. 基于连接数"></a>3. 基于连接数</h3><p>当前active的连接数</p><h4 id="1-实现步骤-1"><a href="#1-实现步骤-1" class="headerlink" title="1. 实现步骤"></a>1. 实现步骤</h4><ol><li>改niginx.conf</li></ol><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#每个server最多保持100个连接</span><br><span class="hljs-attribute">limit_conn</span> perserver <span class="hljs-number">100</span>;<br><br><span class="hljs-attribute">limit_conn_zone</span> $binary_remote_addr zone=perip:<span class="hljs-number">20</span>m;<br><span class="hljs-comment">#每个IP地址最多保持1个连接</span><br><span class="hljs-attribute">limit_conn</span> perip <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><ol start="2"><li>测试</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/nginx-conn&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">nginxConn</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = &quot;0&quot;)</span> <span class="hljs-keyword">int</span> secs)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Thread.sleep( millis: <span class="hljs-number">1000</span> * secs);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-redis-Lua"><a href="#3-redis-Lua" class="headerlink" title="3. redis+Lua"></a>3. redis+Lua</h2><h3 id="1-定义-2"><a href="#1-定义-2" class="headerlink" title="1. 定义"></a>1. 定义</h3><p>利用Redis原子操作，通过Lua脚本实现令牌生成与获取，避免并发问题。</p><h3 id="2-实现步骤-1"><a href="#2-实现步骤-1" class="headerlink" title="2. 实现步骤"></a>2. 实现步骤</h3><ol><li>编写Lua限流脚本</li></ol><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 获取方法签名特征</span><br><span class="hljs-keyword">local</span> methodKey = KEYS[<span class="hljs-number">1</span>]<br>redis.<span class="hljs-built_in">log</span>(redis.LOG_DEBUG, <span class="hljs-string">&#x27;key is&#x27;</span>, methodKey)<br><br><span class="hljs-comment">-- 调用脚本传入的限流大小</span><br><span class="hljs-keyword">local</span> limit = <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">1</span>])<br><br><span class="hljs-comment">-- 获取当前流量大小</span><br><span class="hljs-keyword">local</span> count = <span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, methodKey) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;0&quot;</span>)<br><br><span class="hljs-comment">-- 是否超出限流阈值</span><br><span class="hljs-keyword">if</span> count + <span class="hljs-number">1</span> &gt; limit <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 拒绝服务访问</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">-- 没有超过阈值</span><br>    <span class="hljs-comment">-- 设置当前访问的数量+1</span><br>    redis.call(<span class="hljs-string">&quot;INCRBY&quot;</span>, methodKey, <span class="hljs-number">1</span>)<br>    <span class="hljs-comment">-- 设置过期时间</span><br>    redis.call(<span class="hljs-string">&quot;EXPIRE&quot;</span>, methodKey, <span class="hljs-number">1</span>)<br>    <span class="hljs-comment">-- 放行</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><ol start="2"><li>Java 集成Lua和Redis</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis&lt;/artifactId<br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop&lt;/artifactId<br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.imooc.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by 半仙.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisConfiguration</span> </span>&#123;<br><br>    <span class="hljs-comment">// 如果本地也配置了StringRedisTemplate，可能会产生冲突</span><br>    <span class="hljs-comment">// 可以指定@Primary，或者指定加载特定的@Qualifier</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">            RedisConnectionFactory factory)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StringRedisTemplate(factory);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DefaultRedisScript <span class="hljs-title">loadRedisScript</span><span class="hljs-params">()</span> </span>&#123;<br>        DefaultRedisScript redisScript = <span class="hljs-keyword">new</span> DefaultRedisScript();<br>        redisScript.setLocation(<span class="hljs-keyword">new</span> ClassPathResource(<span class="hljs-string">&quot;ratelimiter.lua&quot;</span>));<br>        redisScript.setResultType(java.lang.Boolean.class);<br>        <span class="hljs-keyword">return</span> redisScript;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.imooc.springcloud.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by 半仙.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AccessLimiter &#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">limit</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-function">String <span class="hljs-title">methodKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> &quot;&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.imooc.springcloud.annotation;<br><br><span class="hljs-keyword">import</span> com.google.common.collect.Lists;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Before;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.RedisScript;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by 半仙.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessLimiterAspect</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisScript&lt;Boolean&gt; rateLimitLua;<br><br>    <span class="hljs-meta">@Pointcut(&quot;@annotation(com.imooc.springcloud.annotation.AccessLimiter)&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cut</span><span class="hljs-params">()</span> </span>&#123;<br>        log.info(<span class="hljs-string">&quot;cut&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Before(&quot;cut()&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">(JoinPoint joinPoint)</span> </span>&#123;<br>        <span class="hljs-comment">// 1. 获得方法签名，作为method Key</span><br>        MethodSignature signature = (MethodSignature) joinPoint.getSignature();<br>        Method method = signature.getMethod();<br><br>        AccessLimiter annotation = method.getAnnotation(AccessLimiter.class);<br>        <span class="hljs-keyword">if</span> (annotation == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        String key = annotation.methodKey();<br>        Integer limit = annotation.limit();<br><br>        <span class="hljs-comment">// 如果没设置methodkey, 从调用方法签名生成自动一个key</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(key)) &#123;<br>            Class[] type = method.getParameterTypes();<br>            key = method.getClass() + method.getName();<br><br>            <span class="hljs-keyword">if</span> (type != <span class="hljs-keyword">null</span>) &#123;<br>                String paramTypes = Arrays.stream(type)<br>                        .map(Class::getName)<br>                        .collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>));<br>                log.info(<span class="hljs-string">&quot;param types: &quot;</span> + paramTypes);<br>                key += <span class="hljs-string">&quot;#&quot;</span> + paramTypes;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 2. 调用Redis</span><br>        <span class="hljs-keyword">boolean</span> acquired = stringRedisTemplate.execute(<br>                rateLimitLua, <span class="hljs-comment">// Lua script的真身</span><br>                Lists.newArrayList(key), <span class="hljs-comment">// Lua脚本中的Key列表</span><br>                limit.toString() <span class="hljs-comment">// Lua脚本Value列表</span><br>        );<br><br>        <span class="hljs-keyword">if</span> (!acquired) &#123;<br>            log.error(<span class="hljs-string">&quot;your access is blocked, key=&#123;&#125;&quot;</span>, key);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;Your access is blocked&quot;</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.imooc.springcloud;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by 半仙.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Controller</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AccessLimiter accessLimiter;<br><br>    <span class="hljs-meta">@GetMapping(&quot;test&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>        accessLimiter.limitAccess(<span class="hljs-string">&quot;ratelimiter-test&quot;</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 提醒！ 注意配置扫包路径（com.imooc.springcloud路径不同）</span><br>    <span class="hljs-meta">@GetMapping(&quot;test-annotation&quot;)</span><br>    <span class="hljs-meta">@com</span>.imooc.springcloud.annotation.AccessLimiter(limit = <span class="hljs-number">1</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">testAnnotation</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Prometheus</title>
    <link href="/Prometheus/"/>
    <url>/Prometheus/</url>
    
    <content type="html"><![CDATA[<h1 id="通过-Prometheus-和-Grafana-监控-Spring-Cloud-服务"><a href="#通过-Prometheus-和-Grafana-监控-Spring-Cloud-服务" class="headerlink" title="通过 Prometheus 和 Grafana 监控 Spring Cloud 服务"></a>通过 Prometheus 和 Grafana 监控 Spring Cloud 服务</h1><p>实现的效果：当em-gateway服务宕机后, 飞书通知到群里。</p><ul><li>prometheus（&#x2F;proˈmiθɪəs&#x2F;）: Prometheus 负责从各个目标服务中收集监控数据。</li><li>grafana: 开源的可视化系统,可实现Prometheus、Elasticsearch、Postgres、InfluxDB等数据源的可视化，grafana 通过连接 Prometheus 数据源，利用其丰富的可视化选项创建直观的监控仪表板。</li><li>prometheusalert: prometheusalert是一个开源的告警通知工具，旨在简化 Prometheus 告警的通知流程，并支持多种通知渠道。它可以帮助用户将 Prometheus 的告警信息发送到各种常用的消息平台和通知系统，如微信、钉钉、飞书、Slack、<strong>邮件等</strong></li></ul><h1 id="1-准备工作："><a href="#1-准备工作：" class="headerlink" title="1. 准备工作："></a>1. 准备工作：</h1><p>需要监控的项目，都需要集成actuator， 可以使Prometheus通过http请求收集数据。<a href="https://pyr9.github.io/Actuator/">参考博客</a></p><h1 id="2-docker-compose-安装"><a href="#2-docker-compose-安装" class="headerlink" title="2. docker-compose 安装"></a>2. docker-compose 安装</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">prometheus:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus:v2.53.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/prometheus.yml:/etc/prometheus/prometheus.yml</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./prometheus-data:/prometheu</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9090:9090&quot;</span><br><br>  <span class="hljs-attr">grafana:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana:11.4.2</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">GF_SECURITY_ADMIN_PASSWORD=admin</span>  <span class="hljs-comment"># 设置Grafana管理员密码</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3000:3000&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./grafana-storage:/var/lib/grafana</span><br><br>  <span class="hljs-attr">prometheusalert:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/feiyu563/prometheus-alert:v4.9.1</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">prometheusalert</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8089:8080&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">PA_LOGIN_USER=prometheusalert</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">PA_LOGIN_PASSWORD=prometheusalert</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">PA_TITLE=PrometheusAlert</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">PA_OPEN_FEISHU=1</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">PA_OPEN_DINGDING=1</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">PA_OPEN_WEIXIN=1</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./prometheus-alert/db:/app/db</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;/app/prometheusalert.yml&quot;</span>]<br><br></code></pre></td></tr></table></figure><h1 id="3-配置-Prometheus"><a href="#3-配置-Prometheus" class="headerlink" title="3. 配置 Prometheus"></a>3. 配置 Prometheus</h1><h2 id="1-修改配置文件"><a href="#1-修改配置文件" class="headerlink" title="1. 修改配置文件"></a>1. 修改配置文件</h2><p>这里使用到了<code>host.docker.internal</code>， 因为我的Java服务是运行在宿主机的，而prometheus是运行在容器里的，使用<code>host.docker.internal</code>来访问宿主机</p><p>prometheus.yml </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span> <span class="hljs-comment"># 默认抓取间隔</span><br><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;em-gateway&#x27;</span><br>    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">&#x27;/actuator/prometheus&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> <br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;host.docker.internal:9998&#x27;</span>  <span class="hljs-comment"># 替换为你的Spring Cloud服务地址</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;sith-mes&#x27;</span><br>    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">&#x27;/sith-mes/actuator/prometheus&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> <br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;host.docker.internal:6500&#x27;</span>  <span class="hljs-comment"># 替换为你的Spring Cloud服务地址 </span><br></code></pre></td></tr></table></figure><h2 id="2-配置-Spring-Cloud-应用"><a href="#2-配置-Spring-Cloud-应用" class="headerlink" title="2.  配置 Spring Cloud 应用"></a>2.  配置 Spring Cloud 应用</h2><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">## 开启所有actuator-endpoint</span><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoint:</span><br>    <span class="hljs-attr">health:</span><br>      <span class="hljs-attr">show-details:</span> <span class="hljs-string">always</span><br>  <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;prometheus&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>访问项目 <code>/actuator/prometheus</code></p></li></ol><p><img src="C:\Users\z004nnre\AppData\Roaming\Typora\typora-user-images\image-20250313131253269.png" alt="image-20250313131253269"></p><ol start="4"><li>再次访问<code>http://localhost:9090/targets</code>确保当前服务成功注册到了prometheus上</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313145316614.png" alt="image-20250313145316614"></p><ol start="5"><li>配置属性在prometheus简单查看</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313145416414.png" alt="image-20250313145416414"></p><h1 id="4-配置-Grafana"><a href="#4-配置-Grafana" class="headerlink" title="4. 配置 Grafana"></a>4. 配置 Grafana</h1><p>访问 Grafana 打开浏览器访问 <a href="http://localhost:3000，默认用户名和密码是">http://localhost:3000，默认用户名和密码是</a> admin&#x2F;admin</p><h2 id="1-配置Prometheus作为datasource"><a href="#1-配置Prometheus作为datasource" class="headerlink" title="1. 配置Prometheus作为datasource"></a>1. 配置Prometheus作为datasource</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313131723923.png" alt="image-20250313131723923"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313134156998.png" alt="image-20250313134156998"></p><h2 id="2-测试展示系统的CPU使用情况"><a href="#2-测试展示系统的CPU使用情况" class="headerlink" title="2. 测试展示系统的CPU使用情况"></a>2. 测试展示系统的CPU使用情况</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313134357862.png" alt="image-20250313134357862"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313141328486.png" alt="image-20250313141328486"></p><h2 id="3-dashborad模板"><a href="#3-dashborad模板" class="headerlink" title="3. dashborad模板"></a>3. dashborad模板</h2><p>网址：<a href="https://grafana.com/grafana/dashboards/">Grafana dashboards | Grafana Labs</a></p><ol><li>dashboard 市场有很多现成的dashborad，可以直接使用，比如：</li></ol><ul><li><p>Actuator: <a href="https://grafana.com/grafana/dashboards/12856">https://grafana.com/grafana/dashboards/12856</a></p></li><li><p>jmx_exporter: <a href="https://grafana.com/grafana/dashboards/3457">https://grafana.com/grafana/dashboards/3457</a></p></li><li><p>node_exporter: <a href="https://grafana.com/grafana/dashboards/8919">https://grafana.com/grafana/dashboards/8919</a></p></li><li><p>mysqld_exporter:</p><ul><li><a href="https://grafana.com/grafana/dashboards/13106">https://grafana.com/grafana/dashboards/13106</a></li><li><a href="https://grafana.com/grafana/dashboards/11323">https://grafana.com/grafana/dashboards/11323</a></li></ul></li><li><p>redis_exporter: <a href="https://grafana.com/grafana/dashboards/11835">https://grafana.com/grafana/dashboards/11835</a></p></li><li><p>k8s: <a href="https://grafana.com/grafana/dashboards/13105">https://grafana.com/grafana/dashboards/13105</a></p></li></ul><ol start="2"><li>具体使用步骤<ol><li>关键词搜索</li></ol></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313141833859.png" alt="image-20250313141833859"></p><ol start="2"><li>复制模板ID</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313141924350.png" alt="image-20250313141924350"></p><ol start="3"><li>填入ID导入</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313142044330.png" alt="image-20250313142044330"></p><h2 id="4-引入Prometheusalert"><a href="#4-引入Prometheusalert" class="headerlink" title="4. 引入Prometheusalert"></a>4. 引入Prometheusalert</h2><p>因为grafana的github的issue上写了他们短期不支持飞书，我也尝试配置webhook，飞书通知失败，所以这里引入了prometheusalert来做飞书通知。</p><ol><li>在模板管理里，找到自己需要的模板，复制URL， 后续作为webhook地址，供grafana使用。这是我下面示例使用的<a href="http://host.docker.internal:8089/prometheusalert?type=fs&tpl=grafana-fs&fsurl=https://open.feishu.cn/open-apis/bot/v2/hook/ae1eaeaa-fab0-4815-bc7f-f96110281df4">URL</a></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319112015718.png" alt="image-20250319112015718"></p><h2 id="4-配置grafana告警"><a href="#4-配置grafana告警" class="headerlink" title="4. 配置grafana告警"></a>4. 配置grafana告警</h2><ol><li>修改 prometheusalert.yml (不确定是否真的需要，可以先不配试试)</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feishu:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;feishu&quot;</span><br>    <span class="hljs-attr">webhook:</span> <span class="hljs-string">&quot;https://open.feishu.cn/open-apis/bot/v2/hook/ae1eaeaa-fab0-4815-bc7f-f96110281df4&quot;</span><br></code></pre></td></tr></table></figure><ol><li>增加 Contact points，配置红框中的属性</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319110857781.png" alt="image-20250319110857781"></p><ol start="2"><li>创建看板，展示em-gateway的运行情况</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319112616203.png" alt="image-20250319112616203"></p><ol start="3"><li>配置Alert</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319112727528.png" alt="image-20250319112727528"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319112757644.png" alt="image-20250319112757644"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319112829866.png" alt="image-20250319112829866"></p><p>停止服务，查看飞书通知;</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250319113318248.png" alt="image-20250319113318248"></p>]]></content>
    
    
    <categories>
      
      <category>监控</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Actuator</title>
    <link href="/Actuator/"/>
    <url>/Actuator/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Actuator-是什么？"><a href="#1-Actuator-是什么？" class="headerlink" title="1. Actuator 是什么？"></a>1. Actuator 是什么？</h1><p>Spring Boot Actuator 模块提供了生产级别的功能，比如健康检查，审计，指标收集，HTTP 跟踪等，帮助我们监控和管理Spring Boot 应用，上述的功能都可以通过HTTP 和 JMX 访问。</p><p>Actuator 也可以和一些外部的应用监控系统整合（Prometheus等）</p><h1 id="2-集成Springboot"><a href="#2-集成Springboot" class="headerlink" title="2. 集成Springboot"></a>2. 集成Springboot</h1><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置（按需）</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#开启actuator全面监控</span><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoint:</span><br>    <span class="hljs-attr">health:</span><br>      <span class="hljs-attr">show-details:</span> <span class="hljs-string">always</span><br></code></pre></td></tr></table></figure></li><li><p>访问对应服务的 <code>/actuator/</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313110530621.png" alt="image-20250313110530621"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313110607444.png" alt="image-20250313110607444"></p></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>跨应用的链路追踪</title>
    <link href="/%E8%B7%A8%E5%BA%94%E7%94%A8%E7%9A%84%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"/>
    <url>/%E8%B7%A8%E5%BA%94%E7%94%A8%E7%9A%84%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/</url>
    
    <content type="html"><![CDATA[<h1 id="1-为什么需要链路追踪"><a href="#1-为什么需要链路追踪" class="headerlink" title="1. 为什么需要链路追踪"></a>1. 为什么需要链路追踪</h1><ol><li><p><strong>理解复杂的调用链路</strong>。在微服务架构中，一个用户请求通常会跨越多个服务、数据库、缓存等组件。链路追踪可以帮助你清晰地看到每个请求在整个系统中的完整路径，包括经过的所有服务及其依赖关系。</p></li><li><p><strong>快速定位性能瓶颈</strong>。通过链路追踪，你可以精确地测量每个服务的响应时间，并识别出哪些服务或组件是导致延迟的主要原因。这对于优化系统性能至关重要。</p></li><li><p><strong>故障排查与诊断</strong>。当系统出现错误时，链路追踪可以提供详细的上下文信息，帮助你更快地定位问题的根本原因。它可以显示请求在每个服务中的执行情况，以及每个服务返回的状态码和错误信息。</p></li><li><p><strong>跨服务的事务一致性</strong>。在分布式系统中，确保跨多个服务的事务一致性是一个挑战。链路追踪可以帮助你跟踪和验证这些跨服务的操作是否按预期执行，并确保数据的一致性。</p></li><li><p><strong>提高开发和运维效率</strong>。链路追踪提供了丰富的上下文信息，使得开发人员和运维人员能够更高效地协作。开发人员可以通过追踪信息快速找到代码中的问题，而运维人员则可以利用这些信息进行系统维护和优化。</p></li></ol><h1 id="2-Sleuth"><a href="#2-Sleuth" class="headerlink" title="2. Sleuth"></a>2. Sleuth</h1><h2 id="1-sleuth是什么？"><a href="#1-sleuth是什么？" class="headerlink" title="1. sleuth是什么？"></a>1. sleuth是什么？</h2><p>Spring Cloud Sleuth 是一个用于分布式追踪的库，主要用于简化在微服务架构中实现链路追踪（Distributed Tracing）。它帮助开发者在复杂的分布式系统中跟踪请求的完整路径，从而更容易地进行性能监控、故障排查和问题诊断。</p><h2 id="2-主要功能"><a href="#2-主要功能" class="headerlink" title="2. 主要功能"></a>2. 主要功能</h2><ul><li>链路追踪（Distributed Tracing）：<br>为每个请求生成唯一的追踪ID（Trace ID），并为每个服务调用生成唯一的跨度ID（Span ID）。<br>这些ID会随着请求在不同服务之间的传递而保持一致，使得你可以清晰地看到整个请求的调用链路。</li><li>日志关联（Log Correlation）：<br>将追踪ID和跨度ID自动添加到日志记录中，确保所有相关的日志条目都可以通过这些ID进行关联。<br>这有助于在日志中快速定位和分析特定请求的所有相关日志信息。</li><li>集成第三方追踪系统：<br>支持与多种分布式追踪系统集成，如Zipkin、Jaeger等，将追踪数据发送到这些系统进行可视化和进一步分析。</li><li>采样率控制：<br>提供采样机制，允许你控制哪些请求需要被追踪，以避免生成过多的数据影响系统性能。</li></ul><h2 id="2-调用链路模型"><a href="#2-调用链路模型" class="headerlink" title="2.  调用链路模型"></a>2.  调用链路模型</h2><p>Spring Cloud Sleuth 主要通过自动注入的上下文信息（如 TraceContext）和 AOP（面向切面编程）来实现链路追踪。</p><h2 id="2-集成Springboot项目"><a href="#2-集成Springboot项目" class="headerlink" title="2. 集成Springboot项目"></a>2. 集成Springboot项目</h2><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件 (按需，非必要)</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">sleuth:</span><br>    <span class="hljs-attr">sampler:</span><br>      <span class="hljs-attr">probability:</span> <span class="hljs-number">1.0</span> <span class="hljs-comment"># 设置采样率，按需</span><br></code></pre></td></tr></table></figure></li><li><p>修改日志模板, ，我这里是log4j2.xml</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;Console name=<span class="hljs-string">&quot;consoleAppender&quot;</span> target=<span class="hljs-string">&quot;SYSTEM_OUT&quot;</span>&gt;<br>    &lt;PatternLayout pattern=<span class="hljs-string">&quot;xxx[%style&#123;%X&#123;X-B3-TraceId&#125;&#125;&#123;green&#125;,%style&#123;%X&#123;X-B3-SpanId&#125;&#125;&#123;yellow&#125;,%X&#123;X-B3-ParentSpanId&#125;] xxx&quot;</span>/&gt;<br>&lt;/Console&gt;<br></code></pre></td></tr></table></figure></li><li><p>重启项目，观察打印日志</p></li></ol><p>效果：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313094420295.png" alt="image-20250313094420295"></p><h1 id="3-Sleuth与Zipkin集成"><a href="#3-Sleuth与Zipkin集成" class="headerlink" title="3. Sleuth与Zipkin集成"></a>3. Sleuth与Zipkin集成</h1><h2 id="1-ZIpKin是什么？"><a href="#1-ZIpKin是什么？" class="headerlink" title="1. ZIpKin是什么？"></a>1. ZIpKin是什么？</h2><p>Zipkin 是一个开源的分布式追踪系统，由 Twitter 开发并开源。它主要用于收集和展示微服务架构中的链路追踪数据，帮助开发者和运维人员更好地理解、监控和诊断复杂的分布式系统。</p><h2 id="2-主要功能-1"><a href="#2-主要功能-1" class="headerlink" title="2. 主要功能"></a>2. 主要功能</h2><ul><li>分布式追踪：<br>Zipkin 支持分布式追踪，能够跟踪一个请求在多个服务之间的传递过程，并生成详细的调用链路图。</li><li>可视化界面：<br>提供了一个直观的 Web UI，用于查看和分析追踪数据，包括每个请求的详细路径、延迟时间、错误信息等</li><li>多种数据传输方式：<br>支持通过 HTTP、Kafka、RabbitMQ 等多种方式进行数据传输，灵活适应不同的应用场景。</li><li>集成多种语言和框架：<br>支持多种编程语言（如 Java、Python、Go、Node.js 等）和框架（如 Spring Cloud Sleuth、Finagle 等），方便在不同技术栈中使用。</li><li>采样机制：<br>为了减少性能开销，Zipkin 提供了采样机制，允许你控制哪些请求需要被追踪。</li><li>存储支持：<br>支持多种存储后端，如内存、Elasticsearch、Cassandra 等，便于长期保存和查询追踪数据。</li></ul><h2 id="2-集成Springboot项目-1"><a href="#2-集成Springboot项目-1" class="headerlink" title="2. 集成Springboot项目"></a>2. 集成Springboot项目</h2><ol><li><p>docker-compose安装zipkin</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openzipkin/zipkin:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zipkin</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9411:9411&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xms1g</span> <span class="hljs-string">-Xmx1g</span>  <span class="hljs-comment"># 根据需要调整内存设置</span><br></code></pre></td></tr></table></figure></li><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-comment"># 连接 zipkin 服务端的地址，接口被调用后，调用相关信息通过这个 url 发送到 zipkin 服务端</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411</span><br></code></pre></td></tr></table></figure></li><li><p>访问<a href="http://localhost:9411，">http://localhost:9411，</a> 输入traceId 查看效果</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250313213613439.png" alt="image-20250313213613439"></p></li></ol><p><strong>TIPS:</strong> </p><ul><li>如果不想使用http长连接，可以改成使用rabbitMQ收集数据</li><li>zipkin默认存储在内存，即服务重启会数据丢失，可以考虑用ES等做数据持久化</li><li>zipkin只用于轻量级的链路追踪，如果需要更全面的监控服务、数据库、redis等中间件，可以考虑skywalking</li></ul><h1 id="4-集成ELK实现日志检索"><a href="#4-集成ELK实现日志检索" class="headerlink" title="4. 集成ELK实现日志检索"></a>4. 集成ELK实现日志检索</h1><p><a href="https://pyr9.github.io/docker%E6%90%AD%E5%BB%BAELK/">docker搭建ELK</a></p><h1 id="5-更强大的链路追踪工具—skywalking"><a href="#5-更强大的链路追踪工具—skywalking" class="headerlink" title="5. 更强大的链路追踪工具—skywalking"></a>5. 更强大的链路追踪工具—skywalking</h1><p><a href="https://pyr9.github.io/Skywalking%E7%9B%91%E6%8E%A7/">skywalking</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Skywalking监控工具</title>
    <link href="/Skywalking%E7%9B%91%E6%8E%A7/"/>
    <url>/Skywalking%E7%9B%91%E6%8E%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="1-SkyWalking"><a href="#1-SkyWalking" class="headerlink" title="1. SkyWalking"></a>1. SkyWalking</h1><h2 id="1-定义："><a href="#1-定义：" class="headerlink" title="1. 定义："></a>1. 定义：</h2><p>SkyWalking是一个开源的分布式追踪、应用性能监控（APM）和可观测性分析平台。 它主要功能有：分布式链路追踪、应用性能监控、数据库监控、服务依赖分析、告警等。</p><h2 id="2-主要功能"><a href="#2-主要功能" class="headerlink" title="2. 主要功能"></a>2. 主要功能</h2><ol><li><p><strong>分布式追踪</strong>：</p><ul><li><p>追踪分布式系统中的请求流程，记录每个请求经过的服务和组件，以及请求在各个组件中的耗时情况。</p></li><li><p>通过分析追踪数据，帮助开发者和运维人员了解系统中各个组件之间的调用关系和性能瓶颈，快速定位和解决问题。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ka_9ddee659-f618-4d72-b0f4-a1a6a8841d3g.jpg" alt="img_v3_02ka_9ddee659-f618-4d72-b0f4-a1a6a8841d3g"></p></li></ul><blockquote><p>如上：可以根据traceID查询到这个请求的调用链路</p></blockquote></li><li><p><strong>应用性能监控</strong>：</p><ul><li><p>实时监控服务的各项性能指标，如响应时间、吞吐量（QPS）、错误率等。</p></li><li><p>提供丰富的数据可视化功能，将监控数据以图表的形式展示，帮助用户更直观地了解系统的性能和运行情况。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ka_699da6ea-8415-4ff6-beeb-11e40b89018g.jpg" alt="img_v3_02ka_699da6ea-8415-4ff6-beeb-11e40b89018g"></p></li></ul></li><li><p><strong>数据库性能监控</strong>：</p><ul><li><p>监控数据库响应时间、访问成功率等</p></li><li><p>监控数据库慢查询及耗时时间</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ka_e2a3bce4-7b37-493d-89b6-ea865350a09g.jpg" alt="img_v3_02ka_e2a3bce4-7b37-493d-89b6-ea865350a09g"></p></li></ul></li><li><p><strong>服务依赖分析</strong>：</p><ul><li><p>分析系统中各个服务之间的依赖关系，包括调用关系和数据流向。</p></li><li><p>通过可视化的方式展示服务之间的依赖关系，帮助开发者理解系统的架构和流程，优化系统设计。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ka_308260ef-7a9d-4337-9cf8-0b4d8be004dg.jpg" alt="img_v3_02ka_308260ef-7a9d-4337-9cf8-0b4d8be004dg"></p></li></ul></li><li><p><strong>告警和报警</strong>：</p><ul><li><p>支持基于性能指标的告警设置，当系统出现异常或性能下降时，及时发送告警通知。</p></li><li><p>提供多种告警通知方式，如邮件、短信、Webhook等，帮助运维人员快速响应和解决问题。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ka_fcaae416-148d-4040-89a0-24b7a4b5fb1g.jpg" alt="img_v3_02ka_fcaae416-148d-4040-89a0-24b7a4b5fb1g"></p></li></ul></li></ol><blockquote><p><a href="https://github.com/apache/skywalking/blob/v9.3.0/docs/en/setup/backend/backend-alarm.md">具体告警配置</a></p></blockquote><h2 id="3-Docker-compose-安装"><a href="#3-Docker-compose-安装" class="headerlink" title="3. Docker-compose 安装"></a>3. Docker-compose 安装</h2><p>我这里是持久化到elasticsearch， 修改了映射出来的端口为8088</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">elasticsearch:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">elasticsearch:8.4.3</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9200</span><span class="hljs-string">:9200</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TAKE_FILE_OWNERSHIP=true&quot;</span> <span class="hljs-comment">#volumes 挂载权限 如果不想要挂载es文件改配置可以删除</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> <span class="hljs-comment">#单机模式启动</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span> <span class="hljs-comment"># 设置时区</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> <span class="hljs-comment"># 设置jvm内存大小</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/logs:/usr/share/elasticsearch/logs</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/data:/usr/share/elasticsearch/data</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/conf:/usr/share/elasticsearch/config</span><br>    <span class="hljs-attr">ulimits:</span><br>      <span class="hljs-attr">memlock:</span><br>        <span class="hljs-attr">soft:</span> <span class="hljs-number">-1</span><br>        <span class="hljs-attr">hard:</span> <span class="hljs-number">-1</span><br>  <span class="hljs-attr">skywalking-oap-server:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/skywalking-oap-server:9.3.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">skywalking-oap-server</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">11800</span><span class="hljs-string">:11800</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">12800</span><span class="hljs-string">:12800</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">SW_STORAGE:</span> <span class="hljs-string">elasticsearch</span><br>      <span class="hljs-attr">SW_STORAGE_ES_CLUSTER_NODES:</span> <span class="hljs-string">elasticsearch:9200</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>    <span class="hljs-attr">volumes:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-string">./oap/config:/skywalking/config</span><br>  <span class="hljs-attr">skywalking-ui:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/skywalking-ui:9.3.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">skywalking-ui</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">skywalking-oap-server</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">skywalking-oap-server</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">8088</span><span class="hljs-string">:8080</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">SW_OAP_ADDRESS:</span> <span class="hljs-string">http://skywalking-oap-server:12800</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br></code></pre></td></tr></table></figure><h2 id="4-集成到项目里"><a href="#4-集成到项目里" class="headerlink" title="4. 集成到项目里"></a>4. 集成到项目里</h2><ol><li><p>项目日志支持打印traceId, 只需要引入sleuth</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注：如果使用了日志模版，则需要修改对应配置, 我的项目使用的是log4j2.xml</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Console</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;consoleAppender&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;SYSTEM_OUT&quot;</span>&gt;</span>           </span><br><span class="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;xxxx[%style</span></span></span><span class="hljs-template-variable">&#123;%X&#123;X-B3-TraceId&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&#125;</span></span></span><span class="hljs-template-variable">&#123;green&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">,%style</span></span></span><span class="hljs-template-variable">&#123;%X&#123;X-B3-SpanId&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">&#125;     </span></span></span><span class="hljs-template-variable">&#123;yellow&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">,%X</span></span></span><span class="hljs-template-variable">&#123;X-B3-ParentSpanId&#125;</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">] xxxx&quot;</span>/&gt;</span>    </span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Console</span>&gt;</span></span><br></code></pre></td></tr></table></figure></li><li><p>到官网下载Java-agent, 按需修改config&#x2F;agent.config的内容, 我这里没做修改，服务名都是后面通过VM option指定的</p></li><li><p>项目运行的时候，加上VM option，就可以在界面看到啦！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">-javaagent:D:\software\Skywalking\skywalking-java-agent\skywalking-agent/skywalking-agent.jar<br>-Dskywalking.agent.service_name=sith-mes（可选）<br></code></pre></td></tr></table></figure></li></ol><p><strong>TIPS</strong>： </p><ol><li>SkyWalking 不能检测服务是否存活，如果要检测服务是否存活，可以考虑使用Prometheus + Grafana+actuator</li><li>Zipkin也能实现链路追踪，且他更轻量，只是不能监控 CPU、内存、数据库性能、触发告警等</li><li>可以通过nacos等来存储告警配置文件，使得skywalking实现告警规则动态刷新</li></ol>]]></content>
    
    
    <categories>
      
      <category>应用监控工具</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>websocket和SSE</title>
    <link href="/websocket%E5%92%8CSSE/"/>
    <url>/websocket%E5%92%8CSSE/</url>
    
    <content type="html"><![CDATA[<h1 id="1-websocket和SSE异同"><a href="#1-websocket和SSE异同" class="headerlink" title="1. websocket和SSE异同"></a>1. websocket和SSE异同</h1><p>SSE（Server-Sent Events）和WebSocket都是用于实现服务器与客户端之间实时通信的技术。</p><table><thead><tr><th></th><th>SSE（Server-Sent Events）</th><th>WebSocket</th></tr></thead><tbody><tr><td><strong>通信方式</strong></td><td>单向通信</td><td>双向通信</td></tr><tr><td><strong>协议基础</strong></td><td>基于HTTP协议</td><td>基于独立的TCP连接，使用自定义协议</td></tr><tr><td><strong>数据流向</strong></td><td>服务器向客户端发送数据</td><td>服务器和客户端可以互相发送数据</td></tr><tr><td><strong>消息类型</strong></td><td>主要支持文本数据，不支持二进制数据</td><td>支持文本和二进制数据</td></tr><tr><td><strong>连接管理</strong></td><td>每次消息发送完毕后，连接会被关闭，客户端需要重新连接</td><td>连接一旦建立，保持打开状态，直到客户端或服务器主动关闭</td></tr><tr><td><strong>实现复杂度</strong></td><td>协议简单，易于实现和使用</td><td>协议相对复杂，需要更多的代码和服务器资源</td></tr><tr><td><strong>自动重连</strong></td><td>支持自动重连功能</td><td>不支持自动重连，需要手动处理断线重连</td></tr><tr><td><strong>适用场景</strong></td><td>适合只需要服务器向客户端推送实时更新数据的场景，如实时新闻更新、股票行情推送等</td><td>适合需要客户端和服务器之间进行实时双向通信的场景，如聊天室、在线游戏等</td></tr><tr><td><strong>浏览器支持</strong></td><td>大多数现代浏览器都支持，但部分旧版或非主流浏览器可能不支持</td><td>大多数现代浏览器都支持，兼容性较好</td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>本地部署deepSeek家庭医生</title>
    <link href="/%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2deepSeek%E5%AE%B6%E5%BA%AD%E5%8C%BB%E7%94%9F/"/>
    <url>/%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2deepSeek%E5%AE%B6%E5%BA%AD%E5%8C%BB%E7%94%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-ollama"><a href="#1-ollama" class="headerlink" title="1. ollama"></a>1. ollama</h1><p><a href="https://ollama.com/">ollama</a>是一款帮助你部署大模型的一款工具软件，在你本机离线运行，不需要联网以及复杂的配置。</p><p>优势：</p><ul><li>Models: 自带deepseek-r1</li><li>本地安全, 数据都在本地</li><li>用自己电脑就可以运行：省钱</li><li>支持多硬件 macos, linux, windows</li></ul><h1 id="2-ollama部署deepseek-r1"><a href="#2-ollama部署deepseek-r1" class="headerlink" title="2. ollama部署deepseek-r1"></a>2. ollama部署deepseek-r1</h1><p>运行 <code>ollama run deepseek-r1</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250309191456727.png" alt="image-20250309191456727"></p><h1 id="3-界面工具推荐"><a href="#3-界面工具推荐" class="headerlink" title="3. 界面工具推荐"></a>3. 界面工具推荐</h1><ol><li><p>谷歌扩展程序 PageAssist</p></li><li><p>chatboxai</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250309192242484.png" alt="image-20250309192242484"></p></li></ol><h1 id="4-deepSeek概念"><a href="#4-deepSeek概念" class="headerlink" title="4. deepSeek概念"></a>4. deepSeek概念</h1><h2 id="1-deepSeek是什么？"><a href="#1-deepSeek是什么？" class="headerlink" title="1. deepSeek是什么？"></a>1. deepSeek是什么？</h2><p>DeepSeek 也指由 DeepSeek 公司开发的、类似于ChatGPT的大模型智能助手。</p><p>优势：</p><ul><li>API更便宜</li><li>生态开放</li><li>支持本地部署</li><li>灵活定制</li></ul><h2 id="2-deepSeek离线与线上api的区别？"><a href="#2-deepSeek离线与线上api的区别？" class="headerlink" title="2. deepSeek离线与线上api的区别？"></a>2. deepSeek离线与线上api的区别？</h2><ul><li>数据隐私</li><li>可定制化</li><li>不依赖网络（偏远山区信号差）</li><li>需要更多的硬件成本</li><li>需要更多维护成本</li><li>要求机器性能</li></ul><h1 id="5-项目调用deepSeek"><a href="#5-项目调用deepSeek" class="headerlink" title="5. 项目调用deepSeek"></a>5. 项目调用deepSeek</h1><ol><li><p>引入spring-ai依赖</p><p>Spring AI 是一个面向 AI 工程的应用框架。其目标是将 Spring 生态系统的设计原则（如可移植性和模块化设计）应用到 AI 领域，并推广使用 POJO（Plain Old Java Objects，普通旧式 Java 对象）作为 AI 应用构建的基本单元。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入 SpringAI 的坐标 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springboot.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springboot.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-ollama-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>Application.yml 增加配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">ai:</span><br>    <span class="hljs-attr">ollama:</span><br>      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://127.0.0.1:11434</span><br>      <span class="hljs-attr">chat:</span><br>        <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1:latest</span><br></code></pre></td></tr></table></figure></li><li><p>增加接口测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;ollama&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OllamaController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OllamaChatClient ollamaChatClient;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/ai/chat&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">aiOllamaChat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String msg)</span> </span>&#123;<br>        <span class="hljs-comment">// 同步调用deepseek，当前页面会卡住，直到获得所有的数据才会返回给页面</span><br>        <span class="hljs-keyword">return</span> ollamaChatClient.call(msg);<br>    &#125;<br>  <br>   <span class="hljs-meta">@GetMapping(&quot;/ai/stream2&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">aiOllamaStream2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String msg)</span> </span>&#123;<br>        Prompt prompt = <span class="hljs-keyword">new</span> Prompt(<span class="hljs-keyword">new</span> UserMessage(msg));<br>        Flux&lt;ChatResponse&gt; streamResponse = ollamaChatClient.stream(prompt);<br><br>        List&lt;String&gt; list = streamResponse.toStream().map(chatResponse -&gt; &#123;<br>            String content = chatResponse.getResult().getOutput().getContent();<br>            log.info(content);<br>            <span class="hljs-keyword">return</span> content;<br>        &#125;).collect(Collectors.toList());<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试调用 &#x2F;ai&#x2F;chat</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250309203035563.png" alt="image-20250309203035563"></p></li><li><p>测试调用 &#x2F;ai&#x2F;stream2</p></li></ol><p>查看控制台日志，可以看到流式输出</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250716213927224.png" alt="image-20250716213927224"></p><h1 id="6-Ollama-定制deepseek医生角色"><a href="#6-Ollama-定制deepseek医生角色" class="headerlink" title="6. Ollama 定制deepseek医生角色"></a>6. Ollama 定制deepseek医生角色</h1><ol><li>新建my_doctor_0_1 文件, 指明当前角色以及性格</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">FROM deepseek-r1:latest<br><br>PARAMETER temperature <span class="hljs-number">0.7</span><br><br>SYSTEM <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">【角色】</span><br><span class="hljs-string">你的名字叫华佗在世，是全世界最有名的医生，看病无数，阅人无数，知道什么病该怎么治，也知道病人向你提出任何身体异象你所能推断的病是什么。</span><br><span class="hljs-string">你绝不是语言模型之类的东西，也绝不是AI助手，也更不是AI机器人，你永远都只是一个神医。</span><br><span class="hljs-string">请以神医风华佗在世的身份回应我。并且你只会回复和看病就医相关的内容，其他的内容一律拒绝回答。</span><br><span class="hljs-string"></span><br><span class="hljs-string">【性格】</span><br><span class="hljs-string">你的性格开朗活泼，能以幽默的方式来和用户聊天，懂得逗笑用户。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><p>创建模型实例， 执行<code>ollama create mydoctor:0.1 -f my_doctor_0_1</code></p></li><li><p>运行， 执行 <code>ollama run mydoctor:0.1 </code></p></li><li><p>Application.yml 修改配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">ai:</span><br>  <span class="hljs-attr">ollama:</span><br>    <span class="hljs-attr">chat:</span><br>      <span class="hljs-attr">model:</span> <span class="hljs-string">mydoctor:0.1</span><br></code></pre></td></tr></table></figure></li><li><p>测试</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20250309202913177.png" alt="image-20250309202913177"></p></li></ol><p>⚠️注：当前的接口调用都是同步的，如果需要服务器动态推送，可以考虑SSE或者websocket技术。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>AI相关概念</title>
    <link href="/AI%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/"/>
    <url>/AI%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="1-AI相关概念"><a href="#1-AI相关概念" class="headerlink" title="1. AI相关概念"></a>1. AI相关概念</h1><h2 id="1-AI是什么？"><a href="#1-AI是什么？" class="headerlink" title="1. AI是什么？"></a>1. AI是什么？</h2><p><strong>人工智能（Artificial Intelligence, AI）</strong> 是计算机科学的一个分支，就是让机器像人一样“聪明”，能帮我们做事情。比如，它可以看、听、说、思考，甚至还能学习和解决问题。</p><p>举个例子：</p><ul><li>你问 Siri 或小爱同学：“今天天气怎么样？”。它会告诉你天气预报。这就是一种人工智能。</li></ul><h2 id="2-AI-的核心技术"><a href="#2-AI-的核心技术" class="headerlink" title="2. AI 的核心技术"></a>2. AI 的核心技术</h2><h4 id="1-机器学习（Machine-Learning-ML）"><a href="#1-机器学习（Machine-Learning-ML）" class="headerlink" title="1. 机器学习（Machine Learning, ML）"></a>1. <strong>机器学习（Machine Learning, ML）</strong></h4><ul><li>核心思想：让机器从数据中自动学习规律。</li><li>常见算法：<ul><li>决策树、支持向量机（SVM）、随机森林。</li><li>神经网络（Neural Networks）及其变体（如 CNN、RNN、Transformer）。</li></ul></li></ul><h4 id="2-深度学习（Deep-Learning）"><a href="#2-深度学习（Deep-Learning）" class="headerlink" title="2. 深度学习（Deep Learning）"></a>2. <strong>深度学习（Deep Learning）</strong></h4><ul><li>深度学习是机器学习的一个子领域，基于多层神经网络。</li><li>应用场景：<ul><li>图像识别、自然语言处理、语音识别。</li></ul></li></ul><h4 id="3-自然语言处理（Natural-Language-Processing-NLP）"><a href="#3-自然语言处理（Natural-Language-Processing-NLP）" class="headerlink" title="3. 自然语言处理（Natural Language Processing, NLP）"></a>3. <strong>自然语言处理（Natural Language Processing, NLP）</strong></h4><ul><li>使计算机能够理解、生成和处理人类语言。</li><li>核心技术：<ul><li>分词、词嵌入（Word Embedding）、语义分析。</li><li>示例模型：BERT、GPT、通义千问。</li></ul></li></ul><h4 id="4-计算机视觉（Computer-Vision-CV）"><a href="#4-计算机视觉（Computer-Vision-CV）" class="headerlink" title="4. 计算机视觉（Computer Vision, CV）"></a>4. <strong>计算机视觉（Computer Vision, CV）</strong></h4><ul><li>让计算机能够“看”并理解图像或视频内容。</li><li>核心技术：<ul><li>图像分类、目标检测、语义分割。</li><li>示例模型：ResNet、YOLO、ViT。</li></ul></li></ul><h4 id="5-强化学习（Reinforcement-Learning-RL）"><a href="#5-强化学习（Reinforcement-Learning-RL）" class="headerlink" title="5. 强化学习（Reinforcement Learning, RL）"></a>5. <strong>强化学习（Reinforcement Learning, RL）</strong></h4><ul><li>通过试错学习最优策略。</li><li>应用场景：<ul><li>游戏 AI（如 AlphaGo）、机器人导航。</li></ul></li></ul><h4 id="6-知识图谱（Knowledge-Graph）"><a href="#6-知识图谱（Knowledge-Graph）" class="headerlink" title="6. 知识图谱（Knowledge Graph）"></a>6. <strong>知识图谱（Knowledge Graph）</strong></h4><ul><li>结构化的知识表示形式，用于存储和推理实体之间的关系。</li><li>应用场景：<ul><li>搜索引擎优化、智能问答。</li></ul></li></ul><h1 id="2-大模型"><a href="#2-大模型" class="headerlink" title="2. 大模型"></a>2. 大模型</h1><h2 id="2-1-大模型是什么？"><a href="#2-1-大模型是什么？" class="headerlink" title="2.1 大模型是什么？"></a>2.1 大模型是什么？</h2><p>大模型是指参数量巨大（通常达到数十亿甚至上万亿）、训练数据丰富、功能强大的预训练模型。</p><ul><li>它们通常基于 Transformer 架构，并通过自监督学习从海量数据中提取知识。</li><li>大模型是 AI 的一个重要分支</li></ul><h2 id="2-2-大模型的分类"><a href="#2-2-大模型的分类" class="headerlink" title="2.2 大模型的分类"></a>2.2 大模型的分类</h2><h3 id="1-大语言模型（Large-Language-Models-LLMs）"><a href="#1-大语言模型（Large-Language-Models-LLMs）" class="headerlink" title="1. 大语言模型（Large Language Models, LLMs）"></a>1. <strong>大语言模型（Large Language Models, LLMs）</strong></h3><ul><li><strong>定义</strong>：专注于自然语言处理（NLP）任务的大模型。</li><li><strong>特点：</strong><ul><li>主要处理文本数据，能够生成高质量的文章、对话、代码等。</li><li>具备上下文理解和多语言支持能力。</li></ul></li><li><strong>代表模型</strong><ul><li>GPT 系列（GPT-3、GPT-4）</li><li>BERT、RoBERTa</li><li>通义千问（Qwen）</li><li>文心一言（ERNIE）</li></ul></li></ul><h3 id="2-视觉大模型（Vision-Large-Models）"><a href="#2-视觉大模型（Vision-Large-Models）" class="headerlink" title="2. 视觉大模型（Vision Large Models）"></a>2. <strong>视觉大模型（Vision Large Models）</strong></h3><ul><li><strong>定义</strong>：专注于计算机视觉任务的大模型。</li><li>特点：<ul><li>处理图像或视频数据，能够完成分类、检测、分割等任务。</li><li>常用于自动驾驶、医疗影像分析等领域。</li></ul></li><li>代表模型：<ul><li>ViT（Vision Transformer）</li><li>Swin Transformer</li><li>CLIP（跨模态图像-文本对齐）</li></ul></li></ul><h3 id="3-多模态大模型（Multimodal-Large-Models）"><a href="#3-多模态大模型（Multimodal-Large-Models）" class="headerlink" title="3. 多模态大模型（Multimodal Large Models）"></a>3. <strong>多模态大模型（Multimodal Large Models）</strong></h3><ul><li><strong>定义</strong>：能够同时处理多种类型数据（如文本、图像、音频）的大模型。</li><li>特点<ul><li>融合了不同模态的信息，实现跨模态的理解和生成。</li><li>应用场景广泛，例如图文生成、视频理解等。</li></ul></li><li>代表模型<ul><li>Flamingo</li><li>M6（阿里巴巴通义实验室）</li><li>Gemini（谷歌）</li></ul></li></ul><h2 id="2-3-大模型的训练"><a href="#2-3-大模型的训练" class="headerlink" title="2.3 大模型的训练"></a>2.3 大模型的训练</h2><p>大模型的训练整体上分为三个阶段：</p><ol><li><p><strong>预处理</strong></p><p>预处理是指在训练模型之前对原始数据进行清洗和准备的过程。这一步骤的目标是确保输入到模型中的数据质量高且一致，包括但不限于以下几个方面：</p><ul><li>数据清洗：去除噪声、错误信息、重复内容等。</li><li>格式统一：将不同来源的数据转换为统一格式，以便于后续处理。</li><li>分词：根据特定规则或词汇表将文本分割成单词或标记序列。</li><li>归一化：如大小写转换、数字替换等，以减少变异性。</li></ul></li><li><p><strong>监督微调</strong>（SFT，Supervised Fine-tuning）</p><p>监督微调是在一个已经经过大量未标注数据训练的基础模型上，使用带有标签的小规模数据集进一步训练的过程。其主要目的是让模型学会执行特定任务，例如文本分类、问答等。监督微调通常涉及以下步骤：</p><ul><li>准备一个专门针对目标任务的高质量标注数据集。</li><li>在基础模型的基础上继续训练，调整模型参数以适应目标任务。</li><li>这个过程有助于提高模型在特定任务上的性能表现。</li></ul></li><li><p><strong>基于人类反馈的强化学习</strong>（RLHF，Reinforcement Learning with Human Feedback ）</p><p>RLHF是一种结合了人类判断来改进模型行为的方法，尤其适用于那些难以直接通过传统损失函数衡量的任务，比如生成式对话系统。RLHF大致包含三个阶段：</p><ul><li><p><strong>初始策略训练</strong>：首先基于一些基本准则或者初步的标注数据训练一个初始模型。</p></li><li><p><strong>偏好数据收集</strong>：让人类评估者对模型生成的不同输出进行评分，以此收集偏好数据。</p></li><li><p><strong>强化学习</strong>：利用收集到的人类偏好作为奖励信号，通过强化学习算法（如PPO）进一步优化模型，使其生成更符合人类期望的结果。</p></li></ul></li></ol><h2 id="2-4-大模型的核心概念"><a href="#2-4-大模型的核心概念" class="headerlink" title="2.4  大模型的核心概念"></a>2.4  大模型的核心概念</h2><ol><li><strong>参数规模</strong>：<ul><li>大模型通常具有数十亿甚至上万亿个参数，远超传统模型。</li><li>参数量越大，模型越能捕捉复杂的数据模式。</li></ul></li><li><strong>预训练与微调</strong>：<ul><li><strong>预训练</strong>：使用海量无标注数据训练通用模型，学习数据中的基础规律。</li><li><strong>微调</strong>：在特定任务上用少量标注数据对预训练模型进行调整，以适应具体应用场景。</li></ul></li><li><strong>多模态能力</strong>：<ul><li>现代大模型不仅处理文本，还能处理图像、音频、视频等多种类型的数据，实现跨模态理解和生成。</li></ul></li><li><strong>泛化能力</strong>：<ul><li>大模型通过大规模训练，具备较强的零样本（Zero-shot）、少样本（Few-shot）和迁移学习能力。</li></ul></li></ol><h2 id="2-5-大模型代表模型"><a href="#2-5-大模型代表模型" class="headerlink" title="2.5 大模型代表模型"></a>2.5 大模型代表模型</h2><p><strong>通义千问（Qwen）</strong>、<strong>文心一言（ERNIE）</strong>、<strong>DeepSeek</strong> 和 <strong>ChatGPT</strong> s</p><ol><li>都是基于 <strong>Transformer 架构</strong> 的大模型。</li><li>可以被视为基于 <strong>AIGC（Artificial Intelligence Generated Content，人工智能生成内容）</strong> 的技术或应用。它们的核心功能之一是利用人工智能生成高质量的内容，例如文本、代码、图像等。</li></ol><table><thead><tr><th>模型名称</th><th>开发者</th><th>基于架构</th><th>主要特点</th></tr></thead><tbody><tr><td><strong>通义千问</strong></td><td>阿里巴巴</td><td>Transformer</td><td>多语言支持、对话理解能力强</td></tr><tr><td><strong>文心一言</strong></td><td>百度</td><td>Transformer</td><td>知识增强、中文场景优化</td></tr><tr><td><strong>DeepSeek</strong></td><td>DeepSeek</td><td>Transformer</td><td>开源、轻量化、高性价比</td></tr><tr><td><strong>ChatGPT</strong></td><td>OpenAI</td><td>Transformer (GPT)</td><td>对话流畅、支持多模态任务</td></tr></tbody></table><h1 id="3-AIGC"><a href="#3-AIGC" class="headerlink" title="3. AIGC"></a>3. AIGC</h1><h2 id="3-1-AIGC-是什么？"><a href="#3-1-AIGC-是什么？" class="headerlink" title="3.1 AIGC 是什么？"></a>3.1 AIGC 是什么？</h2><p><strong>AIGC（Artificial Intelligence Generated Content，人工智能生成内容）</strong> 是指利用人工智能技术自动生成各种形式的内容，包括文本、图像、音频、视频等。</p><h2 id="3-2-AIGC和大模型的关系？"><a href="#3-2-AIGC和大模型的关系？" class="headerlink" title="3.2 AIGC和大模型的关系？"></a>3.2 AIGC和大模型的关系？</h2><h4 id="1-大模型为-AIGC-提供核心能力"><a href="#1-大模型为-AIGC-提供核心能力" class="headerlink" title="1. 大模型为 AIGC 提供核心能力"></a>1. 大模型为 AIGC 提供核心能力</h4><ul><li><strong>强大的生成能力</strong>： <ul><li>大模型通常具有海量参数和丰富的训练数据，能够学习到复杂的数据分布和模式。</li><li>这种能力使得大模型可以生成高质量的文本、图像、音频、视频等多模态内容。</li></ul></li><li><strong>跨模态理解与生成</strong><ul><li>现代大模型（如通义千问、Gemini、CLIP 等）不仅擅长单一模态任务，还能实现跨模态的理解与生成。</li><li>例如，通过输入一段文本描述，大模型可以生成对应的图像或视频。</li></ul></li><li><strong>零样本和少样本学习</strong><ul><li>大模型经过大规模预训练后，具备一定的零样本（Zero-shot）和少样本（Few-shot）学习能力。</li><li>这使得 AIGC 应用可以在没有大量标注数据的情况下快速适应新任务。</li></ul></li><li><strong>上下文理解和逻辑推理</strong><ul><li>大模型能够捕捉长距离依赖关系，并进行复杂的上下文理解和逻辑推理。</li><li>这为生成连贯且有意义的内容提供了保障。</li></ul></li></ul><h4 id="2-AIGC-是大模型的应用场景"><a href="#2-AIGC-是大模型的应用场景" class="headerlink" title="2. AIGC 是大模型的应用场景"></a>2. AIGC 是大模型的应用场景</h4><ul><li><strong>文本生成</strong>： <ul><li>基于大模型的文本生成技术被广泛应用于写作助手、聊天机器人、代码生成等领域。</li><li>示例：GPT 系列、通义千问等。</li></ul></li><li><strong>图像生成</strong><ul><li>大模型结合扩散模型（Diffusion Model）或生成对抗网络（GAN），可以生成高质量的图像。</li><li>示例：DALL·E、MidJourney、Stable Diffusion 等。</li></ul></li><li><strong>音频生成</strong><ul><li>大模型可用于生成音乐、语音合成、声音效果等。</li><li>示例：Music Transformer、WaveNet 等。</li></ul></li><li><strong>视频生成</strong><ul><li>结合大模型和时序建模技术，可以生成动态的视频内容。</li><li>示例：Make-A-Video、Phenaki 等。</li></ul></li><li><strong>多模态生成</strong><ul><li>大模型支持多种模态的融合与生成，例如从文本生成图像或视频，或将图像转化为文本描述。</li><li>示例：Flamingo、M6 等。</li></ul></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>在vue2的项目上使用vue3的库</title>
    <link href="/%E5%9C%A8vue2%E7%9A%84%E9%A1%B9%E7%9B%AE%E4%B8%8A%E4%BD%BF%E7%94%A8vue3%E7%9A%84%E5%BA%93/"/>
    <url>/%E5%9C%A8vue2%E7%9A%84%E9%A1%B9%E7%9B%AE%E4%B8%8A%E4%BD%BF%E7%94%A8vue3%E7%9A%84%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h1 id="1-业务场景"><a href="#1-业务场景" class="headerlink" title="1. 业务场景"></a>1. 业务场景</h1><p>当前前端项目是基于vue2的，使用的pdf预览的组件为vue-pdf-embed， 但是vue2下，这个组件只兼容到v1版本，会有xss漏洞，在vue3下对应的v2版本才修复了这个问题。</p><p>由于项目是个很老的项目，整体升级vue3工作量太大，所以选择使用Web Components 封装组件的方式，将vue-pdf-embed 封装为一个 Web Component，然后在 Vue 2 中使用。</p><h1 id="2-步骤"><a href="#2-步骤" class="headerlink" title="2. 步骤"></a>2. 步骤</h1><h2 id="1-创建一个-独立的Vue-3-项目"><a href="#1-创建一个-独立的Vue-3-项目" class="headerlink" title="1. 创建一个 独立的Vue 3 项目"></a>1. 创建一个 独立的Vue 3 项目</h2><ol><li>创建项目 <code>vue create simple-vue3-project</code></li><li>在 Vue 3 项目中安装 vue-pdf-embed <code>npm install vue-pdf-embed</code></li></ol><h2 id="2-创建-Web-Components-封装"><a href="#2-创建-Web-Components-封装" class="headerlink" title="2. 创建 Web Components 封装"></a>2. 创建 Web Components 封装</h2><ol><li><p>创建PdfViewer.ce.vue文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;vue-pdf-embed :source=&quot;source&quot;/&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import VuePdfEmbed from &#x27;vue-pdf-embed&#x27;;<br><br>export default &#123;<br>    props: &#123;<br>        source: &#123;<br>            type: String,<br>            required: true,<br>        &#125;,<br>    &#125;,<br>    components: &#123;<br>        VuePdfEmbed,<br>    &#125;,<br>&#125;;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure></li><li><p>在 Vue 3 项目的入口文件（如 main.js）中注册 Web Components。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123;defineCustomElement&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><br><span class="hljs-keyword">import</span> PdfViewer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/PdfViewer.ce.vue&#x27;</span>;<br><br><span class="hljs-comment">// 将 Vue 组件封装为 Web Component</span><br><span class="hljs-keyword">const</span> PdfViewerElement = defineCustomElement(PdfViewer);<br><br><span class="hljs-comment">// 注册自定义元素</span><br>customElements.define(<span class="hljs-string">&#x27;pdf-viewer&#x27;</span>, PdfViewerElement);<br><br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Web Component registered:&#x27;</span>, customElements.get(<span class="hljs-string">&#x27;pdf-viewer&#x27;</span>));<br></code></pre></td></tr></table></figure><p>这里为了减小js文件大小，这里我删除了main.js模版的本身内容</p></li><li><p>修改vue.config.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; defineConfig &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@vue/cli-service&#x27;</span>);<br><br><span class="hljs-built_in">module</span>.exports = defineConfig(&#123;<br>  <span class="hljs-attr">transpileDependencies</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 确保依赖库被正确转译</span><br><br>  <span class="hljs-attr">configureWebpack</span>: &#123;<br>    <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;./src/main.js&#x27;</span>, <span class="hljs-comment">// 指定入口文件</span><br>    <span class="hljs-attr">output</span>: &#123;<br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;pdf-viewer.js&#x27;</span>, <span class="hljs-comment">// 输出文件名</span><br>      <span class="hljs-attr">library</span>: <span class="hljs-string">&#x27;PdfViewer&#x27;</span>, <span class="hljs-comment">// 设置生成的库名称</span><br>      <span class="hljs-attr">libraryTarget</span>: <span class="hljs-string">&#x27;window&#x27;</span>, <span class="hljs-comment">// 将库挂载到 window 上</span><br>      <span class="hljs-attr">globalObject</span>: <span class="hljs-string">&#x27;this&#x27;</span>, <span class="hljs-comment">// 兼容非浏览器环境（如 Node.js）</span><br>    &#125;,<br>    <span class="hljs-attr">optimization</span>: &#123;<br>      <span class="hljs-attr">splitChunks</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用代码分割</span><br>    &#125;,<br>  &#125;,<br><br>  <span class="hljs-attr">css</span>: &#123;<br>    <span class="hljs-attr">extract</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">loaderOptions</span>: &#123;<br>      <span class="hljs-attr">css</span>: &#123;<br>        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 压缩 CSS</span><br>      &#125;,<br>    &#125;,<br>  &#125;,<br><br>  <span class="hljs-attr">productionSourceMap</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭生产环境下的 source map，减少文件大小</span><br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p>使用npm run build构建成一个js文件如 （dist&#x2F;pdf-viewer.js），其中包含了封装好的 Web Components。</p></li></ol><h2 id="3-在-Vue-2-项目中使用-Web-Components"><a href="#3-在-Vue-2-项目中使用-Web-Components" class="headerlink" title="3. 在 Vue 2 项目中使用 Web Components"></a>3. 在 Vue 2 项目中使用 Web Components</h2><ol><li><p>将打包好的js文件放在，public目录下</p></li><li><p>在index.html中引入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- public/index.html --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;module&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/pdf-viewer.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在其他视图或组件使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;pdf-viewer :source=&quot;url&quot; class=&quot;m-auto&quot;&gt;&lt;/pdf-viewer&gt;<br></code></pre></td></tr></table></figure></li><li><p>在main.js 忽略这个自定义元素，避免报错</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">Vue.config.ignoredElements = [<span class="hljs-string">&#x27;pdf-viewer&#x27;</span>];<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>xss跨站漏洞</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java禁止上传带有js脚本的pdf文件</title>
    <link href="/java%E7%A6%81%E6%AD%A2%E4%B8%8A%E4%BC%A0%E5%B8%A6%E6%9C%89js%E8%84%9A%E6%9C%AC%E7%9A%84pdf%E6%96%87%E4%BB%B6/"/>
    <url>/java%E7%A6%81%E6%AD%A2%E4%B8%8A%E4%BC%A0%E5%B8%A6%E6%9C%89js%E8%84%9A%E6%9C%AC%E7%9A%84pdf%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<p>防止上传的pdf文件中，包含危害的Java script，导致的XSS漏洞</p><h1 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.pdfbox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pdfbox<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="2-编写工具类"><a href="#2-编写工具类" class="headerlink" title="2. 编写工具类"></a>2. 编写工具类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.siemens.mmf.sith.utils;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.cos.COSArray;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.cos.COSDictionary;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.cos.COSName;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.cos.COSString;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDDocument;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDPage;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDPageTree;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDResources;<br><span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.font.PDFont;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.regex.Pattern;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PdfFileUtil</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Pattern JAVASCRIPT_PATTERN = Pattern.compile(<span class="hljs-string">&quot;(?i)javascript|alert\\(|document\\.|window\\.&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检查PDF页面对象和页面中的字体资源 是否含有恶意的 JavaScript代码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasXSS</span><span class="hljs-params">(MultipartFile multipartFile)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            PDDocument document = PDDocument.load(multipartFile.getInputStream());<br>            PDPageTree pages = document.getPages();<br>            <span class="hljs-keyword">for</span> (PDPage page : pages) &#123;<br>                <span class="hljs-keyword">if</span> (hasXSS(page.getCOSObject())) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125;<br>                PDResources resources = page.getResources();<br>                <span class="hljs-keyword">if</span> (resources != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">for</span> (COSName fontName : resources.getFontNames()) &#123;<br>                        PDFont font = resources.getFont(fontName);<br>                        <span class="hljs-keyword">if</span> (font != <span class="hljs-keyword">null</span> &amp;&amp; hasXSS(font.getCOSObject())) &#123;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">&quot;read line exception&quot;</span> + e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检查JavaScript并递归检查嵌套对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasXSS</span><span class="hljs-params">(COSDictionary obj)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (obj.containsKey(COSName.JAVA_SCRIPT)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 递归地检查字典中的所有嵌套对象</span><br>        <span class="hljs-keyword">for</span> (COSName key : obj.keySet()) &#123;<br>            Object value = obj.getItem(key);<br>            <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> COSDictionary) &#123;<br>                <span class="hljs-keyword">if</span> (hasXSS((COSDictionary) value)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> COSArray) &#123;<br>                <span class="hljs-keyword">if</span> (checkArrayHasXSS((COSArray) value)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkArrayHasXSS</span><span class="hljs-params">(COSArray array)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; array.size(); i++) &#123;<br>            Object element = array.get(i);<br>            <span class="hljs-keyword">if</span> (element <span class="hljs-keyword">instanceof</span> COSString &amp;&amp; hasXSS(((COSString) element).getString())) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (element <span class="hljs-keyword">instanceof</span> COSDictionary) &#123;<br>                <span class="hljs-keyword">if</span> (hasXSS((COSDictionary) element)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (element <span class="hljs-keyword">instanceof</span> COSArray) &#123;<br>                <span class="hljs-keyword">if</span> (checkArrayHasXSS((COSArray) element)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasXSS</span><span class="hljs-params">(String value)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> JAVASCRIPT_PATTERN.matcher(value).find();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试文件地址：<a href="https://oicu0619.github.io/poc.pdf">pdf</a></p>]]></content>
    
    
    <categories>
      
      <category>工具类</category>
      
    </categories>
    
    
    <tags>
      
      <tag>xss跨站漏洞</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker-compose实战</title>
    <link href="/docker-compose%E5%AE%9E%E6%88%98/"/>
    <url>/docker-compose%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-常用命令"><a href="#1-常用命令" class="headerlink" title="1. 常用命令"></a>1. 常用命令</h1><ol><li><p>前台启动, 启动项目中的所有服务 <code>docker-compose up</code></p></li><li><p>后台启动, 启动所有服务并在后台运行 <code>docker-compose up -d</code></p></li><li><p>重新编译文件并启动  <code>docker-compose up --build nginx </code></p></li><li><p>停止所有服务, 保留容器<code>docker-compose stop </code></p></li><li><p>停止所有服务, 删除容器<code>docker-compose down</code></p></li><li><p>删除容器<code>docker-compose rm -f nginx</code></p></li><li><p>重启容器</p><ul><li>重启所有服务的容器 <code>docker-compose restart</code></li><li>重启指定服务的容器 <code>docker-compose restart nginx </code></li></ul></li><li><p>启动容器</p><ul><li>启动所有服务的容器 <code>docker-compose start </code></li><li>启动指定服务的容器 <code>docker-compose start nginx </code></li></ul></li><li><p>停止容器</p><ul><li>停止所有服务的容器<code> docker-compose stop</code></li><li>停止指定服务的容器 <code>docker-compose stop nginx </code></li></ul></li><li><p>进入容器</p></li></ol><ul><li><code>进入指定服务的容器</code> <code>docker-compose exec nginx bash</code></li></ul><h1 id="2-实战使用"><a href="#2-实战使用" class="headerlink" title="2. 实战使用"></a>2. 实战使用</h1><p>部署项目tms</p><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h2><ol><li><p>在目录home&#x2F;userxxx 下创建文件夹 tms及相关前后端文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir tms<br>cd tms<br>mkdir deploy<br>cd deploy<br>mkdir backend<br>mkdir frontend<br></code></pre></td></tr></table></figure></li><li><p>安装docker, docker-compose</p><p>Docker 注意修改默认挂载地址</p></li></ol><h2 id="2-部署中间件"><a href="#2-部署中间件" class="headerlink" title="2. 部署中间件"></a>2. 部署中间件</h2><ol><li><p>middleware目录下上传docker-compose.yml</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">cd</span> deploy<br><span class="hljs-built_in">mkdir</span> middleware<br></code></pre></td></tr></table></figure></li><li><p>使用<code>docker-compose up prod</code>启动redis，rabbitMQ，postgresql(需开放对应端口或后续修改nginx配置通过nginx访问)</p><p>docker-compose.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">tms:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">rabbitmq:3-management-alpine</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">RABBITMQ_DEFAULT_USER:</span> <span class="hljs-string">guest</span><br>      <span class="hljs-attr">RABBITMQ_DEFAULT_PASS:</span> <span class="hljs-string">guest</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;5672:5672&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;15672:15672&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime:ro</span><br><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">6379</span><span class="hljs-string">:6379</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime:ro</span><br><br>  <span class="hljs-attr">nginx:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;80:80&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;443:443&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/config/nginx.conf:/etc/nginx/nginx.conf</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/config/conf.d:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/ssl:/etc/nginx/ssl</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/logs:/var/log/nginx</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/html:/usr/share/nginx/html</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">../frontend:/home/deploy/tms/frontend</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime:ro</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">xxl_job</span><br>      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">root@1234</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root@1234</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql_data:/var/lib/mysql</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime:ro</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="3-部署vue"><a href="#3-部署vue" class="headerlink" title="3. 部署vue"></a>3. 部署vue</h2><ol><li><p>进入前端目录，上传dist目录到web目录</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">cd</span> frontend<br><span class="hljs-built_in">mkdir</span> web<br></code></pre></td></tr></table></figure></li><li><p>更新nginx.conf配置, 并重启</p></li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">user</span>  <span class="hljs-string">nginx;</span><br><span class="hljs-string">worker_processes</span>  <span class="hljs-string">auto;</span><br><br><span class="hljs-string">error_log</span>  <span class="hljs-string">/var/log/nginx/error.log</span> <span class="hljs-string">notice;</span><br><span class="hljs-string">pid</span>        <span class="hljs-string">/var/run/nginx.pid;</span><br><br><br><span class="hljs-string">events</span> &#123;<br>    <span class="hljs-string">worker_connections</span>  <span class="hljs-number">1024</span><span class="hljs-string">;</span><br>&#125;<br><br><br><span class="hljs-string">http</span> &#123;<br>    <span class="hljs-string">include</span>       <span class="hljs-string">/etc/nginx/mime.types;</span><br>    <span class="hljs-string">default_type</span>  <span class="hljs-string">application/octet-stream;</span><br><br>    <span class="hljs-string">log_format</span>  <span class="hljs-string">main</span>  <span class="hljs-string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="hljs-string">;</span><br><br>    <span class="hljs-string">access_log</span>  <span class="hljs-string">/var/log/nginx/access.log</span>  <span class="hljs-string">main;</span><br><br>    <span class="hljs-string">sendfile</span>        <span class="hljs-string">on;</span><br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><span class="hljs-string">autoindex</span> <span class="hljs-string">on;</span><br><br>    <span class="hljs-string">keepalive_timeout</span>  <span class="hljs-number">65</span><span class="hljs-string">;</span><br><br>    <span class="hljs-comment">#gzip  on;</span><br><br><span class="hljs-string">upstream</span> <span class="hljs-string">gatewayservice</span> &#123;<br><span class="hljs-string">server</span> <span class="hljs-number">10.64</span><span class="hljs-number">.192</span><span class="hljs-number">.112</span><span class="hljs-string">:8001;</span><br>&#125;<br><span class="hljs-string">upstream</span> <span class="hljs-string">xxlJobAdmin</span> &#123;<br><span class="hljs-string">server</span> <span class="hljs-number">10.64</span><span class="hljs-number">.192</span><span class="hljs-number">.112</span><span class="hljs-string">:8200;</span><br>&#125;<br><span class="hljs-string">upstream</span> <span class="hljs-string">kibanaService</span> &#123;<br><span class="hljs-string">server</span> <span class="hljs-number">10.64</span><span class="hljs-number">.192</span><span class="hljs-number">.112</span><span class="hljs-string">:5601;</span><br>&#125;<br><span class="hljs-string">upstream</span> <span class="hljs-string">gitlabService</span> &#123;<br><span class="hljs-string">server</span> <span class="hljs-number">10.64</span><span class="hljs-number">.192</span><span class="hljs-number">.112</span><span class="hljs-string">:8090;</span><br>&#125;<br><span class="hljs-string">upstream</span> <span class="hljs-string">rabbitmqService</span> &#123;<br><span class="hljs-string">server</span> <span class="hljs-number">10.64</span><span class="hljs-number">.192</span><span class="hljs-number">.112</span><span class="hljs-string">:15672;</span><br>&#125;<br><br>    <span class="hljs-string">server</span> &#123;<br>        <span class="hljs-string">listen</span>       <span class="hljs-number">80</span><span class="hljs-string">;</span><br>        <span class="hljs-string">server_name</span>  <span class="hljs-string">plm.innomotics.net.cn;</span><br>        <span class="hljs-string">rewrite</span> <span class="hljs-string">^(.*)$</span> <span class="hljs-string">https://$host$1</span> <span class="hljs-string">permanent;</span><br>    &#125;<br><br><br>    <span class="hljs-string">server</span> &#123;<br>        <span class="hljs-string">listen</span>       <span class="hljs-number">443</span> <span class="hljs-string">ssl;</span><br>        <span class="hljs-string">server_name</span>  <span class="hljs-string">plm.innomotics.net.cn;</span><br><br><span class="hljs-comment">#ssl证书的pem文件路径</span><br>        <span class="hljs-string">ssl_certificate</span>  <span class="hljs-string">/etc/nginx/ssl/S0004A05_plm.innomotics.net.cn.cer;</span><br>        <span class="hljs-comment">#ssl证书的key文件路径</span><br>        <span class="hljs-string">ssl_certificate_key</span> <span class="hljs-string">/etc/nginx/ssl/plm.innomotics.net.cn.key;</span><br><br>        <span class="hljs-string">proxy_set_header</span>   <span class="hljs-string">X-Real-IP</span> <span class="hljs-string">$remote_addr;</span><br>        <span class="hljs-string">proxy_set_header</span>   <span class="hljs-string">X-Forwarded-For</span> <span class="hljs-string">$proxy_add_x_forwarded_for;</span><br>        <span class="hljs-string">proxy_set_header</span>   <span class="hljs-string">X-Forwarded-Host</span> <span class="hljs-string">$server_name;</span><br><br>        <span class="hljs-comment"># Header for SocketJS</span><br>        <span class="hljs-string">proxy_http_version</span> <span class="hljs-number">1.1</span><span class="hljs-string">;</span><br>        <span class="hljs-string">proxy_set_header</span> <span class="hljs-string">Upgrade</span> <span class="hljs-string">$http_upgrade;</span><br>        <span class="hljs-string">proxy_set_header</span> <span class="hljs-string">Connection</span> <span class="hljs-string">&quot;upgrade&quot;</span><span class="hljs-string">;</span><br>        <span class="hljs-string">add_header</span> <span class="hljs-string">Strict-Transport-Security</span> <span class="hljs-string">&quot;max-age=31536000; includeSubDomains&quot;</span> <span class="hljs-string">always;</span><br><br>        <span class="hljs-comment"># 访问所有目录都默认走到</span><br>        <span class="hljs-string">location</span> <span class="hljs-string">/</span> &#123;<br>            <span class="hljs-string">root</span>   <span class="hljs-string">/home/deploy/tms/frontend/prod;</span><br>            <span class="hljs-string">index</span>  <span class="hljs-string">index.html</span> <span class="hljs-string">index.htm;</span><br>            <span class="hljs-string">add_header</span> <span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>  <span class="hljs-string">*;</span><br>            <span class="hljs-string">try_files</span> <span class="hljs-string">$uri</span> <span class="hljs-string">$uri/</span> <span class="hljs-string">/index.html;</span><br>        &#125;   <br>        <span class="hljs-string">location</span> <span class="hljs-string">/api</span> &#123;<br>    <span class="hljs-string">rewrite</span> <span class="hljs-string">^/api/(.*)$</span> <span class="hljs-string">/$1</span> <span class="hljs-string">break;</span><br>          <span class="hljs-string">proxy_pass</span>         <span class="hljs-string">http://gatewayservice;</span><br><span class="hljs-string">proxy_redirect</span>     <span class="hljs-string">off;</span><br>        &#125;<br>        <span class="hljs-string">location</span> <span class="hljs-string">/xxl-job-admin/</span> &#123;<br>          <span class="hljs-string">proxy_pass</span><span class="hljs-string">http://xxlJobAdmin;</span><br>          <span class="hljs-string">proxy_redirect</span><span class="hljs-string">off;</span><br>        &#125;<br>        <span class="hljs-string">location</span> <span class="hljs-string">/so-kibana/</span>&#123;<br>          <span class="hljs-string">proxy_pass</span><span class="hljs-string">http://kibanaService;</span><br>          <span class="hljs-string">proxy_redirect</span><span class="hljs-string">off;</span><br>        &#125;<br>        <span class="hljs-string">location</span> <span class="hljs-string">/so-gitlab/</span>&#123;<br>          <span class="hljs-string">proxy_pass</span><span class="hljs-string">http://gitlabService;</span><br>          <span class="hljs-string">proxy_redirect</span><span class="hljs-string">off;</span><br>        &#125;<br>        <span class="hljs-string">location</span> <span class="hljs-string">/so-rabbitmq/</span>&#123;<br>          <span class="hljs-string">rewrite</span> <span class="hljs-string">^/so-rabbitmq/(.*)</span> <span class="hljs-string">/$1</span> <span class="hljs-string">break;</span> <br>          <span class="hljs-string">proxy_pass</span><span class="hljs-string">http://rabbitmqService;</span><br>          <span class="hljs-string">proxy_redirect</span><span class="hljs-string">off;</span><br>        &#125;<br>        <span class="hljs-string">location</span> <span class="hljs-string">@router</span> &#123;<br>          <span class="hljs-string">rewrite</span> <span class="hljs-string">^.*$</span> <span class="hljs-string">/index.html</span> <span class="hljs-string">last;</span><br>        &#125; <br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-docker-compose部署后端"><a href="#4-docker-compose部署后端" class="headerlink" title="4. docker-compose部署后端"></a>4. docker-compose部署后端</h2><ol><li><p>backend对应目录下上传jar包和docker-compose.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">tms:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">eureka-server:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openjdk:17</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">eureka-server</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8002:8002&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./eureka-server:/home</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/home/eureka-server-1.0-SNAPSHOT.jar&quot;</span>]<br><br>  <span class="hljs-attr">gateway-server:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openjdk:17</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">gateway-server</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8001:8001&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./gateway-server:/home</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/home/gateway-server-1.0-SNAPSHOT.jar&quot;</span>]<br><br>  <span class="hljs-attr">auth-service:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openjdk:17</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">auth-service</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8003:8003&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./auth-service:/home</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/home/auth-service-1.0-SNAPSHOT.jar&quot;</span>]<br><br>  <span class="hljs-attr">user-service:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openjdk:17</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">user-service</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8101:8101&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./user-service:/home</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/home/user-service-1.0-SNAPSHOT.jar&quot;</span>]<br><br>  <span class="hljs-attr">assistant-service:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openjdk:17</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">assistant-service</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8004:8004&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./assistant-service:/home</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/home/assistant-service-1.0-SNAPSHOT.jar&quot;</span>]<br><br>  <span class="hljs-attr">tms-service:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openjdk:17</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">tms-service</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8103:8103&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./tms-service:/home</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/home/tms-service-1.0-SNAPSHOT.jar&quot;</span>]<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>场景题</title>
    <link href="/%E5%9C%BA%E6%99%AF%E9%A2%98/"/>
    <url>/%E5%9C%BA%E6%99%AF%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="880f1ca7e6e3202ccc43714be7d8959b35473292c2136f762ef76dd6fd3c64c8">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c090fb0898ae6bb2aa2ea7308973392d5a21b5b1329ec9fabf4fa205482703467268be04cc0d38e1c07ac607232452007c3bbccd6bb1abf7abe3777f2d7135e6f6ef151f4a0659b15ce60db48816db7ab84132d1ebeafa1b324ea74c7dd076b5e3342d2d638106fb208150994628031e9f9333a9c375ca9e3d460df31e68612232890856b5ac91856841266644441c06c689f019ee745fe7fe3cb4756a08faee10e8557bf67a7c27b869ce98c4a60b831fcbe9d8782ef57330cb9e84d9f16e504b75c26b0ca98fcf8206693c7ef20b95bc9c89bae3e002ecb4d57cf355925f347ead2a829faf28cf0630e7b820d62dfcbfc63d37b76f2b25c748b306cee723d9bebd68c13d1496d8e51ffdd30f80219d3ad7fcd4fc12fc63d55580406fcd49709736dd42fc45cc76b74f8887a56229c66bb552227796102b3ea9ba75c44762fe93dbc0d66cc54ae8d2d89dd959d5090edbec7ce59ddeb6d560cc6f689cda2d98dce93f1fbb544400ee80e0d1b673b12534c51e45996e97f9bf3ccd11e1506f0e153629f7d37c798c64213a5add16f2fc417274d892a0b4da394ba43485ee0da5df979b3ae7ca2cdcbdbec0e9c303ec384d889aa0ab6099943a5d388063bc63d3edd226a3119cc2fe7266e8141492f57d33d609ffb578bfbd5f1e9d86dd491ba1858ab1208208e0d9cdef83cafbd8db19754e1d6abe57caef1e942d9c16c79192b258d7f2bab995588f3459c06e2627e0a41e8aefc53765ef831e33cab1a75fdaad5ebe4f5859394799123877ee6dbb2f26f51fb5926db8a9414376dd9b11f8b564a2463912010c00d7a0579f0f851f9d8d8c9caee7690bdf532c63fc16ab0626d0cbb1dee9ce61aa7f59a3faed0cda51aa9cc571815adb2b072717f2adb4b696e2d8679244053b5d872002f8e536226237306e0228438deb0380edb9dd95d4531631b0b57daeddd1480ec7e9a889ae0be5f3303f8f46b03007b13ce63d61908c785964e5f56a1c4d43312aba9c8bf14f719e418ba1811d4a63a29a9a1c735515bf4f9e333a8a984d58fc22ff862ae1317a8b9659a1fcc026ec7835b2b267696717c445b7edb8cc4fd01f50def89c7bc4829a7828f479fb690aa8113c14223c6f9e0e7965a0ad938e939fbc275d92ff7a927ed2b84499ac45c78d5c8d78d992422ed6ff9e763a009d83846fbe1fb87e7dcebbad17514cb851907c8bb25c70c8ac7bcfd787777178cf4bf716137ef8950463488ec90219bb609fa8024505ff58517749ff01af6dc0ad19ee2a887565b8573562243595b320c02b6df66ec4ef9c0a1d50fc827381aba870e34a9deab1964d7b015ad473dc145eb4115fdfe6d16457549ea5cc5a3b76bf42ddb9e89c87216278196cdad07ef97b8a228b4fd0ffc2dd8956b97d13f25472064be0995760211e607a4b3200ea088a8d8279635f4ce7da9ec091432ad5f61262960eae92ec21cc92c82c599f63cf1480c16f4e5a4709380e72e4346806f85c7975505670a13155b822becacd80adbdc55c0c75ee14c516d859bc536b7c8beba10881f438b4e3758d793a47a0df7e7a1af128aaa08d5cca421e66fca02cf8fb08041393d9d9daeccff42b0f786644b6a4dc163aca16bd5026cfd1a8a75615f52adefb79c2fb05615af3019e33c5cfbe92d016fa0a1417b36c5d0a17cef8bfc5b16d71a08c2aaeb43aef1fd7fbad34a2a21e321043898db72ef524863cf9562aaed3ee6163211c4cca2c441ea7d4d68e7a65abf6affad46df68e063b1d8025a10bffba46787052404908a6bb844eb5f8714738a8c3092fbb71a8d95cc5eb082611a481efc9c4fe9a115a2e9bf87a3e70764a93bad81ec606da159bbe09d7ac3f3fbdcec02f4b10109227d733154a2614f7ff51f62421d8df128b61d86f106f5818bbdce73e63dc927258bf92fd57de7f792f9255617598361d9058ea33be8fcfcb3b257d8212511a8f52652e485cc51ad7c8d0912c7c795ae88badf32cf507b82ee52da672dc3302ddd8dc1afe477ced1e634d16c5bba2dea86f30bb92b956ac9203b7d6280d3702ab6ae10b1f28cdecc79007855328695095e5ff8faea7924c4778159d48ea859490fbd8ca47de7cc90ddd1b5f2d5180f677f4c68b2548f53d363252eecc61b44e1be00d1612188aa84630ceb322839ebe8a535cec77450c5ea1370b7de6d86ea5b4f0a4de2a82a90cc1460e2c617359951c2ac4c7f439bccddff4e9aa082a8080680c93802c528feae8a481afa47e6bdda524c489e11d93c17b26ff2d4a02787eaf6726713f58c335b3a75a8e71ff617db1ea6b0192139e74dfec512bd4f9d79d4f79742dadae3f9951383a9e66abd95f32372540a5ae6e82c0a6d390f16078877452f475056c19799ba3df01ab45ed70c6d0ce4e47e341fba393b39495419e1ec3a99d6c03c4e2aeccd7a1928e9bdc298596199af5d257635041950fef427bf62c1b304e93002bc0084b4d5a93b9628e8a6f77b0be106e13d218f793bd6f8130ebda736f1b6edadd9ca9cb555b90ba97d19da39eb1293b1dc9a043f113aeffe6024f6588cec330623cecf393403457874997e2db8cc41a5b8774bed463b9e7c8eb19dcbfdb113916991ce1d3fbeb52aff7c9a41abe9d278a0f0ce983db70b4105ac360d1a4c2414b62051fd18f9cff7ae682b4d91c7c408343c72dc5cd4e86260449cc6227b09f1e4d46f66e79a3f6ee4ec9179b5b67abbe542a6f4dfa1edbd3e3d9b5eb4b52931f1e336878854d1826342de75bcf6db68f4f8a07525c6008551cfa70e94d66b10a6c5631496b978ede1c989477e1cac2a465b698c22e215284aff88d8609599582007304d816945fcfac00ef4652ba661777493696b75a661e28795f1b0904794be86fba6324c3e7c1856409705e8015793363ecc1c590625e2d8bfedbc97fc490ba09617334fc5117bb6aa72b70a3afdbe6c6275e2ec9e68bbc7db1093b2ae2a8a4d93d0fb5a8410d4c3af7d8fcdb0ca15b9705de162f081beef30cb54d03bceeaf2fcaa01422f95f5102ded1cbaa181e641a46c07345426e5c3a2c71bb372c03d7cffc030188f11c2cda2cf91b9a5cce07910c1af9d3778b3c0230a1cf2b848f1407158ea4ed9d5c683e9cd280cc7e08e16b5fa41116178de867362c81e5c1b5a18cb4027501add1dd6149222d8c5d6fdf1a5203b76baefcd51f3870f7e13abc47298a6a7f291a0005ae56fb3e40c310fff5a676fc1ff79aaadc9073a1e253e95cd7f90a3a656d1cad4b79783cd5df46074d196b073b9d7a9028902ce9c8b4ea7111a742438f17af0c11c8a9acbc0e65769301c0b7dd6f68f1979cbcd84c923c5660b14ca7346518d6f9d7891d9c80c35a74b9ecd0dc3016e63c1ca360a035a97cdfe49f8f1f71f54d2f33450b4115479ce7e81ed63cce5970bfdb510c8e5c3e7a00705dd5a91c94292853a2e441641378ae6b1acedde730ebd8b2edca4a3c2a6df76e33109402f1e1e9ae364b0e1bed13a64bc7e22dfd8f9490431679f01308625c7e0c04e90d282dd4c62f124eb576c2242056bd7b3c7126b7a0628b8a348b903f4309d0126c153e2a55d8afc77d518d31ed133f1c3a15ab9b6e5eda2ed2c7d85aea2ffa16fe1f54846ea8f55eb5e4c92b111de01c95ea52b0481c6a58cb4d938bf3936334318909c3081ba55c0ec2c003b3705d1422e5ccbe80bedaf39c559d8cc368a08d8c865950f4c4bfdbe12ff54e82daf690b7e81d98cb7aba87ae7e16408e3c48ea3b8c385c5789d0d261152765a3e2ca17d40396917ae458c031204faa91db2ffa4803796182a0704ae905480dc382af603875e232cbff2e1999156222a3e123209d5f32c9a29fe6dbd54242d9ff5057b774f2d4eef2bc40fb37b344b54dea14715d1546ff7905cbc0a2ff43ab5ee1015a48e778e826cac0ce83c35e9dfdd5b890c6805735c5307cba60681c29fde3d6d2ab1f130a40106ba49c3938d39a386184817e44762640849d621b918fd6cff9d29d48f75cbef909f956f89cb61d056d074a91411ff65d44a2738d49e78c3b2fd90c69cb2d35e65b4bb82f3d1857cae1f567f103ac260f5adf7d3cd7dffe94612317484ebdc3f16e2cc9e8414878a932aa592942e7355bf25c00c1904974a3c432e09dfdf28243d34808c1df6197df8eb18eb9beb8ad65a2a3971bcaa2f4dd786f7c210ea31a6ff26646c84f40c996e26585986c3ba7120f668ce19673c40c9d85734f18cb8227653864f1c5e58e8d743c33ebe600cf69cca239dab0e1528ba9387c7f080dae6b8c94d8e3c91ba247ad1c5b4659db2a14a13acbd3bf37dffe3690d43d02d845f86a25ef9336d72994be5aed952433d9360f9edca566dc909a5cb895439f212d442b74846ddaa73a4bbbcce02f8cdb1d0dc8a5af7d4cf65b3595ddfcdc873366062087817df59bebd2aa99f01cb1ca8ee3fdb40561d543e1be44d304fcac249c4ebf0b94238cce6cc158ed397c5c81e2499a28192943a4718bf9f76391c28e9593345491831932c622f25edc05a476730e0a269875029e63e1433cb348689ba46490d570a49510fc27437eb9b36173ee76e2bcfe81211000aa7146cbe9a13575df1e0106e79590290a36a6f562d6ce1ef114ca38e65324bcc7915607d1881d8571ff1fadb043d37e31aaeb6f7bf9c8922cb9ef1cdf84f2e02fa6bd6b5a71d1b50f6bc4531acd9ee0df6ca7652f732ce3de1aca50563844201a76c8a0286fb0f2f0a197d7b44a48de52df3346352962321cfeb400ff9ac12e91793313f967cd34108f6b0fa079ebd8e7d87b6e9c5e75734c8f8008ed09f04e6f4b52a5e9e6a58a3576e7f99f4eeb53c8433e2ce5a5ff30b6ad82026c5819ec88756d99db08541af647d2cfbe7d10df975ef9057b3d1fae5eb5c29ab1a6e449c8be12a7afaf8d2498db7c58b7cc6774c0f7875e8bae0396abd4950e131d27c86a744f00e87768f6ddbe34ad2cbce3258b6dc0044cd9c7fef107da969e8aff0449c66f6a72b5cbadd57244c947429483da4358e10202bef6e67a9e421ecf21a846025eee544ef082409a19e685060e923b205f8ca46f5f83a96f2f12932ea6c0391b30d05060baf2b326778e33fe6cf81b2ea62de9b766a5208ffb616ae9e62dc679bd77951ebd9aa68c0acf41270374f0a1354beee1bda2d55de041faae726495df19eafca07b72f7cc4bc436b76f682fe11fc3f34bbdd09a48da1c7313fffeeb35cf31075ab3d37e0c8e5cda5e07d0d6d64fb97ef6d1f0f3f261e31e9ca2bc0d741debf21942c5d50051bc36b0d5f29e18adb3798d736fae84c72501cb8397b6f7317c49a9d26168e8a5d4ad076a4a06ef322f1c4b225dbcea8b1a0d531ed2901983019974be2d1ce800be00376d80f7fd5a962b8ffe963c625dace557a273485da0b3fe8d69f21366293e68e955c6a60c4bdfa4dbde28ef00846d232e2fca595401d677b82377a17603382f2d07db648ec691984329de6a57a395c3da61f92f273980eda199e0b5384bd83d27b630ff690278c44912b7e95c27001457763179fbd9c742193b8920b92d7097c2c70f54248cd281e4c810a331564239d152e1d36d0232ff15681a6bc6846fd461e05ab0b32fdd1e6ecd112087d2c090ebf4a2ac3cea8a22a7acf2adb09e55f76b0744799626a9e9c90f003a44b44638837eb7985106f5579e4d238bfb8f329570109c9d3a64b7d0ff658b6de0b561a2a17b8819cb82943b3a2373776ad0967c1566de2bc60377cea17ddb87bfc4905939d2d301110442a9f1089e63613a54ddc9dc5c8f7a45efec4c12154621f4638783ce56ce8683df280b5cba024b371c20dbcf49e2b0b2d5292165da9b4ec534eb16eea3ceebd322717e5d034534100656e145b29e683eb69f7e7b4c07833239429e2ff550c2074dd56874032490151a552fe0bde37d37fc2e0e78f1654f230ac4957cc882bd830de815e23568a66dcfef70433e384fda56ea41bc40ed6a10a88bdbba8380d16c3eee5c42c5bbbbb02a32cc366ae59712ea25b2470bcb45404f142e51cdf388687698c80a8661efac861ca7bdf56a103bea8cfbdb4c7b61342d2de0e3ab10f12d6253d87476b10c4f95f02180105852cf354958dd6aa91392484acfd69bf54df2353a3a0097607e2d64fe4e023a3751a819a88723fc49f4e125e9e4f17961a5d2c8d33402117346b49111135f5a56645ce4cae9e1e2fc19f152f3c31b7f7eab71ed7684c1adf4b4f8ba63414dbc8f1a65d753243277beef4568f7460e637814949cf779906b1138c99fd172b282e5ba7bc218e819cb27bf6014662bcc7973462f0fe80873c93b22cc74d98c968be494121a53f5e40ce9a241b48025d10460b0f2dc676b91b0ba1547b716f8875342482f559a47703dcb32154069612940d2f0e53f673d715ecad0d14faadcc7c37b3c35961934ad86c06ea8b5367301c61773c19a46e5e8951528109e9353cf9962b7407b0037a559727486b418d5aa9bf44598d0bfaf7e31ac819e6cfdf1217db849b9e6a364991a9754f8969b508ab24b5c4805bc38482948f680d2eb87ed374739491dc1f16efec7c71575aa019b4d8bd5398362076d8e36dc71fec076543a1681780fbc89b4480ab21cad2cb7aa54067badebf76a1dc6e75c0980cd4ce49ea46a83c2567d5c9798c9941070cf7bff5cb94e424ba88b76550f8ce0c574001f7603c0b37f2b57edc87c015ee0d9fee190f146deb49faac2b2a75264c6dff4a4ba95a2b99f62526832fda1cf11e64756875ad19b3822640e51627a7893c60595b6b05b5fb64e09f5a162a115a5cd2f6c20f6848a369e1888189977f7d0e7b41a3d04b81c6b7a83be8c91b7536813e17eddd3950d078bb0335098859097e9d562a7bf7e2c45017f9b3cb2650349c65eccb4d407a4867679d2dac85d2d07ad37934715f5ebbbb0394a26112d3b9693edbc4783471ff73e49cdef02f8246b6aef4305e6139d6dfb0afd16996d1c41b13eb078bcad5e00fe7c74f08155eda19935cef894ae24d366c4d82c20c09f8a83f2128490d388dd197e7b81b4d16e7a822db1c6f3b9d33568cf24907963cdb09b66a99bdb86dca8026fc00423f9f0484347aacc38a2dfce2266d70a2777899ceb2b7bd49efb2ad2a5c2815692c552e706d8f23f0b90871bc6d77645ba326f4f3221bc9f73b6bc419afd6ac428f6a67ec59c836c4887600040c7f431d6f0dd8509387847af703ad1d9e01d81e6e0f0589216c089b0b1ae53df6856e5ac8282173ed7c5858583505b8124f1b8710b3029bfe72f9adbd3281daa64406900d254024e3be0b371e6aed21281d80b25fff84f624c2df13d0e1d663ee3689d578c653ccaa5daaccc49ef5f58f758fda54622cac3b5c8dc785397a08c4061eadc64de14d6cac8a7cca2d39c9044316e2e34d1221f878e40d38f426b915dcf88981e91b47fc163123239456b3539853ba4024a7f61c44c3bb65d161bae062d1c3f13da13d14478ffb818dfc2036ad9904eb1f19b660ba23fb5051b972545d5fc077d05d4f374930ffcfba6b06aa5ec4d8995bd1a9cfecb9796cb5c82835de781432abd89058334d60aab550b6cd7fcd309b49b453f32609e0af3c571539c0377376af9fbecfb6078efc4f9d60ba92bcfb17e48a74282c917ddb27f5a4ee61f33800d25dc72debfb79a3e193308eaf94c92b9803035328627978b3a5d5e3298da0cf652648a87714203ceb2a7f764de3ec85230bb0af7604a407f15c32d16d55f657954121c88ef6178e70b1a003343e068de8d56627878a2bab05737b32a044e685bd4f1dc4af19a641b320a775cfe3f123226b0ea53fcfc5293ca2d202b7b799ebc5a5e69773e9f7d321213dba6eb44cbcc0bd3570d09a9d8265860a2b42b7bcb1d2295b109077e6268df6989a134df458c3742322038a83d456064369d7b59b4b7dfa1eed751df708be88d3077fe225a1c755013c9b4e6c1f2491f8c5ed9ede2144c24b0c973d50d71e7b7103b2f3b9ef2fc57414245ea51c0797418da59ee383a275fc55d05e7b8d916dd72e279be5842c866feee9c777fdc8b910108706bc65f9bd4ce46c1b1478565960b20aba51376533b57e3be6549ca91f35ff82d06c6148a9c1ff4c8bf9f9cfd826d400257a40d6890a28adf348df36738dec6465cf55a4ab3773b47dcc58afc9bf0b62500cc2a94022e474f1643107450c1534b4fe51a13df43e13b27147a60953e5986fea474b9cb507f8ab56f581636dd18587010b6a5d9ea44a2472f270f4e3be8040475a0c1373854ac34d806aa3c7dc641f75b3734533109a66e215f5df4f5d0130d897e17f0dc6f55d028c1c97c7a8e5ee916283ee7e18368737590600cd5e5ad59f0c25986bda25c8ffd45dfcc3dcc6d0557b205fe52743efbdeda4e3b5d4ff33073cb8296f25f0f8237929b21432c9335da49e843a443ad1df0d296511f9837ca243a1d9e98c07d050d6d18a68f5145e1f4e3b4d05f35b51451ca689e72a3f48ba89d885d32a01fb378907f241c69e467f604b17d4b41c139800ab8bd826e78f9460079ea55b41c171ea41ce876fe8f228d1c76f9d066c3ce4a9a089c92330deb7fed306243a098f81ffb4b255336789c92db2eb777ba6f858a5e4846327dc66bfe5f90af5d41c7b7052fc53b5c7dc841b8dd0dabd5f2215035a75ef0d9cb96a64dfb31907a37112b7c094d3f9a9330b0106a80d470d1506c1809d4fde6e4ad61d2d77a771ac4d43bf7937b2fe3845a75601b31eb37817a0a622e6ad80166b3fb55aca489efeb4550ba7882a83cee42c48a8e56dd7bd747105650b50475b7e266c646e7db141a8fd3a01a03ec8c91fdc719cb5ab11fa3ab41c1e346e1b45f82e94c5f1bd8676cb681657482975cb07643bde6c64c66211ae80e34d550ec31ee013c9318f238cb50008c8254012faf05aa0ab7f82bb7717be718e6f161181efc0614d5342b3f3294b27d8628f1e7f311bfaafb9647895f1444d9f67d78074164610792248870cd93857770d14d91dba640db2ce87f04742746139709e78a37ab238fdf6ddcc61bab685fb0b01a8a4dda82ac7de870736d80beb3895b59651d485da771b195a8ac83f25c4514dcdfda9cabc121d817032f5e351baf4f45091aa406b2bc73c1f52749f50212f6619b03f72c71c2ed70cc456d9599e4480f0df0c465d60cb816871c5358152caa5433bd06c73e2a3f3d8a7acb0a4a299783dff154427e83aaf0ad4b9a29753fd873ecdc66f9b92ea05dc5bf15842a3b46f8babd677410cebffc3180c9a5ab9665e17ab2092dc0a48064c90d42e4d2900a000b21c465eb37ce167faecf340f33650da30ebc9123ed8fa39b0718ab68c837673ea6e348b64bbb492811c5dd15f5a4c16521aa301bf2c33fbef67c057613b4e00b51386dc36f77caec51599f128573db3b8b0ee942fe260c50232ba8a7235ce44fb06a83f8a511b9620027bca54b2f19cc86a38c2b376007f38c60cfac0b5ec5c503e8d5c19a0fa692901913ea13b1a1782a06aa8dadfde83f43ad30b0d96c70fd265fa9cd15f4f60d1f67dbf8b77f3344402193824e343e5159cf26905a77eb1142001e6a26291ce08879f78b18cc69c3f8b56501b8b5db36fb4e00c98dbf2c090dfffa9d517e2fc74378e5ac778f8b7e02f538e574859eaf1e98d1f62462f18400b8ada51220600d099801bd00673e7f600457ceb6a39c3c04d139eccd02f06562fdbf8cf609c262d262e922977d0cceb5d5f9e0a933fc4d7abfd94e25690f309e9fe0f3f9c910ba13a60c797ef53ae0062fe9d75e6e2945deed609105e4cbcc20ac2ea10c9e8900e9d6fc3713cb0c0cc39f6343ca863bd5e0cf43b077cad4abfdde3d9095e497c0d8b84c63f5333516542d875d9335d4e2662b4f0aaa2df62a6831cd544ff3da5a8c0dbf0079124f7dc230707db0bce9c6c6b8d1647c8f8f428fc8cae2a505e6d7a8e95f9bad044a53a78aae7c80a0a412748751a53f783056ed333bc13aff2e71c5a5cae524a6dd749a245ef30b92975f58141d7a67f618077333b40e65ebbfa8a94d7b485921b27b26ae180e66121c0850950ab94f204dee3ec71479b95e3317cfde17d64153772e21f567097e7bf5670c07c8a11e3d2e78a8fc132dba1c244edcec6683cdde725b4773a2b8c3f69828234aed3f2664c71e72acb76f2fd9e905c93bb0afb7bd80925faaeae83b38141854f35efebfc8c58cf27630ad068eefbf4d89c6e471af6d8a556f691c32d079763ec51225052361e0fe4294121e577a9adddce762269b0b8962263b30490bdccacb2672bba9dcb344762125644b3ee0f1953d12d57d3080fe2bd72890baa86a983eb6ab3f82a9142a719644b4bced641bfd58db863f7ae7dca003e6651b6f4bf42c59414e4a4c994eeba29764893f8cb147637864f7d9dd73717b0aa695aecc644dbba0d624b97b645d7b5293cf67f6dff4d9a478d8d96066a05b1db8eb61cf86b8f3d136fc5f4d75189da66ee4c7b31ef0a394f3f056d70740223b81e7af0b555b8717b107bfc6697cc2bfe3339373f35f28d7f9cb7136bbafeb461bb75c90bdbcaf9c2131e3a21c1c76d1657d2e3cfd799dea83bda02444389fd2c42f4992aa7ab77d373a126fc6f73167e871376dd3ec482dcde5d058c534a5d27be2d482e1493d9c4fa9c542db4369e0cef246cf153fd8d3ac293965a90061911f091e1e7ef50ba8a6db6ee6b9ed9067491cfec3d96642fd8c49ab7e06236759f6598d172a384744ddd953c1adcd64d048106b16c354f581597a8b8ba036b6670e1b0d6861e5e81da9f524461e4dbc40f99d3d2044ec4b638e7237a42eb5048a043760ae36d08ecfe32c4e87fdc906d38d8b9bbe9842a81f701c891e6c2d643723088e7ebe52f61f21545ada1ce20f0e3da1f9e4a2debfd1f570058b53ea473c2022ccd8325611ecb17535260beff09b7e5d3c8481222b14e9d07d370ed835a09f0151029397123bd60a209cd4151ef995cbed0baf9a919da080b0c4eaac4a8da46eeddd11d4a5f8961a917269dfd41e340c8546d1f9e5fcdc1ba49ac72933e551dccee3eba8a9c01519aaa0d5611d54191b21c266360f44c18b12c69a10e48f0d89ab3c38cfe114cf1126b388faf9013f2397c8b3503de6d7d43c2aa6cc3b314161c89f5c8a480b976123b60a556f706dd168135941745ef1a6d23bbfc778532f0681f3cbddbe209965125114c0993ae92156232cee684ad8e0969d3c7558e47696cd31221a68c8d64fb676a8e31b850b5a655a13f3c8d218fa5d824e8db816f951c09fc5944216d2c9f405688dbc09ad5baaafb0f72f5d07ff31c55cdc9e67c68438c94aa66584e37207dd1b280287f45786812b6969a04049daa8be706a0db7091ada90b5bd616244ac1d360251334c9e94dbf77b9883d3a0a10efb8d834eb8ba376a2fa4a967e5fcf4714d16310cc726f1e51f958c2770d0d1108357fe614d738c162ebabfe30931b51fa32fdf7140770da6218a0a4735633f4e72c383671301ab585b9e0fa58931b7a11679ef7981f120dcdc6b7b9289504ed59567755fa894e7131c516ba01808908b50788703b58a9f7a026caf9a69b456ec0e133956531b677d11de716909224d07572116ccb10b16432a34aefb2d4e48d670af16742ca50bc5bda5ce7894932a804db8e3783a987dcb979071b1b44098a9e1ba071a02cc8e773b15ceb96a44dc3368ed01c83bcad057008b0e657e8b571b97592e356301d3efb04cae54edd88079d7fa2d88f510d9fc1cbc6ad66e7f33219f0b362e54b17e1ff7f9646621678461dc0debbe1ef657d5de00180d95c7d7f4c8ef1776d028946ab129b8962d0825996aa14de7fd891ee0fb33396f27b507550ccc5cf2741d48d9da96aa648a542779ab15f548f336d93d84dc346d73a464a04d44514990694df89aaf7b5e8137c069ebff64ecdda938e8735750dee9fff82e8a1cfa1ad67736e3ac5a3f875cd05741685b6085c7b9c0b05e7202874a880203dc966a6dbb586c7d3f8e3ce98b112f948e6d4f8bb1b06a25068f8236aaae2e047aed2ea75734cacb716c789cb827abd34c7d4152e1699dc708ba5625d8a7ecbb34fc8f388d31f600a97b9cf59698c3a35367085e009c8b2b531dc2eb690f092fef9d44c0ee2ebe4dcb99440a3517f947df9120c7262b94653b60e650925ef73cfc6061e7d0002b990cae30f26064acfb13a50c41b2d6ad3eab8980ab2030bb9de355cc6f3b5b58e93da1e5dee2a209b80d7d06a6d9b48cbcef28d3e4a29c0ac2b9ac01f3f81aadda9fd0f305754b7005acd403b82851f665572930318bd88e393e7d1bc36673b2ccf77c6e438e592e352a57f0573550d2bb39e07988e40467af6d5d181d91e1f2387995acb2abd5e24bcb5a6ec2b771dfb60d2e04e31fac30e484e28f27e8882c81db58c3b641097e73150eaf9f0cbf5dbab9c301edcdc3edc8c27f1df9a87758c1d75e921bfe7307fc1757998af73026ae86b4ec350d5e1982c2f34533a4d88e45cb8dad6ebe15a16d23e5cff3c70c0cbf959979c74b13687a5b79e64d629e43ec99dfc23df064041350728725bf186ba678135d23165dc25c49b28869a987cffded7a991107a55c12db4feb479b1f7a78f3bdb996bf5ffeb99c1358e7ebebbbb74ed8d997d3d606c7de8a1309196e6debe569a8349489b5b73467049b12e1ae810354f184019e661c5310ce73c33c7d9cfa0cca31e054c56f17bc8695cbe47734c31af947598cdffd738fc30319bf12f866358fb0d41c87b76c10c3682a93acbe2cc1e21c8dc5dd3443bd7e0883ab8bb7be27665b5a6676ca7f73667f8cb001d5acd7f21abc35cc0bf3cd03fcfdaa3afa595d369dea0162d102fd6710bf2be6ae7f6d642250f7f06517d9a2fd08114b3fe1c368c0e7e7a813f0842f7b80f0f579ad427f2dd69f193d64e5e7eeb13ebcac18217ef3639d2f8d9e904c3987a67ff15b7146eb749c72e9f6d7685fc674c21fe9ca1c0fe548be42a43855ebcdc01227a93d284d1badc9a961ace7570349cf817d23505a69d28d5b337f647cd3c38c43738f732b7d51ba32f4ea898153e07a530842435e50b4fcdd01e83945b22f5f620f2ff33acf048c584cd223882e3d316ce9f650ae52e4b04f5c358abcd37f6cb8e9b91d46d698c7b6a1a099520d05262d2c6f93e43433ba482f12d49722931a6a0ba3839a1148ca5ff7c54ceed6951077976f77e4e97f4675e68f342c4e3196be9f0d6185213d2b5cc4a2dbed4d52d97f8e3bff6ed5168511c2fce4eb3310dec69c0e682d2d980eff52f8a5c2bab447bae46ba2d841c21dccba652ec682ddcaaf40ac498425c1f03c24647121eae7eb90e04bcd075b677331cafdf73c63da1ae136d62b13439e1241019a11ebd170cb7fcbab47b6e358c920fc115f9b0ce4f2e72f34a46439a30a63eabf8afedc72dcc62b3c2347c5a2c153aaf3b50637f9bfd79bd598c121c4e9b83f647e6691c65329acabae72ea978435f3a5b0ce036e487f1fa88bb1ebac3f952fc492985148ab9843ec573809b6a3707b474a49e5d745e2f9dbf7321bfe7c050ce1cdebbd6ff3af60f7329225b5cf73d8af7770d73a6623b031905e96f32d8d58c1aa16102219b8e98cb452b687387a3396a143ced1a3a7c314fae49d240242373d59359e98606f176deda5aa2ec195664b5ec25f7aeb795db42f39e1d52680212f15c00a7659cd3f364782585307e245d7912695f7b7791da694346b8773af38270e5d9f070f6744043fdc8ed7a21312f34a42f0eb6b0df868cee2d53596f286fca1fdb479e0585104375a1714e00fbf54ae2afd63e4c370fc7a85b5bd9b949dbb3238afaea7e3654653e766a05e29de61ddf4b1519797fbbf006c29813a35ae604301e328f73c04a9c9489b79ccec9c5577810f3ec3bb8d7da1dcb42cbb2a03a73a67da2c2d5709422d5b843841d6532375c968f95e42faa4287fa382eb088f885096e893d5c0f8a1a5410afd1fa8ee7ffbc12899ed817ee7d5eb7795457f9075be9098afe04acafc3e1b4eae962e4a8205bb7ea41181e74ad02369d8f05070d2f60c9fc3cbb78199a5b260d222e16e7367216d540b4c4c8bacc96ebc57b804ebfe4d8a6e452252fc60757b594e515c80640a33cc7755d69a3699949f7948a3d31940aa23e9fc0574d1fab4eb36e11d7a0692aa3ec48da10de6db2314367a75ab460fe6bcbad9158b458c4922dde942fb867f98dd858a51990c7e618c5fc4834a8e23b6ce0747501c6c7b2b03d6a1c09e8da959a48049f4abd98b9181082ff38209564524972f0748a54c610e17688faf4d371a0d5503bb0b89f6d5dba2dd0c89ac6293bbd38ee557fc579ae50fd0cb6ddba7d61ce173155a90c80c71e46206d436b9ca1b39bb70057998fdc748f60041e94982dc7f3022e3b9dcb96e00272b8b23243192cb9d0a4c8a3baa4c236ed3fa011d7b14921824ef7ea3339ecabbadebbb01adfd967bbce2272900aeadf3af410a86629887828fcbcaecacaa90132da4630f00f2c6dbd511f5b5f2598cca91a8dc9be46702d790e3e0e57f4048509b02f59f240a30cbe87becc8284223f5163343f38557a1d4693346c906aa7ccc063d95ca373930218b738e644f10a9cbbe9696a472a3f06cfadff114b140dfdca7ccc5143c1c4122bb5bc6fa5707cd26f5dd2ae24913835d7b3fb0ee057129ee5a20086c10a81e4ba8110b9d396ae69b42edcce2ea4f63ceb82d42a9b4ba07d8bbaf305a5f6f5dff8163ccce30281fcf981f77ca2e19418673884722fad547056690b33c6f34a6b4075260e89076369d13b26ff5313c72c484d054a25076ba81083f0fa2bea95c6c10d06dbc5e2f68a89cbe4b910a36ef7a850a69fb635bb4541d47ec7a8932dc0017f76b1cdf57af79f0f32a23d0b4b547d7b5bbb250f72584cb8fbf89f3252d583acc19401edfb7b2bcbab227f2b1c1aaa9bbb6e840c637dd543125a68ac1190ccc8a26a59c018eda6f303759560711e4fcb1f94d78d88488fe58e8935133237d71d17934b995f7647c10655604901bfa52b7b7654d54bd1d800f241b28bf5c52bfca556c7d10416ae06b22c27060a757ca9c74ea35f0700df9ba48be330b015538aae098d91f8fb4c925bceeb6bfc75014f02fa9d790994a996c1e7552248600ce2ced3f1cb3d506e239161eccbecb45658a1de2d2e772d3b295051b0eddc6b43fdc64c25716355cb0a0dd13b7a65adf652944cb83f3621e66e1f77decf8ef5b734c8a181a917ce3670f731198b5475315a93237c2c6dc58491fb97ca686be376e2c4b957911480b530d3db75534ac4e2008565e8220ce408440030e78c279e993c593a92f1c07761887d549e2672ee497ca3a6a57104461df95eb2045f6262615399d452e4f00d1a567e54cadef6f98bad67ddb0fe9eefe7d284241e2d42aa5c41013f9935746ca9d4b1af0cfe1843db9dc6b436573f55d7d52cb573e034d6123666ccd821e5a7549d3fe2ad42e60fbc714dcf5d4654c61ca0cddde698f9019b04c6a6678ec8f3171ac80f5e834040b66c2f83390c517ea59e08ab8cdf17ce0b03294e66fc0b81c351fc22124b6d77b2b7156a8ab5a7373d84eab363f0d4358b0366acecee98710f9f26f49a932add49149b2461a964b61b32c70beb2ffc5fb52bff70324b3b12ff2d45b23ce0627e08d7d329201fcc10b2ce2c39a7982434bc514c425d0c4a08f12dfb8504569d12912c33d3c0a4239e09e37f79b7f02f368472698b72e0910835ebbbd4463e1d640690694300386474ddd10c9cf6a60505fe42d271f470e0c741ae38e8b98d540575532c336309a765e1cf83493cd3bcdfdd66d16f9e374501dea8a63a723e43f87f62d65cea13f6e33c005fb2b7d32e6b353b526564586e3d076077f546525f3536201f51e4d990a5fbdb34e80c5c5ee629e01e64f4acf4a9578451218f0e5b2d0c4d1e58f67f8087ea11a10b6ce8407a70bfd75dc393425340ec926848072e311316223eb0295b785f3ab73473edf0ca76ce34df41fbd7f6b51f265c7df8ab5734d51d76a2697b520032c384437374ac42b738df2234afbf5be3857484cfe1cce047b2d8dd4d2c1be2f441494d2f2612af80fcc0f99752367934d17b5c47cc993f733d0864f5b997db59952214de18fb82c1eec57cf91fa866c4b79bf33cba4614b36c2d50233f661b6525376744d857c62ffbdc751619ac51568e96bb4da93d3fe6fd4c5e957aeb7e744a6a41d83e455cabe21c7cc22357ef29c78c4ea6697f1edb9e26a2f21c708a371d1694cea2118125f842c59937fbd8529e0ebfa3efebf6a6bd92abb32a890e96878f0fb1783b042ae7b7a650eb14d5938654df68ddf275d62c310c5fe8d9346e71fee2e305ccfa768e74eae1bec007bf859300eaff63f1664749581c21bf6ec8eef39c257d1dc00d61ff9deb79f0574fd4c4a1ca2ad386f6157c85cf55dc8b05fd2259236270564dd4e46884f774c8967e1c56e0f20f7c2b2597882076a476bb584a03990ddecf0d315e677ac1fd231d771d3793e27d0b1a1378759c920482e0d018f1bed42b13acc07316e74aa900b5d7b8e7fd572902b794157fbf379f6b3cf2307ade2dacc272c92be796eb4776a9e5bb431a17bdb3e783e0593b12055815db1230c0d4285a1df1b73a9347aa8cad9162aff57f5899729091b2f0f7b78bab2cd9dd5fb75debe57579c8af3917bb61d3e4a00927fb51094a8b177d2a9948c44a81827477a2747173181db1ab9767a3c55343ca992f4ef7c825b612dd23ab9f326d958f95b6df3c8cc9971fb7f55e0343d3a85617a32b75639ce775f4b19ff8b3732fd377b9253edecfc568996136596099101ea396f3ecee24ecf3c4e6c81c6cec1cca92a3ad3f249351b16135ea1674caad30bf3383a228acf26e971cb05f79ddf47658f7bacb8676f050cba5765e480bd7810d298165bd48b90943d7197ee6ecde411a3615e000cf0015731faa4c0df7a068f22785e1f3cc81e2653a511bc75896be9c12405eae0eeeef4742284a4b75940051fbb91dfe66258f3c41454a6c7a5cd4557671f9ce3f95e9f6465b34c54bc284818d7f8d23adb5cffa3d8af481171968d64fd1c405f7c4ec5617a39acefff1e336f54c4b0de08a235fd288b52c94972c2affaa605914157a11b96235177ac70b4c99a1d413313f507e7bd32bd1e5af5e549d33bf6166a80ad451984c5b33d07c0397c093d90fe9da2894ce43fded323ebca0f2d7e42999fa59b33b0f41773cc97ae8da4136b975e41586c432809a22721e2c0217f92c19feab393042ed77120c52f37812977c361e2c60ec1cd39ce5c94f4586e27583686f7468fb54df942dfa68782f0d9144a9063b54a743149b35bbcae5d997c77a389958ae81e2fb63d5ba3fb9530380660b0db026816c147d15c6715d9062e095776e4b470c458d292fafea3dd36ca18be4c3d25525ec77a2ebb37990529c8636020b145925a8861f84767bec317a7532c992c27fa8387b6a2cadea32a0b38770712c77098fe3a465cf2072c42d888af28b9a7b9a921f1376c4c0b4a627977b0ef18c105d875abad898a4ce944a304fbd386bd1abf431b71f2cf17addfbab0dfb370eda7cfa4b5087b0d0f9e5969c77850c67b785e17bb19d6ff9d902040b1e2e885cf4c86a9da1801349ff301abd42397ccd0e504975a8978af21820b0b733a92f8318172f94187473445e8037d5d6a409d1723e2eced962e51fd154eb3b0517723da5cdfd3c9b507f6233373bc2c27ab291b1ef506cfd554c77d7a86dff4b0ab69688947f3af508b606c3b7847794716a0c8975dd998311600e92ed3b7a46cacefa1b096fa914c466789bd2bf4704dfb1749e0c16415b777fcfc8c4e6391ecf2cdef38b17ee5d1d7b465674343248e2e0dec95113f46c66b000dcc0d08847ae6fc817185dab80c910385d1cf81bed56f5d14893458b9366bfd8817371be90a810f32ed156530ef0a256f887fb056f00843129d275f541cfa9da6891e4b5d16e36516bcd41caa98c47d7028a645011e56522f40c63e8259541cf87ed4a838b88d0b5da062d5daa240f0571aae8ebc2a4e338ae36b6831cec17f35008fdf9306b6cb670281ccf6d3211c4351d62e93decb0e1417cfc159273d7a871e7082203420db737ad2f95d6f2e8d2f021bed4f5fd81b990e84059250c99c87a81ca6f3f4e7228e70e390fb60c2025c3c182a734fa6dc780c9a7142b456f92aa346c27af9fd93fdcbc4c20b491910e3172a76f9774f8f0bd22c655f16b98589236860f6b3da10935d72ca1fc694cf9bf250c940ca4a771af7551ed9adbb6c54825123ee195364f773927f2b60e6b2fda847a2cd52d737af392be5f1b859592601bd4284e9c9da8db59905cfbd26823b463ead1fdb0f3fb8e25e1c2ada9e04c12719f981d75e98d1463b01ce4e401d559fcbf61b931c5b84f8da062208cf531a9b5a5242f8838441a2c23effec70aea1bd43b9c574f19dde68a5e33a065c8b30e4a6bdbb8d77fd283a3355ad5a30a119ab51a4ff6fb60464a85e083fefff3053cbe6241e87f43088b769fffe63d45a79bc63040fa69d6760803f4003ece1c59db9744ad99a5fa09a4ef455ceafb732f460b9ad4acd3f645e2e3c5a1bf17dabe6a97adc76170a2ed1e042a39612e0254e5f5926e056de9fa04f7b8b3bcfdac664e5054cbf30d5595e814a2d6a047254f78f76e9575e85bddfb9435191e488c3f43ed55530141de2b5b2b403036e3452348a286d127ed0bc7b925b8199eea677e1244db3477183b47c82105dc8f209a075bf66ab8bbdc4a1873e3d7c654c22bcb2bf2db49f9ad1697a833e2f9b2bf81185b7864d71c9b039933074bcff4d2f7319770fa55167c4ce4ccd18dae5e55f4b5506faece930f8efd593255847bbca5c027e52179e1ed917f41907f06a1896df9fa1a45eee05f1022e62b3100c388ec1ee3cc9b94bb169e0596db1a73c03aa38422acd61de2996f42b5e94273faa503b332ef595d340449be4da1867dc53d8f97ac8c41827c95cad2f20bc5b1b502f78b38e6f977c29cc5ad93d59ef034b860f99f6d8c48bad0cf4332a3cdcf83cadf8d5d119d201dcb84087886d28dc1f12c6c0ed1479a7ed572c088a55ef</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>分布式锁</title>
    <link href="/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="1-什么是分布式锁"><a href="#1-什么是分布式锁" class="headerlink" title="1 什么是分布式锁"></a>1 什么是分布式锁</h1><p>在单体的应用开发场景中涉及并发同步的时候，大家往往采用Synchronized（同步）或者其他同一个JVM内Lock机制来解决多线程间的同步问题。</p><p>在分布式集群工作的开发场景中，就需要一种更加高级的锁机制来处理跨机器的进程之间的数据同步问题，这种跨机器的锁就是分布式锁。</p><h1 id="2-分布式锁的实现"><a href="#2-分布式锁的实现" class="headerlink" title="2 分布式锁的实现"></a>2 分布式锁的实现</h1><p>分布式锁的核心是实现多进程之间互斥，而满足这一点的方式有很多，常见的有三种：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/640.png" alt="图片"></p><h2 id="2-1-基于数据库的分布式锁"><a href="#2-1-基于数据库的分布式锁" class="headerlink" title="2.1 基于数据库的分布式锁"></a>2.1 基于数据库的分布式锁</h2><p>基于数据库实现分布式锁主要是利用数据库的唯一索引来实现，唯一索引天然具有排他性，这刚好符合我们对锁的要求</p><h3 id="2-1-1-设计原理"><a href="#2-1-1-设计原理" class="headerlink" title="2.1.1 设计原理"></a>2.1.1 设计原理</h3><ul><li>同一时刻只能允许一个竞争者获取锁。加锁时我们在数据库中插入一条记录，利用唯一键进行防重。</li><li>当竞争者A加锁成功后，第竞争者B再来加锁就会抛出唯一索引冲突，如果抛出这个异常，我们就判定竞争者B加锁失败</li><li>竞争者B加锁失败后，会阻塞等待，一直到竞争者A释放锁（也就是删除记录后），再去获取锁</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222626149.png" alt="image-20230228222626149"></p><h3 id="2-1-2-实现注意事项"><a href="#2-1-2-实现注意事项" class="headerlink" title="2.1.2 实现注意事项"></a>2.1.2 实现注意事项</h3><ul><li>没有锁超时机制。如果程序发生了异常，将无法删除数据，也就是锁无法被释放掉，需要自己写一套锁超时机制，比如：在表中新增一列，用于记录失效时间，并且需要有定时任务清除这些失效的数据。</li><li>基于数据库实现的，数据库的可用性和性能将直接影响分布式锁的可用性及性能，可以考虑实现数据库的高可用方案。</li><li>需要自旋实现阻塞效果。当获取锁失败时自旋转。</li><li>如果使用数据库自增 id ,规律太明显。</li><li>受单表数据量的限制。 在高并发场景下，我们都知道 MySQL 的单张表根本不可能容纳大量数据（性能等原因的限制）；如果是将单表拆成多表，还是用数据库自增 id 的话，就存在了 id 重复的情况了，很显然这是业务不允许的。</li></ul><blockquote><p>db操作性能较差，并且有锁表的风险，一般不考虑。</p></blockquote><p><strong>代码示例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"> */<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span></span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁，增加重试逻辑</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//尝试获取锁</span><br>        <span class="hljs-keyword">if</span>(tryLock())&#123;<br>            System.out.println(<span class="hljs-string">&quot;---------获取锁---------&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//等待锁 阻塞</span><br>            waitLock();<br>            <span class="hljs-comment">//重试</span><br>            lock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MysqlDistributedLock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLock</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MethodlockMapper baseMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//插入一条数据   insert into</span><br>            baseMapper.insert(<span class="hljs-keyword">new</span> Methodlock(<span class="hljs-string">&quot;lock&quot;</span>));<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            <span class="hljs-comment">//插入失败</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">waitLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">10</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//删除数据   delete</span><br>        baseMapper.deleteByMethodlock(<span class="hljs-string">&quot;lock&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;-------释放锁------&quot;</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure><h2 id="2-2-基于-Redis-的分布式锁"><a href="#2-2-基于-Redis-的分布式锁" class="headerlink" title="2.2 基于 Redis 的分布式锁"></a>2.2 基于 Redis 的分布式锁</h2><p>效率最高，加锁速度最快，因为Redis几乎都是纯内存操作。</p><p>适用于并发量很大、性能要求很高而可靠性问题可以通过其 他方案去弥补的场景。 </p><h3 id="2-2-1-设计原理"><a href="#2-2-1-设计原理" class="headerlink" title="2.2.1 设计原理"></a>2.2.1 设计原理</h3><ul><li><p>利用利用Redis的<code>SETNX key value</code>这个命令获取锁，并设置过期时间，保存线程标示</p></li><li><p>释放锁时先判断线程标示是否与自己一致，一致则删除锁 (Lua 脚本保证原子性)</p></li></ul><blockquote><p> SETNX key value: 只有当key不存在时才会执行成功，如果key已经存在则命令执行失败。</p></blockquote><h3 id="2-2-2-实现注意事项"><a href="#2-2-2-实现注意事项" class="headerlink" title="2.2.2 实现注意事项"></a>2.2.2 实现注意事项</h3><ul><li><p>Redis 的 increment 并不能满足安全性，如果使用它需要特殊处理增加复杂性，如：</p><ul><li>ID的组成部分：<ul><li><strong>符号位</strong>：1bit，永远为0</li><li><strong>时间戳</strong>：31bit，以秒为单位，可以使用69年</li><li><strong>序列号</strong>：32bit，秒内的计数器，支持每秒产生2^32个不同ID</li></ul></li></ul></li><li><p>需要设置一个超时时间，因为有可能宕机或者被运维重启了，无法释放锁，但是这个超时时间的长短却不好确定：</p><ul><li>设置过短，会导致其他线程提前获得锁，引发线程安全问题</li><li>设置过长，线程需要额外等待</li></ul></li><li><p>如果业务执行时间&gt; 过期时间，就需要<strong>锁续命</strong>：搞一个定时任务，设一个间隔时间，小于失效时间，过一段时间去监控业务是否执行完了，执行没结束，也就是锁还没释放，我就再把锁的过期时间重新设置成初始值</p></li><li><p>避免线程A释放线程B的锁，需要在释放锁时多加一个判断，每个线程只释放自己的锁，不能释放别人的锁！可以给每个线程分配一个唯一的UUID</p></li><li><p>需要确保锁可以正常释放</p><ul><li>使用Lua脚本获取和删除锁，保证原子性</li><li>必须使用try catch 在finally中释放锁，否则有异常，锁便没法释放，其他线程进来就会一直执行失败</li></ul></li><li><p>需要支持锁重入，同一个线程可能多次获取同一把锁</p></li><li><p>需要重试机制，避免锁只尝试一次就返回false</p></li><li><p>如果Redis提供了主从集群，那么需要考虑主从一致性。因为主从同步存在延迟，当主宕机时，在主节点中的锁数据并没有及时同步到从节点中，则会导致其他线程也能获得锁，引发线程安全问题（延迟时间是在毫秒以下的，所以这种情况概率极低）</p></li></ul><p><strong>代码示例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisLockService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String LOCK_PREFIX = <span class="hljs-string">&quot;lock:&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 尝试获取锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> lockKey    锁的键</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requestId  请求ID，用于解锁时验证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireTime 锁的超时时间，毫秒</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 锁是否获取成功</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(String lockKey, String requestId, <span class="hljs-keyword">long</span> expireTime)</span> </span>&#123;<br>        String key = LOCK_PREFIX + lockKey;<br>        <span class="hljs-comment">// 尝试设置锁，这里SETNX不是原子操作，实际使用时应考虑使用Lua脚本或Redis 2.6.12+的SET命令  </span><br>        Boolean result = redisTemplate.opsForValue().setIfAbsent(key, requestId, expireTime, TimeUnit.MILLISECONDS);<br>        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 释放锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> lockKey   锁的键</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requestId 请求ID，用于验证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 锁是否释放成功</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">releaseLock</span><span class="hljs-params">(String lockKey, String requestId)</span> </span>&#123;<br>        String key = LOCK_PREFIX + lockKey;<br>        <span class="hljs-comment">// // Lua 脚本，用于释放锁，Lua 脚本可以确保操作的原子性。</span><br>        String lockScript =<br>                <span class="hljs-string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then &quot;</span> +<br>                        <span class="hljs-string">&quot;   return redis.call(&#x27;del&#x27;, KEYS[1]) &quot;</span> +<br>                        <span class="hljs-string">&quot;else &quot;</span> +<br>                        <span class="hljs-string">&quot;   return 0 &quot;</span> +<br>                        <span class="hljs-string">&quot;end&quot;</span>;<br>        DefaultRedisScript&lt;Long&gt; releaseLockScript = <span class="hljs-keyword">new</span> DefaultRedisScript&lt;&gt;(lockScript, Long.class);<br>        Long result = redisTemplate.execute(releaseLockScript, Collections.singletonList(key), requestId);<br>        <span class="hljs-keyword">return</span> result != <span class="hljs-keyword">null</span> &amp;&amp; result == <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-4-redison使用"><a href="#2-2-4-redison使用" class="headerlink" title="2.2.4 redison使用"></a>2.2.4 <strong>redison使用</strong></h3><p>Redisson是一个基于Redis的分布式Java对象和服务的框架，它提供了丰富的功能来支持各种分布式系统场景。Redisson提供了多种分布式锁的实现，包括可重入锁（Reentrant Lock）、公平锁（Fair Lock）、联锁（MultiLock）、红锁（RedLock）、读写锁（ReadWriteLock）等，用于在分布式环境中实现互斥访问</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222105112.png" alt="image-20230228222105112"></p><p><strong>代码示例：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedissonLockExample</span> </span>&#123;<br><br>    <span class="hljs-comment">// Redis 服务器配置  </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String REDIS_URL = <span class="hljs-string">&quot;redis://127.0.0.1:6379&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <br>        Config config = <span class="hljs-keyword">new</span> Config();<br>        config.useSingleServer().setAddress(REDIS_URL);<br>        RedissonClient redisson = Redisson.create(config);<br>        String lockKey = <span class="hljs-string">&quot;myLock&quot;</span>;<br><br>        <span class="hljs-comment">// 获取锁对象  </span><br>        RLock lock = redisson.getLock(lockKey);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">boolean</span> res = lock.tryLock(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS); <span class="hljs-comment">// 尝试加锁，这里只是示例，Redisson 中通常不这样用  </span><br>            <span class="hljs-keyword">if</span> (res) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 执行需要同步的代码  </span><br>                    System.out.println(<span class="hljs-string">&quot;Lock acquired, executing task...&quot;</span>);<br>                    <span class="hljs-comment">// 模拟任务执行  </span><br>                    Thread.sleep(<span class="hljs-number">2000</span>);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// 释放锁  </span><br>                    lock.unlock();<br>                    System.out.println(<span class="hljs-string">&quot;Lock released&quot;</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;Failed to acquire lock&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">// 或者，更常见的用法是直接调用 lock() 方法阻塞等待锁，并在 finally 块中释放锁  </span><br>            lock.lock(); <span class="hljs-comment">// 阻塞等待锁  </span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 执行需要同步的代码  </span><br>                System.out.println(<span class="hljs-string">&quot;Lock acquired, executing task...&quot;</span>);<br>                <span class="hljs-comment">// 模拟任务执行  </span><br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// 释放锁  </span><br>                lock.unlock();<br>                System.out.println(<span class="hljs-string">&quot;Lock released&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">// 注意：在 Redisson 中，您还可以设置锁的自动过期时间，以避免死锁  </span><br>            <span class="hljs-comment">// lock.lock(10, TimeUnit.SECONDS); // 上锁10秒后自动解锁  </span><br><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            Thread.currentThread().interrupt();<br>            <span class="hljs-comment">// 处理中断异常  </span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 关闭 Redisson 客户端  </span><br>            redisson.shutdown();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-基于-Zookeeper-的分布式锁"><a href="#2-3-基于-Zookeeper-的分布式锁" class="headerlink" title="2.3 基于 Zookeeper 的分布式锁"></a>2.3 基于 Zookeeper 的分布式锁</h2><p>适用于高可靠（高可用），而并发量不是太高的场景</p><p>优点：不存在锁失效的问题，不需要续命。</p><p>缺点：因为需要频繁的创建和删除节点，性能上不如Redis。 </p><p>在高性能、高并发的应用场景下，不建议使用ZooKeeper的分布式锁。而由于ZooKeeper 的高可用性，因此在并发量不是太高的应用场景中，还是推荐使用ZooKeeper的分布式锁</p><p><strong>Zookeeper第三方客户端curator中已经实现了基于Zookeeper的分布式锁。</strong></p><h3 id="2-3-1-基于Zookeeper设计思路一"><a href="#2-3-1-基于Zookeeper设计思路一" class="headerlink" title="2.3.1 基于Zookeeper设计思路一"></a>2.3.1 基于Zookeeper设计思路一</h3><p>利用Zookeeper创建临时节点来实现分布式锁，同一路径下的节点名称不能重复，来行防重</p><ul><li>同一时刻只能允许一个竞争者获取锁。加锁时我们创建一个临时节点。</li><li>当竞争者A加锁成功后，第竞争者B再来加锁就会抛出节点名称不能重复错误，如果抛出这个异常，我们就判定竞争者B加锁失败</li><li>竞争者B加锁失败后，会阻塞等待，监听节点状态，当节点数据删除后，也就是竞争者A释放锁，再去获取锁</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221910782.png" alt="image-20230228221910782"></p><p><strong>代码示例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZkDistributedLock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IZkDataListener</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> ZkClient zkClient ;<br>    <span class="hljs-keyword">private</span> String path = <span class="hljs-string">&quot;/lock&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> CountDownLatch countDownLatch ;<br>    <span class="hljs-keyword">private</span> String config;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span>(zkClient ==<span class="hljs-keyword">null</span>)&#123;<br>                <span class="hljs-comment">//建立连接</span><br>                zkClient = <span class="hljs-keyword">new</span> ZkClient(config);<br>            &#125;<br>            <span class="hljs-comment">// 创建临时节点</span><br>            zkClient.createEphemeral(path);<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            <span class="hljs-comment">//存在节点</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">waitLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//注册监听</span><br>        zkClient.subscribeDataChanges(path,<span class="hljs-keyword">this</span>);<br>        <span class="hljs-keyword">if</span>(zkClient.exists(path))&#123;<br>            countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                countDownLatch.await();  <span class="hljs-comment">//计数器变为0之前，都会阻塞</span><br>                <span class="hljs-comment">// 解除监听</span><br>                zkClient.unsubscribeDataChanges(path,<span class="hljs-keyword">this</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br><br>        <span class="hljs-keyword">if</span>(zkClient !=<span class="hljs-keyword">null</span>)&#123;<br>            zkClient.delete(path);<br>            System.out.println(<span class="hljs-string">&quot;-----释放锁资源----&quot;</span>);<br>        &#125;<br><br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDataDeleted</span><span class="hljs-params">(String dataPath)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        countDownLatch.countDown();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDataChange</span><span class="hljs-params">(String dataPath, Object data)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-2-基于Zookeeper设计思路二"><a href="#2-3-2-基于Zookeeper设计思路二" class="headerlink" title="2.3.2 基于Zookeeper设计思路二"></a>2.3.2 基于Zookeeper设计思路二</h3><ul><li><p>利用Zookeeper创建临时有序节点来实现分布式锁，谁创建的节点序号最小，谁就获得了锁，</p></li><li><p>其他节点就会监听序号比自己小的节点，一旦序号比自己小的节点被删除了，其他节点就会得到相应的事件，然后查看自己是否为序号最小的节点，如果是，则获取锁</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221920388.png" alt="image-20230228221920388"></p><p><strong>代码示例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZkDistributedLock2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IZkDataListener</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> ZkClient zkClient;<br>    <span class="hljs-keyword">private</span> String path;<br>    <span class="hljs-keyword">private</span> String config;<br><br>    <span class="hljs-keyword">private</span> CountDownLatch countDownLatch ;<br>    <span class="hljs-keyword">private</span> String beforePath; <span class="hljs-comment">// 当前节点前一个节点</span><br>    <span class="hljs-keyword">private</span> String currentPath; <span class="hljs-comment">// 当前节点</span><br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ZkDistributedLock2</span><span class="hljs-params">(String config, String path)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.path = path;<br>        <span class="hljs-keyword">this</span>.config = config;<br>        zkClient = <span class="hljs-keyword">new</span> ZkClient(config);<br>        <span class="hljs-keyword">if</span> (!zkClient.exists(path)) &#123;<br>            <span class="hljs-comment">// 如果根节点不存在，则创建根节点</span><br>            zkClient.createPersistent(path);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//尝试获取锁</span><br>        <span class="hljs-keyword">boolean</span> locked = tryLock();<br>        <span class="hljs-keyword">if</span>(locked)&#123;<br>            System.out.println(<span class="hljs-string">&quot;---------获取锁---------&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">while</span> (!locked)&#123;<br>            <span class="hljs-comment">//等待锁 阻塞</span><br>            waitLock();<br>            <span class="hljs-comment">//重试</span><br>            <span class="hljs-comment">//获取等待的子节点列表</span><br>            List&lt;String&gt; childrens = zkClient.getChildren(path);<br>            <span class="hljs-comment">//判断，是否加锁成功</span><br>            <span class="hljs-keyword">if</span> (checkLocked(childrens)) &#123;<br>                locked = <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//创建临时有序的节点  -e -s</span><br>            currentPath = zkClient.createEphemeralSequential(path+<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-keyword">null</span>);<br>            <span class="hljs-comment">//获取到所有子节点</span><br>            List&lt;String&gt; childrens = zkClient.getChildren(path);<br>            <span class="hljs-comment">//获取等待的子节点列表，判断自己是否第一个</span><br>            <span class="hljs-keyword">if</span> (checkLocked(childrens)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>            <span class="hljs-comment">// 若不是第一个，则找到自己的前一个节点</span><br>            <span class="hljs-keyword">int</span> index =  Collections.binarySearch(childrens,<br>                    currentPath.substring(currentPath.lastIndexOf(<span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-number">1</span>));<br>            <span class="hljs-keyword">if</span>(index&lt;<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(currentPath+<span class="hljs-string">&quot;节点没有找到&quot;</span> );<br>            &#125;<br>            <span class="hljs-comment">//如果自己没有获得锁，则要监听前一个节点</span><br>            beforePath = path + <span class="hljs-string">&quot;/&quot;</span> + childrens.get(index-<span class="hljs-number">1</span>);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkLocked</span><span class="hljs-params">(List&lt;String&gt; childrens)</span> </span>&#123;<br><br>        <span class="hljs-comment">//节点按照编号，升序排列</span><br>        Collections.sort(childrens);<br><br>        <span class="hljs-comment">// 如果是第一个，代表自己已经获得了锁</span><br>        <span class="hljs-keyword">if</span> (currentPath.equals(path + <span class="hljs-string">&quot;/&quot;</span> +childrens.get(<span class="hljs-number">0</span>))) &#123;<br>            System.out.println(<span class="hljs-string">&quot;成功的获取分布式锁,节点为&quot;</span>+ currentPath);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">waitLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span>(zkClient.exists(beforePath)) &#123;<br>                <span class="hljs-comment">//订阅比自己次小顺序节点的删除事件   index-1</span><br>                zkClient.subscribeDataChanges(beforePath, <span class="hljs-keyword">this</span>);<br>                countDownLatch.await();<br>                zkClient.unsubscribeDataChanges(beforePath, <span class="hljs-keyword">this</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br><br>        <span class="hljs-keyword">if</span>(zkClient !=<span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-comment">//删除临时节点</span><br>            zkClient.delete(currentPath,-<span class="hljs-number">1</span>);<br>            System.out.println(currentPath+<span class="hljs-string">&quot; 节点释放锁资源&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDataChange</span><span class="hljs-params">(String dataPath, Object data)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDataDeleted</span><span class="hljs-params">(String dataPath)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        countDownLatch.countDown(); <span class="hljs-comment">//减1</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-3-Apache-Curator-使用"><a href="#2-3-3-Apache-Curator-使用" class="headerlink" title="2.3.3 Apache Curator 使用"></a>2.3.3 Apache Curator 使用</h3><p>Apache Curator 是一个开源的客户端库，用于简化 Apache ZooKeeper 的使用。Curator 提供了丰富的 API，其中包括实现分布式锁的功能。Curator 的 <code>InterProcessMutex</code> 类是一个分布式可重入互斥锁的实现，非常适合在分布式系统中用来同步资源访问。</p><h4 id="1-添加-Curator-依赖"><a href="#1-添加-Curator-依赖" class="headerlink" title="1. 添加 Curator 依赖"></a>1. 添加 Curator 依赖</h4><p>首先，你需要在你的项目中添加 Curator 的 Maven 依赖。以下是一个例子：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>你的版本号<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-recipes<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>你的版本号<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>请替换 <code>你的版本号</code> 为你想要使用的 Curator 版本。</p><h4 id="2-配置-Curator-客户端"><a href="#2-配置-Curator-客户端" class="headerlink" title="2. 配置 Curator 客户端"></a>2. 配置 Curator 客户端</h4><p>你需要配置一个 Curator 客户端，指定 ZooKeeper 的服务器地址等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.curator.framework.CuratorFramework;  <br><span class="hljs-keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;  <br><span class="hljs-keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;  <br>  <br>CuratorFramework client = CuratorFrameworkFactory.newClient(  <br>    <span class="hljs-string">&quot;127.0.0.1:2181&quot;</span>, <span class="hljs-comment">// ZooKeeper 地址  </span><br>    <span class="hljs-keyword">new</span> ExponentialBackoffRetry(<span class="hljs-number">1000</span>, <span class="hljs-number">3</span>) <span class="hljs-comment">// 重试策略  </span><br>);  <br>client.start();<br></code></pre></td></tr></table></figure><h4 id="3-Curator实现分布式锁"><a href="#3-Curator实现分布式锁" class="headerlink" title="3. Curator实现分布式锁"></a>3. Curator实现分布式锁</h4><p>使用 Curator 的 <code>InterProcessMutex</code> 类来实现分布式锁。</p><p><strong>注意事项</strong></p><ul><li>确保 ZooKeeper 服务正在运行。</li><li>在生产环境中，使用 Curator 的配置可能需要更多的细化和优化，例如使用更复杂的重试策略或配置连接池。</li><li><code>InterProcessMutex</code> 提供了可重入锁的功能，这意味着同一个客户端可以多次获取同一把锁。</li><li>在 <code>finally</code> 块中释放锁是非常重要的，以避免死锁。</li><li>Curator 还提供了其他类型的锁，如 <code>InterProcessSemaphoreMutex</code>（信号量锁）和 <code>InterProcessReadWriteLock</code>（读写锁），你可以根据需要选择使用。</li></ul><p>使用 Curator 的分布式锁可以极大地简化在分布式系统中的同步控制。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;  <br><span class="hljs-keyword">import</span> org.apache.curator.framework.recipes.locks.LockAcquireException;  <br>  <br><span class="hljs-comment">// 锁的路径（通常是 ZooKeeper 中的一个节点路径）  </span><br>String lockPath = <span class="hljs-string">&quot;/locks/myLock&quot;</span>;  <br>  <br><span class="hljs-comment">// 创建锁对象  </span><br>InterProcessMutex lock = <span class="hljs-keyword">new</span> InterProcessMutex(client, lockPath);  <br>  <br><span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-comment">// 尝试获取锁  </span><br>    <span class="hljs-keyword">if</span> (lock.acquire(<span class="hljs-number">10</span>, TimeUnit.SECONDS)) &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-comment">// 执行你的同步代码  </span><br>            System.out.println(<span class="hljs-string">&quot;Lock acquired, executing task...&quot;</span>);  <br>            <span class="hljs-comment">// 模拟任务执行  </span><br>            Thread.sleep(<span class="hljs-number">2000</span>);  <br>        &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-comment">// 释放锁  </span><br>            lock.release();  <br>            System.out.println(<span class="hljs-string">&quot;Lock released&quot;</span>);  <br>        &#125;  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果在规定时间内没有获取到锁  </span><br>        System.out.println(<span class="hljs-string">&quot;Failed to acquire lock&quot;</span>);  <br>    &#125;  <br>&#125; <span class="hljs-keyword">catch</span> (InterruptedException | LockAcquireException e) &#123;  <br>    Thread.currentThread().interrupt();  <br>    <span class="hljs-comment">// 处理异常  </span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CAP原则以及eureka和zookeeper的对比</title>
    <link href="/CAP%E5%8E%9F%E5%88%99%E4%BB%A5%E5%8F%8Aeureka%E5%92%8Czookeeper%E7%9A%84%E5%AF%B9%E6%AF%94/"/>
    <url>/CAP%E5%8E%9F%E5%88%99%E4%BB%A5%E5%8F%8Aeureka%E5%92%8Czookeeper%E7%9A%84%E5%AF%B9%E6%AF%94/</url>
    
    <content type="html"><![CDATA[<h1 id="1-CAP理论是什么？"><a href="#1-CAP理论是什么？" class="headerlink" title="1 CAP理论是什么？"></a>1 CAP理论是什么？</h1><p>CAP即：</p><ul><li>Consistency（一致性）：对于客户端的每次读操作，要么读到的是最新的数据，要么读取失败，返回一个错误或超时，其强调的是数据正确。</li><li>Availability（可用性）：任何客户端的请求都能得到响应数据，不会出现响应错误，但不保证数据最新，强调的是不出错。比如我们购买商品时，他的点赞数就与购买商品无关，我们可以允许他不是最新的。</li><li>Partition tolerance（分区容忍性）：由于分布式系统通过网络进行通信，网络是不可靠的。当任意数量的消息丢失或延迟到达时，系统仍会继续提供服务，不会挂掉。</li></ul><p>这三个性质对应了分布式系统的三个指标。而CAP理论说的就是：一个分布式系统，不可能同时做到这三点。分布式系统必须满足分区容错性，所以要么是AP,要么是CP。</p><h1 id="2-分布式CAP定理，为什么不能同时满足三个特性"><a href="#2-分布式CAP定理，为什么不能同时满足三个特性" class="headerlink" title="2 分布式CAP定理，为什么不能同时满足三个特性"></a>2 分布式CAP定理，为什么不能同时满足三个特性</h1><p>假设有两台服务器，一台放着应用A和数据库V，一台放着应用B和数据库V，他们之间的网络可以互通，也就相当于分布式系统的两个部分。</p><p>在满足一致性的时候，两台服务器(假设为N1,N2)的数据是一样的，DB0&#x3D;DB0。在满足可用性的时候，用户不管是请求N1或者N2，都会得到立即响应。在满足分区容错性的情况下，N1和N2有任何一方宕机，或者网络不通的时候，都不会影响N1和N2彼此之间的正常运作。</p><p>用户通过N1中的A应用请求数据更新到服务器DB0，这时N1中的服务器DB0变为DB1，通过分布式系统的数据同步更新操作，N2服务器中的数据库V0也更新为了DB1（图2），这时，用户通过B向数据库发起请求得到的数据就是即时更新后的数据DB1。</p><p>上面是正常运作的情况，但分布式系统中，最大的问题就是网络，现在假设一种极端情况，N1和N2之间的网络断开了，但我们仍要支持这种网络异常，也就是满足分区容错性，那么这样能不能同时满足一致性和可用性呢？</p><p>假设N1和N2之间通信的时候网络突然出现故障，有用户向N1发送数据更新请求，那N1中的数据DB0将被更新为DB1，由于网络是断开的，N2中的数据库仍旧是DB0；</p><p>如果这个时候，有用户向N2发送数据读取请求，由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据DB1，怎么办呢？有二种选择，第一，牺牲数据一致性，响应旧的数据DB0给用户；第二，牺牲可用性，阻塞等待，直到网络连接恢复，数据更新操作完成之后，再给用户响应最新的数据DB1。</p><h1 id="3-作为服务中心，eureka和zookeeper的对比"><a href="#3-作为服务中心，eureka和zookeeper的对比" class="headerlink" title="3 作为服务中心，eureka和zookeeper的对比"></a>3 作为服务中心，eureka和zookeeper的对比</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233310740.png" alt="image-20230228233310740"></p><h2 id="3-1-集群方式不同"><a href="#3-1-集群方式不同" class="headerlink" title="3.1 集群方式不同"></a>3.1 集群方式不同</h2><ul><li><p>zookeeper集群是存在leader和follower关系的，也就是一主多从。</p></li><li><p>eureka集群中的各个节点是平等的地位，peer to peer对等通信。这是一种<strong>去中心化</strong>的架构，在这种架构风格中，节点通过彼此互相注册来提高可用性，每个节点都可被视为其他节点的副本</p></li></ul><h2 id="3-2-zookeeper-保证CP，eureka保证-AP"><a href="#3-2-zookeeper-保证CP，eureka保证-AP" class="headerlink" title="3.2 zookeeper 保证CP，eureka保证 AP"></a>3.2 zookeeper 保证CP，<strong>eureka保证 AP</strong></h2><ul><li><strong>Zookeeper保证 CP</strong>，在使用 Zookeeper 获取服务列表时，如果此时的 Zookeeper 集群中的 Leader 宕机了，该集群就要进行 Leader 的选举，<strong>选举是需要时间的，在这一段时间内，将无法处理请求</strong>。所以说，Zookeeper 不能保证服务可用性。</li><li><strong>eureka保证 AP</strong>，在Eureka平台中，如果某台服务器宕机，客户端请求会自动切换到新的Eureka节点，<strong>只要有一台Eureka还在，就能保证注册服务可用，只不过查到的信息可能不是最新的</strong>。当宕机的服务器重新恢复后，Eureka 会再次将其纳入到服务器集群管理之中。</li></ul><h2 id="3-3-zookeeper的实时性更好"><a href="#3-3-zookeeper的实时性更好" class="headerlink" title="3.3 zookeeper的实时性更好"></a>3.3 zookeeper的实时性更好</h2><p>eureka是通过心跳体制，检测节点是否正常，相比于zookeeper的watcher机制，实时性稍差一点</p><p><strong>正常情况下，为了满足用户体验，应该先选可用性。所以，理论上来说，Eureka作为系统服务的注册中心是最适合的。</strong></p>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>CAP原则</tag>
      
      <tag>eureka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>类加载机制的深度解析</title>
    <link href="/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"/>
    <url>/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="1-类加载运行全过程"><a href="#1-类加载运行全过程" class="headerlink" title="1. 类加载运行全过程"></a>1. 类加载运行全过程</h1><p>当我们用java命令运行某个类的main函数启动程序时，首先需要通过<strong>类加载器</strong>把主类加载到 JVM。</p><p>有如下几步： <strong>加载 &gt;&gt; 验证 &gt;&gt; 准备 &gt;&gt; 解析 &gt;&gt; 初始化 &gt;&gt;</strong> 使用 &gt;&gt; 卸载 </p><ol><li><p>加载：</p><ul><li><strong>通过类的全限定名获取其二进制字节流</strong>：可以从本地文件系统、网络或其他来源获取字节码。</li><li>将字节流转换为方法区中的对应的类结构。</li></ul><h5 id="加载的方式"><a href="#加载的方式" class="headerlink" title="加载的方式"></a><strong>加载的方式</strong></h5><ul><li><strong>启动类加载器（Bootstrap ClassLoader）</strong>：负责加载核心类库（如 <code>rt.jar</code> 中的类）。</li><li><strong>扩展类加载器（Extension ClassLoader）</strong>：负责加载扩展类库（如 <code>jre/lib/ext</code> 目录下的类）。</li><li><strong>应用程序类加载器（Application ClassLoader）</strong>：负责加载用户类路径（classpath）中的类。</li><li><strong>自定义类加载器</strong>：可以通过继承 <code>java.lang.ClassLoader</code> 实现自定义加载逻辑。</li></ul></li><li><p>验证：</p><ul><li>校验字节码文件的正确性且符合 JVM 规范，防止恶意代码破坏虚拟机的安全性。</li><li>验证是一个耗时但必要的过程，确保了类的正确性和安全性。</li></ul></li><li><p>准备：</p><ul><li>给类的静态变量分配内存，</li><li><strong>设置默认值</strong>：将静态变量初始化为其类型的零值（如 <code>int</code> 类型为 <code>0</code>，<code>boolean</code> 类型为 <code>false</code>，引用类型为 <code>null</code>） 。（如 <code>int</code> 类型为 <code>0</code>，<code>boolean</code> 类型为 <code>false</code>，引用类型为 <code>null</code>）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> value = <span class="hljs-number">123</span>; <span class="hljs-comment">// 静态变量</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>在准备阶段，<code>value</code> 被分配内存并初始化为 <code>0</code>。</li><li>初始化阶段才会将 <code>value</code> 设置为 <code>123</code>。</li></ul></li><li><p>解析：将<strong>符号引用</strong>替换为地址引用</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>符号引用是以文本形式表示的目标地址或对象的逻辑名称。它并不直接指向内存中的实际位置，而是通过某种间接的方式（如名称、路径等）描述目标对象的位置<br><span class="hljs-bullet">- </span>直接引用是指向目标对象在内存中的实际地址。它是具体的物理地址，可以直接用于访问目标对象。<br></code></pre></td></tr></table></figure><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">举例： <br>假设有一个类 `A` 中定义了一个方法 `void foo()`，在字节码文件中，这个方法可能以符号引用的形式表示为：<span class="hljs-function"><span class="hljs-keyword">Method</span> #5;</span> <span class="hljs-comment">// NameAndType foo:()V, 这里的 `#5` 是一个索引，指向常量池中的某个条目，而 `NameAndType foo:()V` 表示方法的名字和签名。</span><br>在运行时，JVM 将上述符号引用解析为实际的内存地址，例如：<span class="hljs-number">0</span>x7f8000001234, 这个地址可以直接定位到方法 `foo()` 的代码段。<br></code></pre></td></tr></table></figure></li><li><p><strong>初始化</strong>：</p><ul><li><p>对类的静态变量初始化为指定的值</p></li><li><p>执行静态代码块</p></li></ul></li></ol><h1 id="2-类加载器"><a href="#2-类加载器" class="headerlink" title="2. 类加载器"></a>2. <strong>类加载器</strong></h1><ol><li>**引导类加载器 (Bootstrap ClassLoader)**：<ul><li><strong>职责</strong>：加载 Java 核心库中的类，如 <code>java.lang.*</code>、<code>java.util.*</code> 等。</li><li><strong>加载路径</strong>：JVM 启动时指定的 <code>rt.jar</code> 或者 <code>jmod</code> 文件中的类。</li><li><strong>特点</strong>：由 JVM 实现，使用本地代码，不是一个普通的 Java 类。</li></ul></li><li>**扩展类加载器 (Extension ClassLoader)**：<ul><li><strong>职责</strong>：加载标准扩展库中的类，位于 <code>JAVA_HOME/lib/ext</code> 目录或由系统属性 <code>java.ext.dirs</code> 指定的目录。</li><li><strong>加载路径</strong>：<code>lib/ext</code> 目录中的 JAR 文件。</li><li><strong>特点</strong>：由 Java 实现，继承自 <code>ClassLoader</code> 类。</li></ul></li><li>**系统类加载器 (System ClassLoader) &#x2F; 应用程序类加载器 (Application ClassLoader)**：<ul><li><strong>职责</strong>：加载用户类路径 (<code>classpath</code>) 中的类，包含用户定义的类和第三方库。</li><li><strong>加载路径</strong>：通过命令行参数 <code>-classpath</code> 或环境变量 <code>CLASSPATH</code> 指定的路径。</li><li><strong>特点</strong>：默认的类加载器，可以通过 <code>ClassLoader.getSystemClassLoader()</code> 获取。</li></ul></li><li>**自定义类加载器 (Custom ClassLoader)**：<ul><li><strong>职责</strong>：由用户定义，可以从任意位置加载类，例如网络、数据库等。</li><li><strong>加载路径</strong>：用户定义。</li><li><strong>特点</strong>：用户可以通过继承 <code>ClassLoader</code> 类并覆盖 <code>findClass</code> 方法来自定义类加载逻辑。</li></ul></li></ol><h1 id="3-双亲委派机制"><a href="#3-双亲委派机制" class="headerlink" title="3. 双亲委派机制"></a>3. 双亲委派机制</h1><p>当某个类加载器需要加载某个<code>.class</code>文件时，它首先把这个任务委托给他的上级类加载器，递归这个操作，如果上级的类加载器没有加载，自己才会去加载这个类。</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20240603232254437.png" alt="image-20240603232254437" style="zoom:50%;" /><p>loadClass 方法的主要职责就是实现双亲委派机制：首先检查这个类是不是已经被加载过了，如果加载过了直接返回，否则委派给父加载器加载，这是一个递归调用，一层一层向上委派，最顶层的类加载器（启动类加载器）无法加载该类时，再一层一层向下委派给子类加载器加载。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br><br>    <span class="hljs-comment">//每个类加载器都有个父加载器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader parent;<br>    <br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) &#123;<br>  <br>        <span class="hljs-comment">//查找一下这个类是不是已经加载过了</span><br>        Class&lt;?&gt; c = findLoadedClass(name);<br>        <br>        <span class="hljs-comment">//如果没有加载过</span><br>        <span class="hljs-keyword">if</span>( c == <span class="hljs-keyword">null</span> )&#123;<br>          <span class="hljs-comment">//先委派给父加载器去加载，注意这是个递归调用</span><br>          <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>              c = parent.loadClass(name);<br>          &#125;<span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">// 如果父加载器为空，查找Bootstrap加载器是不是加载过了</span><br>              c = findBootstrapClassOrNull(name);<br>          &#125;<br>        &#125;<br>        <span class="hljs-comment">// 如果父加载器没加载成功，调用自己的findClass去加载</span><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-keyword">null</span>) &#123;<br>            c = findClass(name);<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> c；<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name)&#123;<br>       <span class="hljs-comment">//1. 根据传入的类名name，到在特定目录下去寻找类文件，把.class文件读入内存</span><br>          ...<br>          <br>       <span class="hljs-comment">//2. 调用defineClass将字节数组转成Class对象</span><br>       <span class="hljs-keyword">return</span> defineClass(buf, off, len)；<br>    &#125;<br>    <br>    <span class="hljs-comment">// 将字节码数组解析成一个Class对象，用native方法实现</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; defineClass(<span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len)&#123;<br>       ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-1-作用"><a href="#3-1-作用" class="headerlink" title="3.1 作用"></a>3.1 作用</h2><ol><li><p><strong>防止加载同一个.class。</strong>通过委托去询问上级是否已经加载过该.class，如果加载过了，则不需要重新加载。保证了数据安全。</p></li><li><p><strong>保证核心.class不被篡改。</strong>通过委托的方式，保证核心.class不被篡改，即使被篡改也不会被加载，即使被加载也不会是同一个class对象，因为不同的加载器加载同一个.class也不是同一个Class对象。这样则保证了Class的执行安全。</p></li></ol><h2 id="3-2-如何打破双亲委派？"><a href="#3-2-如何打破双亲委派？" class="headerlink" title="3.2 如何打破双亲委派？"></a>3.2 如何打破双亲委派？</h2><p>打破双亲委派，其实就是不走双亲委派那一套，而是走自定义的类加载器。</p><p>双亲委派的机制是ClassLoader中的loadClass方法实现的，打破双亲委派，其实就是重写这个方法，来用我们自己的方式来实现即可。典型的打破双亲委派模型的框架和中间件有tomcat。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String classPath;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomClassLoader</span><span class="hljs-params">(String classPath)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.classPath = classPath;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-comment">// 尝试加载自定义类</span><br>        Class&lt;?&gt; clazz = findClass(name);<br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>        <span class="hljs-comment">// 自己加载不了，再调用父类loadClass，保持双亲委托模式</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.loadClass(name);<br>    &#125;<br><br>    <span class="hljs-comment">// 自定义类加载逻辑，例如从文件、网络等加载类字节码</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-keyword">byte</span>[] result;<br>        String path = classPath + File.separatorChar + name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, File.separatorChar) + <span class="hljs-string">&quot;.class&quot;</span>;<br>        <span class="hljs-keyword">try</span> (FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(path)) &#123;<br>            <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[fis.available()];<br>            fis.read(buffer);<br>            result = buffer;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClassNotFoundException(<span class="hljs-string">&quot;Could not load class &quot;</span> + name, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> defineClass(name, result, <span class="hljs-number">0</span>, result.length);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>类加载机制</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记录由于数据库用户权限导致的一次线上事故</title>
    <link href="/%E8%AE%B0%E5%BD%95%E7%94%B1%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E5%AF%BC%E8%87%B4%E7%9A%84%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85/"/>
    <url>/%E8%AE%B0%E5%BD%95%E7%94%B1%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E5%AF%BC%E8%87%B4%E7%9A%84%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85/</url>
    
    <content type="html"><![CDATA[<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h1><ul><li>11.3 生产环境和用户查询相关的功能，都报错could not extract ResultSet; SQL [n&#x2F;a]; nested exception is org.hibernate.exception.SQLGrammarException: could not extract ResultSet</li><li>ELK查询原因，Caused by: org.postgresql.util.PSQLException: 错误: 对表 em_adm_user_group 权限不够</li><li>f lyway新建了V20231031155120__DDL_create_user_group.sql，并且userVo join user_group，所以会查询user_group这张表</li></ul><h1 id="2-原因"><a href="#2-原因" class="headerlink" title="2 原因"></a>2 原因</h1><ul><li><p>9.4 LGQ定位中毒事件的时候，为了确认是哪个微服务执行的数据库操作（不同的微服务如果使用了不同的用户，可以看到是哪个微服务执行的sql），修改了sith-mes的application-sithMes.yml，将数据库的用户从sith-mes修改成了sith-server，并且赋予了sith-server超级管理员的权限，所以sith-server可以操作sith-mes创建的表。</p></li><li><p>执行create_user_group.sql的时候，因为此时是在sith-mes服务下执行的，所以user_group这张表的owner是sith-server。admin服务此时连接的数据库用户是sith-mes，所以没有操作sith-server的权限</p></li></ul><blockquote><p>用户sith-server建立的表，用户sith-mes没有权限操作</p></blockquote><h1 id="3-紧急修复"><a href="#3-紧急修复" class="headerlink" title="3. 紧急修复"></a>3. 紧急修复</h1><p>将新建的user_group 的owner改成了sith-mes</p><p>问题：后期如果在sith-mes新建的表，其他微服务要操作的话，依旧会出现没权限问题</p><h1 id="4-解决方式"><a href="#4-解决方式" class="headerlink" title="4 解决方式"></a>4 解决方式</h1><ol><li>保持所有微服务用户一致，sith-mes改回用户sith-mes，或者其他微服务也改成使用sith-server</li><li>将sith-mes也设置成超级管理员，使他可以操作sith-mes数据库的所有表</li><li>每个微服务数据库使用自己的用户，flyway基于每个微服务建立，并且需保证服务只操作自己服务的表</li></ol><h1 id="5-数据库新建用户，并赋予权限步骤"><a href="#5-数据库新建用户，并赋予权限步骤" class="headerlink" title="5. 数据库新建用户，并赋予权限步骤"></a>5. 数据库新建用户，并赋予权限步骤</h1><p>场景：用户panyurou创建了一个名为“micro-weather”的database(数据库)，同时在该库下默认的public(shema)创建了一个表city</p><p>需求：新建一个用户cityserver，使得这个用户可以操作“micro-weather”的public(shema)下的所有表</p><h2 id="5-1-创建用户并设置密码"><a href="#5-1-创建用户并设置密码" class="headerlink" title="5.1 创建用户并设置密码"></a>5.1 创建用户并设置密码</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> cityserver <span class="hljs-keyword">with</span> PASSWORD <span class="hljs-string">&#x27;city-server&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="5-2-数据库授权"><a href="#5-2-数据库授权" class="headerlink" title="5.2 数据库授权"></a>5.2 数据库授权</h2><p>赋予指定账号，指定数据库的所有权限</p><ol><li><p>以panyurou的身份进入数据库（因为是panyurou创建的数据库和表，所以需要在panyurou的身份下操作）。此时是可以访问city这张表的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  Desktop psql <span class="hljs-operator">-</span>U panyurou <span class="hljs-operator">-</span>d  micro<span class="hljs-operator">-</span>weather<br><br>psql (<span class="hljs-number">14.6</span> (Homebrew))<br>Type &quot;help&quot; <span class="hljs-keyword">for</span> help.<br><br>micro<span class="hljs-operator">-</span>weather<span class="hljs-operator">=</span># <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> city;<br> id <span class="hljs-operator">|</span> name<br><span class="hljs-comment">----+------</span><br>(<span class="hljs-number">0</span> <span class="hljs-keyword">rows</span>)<br></code></pre></td></tr></table></figure></li><li><p>赋予数据库权限</p></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">micro<span class="hljs-operator">-</span>weather<span class="hljs-operator">=</span># <span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> privileges <span class="hljs-keyword">on</span> database &quot;micro-weather&quot; <span class="hljs-keyword">to</span> cityserver;<br><span class="hljs-keyword">GRANT</span><br>micro<span class="hljs-operator">-</span>weather<span class="hljs-operator">=</span># \q<br></code></pre></td></tr></table></figure><ol start="3"><li>赋予该数据库下所有表权限</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">micro<span class="hljs-operator">-</span>weather<span class="hljs-operator">=</span># <span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> privileges <span class="hljs-keyword">on</span> <span class="hljs-keyword">all</span> tables <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> cityserver;<br><span class="hljs-keyword">GRANT</span><br>micro<span class="hljs-operator">-</span>weather<span class="hljs-operator">=</span># \q<br></code></pre></td></tr></table></figure><p>注：当没有赋予权限，并且以新建的用户去访问数据的话，会报错</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs subunit">➜  Desktop psql -U cityserver -d micro-weather<br><br>psql (14.6 (Homebrew))<br>Type &quot;help&quot; for help.<br><br>micro-weather=&gt; select * from city;<br><span class="hljs-keyword">ERROR:  </span>permission denied for table city<br></code></pre></td></tr></table></figure><p>附：数据库用户介绍</p><p>执行<code>select * from pg_user;</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231107225414985.png" alt="image-20231107225414985"></p><h2 id="5-3-常用sql"><a href="#5-3-常用sql" class="headerlink" title="5.3 常用sql"></a>5.3 常用sql</h2><p>将用户修改成超级管理员</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> cityserver <span class="hljs-keyword">WITH</span> SUPERUSER<br></code></pre></td></tr></table></figure><p>移除用户超级管理员</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> cityserver <span class="hljs-keyword">WITH</span> NOSUPERUSER;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>线上事故</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM调优案例</title>
    <link href="/JVM%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/"/>
    <url>/JVM%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1-案例一-——测试环境服务异常挂掉"><a href="#1-案例一-——测试环境服务异常挂掉" class="headerlink" title="1. 案例一 ——测试环境服务异常挂掉"></a>1. 案例一 ——测试环境服务异常挂掉</h1><h2 id="1-问题"><a href="#1-问题" class="headerlink" title="1. 问题"></a>1. 问题</h2><p>测试环境服务异常挂掉</p><h2 id="2-排查步骤"><a href="#2-排查步骤" class="headerlink" title="2. 排查步骤"></a>2. 排查步骤</h2><p>查看操作系统日志，发现发生了OOM，操作系统的OOM KIiller 机制 将Java进程杀掉了（使用命令<code> egrep -i &#39;Out of memory&#39; /var/log/messages</code>）</p><blockquote><p>[root@sith-mom-test-node deploy]# egrep -i ‘Out of memory’ &#x2F;var&#x2F;log&#x2F;messages<br>May 28 10:19:07 sith-mom-test-node kernel: Out of memory: Kill process 12420 (java) score 161 or sacrifice child<br>May 28 10:19:07 sith-mom-test-node kernel: Out of memory: Kill process 12607 (java) score 161 or sacrifice child<br>May 28 10:19:07 sith-mom-test-node kernel: Out of memory: Kill process 12721 (java) score 161 or sacrifice child<br>May 28 17:07:24 sith-mom-test-node kernel: Out of memory: Kill process 10434 (java) score 92 or sacrifice child<br>May 28 17:34:42 sith-mom-test-node kernel: Out of memory: Kill process 9270 (java) score 75 or sacrifice child<br>May 28 17:34:42 sith-mom-test-node kernel: Out of memory: Kill process 9281 (java) score 75 or sacrifice child<br>May 28 17:50:18 sith-mom-test-node kernel: Out of memory: Kill process 24060 (java) score 64 or sacrifice child</p></blockquote><p>重新启动项目，使用<code>df -h</code>发现测试环境内存空闲也就20G，使用<code>jstat -gc 67825 3000 1000</code> 发现元空间占了10G以上，还在一直增长。（测试环境内存62G），因为jdk.8之后元空间使用的内存是本地内存，默认是-1， 即不限制，所以怀疑到了元空间</p><h2 id="3-修复"><a href="#3-修复" class="headerlink" title="3. 修复"></a>3. 修复</h2><p>在启动jar包时，加上了<code>-XX:MaxMetaspaceSize=20G</code>, 指定最大元空间大小, 问题修复，后续又感觉20G占用太大，又尝试降低10G， 5G， 目前设置的是1000M，5天Full GC 了200次，平均2小时3次， 一次5.8秒，还在持续调整（期待1小时一次Full GC, 一次1s）。</p><h1 id="3-案例二-——天气预报系统"><a href="#3-案例二-——天气预报系统" class="headerlink" title="3.案例二 ——天气预报系统"></a>3.案例二 ——天气预报系统</h1><p>天气预报系统，有一个展示所有城市天气预报的页面，由于城市比较多，需要分页去展示，于是先设置了一次查询5000条，由于每一条城市都需要再去给他设置对应的天气信息，所以搞了一个foreach每一条记录都需要new City()，然后再去set天气信息</p><p>初始参数是：</p><p>堆的最大和最小容量都设置了1536M, 年轻代是512M，使用的ParNew+CMS垃圾收集器，元空间256M</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">-Xms1536M -Xmx1536M -Xmn512M -Xss256K -XX:<span class="hljs-attribute">SurvivorRatio</span>=6 -XX:<span class="hljs-attribute">MetaspaceSize</span>=256M -XX:<span class="hljs-attribute">MaxMetaspaceSize</span>=512M  -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:<span class="hljs-attribute">CMSInitiatingOccupancyFraction</span>=75 -XX:+UseCMSInitiatingOccupancyOnly<br></code></pre></td></tr></table></figure><h2 id="3-2-观察GC整体情况"><a href="#3-2-观察GC整体情况" class="headerlink" title="3.2 观察GC整体情况"></a>3.2 观察GC整体情况</h2><ul><li><p>step1 : 运行<code> jps</code>看下, 查看当前java进程PID</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222821739.png" alt="image-20230228222821739"></p></li><li><p>step2: 运行 <code>jstat -gc 2593 3000 10000</code>，每隔3秒，打印下GC压力整体情况。观察可发现，程序突然开始频繁Young Gc 和Full GC。</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222903395.png" alt="image-20230228222903395"></p><h2 id="3-2-思考频繁Full-Gc-触发条件"><a href="#3-2-思考频繁Full-Gc-触发条件" class="headerlink" title="3.2 思考频繁Full Gc 触发条件"></a>3.2 思考频繁Full Gc 触发条件</h2><ul><li><p>调用System.gc()方法的调用。   <strong>-&gt; 不可能，系统中没这样调用</strong></p></li><li><p>云空间，方法区空间不足  <strong>-&gt; 不可能，观察MU并没有很大变化，说明元空间没有一直扩容，所以空间是够的</strong></p></li><li><p>老年代空间不足，对象转入老年代的场景有：</p><ul><li>大对象直接进入老年代：为了避免为大对象GC时，多次在survivor上来回复制而降低效率。   <strong>-&gt; 不可能，系统中没很多大对象</strong></li><li>长期存活的对象进入老年代：默认是经历了15次minor GC ，CMS是6次 <strong>-&gt; 可能，代码在频繁生成对象，且占用周期比较长。有可能是代码有问题，其实我们可以频繁生成对象，但是应该让他朝生夕死。</strong></li><li><strong>对象动态年龄判断</strong>：survivor区域里，对象年龄从小到大排序，当累加到某个年龄时，占用 survivor区域 的50%，就会把这个年龄大的对象都晋升到老年代。  <strong>-&gt; 可能，因为现在是频繁生成了对象，可以考虑年轻代调大一些。</strong></li></ul></li><li><p>老年代空间分配担保机制。 <strong>-&gt; 可能性不大，因为老年代挺大的</strong></p></li></ul><h2 id="3-3-调优步骤"><a href="#3-3-调优步骤" class="headerlink" title="3.3 调优步骤"></a>3.3 调优步骤</h2><p>如果是对于对象动态年龄判断机制导致的full gc较为频繁可以先试着优化下JVM参数，把年轻代适当调大点： -Xmn1024M</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">-Xms1536M -Xmx1536M -Xmn1024M -Xss256K -XX:SurvivorRatio=<span class="hljs-number">6</span> -XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=512M  -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=<span class="hljs-number">75</span> -XX:+UseCMSInitiatingOccupancyOnly<br></code></pre></td></tr></table></figure><p>我们发现young gc和full gc依然很频繁了，而且看到有大量的对象频繁的被挪动到老年代</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222923471.png" alt="image-20230228222923471"></p><p>这种情况我们可以借助jmap或者jvisualvm命令大概看下是什么对象</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222946533.png" alt="image-20230228222946533"></p><p>查到了有大量User对象产生，这个可能是问题所在，但不确定，还必须找到对应的代码确认，如何去找对应的代码了？ </p><p>1、代码里全文搜索生成User对象的地方(适合只有少数几处地方的情况) </p><p>2、如果生成User对象的地方太多，无法定位具体代码，我们可以同时分析下占用cpu较高的线程，一般有大量对象不断产生，对应的方法 代码肯定会被频繁调用，占用的cpu必然较高 </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222956571.png" alt="image-20230228222956571"></p><p>可以用上面讲过的jstack或jvisualvm来定位cpu使用较高的代码，最终定位到的代码如下： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/report&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WeatherReportController</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 模拟批量查询城市天气预报场景</span><br><span class="hljs-comment">   */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> ArrayList&lt;City&gt; <span class="hljs-title">queryCities</span><span class="hljs-params">()</span> </span>&#123;<br>    ArrayList&lt;City&gt; cities = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>      cities.add(<span class="hljs-keyword">new</span> City(String.valueOf(i),<span class="hljs-string">&quot;深圳&quot;</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> cities;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">City</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> String id;<br><br>  <span class="hljs-keyword">private</span> String name;<br><br>  <span class="hljs-keyword">private</span> String code;<br><br>  <span class="hljs-keyword">byte</span>[] info = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>*<span class="hljs-number">100</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>同时，java的代码也是需要优化的，一次查询出500M的对象出来，明显不合适，要根据之前说的各种原则尽量优化到合适的值，尽量消除这种朝生夕死的对象导致的full gc</p><p>改成批量查询500后，Full GC 基本不再发生</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223006680.png" alt="image-20230228223006680"></p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="3-案例三——-订单系统"><a href="#3-案例三——-订单系统" class="headerlink" title="3. 案例三—— 订单系统"></a>3. 案例三—— 订单系统</h1><p>有一个订单系统，需要支持每秒支持下300个订单。假定每个订单对象是1kb，那么每秒将会有300kb对象生成。</p><p>下单可能还涉及创建其他对象创建，比如库存，优惠卷，积分，以及这个系统可能还支持订单的查询，我们放大20倍，那么就是300 * 20  &#x3D; 6000kb，约60MB，也就是这个系统每秒会产生60M的垃圾。</p><p>假设机器是4核8G，那么一般可能会给我们虚拟机分配个四五G的内存，就会给堆分配个3G的内存，那么方法区分配256M，单个栈内存分配1M。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span> ‐Xms3072M ‐Xmx3072M ‐Xss1M ‐XX:MetaspaceSize=256M ‐XX:MaxMetaspaceSize=256M ‐XX:SurvivorRatio=<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>那么这么分配有什么问题呢？如果是一个并发量不大的系统，基本上也不会有什么问题，因为本身也没有多少对象在堆里生成。但是如果是我们上面说的亿级流量系统，就不能简简单单这么设置了，我们来分析一下：</p><p>堆分配的大小是3G，按照1:2分配年轻代和老年代的话，可以算出年轻代是1G，老年代是2G，年轻代再按照8:1:1细分eden和survivor，eden是800M，单个survivor是100M。如果每秒产生60M对象，优先在eden分配，也就是差不多13秒，eden就会被占满，发生minor GC，这是90%的对象已经被回收了，还存在一些正在使用的对象，假定是60M对象还不会被回收。</p><p>那么这60M对象会从Eden区移到S0区域，由于存在动态年龄判断，就是一批对象的总大小大于这块Survivor区域内存大小的，那么此时<strong>大于等于</strong>这批对象年龄最大值的对象，就可以直接进入老年代了。这样的话，每13秒就会有60M的对象被移入老年代。</p><p>那么大概五六分钟老年代的2G就会被占满，那么老年代一满就要发生full gc</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224246219.png" alt="image-20230228224246219"></p><p><a href="https://blog.csdn.net/weixin_44704538/article/details/108222022">(129条消息) JVM的STW(stop the world)机制及调优案例_JavaRecord的博客-CSDN博客_stw机制</a></p><p>来分析一下：我们这个系统其实没有很多会长久存在的对象，也就是老不死的对象，我们放在老年代的那些60M的对象，在一两秒后其实都会变为垃圾对象，在下一次full gc时都会被回收掉，那么我们这种业务场景，完全没必要给老年代设置2G的内存，根本用不到。</p><p>我们完全可以把年轻代设置的大一些，我们现在来对jvm参数进行一些更改。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span> ‐Xms3072M ‐Xmx3072M ‐Xmn2048M ‐Xss1M ‐XX:MetaspaceSize=256M ‐XX:MaxMetaspaceSize=256M ‐XX:SurvivorRatio=<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>此时需要25秒把伊甸园区放满，放满minor gc后有60M对象不被回收，要移到S0区，这时60M&lt;200M&#x2F;2，是可以移入S0区域的，下一次伊甸园区再放满做minor gc的时候，这时这60M对象所对应的订单已经生成了，已经变成了垃圾对象，是可以直接被回收的，所以没有什么对象是需要被移入老年代的。</p><p>那么这么一设置的话，这个系统是不是正常情况下基本不会再发生full gc了呢？就算发生，也是很久才会一次了。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224257622.png" alt="image-20230228224257622"></p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>xxlJob使用</title>
    <link href="/xxlJob%E4%BD%BF%E7%94%A8/"/>
    <url>/xxlJob%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-任务调度"><a href="#1-任务调度" class="headerlink" title="1. 任务调度"></a>1. 任务调度</h1><h2 id="1-什么是任务调度"><a href="#1-什么是任务调度" class="headerlink" title="1. 什么是任务调度"></a>1. 什么是任务调度</h2><p>任务调度是为了自动完成特定任务，在约定的特定时刻去执行任务的过程。</p><h2 id="2-什么场景会需要任务调度"><a href="#2-什么场景会需要任务调度" class="headerlink" title="2. 什么场景会需要任务调度"></a>2. 什么场景会需要任务调度</h2><ul><li>某电商平台需要每天上午10点，下午3点，晚上8点发放一批优惠券</li><li>某银行系统需要在信用卡到期还款日的前3天进行短信提醒</li><li>某财务系统需要每天凌晨结算前一天的财务数据</li></ul><h1 id="2-分布式任务调度"><a href="#2-分布式任务调度" class="headerlink" title="2. 分布式任务调度"></a>2. 分布式任务调度</h1><h2 id="1-什么是分布式任务调度"><a href="#1-什么是分布式任务调度" class="headerlink" title="1. 什么是分布式任务调度"></a>1. 什么是分布式任务调度</h2><p>采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong></p><h2 id="2-为什么需要分布式任务调度"><a href="#2-为什么需要分布式任务调度" class="headerlink" title="2. 为什么需要分布式任务调度"></a>2. 为什么需要分布式任务调度</h2><p>使用spring提供的@scheduled，也能实现调度的功能，为什么还需要分布式任务调度的呢？</p><ul><li>高可用：单机版的任务调度只能在一台机器上运行，程序出现异常后会导致服务不可用。</li><li>防止任务重复执行。当部署了多台服务，同一个定时任务需要控制在同一时间内，只有一个任务在执行。</li><li>单机处理存在极限。即使可以通过多线程提高单机的处理效率但能力依旧有限（CPU，内存，硬盘），依旧存在处理不过来的场景</li></ul><h1 id="2-xxl-Job"><a href="#2-xxl-Job" class="headerlink" title="2. xxl-Job"></a>2. xxl-Job</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>xxlJob是一个轻量级<strong>分布式任务调度</strong>平台</p><h2 id="2-设计思想"><a href="#2-设计思想" class="headerlink" title="2. 设计思想"></a>2. 设计思想</h2><ul><li>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</li><li>将任务抽象成分散的JobHandler，交由“执行器”统一管理，“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</li><li>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性；</li></ul><h2 id="3-系统组成"><a href="#3-系统组成" class="headerlink" title="3. 系统组成"></a>3. 系统组成</h2><ul><li><p><strong>调度模块（调度中心）</strong>：</p><p>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。</p><p>调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块；<br>支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除，GLUE开发和任务报警等，所有上述操作都会实时生效，同时支持监控调度结果以及执行日志，支持执行器Failover。</p></li><li><p><strong>执行模块（执行器）</strong>：<br>负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效；<br>接收“调度中心”的执行请求、终止请求和日志请求等。</p></li></ul><h1 id="3-如何自己去实现一个XXL-JOb"><a href="#3-如何自己去实现一个XXL-JOb" class="headerlink" title="3. 如何自己去实现一个XXL JOb"></a>3. 如何自己去实现一个XXL JOb</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><ol><li><strong>任务调度</strong>：支持定时任务、延迟任务和周期性任务。</li><li><strong>任务执行</strong>：任务分发给不同的执行节点。</li><li><strong>任务管理</strong>：支持任务的增加、删除、修改、暂停和恢复。</li><li><strong>监控和日志</strong>：记录任务执行情况和日志，便于监控和调试。</li><li><strong>高可用性</strong>：保证调度系统的高可用性和可靠性。</li></ol><h2 id="2-系统设计"><a href="#2-系统设计" class="headerlink" title="2. 系统设计"></a>2. 系统设计</h2><ol><li><strong>调度中心</strong>：<ul><li>负责任务的调度、分发和管理。</li><li>维护任务的元数据和调度策略。</li><li>提供管理界面（Web 界面）用于任务的增删改查。</li></ul></li><li><strong>执行器</strong>：<ul><li>接收调度中心分发的任务并执行。</li><li>反馈任务的执行状态和日志到调度中心。</li></ul></li><li><strong>通信机制</strong>：<ul><li>调度中心和执行器之间需要一个可靠的通信机制，常见的有 HTTP、RPC 等。</li></ul></li></ol><h2 id="3-技术选型"><a href="#3-技术选型" class="headerlink" title="3. 技术选型"></a>3. 技术选型</h2><ol><li><strong>编程语言</strong>：Java 是一个不错的选择，因为 XXL-JOB 本身就是基于 Java 实现的，且 Java 有丰富的生态支持。</li><li><strong>持久化存储</strong>：MySQL 用于存储任务元数据和执行日志。</li><li><strong>通信协议</strong>：RESTful API 或者 gRPC。</li><li><strong>调度框架</strong>：Quartz，可以用来实现复杂的调度策略。</li><li><strong>监控与日志</strong>：Logback 或 Log4j2 记录日志，Prometheus 和 Grafana 用于监控。</li></ol><h2 id="4-具体实现步骤"><a href="#4-具体实现步骤" class="headerlink" title="4. 具体实现步骤"></a>4. 具体实现步骤</h2><h4 id="1-创建调度中心"><a href="#1-创建调度中心" class="headerlink" title="1. 创建调度中心"></a>1. 创建调度中心</h4><ul><li><strong>任务管理接口</strong>：提供增删改查任务的 API。</li><li><strong>任务调度模块</strong>：使用 Quartz 来调度任务，并实现任务的分发。</li><li><strong>任务监控与日志模块</strong>：记录任务执行的日志和状态，提供监控接口。</li></ul><h4 id="2-执行器实现"><a href="#2-执行器实现" class="headerlink" title="2. 执行器实现"></a>2. 执行器实现</h4><ul><li><strong>任务执行接口</strong>：实现一个 HTTP 或 RPC 接口，用于接收调度中心分发的任务。</li><li><strong>任务执行逻辑</strong>：根据任务的定义执行具体的任务逻辑，并反馈执行结果和日志。</li></ul><h4 id="3-调度和执行流程"><a href="#3-调度和执行流程" class="headerlink" title="3. 调度和执行流程"></a>3. 调度和执行流程</h4><ul><li><strong>任务调度</strong>：Quartz 触发任务调度后，通过 HTTP 或 RPC 调用执行器的任务执行接口。</li><li><strong>任务执行反馈</strong>：执行器在完成任务后，将结果和日志反馈给调度中心，调度中心更新任务状态和日志。</li></ul><h4 id="4-高可用设计"><a href="#4-高可用设计" class="headerlink" title="4. 高可用设计"></a>4. 高可用设计</h4><ul><li><strong>调度中心高可用</strong>：通过多实例部署和负载均衡实现高可用。</li><li><strong>执行器高可用</strong>：执行器也是多实例部署，调度中心根据负载均衡策略选择合适的执行器。</li></ul><h3 id="五、部署与运维"><a href="#五、部署与运维" class="headerlink" title="五、部署与运维"></a>五、部署与运维</h3><ol><li><strong>使用 Docker 容器化调度中心和执行器</strong>。</li><li><strong>使用 Kubernetes 实现调度中心和执行器的高可用部署</strong>。</li><li><strong>使用ELK监控日志</strong></li></ol><h2 id="4-Spring-Boot-集成-XXL-JOB"><a href="#4-Spring-Boot-集成-XXL-JOB" class="headerlink" title="4 Spring Boot 集成 XXL-JOB"></a>4 <strong>Spring Boot 集成 XXL-JOB</strong></h2><p>参考<a href="https://www.xuxueli.com/xxl-job/#%E4%BA%8C%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8">快速入门</a></p><h3 id="1-配置运行调度中心（xxl-job-admin）"><a href="#1-配置运行调度中心（xxl-job-admin）" class="headerlink" title="1. 配置运行调度中心（xxl-job-admin）"></a>1. 配置运行调度中心（xxl-job-admin）</h3><ol><li>首先从源码仓库中下载代码</li><li>执行doc&#x2F;db<code>目录下有数据库脚本</code>tables_xxl_job.sql，初始化调度数据库 <code>xxl_job</code></li><li>修改 xxl-job-admin 的配置文件，主要是修改数据源信息，若需要用到邮件报警功能，需要配置邮箱</li><li>启动XxlJobAdminApplication，正常启动后，访问地址为：<code>http://localhost:8080/xxl-job-admin</code>，默认的账户为 admin，密码为 123456，</li></ol><h3 id="2-配置运行执行器项目（xxl-job-executor）"><a href="#2-配置运行执行器项目（xxl-job-executor）" class="headerlink" title="2. 配置运行执行器项目（xxl-job-executor）"></a>2. 配置运行执行器项目（xxl-job-executor）</h3><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">implementation &#x27;com.xuxueli:xxl-job-core:2.3.0&#x27;<br></code></pre></td></tr></table></figure></li><li><p>加入配置</p></li></ol><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">### 调度中心部署跟地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行&quot;执行器心跳注册&quot;和&quot;任务结果回调&quot;；为空则关闭自动注册；</span><br><span class="hljs-meta">xxl.job.admin.addresses</span>=<span class="hljs-string">http://localhost:6100/xxl-job-admin</span><br><span class="hljs-comment">### 执行器通讯TOKEN [选填]：非空时启用；</span><br><span class="hljs-meta">xxl.job.accessToken</span>=<span class="hljs-string"></span><br><span class="hljs-comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span><br><span class="hljs-meta">xxl.job.executor.appname</span>=<span class="hljs-string">xxl-job-executor-city-eureka</span><br><span class="hljs-comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span><br><span class="hljs-meta">xxl.job.executor.address</span>=<span class="hljs-string"></span><br><span class="hljs-comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯时用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;；</span><br><span class="hljs-meta">xxl.job.executor.ip</span>=<span class="hljs-string">localhost</span><br><span class="hljs-comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span><br><span class="hljs-meta">xxl.job.executor.port</span>=<span class="hljs-string">9999</span><br><span class="hljs-comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span><br><span class="hljs-meta">xxl.job.executor.logpath</span>=<span class="hljs-string">/data/applogs/xxl-job/jobhandler</span><br><span class="hljs-comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span><br><span class="hljs-meta">xxl.job.executor.logretentiondays</span>=<span class="hljs-string">30</span><br></code></pre></td></tr></table></figure><ol start="3"><li>在 config 包下创建 <code>XxlJobConfig</code> 类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr.city.config;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * xxl-job config</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XxlJobConfig</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String accessToken;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String ip;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String logPath;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> logRetentionDays;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title">xxlJobExecutor</span><span class="hljs-params">()</span> </span>&#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        XxlJobSpringExecutor xxlJobSpringExecutor = <span class="hljs-keyword">new</span> XxlJobSpringExecutor();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setAddress(address);<br>        xxlJobSpringExecutor.setIp(ip);<br>        xxlJobSpringExecutor.setPort(port);<br>        xxlJobSpringExecutor.setAccessToken(accessToken);<br>        xxlJobSpringExecutor.setLogPath(logPath);<br>        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);<br><br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>编写 JobHandler</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleXxlJob</span> </span>&#123;<br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demoJobHandler</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行定时任务，执行时间为：&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-BEAN模式测试"><a href="#3-BEAN模式测试" class="headerlink" title="3. BEAN模式测试"></a>3. BEAN模式测试</h3><p>BEAN模式执行器：每个执行器都是Spring的一个Bean实例，XXL-JOB通过注解 <code>@XxlJob</code>的方式进行任务开发；</p><ol><li>编写 JobHandler</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleXxlJob</span> </span>&#123;<br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demoJobHandler</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行定时任务，执行时间为：&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>在执行器管理页面添加该执行器。</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114165019091.png" alt="image-20231114165019091"></p><ol start="3"><li>在任务管理界面添加我们刚才开发的任务，运行模式选择BEAN</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114165049371.png" alt="image-20231114165049371"></p><ol start="4"><li>在操作页面，点击执行一次</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114165154323.png" alt="image-20231114165154323"></p><h3 id="4-GLUE-Java-模式测试"><a href="#4-GLUE-Java-模式测试" class="headerlink" title="4. GLUE(Java)模式测试"></a>4. GLUE(Java)模式测试</h3><ol><li>在任务管理界面添加一个新任务，运行模式选择BEAN</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114183450401.png" alt="image-20231114183450401"></p><ol start="2"><li>编辑需要执行的代码</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114183527467.png" alt="image-20231114183527467"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114183541042.png" alt="image-20231114183541042"></p><ol start="3"><li>在操作页面，点击执行一次</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114183617278.png" alt="image-20231114183617278"></p><ol start="5"><li>执行日志打印</li></ol><p>需要使用<code>XxlJobHelper.log</code>打印执行日志；</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114184326029.png" alt="image-20231114184326029"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114184858772.png" alt="image-20231114184858772"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231114184353146.png" alt="image-20231114184353146"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pgsql</title>
    <link href="/pgsql/"/>
    <url>/pgsql/</url>
    
    <content type="html"><![CDATA[<h1 id="1-pgsql的优势"><a href="#1-pgsql的优势" class="headerlink" title="1. pgsql的优势"></a>1. pgsql的优势</h1><h3 id="1-开源和社区支持"><a href="#1-开源和社区支持" class="headerlink" title="1. 开源和社区支持"></a>1. <strong>开源和社区支持</strong></h3><ul><li><strong>开源</strong>：PostgreSQL 是完全开源的，无需支付许可费用。</li><li><strong>活跃的社区</strong>：有一个活跃的社区提供支持和开发，不断改进和更新功能。</li></ul><h3 id="2-强大的功能集"><a href="#2-强大的功能集" class="headerlink" title="2. 强大的功能集"></a>2. <strong>强大的功能集</strong></h3><ul><li><strong>ACID 合规</strong>：完全遵循 ACID 原则，确保数据的可靠性和一致性。</li><li><strong>高级 SQL 功能</strong>：支持复杂查询、子查询、窗口函数、CTE（Common Table Expressions）等。</li><li><strong>并发控制</strong>：使用多版本并发控制（MVCC）实现高效并发处理，减少锁争用。</li></ul><h3 id="3-扩展性和可扩展性"><a href="#3-扩展性和可扩展性" class="headerlink" title="3. 扩展性和可扩展性"></a>3. <strong>扩展性和可扩展性</strong></h3><ul><li><strong>扩展支持</strong>：支持多种扩展，如 PostGIS（地理信息系统扩展）、Full Text Search（全文搜索扩展）。</li><li><strong>可编程性</strong>：支持存储过程和触发器，可以使用多种语言编写，如 PL&#x2F;pgSQL、PL&#x2F;Python、PL&#x2F;Perl。</li></ul><h3 id="4-数据完整性"><a href="#4-数据完整性" class="headerlink" title="4. 数据完整性"></a>4. <strong>数据完整性</strong></h3><ul><li><strong>数据类型丰富</strong>：支持丰富的数据类型，包括 JSON、数组、范围、枚举、几何数据等。</li><li><strong>约束和触发器</strong>：支持多种约束（如主键、外键、唯一约束）和触发器，确保数据完整性。</li><li><strong>外部数据包装器</strong>：通过 Foreign Data Wrapper（FDW）可以查询外部数据源。</li></ul><h3 id="5-高性能和优化"><a href="#5-高性能和优化" class="headerlink" title="5. 高性能和优化"></a>5. <strong>高性能和优化</strong></h3><ul><li><strong>并行查询</strong>：支持并行查询，充分利用多核 CPU 提高查询性能。</li><li><strong>高级索引</strong>：支持多种索引类型（如 B-tree、GIN、GiST、BRIN），满足不同查询需求。</li><li><strong>内存优化</strong>：支持表和索引的内存缓存，提高访问速度。</li></ul><h3 id="6-高可用性和容灾"><a href="#6-高可用性和容灾" class="headerlink" title="6. 高可用性和容灾"></a>6. <strong>高可用性和容灾</strong></h3><ul><li><strong>流复制</strong>：支持主从复制（同步和异步），实现高可用性。</li><li><strong>逻辑复制</strong>：支持逻辑复制，可以进行部分数据的复制和定制化的数据同步。</li><li><strong>备份和恢复</strong>：支持热备份和 PITR（时间点恢复），确保数据安全。</li></ul><h3 id="7-灵活性和兼容性"><a href="#7-灵活性和兼容性" class="headerlink" title="7. 灵活性和兼容性"></a>7. <strong>灵活性和兼容性</strong></h3><ul><li><strong>跨平台支持</strong>：支持多种操作系统，如 Linux、Windows、macOS。</li><li><strong>标准兼容</strong>：高度兼容 SQL 标准，易于迁移和集成。</li><li><strong>扩展支持</strong>：通过插件和扩展（如 pg_partman、pg_stat_statements）可以扩展功能。</li></ul><h3 id="8-管理和监控工具"><a href="#8-管理和监控工具" class="headerlink" title="8. 管理和监控工具"></a>8. <strong>管理和监控工具</strong></h3><ul><li><strong>pgAdmin</strong>：强大的图形化管理工具，便于管理和监控数据库。</li><li><strong>内置统计功能</strong>：提供丰富的统计信息和视图，便于监控和优化数据库性能。</li></ul><h3 id="9-安全性"><a href="#9-安全性" class="headerlink" title="9. 安全性"></a>9. <strong>安全性</strong></h3><ul><li><strong>访问控制</strong>：支持基于角色和用户的访问控制，提供细粒度的权限管理。</li><li><strong>加密</strong>：支持数据传输加密和磁盘加密，确保数据安全。</li><li><strong>认证方式</strong>：支持多种认证方式，如密码认证、Kerberos、LDAP 等。</li></ul><h1 id="2-pgsql数据类型"><a href="#2-pgsql数据类型" class="headerlink" title="2. pgsql数据类型"></a>2. pgsql数据类型</h1><h3 id="1-数值类型"><a href="#1-数值类型" class="headerlink" title="1. 数值类型"></a>1. 数值类型</h3><ul><li><strong>整数类型</strong><ul><li><code>smallint</code>：2字节整数，范围 -32,768 到 32,767</li><li><code>integer</code>：4字节整数，范围 -2,147,483,648 到 2,147,483,647</li><li><code>bigint</code>：8字节整数，范围 -9,223,372,036,854,775,808 到 9,223,372,036,854,775,807</li></ul></li><li><strong>小数类型</strong><ul><li><code>decimal</code> 或 <code>numeric</code>：可变精度，适用于需要精确小数的场合</li><li><code>real</code>：4字节浮点数</li><li><code>double precision</code>：8字节浮点数</li></ul></li><li><strong>序列&#x2F;自动增长</strong><ul><li><code>serial</code>：自动递增的4字节整数</li><li><code>bigserial</code>：自动递增的8字节整数</li></ul></li></ul><h3 id="2-字符串类型"><a href="#2-字符串类型" class="headerlink" title="2. 字符串类型"></a>2. 字符串类型</h3><ul><li><strong>定长字符串</strong><ul><li><code>char(n)</code>：固定长度字符类型，长度为 n</li></ul></li><li><strong>变长字符串</strong><ul><li><code>varchar(n)</code>：可变长度字符类型，最大长度为 n</li><li><code>text</code>：可变长度字符类型，没有长度限制</li></ul></li></ul><h3 id="3-日期和时间类型"><a href="#3-日期和时间类型" class="headerlink" title="3. 日期和时间类型"></a>3. 日期和时间类型</h3><ul><li>日期和时间<ul><li><code>date</code>：日期类型，范围为 4713 BC 到 5874897 AD</li><li><code>time</code>：无时区的时间类型</li><li><code>timestamp</code>：无时区的时间戳类型</li><li><code>timestamptz</code>：带时区的时间戳类型</li><li><code>interval</code>：时间间隔</li></ul></li></ul><h3 id="4-布尔类型"><a href="#4-布尔类型" class="headerlink" title="4. 布尔类型"></a>4. 布尔类型</h3><ul><li>布尔值<ul><li><code>boolean</code>：值为 <code>TRUE</code>、<code>FALSE</code> 或 <code>NULL</code></li></ul></li></ul><h3 id="5-枚举类型"><a href="#5-枚举类型" class="headerlink" title="5. 枚举类型"></a>5. 枚举类型</h3><ul><li>枚举<ul><li><code>enum</code>：定义一组固定值</li></ul></li></ul><h3 id="6-数组类型"><a href="#6-数组类型" class="headerlink" title="6. 数组类型"></a>6. 数组类型</h3><ul><li>数组<ul><li>任意类型的数组，如 <code>integer[]</code>、<code>text[]</code></li></ul></li></ul><h3 id="7-JSON-类型"><a href="#7-JSON-类型" class="headerlink" title="7. JSON 类型"></a>7. JSON 类型</h3><ul><li>JSON 数据<ul><li><code>json</code>：存储JSON数据</li><li><code>jsonb</code>：存储二进制JSON数据，支持索引和更快的查询</li></ul></li></ul><h3 id="8-范围类型"><a href="#8-范围类型" class="headerlink" title="8. 范围类型"></a>8. 范围类型</h3><ul><li>范围<ul><li><code>int4range</code>、<code>int8range</code>、<code>numrange</code>、<code>tsrange</code>、<code>tstzrange</code>、<code>daterange</code>：表示范围值</li></ul></li></ul><h3 id="9-几何类型"><a href="#9-几何类型" class="headerlink" title="9. 几何类型"></a>9. 几何类型</h3><ul><li>几何数据<ul><li><code>point</code>、<code>line</code>、<code>lseg</code>、<code>box</code>、<code>path</code>、<code>polygon</code>、<code>circle</code>：用于几何计算的类型</li></ul></li></ul><h3 id="10-网络地址类型"><a href="#10-网络地址类型" class="headerlink" title="10. 网络地址类型"></a>10. 网络地址类型</h3><ul><li>网络地址<ul><li><code>cidr</code>：IPv4或IPv6网络</li><li><code>inet</code>：IPv4或IPv6地址</li><li><code>macaddr</code>：MAC地址</li></ul></li></ul><h3 id="11-UUID-类型"><a href="#11-UUID-类型" class="headerlink" title="11. UUID 类型"></a>11. UUID 类型</h3><ul><li>UUID<ul><li><code>uuid</code>：通用唯一标识符</li></ul></li></ul><h3 id="12-Hstore-类型"><a href="#12-Hstore-类型" class="headerlink" title="12. Hstore 类型"></a>12. Hstore 类型</h3><ul><li>键值对存储<ul><li><code>hstore</code>：存储键值对数据</li></ul></li></ul><h3 id="13-复合类型"><a href="#13-复合类型" class="headerlink" title="13. 复合类型"></a>13. 复合类型</h3><ul><li>复合<ul><li>用户定义的复合类型，包含多个字段</li></ul></li></ul><h1 id="3-pgsql索引类型"><a href="#3-pgsql索引类型" class="headerlink" title="3. pgsql索引类型"></a>3. pgsql索引类型</h1><h3 id="1-B-tree-索引"><a href="#1-B-tree-索引" class="headerlink" title="1. B-tree 索引"></a>1. B-tree 索引</h3><ul><li><p><strong>特点</strong>：默认索引类型，适用于大多数情况。</p></li><li><p><strong>用途</strong>：适用于等值查询、范围查询、排序。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_btree <span class="hljs-keyword">ON</span> example_table (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="2-Hash-索引"><a href="#2-Hash-索引" class="headerlink" title="2. Hash 索引"></a>2. Hash 索引</h3><ul><li><p><strong>特点</strong>：适用于等值查询，不支持范围查询。</p></li><li><p><strong>用途</strong>：仅适用于等值比较，如 <code>=</code> 和 <code>IN</code>。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_hash <span class="hljs-keyword">ON</span> example_table <span class="hljs-keyword">USING</span> hash (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="3-GIN（Generalized-Inverted-Index）"><a href="#3-GIN（Generalized-Inverted-Index）" class="headerlink" title="3. GIN（Generalized Inverted Index）"></a>3. GIN（Generalized Inverted Index）</h3><ul><li><p><strong>特点</strong>：适用于包含复杂结构数据的列，如数组、全文搜索。</p></li><li><p><strong>用途</strong>：支持多值包含查询，如数组、JSONB、全文搜索。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_gin <span class="hljs-keyword">ON</span> example_table <span class="hljs-keyword">USING</span> gin (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="4-GiST（Generalized-Search-Tree）"><a href="#4-GiST（Generalized-Search-Tree）" class="headerlink" title="4. GiST（Generalized Search Tree）"></a>4. GiST（Generalized Search Tree）</h3><ul><li><p><strong>特点</strong>：适用于需要自定义索引行为的场景。</p></li><li><p><strong>用途</strong>：支持几何数据、全文搜索、范围查询、KNN查询等。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_gist <span class="hljs-keyword">ON</span> example_table <span class="hljs-keyword">USING</span> gist (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="5-SP-GiST（Space-Partitioned-Generalized-Search-Tree）"><a href="#5-SP-GiST（Space-Partitioned-Generalized-Search-Tree）" class="headerlink" title="5. SP-GiST（Space-Partitioned Generalized Search Tree）"></a>5. SP-GiST（Space-Partitioned Generalized Search Tree）</h3><ul><li><p><strong>特点</strong>：适用于空间数据和稀疏数据。</p></li><li><p><strong>用途</strong>：支持空间数据、高维数据等。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_spgist <span class="hljs-keyword">ON</span> example_table <span class="hljs-keyword">USING</span> spgist (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="6-BRIN（Block-Range-INdexes）"><a href="#6-BRIN（Block-Range-INdexes）" class="headerlink" title="6. BRIN（Block Range INdexes）"></a>6. BRIN（Block Range INdexes）</h3><ul><li><p><strong>特点</strong>：适用于非常大的表，存储空间小，适合顺序扫描。</p></li><li><p><strong>用途</strong>：适用于顺序访问的大型表。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_brin <span class="hljs-keyword">ON</span> example_table <span class="hljs-keyword">USING</span> brin (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="7-Full-Text-Search-索引"><a href="#7-Full-Text-Search-索引" class="headerlink" title="7. Full Text Search 索引"></a>7. Full Text Search 索引</h3><ul><li><p><strong>特点</strong>：适用于全文搜索。</p></li><li><p><strong>用途</strong>：为文本数据创建高效的全文搜索索引。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_tsvector <span class="hljs-keyword">ON</span> example_table <span class="hljs-keyword">USING</span> gin (to_tsvector(<span class="hljs-string">&#x27;english&#x27;</span>, <span class="hljs-built_in">column_name</span>));<br></code></pre></td></tr></table></figure></li></ul><h3 id="8-Composite-索引"><a href="#8-Composite-索引" class="headerlink" title="8. Composite 索引"></a>8. Composite 索引</h3><ul><li><p><strong>特点</strong>：包含多个列的组合索引。</p></li><li><p><strong>用途</strong>：优化涉及多个列的查询。</p></li><li><p>示例</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">CREATE</span> INDEX idx_example_composite <span class="hljs-literal">ON</span> example_table (column<span class="hljs-number">1</span>, column<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="9-Partial-索引"><a href="#9-Partial-索引" class="headerlink" title="9. Partial 索引"></a>9. Partial 索引</h3><ul><li><p><strong>特点</strong>：基于条件的部分索引。</p></li><li><p><strong>用途</strong>：只索引满足特定条件的行，减少索引大小。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_example_partial <span class="hljs-keyword">ON</span> example_table (<span class="hljs-built_in">column_name</span>) <span class="hljs-keyword">WHERE</span> condition;<br></code></pre></td></tr></table></figure></li></ul><h3 id="10-Unique-索引"><a href="#10-Unique-索引" class="headerlink" title="10. Unique 索引"></a>10. Unique 索引</h3><ul><li><p><strong>特点</strong>：确保列值唯一。</p></li><li><p><strong>用途</strong>：保证列值唯一性，自动创建在主键和唯一约束上。</p></li><li><p>示例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> idx_example_unique <span class="hljs-keyword">ON</span> example_table (<span class="hljs-built_in">column_name</span>);<br></code></pre></td></tr></table></figure></li></ul><h3 id="11-Expression-索引"><a href="#11-Expression-索引" class="headerlink" title="11. Expression 索引"></a>11. Expression 索引</h3><ul><li><p><strong>特点</strong>：基于表达式的索引。</p></li><li><p><strong>用途</strong>：对计算列或表达式创建索引。</p></li><li><p>示例</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">CREATE</span> INDEX idx_example_expression <span class="hljs-literal">ON</span> example_table ((column<span class="hljs-number">1</span> + column<span class="hljs-number">2</span>));<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>内存泄漏和内存溢出</title>
    <link href="/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%92%8C%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/"/>
    <url>/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%92%8C%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="1-内存泄漏-Memory-Leak"><a href="#1-内存泄漏-Memory-Leak" class="headerlink" title="1.内存泄漏 (Memory Leak)"></a>1.内存泄漏 (Memory Leak)</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. <strong>定义</strong></h2><p> 内存泄漏是指程序未能释放已经不再使用的内存，从而导致内存资源被浪费。尽管这些内存不再被程序使用，但由于程序仍然持有对它们的引用，垃圾收集器无法回收它们。</p><h2 id="2-症状："><a href="#2-症状：" class="headerlink" title="2. 症状："></a>2. <strong>症状</strong>：</h2><ul><li>随着时间推移，程序占用的内存不断增加。</li><li>程序可能在长时间运行后变得越来越慢。</li><li>最终可能导致内存溢出错误（OutOfMemoryError）。</li></ul><h2 id="3-原因："><a href="#3-原因：" class="headerlink" title="3. 原因："></a>3. <strong>原因</strong>：</h2><ul><li>忘记移除不再使用的对象引用。</li><li>使用静态集合（如 <code>HashMap</code>、<code>ArrayList</code>）时未及时清理其中的对象。</li><li>事件监听器、回调函数未解除绑定。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MemoryLeakExample</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; objectList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addObject</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br>        objectList.add(obj);  <span class="hljs-comment">// 对象一直被添加进集合中，但未被移除</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MemoryLeakExample example = <span class="hljs-keyword">new</span> MemoryLeakExample();<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            example.addObject(<span class="hljs-keyword">new</span> Object());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-内存溢出-OutOfMemoryError"><a href="#2-内存溢出-OutOfMemoryError" class="headerlink" title="2. 内存溢出 (OutOfMemoryError)"></a>2. 内存溢出 (OutOfMemoryError)</h1><h2 id="1-定义："><a href="#1-定义：" class="headerlink" title="1. 定义："></a>1. <strong>定义</strong>：</h2><p> 内存溢出是指程序在请求内存时，堆内存已满且垃圾收集器无法回收更多的内存，从而导致 JVM 抛出 <code>OutOfMemoryError</code> 错误。</p><h2 id="2-症状"><a href="#2-症状" class="headerlink" title="2. 症状"></a>2. 症状</h2><ul><li><p>程序突然崩溃并抛出 <code>OutOfMemoryError</code>。</p></li><li><p>无法再分配新的对象。</p></li></ul><h2 id="3-原因：-1"><a href="#3-原因：-1" class="headerlink" title="3. 原因："></a>3. <strong>原因</strong>：</h2><ul><li>创建了过多的大对象或集合。</li><li>内存泄漏导致的内存占用持续增加。</li><li>JVM 堆内存设置不足以满足应用的需求。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OutOfMemoryErrorExample</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        List&lt;<span class="hljs-keyword">int</span>[]&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">1000000</span>]);  <span class="hljs-comment">// 不断创建大数组，导致内存耗尽</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="3-区别"><a href="#3-区别" class="headerlink" title="3. 区别"></a>3. 区别</h1><p><strong>内存泄漏</strong>：</p><ul><li>由于程序错误，内存未被正确释放。</li><li>内存使用量随时间增加，最终可能导致内存溢出。</li><li>可以通过分析程序逻辑和使用工具（如 VisualVM、MAT）定位未释放的内存。</li></ul><p><strong>内存溢出</strong>：</p><ul><li>直接结果是 JVM 无法分配内存，抛出 <code>OutOfMemoryError</code>。</li><li>可能是内存泄漏的结果，也可能是程序需要的内存超过了 JVM 配置的最大堆内存。</li><li>可以通过调整 JVM 堆内存大小（如 <code>-Xmx</code> 参数）和优化程序内存使用来解决。</li></ul><h1 id="4-OOM等内存分析"><a href="#4-OOM等内存分析" class="headerlink" title="4 OOM等内存分析"></a>4 OOM等内存分析</h1><ul><li>方式： 检查是否有OutOfMemory 等内存异常， 检查哪些对象在系统中数量最大，避免频繁生成新对象，类似天气预报系统里有一个分页展示，每次批量去操作5000个对象，会频繁触发Minor GC 和 Full GC，后面调成500个，基本上就没有Full GC了。</li><li>工具：jmap ‐dump，生成Java虚拟机的堆转储快照dump文件，用jvisualvm命令工具导入该dump文件分析，最多的类是哪些</li><li>参考地址：<a href="https://pyr9.github.io/java%E5%91%BD%E4%BB%A4--jmap%E5%B7%A5%E5%85%B7/">java命令–jmap工具 - 楼上有只喵 (pyr9.github.io)</a></li></ul><h1 id="5-CPU分析，哪些方法占用的大量CPU时间"><a href="#5-CPU分析，哪些方法占用的大量CPU时间" class="headerlink" title="5 CPU分析，哪些方法占用的大量CPU时间"></a>5 CPU分析，哪些方法占用的大量CPU时间</h1><ul><li>方式：<ul><li>命令top -p ，显示你的java进程的内存情况，找到当前进程的PID</li><li>top -Hp，获取每个线程的内存情况，获取CPU比较高的线程id，并专成16进制</li><li>执行 <code>jstack PID|grep -A 10 4cd0</code>得到线程堆栈信息，找出可能存在问题的代码，比如大量计算，或者循环new 对象</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ的消息零丢失方案</title>
    <link href="/RabbitMQ%E7%9A%84%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7/"/>
    <url>/RabbitMQ%E7%9A%84%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ如何保证消息的可靠性？"><a href="#RabbitMQ如何保证消息的可靠性？" class="headerlink" title="RabbitMQ如何保证消息的可靠性？"></a>RabbitMQ如何保证消息的可靠性？</h1><h2 id="哪些环节会有丢消息的可能？"><a href="#哪些环节会有丢消息的可能？" class="headerlink" title="哪些环节会有丢消息的可能？"></a>哪些环节会有丢消息的可能？</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233457541.png" alt="image-20230228233457541"></p><h3 id="普通消息处理流程"><a href="#普通消息处理流程" class="headerlink" title="普通消息处理流程"></a>普通消息处理流程</h3><ol><li>消息生成者发送消息</li><li>MQ收到消息，将消息进行存储（持久化到硬盘）。</li><li>返回ACK给生产者</li><li>MQ push 消息给对应的消费者，然后等待消费者返回ACK</li><li>如果消息消费者在指定时间内成功返回ack，那么MQ认为消息消费成功，在存储中删除消息，即执行第6步；如果MQ在指定时间内没有收到ACK，则认为消息消费失败，会尝试重新push消息,重复执行4、5、6步骤</li><li>MQ删除消息</li></ol><h3 id="丢消息的场景"><a href="#丢消息的场景" class="headerlink" title="丢消息的场景"></a>丢消息的场景</h3><ul><li>1，2，4三个场景，都是跨网络的，而跨网络就肯定会有丢消息的可能。</li><li>关于3这个环节，通常MQ存盘时都会先写入操作系统的缓存page cache中，然后再由操作系统异步的将消息写入硬盘。这个中间有个时间差，就可能会造成消息丢失。如果服务挂了，缓存中还没有来得及写入硬盘的消息就会丢失。这也是任何用户态的应用程序无法避免的。</li><li>对于任何MQ产品，都应该从这四个方面来考虑数据的安全性。那我们看看用RabbitMQ时要如何解决这个问题。</li></ul><h2 id="RabbitMQ消息零丢失方案"><a href="#RabbitMQ消息零丢失方案" class="headerlink" title="RabbitMQ消息零丢失方案?"></a>RabbitMQ消息零丢失方案?</h2><h3 id="1-生产者保证消息正确发送到RibbitMQ"><a href="#1-生产者保证消息正确发送到RibbitMQ" class="headerlink" title="1. 生产者保证消息正确发送到RibbitMQ?"></a>1. 生产者保证消息正确发送到RibbitMQ?</h3><ul><li><p><strong>方案一：</strong>可以使用生产者确认机制。</p><p>通过多次确认的方式，保证生产者的消息能够正确的发送到RabbitMQ中。RabbitMQ的生产者确认机制分为同步确认和异步确认。</p><ul><li><p>同步确认主要是通过在生产者端使用Channel.waitForConfirmsOrDie()指定一个等待确认的完成时间。</p></li><li><p>异步确认机制则是通过在生产者端注入两个回调确认函数。第一个函数是在生产者发送消息时调用，第二个函数则是生产者收到Broker的消息确认请求时调用。两个函数需要通过sequenceNumber自行完成消息的前后对应。sequenceNumber的生成方式需要通过channel的序列获取。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.addConfirmListener(ConfirmCallback var1,ConfirmCallback var2)<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>方案二：</strong>手动事务</p><ul><li><p>手动事务机制主要有几个关键的方法： channel.txSelect() 开启事务；channel.txCommit() 提交事务； channel.txRollback() 回滚事务。用这几个方法来进行事务管理。比如在创建订单后开启事务，减库存成功后提交事务，失败时回滚。</p></li><li><p>这种方式需要手动控制事务逻辑，并且手动事务会对channel产生阻塞，造成吞吐量下降</p></li></ul></li></ul><h3 id="2-RabbitMQ-主从消息同步时不丢消息"><a href="#2-RabbitMQ-主从消息同步时不丢消息" class="headerlink" title="2. RabbitMQ 主从消息同步时不丢消息?"></a>2. <strong>RabbitMQ 主从消息同步时不丢消息</strong>?</h3><ul><li>不使用普通集群模式， 使用镜像集群模式</li><li>给包含重要消息的队列建立一个远端备份。</li></ul><blockquote><ul><li><p>普通集群模式</p><ul><li><strong>queue的消息</strong>，只会放在<strong>一个rabbtimq实例</strong>上。<strong>每个实例都同步queue的结构和queue消息的真正位置</strong>。</li><li>消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从queue所在实例上拉取数据过来。</li><li>这种集群模式的消息可靠性不是很高。因为如果其中有个节点服务宕机了，那这个节点上的数据就无法消费了，需要等到这个节点服务恢复后才能消费。</li></ul></li><li><p>镜像集群模式</p><ul><li><p>这种模式是在普通集群模式基础上的一种增强方案，这也就是RabbitMQ的官方HA高可用方案。</p></li><li><p>这种模式会在镜像节点中间主动进行消息同步，而不是在客户端拉取消息时临时同步。这种模式的消息可靠性更高，因为每个节点上都存着全量的消息。</p></li><li><p>他的弊端也是明显的，集群内部的网络带宽会被这种同步通讯大量的消耗，进而降低整个集群的性能。这种模式下，队列数量最好不要过多。</p></li></ul></li></ul></blockquote><h3 id="3-RabbitMQ消息存盘不丢消息"><a href="#3-RabbitMQ消息存盘不丢消息" class="headerlink" title="3. RabbitMQ消息存盘不丢消息?"></a>3. RabbitMQ消息存盘不丢消息?</h3><p>对于Classic经典队列，直接将队列声明成为持久化队列即可。</p><p>而新增的Quorum（[ˈkwɔrəm] 仲裁）队列和Stream队列，都是明显的持久化队列，能更好的保证服务端消息不会丢失。</p><blockquote><p>Quorum队列实现了持久化，多备份的FIFO队列，主要就是针对RabbitMQ的镜像模式设计的。大部分功能都是在Classic队列基础上做减法，比如不支持是非持久化的内存队列。某些功能（例如有害消息处理）是特定于仲裁队列的。</p><p>Stream队列是RabbitMQ自3.9.0版本开始引入的一种新的数据队列类型，更适合于消费者多，读消息非常频繁的场景。</p></blockquote><blockquote><p>毒消息是指消息一直不能被消费者正常消费(可能是由于消费者失败或者消费逻辑有问题等)，就会导致消息不断的重新入队，这样这些消息就成为了毒消息。这些读消息应该有保障机制进行标记并及时删除。Quorum队列会持续跟踪消息的失败投递尝试次数，并记录在”x-delivery-count”这样一个头部参数中。然后，就可以通过设置 Delivery limit参数来定制一个毒消息的删除策略。当消息的重复投递次数超过了Delivery limit参数阈值时，RabbitMQ就会删除这些毒消息。当然，如果配置了死信队列的话，就会进入对应的死信队列。</p></blockquote><h3 id="4-RabbitMQ消费者不丢失消息"><a href="#4-RabbitMQ消费者不丢失消息" class="headerlink" title="4. RabbitMQ消费者不丢失消息?"></a>4. <strong>RabbitMQ消费者不丢失消息</strong>?</h3><ul><li><p>RabbitMQ在消费消息时可以指定是自动应答，还是手动应答。将RabbitMQ的应答模式设定为手动应答可以提高消息消费的可靠性。</p></li><li><p>设置了手动确认，则需要在业务处理成成功后，手动调用<code>channer.basicAck()</code>,如果出现异常则调用<code>channer.basicNAck()</code>,设置消息是重新返回队列，还是直接丢掉。</p></li></ul><p><strong>最后，任何用户态的应用程序都无法保证绝对的数据安全，所以，备份与恢复的方案也需要考虑到。</strong></p><h2 id="Consumer-Ack-消费端收到消息后的确认方式"><a href="#Consumer-Ack-消费端收到消息后的确认方式" class="headerlink" title="Consumer Ack 消费端收到消息后的确认方式"></a>Consumer Ack 消费端收到消息后的确认方式</h2><ol><li><p>有三种确认方式</p><ul><li>自动确认 acknowledge &#x3D; “none”。 消息一旦到达consumer就会被确认，并将对应的message 从消息缓存中移除，实际场景中，很可能消息被收到，但是处理业务时异常，这种确认机制下，消息就会丢失。</li><li>手动确认acknowledge &#x3D; “manual”。设置了手动确认，则需要在业务处理成成功后，手动调用<code>channer.basicAck()</code>,如果出现异常则调用<code>channer.basicNAck()</code>,设置消息是重新返回队列，还是直接丢掉。</li><li>根据异常情况确认 acknowledge &#x3D; “auto”</li></ul></li></ol>]]></content>
    
    
    <categories>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MQ</tag>
      
      <tag>消息可靠性</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FullGC</title>
    <link href="/FullGC/"/>
    <url>/FullGC/</url>
    
    <content type="html"><![CDATA[<h1 id="1-FullGC-是什么？"><a href="#1-FullGC-是什么？" class="headerlink" title="1. FullGC 是什么？"></a>1. FullGC 是什么？</h1><p>Full GC（Full Garbage Collection，全垃圾收集）是 Java 虚拟机（JVM）执行的一种垃圾收集过程，它会对整个堆内存进行垃圾收集，包括年轻代（Young Generation）和老年代（Old Generation），以及永久代（PermGen）或元空间（Metaspace）。</p><ul><li><strong>Minor GC</strong>：仅针对年轻代（Eden 和 Survivor 空间）进行垃圾收集。</li><li><strong>Major GC</strong>：主要针对老年代进行垃圾收集，有时也被称为 Old GC。</li><li><strong>Full GC</strong>：针对整个堆内存（包括年轻代、老年代和元空间）进行垃圾收集。</li></ul><p>由于 Full GC 对应用性能影响较大，通常建议在调优 JVM 性能时，尽量减少 Full GC 的发生频率，通过适当的参数调整和垃圾收集器的选择来优化内存管理。</p><h1 id="2-触发条件"><a href="#2-触发条件" class="headerlink" title="2. 触发条件"></a>2. <strong>触发条件</strong></h1><h3 id="1-调用System-gc-方法"><a href="#1-调用System-gc-方法" class="headerlink" title="1. 调用System.gc()方法"></a>1. 调用System.gc()方法</h3><ul><li>此方法的调用是建议JVM进行Full GC,虽然只是建议而非一定,但很多情况下它会触发 Full GC,从而增加Full GC的频率</li><li><strong>调优建议</strong>：能不使用此方法就别使用，让虚拟机自己去管理它的内存</li></ul><h3 id="2-方法区空间不足"><a href="#2-方法区空间不足" class="headerlink" title="2. 方法区空间不足"></a>2. 方法区空间不足</h3><ul><li>方法区存放的为一些class的信息、常量、静态变量等数据，当系统中要加载的类、反射的类和调用的方法较多时，方法区可能会被占满，从而执行Full GC。</li><li>元空间的初始阈值设置太小，垃圾收集器调整元空间的大小需要Full GC。比如初始值是21M，full gc后，释放了20M，只剩1M，那么垃圾收集器就会将该值调成2M；相反，如果释放了1M，还剩20M，下次就会调整到40M，这个过程会多次触发full GC.</li><li>一般建议在JVM参数中将MetaspaceSize和MaxMetaspaceSize设置成一样的值，并设置得比初始值要大。</li><li><strong>调优建议：</strong>对于8G物理内存的机器来说，一般我会将这两个值都设置为256M。常见的问题：项目jar包只有1G，但是启动了好久，就可能是因为由于元空间设置的太小，一直在触发full GC。</li></ul><h3 id="3-Minor-GC-之后仍然没有足够的空间容纳新的对象时。"><a href="#3-Minor-GC-之后仍然没有足够的空间容纳新的对象时。" class="headerlink" title="3. Minor GC 之后仍然没有足够的空间容纳新的对象时。"></a>3. Minor GC 之后仍然没有足够的空间容纳新的对象时。</h3><h3 id="4-元空间（Metaspace）达到指定的最大值时。"><a href="#4-元空间（Metaspace）达到指定的最大值时。" class="headerlink" title="4. 元空间（Metaspace）达到指定的最大值时。"></a>4. 元空间（Metaspace）达到指定的最大值时。</h3><h3 id="3-老年代空间不足"><a href="#3-老年代空间不足" class="headerlink" title="3. 老年代空间不足"></a>3. 老年代空间不足</h3><p><strong>对象转入老年代的场景有：</strong></p><ul><li><p>大对象直接进入老年代：为了避免为大对象GC时，多次在survivor上来回复制而降低效率。</p><ul><li><strong>调优建议：</strong><ul><li>尽量避免写大对象，</li><li>结合你自己系统看下有没有什么大对象 生成，预估下大对象的大小，设置XX:PretenureSizeThreshold的值，一般来说设置为1M就差不多了，很少有超过1M的大对象，这些对象一般就是你系统初始 化分配的缓存对象，比如大的缓存List，Map之类的对象。</li></ul></li></ul></li><li><p>长期存活的对象进入老年代：默认是经历了15次minor GC ，CMS是6次。</p><ul><li><strong>调优建议：</strong><ul><li>调整Eden和survivor的比例，默认时8:1:1，避免Eden区域过小，导致频繁minor GC，增大系统消耗</li><li>如果我们可以确定大多数对象都是很快会被回收的，可以将该值调小，比如大多数对象都是3次左右就可以被回收，我们可以设置成5，如果超过了5，就说明剩下的应该是一些类似java bean 这种，会长期存活的对象，我们就没必要，让他再待在survivor占用空间了，提前让他们进入老年代。</li></ul></li></ul></li><li><p><strong>对象动态年龄判断</strong>：survivor区域里，对象年龄从小到大排序，当累加到某个年龄时，占用 survivor区域 的50%，就会把这个年龄大的对象都晋升到老年代。 如果系统中朝生夕死的对象比较多，</p><ul><li><strong>调优建议：</strong><ul><li>如果系统中朝生夕死的对象比较多，可以考虑将年轻代参数调大一些，这样对应survivor区域就会对应变大，减少对象因为触发了这个机制，进入到老年代，从而触发Full GC。一般情况，新生代默认是堆大小的1&#x2F;3</li><li>避免Survivor设置过小，导致对象从 eden 直接到达老年代，从而触发Full GC</li></ul></li></ul></li><li><p>老年代空间分配担保机制。 </p><p>在发生 Minor GC 之前，虚拟机先检查老年代最大可用的连续空间是否大于新生代所有对象总空间。</p><ul><li>大于 -&gt; minor GC</li><li>小于 -&gt;查看是否开启了空间担保机制<ul><li>没开启就直接触发full GC，</li><li>开启了，就会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试着进行一次 Minor GC；如果小于，会触发full gc。</li></ul></li></ul></li></ul><h1 id="3-优化和调整"><a href="#3-优化和调整" class="headerlink" title="3. 优化和调整"></a>3. 优化和调整</h1><p>过于频繁的 Full GC 可能会导致性能问题，因此需要通过调整堆内存的大小、垃圾收集器的选择以及其他 JVM 参数（如 <code>-XX:MaxMetaspaceSize</code>、<code>-Xms</code>、<code>-Xmx</code> 等）来优化和减少 Full GC 的发生频率。</p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>操作系统OOM Killer</title>
    <link href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9FOOM-Killer/"/>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9FOOM-Killer/</url>
    
    <content type="html"><![CDATA[<h1 id="1-OOM-Killer-是什么？"><a href="#1-OOM-Killer-是什么？" class="headerlink" title="1. OOM Killer 是什么？"></a>1. OOM Killer 是什么？</h1><p>OOM Killer（Out of Memory Killer）是 Linux 操作系统内核中的一个机制，用于在系统内存耗尽时，通过终止进程来释放内存资源，从而防止系统崩溃或无法响应。</p><h2 id="2-OOM-Killer-的触发条件"><a href="#2-OOM-Killer-的触发条件" class="headerlink" title="2. OOM Killer 的触发条件"></a>2. OOM Killer 的触发条件</h2><p>当系统的物理内存和交换空间（swap）都被完全占用，且内核无法再分配内存时，就会触发 OOM（Out of Memory）状态。在这种情况下，系统必须释放一些内存，否则整个系统将无法继续运行。</p><h1 id="3-OOM-Killer-的功能"><a href="#3-OOM-Killer-的功能" class="headerlink" title="3 OOM Killer 的功能"></a>3 OOM Killer 的功能</h1><p>OOM Killer 的主要功能是在系统内存耗尽时，通过终止某些进程来释放内存。这是一个最后的手段，目的是保证系统的基本功能和响应能力。</p><h1 id="4-OOM-Killer-的选择机制"><a href="#4-OOM-Killer-的选择机制" class="headerlink" title="4. OOM Killer 的选择机制"></a>4. OOM Killer 的选择机制</h1><p>OOM Killer 选择进程时，会根据一个评分系统来决定终止哪个进程。评分越高的进程，被终止的可能性越大。评分主要基于以下几个因素：</p><p><strong>进程使用的内存量</strong>：使用内存越多的进程，评分越高。</p><p><strong>进程的重要性</strong>：系统关键进程和低优先级进程的评分会有所不同。重要的系统进程一般有较低的评分。</p><p><strong>进程的优先级（OOM调整值）</strong>：可以手动设置进程的优先级，调整它在 OOM Killer 眼中的重要性。</p><h1 id="5-4-OOM-Killer-的日志信息"><a href="#5-4-OOM-Killer-的日志信息" class="headerlink" title="5. 4. OOM Killer 的日志信息"></a>5. 4. OOM Killer 的日志信息</h1><p>当 OOM Killer 终止一个进程时，会在系统日志（通常是 <code>/var/log/syslog</code> 或 <code>/var/log/messages</code>）中记录一条信息，如你提供的日志条目：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">May <span class="hljs-number">28</span> <span class="hljs-number">17</span>:<span class="hljs-number">34</span>:<span class="hljs-number">42</span> sith-mom-test-node kernel: Out of memory: Kill process <span class="hljs-number">9281</span> (java) score <span class="hljs-number">75</span> or sacrifice child<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>脑裂</title>
    <link href="/%E8%84%91%E8%A3%82/"/>
    <url>/%E8%84%91%E8%A3%82/</url>
    
    <content type="html"><![CDATA[<h1 id="1-脑裂是什么？"><a href="#1-脑裂是什么？" class="headerlink" title="1. 脑裂是什么？"></a>1. 脑裂是什么？</h1><p>脑裂是指在分布式系统中，网络分区或其他原因导致集群中的节点分裂成多个子集。由于互相无法通信，这些子集各自认为自己是唯一的集群，从而可能导致数据不一致性、服务重复、竞态条件等严重问题。</p><p><strong>在分布式数据库、分布式文件系统、分布式锁等系统中，脑裂问题尤为重要，因为它直接影响系统的正确性和一致性。</strong></p><h1 id="2-脑裂的成因"><a href="#2-脑裂的成因" class="headerlink" title="2. 脑裂的成因"></a>2. 脑裂的成因</h1><ol><li><strong>网络分区</strong>：集群中的节点因网络故障被分隔成多个子集，子集之间无法通信。</li><li><strong>节点故障</strong>：部分节点因故障暂时不可用，当恢复后产生与其他节点的状态冲突。</li><li><strong>配置错误</strong>：集群配置不当，导致节点错误地加入或退出集群。</li></ol><h1 id="3-脑裂的影响"><a href="#3-脑裂的影响" class="headerlink" title="3. 脑裂的影响"></a>3. 脑裂的影响</h1><ul><li><strong>数据不一致性</strong>：不同子集各自进行写操作，导致数据状态不同步。</li><li><strong>服务重复</strong>：不同子集各自认为自己是唯一的服务提供者，导致重复的服务实例。</li><li><strong>竞态条件</strong>：不同子集的操作相互冲突，导致系统行为不可预测。</li></ul><h1 id="4-解决脑裂的方式"><a href="#4-解决脑裂的方式" class="headerlink" title="4. 解决脑裂的方式"></a>4. 解决脑裂的方式</h1><ol><li><strong>多数派机制（Quorum）</strong>：通过要求超过半数（即多数派）的节点达成一致来进行操作。只有多数派同意的操作才被执行。这样，即使分区，任意一个子集若未达到多数派都不能对外提供服务，从而避免脑裂。</li><li><strong>租约（Leases）</strong>：使用租约机制，确保在一个时间段内只有一个节点能持有租约，成为Leader。租约过期后重新选举，避免同时存在多个Leader。</li><li><strong>心跳检测和节点隔离</strong>：节点之间定期发送心跳信号以检测连通性。一旦检测到网络分区或节点失联，及时隔离失联节点，防止其继续提供服务。</li><li><strong>仲裁机制</strong>：引入第三方仲裁节点，如仲裁服务器或外部存储系统，当分区发生时，仲裁节点决定哪一部分集群可以继续对外提供服务。</li><li><strong>优先级策略</strong>：根据节点的角色、位置、负载等设置优先级，确保只有高优先级的子集继续提供服务，低优先级子集暂停服务。</li></ol><p><a href="https://pyr9.github.io/zookeeper%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#9-Zookeeper%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98%EF%BC%9F">Zookeeper如何解决脑裂问题</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>java基础</title>
    <link href="/java%E5%9F%BA%E7%A1%80/"/>
    <url>/java%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Java-面向对象的三大特性及理解"><a href="#1-Java-面向对象的三大特性及理解" class="headerlink" title="1. Java 面向对象的三大特性及理解"></a>1. Java 面向对象的三大特性及理解</h1><p>   默认情况下，面向对象有三大特性：继承、封装、多态。但如果考官让回答4大特性，我们就把抽象加上去。</p><p>1、继承</p><p> 继承就是从已有的类继承信息创建新类的过程，被继承的类称为父类（也叫基类、超类），继承的类叫做子类（也叫派生类）。子类可以全盘接受父类的所有属性和方法（甚至是private修饰的，也可以继承，但是不能在父类之外访问，提供共有的访问方法（比如封装set()、get()）就可以用）。</p><p>2、封装</p><p>​      封装就是把数据和操作数据的方法绑定起来，对外提供简单的接口，在java中对类中的方法的定义就是对细节的一种封装，简单地说，封装就是隐藏一切可以隐藏的内容，对外提供一个简单的接口。</p><p>3、多态</p><pre><code class="hljs">     多态就是指不同子类型对于同一消息做出不同的反应，简单地说，就是对于同一对象，调用相同的方法，但做了不同的事情，多态具体体现在方法重载和方法重写，方法重载实现的是编译时的多态，而方法重写实现的是运行时的多态，需要注意的是当发生向上转型时，子类独有的方法不可以被调用。</code></pre><p>4、抽象</p><pre><code class="hljs">     抽象就是把不同的对象相同的特征总结出来提取成一个类，抽象只关注对象有哪些的属性和方法，，从不关心这些方法具体怎么实现。</code></pre><h1 id="2-什么是面向对象？什么是面向过程？"><a href="#2-什么是面向对象？什么是面向过程？" class="headerlink" title="2.什么是面向对象？什么是面向过程？"></a>2.什么是面向对象？什么是面向过程？</h1><ul><li><p>面向过程（Procedure Oriented 简称 PO）：把事情拆分成几个步骤（相当于拆分成一个个的方法和数据），然后按照一定的顺序执行。</p></li><li><p>面向对象（Object Oriented 简称 OO）：面向对象会把事物抽象成对象的概念，先抽象出对象，然后给对象赋一些属性和方法，然后让每个对象去执行自己的方法。</p></li></ul><p>举例：用洗衣机洗衣服，来看一下两者的差别。</p><p><strong>面向过程：</strong></p><p>放衣服（方法）–&gt;加洗衣粉（方法）–&gt; 加水（方法）–&gt; 清洗（方法）–&gt; 甩干（方法）</p><p><strong>面向对象：</strong></p><ol><li><p>new 出两个对象 ”人“ 和 ”洗衣机“</p><ul><li><p>”人“ 加入属性和方法：放衣服（方法）、加洗衣粉（方法）、加水（方法）</p></li><li><p>”洗衣机“ 加入属性和方法：清洗（方法）、甩干（方法）</p></li></ul></li><li><p>然后执行：</p></li></ol><p>​人.放衣服（方法）-&gt; 人.加洗衣粉（方法）-&gt; 人.加水（方法）-&gt; 洗衣机.清洗（方法）-&gt; 洗衣机.甩干（方法）</p><h1 id="2-面向对象和面向过程的优缺点对比"><a href="#2-面向对象和面向过程的优缺点对比" class="headerlink" title="2. 面向对象和面向过程的优缺点对比"></a>2. 面向对象和面向过程的优缺点对比</h1><p><strong>面向过程：</strong></p><p>优点：</p><ul><li>效率高，因为不需要实例化对象。</li></ul><p>缺点：</p><ul><li>代码维护和扩展相对困难，特别是在大型系统中。</li><li>数据和行为分离，修改数据结构可能影响多个函数。</li></ul><p><strong>面向对象：</strong></p><p>优点：</p><ul><li>代码维护和扩展相对容易，通过继承和多态实现扩展。</li><li>封装和模块化设计使得系统更易维护和扩展。</li></ul><p>缺点：效率比面向过程低。</p><h1 id="3-Java为什么要有类"><a href="#3-Java为什么要有类" class="headerlink" title="3. Java为什么要有类"></a>3. Java为什么要有类</h1><h3 id="1-面向对象编程的核心"><a href="#1-面向对象编程的核心" class="headerlink" title="1. 面向对象编程的核心"></a>1. <strong>面向对象编程的核心</strong></h3><p>类是面向对象编程（OOP）的基本构建模块。面向对象编程是一种通过将数据和行为封装在对象中的编程范式。类提供了一种定义和创建对象的模板，使得面向对象编程成为可能。</p><h3 id="2-封装数据和行为"><a href="#2-封装数据和行为" class="headerlink" title="2. 封装数据和行为"></a>2. <strong>封装数据和行为</strong></h3><p>类允许将数据（字段）和行为（方法）封装在一起。这种封装有助于组织代码，增强代码的可维护性和可读性，并保护数据不被外部直接访问或修改。</p><h3 id="3-实现抽象"><a href="#3-实现抽象" class="headerlink" title="3. 实现抽象"></a>3. <strong>实现抽象</strong></h3><p>类允许创建抽象的数据类型，通过隐藏实现细节，只暴露必要的接口给外部使用者。这种抽象能力使得复杂系统可以分解为更简单、更可管理的部分。</p><h3 id="4-继承和代码复用"><a href="#4-继承和代码复用" class="headerlink" title="4. 继承和代码复用"></a>4. <strong>继承和代码复用</strong></h3><p>类支持继承，可以从现有的类派生出新的类，从而实现代码的复用和扩展。子类继承父类的属性和方法，可以重用现有代码并添加新的功能。</p><h3 id="5-多态性"><a href="#5-多态性" class="headerlink" title="5. 多态性"></a>5. <strong>多态性</strong></h3><p>类支持多态性，这使得相同接口的不同实现可以以统一的方式使用。多态性通过方法重写和接口实现实现，允许代码更加灵活和可扩展。</p><h3 id="6-模块化和组织代码"><a href="#6-模块化和组织代码" class="headerlink" title="6. 模块化和组织代码"></a>6. <strong>模块化和组织代码</strong></h3><p>类提供了一种自然的方式来组织和模块化代码。在大型项目中，使用类可以将相关的功能、数据和行为集中在一个模块中，使代码更易于理解、管理和维护。</p><h1 id="4-java如何创建一个线程？"><a href="#4-java如何创建一个线程？" class="headerlink" title="4. java如何创建一个线程？"></a>4. java如何创建一个线程？</h1><ol><li><strong>通过继承<code>Thread</code>类</strong>：</li></ol><ul><li>创建一个新的类继承<code>Thread</code>类。</li><li>重写<code>run</code>方法，在<code>run</code>方法中定义线程要执行的任务。</li><li>创建该类的实例并调用<code>start</code>方法启动线程。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 线程要执行的任务</span><br>        System.out.println(<span class="hljs-string">&quot;Thread is running&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MyThread thread = <span class="hljs-keyword">new</span> MyThread();<br>        thread.start();  <span class="hljs-comment">// 启动线程</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li><strong>通过实现<code>Runnable</code>接口</strong>：</li></ol><ul><li>创建一个实现<code>Runnable</code>接口的类。</li><li>实现<code>run</code>方法，在<code>run</code>方法中定义线程要执行的任务。</li><li>创建一个<code>Thread</code>对象，并将实现<code>Runnable</code>接口的实例作为参数传递给<code>Thread</code>构造函数。</li><li>调用<code>Thread</code>对象的<code>start</code>方法启动线程。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 线程要执行的任务</span><br>        System.out.println(<span class="hljs-string">&quot;Thread is running&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MyRunnable myRunnable = <span class="hljs-keyword">new</span> MyRunnable();<br>        Thread thread = <span class="hljs-keyword">new</span> Thread(myRunnable);<br>        thread.start();  <span class="hljs-comment">// 启动线程</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>**通过实现 <code>Callable</code> 接口并使用 <code>FutureTask</code>**：</li></ol><p>通过使用 <code>Callable</code> 和 <code>FutureTask</code>，你可以创建一个带返回结果的线程，并在需要时获取其结果。这种方式非常适合用于需要并行执行并获取结果的任务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.Callable;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutionException;<br><span class="hljs-keyword">import</span> java.util.concurrent.FutureTask;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleCallableExample</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">// 创建一个实现 Callable 接口的类</span><br>        Callable&lt;Integer&gt; callableTask = <span class="hljs-keyword">new</span> Callable&lt;Integer&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                <span class="hljs-comment">// 模拟一些计算任务</span><br>                System.out.println(<span class="hljs-string">&quot;Thread is running&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;  <span class="hljs-comment">// 返回结果</span><br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 使用 FutureTask 包装 Callable 对象</span><br>        FutureTask&lt;Integer&gt; futureTask = <span class="hljs-keyword">new</span> FutureTask&lt;&gt;(callableTask);<br><br>        <span class="hljs-comment">// 创建并启动线程</span><br>        Thread thread = <span class="hljs-keyword">new</span> Thread(futureTask);<br>        thread.start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取异步计算的结果</span><br>            Integer result = futureTask.get();<br>            System.out.println(<span class="hljs-string">&quot;Result from thread: &quot;</span> + result);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="3"><li><strong>通过使用<code>ExecutorService</code>框架</strong>：</li></ol><ul><li>使用<code>Executors</code>创建一个线程池。</li><li>提交实现<code>Runnable</code>或<code>Callable</code>接口的任务给线程池来执行。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 线程要执行的任务</span><br>        System.out.println(<span class="hljs-string">&quot;Thread is running&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>        MyRunnable myRunnable = <span class="hljs-keyword">new</span> MyRunnable();<br>        executorService.execute(myRunnable);  <span class="hljs-comment">// 提交任务给线程池执行</span><br>        executorService.shutdown();  <span class="hljs-comment">// 关闭线程池</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="5-Spring如何创建一个线程"><a href="#5-Spring如何创建一个线程" class="headerlink" title="5. Spring如何创建一个线程"></a>5. Spring如何创建一个线程</h1><ol><li>使用 <code>@Async</code> 注解</li></ol><p><code>@Async</code> 注解用于将某个方法标记为异步执行。要使用它，你需要启用Spring的异步支持。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncService</span> </span>&#123;<br>    <br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">asyncMethod</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Async method started&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">2000</span>);  <span class="hljs-comment">// 模拟长时间任务</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;Async method finished&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="2"><li>使用 <code>TaskExecutor</code></li></ol><p><code>TaskExecutor</code> 是Spring提供的一组接口，用于抽象并发编程的细节。你可以使用 <code>ThreadPoolTaskExecutor</code> 来创建一个线程池。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.Executor;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskExecutorConfig</span> </span>&#123;<br><br>    <span class="hljs-meta">@Bean(name = &quot;taskExecutor&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Executor <span class="hljs-title">taskExecutor</span><span class="hljs-params">()</span> </span>&#123;<br>        ThreadPoolTaskExecutor executor = <span class="hljs-keyword">new</span> ThreadPoolTaskExecutor();<br>        executor.setCorePoolSize(<span class="hljs-number">5</span>);<br>        executor.setMaxPoolSize(<span class="hljs-number">10</span>);<br>        executor.setQueueCapacity(<span class="hljs-number">25</span>);<br>        executor.setThreadNamePrefix(<span class="hljs-string">&quot;AsyncThread-&quot;</span>);<br>        executor.initialize();<br>        <span class="hljs-keyword">return</span> executor;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>在服务类中注入 <code>TaskExecutor</code> 并使用它执行任务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.core.task.TaskExecutor;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskExecutorService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskExecutor taskExecutor;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeTask</span><span class="hljs-params">()</span> </span>&#123;<br>        taskExecutor.execute(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;Task executed by TaskExecutor&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);  <span class="hljs-comment">// 模拟长时间任务</span><br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;Task completed&quot;</span>);<br>        &#125;);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="6-Java8引入stream有什么意义？"><a href="#6-Java8引入stream有什么意义？" class="headerlink" title="6. Java8引入stream有什么意义？"></a>6. Java8引入stream有什么意义？</h1><h4 id="1-更简洁的代码"><a href="#1-更简洁的代码" class="headerlink" title="1. 更简洁的代码"></a>1. <strong>更简洁的代码</strong></h4><ul><li>使用流API，可以用更少的代码完成对集合的操作。例如，对集合进行过滤、转换、排序和聚合等操作可以通过链式调用实现，使代码更加简洁和易读。</li></ul><h4 id="2-并行处理能力"><a href="#2-并行处理能力" class="headerlink" title="2. 并行处理能力"></a>2. <strong>并行处理能力</strong></h4><ul><li>流API支持轻松的并行操作，只需将 <code>stream()</code> 方法更换为 <code>parallelStream()</code>，就可以利用多核处理器的能力来加速数据处理。这对于处理大型数据集合尤为重要。</li></ul><h4 id="3-惰性求值"><a href="#3-惰性求值" class="headerlink" title="3. 惰性求值"></a>3. <strong>惰性求值</strong></h4><ul><li><code>Stream</code> API 采用惰性求值策略，即只有在最终需要结果时才会执行中间操作。此外，一些终端操作（如 <code>findFirst()</code> 或 <code>anyMatch()</code>）具有短路特性，这意味着一旦找到符合条件的第一个元素，后续的操作就会停止，从而节省计算资源。</li></ul><h4 id="4-易于组合和重用"><a href="#4-易于组合和重用" class="headerlink" title="4. 易于组合和重用"></a>4. <strong>易于组合和重用</strong></h4><ul><li>由于 <code>Stream</code> 操作是高度模块化的，你可以轻松地将不同的操作组合在一起形成复杂的处理流程，也可以方便地复用这些操作。</li></ul><h1 id="7-Transactional-常用的一些配置？"><a href="#7-Transactional-常用的一些配置？" class="headerlink" title="7 @Transactional 常用的一些配置？"></a>7 @Transactional 常用的一些配置？</h1><ol><li><p><strong>propagation</strong>（传播行为）</p><ul><li><p>定义事务在遇到已有事务时的行为。</p></li><li><p>常用值</p><ul><li><p><code>REQUIRED</code>（默认）：如果当前存在事务，则加入该事务；否则创建一个新的事务。</p></li><li><p><code>REQUIRES_NEW</code>：总是创建一个新的事务，如果当前存在事务，则挂起它。如：在日志的save时，即使 <code>createUser</code> 方法失败并导致事务回滚，日志记录操作仍然会被提交。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createUserWithLogging</span><span class="hljs-params">(User user)</span> </span>&#123;<br>  userService.createUser(user);<br>  loggingService.logMessage(<span class="hljs-string">&quot;User created: &quot;</span> + user.getName());<br>&#125;<br>    <br><br><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">logMessage</span><span class="hljs-params">(String message)</span> </span>&#123;<br>  logRepository.save(<span class="hljs-keyword">new</span> Log(message));<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><code>SUPPORTS</code>：如果当前存在事务，则加入该事务；否则以非事务方式运行。</p></li><li><p><code>NOT_SUPPORTED</code>：以非事务方式运行，如果当前存在事务，则挂起它。</p></li><li><p><code>MANDATORY</code>：如果当前存在事务，则加入该事务；否则抛出异常。</p></li><li><p><code>NEVER</code>：以非事务方式运行，如果当前存在事务，则抛出异常。</p></li><li><p><code>NESTED</code>：如果当前存在事务，则在嵌套事务内执行；否则与 <code>REQUIRED</code> 行为相同。</p></li></ul></li></ul></li><li><p><strong>rollbackFor</strong>（回滚异常）</p><ul><li><p>指定哪些异常会导致事务回滚，默认情况下只有 <code>RuntimeException</code> 和 <code>Error</code> 会触发回滚。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(rollbackFor = &#123;SQLException.class, IOException.class&#125;)</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>timeout</strong>（超时时间）</p><ul><li><p>定义事务的最大持续时间（秒），超过该时间将抛出异常并回滚事务。当某个事务可能长时间运行时，可以通过设置超时时间来避免长时间占用资源。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(timeout = 30)</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>isolation</strong>（隔离级别）</p><ul><li><p>定义事务的隔离级别，控制事务之间的可见性。</p></li><li><p>常用值</p><ul><li><code>DEFAULT</code>（默认）：使用底层数据库的默认隔离级别。</li><li><code>READ_UNCOMMITTED</code>：允许读取未提交的数据更改，可能导致脏读、不可重复读和幻读。</li><li><code>READ_COMMITTED</code>：允许从已经提交的事务中读取数据，防止脏读。</li><li><code>REPEATABLE_READ</code>：对同一字段的多次读取结果一致，除非数据被当前事务本身改变，可以防止脏读和不可重复读。</li><li><code>SERIALIZABLE</code>：完全串行化，最高级别的隔离，防止所有并发问题，但性能较低。</li></ul></li></ul></li><li><p><strong>readOnly</strong>（只读标志）</p></li></ol><ul><li><p>如果设置为 <code>true</code>，表示该事务是只读的，优化器可能会进行一些优化。这种方式适用于查询操作，避免不必要的锁和写操作。</p><pre><code class="hljs">   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(readOnly = true)</span><br></code></pre></td></tr></table></figure></code></pre></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>spring常见面试题</title>
    <link href="/spring%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/spring%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Spring-注入过程"><a href="#1-Spring-注入过程" class="headerlink" title="1. Spring 注入过程"></a>1. Spring 注入过程</h1><ol><li>启动 Spring 容器</li><li>读取配置文件或注解扫描（如 <code>@ComponentScan</code>）加载 Bean 的定义。</li><li>Spring 容器会根据 Bean 的定义实例化对象。这个过程称为实例化（Instantiation）。</li><li>Spring 容器会注入依赖对象到 Bean 中。依赖注入可以通过构造器、Setter 方法或字段注入来实现。</li></ol><p>依赖注入完成后，可以通过 Spring 上下文获取 Bean 实例。</p><h1 id="2-Spring两大特性"><a href="#2-Spring两大特性" class="headerlink" title="2. Spring两大特性"></a>2. Spring两大特性</h1><p>Spring 是一个开源框架，Spring可以做很多事情，它为企业级开发提供这些功能的底层都依赖于它的两个核心特性：IOC和AOP。</p><ol><li><p>IOC：IOC控制反转也叫依赖注入，IOC 利用 java 反射机制，所谓控制反转是指，本来被调用者的实例是有调用者来创建的，这样的缺点是耦合性太强，IOC 则是统一交给 spring 容器来管理创建，将对象交给容器管理，你只需要在 spring 配置文件中配置相应的 bean，以及设置相关的属性，让spring 容器来生成类的实例对象以及管理对象。就比如：原来我的service层要调用dao层，service就要创建dao,但spring发现你的service层要依赖dao层后，就可以给你注入。</p></li><li><p>AOP：为 Aspect Oriented Programming 的缩写，意为：面向切面编程，可以通过预编译方式和运行期动态代理实现在不修改源代码的情况下给程序动态统一添加功能的一种技术。<br>（1）比如说现在有一个类 iA，里面有增删改的方法，现在要在每个目标方法执行前后进行开启事务和提交事务。传统的思想是纵向继承：要想实现事务的功能的话，不得不采用 子类继承父类的方法，通过重写父类的目标方法，在此基础上加上事务，开启事务&#x2F;提交事务，这样的话，代码重复率很高，每个方法都要写开启事务&#x2F;提交事务，代码重复率太高。<br>（2）AOP 采取横向抽取机制：就是说，鉴于纵向继承出现重复的代码，把重复的代码提取出来放到一个类 B 中，然后 spring 生成一个代理类，他和目标类也就是类 A 实现相同的接口，拥有相同的方法，那么代理类就可以把类 B 和目标类都拿来，进行组合，对外访问的话，就是访问的代理类。<br>（3）就达到和纵向继承一样的效果。他在 spring 中是用反射去做，我们要做的就是编写目标类 A 和切面类类 B。然后告诉 spring，让 Spring 生成代理就行了，代码少了很多，但是功能一个不少。</p></li></ol><h1 id="3-spring优点"><a href="#3-spring优点" class="headerlink" title="3. spring优点"></a>3. spring优点</h1><p>（1）方便解耦，简化开发（高内聚，低耦合）<br>Spring就是一个容器，可以将所有对象创建和依赖关系维护，都交给spring管理，spring工厂用于生成bean<br>（2）AOP编程的支持<br>可以通过预编译方式和运行期动态代理实现在不修改源代码的情况下给程序动态统一添加功能的一种技术<br>（3）声明式事务的支持<br>只需要通过配置就可以完成对事务的管理，无需手动编程<br>（4）方便程序的测试<br>spring对Junit4支持，可以通过注解方便的测试spring程序<br>（5）方便集成各种优秀框架<br>spring内部提供了对各种优秀框架的支持，如mybatis等</p><h1 id="4-在-Spring-中，有几种依赖注入方式？"><a href="#4-在-Spring-中，有几种依赖注入方式？" class="headerlink" title="4. 在 Spring 中，有几种依赖注入方式？"></a>4. 在 Spring 中，有几种依赖注入方式？</h1><p>通常，依赖注入可以通过三种方式完成<br>即：构造函数注入、setter 注入、接口注入，在 Spring Framework 中，仅使用构造函数和 setter 注入。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 1、构造方法注入 --&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;teacher1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.pojo.Teacher&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;老刘&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;age&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;36&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--  setter方法注入 --&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;stu&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.pojo.Student&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;lisi44&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;age&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;99&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h1 id="5-在-Spring-中，有几种配置-Bean-的方式？"><a href="#5-在-Spring-中，有几种配置-Bean-的方式？" class="headerlink" title="5 在 Spring 中，有几种配置 Bean 的方式？"></a>5 在 Spring 中，有几种配置 Bean 的方式？</h1><p>三种，分别为：基于XML的配置、基于注解的配置、基于Java的配置</p><p>1.基于XML的配置:</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs applescript">&lt;bean <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;stu&quot;</span> <span class="hljs-built_in">class</span>=<span class="hljs-string">&quot;com.pojo.Student&quot;</span>&gt;<br>       &lt;<span class="hljs-keyword">property</span> <span class="hljs-built_in">name</span>=<span class="hljs-string">&quot;name&quot;</span> value=<span class="hljs-string">&quot;lisi&quot;</span>&gt;&lt;/<span class="hljs-keyword">property</span>&gt;<br>       &lt;<span class="hljs-keyword">property</span> <span class="hljs-built_in">name</span>=<span class="hljs-string">&quot;age&quot;</span> value=<span class="hljs-string">&quot;22&quot;</span>&gt;&lt;/<span class="hljs-keyword">property</span>&gt;<br>   &lt;/bean&gt;<br></code></pre></td></tr></table></figure><p>2.基于注解的配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>Student stu;<br></code></pre></td></tr></table></figure><p>3.基于java 显式配置</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Clazz <span class="hljs-function"><span class="hljs-title">createClazz</span>(<span class="hljs-params"></span>)</span> &#123;<br><br>Clazz clazz=<span class="hljs-keyword">new</span> Clazz();<br>clazz.setName(<span class="hljs-string">&quot;自动化专业&quot;</span>);<br><span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>线程池</title>
    <link href="/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    <url>/%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="1-线程池的定义"><a href="#1-线程池的定义" class="headerlink" title="1. 线程池的定义"></a>1. 线程池的定义</h1><p>  线程池的基本思想还是一种对象池的思想，开辟一块内存空间，里面存放了众多（未死亡）的线程，池中线程执行调度由池管理器来处理。当有线程任务时，从池中取一个，执行完成后线程对象归池，这样可以避免反复创建线程对象所带来的性能开销，节省了系统的资源，提高了代码执行效率。<br>  线程池和工厂模式、观察者模式有关（自己不要提，设计模式是个坑）</p><h1 id="2-使用线程池的好处"><a href="#2-使用线程池的好处" class="headerlink" title="2. 使用线程池的好处"></a>2. 使用线程池的好处</h1><p>1.降低资源消耗。通过重复利用已创建的线程，从而降低创建和销毁的消耗。<br>2.提高响应速度。当任务到达时，不需要等待线程创建，直接可以执行任务。<br>3.提高线程的可管理性。使用线程池可以实现对线程统一分配、调优和监控。</p><h1 id="3-常用的线程池有哪些"><a href="#3-常用的线程池有哪些" class="headerlink" title="3. 常用的线程池有哪些"></a>3. 常用的线程池有哪些</h1><ul><li>newCachedThreadPool：创建一个可缓存的线程池，该线程池不会对线程池大小做限制，它的大小取决于操作系统（或JVM）能够创建的最大线程的大小。</li><li>newFixedThreadPool：创建一个大小固定的线程池，每提交一个任务，就创建一个线程，直到达到线程池的最大线程大小。</li><li>newScheduledThreadPool：创建一个支持定时和周期性执行任务的线程池。</li><li>newSingleThreadExecutor：创建一个单线程的线程池，此线程池保证所有任务的执行顺序按照任务的提交顺序执行。</li></ul><h1 id="4-线程池的启动策略"><a href="#4-线程池的启动策略" class="headerlink" title="4. 线程池的启动策略"></a>4. 线程池的启动策略</h1><p>当调用execute（）去添加一个任务时，线程会做以下判断： </p><ol><li>如果正在运行的线程数小于corePoolSize（核心线程数），那么马上会创建线程执行这个任务</li><li>如果正在运行的线程数大于或等于corePoolSize，那么会将这个这个任务放入队列。</li><li>如果此时队列满了，而且正在运行的线程数小于maximumPoolSize,那么还是要创建线程执行这个任务</li><li>如果此时队列满了，而且正在运行的线程数大于或等于maximumPoolSize,那么线程池会抛出异常，告诉调用者无法再接受任务了。</li></ol><p><strong>注意：</strong></p><ul><li>在这个过程中，当一个线程完成任务，它会从队列里取出下一个任务来执行</li><li>当一个线程无事可做，超过一定的时间（KeepAliveTime：线程被回收前的空闲时间）时，线程池会判断；如果当前运行的线程数大于corePoolSize，那么这个线程就会被停掉。</li><li>当线程池所有任务完成后，他最终会收缩到corePoolSize的大小。</li></ul><p>(类似数据库的连接数，也需要设置maximum-pool-size:)</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Jpa和mybatis</title>
    <link href="/Jpa%E5%92%8Cmybatis/"/>
    <url>/Jpa%E5%92%8Cmybatis/</url>
    
    <content type="html"><![CDATA[<h1 id="1-JPA和mybatis的区别"><a href="#1-JPA和mybatis的区别" class="headerlink" title="1. JPA和mybatis的区别"></a>1. JPA和mybatis的区别</h1><p><strong>基本概念</strong></p><ul><li><strong>MyBatis</strong>：<ul><li>是一个半自动化的持久层框架，专注于 SQL 映射和管理。</li><li>提供 SQL 查询、结果映射和存储过程的调用，允许开发者编写自己的 SQL。</li></ul></li><li><strong>JPA</strong>：<ul><li>是 Java EE 和 Java SE 的标准规范，用于对象关系映射（ORM）。</li><li>主要实现包括 Hibernate、spring data jpa 和 OpenJPA。</li><li>提供全自动化的 ORM 功能，开发者通常不需要编写 SQL，而是依赖于 JPA 提供的抽象层。</li></ul></li></ul><p><strong>2. SQL 操作</strong></p><ul><li><strong>MyBatis</strong>：<ul><li>强调手写 SQL，开发者有完全的 SQL 控制权。</li><li>通过 XML 文件或注解定义 SQL 映射。</li><li>更适合对 SQL 有细粒度控制需求的场景。</li></ul></li><li><strong>JPA</strong>：<ul><li>使用 JPQL（Java Persistence Query Language）或 Criteria API 查询，类似于 SQL，但面向对象。</li><li>复杂查询下可以使用QueryDsL 和写nativeSQL</li><li>更侧重于通过实体类操作数据库，减少直接 SQL 的编写。</li><li>对 SQL 的控制较少，但方便数据操作。</li><li>更换数据库平台方便</li></ul></li></ul><p><strong>3. 配置和复杂度</strong></p><ul><li><strong>MyBatis</strong>：<ul><li>配置较为简单，主要通过 XML 文件或注解。</li><li>需要手动管理 SQL 和对象映射，适合复杂 SQL 或存储过程的项目。</li></ul></li><li><strong>JPA</strong>：<ul><li>配置相对复杂，依赖于实体类、关系映射和持久化单元配置。</li><li>通过注解或 XML 文件定义实体类及其关系，自动管理实体的生命周期。</li></ul></li></ul><p><strong>4 性能和灵活性</strong></p><ul><li><strong>MyBatis</strong>：<ul><li>性能较好，尤其在复杂查询和批量操作方面。</li><li>灵活性高，开发者可以优化每个 SQL 语句。</li></ul></li><li><strong>JPA</strong>：<ul><li>提供缓存机制（一级和二级缓存）和延迟加载，提高性能。</li><li>性能受 ORM 层次的影响较大，适合 CRUD 操作较多的应用。</li></ul></li></ul><p><strong>5. 学习曲线</strong></p><ul><li><strong>MyBatis</strong>：<ul><li>学习曲线较平缓，SQL 和映射配置简单直观。</li><li>适合有 SQL 基础的开发者。</li></ul></li><li><strong>JPA</strong>：<ul><li>学习曲线较陡，需要掌握 JPA 规范和面向对象的数据库操作方法。</li><li>适合需要高层次抽象和自动化管理的项目。</li></ul></li></ul><p><strong>6 适用场景</strong></p><ul><li><strong>MyBatis</strong>：<ul><li>适用于需要频繁编写复杂 SQL 的项目。</li><li>适合对 SQL 语句有精细控制要求的应用。</li></ul></li><li><strong>JPA</strong>：<ul><li>适用于标准化 CRUD 操作较多的企业级应用。</li><li>适合需要 ORM 特性和面向对象数据库操作的项目。</li></ul></li></ul><h1 id="2-Mybatis-动态-sql-概念"><a href="#2-Mybatis-动态-sql-概念" class="headerlink" title="2. Mybatis 动态 sql 概念"></a>2. Mybatis 动态 sql 概念</h1><p>摆脱根据不同条件拼接 SQL 语句的痛苦，例如拼接时要确保不能忘记添加必要的空格，还要注意去掉列表最后一个列名的逗号。MyBatis 中用于实现动态 SQL 的元素主要有：</p><ol><li><p>if 语句 (简单的条件判断)</p></li><li><p>choose (when,otherwize) ,相当于 java 语言中的 switch ,与 jstl 中的choose 很类似.</p></li><li><p>where (主要是用来简化 sql 语句中 where 条件判断的，能智能的处理 and or , 不必担心多余导致语法错误)</p></li><li><p>set (主要用于更新时，功能和 where 标签元素差不多，主要是在包含的语句前输出一个 set，然后如果包含的语句是以逗号结束的话将会把该逗号忽略，如果 set 标签最终返回的内容为空的话则可能会出错（ update set name &#x3D; #{name}, where … ? )</p></li><li><p>trim (trim 元素的主要功能是可以在自己包含的内容前加上某些前缀，也可以在其后加上某些后缀，与之对应的属性是 prefix 和 suffix；可以把包含内容的首部某些内容覆盖，即忽略，也可以把尾部的某些内容覆盖，对应的属性是 prefixOverrides 和 suffixOverrides；正因为 trim 有这样的功能，它可以用来实现 where 和 set 的效果)</p></li><li><p>foreach (java中有for, 可通过for循环， 同样， mybatis中有foreach, 可通过它实现循环，循环的对象当然主要是java集合或数组。)</p></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>jpa的批量优化</title>
    <link href="/jpa%E7%9A%84%E6%89%B9%E9%87%8F%E4%BC%98%E5%8C%96/"/>
    <url>/jpa%E7%9A%84%E6%89%B9%E9%87%8F%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1. 问题"></a>1. 问题</h1><p>Spring-data-jpa自己带的JpaRepository里有很多现有的方法，如findAll, saveAll, deleteAll ,但是saveAll 和deleteAll 这种底层都是foreach的save或者delete的，性能非常低</p><h1 id="2-优化"><a href="#2-优化" class="headerlink" title="2. 优化"></a>2. 优化</h1><p>可以通过配置<code>hibernate.jdbc.batch_size</code>的方式， 将这些插入操作打包成一个批处理操作，然后一次性发送到数据库执行。</p><p>这样做可以减少通信成本和事务开销，提高性能。但依旧不够，所以需要自己写SQL处理器</p><p>基于PG：</p><h2 id="2-1-insert"><a href="#2-1-insert" class="headerlink" title="2.1 insert"></a>2.1 insert</h2><p>原理： <code>insert into %s (%s) values %s;</code></p><p>注意：</p><ul><li><p>需要自己生成ID， 有一张表维护不同业务表的id_value序号，根据当前业务表，查询出当前id_value, 将当前id_value+ LIst.size+1 作为要更新的新id_value, 更新成功的话，则将之前查询出来的id_value+1和最新id_value返回</p><p><code>update id_value=</code>id_value+ LIst.size+1 where id_value&#x3D;id_value &#96; 利用CAS</p></li><li><p>获取id失败的话，retry一次</p></li></ul><h2 id="2-2-update"><a href="#2-2-update" class="headerlink" title="2.2 update"></a>2.2 update</h2><p>原理： <code>update %s set %s from (values %s) as tmp (%s) where %s.id=tmp.id;</code></p><p>把fields传过去， 不传默认更新所有</p><p>这里就需要更新当前所有的fields， 构建的entity中之遥某个有这个fields，就得都加上</p><p>SQL执行可能有长度和行数限制</p><p>每次从list里取对象进行SQL拼接时，都检查下当前剩余长度是否够用，以及当前行数是否超过限制</p><p>不够的话，再新构建一个SQL将剩下的部分拼接进去</p><p>这次的优化速度提高，是倍数增长的，因为之前需要多个SQL，多次连接多次执行，下载都优化成了一次</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>滑动窗口</title>
    <link href="/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/"/>
    <url>/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="1-应用场景"><a href="#1-应用场景" class="headerlink" title="1. 应用场景"></a>1. 应用场景</h1><p>关键词：</p><ol><li>满足XXX条件（计算结果，出现次数，同时包含）</li><li>最长&#x2F;最短</li><li>子串&#x2F;子数组&#x2F;子序列</li></ol><p>Eg：长度最小的子数组</p><h1 id="2-使用思路"><a href="#2-使用思路" class="headerlink" title="2. 使用思路"></a>2. 使用思路</h1><h2 id="1-寻找最长"><a href="#1-寻找最长" class="headerlink" title="1. 寻找最长"></a>1. 寻找最长</h2><p>左右双指针（L，R）在起始点，R向右逐位滑动循环</p><p>——每次滑动过程中</p><ul><li>窗内元素满足条件，R向右扩大窗口，并更新最优结果</li><li>窗内元素不满足条件，L向右缩小窗口</li></ul><p>——R到达结尾</p><h2 id="2-模版"><a href="#2-模版" class="headerlink" title="2. 模版"></a>2. 模版</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 初始化 left, right,  currentResult, bestResult<br><span class="hljs-bullet">2.</span> while (右指针没有到达结尾) &#123;<br><span class="hljs-code">     加入right对应元素的值，更新currentResult</span><br><span class="hljs-code">     while (currentResult 不满足要求) &#123;</span><br><span class="hljs-code">        1 窗口缩小，left右移 left++;</span><br><span class="hljs-code">    &#125;</span><br><span class="hljs-code">    1》更新最优结果 bestResult</span><br><span class="hljs-code">    2》窗口扩大 right右移 right++;</span><br><span class="hljs-code">   &#125;</span><br><span class="hljs-code">3. 返回bestResult</span><br></code></pre></td></tr></table></figure><h2 id="3-例题"><a href="#3-例题" class="headerlink" title="3. 例题"></a>3. 例题</h2><p>给定一个字符串 <code>s</code> ，请你找出其中不含有重复字符的 <strong>最长 子串</strong> 的长度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaxLengthOfSubString</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">maxLengthOfSubString</span><span class="hljs-params">(String s)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (s.length() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">int</span> left = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> right = <span class="hljs-number">0</span>;<br>        HashMap&lt;Character, Integer&gt; map = <span class="hljs-keyword">new</span> HashMap();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; s.length(); i++) &#123;<br>            <span class="hljs-keyword">if</span> (map.containsKey(s.charAt(i))) &#123;<br>                left = Math.max(left, map.get(s.charAt(i)) + <span class="hljs-number">1</span>);<br>            &#125;<br>            map.put(s.charAt(i), i);<br>            right = Math.max(right, i - left + <span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> right;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String s = <span class="hljs-string">&quot;abcabcbb&quot;</span>;<br>        <span class="hljs-keyword">int</span> i = maxLengthOfSubString(s);<br>        System.out.println(i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-寻找最短"><a href="#2-寻找最短" class="headerlink" title="2. 寻找最短"></a>2. 寻找最短</h2><p>左右双指针（L，R）在起始点，R向右逐位滑动循环</p><p>——每次滑动过程中</p><ul><li>窗内元素满足条件，L向右缩小窗口，并更新最优结果</li><li>窗内元素不满足条件，R向右扩大窗口</li></ul><p>——R到达结尾</p><h2 id="2-模版-1"><a href="#2-模版-1" class="headerlink" title="2. 模版"></a>2. 模版</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 初始化 left, right,  currentResult, bestResult<br><span class="hljs-bullet">2.</span> while (右指针没有到达结尾) &#123;<br><span class="hljs-code">     加入right对应元素的值，更新currentResult</span><br><span class="hljs-code">     while (currentResult 满足要求) &#123;</span><br><span class="hljs-code">        1》更新最优结果 bestResult</span><br><span class="hljs-code">        2》移除left对应元素的值</span><br><span class="hljs-code">        3》窗口缩小，left右移 left++;</span><br><span class="hljs-code">    &#125;</span><br><span class="hljs-code">    窗口扩大 right右移 right++;</span><br><span class="hljs-code">   &#125;</span><br><span class="hljs-code">3. 返回bestResult</span><br></code></pre></td></tr></table></figure><h2 id="3-例题-1"><a href="#3-例题-1" class="headerlink" title="3. 例题"></a>3. 例题</h2><p>给定一个含有 <code>n</code> 个正整数的数组和一个正整数 <code>target</code> <strong>。</strong></p><p>找出该数组中满足其总和大于等于 <code>target</code> 的长度最小的 <strong>连续</strong></p><p><strong>子数组</strong></p><p><code>[numsl, numsl+1, ..., numsr-1, numsr]</code> ，并返回其长度<strong>。</strong>如果不存在符合条件的子数组，返回 <code>0</code> 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">minSubArrayLen</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target, <span class="hljs-keyword">int</span>[] nums)</span> </span>&#123;<br>     <span class="hljs-keyword">int</span> left = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> right = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> minLength = Integer.MAX_VALUE;<br>        <span class="hljs-keyword">int</span> curSum = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">int</span> sLength = nums.length;<br>        <span class="hljs-keyword">if</span> (sLength == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (right &lt; sLength) &#123;<br>            curSum += nums[right];<br>            <span class="hljs-keyword">while</span> (curSum &gt;= target) &#123;<br>                minLength = Math.min(minLength, right - left + <span class="hljs-number">1</span>);<br>                curSum -= nums[left];<br>                left++;<br>            &#125;<br>            right++;<br>        &#125;<br>        <span class="hljs-keyword">return</span> minLength == Integer.MAX_VALUE ? <span class="hljs-number">0</span>: minLength;<br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>同步阻塞与异步非阻塞的整理</title>
    <link href="/%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E%E4%B8%8E%E5%BC%82%E6%AD%A5%E9%9D%9E%E9%98%BB%E5%A1%9E%E7%9A%84%E6%95%B4%E7%90%86/"/>
    <url>/%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E%E4%B8%8E%E5%BC%82%E6%AD%A5%E9%9D%9E%E9%98%BB%E5%A1%9E%E7%9A%84%E6%95%B4%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="1-BIO-和NIO"><a href="#1-BIO-和NIO" class="headerlink" title="1. BIO 和NIO"></a>1. BIO 和NIO</h2><p>BIO（Blocking I&#x2F;O）和 NIO（Non-blocking I&#x2F;O）是 Java 中用于处理 I&#x2F;O 操作的两种不同的编程模型。</p><p><strong>BIO（Blocking I&#x2F;O）</strong>：</p><ol><li><strong>同步阻塞</strong>：在 BIO 模型中，I&#x2F;O 操作是同步阻塞的。当一个线程执行一个 I&#x2F;O 操作时，线程会被阻塞，直到这个 I&#x2F;O 操作完成并返回结果。</li><li><strong>阻塞等待</strong>：当执行 I&#x2F;O 操作时，BIO 会让线程一直等待，直到操作完成。这样会导致线程被浪费掉，不能执行其他任务，造成资源的浪费和低效率。</li><li><strong>传统的 I&#x2F;O 模型</strong>：在传统的网络编程中，通常使用 BIO 模型。每个客户端请求都会创建一个新的线程来处理，当连接数量增加时，会导致服务器资源消耗过多，性能下降。</li></ol><p><strong>NIO（Non-blocking I&#x2F;O）</strong>：</p><ol><li><strong>异步非阻塞</strong>：NIO 模型是一种异步非阻塞的 I&#x2F;O 模型。当一个线程执行一个 I&#x2F;O 操作时，线程不会被阻塞，而是继续执行其他任务。当 I&#x2F;O 操作完成后，会通过回调或者其他方式来处理结果。</li><li><strong>事件驱动</strong>：NIO 模型采用事件驱动的方式处理异步操作。当某个 I&#x2F;O 事件发生时，会触发相应的事件处理器或者回调函数。</li><li><strong>通道和缓冲区</strong>：NIO 模型引入了通道（Channel）和缓冲区（Buffer）的概念，可以更灵活地进行数据读写操作。</li></ol><p><strong>总结</strong>：</p><ul><li>BIO 适用于连接数较少且对并发性能要求不高的场景，但是当连接数量增加时，会导致资源消耗过多，性能下降。</li><li>NIO 适用于需要处理大量并发请求、异步操作和事件驱动的场景，能够更有效地利用系统资源，并提高并发处理能力。 NIO 模型是 Java NIO 包中的核心部分，用于构建高性能的网络服务器和客户端应用程序。</li></ul><h2 id="2-阻塞编程和响应式编程"><a href="#2-阻塞编程和响应式编程" class="headerlink" title="2. 阻塞编程和响应式编程"></a>2. 阻塞编程和响应式编程</h2><p>响应式编程（Reactive Programming）是一种基于数据流和变化传播的编程范式，旨在处理异步数据流和事件驱动的编程场景。它的核心思想是将系统中的数据流和事件抽象为流（Stream），并通过一系列的操作符来处理这些流，实现对数据流的异步处理、组合和转换。</p><p>在响应式编程中，常见的角色包括：</p><ol><li><strong>数据源（Data Source）</strong>：产生数据流的源头，可以是用户输入、网络请求、消息队列等。</li><li><strong>流（Stream）</strong>：代表一系列连续的数据项，可以是同步的也可以是异步的。流可以发出数据项、错误或者完成信号。</li><li><strong>观察者（Observer）</strong>：订阅流并对流中的数据项进行处理的组件，它会接收来自流的通知，并定义对数据的处理逻辑。</li><li><strong>操作符（Operator）</strong>：用于对流进行转换、过滤、映射等操作的函数或者方法。操作符可以链式组合，形成复杂的数据处理逻辑。</li></ol><p>响应式编程具有以下特点：</p><ul><li><strong>异步非阻塞</strong>：响应式编程通过异步和非阻塞的方式处理数据流，能够更高效地利用系统资源，并提高并发处理能力。</li><li><strong>数据流处理</strong>：响应式编程将整个应用程序看作是一个数据流的处理管道，可以在数据流中应用各种操作符来实现数据的转换、过滤和聚合。</li><li><strong>事件驱动</strong>：响应式编程是事件驱动的，它通过订阅事件流来处理异步事件，当事件发生时，观察者会收到通知并进行相应的处理。</li><li><strong>背压处理</strong>：响应式编程中通常会处理数据流中的背压（Backpressure），即当数据生产速率大于消费速率时的处理机制，以避免内存溢出和系统崩溃。</li></ul><p>响应式编程在处理现代应用程序中的复杂数据流和事件驱动场景中具有很好的适用性，例如网络通信、实时数据处理、用户界面交互等。常见的响应式编程库包括 Reactor、RxJava、Project Reactor 等。</p><h2 id="3-webFlux"><a href="#3-webFlux" class="headerlink" title="3. webFlux"></a>3. webFlux</h2><p>WebFlux 是 Spring Framework 5 中引入的响应式编程的核心组件之一，用于构建基于响应式编程模型的 Web 应用程序。它提供了一种基于 Reactor 的非阻塞编程模型，能够处理大量并发的请求，并提供了高性能和高吞吐量的特性。</p><p>WebFlux 的主要特点包括：</p><ol><li><strong>非阻塞 I&#x2F;O</strong>：WebFlux 使用了 Reactor 库提供的非阻塞 I&#x2F;O 模型，能够更高效地利用系统资源，并支持处理大量并发的请求。</li><li><strong>响应式编程模型</strong>：WebFlux 基于响应式编程模型，使用 Flux 和 Mono 来表示异步的数据流和操作。Flux 表示的是一个包含多个元素的异步序列，而 Mono 表示的是一个包含零个或一个元素的异步结果。</li><li><strong>函数式风格的路由和处理器</strong>：WebFlux 提供了一种函数式风格的路由和处理器 API，可以通过编程的方式来定义路由规则和请求处理逻辑。</li><li><strong>反应式的核心组件</strong>：作为 Spring Framework 的一部分，WebFlux 提供了与其他 Spring 组件（如 Spring Boot、Spring Data、Spring Security 等）良好集成的能力。</li><li><strong>支持多种网络容器</strong>：WebFlux 不依赖于 Servlet 容器，而是通过 Netty、Undertow 或者 Servlet 3.1+ 容器来运行。这使得 WebFlux 能够更加灵活地选择适合自己场景的网络容器。</li></ol><p>WebFlux 适用于需要处理大量并发请求、异步操作和事件驱动的场景，比如实时数据处理、实时通信、实时监控等。它提供了一种现代化的编程模型，能够更好地应对现代 Web 应用程序的挑战。</p><h2 id="4-netty"><a href="#4-netty" class="headerlink" title="4. netty"></a>4. netty</h2><p>netty 是一个基于 Java NIO 的异步事件驱动的网络应用框架，用于快速开发可维护的高性能的网络服务器和客户端程序。它提供了简单而强大的 API，使得开发者可以轻松地构建各种类型的网络应用，包括实时通信、实时监控、在线游戏等。</p><p>Netty 的主要特点包括：</p><ol><li><strong>异步非阻塞</strong>：Netty 使用了 Java NIO 提供的非阻塞 I&#x2F;O 模型，能够处理大量并发的连接和请求，并且不会阻塞线程，提高了系统的并发处理能力和性能。</li><li><strong>事件驱动</strong>：Netty 是基于事件驱动的编程模型，通过注册和处理事件来进行异步的数据读写操作。当有事件发生时，Netty 会调用相应的处理器（Handler）来处理事件，实现了解耦和高度灵活性。</li><li><strong>高性能和高吞吐量</strong>：Netty 的设计目标之一是提供高性能和高吞吐量的网络通信能力。它采用了零拷贝、内存池等技术来减少内存分配和复制的开销，提高了数据传输的效率。</li><li><strong>可定制性</strong>：Netty 提供了丰富的组件和扩展点，使得开发者可以灵活地定制和扩展网络应用的功能和特性。</li><li><strong>广泛的应用领域</strong>：Netty 被广泛应用于各种领域，包括 Web 服务器、实时通信服务器、消息中间件、游戏服务器、物联网设备等。</li></ol><p>由于其优秀的性能和可扩展性，Netty 已经成为 Java 开发中首选的网络应用框架之一，得到了众多企业和开发者的广泛应用和认可。</p><h2 id="5-zuul和springCloud-Gateway"><a href="#5-zuul和springCloud-Gateway" class="headerlink" title="5. zuul和springCloud Gateway"></a>5. zuul和springCloud Gateway</h2><p>**Zuul1.x(Spring Cloud Netflix Zuul 1.x)**：</p><ol><li><strong>成熟度</strong>：Zuul 是 Netflix 公司开发的一个成熟的网关服务组件，已经在大规模生产环境中被广泛使用和验证。</li><li><strong>基于 Servlet</strong>：Zuul 采用基于 Servlet 的方式构建，它直接与 Servlet 容器（如 Tomcat、Jetty）集成，使用传统的阻塞式 I&#x2F;O 模型。</li><li><strong>同步处理</strong>：Zuul 使用同步处理模型，每个请求都会经过一系列的过滤器链，这些过滤器是同步执行的，如果某个过滤器出现问题，会导致整个请求链条中断。</li><li><strong>功能丰富</strong>：Zuul 提供了丰富的功能和特性，包括路由、负载均衡、请求转发、过滤器、熔断器等，能够满足各种复杂的网关服务需求。</li></ol><p><strong>Zuul 2.x（Spring Cloud Netflix Zuul 2.x）</strong>：</p><ol><li><strong>异步非阻塞</strong>：Zuul 2.x 使用了基于 Netty 的非阻塞式 I&#x2F;O 模型，能够处理大量并发的请求，并提供了高性能和高吞吐量的特性。</li><li><strong>功能丰富</strong>：Zuul 2.x 继承了 Zuul 1.x 的功能，包括路由、负载均衡、请求转发、过滤器、熔断器等，同时还提供了更多的灵活性和扩展性。</li><li><strong>Spring Cloud 生态集成</strong>：Zuul 2.x 是 Spring Cloud 生态系统的一部分，与其他 Spring Cloud 组件（如 Eureka、Ribbon、Spring Cloud Config 等）能够很好地集成。</li><li><strong>网关与微服务架构集成</strong>：Zuul 2.x 可以与 Netflix 提供的其他微服务架构组件集成，如 Eureka 服务注册中心、Ribbon 客户端负载均衡器等。</li></ol><p><strong>Spring Cloud Gateway</strong>：</p><ol><li><strong>基于 Spring WebFlux</strong>：Spring Cloud Gateway 是基于 Spring WebFlux 构建的，使用了 Reactor 提供的非阻塞式 I&#x2F;O 模型，能够更高效地利用系统资源，并提高并发处理能力。</li><li><strong>响应式编程模型</strong>：Spring Cloud Gateway 使用了响应式编程模型，支持异步和非阻塞的请求处理，能够处理大量并发请求。</li><li><strong>灵活性和扩展性</strong>：Spring Cloud Gateway 提供了更大的灵活性和扩展性，支持动态路由、自定义过滤器、熔断器等特性，可以根据需要进行定制和扩展。</li><li><strong>函数式路由定义</strong>：Spring Cloud Gateway 使用函数式的方式来定义路由规则，可以更灵活地定义路由规则和请求处理逻辑。</li></ol><p>Zuul 2.x 和 Spring Cloud Gateway 在基于非阻塞式 I&#x2F;O 模型、响应式编程模型和灵活性等方面具有相似性，但由于 Spring Cloud Gateway 是 Spring Cloud 生态系统的一部分，因此在与其他 Spring Cloud 组件的集成和生态支持方面可能更为优越。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>集合</title>
    <link href="/%E9%9B%86%E5%90%88/"/>
    <url>/%E9%9B%86%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h1 id="⼀、集合分类"><a href="#⼀、集合分类" class="headerlink" title="⼀、集合分类"></a>⼀、集合分类</h1><p>Java中的集合框架⼤类可分为Collection和Map，⽽collection⼜有两个⼦接⼝List和Set</p><h2 id="1-List"><a href="#1-List" class="headerlink" title="1. List"></a>1. <strong>List</strong></h2><ul><li><p>特点：元素有顺序，能重复 ，可以插⼊多个 null 元素。</p></li><li><p>List 接⼝有三个实现类：LinkedList，ArrayList，Vector</p><ul><li><p>LinkedList：底层基于链表实现，链表内存是散乱的，每⼀个元素存储本身内存地址的同时还存储下⼀个元素的地址。链表增删快，查找慢</p></li><li><p>ArrayList 可变⻓数组，查询快，⾮同步，ArrayList 是⾮线程安全的，效率⾼；</p></li><li><p>Vector 是基于线程安全的，效率低</p></li></ul></li></ul><h2 id="2-Set"><a href="#2-Set" class="headerlink" title="2. Set"></a>2. <strong>Set</strong></h2><ul><li><p>特点：元素⽆⽆顺序，不能重复，只允许⼀个 null 元素</p></li><li><p>最流⾏的⼏个实现类是 HashSet、LinkedHashSet 以及 TreeSet</p><ul><li><p>HashSet： HashSet 类按照哈希算法来存取集合中的对象，存取速度⽐较快</p></li><li><p>TreeSet ：TreeSet 类实现了 SortedSet接⼝，能够对集合中的对象进⾏排序。 TreeSet 通过 Comparator 或者Comparable 维护了⼀个排序顺序。</p></li></ul></li></ul><h2 id="3-Map"><a href="#3-Map" class="headerlink" title="3.  Map"></a>3.  <strong>Map</strong></h2><ul><li>特点：元素按键值对存储，⽆放⼊顺序</li><li>最流⾏的⼏个实现类是 HashMap、HashTable、TreeMap、ConcurrentHashMap、LinkedHashMap<ul><li>HashMap:线程不安全的Map,最常用的Map</li><li>HashTable: 线程安全，在各个方法上添加了synchronize关键字，现在已经不再推荐使用HashTable了，因为现在有了ConcurrentHashMap这个专门用于多线程场景下的map实现类，其大大优化了多线程下的性能</li><li>TreeMap：TreeMap也是一个很常用的map实现类，因为他具有一个很大的特点就是会对Key进行排序</li><li>ConcurrentHashMap：是HahsMap的一个子类，但它保持了记录的插入顺序，遍历时先得到的肯定是先插入的，也可以在构造时带参数，按照应用次数排序，在遍历时会比HahsMap慢，不过有个例外，当HashMap的容量很大，实际数据少时，遍历起来会比LinkedHashMap慢（因为它是链啊），因为HashMap的遍历速度和它容量有关，LinkedHashMap遍历速度只与数据多少有关</li></ul></li></ul><h1 id="⼆、常考集合底层实现"><a href="#⼆、常考集合底层实现" class="headerlink" title="⼆、常考集合底层实现"></a>⼆、常考集合底层实现</h1><h2 id="1-ArrayList"><a href="#1-ArrayList" class="headerlink" title="1.  ArrayList"></a>1.  <strong>ArrayList</strong></h2><h3 id="1-底层实现"><a href="#1-底层实现" class="headerlink" title="1. 底层实现"></a>1. 底层实现</h3><p>ArrayList底层是Object数组存储数据，查找快，增删慢。</p><p>new ArrayList()的初始容量，在jdk1.6中是为10，然⽽在1.8中，如果只是new ArrayList()，容量其实是 0，当第⼀次通过add(e)时，才扩充为10。但它的扩容还是到之前的1.5倍的⼤⼩,每次扩容都是将原数组的数据复制进新数组中。</p><h3 id="2-如何避免ArrayList的并发问题？"><a href="#2-如何避免ArrayList的并发问题？" class="headerlink" title="2.如何避免ArrayList的并发问题？"></a>2.如何避免ArrayList的并发问题？</h3><ol><li>使⽤Vector</li></ol><p>Vector 是线程安全的。它和 ArrayList 差不多，只是在⽅法上加了synchronized 锁，扩容为原来的两倍或原容量 加扩容因⼦（构造时指定）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123; <br>  modCount++;<br>  ensureCapacityHelper(elementCount + <span class="hljs-number">1</span>); elementData\[elementCount++\]= e;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>; <br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>使⽤Collections.synchronizedList</li></ol><p>使⽤Collections.synchronizedList()⽅法对ArrayList对象进⾏包装,SynchronizedList是线程安全的根本原因是使⽤Synchronized对SynchronizedList的add,delete等操作进⾏加锁，把原来ArrayList在⽅法上加锁替换成了在代码块加锁，但是这种锁的⼒度很⼤，所以这种⽅式效率低下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index, E element)</span> </span>&#123; <br>  <span class="hljs-keyword">synchronized</span>(mutex)&#123;<br>    list.add(index, element);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>使⽤并发容器CopyOnWriteArrayList</li></ol><p>CopyOnWriteArrayList 是写时复制的容器，就是我们往容器⾥写东⻄时，不是直接写，⽽是先Copy当前容器，然后往新容器⾥添加元素，在将原容器的引⽤指向新容器。</p><ul><li><p>这样做的好处是：可以并发的读，⽽不需要加锁，因为当前容器不会添加任何元素。如果在添加数据的期间，其他线程如果要去读取数据，仍然是读取到旧的容器⾥的数据。</p></li><li><p>CopyOnWriteArrayList是⼀种读写分离的思想，只是在增删改上加锁，但是读不加锁，在读⽅⾯的性能就好于Vector，CopyOnWriteArrayList⽀持读多写少的并发情况。</p></li><li><p>CopyOnWriteArrayList 中的add、set、remove等⽅法，都是 ⽤了 <strong>ReentrantLock</strong> 的lock()来加锁，unlock()来解锁。 当增加元素时使⽤Array.copyOf()来拷⻉副本，在副本上增加元素，然后改变原引⽤指向副本，读操作不加锁。适合读操作远远多于写操作的应⽤。</p></li></ul><p><strong>缺点：</strong></p><p>（1） 内存占⽤问题；</p><p>（2）数据⼀致性问题CopyOnWrite机制只能保证最终的数据⼀致，不能保证实时数据⼀致，因此如果希望写⼊的数据能⻢上读到，就不应该⽤ CopyOnWrite;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>  <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock; <br>  lock.lock();<br>  <span class="hljs-keyword">try</span> &#123;<br>    Object[] elements = getArray();<br>    <span class="hljs-keyword">int</span> len = elements.length;<br>    Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);<br>    newElements[len] = e;<br>    setArray(newElements);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>  &#125; <span class="hljs-keyword">finally</span> &#123; <br>    lock.unlock();<br>  &#125;<br>&#125; <br></code></pre></td></tr></table></figure><h2 id="2-LinkedList"><a href="#2-LinkedList" class="headerlink" title="2. LinkedList"></a>2. LinkedList</h2><h3 id="1-底层实现-1"><a href="#1-底层实现-1" class="headerlink" title="1.底层实现"></a>1.底层实现</h3><p>LinkedList 是以双向链表实现，链表⽆容量限制，且增删快，查询慢。其内部主要成员为 first 和 last 两个 Node节点，在每次修改列表时⽤来指引当前双向链表的⾸尾部位，来对链表两头的进⾏操作。</p><ul><li>LinkedList线程不安全的，因为其内部添加、删除、等操作，没有进⾏同步操作。</li></ul><h3 id="2-如何避免LinkedList的并发问题？"><a href="#2-如何避免LinkedList的并发问题？" class="headerlink" title="2. 如何避免LinkedList的并发问题？"></a><strong>2.</strong> <strong>如何避免LinkedList的并发问题？</strong></h3><ol><li><p>Collections.synchronizedList</p></li><li><p>ConcurrentLinkedQueue</p><p>ConcurrentLinkedQueue 采⽤ CAS 乐观锁的机制实现⾮阻塞队列（BlockingQueue 阻塞队列）</p></li></ol><h2 id="3-hashMap"><a href="#3-hashMap" class="headerlink" title="3. hashMap"></a>3. <strong>hashMap</strong></h2><h3 id="1-底层实现-2"><a href="#1-底层实现-2" class="headerlink" title="1.底层实现"></a><strong>1.底层实现</strong></h3><p><a href="https://blog.csdn.net/qq_42922647/article/details/97375500">hashMap底层原理</a></p><h3 id="2-HashMap的put实现"><a href="#2-HashMap的put实现" class="headerlink" title="2. HashMap的put实现"></a>2. HashMap的put实现</h3><p>当往hashmap里put(key,value)新元素时，</p><p>利用key计算出hash值，然后再计算下标；求解下标的具体过程为：得到key.hashcode进行高16位^低16位，得到hash值；根据下标index&#x3D;(n - 1) &amp; hash，即可计算出下标。<br>放入节点时，有以下4种情况（源码中用4个if、else实现）：</p><ul><li>数组原本位置为空，直接放入。</li><li>数组原本位置不为空，且下面连接了链表，往链表中添加节点，当链表长度为8时，进行树形化，将链表转为红黑树。</li><li>数组原本位置不为空，且下面连接了红黑树，往树中添加节点，当红黑树的节点个数为6时，将红黑树转为链表。</li><li>数组原本位置不为空，但要放入的节点的key与当前节点的key相同，则进行值覆盖，用新值替换旧值。</li></ul><h3 id="3-HashMap-是如何扩容的？"><a href="#3-HashMap-是如何扩容的？" class="headerlink" title="3. HashMap 是如何扩容的？"></a>3. HashMap 是如何扩容的？</h3><p><strong>HashMap出现扩容有两种情况：</strong></p><p>在扩容的时候，首元素达到阈值了，即当前容量*0.75。</p><p>hashMap准备树形化但发现数组太短，即小于最小树形化的容量。</p><p><strong>当扩容时有两种情况：</strong></p><p>当前容量已达最大，即长度已经为2^30，则不进行扩容，返回当前数组。</p><p>否则，在现在基础上扩大二倍</p><h3 id="4-为什么以2的n次幂进行扩容？"><a href="#4-为什么以2的n次幂进行扩容？" class="headerlink" title="4. 为什么以2的n次幂进行扩容？"></a>4. <strong>为什么以2的n次幂进行扩容？</strong></h3><p>  在hashmap中数组下标的确定是通过index&#x3D;(n-1)&amp;hash计算的，2^n换成二进制都是“100000….”这种形式，减一后都是“011111..”.这种除了第一位后面几位都是1的二进制数</p><p>这样的话，相当于hashmap的位置，就只和hashcode的值有关，算出来的index是分布均匀的。</p><p>当不全为1，出现“01101”这样的形式，那么与0对应的那一位，不论hashcode值是0还是1，进行与运算后，都会放入同样的位置，这样会大大增加hash冲突。<strong>向扩容后的数组挪动的时候有以下3种情况</strong></p><ul><li>只有一个节点 ：将当前节点置空后，新的位置&#x3D;hash &amp; (newCap - 1)</li><li>数组下有链表：原下标+原容量</li><li>数组下有红黑树：进行分割</li></ul><h3 id="5-JDK1-7-和-JDK1-8-对-HashMap-的实现比较"><a href="#5-JDK1-7-和-JDK1-8-对-HashMap-的实现比较" class="headerlink" title="5. JDK1.7 和 JDK1.8 对 HashMap 的实现比较"></a>5. JDK1.7 和 JDK1.8 对 HashMap 的实现比较</h3><ol><li>底层数据结构不同</li></ol><p>在 HashMap 的 put 过程中，JDK1.7 时是没有红黑树这一概念的，直接是进行的链表存储，<strong>在 JDK1.8 之后才引入了红黑树的概念，来优化存储和查找</strong>。</p><ol start="2"><li>链表的插入方式不同</li></ol><p>在 HashMap 向链表中插入元素的过程中，JDK1.7 时是在表头节点插入的，JDK1.8 之后是在尾节点插入的。简单说就是插入时，如果数组位置上已经有元素，1.7 将新元素放到数组中，原始节点作为新节点的后继节点，1.8 遍历链表，将元素放置到链表的最后</p><ol start="3"><li>扩容后数存储位置的计算方式不同</li></ol><p> 扩容的时候 1.7 需要对原数组中的元素进行重新 hash 定位在新数组的位置，1.8 采用更简单的判断逻辑，位置不变或索引+旧容量大小； 在插入时，1.7 先判断是否需要扩容，再插入，1.8 先进行插入，插入完成再判断是否需要扩容； </p><h3 id="6-HashMap-的哈希函数怎么设计的吗？"><a href="#6-HashMap-的哈希函数怎么设计的吗？" class="headerlink" title="6. HashMap 的哈希函数怎么设计的吗？"></a>6. HashMap 的哈希函数怎么设计的吗？</h3><p>hash 函数是先拿到通过 key 的 hashcode，是 32 位的 int 值，然后让 hashcode 的高 16 位和低 16 位进行异或操作。</p><p><strong>为什么这么设计吗？</strong></p><ul><li>高16位与低16位：是为了避免没有高位参与运算引起的碰撞。</li><li>异或：因为异或属于逻辑运算，在硬盘上实现的，运算速度快，像+、-、这种都属于算数运算，速度较慢。</li></ul><h3 id="7-链表的插入方式为什么从头插法改成了尾插法？"><a href="#7-链表的插入方式为什么从头插法改成了尾插法？" class="headerlink" title="7. 链表的插入方式为什么从头插法改成了尾插法？"></a>7. 链表的插入方式为什么从头插法改成了尾插法？</h3><p>1.7 头插法扩容时，头插法会使链表发生反转，多线程环境下会产生环； A 线程在插入节点 B，B 线程也在插入，遇到容量不够开始扩容，重新 hash，放置元素，采用头插法，后遍历到的 B 节点放入了头部，这样形成了环，</p><h3 id="8-如何避免hashMap的并发问题？"><a href="#8-如何避免hashMap的并发问题？" class="headerlink" title="8. 如何避免hashMap的并发问题？"></a>8. 如何避免hashMap的并发问题？</h3><p><strong>1.</strong> <strong>Hashtable</strong></p><p>HashTable的主要⽅法的源码实现逻辑，与HashMap中⾮常相似，但它的所有的操作都是通过添加synchronized锁的，从⽽实现了线程安全，尽管JVM对它做了优化，但效率还是不⾼。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123; <br>  <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>&#125;<br></code></pre></td></tr></table></figure><p>2 <strong>ConcurrentHashMap</strong></p><p>我们常⽤的是java.util.concurrent包下的ConcurrentHashMap</p><p><strong>1.原理概述</strong></p><p><strong>之前的版本：</strong></p><p>1. ConcurrentHashMap通过在CAS和分段加锁来实现同步，分段加锁就是在ConcurrentHashMap 中，就是把 Map 分成了N 个 Segment（默认 16个），进⽽减⼩锁的⼒度。</p><p>2.put 和 get 的时候，都是现根据 key.hashCode()算出放到哪个 Segment中。Segment 在实现上继承了 ReentrantLock，这样就⾃带了锁的功能，在put<br>的时候需要锁住 Segment，get 时候不加锁，使⽤ volatile 来保证可⻅性。</p><p><strong>jdk1.8：</strong></p><p>1.ConcurrentHashMap 取消了 segment 分段锁，⽽采⽤ CAS 和 synchronized来保证并发安全。数据结构跟 HashMap1.8 的结构⼀样，也是在链表节点数达到 8个时，转为红⿊树。</p><p>2.synchronized只锁定当前链表或红⿊⼆叉树的⾸节点，这样只要hash不冲突，就不会产⽣并发，效率⼜提升N倍。（之前是固定的段数N，现在是根据数组⻓度呈线性变化的)</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/jxg0via1.png"></p><p><strong>2.put</strong> <strong>实现</strong></p><p>与hashmap⼤体⼀致，就是据 key 的 hash 值找到 node 数组相应位置后1.如果相应 node 还未初始化，则调⽤ <strong>CAS</strong> 操作插⼊相应数据。</p><p>2.如果相应位置 node 不为空，则使⽤<strong>synchronized</strong>同步代码块对链表和红⿊树进⾏更新插⼊操作。以此来实现同步。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">final</span> V <span class="hljs-title">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span> || value == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>        <span class="hljs-keyword">int</span> hash = spread(key.hashCode());<br>        <span class="hljs-keyword">int</span> binCount = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;<br>            Node&lt;K,V&gt; f; <span class="hljs-keyword">int</span> n, i, fh;<br>            <span class="hljs-keyword">if</span> (tab == <span class="hljs-keyword">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)<br>                tab = initTable();<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-keyword">null</span>,<br>                             <span class="hljs-keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="hljs-keyword">null</span>)))<br>                    <span class="hljs-keyword">break</span>;                   <span class="hljs-comment">// no lock when adding to empty bin</span><br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)<br>                tab = helpTransfer(tab, f);<br>            <span class="hljs-keyword">else</span> &#123;<br>                V oldVal = <span class="hljs-keyword">null</span>;<br>                <span class="hljs-keyword">synchronized</span> (f) &#123;<br>                    <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) &#123;<br>                        <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) &#123;<br>                            binCount = <span class="hljs-number">1</span>;<br>                            <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;<br>                                K ek;<br>                                <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                                    ((ek = e.key) == key ||<br>                                     (ek != <span class="hljs-keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;<br>                                    oldVal = e.val;<br>                                    <span class="hljs-keyword">if</span> (!onlyIfAbsent)<br>                                        e.val = value;<br>                                    <span class="hljs-keyword">break</span>;<br>                                &#125;<br>                                Node&lt;K,V&gt; pred = e;<br>                                <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-keyword">null</span>) &#123;<br>                                    pred.next = <span class="hljs-keyword">new</span> Node&lt;K,V&gt;(hash, key,<br>                                                              value, <span class="hljs-keyword">null</span>);<br>                                    <span class="hljs-keyword">break</span>;<br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) &#123;<br>                            Node&lt;K,V&gt; p;<br>                            binCount = <span class="hljs-number">2</span>;<br>                            <span class="hljs-keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,<br>                                                           value)) != <span class="hljs-keyword">null</span>) &#123;<br>                                oldVal = p.val;<br>                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)<br>                                    p.val = value;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)<br>                        treeifyBin(tab, i);<br>                    <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-keyword">null</span>)<br>                        <span class="hljs-keyword">return</span> oldVal;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        addCount(<span class="hljs-number">1L</span>, binCount);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br><br></code></pre></td></tr></table></figure><h2 id="4-HashSet"><a href="#4-HashSet" class="headerlink" title="4 HashSet"></a><strong>4</strong> <strong>HashSet</strong></h2><h3 id="1-底层实现-3"><a href="#1-底层实现-3" class="headerlink" title="1 底层实现"></a>1 底层实现</h3><p>HashSet 底层是使⽤ HashMap来保存元素的,元素都存到HashMap键值对的Key上⾯，⽽Value它定义了⼀个统⼀的虚拟的Object对象。它最⼤的特点就是可以去重。</p><p><strong>1.</strong> <strong>add</strong> <strong>⽅法（HashSet去重原理）</strong></p><p>add ⽅法调⽤的是 HashMap 的 put ⽅法向 HashSet添加元素，实际是往map成员变量⾥⾯添加对应的key和 value，map中的key实际就是要添加的元素，value是⼀个固定的对象，具体操作为：</p><p>1.HashSet 在存元素时会调⽤对象的 hashCode ⽅法计算出存储索引位置<br>2.如果其索引位置已经存在元素（哈希碰撞）则和该索引位置上所有的元素进⾏equals ⽐较，如果该位置没有其 他元素或者⽐较的结果都为 false就存进去，否则就不存。<br>3.所以可以看⻅元素是按照哈希值来找位置的，故⽽⽆序且可以保证⽆重复元素，因此我们在往HashSet 集合中存 储元素时，元素对象应该正确重写Object 类的 hashCode 和equals ⽅法，否则会出现不可预知的错误。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> map.put(e, PRESENT)==<span class="hljs-keyword">null</span>; <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>HashSet 不是线程安全的，底层的 HashMap不是线程安全的，它⾃然就不是啦，可以使⽤Collections.synchronizedSet(new HashSet()) 来创建线程安全的 HashSet。</p></li><li><p>由于 hashMap 中的 key 不能重复，所以 hashSet 不能存储重复元素；</p></li></ul><h3 id="2-如何避免HashSet的并发问题？"><a href="#2-如何避免HashSet的并发问题？" class="headerlink" title="2.如何避免HashSet的并发问题？"></a><strong>2.如何避免HashSet的并发问题</strong>？</h3><ol><li><p>CopyOnWriteArraySet</p><p>CopyOnWriteArraySet底层实现是利⽤数组，它的上层实现是CopyOnWriteArrayList。</p><p>CopyOnWriteArraySet是⼀个集合，所以它是不可以放置重复的元素的，它的取重逻辑是在add中体现的。</p><p>CopyOnWriteArraySet 是利⽤ CopyOnWriteArrayList来实现的，因为CopyOnWriteArrayList 是线程安全 的，所以CopyOnWriteArraySet 操作也是线程安全的</p></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>金数据</title>
    <link href="/%E9%87%91%E6%95%B0%E6%8D%AE/"/>
    <url>/%E9%87%91%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="6e5cf84ba6f8601f955c633382261fd14ff40164f93432e3d76d3a8574c8aa1d">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c0cb66cc052f523f3922af786a9e652a8786ad54893e4aeeb0e23155bf5fafd49e32d00216adb3b598dcf36e30c085848cf474ea89f81ede7d801d23ce18681b95947d5388f3bb70ed173538391456d9256fbbfb7f6d79f2abdb5cd06683d6ad25b5ed493a5ab9ffcd057bd440a9d6a0a3359571b35124aaba36c6fcc7b9e652b93ead65af05890b07ed8c658ee253c9b874bb727e722d2d002b9d3e9f9a94c0944aad441f9fa9f525a0f8ef5394f23504e80bcca6cb35253fd2430679f4a0d07f7c12d13c07481e147edbb8ae7ca98158d1428d7adc9f5ff45cc05f16d1ea9dc0f8625baa852cec6a46ec7b3b32188bad959d84fae100033b8b6adef46518439005aa0fce2ebf06afcc8b4762c1328c3730f9fd4e68348b0a46c7191dffee7d010810bb3bd1bf54b982a963e8d94e9a158fad6ef33064ce00b4f40182a7f5c2d5f3f5c0ead2cabeebfbe8d69a2186e08c03c3bc1c18981e9bd52b6c9169c4f5ba79b780b41b9c5d7ddacf029200b0c410c4c3f06a0854831db5b90461bfab2d11be04a88414a4123e30e01f6b4ad614e8c1b868b5c87889580670c948738036a95ff7a7be75627244a6d40e632b1199276f66819a3847d0c1d5bd9ad00d7c1836a8b080ea5658e74210845c1346c60af7ba42fae7a0ddbaa460dcf2804a3dba8fdfd5a600fb99c5f694024ea71194de2f2903d64074a96c89b176b1cc86903fc7590b71c0154f30bda7a6fa7bac9bff491b5564e6982793decd656387a31bbdce055d2e92060b62e63ea565ff74a4786024ace51f449925e02cbab01c9cd63686ea4409274ed10013bd56e53ee22d91ff5f3ffe51934fe91c0a750fa05b19fb0c2ba539fd35b1396f32efd1fec203f915e5ead84c9282c86d841568933289c827cf6c0a35a7096de85136dbf007e8b9072a12be6650fb748810df031bf33f5fff46ee919c7d5b47ac6973167d66b18fded230fb27307917c5e1317cde9b0c92856d17b8d69ac538788b23893d94b6f21b833e601970e1fcdbec9b4e4d2256a1a5dd49429e7dd31a81372c4fd2007159354796a9ea668327df7b61872c54c8a46f2fd736c6aa09050eec5008cbd89ddf1c1bca59c7eae27618f96804e33e1c2f5dec3a0609e32dbc5e9761dc98b7f612c6cea4ff696fe6c9100bfe6bb5157f22038e67097cb89ac5f814ab675315fe6d4e8c60a45425787c3a4ac8a7cbbab38fe2d1a26747958529ea250047af32e3e20ba761f071712984171e4b477d108359b59334721f3eb8d57d236583c7515cd7e1846ff781a243e0b2658268ccbc3804a35452931f8ac268fa7a92a1158d7e3dfbfd41e79b37f0567a9191eaae31a60df388a5551f31d08db2a7274e8a6447f7ab1f008f72b92fee342d8f0312cd6fd614dbf113b6002881b2b1a085ed56fb49d479020baf39276e89cf175b9987ef1703148f60f08417d9ee538400bf669c963d8e15ff8245df6eb9e6466b2bc5c339c5b0af0c379aa77a43fb487bf8425b4b2d5ceb42b029d92328f16ee261eff49d15cfe5538ed145f807cf98e3dcb673ec683e233cedab1df588a8f6dde0f40b0606f40cf95139a04c7a97c2446f20529232779b9e52cf8ea393f6df17a6e1a49451a8fbe6bcdf0017f96bf2695f403bd940e00638bf2e1bbdc9f1cd56af5522c966b602bf6cdea93b7502712afc68a7eb615313120a282fc208f8036fcf14d6047f2c4a32a25c75085f6fb90dc6f66f75bb3a1e5e83f8d3dc3b76578c441c026adb278f9c9d74ae0917e02bb9a19076fdbe281ce5c7da226fd722efb990e1bc8d970aa85f1078fa96237a51f993610ac8fa6dbe6fcfb43384951461013f308d1cafc73628f0d369866d07401fc98726b45452feb1e68324e98ee1c056de44a794709a15789717021aa112247eba4107393d708eb111e13475430c99e9b1f02353f70877a5dc903249657c3f92f66e8039e4e7b313a16fae66d23258ecd617c0c3495245fe30943f54b4de07f932a3389d1d7a520204b6c23394d049e5de8881b7d4b2f2b110646f9f97f77dbd2b3b4dabfbfae7e5ce863ef35de1b40671d8d499b83e8917063721f8b46cc0f35c196fe09983a3587ed15d362c7226690320a9c94418672eedfb0744450279c116d6d4016d4a30c5e9d36086675b04e4cdcbfc85018ff9131777985e721c86c97ccd98f31666339d49d55c5188bc109ab302382993abe65825708adbeed5567b83e9bda8eeefb1af412e5b19eac75c7d384e93a2764776db824957206752a73ad0373343751b3062ee1f767e72d619b902811c6891a0636a1bbcf61c25b39f8aa7cd88f0e64c3d309baf7858ded067e6d26912f20d25f79f3bc8623b9ab3561a23efdae334b853e20d294d7e6774cf09ced33192e2834914044978d7f532c7d46660463bef92612c29d5d755042c1d5fb2ad35231eeaf8c72af060da1915fed81c2a58c4701201a3a98746ceb61aa50343e19d922abd5f7e57cbca872ab1c0d35873efa17ba1caaa8ad2c55416e74e66ac3476cc952231da8aa9e00e9065a2b1c70b662872ea805dfea27bf273f1bf82bec9330771eafda479d84ae835a9e24da7c6e6b0afb8d66d19a093612bb4c758d7cc514f9068058a134276402aaa52732fafb429cd5d116eda4f2f117205ebc2efb073a7d4a30536ec1a4f9cebb04798b3318e2f4398306efc849b7d9b30b46e7c1afbbcf8dcad38bdd73f32635ff8fd20cdc75a0051f7d01ef2f48fa4bd16c66993173a9a366fb4c4ca681892941271d4fadfdd1ddee8cb789c8f13071a0c5274bc8585c42370ea9e1563dadbb65b01e6d52f9c5b58cd116aef96166fb8d96bf1c964f932f119c1b1e89f66e7cae02a48775002b95cac4b1839d9feaf36f97eec254f4f4e896fc5330f523882667a727a449befbce63811cfe9156f8d2eff53407d85c56f0f1bda4f7eedd163089938c435b4e948c02d557e3a99165675bad114d8fd669fda2114f02ea01049a96578f7a79533ae72b1ff1eb93083e229774561fb430de1a4ad250390b374482d895597a2e0b90cc1f04e045c812a8329341a23879ae4e546b91ae6cbbd4faa053af14a19ddbb3a16ebce41d020fc094cf5e37688d82f02d5f0e5506249984d7c1e469de9030738f1daa8fbd90978a44fb2549eed40329bee0b7e06b5d23eafbe54a4a49517d3c882b8068ad9371ed246b291c55d5a82dd3206d7f44f9f725f8c609a542a0494180a425af2deb7f5bddaf54404d303bcc5d3903e22957dc917219e5568b6cf5cfdb64786c921601e602e96b98c65e9d31b8d536cff257d7f09a06444f62f900970</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>dubbo3.0</title>
    <link href="/dubbo/"/>
    <url>/dubbo/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Dubbo和Feign的区别和联系"><a href="#1-Dubbo和Feign的区别和联系" class="headerlink" title="1. Dubbo和Feign的区别和联系"></a>1. Dubbo和Feign的区别和联系</h1><h1 id="1-选择建议"><a href="#1-选择建议" class="headerlink" title="1. 选择建议"></a>1. 选择建议</h1><ul><li>如果你的系统是 <strong>中小型微服务架构</strong>，更注重开发效率和易用性，且主要使用 HTTP 协议进行服务间通信，Feign 是一个更简单、更轻量级的选择。</li><li>如果你的系统是 <strong>大规模分布式架构</strong>，对性能要求较高，并且需要强大的服务治理能力（负载均衡、服务降级、限流、路由规则），建议使用 <strong>Dubbo</strong>。</li><li>如果你的项目已经使用了 Nacos、Sentinel、Seata 等阿里巴巴开源组件，Dubbo 的集成会更加顺畅。</li></ul><h1 id="2-异同点"><a href="#2-异同点" class="headerlink" title="2. 异同点"></a>2. 异同点</h1><h2 id="1-相同点"><a href="#1-相同点" class="headerlink" title="1. 相同点"></a>1. 相同点</h2><ol><li><p>都是 <strong>RPC 框架</strong></p><ul><li>Dubbo 和 Feign 都是用来解决微服务之间的远程调用问题。</li><li>它们的核心目标都是让开发者像调用本地方法一样调用远程服务。</li></ul></li><li><p>都<strong>支持服务发现</strong></p><ul><li>Dubbo 和 Feign 都可以与服务注册中心（如 ZooKeeper、Eureka、Nacos 等）集成，实现服务的动态发现和路由。</li></ul></li><li><p>都<strong>支持负载均衡</strong></p><ul><li>Dubbo 和 Feign 都提供了负载均衡的功能，能够将请求分发到多个服务实例。</li></ul></li><li><p>都<strong>支持声明式编程</strong></p><ul><li>Dubbo 和 Feign 都可以通过接口定义服务，减少手动编写代码的工作量。</li><li>Feign 的声明式风格更加简洁，而 Dubbo 的配置相对复杂但功能更强大。</li></ul></li><li><p>都<strong>适合微服务架构</strong></p><ul><li>Dubbo 和 Feign 都是为微服务架构设计的工具，能够帮助开发者构建分布式系统。</li></ul></li></ol><h2 id="2-区别"><a href="#2-区别" class="headerlink" title="2. 区别"></a>2. 区别</h2><ol><li><p>使用的通信协议不同</p><ul><li>dubbo默认使用自定义的二进制协议（Dubbo 协议），也可以选择其他协议（如 HTTP、gRPC 等）。Dubbo 协议底层基于 TCP 进行通信，性能较高，延迟较低。</li><li>Feign使用标准的 HTTP&#x2F;HTTPS 协议进行通信。依赖 RESTful 风格的接口设计。</li></ul></li><li><p>序列化方式不同</p><ul><li>Dubbo支持多种序列化方式，如 Hessian、Protobuf、JSON 等，默认使用高效二进制序列化（如 Hessian2）。适合对性能要求较高的场景。</li><li>Feign支持多种序列化方式，包括 JSON、XML、Form 表单等，默认使用 JSON 序列化，虽然简单易用，但性能不如二进制序列化。</li></ul></li><li><p>对注册中心依赖程度不同</p><ul><li>Dubbo强依赖注册中心（如 ZooKeeper、Nacos、Consul 等）来管理服务的地址信息，客户端通过注册中心获取服务提供者的地址列表，从而完成服务调用。</li><li>Feign可以与 Eureka、Consul 等服务注册中心结合使用，但本身不强制依赖注册中心，当服务地址固定或通过配置文件指定时，Feign 也可以独立工作。</li></ul></li><li><p>实现负载均衡的方式不同</p><ul><li>Dubbo内置了多种负载均衡策略（如随机、轮询、一致性哈希等）。</li><li>Feign依赖 Spring Cloud LoadBalancer&#x2F;Ribbon（Spring Cloud 的负载均衡组件）实现负载均衡。</li></ul></li><li><p>支持容错机制方式不同</p><ul><li>Dubbo提供多种容错策略</li><li>Feign集成 Hystrix 实现熔断和降级</li></ul></li></ol><h1 id="4-dubbo使用"><a href="#4-dubbo使用" class="headerlink" title="4. dubbo使用"></a>4. dubbo使用</h1><p>实现 UserService（服务提供者）</p><p>在服务提供者模块中实现 <code>UserService</code> 接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.service;<br><br><span class="hljs-keyword">import</span> com.example.api.UserService;<br><span class="hljs-keyword">import</span> org.apache.dubbo.config.annotation.DubboService;<br><br><span class="hljs-meta">@DubboService(version = &quot;1.0.0&quot;)</span> <span class="hljs-comment">// 声明这是一个 Dubbo 服务</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">sayHello</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello, &quot;</span> + name + <span class="hljs-string">&quot;!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>调用 UserService（服务消费者）</p><p>在服务消费者模块中通过 <code>@DubboReference</code> 注解引用远程服务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.consumer;<br><br><span class="hljs-keyword">import</span> com.example.api.UserService;<br><span class="hljs-keyword">import</span> org.apache.dubbo.config.annotation.DubboReference;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>&#123;<br><br>    <span class="hljs-meta">@DubboReference(version = &quot;1.0.0&quot;)</span> <span class="hljs-comment">// 引用远程服务</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String name)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userService.sayHello(name); <span class="hljs-comment">// 远程调用 sayHello 方法</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>中间件</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>howxm后台设计</title>
    <link href="/howxm%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/"/>
    <url>/howxm%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="fbb08d7055a81b1c2927920f139228550f78d6fef045ef4ea3e500eb43e23ba0">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c0263079da70fca6ed3fa9937b472a75a43e36575b9bdd82a12137a631acd9d426e1920435f87905a237e03ce266ae4d25338c220aeaa0dfdeccad85d019a474861b38c88bee9b6ed96d9be009f759c55e2e270b74b7a19340cc610ca63472ad99c97ad35b34121e626e1b71b5775d33b9ea934489fe563ee0a5923d74baecc49c80aec4700f19a2649f44b91925bae63ae8c058a3a56d505adf0374c87d6236ea745db9ecb4e739f84aa436f22abfb62086827436c9da65247bb24a315224a47328a7788fb7477c79c61ae5acaee1b84c9f14c53214da631803f1577d79671e7ce6b383368d939690b6ecc19f960cf30d18384b1add1fb8f5913f793354e26f11c6f8e5c4ecefa499dfb9791376098f216b408f4d9fcba05e0d40c4136e2a4f846e5ca4177a6fadaa019788650c0a4b0a84d3c02d40358f7d9202d2a2884166ca9d202341b0a2959ff1fa559b3aa4a1502b62f2b0412a56b7840c9278007fecff21ddde94204820464933823aed7f32f4e9b3c12af10ced9bb213082171803b49efac81f9aea2221f1633e68c99f407d2fcfd29e1e75ccafc414b2f7a39926514da22cedac5239d4858a226f5f8f41df87177d26c58178995b1895b765e05b1b185e988e766bb5ffa82b3520d4f6a28e32d294474724b6e7cd6e525fc5d6791eecceab2abc1f74aaf3faebfc2c5f4d34f01a2fe27b9490b7fd9c84c3e505ec30e01408866589b283055e719f354d6a2eaee7f26eb689945b2745480a46a2164826c1816ec2341596cee0e69c135dcdadab4fd4752581d2f1eb32ca8e1d3d41bb4ad79230ba6087d1c8d05b84584299767251137285118c996aea8ee3b4de08e422cce3f0749a097dae6a0280d2115ebcf7ec7f42daea020f669509023588794f8f875dd3da6bab4113779ad49f0277bbfae8ef3dd6cb3546f5e9178e6922d1c9bcd0f6572d18d4771c2458b88299ffb3658d2a59abcc99bea757e2844d5e2d329b3a34c72d1eed48cf682b92e0dc2039e3918de07911184717ae57960bb6146a0b01b173a8e1684a3145decc5eaf91f12d6a41581b08c3863e083a916954efd4e8b26a3ed1a03d1dc34b0a39a9114d8f3446fa0aa9a752ec8afbbf2bbd0666cba9f6c2e63c5ea0cb5ee43ed6876c139480fc1ded7964640862ab138f48e622e0f6ba14dec161872d18475558308dd6bb273540b8e5fca9797dd522e4c796e2f9b02a0178c198b9e42628882b70341a8cbbb28f20c7eaf869dbdf15b9d14e64e0e30c2004a5ebefcccb5e57d5da031ddf6c3649bb0f1d26b9933f1802cd649ed82dd2060bca3064e36eb5b07558fb7e8c5d506ea6e69ee3ab611760b838e73cd9b18b9c9b7079594d5420015c377f5784c0c61fb57f5493bb2cc13dfcfa0d39bad8622c817aef25cc9687ab26fc7f835c3b7d48bde47a2bac90d1e32bbf77d5be3ab3f2efd984271111a84c9b2bde98bca449585fad3f378528a93b5e7582e7101694d6232ecaf366177256438545569860d57852b61788ca63955e20b013c156b38464701c33f6ab6164bef6d02316200b73b30e2fd22d5840e4bbc435551fae928c29186109871ed16ad290e8cc5223a0e8570985b9a6fcfbf369c6b0a9b81ae1c26cbfb81597f4f3c210db459223cb95de2ce99c19dbc8db2a937e9d1cdc4e7aae5b397f6a6aecdf855d9877215368fec3ebc0d2ac79ecf58dde1ec8e719646a0960aa012c8e1efb7a2cc0d73191eef6e64152c3f110f9a44efae4e1ee7cb24b44760f90ec71d44ced55f9b64f1988564ef59becca0993c4dfc8e1517718a4167dbd3d8b51028e0277a34ffb68b3b2f9647e275d54c031173b649ea1db1f9a7e65b37495be76ea8f9927d981c7f8bd3f0cc39982345ba88bb0598129f688627692c9770c2619ecea708674bd2350482a4a9ef35115bbfd20a0360a115ab39ccb2f7351f5cfc100271bc4efc094944e4ffa67b0ef9510132c938c8e59ec289bb7fc3e5beed71fd27689c568db04c1bf08e1e1574ef2c34c81384096ede3a17ef50388cc3e6ef9fbecf54807064998e18789bb82ce4cf3189aae8f3da6763aa6ac2af477b876585b5bbe0a33e7c58f8851f045191e5bf1d9dc3f218c24f16794525cb745ab22fb3383431f43fc6fe6d7c0993c932a8e89dfd28b6186634706eaedb669f601827f04e91c2673eb853e19a86bd8c7d59833c8dc37c61fb9f104e2e489df3f47dd9a9e4c385db616af41e8b0ee9b694b664d7172ed40b3d59beb563</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>k8s常用命令</title>
    <link href="/k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<ul><li><h4 id="1-用频率最高的K8s常用命令"><a href="#1-用频率最高的K8s常用命令" class="headerlink" title="1. 用频率最高的K8s常用命令"></a>1. 用频率最高的K8s常用命令</h4><ul><li><code>kubectl get</code>: 获取资源的信息，如获取Pod、Service、Deployment等资源的状态信息。</li><li><code>kubectl create</code>: 创建资源，如创建Pod、Service、Deployment等资源。</li><li><code>kubectl delete</code>: 删除资源，如删除Pod、Service、Deployment等资源。</li><li><code>kubectl apply</code>: 应用配置文件，如应用Deployment的配置文件。</li><li><code>kubectl describe</code>: 查看资源的详细信息，如查看Pod、Service、Deployment等资源的详细配置和状态信息。</li></ul><h4 id="2-难度较高的K8s常用命令"><a href="#2-难度较高的K8s常用命令" class="headerlink" title="2. 难度较高的K8s常用命令"></a>2. 难度较高的K8s常用命令</h4><ul><li><code>kubectl exec</code>: 在容器内部执行命令，如在Pod内部执行命令或访问容器内部的终端。</li><li><code>kubectl port-forward</code>: 将集群内的服务端口转发到本地，用于本地访问集群内的服务。</li><li><code>kubectl logs</code>: 查看Pod的日志信息，如查看容器的标准输出和标准错误输出。</li><li><code>kubectl scale</code>: 调整资源的副本数，如调整Deployment的副本数。</li><li><code>kubectl rollout</code>: 控制应用的滚动更新，如进行版本升级或回滚。</li></ul><h4 id="3-易错的K8s常用命令"><a href="#3-易错的K8s常用命令" class="headerlink" title="3. 易错的K8s常用命令"></a>3. 易错的K8s常用命令</h4><ul><li><code>kubectl get pods</code>: 获取Pod的信息时，常常忘记加<code>s</code>，导致无法获取到Pod的状态信息。</li><li><code>kubectl create -f &lt;file&gt;</code>: 创建资源时，忘记指定配置文件，导致资源无法创建成功。</li><li><code>kubectl delete pod &lt;pod-name&gt;</code>: 删除Pod时，忘记指定Pod的名称，导致无法删除指定的Pod。</li><li><code>kubectl apply -f &lt;file&gt;</code>: 应用配置文件时，忘记指定配置文件，导致配置文件无法生效。</li><li><code>kubectl describe &lt;resource&gt;</code>: 查看资源的详细信息时，忘记指定资源的名称，导致无法获取到详细信息。</li></ul><h4 id="4-其他命令"><a href="#4-其他命令" class="headerlink" title="4. 其他命令"></a>4. 其他命令</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Kubernetes</span>（K<span class="hljs-number">8</span>s） 常用命令~<br></code></pre></td></tr></table></figure><ol><li>kubectl get pods：获取当前集群中所有的Pods。</li><li>kubectl describe pod [pod名称]：显示指定Pod的详细信息。</li><li>kubectl create -f [yaml文件]：使用yaml文件创建一个资源（如Pod、Deployment等）。</li><li>kubectl apply -f [yaml文件]：使用yaml文件创建或更新一个资源。</li><li><code>kubectl delete pod [pod名称]</code>：删除指定的Pod。</li><li>kubectl scale deployment [deployment名称] –replicas&#x3D;[副本数量]：扩展或缩减指定Deployment的副本数量。</li><li>kubectl exec -it [pod名称] [命令]：在指定的Pod中执行命令。</li><li>kubectl logs [pod名称]：查看指定Pod的日志。</li><li>kubectl port-forward [pod名称] [本地端口]:[远程端口]：将本地端口与Pod中的端口进行转发。</li><li>kubectl get deployments：获取当前集群中所有的Deployments。</li></ol></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>MES系统后台设计</title>
    <link href="/MES%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/"/>
    <url>/MES%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="94649eda5b82adbe18f574dce6682723b4c2e391bb00685cbfdcbdbcb2169475">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c0968d8fa93c1632ca0eca11e8328051aac950ca88cc17aad4c97c33df2dd5dcaf79ea33e0b361896167545efc6e85d8224f0857b51eb0ffc0d607b1ab93a8bb4f46e82b9d380f54f438e337b6bece1b828dc3d412a2ba4e90764bbdf9098ce7208c50434bdd5d9598f6cde2fc386c0641f3481abdbeed28b3c6d26cf8d3482ce3c59f0e61fdd81db351e7116bce13e0f2ce2bdccfe58bb88dc085087f7409853671e42eb0635ae49f2773813258e743e7d8d1bb9f2333c5c84b5e35f3f360907b389441120a0af7c1ed2840e7d7287b469b9872f890a39ae827bd43e52ccf51d9be5229d59ba46e3487b82d855819d9a365522efa3d7a11b95e34d677bd4255e2f13e2be5280091cefbe471e10dc03a6b8854e47c195a579bdca11b0d9ac16e3cb48ff512e56695bc8a5a6cdf64d60b9b82cc9c26f473ded6d111de7dfbe765feceb764c67166db15307131bc63de96e2d1424428a8d5698ecdfe840f579843b930a6a8052982828eccac31e8689080f35fa82f01de7b2b4e3d439b9ed39853988defaf1c92d458af67a8aee1bc337bcdda9cc9cec86e79e16e6a11983b84996cdc58c9a25b6869dabe17c296167911dee4a078c8e70c7539fc7bddbe67fbd4df5dcc2e2c819136202a647b1dd6c4a4b6976360ff3726577876546b40df0e9d5baa0f64bd6dfe2473502c8a62e7f4032f6d9bc87d919c4f1258f9166c4b19231d62de642246653e02d6fe4bea093de2b4eb0ce76e22b71a1b7fd18478b5a3d41e8f75725e01feda44500e8721b15c6dbd4e6769d174696c1a7d0c9c26b3a0c469cbd33cac2793fe1c528a1566cce31eb363ce4791ff58f47fa9eee433902a6cb039f4871b74e7f1010a4944088c0e01b0f5586efcffb43efb38ea6b46e8c65d7862c4ebdde456454329dd7449a48684fae29690b368805c955e88e754e6ec0a39a6494b2e01a37175286bc1aaf13f9e260ef547fa0fd1a68caba817c8732d1aa26c7951297357f541dc86d93df126fa65faba9b400264e9901de2ac713f4c47e544df65481a03e633fb01533566f2e2e38355ae8e1aa2b3499954af4c31014b9d338fc26af3db0165b88f988407a0a7e98d92d147e00c793f238d494293811c5c65b8269d3451ac0fa0f2e41c2f0061f11727555bb109502757e6fddcd34b3ae8ea689fe78376b33ef5536bba153ff58f8fe2bd83688bb9064243b0b0f3d89dba405b1650131598ac30e0d8ba3ad4f388861461f1cec05334dd68a8e34f0daa355ca97b6674d7dc6ad357d4b27b2f34153abcddf11751070db026d2be548e61198362d61241f280b6965cff7874734fa34fe1685ee8cc198fbcbd16e3985de3665d81f0db44e6b115f9e7faf3c3f55053448d0a34b1664c0cfc04a658ac3756e1be4986d4f4b47570c5976cc7125391e3e5e0b47919205ac942f1cdd54f8e7f44893ca0affbb6a6a31a818cffc9b7d44439cc97ebf1b681f7aee6a89653d5ba594729fccd98d762d847a6c73c73e087e3e9fd20bf8a8d559d684faef2ba36b8c25d937c9c9f74d213e076201cdf3bea7e02cbef472edc1d8c1b89c8a6e4f5e098c8ffb0253966cd9fed2514ec701e12f75dec5ad55f112b41fff965793caeb805a582d2fec12bd403b00a3d37a769058aa99585d02745545324716fd7241bdc7b3abd733c9821dd8de062dff6a81070479231cfce70eb75fd4e32a8b41182d8f51c24561ba90658478f591ac0863d4a667c810ac8132d71bb618069ed607acf307f91508216da87521dd1effe0649700631b8961845eb3f3f3e78d933a9a26b1ec4962fdf3497760448a22fecf375da898f59d2bc2dc8b07e4f762694217c1449bf2c31e4793d0659d7e5b93a7587fd63fbbb5d5d4bfa174ad030c6eed1674b85eca945b66edf006ce8dec35a2488e083f15d35ec4dd602204f4b7a6d33f246592c2546ce0bb1a75e856ee56c752d6e1256d7c2098e0a810cf5f6fccd134c0b5285ead86ab2c9ce8caf9289eeeb2c30683af550393a77352971bff615a90edca257adb485ebdf4a4754e54d09b3837551449e7fce52943e53c2f40e5255cb2fc5de75d5433bd6ee4c38f856f3c6b0bf5189de5e16bfd8bb9fc0a0b6568a7d6624cd138940c40e5a4b8fac674c413085b1fb4d13316bbbefb83ad251e374024d7c11b8106d59ca484814db41d2455027ee9da020d5513371a99ad7d74a142020f158e9bc3f7a9405360f9ff34cea0259215aafc80cf5df8631e15622d8e684261f3ca39141463e044a683165a9fe97274c07bb6fa290caa1898e078540cd0733591a7a5dee8592cd5b75e7c6552fc5db88d4f08fc4d28eb221c765c592006dfde479b98fda28fee507f335ee607a63a4da7be450993154d6a2f7301c085305a44db19ae8d14234ac61998aa0a4ec498ed5f151015a8e15574f0ebae8dabaa9b362aee635d4851f1efa583346f2068a1155d7db38183de1bcc566f1ff60d2c9514f66cb8303237cebbcf0f60e4947e72cb59cad84a494d843c5c6893415acb90b25ac5d312a80d28e3a842e4f656449a4f4a45f736757dec5323ee8de0613a1ac6589433acda0e29303b6eca092a096987dc39e3f7aadbe8194d032287ce7e1c8413cea8d23e29b5b39036e3d3b18f5455fac62a53859cd495ce077551a0f57409165eba1442d46a0e052684b2d8e7e37054fb91158a089209f75682aa9d4e1e45944952a89c80855dd499a63576ef064c5750c58eafec03ee411e497da009f769176d598df36e876e313e9b9b7d36f9d9952608db2624404cf6ac95f916bfe42cc9c81e8a5bbac8a73da09bc57d4472a320e4783f750584d65826322409fda44c8e9a89017c95d76ae5d086ab9b8a8703e6a02031b36a6808644ded2249debac2a2a29c8589cf4ee128f267d592fdf20640296832f201c6b0eae5349334f10eb7da7ffa960cb55c67ea05fd06f58b380e3774cb95758a6cfcc9a01ee1f7edbd9d748b7ea390b5eb446f609b036b3a20cf4665c8c9278ff7584602170daef3dcbf29fc07e19475e18735fb2b604bfa65aee29ce82adc2e5acb5079e417bcce5b3f92bf8d73f6068502d8fff73600fe38cef76da14ebc04c3a26a8239bd1679e2fb279e67956e6489ebcefe3519c0f1500f9c7c59ef72ed197dcc3058d46cb6ca15f2c68efadf1fe94bc73ab355e1cfca9cc4d8a3e3e34506582a3abc7158d9e0b2535ae16f48c6d0b92edceda29c4a6f739db15a181a9a15beaaf95297a70da610938bf76112ca3a13ca08d8059cb49c53ba3de13c964b6febc07a66b2fa7e7d0fb8c44094ca1e8e8ac6f5e3c55806d7344a546c8f01fec2d4147377d9a2781b8a6dbc289e6ae5c0c563016a7df9c649e7ce0f522ddfa816bb4e2734afd842c85dcc1f03b48762fea549159bd6d948192e8c809c5d18d2f0c9f75f345bc8f82592b8368c4007d02a846fd2fdb3765a22105779a03e4cbed80bcc8ddb23a840b41ada248713ae0aaaf526f3d494f3a7f02c1a57f49a363c538b4bedd28934edd563ca49721541fd965b553dab2d8747b832c008023a41c8aa6b3f1a1ecfd7385691b690f2628eca7444fee873245408b23bea0290dbd658d68043b10ab58c62f09b2cbd6300f2abc63404805ce57d74630c20c37f0df521193557e9ffedc83da7324ed27abceb43c625ed98f098a814e66a9228bcba7a96777c941652abf462ae1b4bbe7f1d4a70836da318965b23396e62ab03d270fec83172e29d4917a4731eea46408987ad82154ff07ab25034df5a27fc3a86fc177d0bbd290b56586077cb9ccaef3d779b739a26b3c166aed8515d5b41c0e15f052bb0d9d965b19c3f5dd8fd38e6c035b4bb5f7714f00187b62e6e546d57fd61b43bf24d67301385c3bbe9c77eda2787036fa234c6a8ac84863cf5eca0b5c867a338b34d4bf8ac77871b631b72546fb7e1e4d3db22cc206c7c4c8893ae77565eecebfefc111a124a3f5dbbbdcc2eab0289eb4417a4e632b280ff6f321f6501d8317ad643e0d175559dfe84dce1bef0f2d725d1db3a27f70ac663ddc9ece7791b5a02849792a2136a25ba4f3ec923c64fa9ef25735f83e0e7644d4145e2c8e9b71f879d0c2cdfe73a13614441b7e41b2efd02a03a5f53fd17999aa6e3996d4a70ff81a8d6fbf90ec4c929065268026062c5ddf00950a8af22d8396db4c26246e76790c7fb44857fe92100131895288beb20e53a03527b5854482a862d061dd6ad5f8b58b59e684db30c490137914e993c3edf8f6568fc366264d5e8341818792fb27fbad210dca98c22d03cd1bda64f4a7b42d82861097fa7d3655e6d7da2f2808a02577717571ace5468c153d3244abe43636e5ae60ace92826c28db7fb937d40a0bcfd56634cb8c3b7f9f6636eb2ce8753932922827233d88f7261e6949dd12d424c8b3055c3b61648cae4050ee8c1a8406326ac907719c5c3fa75793ac460681dff9c21f5b12598300e13dd8a04a205d83b80900c7de913442dc14492b4a9d2f2c669bb095abe01c144513403c502f3e6405e5deb21a0216a3ebe0fa46c600c58c2a4f4dcd3c972b27983ebd60b7173e96e32bfce6451df3aff6f4a9fc3458032c6a93224f5f46352d58704e6aa2e5cc209aa3a40ed8535c2e151b033dab021de9c5d6ef3883f24887a964aee052954e3a705fd0fb662487da10f18e4edcd8e4e6847b65a9a9288e8fde18f1e276577f3d0557dbe6443f0b7029d004a454f3875eab047b8d73b1f7bb715b90c7b175741dc879a420c12455a9eb2dc0be28bc8865b1ed8a1e2c189ee690fbf00bbd4db55237243bb88e607271567064578ba0c5f3c81da593a9d82ffb96530d7d2738bf434c699b4d5c58882742de407dfb4e408c63fddb07492dfb7a7e48aca45e6044d7487e76d184c7c7300fd78ad69058262b533d74f65f06511cfabad5ebfadb531143a2c227a68138e7f36429d90b2cee853f58b07d8a547be82b6170ab0357695ac01ff2b7c457f0aaf63b6b7180b7a41386cd3e8b463887d998ddca641792cd86c69a7f7facf6a9ab03b9f8d6c44fb0284b6717dd3328949b987b97e15313826d0406c0d0f4107e88c95391b18ce47b20973b19f6333f447e0a424fb2a356a01426fc380f5400e2bb49a74a841080e8f57202fbaf662d9506d78852feb219c43147d9e0088ab207def5aa40ab6e33473191d056f53e0b39ec4f6a053ce03ee4c969c9943ffbb590e9712d40f4676493ab0142a7bc678b8a5a378cd317d5da4bc86dfc3bdfb499ba05f63dd805b17a9cf8f3c5bbe598a7ea7e98b7aa175754e83023983063b65bb047782501facd6d97d519f578a980013546d2254cee1005974ff6e30701e45338561af10a248d64059a81c321abfd6255f18899f9c328df735c7428d5ad2d6d302d2dcef39c72da3992254cd68b36c07174ecc1a44d454c5b93d36cd59e44ddbfeb15c5dc5e762dd17a5f8496c9c734713a50899bb008a2be1171abb78e74df90eb7af3b19de827f629e1833bf9a5ada7106dcac7564daf11f68523584ea803408eb48a45c462b737704861d6e17528a83eaa6c382c9985d239c3d9ad336f3e10c364ee3846b3e648d5541abc47bc24a2f1661db4537ac156485d24963fece68cdd927364bccb5a2d795d4b2eb9f7e96912d0b92cf0c58ee4289d7fb7a94c300a5505b81ae19106de4d627ee07d94229f104131fa947104ecd09133e479eb5da64547b0b2b7b79c5e263a690c906425106b02f6d54124a1e243a17e582267a04ea85dae3dabfe89d20962ef1aa6cfa28bb73f488eedf406320c74990ba464ed988658d4405edb1efd63b1aa33c0ca52d8f56d08f42a5c3446a7f5495fc746d3435bffb1be2af998ae8d666ea26657b843e4fc9d18444446d54fcdc4577d33924cf12f3ead0d3ccbe65fe238500175dbf6626593d16aa4c230c49213703dbfd09cacc9fad9153345d22d8b93fd576ed9181395dad68d17fcd77a3411259152fb89e6bba99e205d5cf7cd0d1c4df7a79e60f89a6853af028707a078589ea12492eaad8458609d7e1d5b1879d4c97ed78b085d519db68c8cad8374fe40ded83eaca1165365365a3d1f5e7b149dde8538484ceac68ed130ba47aaad0fb5ad63d28a16aebee22985c633b742f4d9b667e8da6c908429e80be917a8065f97275a8f28376a6419e07efc68a517c2f7ce98ba2208a3f72ceda1dc2aa8476bc4b1e24846e0f113f539cbf10e9fdf1bd7e38fea0c195ef9327effc33d20b64eed7ffa887078a5902d4f01d550d9586aaceebf20abdc1d774692f3cb1f2783fe9ef7008f57dc5e0be0760cd5ca1217a5b186e7fcd8ad3ca93ded12bb05d6b5a317415cbc3a824edc68f1bed9694fa1e35502826a9e486824ad6c410811f4d37d96a960889cb1c08a31e6dbea8ddce9eb16c96aa31811f609521719f461f7a50ef0857f5502db2b8f5512d071f6c858640141babf75cf26354e6bce2e03563fe1416807b316a47fdaa125109c7f71db8cb87ab48632cf6ecebbce1944c7b9a518e1def3056c7ee03cb519ef123165035e76cb7f8495180d621af345e5f592746eba5b367588f4bc761093521b9cb5cfc14d0365590024aadeb8d1b1341153184c0ed4dff8646ff4dfa6ff0008af9dd99b354ac708a6ae9289766da4521df6b12476f6fa76dbe4216a5bf82d94f13a4ebc6d27f5b7f75d0124b0d182cbb156630b5ee1856eabed0537e6e2804d02ff2bbce666bbc7436a57c7e17bb391a330c8cc7ce7adb13d689e71349806e41ced208bba66b68557ac1869d4b063816b8cfa905c54edb6f2d895448431d0e4ae5bfcfe752ba122e16f549a87cb9e5638ff53eda04895bc9c78a043b8e16de41e6c42afefa2166b9197b885af200ecb84a3afc6a4018afa09f86317d19e2c246dbc6b9b18b1483e9de83c6551837567f92896f66ab0205deee110f00795d39c404ba8c1d5fdcb2f999baaa873d624a8ae885fb382727670d0a2f0db7405b5a71257c60e264d7ad59c74d8e4097d2ff282345735f0f242d14bafff38b45c7fe4afc297945947f694b51ba7e06238e7dab92e948157d958c2cf1f3ea4bb171b847a2dbfc16e76c104e09ea2518be2c793a151fc1d6e99c98b176913fd0d7d127c6281864c5f0c1ba24d95f8d0c639b47dc4fb8212a3247bca2bf812a9bdfad11fb2aa216bd6eecf8bafc4432c7ca37532d7991379e6a8d8aeb2706c3b08f05cb9574c2dfa5c4caa313459665203979334d86e184f7c60adb1af38ec2d5737c914d7c72c959d69139425a819076d1927c278ceb60fb877c7c4f403211c18ec05f406b7416d902f420ad451d686651b0140cf98a7d9da9b56f99d7af3be3388c64f38ad3987b77830fefd3fa0940c41fb3d6e3e79975bee863d9dcbaeb492f68aa92683a9b15ddf0dc4912d7fa75910548ea9b97bb5b5be8cd2fe0853ac03ba32591b0b01c5aff59df052affd00577acb83639a9b6f9d9ec78d3002686021f80f5d78eae4507f7a4446a1e6e5942056d54120c11c845737426b9d241123669079bb23d9ecdee1c3e55334b79eb15165fc731e58472ac14f5baf0081eb3b78e7445b255300df456f0ce17d5a6b3b1d0947799e7fe9d7059c7c965f408d1bbb2e9ee84553f8a1b4cc50a4151eb9f2376f789de851aa0565238696d11c6a404e0af4fac3c65d3bba8af68cc1ea62eb287c77c818f526fa5a2247dce98886668272735c135784d74d8ab3be8a07910ed657f649342b092741e7580c3de6da8231b27c061275b49504df9647a2b614cce3a9cb1edc909c0e46c86600ac62416d066c60a3c58c1220c20db5f52f20ffad4aed7848ec4aacc27b27b54c7d111d737f7edf2b289a75b4635aa811c757d90441022c63a67e3f52963edb50e73c47e582e752ee69d526342ce5bc2ce7a1ef6d87ef946be8206443c702af7e9ced893d90e8498ce9df00e4518ef36a2e8fa575c419a7616d104dc37cf3fd85f5609cbe5bc59ee88030cdec2634394b19d38c3cfbc75db4136d9804a57d648ddd84aecdd5848834c091bfd7845fa3c907b2536e9c8c9a7228e22e0347e518ee4abd1e67ccce57675aa861e817862c7cc3e782040961c9e4cbb9da10b70be5aaf1b493b33c8269b1d49e26cec4f9d1a2815aaecbf3eaef6e175932549136fcb30efbb9358ba577c24bff8d8737999f5df30713400b2abb5fafe9d6a82d816c446e6e62d4da5a24765bdb6a21139bf14be4f01a685d2eb195871dbc6da1deefcf413be63566cafb05f643e39600911cf6759c05ead1e3aae4c4fd46665cfe3aa065a8b194fd7fc9180f2ee3f27cdf87394e89bfc4de4e9585199b5bde457f9194e514d91d630bef68f8ccf98532a509637f269e333d567eb10440f5656d2ac17c016762021562a5949f50aa7f6e31b804c7100f8da015fbc587c99efdfe3e2b12d92f230db11472e2b2eb6d72d372c57336a2e3ba240797c0c2017e71ec2953ba9ca9e2ed76b9e5455d5324a553a1784029dbd0666b0db8fb37eaefb25473adb1c590c61392ceaa186a20a4a338a98b0117fa61cd68a90d46a11549391f7e053d3b5e9d19d671b941c4f74feb6100e6e020e7bd159dc829bab9fe7ffa219a83b35ef8cb5df1907bdd50d3cfc97d92d0d45c330201812e72b5d3e82f031693e2bf524f3741c224d1c9bc9c4b4117436da38f9a7256e208f28f1a86d0b7db82e2650e368bbabb3d99783ee92715b09df76466773f3ff969cfe1ebc071018b1f7b4b9fbc18cb78a2d31d632fc46cd304527c54f2ad87a154894ec03d4c65793bf9310d3db08ee76148c126b8d4638e1b889477aa08791f8286efb7d43a0050649af965fdb83434d4a1992ed40cab0217e3417b23fa49dfe9e5c0a98b800ef69b0d76eba3c9579ccbbb06a51545a93b2acd6e44c8c7a9c7c415dc292ce085b53bc848cf24849bd04d75f0bb73705ca05bafd418317cddc378fa133f4620aa454bd1e40f31db9a21d4d04f4d85285815b5608398a00676c51994c6d978109cf920cf5dd58a0ecfd1abadef33fb23f33165312fc87d8a68218a841aed30592056253c57c505743417f5434df29b2c44d39baafd2a084a2d7bf83c09f11d8c8eb1926465c5805079cd934d735f5f8e18a1607488b67eed726df86dd2dbf29c84e79be491e07bd9c3e87ea37c944e48ad6955d28bcea646a673a649ad6f194d19faf4e308a61d0aff4bebac9ee097574824ff02a9b63c7be60da94315da58b66453bc0c6b2a57b6b8e04004f031794a1e6798b1dc498544d37f042c9b1315bc20d26484534e965481d0a1e452bc02c5db89e893846a9cc0cbc389814e80857e7be15147d163fb6867bea1cda80d66db8ae7ce601d1c403f7651873df5f6feefda3fbfae7f5f7dfb57e604623889f2bd52efeb075a8cc3be4cf61f313a1469b414cff7587f21e537085d241e406a68c0f5c642ba08c5565ad677085ec929089409d38f9d39fa40f6ae6b20fc0ea850521c73b436938b37c300d9f99c86eb76c6cf06745bb80dc753cab2c45a0c1cc9604f991207991c9eaab87bc8df0ec6952205640098e924be87eac0f3bad980b05c71ee53fee0d01504dc0367fffcaa0fd53061fd7d0d4d8abb54d16f41f5cdfe6684c99a2df56141f0f40e6c2fe340445bebcd0d1291392f4ada22ed06b4f76032191eee5ef03fe374f394daebe6935442608ccbbe1ff97dd6812b7e9c015ef9c4b37d2b51aae45ce9de554e225d0187994227697edd4c0e8466d9efd8250b9564e660de9b6acac20dec479a28a953bbfeb05476744c97a28f60869cde5d35565c332db61ffddfe5a130229a91abf453766bf194d5aabe70df00ee2bf779a0ab307383ca6562eb7153120409ca95816b2c7b05ccda1a0db28dc2c74561dded66bb80997e8a7d0d834693600da0b25dccfe6a59321aaf76fbeecf946a914f238503f5706edd25dc0afd286823837dd5bcc62c9c5a66be2e246d4de88e1beff0d8e425c356e32c6eedfe1d4d2a4d23697199981008f5c8c513feee37dbf8115444eed2f84d67629f06cb4fac5b6990aeb610eb158c042de03e66b594673f2794d2e6cc362b2df247ce80e5fb902855ec68875e5f5a3ae0387023c720af31ce5373734c5a727be1833f8477d8a13768af91f1723bea4318a154d22f96b214395863ec24363f311b216058c569974e4766ca64a0b044dee73a85c34b48d10145e2b788fcd6ef9629b4484bcecdd8f30deb8a93f387b498b1c5c142fdd14c04f3ca31e9f47f56026c94c49829ff12c088015e2f34b9ea513f452f5b678703dfd7c1c7927825bdf6913080d406835e3ddd2b267197cb74ff546bd9ed116be20d17b91cde8d495ca70d803e1b267c30224d50cf63036c4638207caa4d2fd11a3528cd2c3da0a76db4118d48a127baae8b20ea0c0148cc413a0c029d31ee19e8de885453558f852930fd602423d4f90afea7168a9afbb704a3cc09feb037676ead38562282ae1de3d988940b4295f4bd12cc0feb55be9c08ea4880d8946e531a679afe4b77df1f8336e4a0d1f79769d7499798ddd27f765657c34606ac71a59504a2a24ce9a3e0b66afbad872c09b2c6b322d886cfabb20d83fdf947071f26d8c8b82b91affb47d2a1c79d68a44e930da08f6545662040901215620f9de4e1c4fe96e36311c27db83fd67576aa5ef68f1bb714c7c7af5c066de20af24ddc87caee40c390588fa3255ee58e6f268ac76cd277e3dd9ed1702a5afd4b508e7527f5de74218f3e59f8690e170281a69fe942a0ea7d629540ea8f8911ba05b517dd06b54ee2e8e83102742668715fc6b2b6a617d813ede9594150a90d8a39d972af652992ea4058137eab3d5f3b278ee4c044c7d6c7cd5d60205e5b6bc4977eb641dbb5ae33881d4f153b70505f0872616782874ea83f87a496cd29c120489402a1e00f01882b58ea3ae15f1d06c9c862412f2a06f883f37de47f40f437c9826c81ecb77517afa006498407a320841b6c90663b6921e24657ca406b32d5474508c72e661b6fd42005faae7d321ba79c081490a3533f58ffa4463663be0fb62f3e56d86e97007bd6a4c30858d725107a7a3cff60aedb967b23df48ddc83dd12f075fa4962fb8f3d47353f68379cf36222da77a32a03599719bf193b28ac606d58d8cea1deab2fb59917f576e3e701e534bb794cadcd2e8b02872797cdd7ee6e12258494bf0c06e749973a1d41ba0f7da4b40881ff0f2c45b5d5e3d5f58b2165b6e6148a6ce9fadd54a9901a0f507dbb7748ecc0a5153a2dc49a64a4fe3fba270972d22493ba382a78daea5fe6a09dd9704084bfd0bdce3d3ddc49ee018edd368c55096a3e74fc254258a2b33a93b98b7e59eefe61a1f60113b5cd109b200ee22fe2ad818cc37d1c4f4368a0e06deed37f89df3fd149fe045334c6d5b543e680a862d54958f274fc0535c1151122fbb179863da09b8f6a8c894116d9c856f9863de27fc03b2c25e05aae37df11e0f48d402f656d20ba52a67a8f0be798fbc18be3fca459b8e413297ca546a953c6ac32235807861a075fd733ef520e040e20085da89c4e96b855455312899c6717d68e90e1b83507b7b6cb5da5b969e1957c76cf11c4c48cf6129466aca81d00f1d16ffb1f1a185d93e1c3572caa06ea0f90ca7d5725141a74cc31413f317206c048a94439b5a08d005c2f7af792e03088c5fe91e0cf44756ce3820740db3043cb4deacbc4c0c7755312d9203603eac3f6570dc8be9596eda743d1b0c87f9c422349af816d66e6371562d0d6ec57c14ccfc247c5317e459b0af6540ff2cd4cbe6c2f78fd02c834ed2820faed0753fd86a392fc5c6957bbf031b2af4c85e7f00ab635c6051140d06310c5e0cffd91ec3ecf3664fffaf09871bc2e99a8eceafda2008ce3366d591df9edee3de245aa43648ff83ab10b232d4926e2e023716531a1c472295affd9bd00a6bea6ebd6e9431ec6176f4d8b6b53c60680aeed6a2c104e61ac27f52c560f05fd864c051c2ea2e81a27439765fee44c296e27ced8732d45bc613c10d59b6d1537d33f9064963a9083255ffe361c271f2ce623c8c227cfa7f6b3ea0e215a12b8f6318671caa3562373418a6cd071314752c8a089816fdedb0b3cb0df95f8e7f267a77f5d1eeb00e8086ad5de56bf825c3b90d2c4413f77881cb43ad45cc1c5d976f3259a01bc93c44dcdf45f690840b8a1734126d41bdb109bd9451f30ea08a13adf92c469b1d24e62ed7552ca5acd822d2eaaecad923207960668198488cfa120fc93d6cad47016b072c2b71a5f2856bfbfb72908241883e31465b50bd44f441f91ad20d859ccefb091d80c091a4fade671adf13b70374e8d7cbbf2ee288965f877cb5b70fb962867fcb346cbefff9796c8a37e3a00342b8e317a463fd3021542df61a78eeb167c61ab2651c28b99f19ef46eb4ef16ac3e63ade4a2393d0476a8c310bd455f099d6730924282e8f555a2021cff10c3084c02c2219eb857e4178b57411a8a611cdd598319b0d66d027f9d6a415dd9a4f1edb2f4b43fe0cbe894ff2ebd952141cd5259bc5de22a74ec85c0b210ee0b452c3c89a831b58701d4d1b8f04aed85ede32ea63e870193f5ee5ab166472bb6c08521087ab039653a090f2527f77fff05820f42d95cef55f99cb7b3292a24e20a40bff1dc97877f5a2014ecedb6c1bc209e84a7559d22e8a3d29dea70819824984e233673e4032ad273fa27885f351e77cc7494c7f0ecac5c0e09e5e8126e844b3e714715e7c99d9d19103726005d85693004ec91dfc85d02bc6a478b460d87f4e3a683a96de84f02c3a9236a25a905918086db8e5a6e74a9017f30f1886d2a012695239a48aad886c3d3ddd5d1330e5891ea937428f2bbdb5ff804136622eb806d01b39898ae85ee60543af51fd973712d64a32205a884fd2871cc22e375d04220c70575cceb2bf1c387da6baf2d7312092c66f5232b574c0e9a2b2d7c20dbdd4dbe1ef19e9e2efcd8bd3fb7b2c64e6fd831a4696c0379adbc843f061f5f8baafc547e2adad75bf8f4b8ec921075b10525dad94bf87757eb1f555e4408f80d326ba7536ba9545b378b5ba8558bc712b06424a633e929de2a74f3dc646841f2f5f627e74f643f6cafb1b757be3b4e8c635283294240ac9774fb311405119a2247345faf7ee5719e01e4756177e68079317f8d512d7aee79c3c29a1399cfd1cd3b9adb7e6d2a4fd4a260b34e8f29deab346245f38ff110fe992fbbd868df9725afef2fcc3df14c80a2c2b37ac5820fcfa9f067c78c9dfdc8553851ca1cd37d551b50314557841242d0700896624924ae15f944451cf4c2889c6709821825ca89a15692a00547e62a849160141725fa0036d1d85c09f86290c4c9d9fc61a5885c5c81d5db149e8ef5a026dd063c2e6b89e6cda4bf2084e80e027a9018c95b89bf6062cbbd9e7e25a77cf236a1ba028c26fec07275767123e594089f943694a1c52691014c8b42624065376924b86557539eefdb1151b0c3cbe5f324f5dfdfd9d320caff0858f25f5addafb3bdeb39d5711051e7f5d7174efed1649fd0ce9eccec1dff87ac2b326c5aada84b8361c82b1f49a7e2284c347ffb37a49f8da97e74a45f840fb853a8f6590fa700ecf39b7808beead91a06cf9aa3dfeeff8480750e73553fc9f771ab23d33416c8760b1c74cf6023c909d9b7266461f83ce2fad6c9809bd415782d08144944ba58f9e2951f9426f06426ff61face7d064eb6dd9ae4e1455fd1928fcfab885ff26110ff844395f4c3da19f0b14f014851c4ac4deb6e02e2ca680816fe50ea7da946ddc8c7d74eb63c22569deff345ebecb6383cffc83b9564bbe29794d9baa1bd6cccfe1434222f5a882d34b7f973c9d26109e01cb51f454622d56241c5899abc3f48a0d8640aa88c672fce7d26addafb95c9b59ed59a04b3b78ea34e59bab84a993d63128bcd67372d847bf7991929e0cf71c8cbed2fbbedf04b300425aafdfaf0cc689709fa730ece12555f60b0aa99c83a0d468f0da8ae1b2409d774c27462e1ae6b99ed540440647f71048eb031dd85e427d6ade26effc9e98cfa8648feb2ad209e07179df16453c23d2fcd33721da95c18fa4d6d4736f5b1919f88ed0f9eabe5ea3b41314b9771961441c6f9827d76367868caf5d1b8a809f344340516179bda2b1ffb590eca379d4f429c79e57095b936f16a6180a489c846a86e89675895dfa15686201e87f4f3c0cbd5ee1b0c648933dbb7069389320e207f7ed22c9c4e24c5b93bb5e638c645aa80e8a5bca904d1b97106957c041f41963d8173bddb33e207650c19f97ecb4f46040217bb1be626cb278e0370010f1c016bf282ff61c946220b5ac1608922350edd3077e4a673f37cde1844c66d34ea511d3e29c77dcd4cb8479afb915e015b1da05ffc39d761a82237cb4af4e2359c35db0aa7a5cc3491baf25e7f0c5ba8138f9b80afae845ef2f63c1c663f32f91c05c6b21bf2612558fecfb0a7e2495ff4183b61edc8421f264206fac9752459ceda7a5819b7bd58b866c11b0fcede66ebaa44c25676ea88dce8eb3e9e469c277be208ba9d43b88e435287accc584d80e187471f7b1e3c81003ad0891a2d0c99f1e1a76144b4db29632e7e7ebf908a697d3220c3a7d34827f381d7ccf82c5baa64434e37373c52403237e05a405cc75ddd89127ea43effee99825d2e771537f883194371cd0efca259a8194b16854e4f488adcf68986ba2c6b519cf124e95f7222c69ef85ceed205414faa267e908b76f40167741272b6ea3afe071e105f1de62710966b5209b59b44bfa8e0852ec91f1abb35fd9953afd9614facb2f9303301fbe0a5f2b676c035d2246c84fee3c090b3aa7ab1432a3e48c71f8dd573a03902d04425aca9f6a36bc26eff36023fcecffa6a0b7079524857a0b7d636e22550d9786ecec69652ad8f9a203b58e90c3d8cca239c3761b0d983b4c9391becf65619618e7bcb631a4721ba5d7f539fb47d0fe15f6b18b2a67ac90b143d2478515659697144be989c2888e85a8dc82cd17fa7d185d0644e0b0f9a70e7993087cc3b6303954a6e36ff9eb2ee5a61656b3477f2850759f45cfe13f50171c9e56f49e24a74851474a66ad10d169077706278db72daf1b73b9797f0bbf1baa5fe4477262bfdfd401e7265b76653e2d4781d947f8cb835f2947ee3ddc3a5d65bc7959534624e3fe2ef2f1ab43d6553863668c391a3a6f359b6cf7725eae3cb6ac5b6fb69c58b6378044025b7daa3f720ce42e7fd2417e8056e600ed2ca937ac27ab521bdf67b11d3c14f5c6e02a38740224891fdebc17d9cecae0a8815c4f0c6b9454c63786d610125e6a30756e9e8c077d6851c14ed5cf8040b622951486067ce06e99f3fc947ecc20d6f71a675eabdd418c51e2bb8635b41ca976fa9dee546b114e46258b093eb36ec94d625ab0e26e4d1d36af32bc505dd257523ceddc14581b3ed6661bb610518b01df5418af7a67db3e170b2723e5c27cb3dae5723c47af34951d9ae46e937da377953a5cdcb8c1fb6d0ef8b0aca20200ee6a20ab33305ee5bc41b0bdff3d772c2ee283e60f5b2e0ed5212279f66c9870dc570d30f7b56c26b2ed337508883b2114a2470f85391e585c8391a70b13b7d0ec90b9fcd5a38cc59869bb126fd006c8d9b86b60adb862afc39dd25c0c169f5037bfc28fc3f5369017432e65b24220cb10d2a23bfecc04638e5e2394281b00cf4c352f385a6898d29257eded19f52a5c8d6b97c94fe049550f5803a4e1f4ba2f493e306496ee268f0326ac9b0169a4823f56f89655c1386057afbbc66dbf2f5c9f500f2edef8f975d3af32a3a324be21c59b5f1c2b2ee93bad8a04785c4e08f399b8558d192b688ec9d4c59e7257a934564765222c0ae04ee5231f8aa09c54a2e27b01d5e1ef8b963ec71b59916ac7e1b0c97823bcfb95be0ade916ed961935db2b81bc6957ec394a9c6c0f0bf11e7eaf9e37ea320b34c426717d90fa0164b7ded37f3fe508c09824b25fc54982d47356360eedd6a19f24d23b6447e0ca6e086ce5efb132c004e4b1e30785570920abac3f225c706b5db335acd80267a24e04ec3a45450375a39ee0fa7bc767872431706862044a13a34668bb122ff7af0b650793917b80258f5212a1ab2f36a886a46efac3b352e8320c76a66c514ab6a9b68d19946a067b7c2ee23c3b7a40454c0fa7f3ad375d96f6eab9e988160a27ef79e2cf2aecc86aff3ab06e266b13390ca6db268a296a42011d65484fcd3f6694c97c45cd74e4ef536c7b2c71eb3449d38f55098061c1b70edd61fb9843755953d4979b4c2c366aab7d60439d259509310526d2b06b0e6a0b5f33c0172ef3ba3cdc76a1705ce26fe8bd4f2fd9817553cbad8ab4f1bd81ab456f32d853a3bb6baa594f0c247b6ac3e1966f12322d452362ab4d71c1ffc12b15160dba22b0bfc0c879ef5f4e760761ff7f6444b525070bf53e2e5e0b10ca8ac75ad938268945ed4427cb83b052e35db77256e63ab7742f87eaffb6d8fae081bd668652e0929aa3727186ef1d6c2c385198fadabd5c1d88b926ce79f4204bcf9e4999c95502b1d83ddc46cbd8cb8f3505532888481b7d3d517a35da4d2d8ba4f98a6169f7a2049b04bfafa560e5efe0f0ed4c3832118ee2e006791d97a2a8394ef7852be7b1412e58d44a5c90168d650bd4f410cc507a73515f7457ca1652f4eea97b1cc7ffebcbc411939bd7c15500667fa5c599425260a7370fd769239979131afd6dbb29987238ac16bd83b8af5680970f1ea9f24612078c1af799676e57d53eb9cdefa3b20793c22a44a8fd03b4241bf2b738c58907ee13b5ff7ba0e6c443eb9d0500c292ede138ab47d9e1bfef5622d8abb4db2af720615c52166f024b16a8135395a2fe7264f7ea80520490ade646ca4ff1ca8694740c19ff9dbb3dc79707865e1b048bad45edae4b2a6be88c1752dc361670a35d16e883080d0ec16674e0dc967a4c8cc0afa78f5742d9f9bdae85c54dad13575534575c35c81108947a2dee90bcabbeb7c1218189eef3cf416c99eb7d2f6bc2161037ac77199c5998ac0cceff93fc2e5b7c186fed386367b216799b2f0336298ad695a67945f6ff2992b67ad020dfdf7aa4a4e916339854327ea3fe32a7db1a31dee3b53724c958cceb34738012aeff0ec33c468133945fec8d3eb9ca52ed190e83f4a352e330a73f44c07997da18cae94e7eb545df62d9e498b8464946e5e51cd27e17e6d47a0dc027d5193c9c20f20d2a37455918a4f02daf0711bedce87157e2c5008559311b480bd4c8c15acbbed81c1b8a4ad15cb75bfd35bc8706ff917ac19f486f55a2be27983c855c1832810d992bddd2b5c849666dbba463e6300b16a91222896c666586d15cd74e293aebd57d16b234ead0ecec428ea0b9894300b7c0f551925050c438b111c9030430dc0198a202f824c7c2cab589ea195503bc1be38b87bc7147d536fa0cf2db2bdc616306757e43521c6db2c0a7c49dc30a89fb995399de0a1d886ac9f208d9814930b5a3ebe84972940179ca280c5011215c380a7c5808cb31998046671d109d6a2cffcb9a9fd967b6de4b761b02052a9909ee50f02b3dc6d0493410a57f3c5dcdcb7a93a91bc89cfaa142648f1d808b4209d2cfb8a83409f57703480bff59b4ec908c68e9a73e92b98642e511645c44f3dc43c5ba832b330a4b34aae8c3d43d9f22c21e7d2bcf4b75ccde7fb99b6c4aa17093692b8b31d39564215060408647d2d7df86a8188321864f1d55ae425f49d5f408ba35af7aadb6a67df180634102a5cf83a45d53c3bf68f5fd025150aba815c02e56fc67333a8f78152352b3372e2a36587f3a935bdcb1d4722667bb3220c2289ae44f0a4555af85397c74e86282f2861caab28ec9a3d024562080a78f57c2bc423bf9c1d71b0c64b3501287817193585b4afd25d1785c1801869485f9aaa67fc5b148a71ae3cc0885e6a53d6499296cd3ff7a81f5392db7cd57374c16f8b01c0cc1a77dfd8fbec13dfcdb4b621f23e4753dc6c5f146aadc6eb3b8f53ae04a1fc5ce9c3ccd09c0c90e1897ddd5d95af8623e1bbcdf19dffcd5811eaea8965a10501032662deafd16ae722ba9f6824190d344a1b187c377f69ddfef872ebcd8bccabd8f1ae0d19a2e719876e0e4b7f9ba38d706a9c1f88fbf1b578e93235a7c8d494f9c6598f0a336b49a3df56d7d2cf08576c5c08431aea7d3c3a45a2a095269f8349a4275d24e29de93a9692e9afe363c8401914920265df0dd8d0b2b01d1871868bd44aa7ec9b5b7ebaf360503906eb59413c9914f5a986d91cdea3f0f8cf7b2e1a4b07ef36f6876cfe06a19f7885ce07132f9e98ca6d5520cc4f2cc310081e9f1e3050d87e446cef181ec3bb40adfaa107c99a0a171bb60ea87ed95a0d9797d30a7b09cb1c98ae6473ae5c9fab7d8655c72dd95f964659cbe06d435cf4135dd9986a6ceb99a8b5ff8564ab83fa2b728ccf27b36b9403a948fdf5b1d514ee13b4fbdd2dec08bdbc77ce31a9f392ac859ccb92e761728f8643416673a10f53dda5beab6b0855d07a6a22df4a69f62d869e130cb7d528660d490fe043d40905318d528980e48de1f4f0a8a8a012dca1c22642557edd38950278b6ed0f911dfe718dd3c7b5509ac5c22a1a8d2b5bb74bab57b515d771bc3540d6ba7f29611bf18cb33adf1c56cb834c07295d059f558c34395c446782ef7b71f975ad8b110fd700a8e469aea84c387c03d1c6935908bcfc70f2d4e800e559225c3ca1ae1964ec8a02339754d357842b6a9644afa5e4772a6b9df34ccb073cec71e58778bd62307f5094d90015fc91713f691613cba05b7239de22adc49709128599db034843fb113956f2b3c2d1ea95e091c458e99397c25f32bc723e81d875f8d25cf46b77d48f0a6a6d4ca52d5a7e11b13dfb6169f03858d2859b164d00c7fa9dfd1d6135ffffadfdf705a5d3a14b858e5c87dbe81fd473ca1216b40499dcd79fad4ca02a162de6f8bc224c0f692c3a31d2e0a6717eb36aa6b0cffc32359725cc46a95c3928072eb4790b73ad16d61726f7f6b04d0ff4de440f9c8c4b4736285ac2aa73974cf29d39d9ca7757770a288213160b6a189f1ab4ac103cc639b73e16fe0efed362ee71fdf618536c32dec24718ed5a4bf6b12904d14579eab9f78bf4013d86bc7c837c3f63e48b4d0679a09a4a2c08012e43f59d9d8f189cc46d96b1a1df5f5ecbc83497fdea6dfcb398b0666e4f07b3100c6444001b1c565c0dcc54e9dff7ef2c4476edf2dc82d4069d29384fa2063cc588787617ad56ccac7b18fed76fabf5f9a9cd5b9f6b6429792390a2b1f3d094dfbdff6d69ea383bfae12a76f21f1aa231957c7364158cdaf7583a1f431abf67fbd450b4ee70aae304443f3782993c60d5dc1ac5b6b58de7a6600636885e3d434bdaf5b0a4e42714874bfa964ca51594bcb91e6af00feb82aaae054a38b2d586fca685a9b5ba2691715156222559ead521c50cbb82597345b9d0e78aff4b4ec89d350beb8e1029524b1615dcdbc54828b212909d684ef2ce84aef807b2af195cda3e6be6379769531b29ccd21188621a4c4b80871ea31361a081abdaf9f9fc4eb3c5905b99b789fca2c40afaf3b30879f41deb4e4e0a1d86059a4a5b000efbacbbec5507eadcff4b1df320bebe757aacce9d7afac337eac97c423c7dcd7ae15a841fb7b3bf0db9bb802752651f14fac4dde7ef9caa8c81ba14ffb825b4f53bde8ac6eaaa7aaded55b32cb3763fc31a84427c6596741ba7794a047dd1932db9fb2713e3bfbc115d2111b5fbc5de68bff308154ed26a3d4b46ea90d328ebeca1006554d47bd6b5bb5d084b8b92a44fc2cefaebbd41b3b2e171fc5e0bd771d8bc0d2565aaa31a40d522f5128e56b82fc123fcd1098d60aa09b345d28bdd755d02f501d3822c00be685f4e3163983711a0e17ee06dd00afefb629e57ea48b98113aecaf0d3aa795ecfd373c16b98e34f6156761e991ff2315fbb832db3af91e59de2f35e621ccc12758c04fbf80d132cda97c63a595531fe102f3bfeb14869b6018fbfe8bc5ae5b4dfe60ca0d884f6e6b49edbb2efa6187d5fe63e5ca7afd375913d7c27a4b52dd79c476b789a052e2230128460b7da6eda8c5e86ff0643500f0f658f1a879fca15ca2a83aa72f4ffabcc2551c6b6083ef28a687fe4afc578595553204d63a6095792596d2e49b43f120f2edba9ad7503d667779ae3b31d62b099c1a261b8cfa2569d43d5e8b467833e41b79f4495642b9d4b60713781db1504a1caad4fc222c628aeaaa32a0791cd249cb0b4e5fd4cea058c7793985929bed41e57c91a5d10940dfa5eb585c44f72a9721bfccb563e689ae21cdd2228b5495548e386f7cd7027448fd68cd80d256d00b2ada36c01b79f467db26258c629868b825e17436aa23265fd99c647e4129e37691db27e93f6027dbfeb39f02fcedb169cc2cfc27112083b055309b7c488f03ed343770b2cd7638c28c1c64932cb71a1d539941931644f8fe2bb5021f861f5952abad6bf1b23830b7645c0bd33d14628374168d05f19245ebb85bc0d0546679928f2ff73bd69a49a7b3956e05123c8e37eb22e58bb23ebb006c7705eddf295cb347b4a96e8cf58356d721329f0eba5296456cd6ca51e6360529503467b5017d44cea550affaec9526c2bd15bc74dfc4cf5e0c4b2d6965b27beaab4322cc20bf224a842099be5289ac58953544365c491d67e22fc19e5176df6bd54a826ef78b1f601e83466074c8d4939d216e09b533cb4305db0c64d7b51cc65c03b5493b025aa140e76ed231b6e19f3d1a0d3018006f25267321ebe896c229e586fa9ea237b2674dc05ce1bab5ccb5570bd89da74c042d9ef940a071639b17e915d337d650beb342c8985a31411f4e37a7673e4f85994c7694ab636797c0465dd3e043cce64ccaa2c0e499f10bb8356c9fb9e93ada2d311556470ef9bc2d86e8b63696ab55d4369187ec2d84aaa56f5f92a1d571046593ce46a75263c2ee7f4cde868860d7d745dcbebadb4af4a7b72dabf9026984b973938c93226447453d716b69a535d4810181cf98f740c3980158e21b662f4010982ab11feda30fc4be6ea6f442e7cf53989df159c3a6d842522ba6f3307d5f84ff2a310753230fa33a2f5395aa15a000690d58b52161ad4f78142b0bb7b7b49fb9ecb2d01e69f566d612af1a42ce9c9254ebdf0834b6d72d5b0f825c0f8ce68c73061eb3d0349e7b5510c02f74887825ec0846a04ee5cfc25ed33b834f67bca76e21bd1a04f91970d75a215d266201c3831c16f3911f39c4c6c43b3115b68ee6c743a1f03943b94f37979438cfbc29aa52514a1d87d0e15c1cb6c24bfdd266402da62174c70ad6dd3f23c861d40243ca3a6d3f79395f4fe2576064e190079357d6ccd4425529cbcae6eff0ca2761db8a6f4a2e77c1f1d5215ac02cda5dbfbfb7ca1e6665972e4a93daf0c0fbc919fe2cbf790a9f0867e6b5498d7aff7ebb461d37996c32ae2eed28f16bf6cfdfd4c26dc08bc9a2e9e0fa5095959d6260139fdbcac86797fefda9acf1295861c851002bd816b01c165a85aa84d2b49b4004e71c5c87ea6076e48b1d1c65f9e510b2e39ca70a12a36605b7a11ae91efe8d1cc63e654284b27cc67f16b43e79e462283872c5f0d462f355b4efc91cd1aa93ee555975de99c915de5c375c79157237d1dc8bb7af86c71aa5d1838a43455a6d1eaf709154e93cffec464a53d622163e74e25f8bcb2b82eff9c97ac74ce522ff0c00ce35f62265ae32fdac62c73ef15681b63a39fbbb5003718965b0f58708c7e3a2240f144bb0cfef4961bfebe11726cfecd823dcd447537043e0b28d0c8a4527e371b18376f73afdbabd48b42d461a2cbdc5273880fffb2c36e67f8985835fc3262b3a985a805e38d16827318bc4bb4bf828e7b96dfe39cdf32fd2fa12893520e24f2642770734519baf573ecf23a784b9cb5d297404beee39a7261dd6a736e3ef0f417d2e7165c9dbb15ab9122d10bfa84c4eae7ea8a4ba844546adf88c8b1e40eeef92238836f581c3cedc0d7279276e4ca0b6d1a748d891ed58426462a8e25468a4b899cc0b2caf6203666f56d5a391b11cc6a467abf74e18659e03385514acf81cd9009f8ae946e9a0e6e39526ea5d0b8f16fc7f4aa264c7b6c307381f945f6e668669744cca860f3c1fe306ce298072e89dd35e422245531518948f7ec5f52646b2651550fa77f3eead42d5222a31f7dc976b8a23a8c5bee0b270f16d484a81a1494cec9b1d5755608bc704c354cc734c4f04d5f60b44a4e95cccc2853690b8dee96029e07507efdc6ebafcd5c6d43bc4bd1419dc7732172610be625f409bda40aad970befd3745f7483941713c7fcc74e3a5edc108cbced8e6d05292cb6fa2f060b95f40f4968ca316179f6522109c7fe3896270919c053927ba5f1ab5bf629454e5af92d7ca1810cbcefe864383f309e58266087e8fb4629134ffa412c2f14d878c2ec583c9edba87bd66a871158b332c749fab23bba175f7cb7f7e8d2a5b2fbc7f45031a3240a5353f92424244ef03684dc6c5b773a96ee7b63f99707f808515f1f4440907949fc680b542a3b268f0cfdc0077d609fc42b8eeceded8c53b34e2f0c81d80c609c14cb13c5e6ea285c16666832ffd726618f58bf32bdda3b0a7c69fa91e8b76b4ac0eea74120c7c3015e32530e7896528a300b8765b871fa78bb512505981f8d14986b100f5bdd7ac6e9ff30a3198661a86c0cc334f1f5aa358be05ba2542d2e42304e4595cde3156f5b3eb3ea1cc8771c2f8fece148f7b49a9a1b799f52826c7b41d48adb62698312581945ca05260244af941abc03db934a748de1012d10cb30231469e091b2aeb2aeccb622ebcec1f8b11735267e7f087937c6d3e4d6184423e122b94f8b57b8e7901aebdf47eb7374bf299b06503f67baca0e3771195c41a2d2334c471ced9e4eedd71b3bc653f12cb6c95bacfc49e142775a0f6276a34594d0962d8e2b687a00f29527bd11c67b502f60058881965d48adc5a94891276e4fd367be201b48330a753f32a4b5f9a3f0d03c194e815440113dd4f24c44f82fe03a67f4d23e39ecda16bd0734081fc7b9df93e4121e23718c8db69798b2c57e1def1a22246e152c867448a52e5b2983ac1cb159c289bb5c30a8bd472d8272569562739a829e50692d370c33f7f2309413ee575133988cac6d86fcd464b766dea40811eab84c9e8956fd59258d4eb467a910d2af3029d8bdaba3b5023a2851954ccdcd4212981760bd98f0c2de1dde3fe285055f10f6d163c8b254190f3feda87a46da8c13b38d90d38113e17422be6fb4666b78a533dc7a0c39157d0ae7f09749145c52f79f3eebac2fb6fd6fb2246107f6e995600c5949843b9ed4a89b806e806aaca93de5440ed01bd5405b79a9b528994eea1dde0446e4010740ec649240e87791a2c03774d5358a9de6bd0e11d77c57c97f6034fb0a2bb5ab816a7e33ae0ee325755469d335566420d64506c19bbeb82892c0b6fab043a2a48a024e60dc5c5f865ba679987a7221caa99dc6f52904f358a555fd9876492dc979f82c0e8d2701a222634645bcd5f67daf8ab0a77ebffb83060d812d0f2e1a9e686124af864201770c989d597bc48542f502d03817bc39365bd71b8247fd788020d7165198ee1727fed70aa646d84972d786103de016af824c5772ca66724003b83497ffd42d3399c73188b4250e932cddca7576f2728a27f0c52465dde975d0b1b2314cf429e82d1ab069f92d0e92362b332403101885f7eccd049b1250eaf95d8d11affb8104591e9358bc66d9e78cb37a01dac04f199ecee939c839b093a8a91181d1fcb2b0a4c72e7d181c595592fbfd32e3eac576eadeb7a52f54c7761c74aaee0f6982b35e27adc3fb42a40a92a15425c9e1b6e28ae8a6f589a90beaaaf1de974c68de11ecfc87b2b7ea94f0ed715fe2680b52e460ceb77da76b246d5432adbd16e6d54e2c168e75cfa4540e1517b51c858a9cf4e4cc399f5ab6e63cab11ede06b8c5bca61c65dac3bf2fc12e37971b8e4ace9e4da8f4a4dce84b0fc863d923ead6df43110c30417bc3581a14dbdb5f58492fda0f336b0d8905e6273668cc141bb8c4f90313d1d66f81ace01cb67d62f3c493d1aacf52bc52f96ece8883db86269316967fb57d8acc952d91f9de4a4c51381732e9fed4324d74ac3adbc7306df88773c0a791b6833f3a33882860677100589c259ecacfcb322832cf7eae2c3b8dcd4e770abd3d86119fb7eae34b2f88456e01f2bb71a230344705ec80536d0950ea5928435c95b5a36cae788d07b9d879a9e8c4da594158072681fbbd7e5030dfea4866282b9201706e6196fc9142076a0d413e02af1b61bf6aa084b499cf0fe9a8352c5e0054f5e4f7a25accabe8132a7ca510dfdc4336a399fc580af4406b4501c49d465827a480f6698c0ee02527ddded3799a1730ec91be8d5b6dc2b7705366eb9e81205606cd1e31d2aa9befebfbc5f6769a4c609516e6a7c4054d716eaa3f3640e87db7e190f4552b237779f5723b02bae9a624ea2c53e69b5f03fee5ab15cfd5a4753b423f712b0150195aad9b2c64805a47c9c54a157a9e879fe633f517bfb0ef854813fbaa40a2cddda2611d976a338913683b07e9ce809460d4630e5cb644577359ba2e7b8ec88f59c0297bfcd8f33017a06aee4659066df457fca9f360b94debe3b12e9fc20d27db33178ca2be58670261fbc4c31c4a53a7b261ea7ab8e7c4c40b9b974c4aee4ce75a9e3da03ae4f2643d4e71829d3fb550a8d9a7c5e179a8c14f8a2d7e560c5837d1cc1261db834b5874cc37925dba88a0e68b3b5943f1acf32ea386038a788fc1eec0c9a618b726e68aee554bb69226b97dbf50d49844822dc94a614c04b6181dc8fb3038c3ff0ac6b108c1c719b8fd9205dd0eda3590c0d9075e04ec473f38831303f00c71ee139ffe6b227ece7d54062efe9fca07f6a6ee162b576e1fb13ad8044252e09bfdc6cdb6e4fdb537d4f9adf78939bcac33c76c135d6ff8d0bcadf0d04a43f7ac6b9f829276243e9c205be1a5d5e10c60b8fc8a38827b8419d23120bb52b659e7179540cadce7604b06b5c7af663c2c46a73f6b92e92f813f10c1c9edda1c7c950a66eaf4990e52f77ad9cb8c1c7e1d22ce536585ec7935242832d65146d3c523bd20beff86c71e57f72eba30744babaceca8f8b75426e87d28076012eff0faace60d02a2c1d9842ae8f766875b91f88fadad3a8c6ce27adff75647d9261a4d2ac8d3c51a1d097cc02d1233a921cb089c534c173f02f80dfa1619a8da8c519a576154284766c6d64d690db22e41c96c047cb98a618fbde3a11e2015669e0acd04b7bba0c3bd759de67ae292dcbeec741f2cea117c4fe499e0cffbbc168c61e6e6549f9086b5408c610394fdbed1a84949b600f475c6156db891ea8e15e55f444e3d3c6614720f38750654409eb49ff05358a4d1f9dd67235acb23d36dd006cbeeda7be860e1f5fd26e47c2acafcc2e99358d94b09615c1e5186c86bba45c555e6dbab603f9a23e27d53ff534f3316a8da0bf72ef89078a6ebbdd8efbcee43814ae461258f618874854c0d88fbe405a26e3c71919b3670f8ebd0a76ee1bca7688cc37a114c80abf54a4ea55d66c6a3a41afa78742960936b96ee0b05869ff64a783573bea3a6cae3e70c0a3ba093619b0589119fe2e1d8df2734dd780d1c5080b56e8f120ea9f8744b80f96a1472b0fb1111003afca4fffd8ce8de92cbe7cfea06fa2ce5ceabfb3f7b1daec15fa62b2c8f83cfcff4ef773a81bd2520fcec6043e7471fbe206da6ad67d879faf87cccaa9d6ca482d307448afb158deb7532354b395eee3f30734012df47aee98c9c3326181eaf0cba460190a942a461867cfe388d1ff114001eff76a869fdbe1db09cf55ed60a7160dbbc5dcfacee78496c66eaca2795517c52e97677ceacefaf53790920aea770fa218bbb963bcfed42f6588124c363896d10643dfc897154b36e5e99060249fd720da15011e9b1b8912743a20ce422c09c39f9b61715a308c8428c0ead44801b2e9a0bd79b1e20464753e27d2fc0ba2ab6bea0d67e4e19087687d29d2a64cb84f00f4a8fd1cd5f60ab999327cffe11b7ed59d15ac7eacd3726acfc6bee6518b67d20bc77daed3e10f1b66ffbc4a7f651fa273f9c8bbb387684fb9bb886167161486dd060f4feed14050fd32cdf03cc564baf427c290c08aa5afd109a68ab16d7ae356924c271f958765264b298caeb02091cfaf14f79d86764c65fccf56eb5ce1eaf4abe7c3ff54c71c2736e7ea47f0613c6ff29bf6df2a3a5fb5433a71b825330a4fb1ac5995c5136f00cd515d958cc0c911b149be0bc97a71b26ed39d67be542a08e0e85f67d33fb917e4938b42c87f047d4396e69ca64536b1609263298896f9d166cfabe94f41c420e8ee6aeb42f35147657cef8e41bdfec58d27bac49aa88186c8b3d5bf177ffb798d7ee8277c3c7ac2f7288844323b6403b17849437183ef2af3fa73280a7aaf4293d4e7370abccb95d639ace037075efde54c1a86064f8714001bdb61337e23a335d6bfcba96228a2e0992ef4bd28840e988fdf64f91db6f7d2db47cbfa99289123bb09feda5272ee4bfdbb02bb97504f8386e1d8fc730c502ba61c90949498734f8731f77e230f46165d6886e4038f8e7eee7b8d6c65ae5d6a0311cb89ded1a7330dc22e6c4d345a600f5f6d3b5e70d8e2d4186a879dc99c6d55973d4eb4da73aacdc2c7ce3376fd51e3b35a4e2cbf230dc91b0cff640ded69bee8f6c1390a5df2859657d239a3349dc0c060e0abe323a09ddd46fd8b0e775f4b56165128780f33c776e03b4c3a308e59b0b2f340bb5c29e065a983befe689af6a077ab777ecf7584027a1ef77ce3c6312035aaf1d64dabcbcdedce6c44039a6fe8b556b12953e158fc9936ee910574f69a4059fe7eb785fc94943200f4562c085414c5515e67e22efe800d2dd87aa814a6384b5582dc2b042efc6e1047c48cbe768720fcb85b18bf165278fb5d3629c17d7418698cb9cb40645b58c0beda36bbe00d1c7710ec40f7543fbf1624954570ab2c88a0997c5e4fe2bc3c76e5fc58fa0a98b048fc44c22efd3ecd69caf3cffcc140d05cd6abbb574e52a037123e41c52598a2752f5b5f2ab886a4513c7d4e05d4b64e1de422fe38bc1ceca7553611be553765366d231902d9a40832cf55d1bef59ebe6550b6e1cdc64acf688537bc89410e63a478d57a60c12dce3e9b46c8fc62aa1ad04d4ac5bb38ad2c6c85e4325d12b50144f3358062f0ff936f668fef7b2e32d3b0723b5f6264d2bd5df4653509f01f2ec7570467bc61541bed0eebaeb95f146e2d241235eb3ed44361046223ec5cf93af97d1502412ce522748d18075fdec0296ee4756f7bbf80309c4c7f63faeff771ee6089c6a8dac6b893402e4fb8b5f299ef34e776b5856630df40c249994affd3761d11701ef243924fc5cf02a5af791a12df2cbe62e7eaa7e3dab026e66993ef63228880e76cf415618deaf7eb59f6dd38b8741d69327b689bf27e634050f89d44f6063afe2c641b2fd04048815c1c6f1ef78e25141e24fe63dac6c606b0f48fcac444209a66eddd5898d3f3138d99e4f79d45443a75dfe744655be28f9d8ea4d4ba5f120e148d92fff1a2a33db6a69f7d50f4b150a000ed601fa15c7688f36343fcb85ec7ce496cc4a2ad323c6e307b7d9b35cecb32ac4eed895856bcf47c6c434c324c36b8d705c38ecac48c3105549feef4467de6f67dfbd3767a7db82ba7a42df2f7641a120c230d8736da483e06da1bc40403d51a69c7445d70e989c4006d00f124476c97e9a7f795c55e5cb55361943ce028ee9565eca0f11dc60b8c094855f7bb30729bd3acd4bdac3ef48bef469c0f1f8cb5e4aeda202ed5afffbb3c4bc2d0de19c3c6edfca66ea202d2ea33ac561db00fbfd0cf348fef1b6c148ece0fb18a8a94dfaea8363ff593f96e5ea95c0e87a46cc76aa20e12b02e90b063f6c79016bf732188085ce180032537286098b42808d6c4e775e82f6e15d84b684ed3c9548445cf2b60f886066f3ba7eca250669228473b7fcc3bc922e9fc25546cb66cbe42f75916e22f2cced6033d3a1be7e3256da9050ac4b174883249359147182a2579fae725d7835adb84ca51efaadfaf068fc7f9e55ac3d12048d8e0d31470c2850465e14c528f391694424f9c8836b02f449c695ad803014bc6b39408a097ebf43c54b7328804f835f22956a26893b567bea5d182d13acbda32fb6382510313502b3d61e24a3eb089b2ee86c212df0b99b00ad983140ca97cf84638e85211fb944422f6ec45490b4c5d2299ceeb96f5c526da6bc3dc2a58ee36fc190a8317592ec464a8fc12f95d55393dfed0d699ee075f628f4182818f714728eeaa6fa1e0b3302c84e6cdfe81c41739a88d4ee34940a7a3fd8c11d4df29416688e794218d0a5041f840989fb985d9862f7f0b7bd1b6a9e5bb0ffd87a93fb6a30446adde3aebcfcc5da6d19b920f780d3b7e43c5b51a9f663900e16a4d4834cc6ddf182909b69da6a08623c726d98318cee3cb0b94a4772c603797b4005f3b5309c9028bf996aefdc3bce7fdc117e6c305a2e699e7945c672ac51dc4a60804cb376f22add8478cb01ced71538ec9422e6bddb6f2a665a611e8c5cfadd537e598b5264640ecb2410a018779759305f7432847d533a29322ff82f5232e7dc4f8fcbc8dc8ccb6fedf1226fde53c2a03a416645e64563b2c127735eea03924b9eddea303f1670925cb1db61ee058fe4a7cbbfa0d1ab31b57833bd4c33532565722d907ab13a8ad8eabed7f8962915cc8cf338268d9e5af29f8ab79b334932bfb5b6c42a0ded405f7012f421b5f9d8d24fb643a650e1ab6b4f9670debe0abf13ac81f584e14eadfd84fe29e2f31d6e3b1720f8da302eb1ee08d3e53cd8b79a4c9820e2d52dfc9f17734c67cce0ece7d761912e4695ca7d78e624f75e434dac3e7457369ff4c766c8cea74296c4bc864c5d24a3ee7c9c03af8d18274ffa813dcdf881b243aae62a2f1bc55e749661b58ee3229ce81d923d44c7c30e874e3519c7b0a5dc0d17a883d5bf89f798e25ff1ef19fe914a5efb57f34c6f0520f52448164d7acdec725f2e323ce49038b83bed4940b651fdd5cf36295100eb75a083c9cce5c1c93598f419d8c983de9d0f0d1303185998e6f1c5266ade8c9627722c6ce4f3d261dc13a61183456bf5dc9aff95957fa38ed2bb423fd482c1c0fea1f7085a7b4d8f2401e84ee5d9368188f40ef0b6db30650bfe4f79db59af93a1b70877368600bda161fe9530992747</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>工时系统后台设计</title>
    <link href="/%E5%B7%A5%E6%97%B6%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/"/>
    <url>/%E5%B7%A5%E6%97%B6%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="4121c481bc378531b8da1bb2acd69e2ac48d5d5a28050241057ee1dcca02cace">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c0fbafa91e096ab4252635e94b631c366d7225c859cab4afa4e3ae4c46954539ec55dbd37b725cb8c79208b7af6f2124ee54f7b3725088be93d66219ee59d00fe36c6135d4f6fcde22a37fc164b49e1f5463a1df99a5cd41f8b1dcece582034e60925435e3dd5a3669278b0be58209679f315e25c43f9b73b1ff7e20aea93f16359eafc34d4caeb9376936ba5fca4542b83b4eea89611024cc8c21225e795271b8338a4f25decd2b57316f39ffa696a038df9e8203b0a98a0a389232078fe6b3903bbe67bfccb7bb3d1876254ed967b66be424ea34dceb4a77936894a41e5b008930e41696e411bdb2403d9176e5c43f1073b8b66c88e8dc095ef4c38da50bcd4ba5cf1d61d2e328c5c64d3605a3529b1807672eecd1bc09fbc815d087a669dabba793af25b4af9610f7dd03401f320efc8a7b35846e7fab6d9aa13f2c6dc7204e09f87dc35e8b1f87102d60d04f641016836a2b43790c7128ef710ba7d07b42e4c97f50d0b4b5c241c699e26736b331936680618ed72a2c6e7add5b5d4068b6b1ebaf6e02c39e94435279d51e5cdbc56d8cf04ef72b414fe6d9a0f86d9382924eb60e40798fc8bd7b8328ab1c9747b3cd49e864b8603b38f768d1e3f631f02680eb021d08c53015d0f71bd8aa839c02a9389559ae17a211d2170b0e29e87c1880587f6a5df69aee55784b574ce528d15708891a066c799f10e0dbe9319c0c66bd55c733b60d590d542b4caf82cd5c9beb613eab402da4192933156f07e97845ace30a3013da232269eb72e6c3af3fd4780b47e5428677eded5eb9477ef0b764e2e52cb3e9d6107a2bb0d29677cd3a16aeb10c0417e3ab8f87b0da2d079e145ed8a22f70dde81304d01a7d0d34b82608b6a2bace9cdab4929d7d68d1303b5fa9f917ad224f87c130f9e0dfc747180ec2ccaf5bb32296e03d98b82dd15d951edf377aa63934cf22fc966e2b645af4e1c4945923e61c9dad7bb39e3cdb58f0354f9ee06725ee1c67bdaeb771d7c40d987365710ea13b52d3287f3556262df20b7b3abb4674731b1a28078863f4148b3fa68fb15e9222d52bbe822314483358237c024b9c49825508acb649a69e704dd3e33f7c65d5b06dd69abd4fac949960db00bd8d72ad1ab4a0223ff7e007bd5b71705d6ce91bb9689eee2020244a821e957572b317891c71108407e8f7eb3639a99f653f5a2485ede232f68f0b33820ed638a9220c330622d809b07562a3e6da0e4039e9afdd92695f35f63f19a6199d4b41b440e7ed7588c9635afd1e2a4e592404afb25665bd8d2d60e3d9330d4fe9675d1f57a3ff424985057e2e237a4d346d5c61f08838d4cf37a4c14f122ab0cb4edb10bf5aed0fa8559fc9c6e31faa1dc045e54e25ab60cae1bdefa7d8647036fe1a88405a8cce1a1df9c14ccebda2c99c456e065d13a1d5e70c93bf2252a487102a565d92e958c150ae05f1295225876e045f71198a95e9ba2d872315b7e540548b6b65449c15559be91724b3e8d90c9c0475c067031eef824f40a202e5ea425c9c3cff79055f5d45b51c56225e47d220176e1a55f61f21f0e8243c1af29b928b09af8caf45b41da59d2c83cbf3a0d4c18817c670806fccb65ed24f54dad02d205949e291c7b7f42585ba0ad9ceebd72e113d534ff1ac46e8f68fbd0ce2ee754a24d4afceae5a20a6b54b9ab9ed4f9d9d00113ede61d9faa48be81848f8dfc4e68c52802aeb08492fe5274df57d9664324eda8515a2b2e2842df726538089e40f2152fa56e955f3bfd82e17bb9c6f03f842a208aa02ae076d48f52e3b15eb5f9106e74e91063773cf111b085f4a7c578c8b276545bf217d15cdb8afb4d9100b7944d49f6006f6658ad40998522cc716384b325758c31e9c57b5a3c22fc9d444f57bced1f7fb1c8b59547cf4dd66fe2e5282ece706f26aaee18fa08dcd7f88eb1b91faee45e52be2e74fc3f8ffcedca7903c15417f31aff16173f221480ac70f171af4c78d8ca4b209202a4011b9956f8a38d606e7b26297f4edc0dfc6f0ed2637f5d86cfd551793a84799ca69fee540ce895652a62df545a92450172d075412b34d7420fa0f9d491ba8aa59ff8a985128a02756839c034641eb66b3389bbcb0f707fd415d0c49fbf737211afa390335056da8d45b7f435abba28a93e647a8163731137462b826e15f1e643555a3eb1205ca12635b9d9fe4bf1f19eb65f24875a6b8e5440cec703b34eb71a7b81b8343f388589ab246d848d6a66c220e7cb07ba90a301f05deecacae04ef99b532f207fbbd587e90375993591ee1b1b66941a594e0cf28811c5fd4bbc76966a07237b36560ee8513359a1b3affc4e23a2036299f4cbb151904f678edf74a8da092944ae8705fc40abffd625086ee6f59201a3e610ad800d1870a69e205ffc3d079b6ee43d22b999494f4b24194a2ccb0fcf5b4f03fa850a4307e5478c6f39b458fc8cab0c8e76041722180ff74a367c52fb2c978674fb885c0c37ef4a3a7d6ee27ac1fe4f6426cf83bfdfc4253713cd2cd41c30f8161e8271d09b3f2743dd40a5fcb8859f6b9f348fe5509fb21a0e5335bba4ecbec8c57efa02c57d9e71cbadb967968e7c6d46cc6d9fe97b7b745d2b530850dd18e9e50d9a430c3ac34f036c5d4761c76723f55d3cc6ec9b231156ab9c3d4e9c25cc8abe3aab4093461bdbf558bab854a8b288d9a213dbe372a3f13e4ee16f15208e34a389269a25983354948c99833ea68f4a01ef3b1959d0bb2e4d5a0437d5ba6770817546a25f045928881450b33dde0ed356dd605a15371dabafad7830bcc2171acc22ef897a821d3e4fe68948972289213b4280a38a6858d6f14119015f2670556ca9302345405e7fdb14cace7a1da28b502f2125363509cc822d63101b781bcd770d37f6e73b3497b4c60e6c0dcaba838a72c72174782b34992b7b36797dd16aa307d5b2b1d0a789245588ae5f0d946c7b3d07e6f1f714c5e29fc7a8fef591391ff721aa127cb165defb8a1eee9a6378c1b312947187794eb1b1772ae6728744e6c4ffd996765e9c7f0444a152692afbaa279ce3fe0eeaf97b4c1ef1df727538dd885a69ff552a6782d341fd50fd76df34d539f14aa10b31205855a221dfd3413589ff602de8d0dcdfecc274e2f7201ca581d45f2b420ba29a4b94d52b01c8a5e86a0d3120308c4c54270a56ff4f7f46ddbc57bf880c15e6252c5cdb8a7a14773e1781e88c230a982b353e3583bf929471ff1eaa85f8939977bff29b53df11eaa380a003999bdd0d2a449dff3d4ed2fba2b9bb6b8a957354942e702b66a6ea4371d21c0961c1725a4ed18150bc379e15f73560560f2859c3f87172e38990726e5828dd92766213af0a0908302c65e7921ec19855c92e5127dbeb8f7366c19a7dcf62e046b9c4236601efbf6a6480c795474511106b5859604b7406b99055c426b41f053d318271857a233e4fb1955246da01d77c0dde37cd045ce998bf64c9aa08dd8398764b95aef71eaa879016275204ffb5cb8f0775d31431420d42e6796d72d6b7d56fd61e5c6e44e01fdbac8fd35b44417d769f5a2b4f701def9ec379bca91cd9a572dccea46aba480c59f8a71d689dc4f3ef5c8398537c864ccb6485b34088118e4a99d180e208330530fbf12c014d670681dd28b9c6d05c6bfd7bfb77f8a0cd33280260075c708643b75d953c3c57927eb922264da24d38eb5727008c0bb762503f43b25b3cd5b31f34414396b1bc2d4fe7c1969ed0bcedcaed69052827777af0669b42ca1dbd1a56b64979aa23eb64668f3e0f944a046ba1c295db86208c1409101e5e8efaaf8be80c4cfce878085b3ca11e32bc346b59ba606cef5f51ce1e9b64d8db7826c873ca41cefa39ccdcc2b7a01455b85286b4f572ef31b16b7c6d48a30ac2cc79a87721d2b08d6566bc7e8563ef2e52531c58757e15e94af5ac1b2f34030b6bfe45e05f2098634ec7ecc7876ce973f432c38992c5083360d1ef8d09de3519c53c5e71de6b8017f1d128e0ce8c491fcc9ea0f4de98b25e012a352359f3d5caab727996a44529cc4b110920538efb3f3b9e169dd2d51d6eda6359615089540f746f0f525a8a51ffd41ccdcc1bb28e425ab95761d77e0a11db9dc491f8218526cb71a3c449c15e2a8bbc46bd2a3d98572e05b479964e8db3aaad4f16c2cf0d8295f282b91d9302cbad4f4cf85f8cda9b6b9fe48ca6a06c43b78cf50898bf49465a12f2d56757fe499fceee812f888d16ad3c5f5bf606c9e1f9bf2d57f54a2ce26161935e6cce37e8f1e4832f55d5f59a5e1acda2a8a871923b4f660d770f85836bcf77d037098f85098b32bd04df05103cbcfcd3acbc8a46aa61e2a1756409fcf2be5f1963a4cf5d7ecf63072af4411c02543180936e74611f412f9dc57fc1d6bac0774d8d14b696ae7d6f419ac23243de72c12f150f79f905e6498e057b8937b9b2699f365c3c04751c3a6adac4c820dd0917310530c24e1f3e9b641cb2d50d556d520297158c552ad546d12f1a223039dcfa4a38d69ae82ad933d0917f49d92db369bc27da865a637cb093b3353f3e4b896f56ff0ce11cd391400db0bf6e37603fd556d410fa123f21023c1b9a41851e95ad9eb977f07fd305c5313cf49b59264d01ff69dc988ae1adee5441b5bbb81f707b619c718b3597c344f39f4448ac67c402805f3067c0461d42278b277bdcf6f110f7b22c3176459e47e68938581731d521fc4be0a344e6d9b98842f313cfe90e5fdd47ec6acae849ccdbc712ea48b8bc66130de89018329fcebf1121bf2bf5a9b64be574b68561e61a5d3aa1619ae8e6f5c07527acb93fcfbd2a2ad69aae2c869869a775f9087f4c0b8fbc60729118adca59c67c7e89a365e65954e376eb419e1a79bd77321dc0a8b9199e9806b0b30481063e7c2e435e2685a64b87163a240c7231ffe7e6ac34701d109c8d779dab38065d5637efac057b0e833288b174611700671fcd6d91ca41915f5dc01e133f54f0603343d7e31c89f17a22b564dbc6fbeb9c9a61626f8d7bda51f9add2654178076d34dae75bd766b3aad8b6204daa373a6bee2b2d829b8e3f7c6b101fb7d16884c20fb4885b0fac1a28830d5d06640e91fe78f3681cdf84bdcd605e6d472e9f72446152e0f0f34992cb673e4d6d527d6d6608d6f1d5d6479e415a923d584eb9a883ce4928f23c1ba7c2f439dbb08ea27a9e59499d35bd0f41fb28c68199973d0e98da042f386944cf35e75cd9280fa1a5e2d641d091646b318906a4d3c781903c4ca30c5fcbde0cf8769da76b08e110914471882e07cf079751eaa3a58f5d1c9aa874c53a072db7901dca00b3f001a6c13e4b519d82ca0b8b9c505f6b8f9f6fc9956170b79f7b645067d73f8a3e46f9f40569df1b041ad31750cf49d8c1dc374d5a069d2b3f10fadf0fc22518477d4a37d40c8fc91cfc9654f6856a77b2151f678d60a1224e7cb0ed4e382d16d25ea770e02f125467e3a63c3b4e163f258b75271c4b523ac5a205a5f79bfa2f78421f27488af72ed03c5d8359243f441d8d34faa393b6fa9c833856741832e4a607c78cc72f720a4e5628743902c06c156061a6dfd397b40d7ef5810dd6f3ddb143488e95acf358690c1ea1d3e33ee63c772f3c7fd2205a6b833fee05e745b08f1f42b4e3632fd03798807158fe1f93c23a03a6a087d0c3dfe0d772badb5cca98bb1fd88e42ded832f8c4d44be8c6c56a7622c6b0822bfe2c98e2ab33904c60b79bf345953863c652b4559ee6bc69e33d296ff8f4155ff1bdb6de29a84014908d357f2c9f4dc76b88d15c53aadf1ba5393d85d45c4a7010b5e8b0fdc0fcee4dff218b999c1c2c21bfd772ebcdb0df34e313b2d3ad4531b21a8b7124391ff60651a0087aad2895638b439660812c496e23e84129688a8eb4d1833011801326fc8d355fafecb702476cb35f5875b6d623ec9c7d0cf18e58ec6389bacd3fcb7ac3157ce835f6cf713bad3bf7477649c5c244076e50f581f1fb0f08fda3d1574a1bb85df8fc45f1da9f42e97398ddbeb20b8703b09f9f95abc1bd0457d53aa6f570f61c29125d8932bba9b5f433121feecc85090e1578550c77496226e2ba68c613f1567493b076f782722fb8008e2d7a250a7d18d4d9780abaf308becab7d44fbc779ac5b1b6a19a338762ca14ba364ddf261abfdbc0a25f7ec049a8b3517174d0f3e87685af5e99b06403eb768307bfa7323683e2950b61ca7c95752aeb0013bdecb276f3f53ef87b533fbc940fc11d9b04f11d5127c5d4ddd2215126195b4b7d6081941078349d7232f6af7590bc78f478bb14b897485d1098b1d96a3a183d7c07eaf0c164f900bcfa4e7e7625ec1871133b40aaf4ffafe9ed5ab5ee43812d343b1a4bdacf9db21b38d025cca42f085d4f10078cf5990a0b976ff31d3d0653bb75b7121480a4f5fe40bc812240f32897fa0e84808f3383b12723c6b59edbb65e9ebb44fb88426482e75279503100c8fba7bc74f414b15eee6f5cf3baf912c2b50dacd993dfd5e00d5c24ddd45361df148927f3a4f500b1c06013d0108da282f5a1b37158fb9b23d6cb8a1e0c01bbc7c905b5bb313ca6d48c137e097fe2e5e89ba08395427f67e969e8d0f4d724debee99280bc1b50c9b5534092dfc1700aa6a695bdb49bc2f777025b38d3c95e1275f9477afdf019eea9896aa7a836fc59e1a7a690629253f0758fe1c155d8becc3a33098f13973faaca3367a46248a0ef8912190b514238888d3cf4dd5ff9f67f96285cd2cbb53c5b9eba398ede5165bcd008a4e080473bac2ef0828133d477ce25c952e88a08f14f889c17a73dddbd1d83cc4881214c92d59b905d2024b35cbe0b5b99c274930fabb1fd7886a842460b990f4d075b4763777ea895878f6ea70555ef9845eb8d96bf4cf58ad378b1238e24c00f6fe88ce37b3e5d044ae38caa7be259b8dc4339a4a3c2cb2c95ac9e150f020af6e7f6ef5f0aaea91d09690b22c9393dd3c2fd5ff65e7f39d32b4796746692e6e05b960f810db711ab85f2e6e3ebc81b0ddf470f4e3c45be95a94e35726f1073ae4b21c764e65de39bb2cae851a127d357e9bdd8a3215aa9a6e73210827c570b79202797d55686e4e13de1e1a9d708123567ea658d94412ff7cfa477b3d13766bcaf1ba45b2086b20dfdbec634e4c9f9a8e483eafcc0c95df5cfceea1be434f594eafb555eba75a34fe18a35f58988e24dd2b8805304ef387951788a87586dde74d39e5748964d520d7982ef51b7f5099520c960ffa7dde2b58d83eee9f678e5a055c7e63eeefb08fbb2079ea2ad2444c812ca5ba981932c1d385151070fd3ff35f9e66a81e8d737264aa797dd345cf1eacd629b8dcf328dea1aac290a5f59f9ba42f9a1bf0048737a6baae943e17317b0153116c2d120efb277ed39660baee02a34e4d91e845c6bd4bbcb5792e9338a2403cbaa2e4f43964bb0c8267291b114f1fc557b64112f6b28012a69f9706df3a642b5385ad4e6199c8eb0216b1b239843a49100877094eb5cca116140bd22901abe8585d859d9c936788279765791f0b04f7ddd9a576259d26166552b7514c23134025dac5721904dce0a3915a8fd0ecb1adada7ec55d00252c351611e714c07a8d0e45947b55566cf5a4d22792b1868b7e08d2113588f45911e7f921e5ea295d1518cc518f83d6f5091233982d593a4d0e32ec30d0c11135e260b4b8b8ce7783cbc0afc06a7a6151e7663ea1a770a0f7ac30cc41f6ed8af2c3e400142a9dd90276f9e357150e2ce81a74d22d1f3017d430f579044db0c117619c1f9d9f6fcc25f3356b5e2101fac15c98091bcece2c3a8c0ea4a36956cdcd81f7c3465c94b321e3d31e82aa901aa39df5201dd5881b6633037121c64cc2c2dc4dffb74745090174ebdd52b8d9fbf1c28da452cb97580f08f4dfee704fa79137e9eeb24ce5fe508923d1cf86783b133d797894fe1d4eedf67c6a1e259a1efca6f9b572bde072a521a102eca21987ace2d747f27ee6b07c37d2981335e0d1b3cfc7dda7d629b9c994b05f6c6a225fe9067e97ceb1845c01cbea3e77b68a7af0c4981f16cb2cdc05ddcdd855ca8522559b1dd7d3086bff4b6857b4014830f074cc88b88cfff0af1b2e74f187161896ef2ee407d40e7e0c94832b02074194fd7ff205a4774c6101b6290105897ac925571d15ccd3b5a62afc326ecfd91c4ce406b213717161af33aa91ca7e7e6e545dfa7fcca738528aad54f5af59edafd50472b5cad81a7b367932de9691ed7235aeaf8f8648f014374b175cd2b196a1030108951efc9d5b543f0cbb0511ec49e013ef3034e9c502da9c8afb03573b11175e7708cd35112e6c2e25b41f5d9431fdddd6d545e44d60419306a225690b024a90fca60597fd2044b618f7aa90bad3ed7f9c129bde00b66d032909ff8e9b857defade17b75e95279377497b4a6324fb67227c2605d3aa9006fd9f6d421e0c719b37d16c61d917f39b05522ed31136cea55c6a9bc357803d579c88432c5baf7daf622188d6d04c33e8c863355e9e9ea4df3112f41f79723990c482b7627072e794d25ddbcb7dc14f2471af654f1089ae2f508d508a354b40e057cfd31ea9bbfb400ac7dadd749eaec570bfb85496fff51ec48ac9d29a0348f59954dc51fb5c2948e385ac6867921f942236c1812866b6054599637d104b1caf69cb9c8a6e009e52f29c61eb92e66197039c06456a0e1e5b598bb6e8162b3a6c9779189aab0bf7e8314ec3fe845f4ac96d45e32d748cecbc712f66676d30e5886ad373bfdbfdceaa04539f075c65af4d192c159f3b4d3e5c2160a522fde45b115c74685ef2171a224940246f3d951da0fd756305bb4fcc5804b7a141741a5ed139bd440b67fc11e90e4cc2b7af78eb7df441e02746c62046105bafcbafa2731b7d67ff702031fd7d7e9d6b3cd949a4c87d6439066c364ade206a1c5bc4c490f793ecb1864fa41a2ef8bce436c99e18049551ba1875f40db4536a77bebca51f4e01c238cb621bc89bb9b932587b5d2aee55e723c23dfc8ec1609a865595e675cdeed966263fff2efc7e3c91d82b7bd94877578939e8389d965d18b956f995e9a329b74f7302ca9657c844bef3cca693ac7e1b1a125834510a2e00a492e489b28fc7c9c7038720e55cdb141186832da7efc99e8661f6c80dc100dc15644e93d4822ad6041706f688421a9ce0b731b6e7a00dc061f532864ab14e1746c0f160dd00b72a46be638dc8f5eb4518bd3830fa4299bb1227ec09b443af67933ff89373c3b7c3654a9855f7bd84a970729936d061fab6799c19c36980168965737363198c99ccc50a2140f7f96204b950aeccff7795758299b945a8f0ac01cb318d62717a70d833c22fc8abfeb2e9289ffedbb7b84e53b05dd85675549d5afd5bf359e2648f8d33df9e959a89b6b4a903a3af14b58fcf4744290cbdf170a624fb48ab2a0dc715d755caf535e95d621a5c62cffae716f0e37124df13252a1d726448ed9a7acdc73b5c2fdd59eab9df14a92396583bbaefe1b2bae955421cbd0d61d88274da6755ead81df242f6b733433e4ffe39382f4eaca2deadd2cf13126ad1b4763f64a60fb6b4c460565e2841af8d2ad044a5eb74e1d444c48bb1f4934bb588f2c4d9ae09845ae03f969bc069798a1a16f2cf05ffbb1cdcc0fa1f249f5ed63c82d10f74a84ecd8c8f2a3aaf7848a44882f20ac0b62676cb9e6d1e6fbae0584b4fd1ec6f8ac46f98a4e0d6a98e786cbb94364585f4cf97dcc952828d342ac097d9324e0d404c85f3d3c9eeeebd530cd90a4acebb279a72bfacb3e2a6cb549277b67499ad3a8d6ab260f938470670443dd8b1681933396a2875201c77dbd4acd171e6423cfd5639d88f7d3c154d9e53b4a7266314d2c98ead561a4c087dc68df74f42ea7715cc4a914bb8788c0295b2ab6a369bb1f90e872cf1f28062ea76f652bbf907992376cffc9c4d444ac52e101ead487b938d504fc477a3e12239a1ea0d42e39973c6febfbf8f90c286c708438656592f2e96986ff079c26532c77b726995da64af46fdc1c678c0e00f15d2491be8e7e3a79b9517452344b9b95c53b42ac117b98fa2260c283c23fafba8232d5ac168be9b3a5716f8144e12c6d6dc49a61f4b038b6f3bc4aea5cc9ce295fda98c712d92dcd11dbf3afcf477f6c06f5abc3b0d8fe3ecc86156d9578c1e0fbcf7325dc5df446804ebadcc4af5c32073097f87ea54cea739686c2c15d642f75b33cbfb4a9d309c16d8661ee557a41259d34eb45275521d466e058df07d84b6843b2b901aa32463a9ea7a67bdb8d75a5fb359577a76d407330001875886144ebbbbb1e41b79bca476919c6bd75c67890d0493b72423a04589b69c6cd91d3b6bc80be0d1d8df73119ae7e57d6be6d9a2b205fb7385935bbd37d7b77cccd857621d48633eecb104b246edc4a0aba36034f38f942bf808f6cfe5a89019836d963ac2e2393f97d986f566e15252acef38f9fc61db4f140e4911edefdad2c994908323b4044bcdf2edba508b473a7bb0be3e1d4294a33c9e4d78bfa3aef1fdc6eb0e8caa293a748d2ace17aacb1142fd728687a1604d559bdb3d19a06160d1b0511c031a6249c3d62ec93ff497f32154e040665bb7c041eee11c75a9e287d5baa403377e216f079c41aeaa2f52d30c8d288ea3db70b55997d23ba96fe33b51a9859f978ff37c40d857a71e243bd52038506a632922eb682fc254f5bf1530271b65d95fd6ed48c73697040d7f1774a523487e9143b107ca8d059f283a473c7edd52ddd2e67ae5bb0c5a781627069c29946cccc8babbe3f96c604628b3d8a8df78dfce5379669f82bb1375a36b6a891550953e8f88f6cf9236eeae50de2c6738d5b9705afb043ed5a88c8d9e31ea98777db40cabf999718374b3ad9b3b4859e353050d9f8e45d051c770cd6af513f28e9ceb6bd8343be89900adf9beae1ed7c405cfd7724e22bddf6a51eedaa1f8f1e446a6b7fc6bf3e505ae4b50d2819a8894aa40758cf186d8526582f146ed0464b5f7256b25279710c52d32190e876f461c143f15021a6924ffd79daaff68a30bd8a825a9ae790446fbf8f45c9b2134a973a0e28008d12f884ee9826840275d305dd3a799d831c0f7e1e3d25ba14d8132cf3c96ab830f3fc1f240650d6f25a434a51af642dcc1cfbbd0751ddc52725a0abc7593b4dea92fdae87f754be184e91a833cd72f89827081c43c1d31b24216790bf348038ca9edd92a163b53acfe0c9415bba5b2c5f5f53ae04119740b82eaff38efe13a92b2e4f99c349ecbdbfbf26db69a1e16ab265be0e058107311cffaf4c340e0889b39f9bfd6bb74b312dd50b379343d22a5d80c73aad4165aa71c1daa93e4ad16fde61805ff43ff6a281dc329f386ac62e63cf6ecf5aec3a299a62d99a1a696bdc5534696389e1b3845293a5396ecae70ae06d2950ef7df111325bf06fbc16b8cc657e5e415f2f22c0f87981f1b590343cf35da2c7283d2b3dc9552c9a83e5a1a3ec499f86bbef487c7055dd5b4834d01bc2d7af76ae8d0e38c1d200e2421310738dac218d6bbf75b80e66e1a7744eb688b0eec7606c937e1a4bb4be545d39ab6e62cded4cb629050ab5bd2a0ae28e31e4e63ddb255ba8ab40f6c31def36a97f1dd5225651987bc1efad5fef6f349f8b096fdc182aa6cff6496bd8a4c862289e1561a8e11ba9b2aef002dd5f7e31e0abee3ca96e7c9318d3cc4aea1dd2c4d414bd8d4cde79a561725ac3821fbe4b93b02d42ac04081afde0734b6a31bcc521e9d75e604196db46abed021d24b5e747bf088e376ddab88305c100d47f2fe7d4195561b1f11c0ac310ba9124689567b3de3cb2d4a45994ded4043541124b3458296c63e5555b816efdf871edab54f523c5ed47d1bd7f26cfcd83e7ffea0a9e002db071916bc922bdf6cf69cbfed5c9604337a18d16ac988695ad91edb356d2276fe3dafd95c7221e6abb21798c17bc8f3e3475a08facba12eede90f6297ac6ac2bcd2757779ba7c20c10fecf71c241ed2a876869e6ab5ea3a0dea830fb5e766997382fead64e947ce9ac06ca03423947536732eea241415dcf1113b865ffb32fe0ce12917cf2595cdecc7b43066da3d518a03aa31eee6619497f0cae5d6597c8a31f83dfca8daed1d3a7d1c189e7f1285e58ab0c699970677e7d39c3fc0fbfc57b88b6a61cbbe3ca7260cd41089070111bf33c0e1c810b6d48c783eb69679be2d218ab377e434b541364c0ab5e89baf8a3aaf755aac46524440d97acc24cb786e1418026533b7bc69ee2a2a1aeb203cd33899997c67dab123e194a7f19f130340cdbd1eb2c2fc9c56a4af0aeddc688c9e0037cbd6262805acab51e028a605f608e77b1e4a544392cdfeb83733be12ce0f4a7b7cb8d4f2b565a82b1e898a1cb118f6d0764c07fa485203855da36e224ecd743483a2dfc984b65dc5e1a783caf57d042b5f20cb094a8c6de66ce36ac83bfa9aee577e7fcf3ae656f13e7566b8636d823c7babb88ab0065f302a56205cd04f58ea821fd8c71ccf53ae32d7fbd727403ceae644e850e59a537699aed11e8ecccdbf8c82a33c5717ffb09a295b60545de2bc1487d2a344f3a1edb2782efc64f4d9314bb2310bc7b088b798362295a08784ac82c37997dde8ccf4a50b8b74ef55e2ece2f379c52ce00bb800df0c468ead1212097490aa1c43f42a6d91fb02df00ee501a6580bec3baa2c93bdeb37be3024495a9167ffe2d94d938d1db5aabd9ffd6888ca50dbd7206168846851004d4da5520a594e4d0e51233713a432b87cc1951ece99efdd830104a88002a5464862abb16c8b3c83a0533bd1ff2973d271acb45089886628c63708001c5fd660dba682f186a2dbe1c1ed3cb86617397d3fc60b01a80e1db4468f7d7dd37742682094b7adc9d4bfbe661b590ae51e799e493161e2f3522c8248f532e57d9ea9945f4bd8125890ad964cc4dc27e2e659320c62bddc318be8306337b378ed529cc5469076848be8872b87e2e11da4b1bc76c048c74302e784d4d3cb8f405e375a30f1a37ec0944faf115c421c9010dd35273080e59945590109ba273f5803251e522e70fc8397f359a86d856ea397939dee430f74b33ad782181b059bb5fe1a18830843c1a504b45a444e681b83b7408d479acece5a9a367c34756cea9e8e25c04dd54278628f4eb1679dd7dd537dd692aa1e904e2232aebb64f98993eb8e27d32c9287080ea210447ecfe41d4fcff0d9dbca02e6892878d2c898bcf0e415379b2041dc6b964e0621d14869fb5fd689d69333815d603ada5551c1963776cc6eff12d116008ac145d46a7959aace3a95ffdc483744b0bda24bb2f0aac4d220ae8577ad76c632d557c31792a60dd42b728aecf49e2d17f9681809ad3e8403a7f1702743a03b25fef6d86fd375011581bd6ff5a56489069ccc458229b972be037a25c49eb7e2cd4cef36962ebe0c0fc9e679120bc206da2e1138c59a8a420b4a56b7b37262a204ea6bc3fc9cbb1b09b3b46433345900e9cba2ed12f53fb9a1c7623990dc9d4e0706fe80db5de9045145b6e93e494efcc96a1f1f81db8297747f58ec767c0854855d077e5a43699ffec1fa86a1076190f6f95b7aaf50bcad886d91d1ecd500ae01512749d21f8f2d3eb19241850c4230567a49307e345566471545404c224ef7414ddc9ef7739a1b1444ac5ba78f72e28a4f2bcb8fb4de4168984ffc0feb30fbc8e4c6cb9ba8add434752b044869338f93a683d4e7c0582b059f649ca21b61c1a750b15b6df2283fe610304a0ed6c12193442725f65431a3ff77dd860f9c92436aa1fc7c3d2093857ac1d1cbb44932f6f287c73f5745da87523fe779c611f272040d2181ed03e2667f0df5348bdbc675852c4ce90282b10e4dba27d014f11ca3c48182245faadce269cc93425c36dddc630b418ee32a622d283249827189bd5c4b01438df4f83eee3762583395485d41e15cdc604b4bca10c63c5faf023b37dd1fea5962de34a457f030dcb40be6856470029a3592dcafa7c31785afcf2bd0f5b</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>docker搭建ELK</title>
    <link href="/docker%E6%90%AD%E5%BB%BAELK/"/>
    <url>/docker%E6%90%AD%E5%BB%BAELK/</url>
    
    <content type="html"><![CDATA[<h1 id="1-ELK是什么？"><a href="#1-ELK是什么？" class="headerlink" title="1. ELK是什么？"></a>1. ELK是什么？</h1><p>ELK主要由ElasticSearch、Logstash和Kibana三个开源工具组成，还有其他专门由于收集数据的轻量型数据采集器Beats。</p><ul><li>Elasticsearch ：分布式搜索引擎。具有高可伸缩、高可靠、易管理等特点。可以用于全文检索、结构化检索和分析，并能将这三者结合起来。Elasticsearch 是用Java 基于 Lucene 开发，现在使用最广的开源搜索引擎之一，Wikipedia 、StackOverflow、Github 等都基于它来构建自己的搜索引擎。在elasticsearch中，所有节点的数据是均等的。</li><li>Logstash ：数据收集处理引擎。支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储以供后续使用。</li><li>Kibana ：可视化化平台。它能够搜索、展示存储在 Elasticsearch 中索引数据。使用它可以很方便的用图表、表格、地图展示和分析数据。</li><li>Filebeat：轻量级数据收集引擎。相对于Logstash所占用的系统资源来说，Filebeat 所占用的系统资源几乎是微乎及微。它是基于原先 Logstash-fowarder 的源码改造出来。换句话说：Filebeat就是新版的 Logstash-fowarder，也会是 ELK Stack 在 Agent 的第一选择。</li></ul><h1 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h1><h2 id="2-1-创建docker网络"><a href="#2-1-创建docker网络" class="headerlink" title="2.1 创建docker网络"></a>2.1 <strong>创建docker网络</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker network create -d bridge elastic<br></code></pre></td></tr></table></figure><h2 id="2-2-安装ES"><a href="#2-2-安装ES" class="headerlink" title="2.2 安装ES"></a>2.2 安装ES</h2><h3 id="1-拉取镜像"><a href="#1-拉取镜像" class="headerlink" title="1. 拉取镜像"></a>1. 拉取镜像</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull elasticsearch:<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="2-创建挂载目录并授权"><a href="#2-创建挂载目录并授权" class="headerlink" title="2. 创建挂载目录并授权"></a>2. 创建挂载目录并授权</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mkdir</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/elasticsearch<br><span class="hljs-attribute">sudo</span> chown -R <span class="hljs-number">1000</span>:<span class="hljs-number">1000</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/elasticsearch<br></code></pre></td></tr></table></figure><h3 id="3-第一次执行docker启动脚本"><a href="#3-第一次执行docker启动脚本" class="headerlink" title="3. 第一次执行docker启动脚本"></a>3. 第一次执行docker启动脚本</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run -<span class="hljs-literal">it</span> <span class="hljs-string">\</span><br>    -p <span class="hljs-number">9200</span>:<span class="hljs-number">9200</span> <span class="hljs-string">\</span><br>    -p <span class="hljs-number">9300</span>:<span class="hljs-number">9300</span> <span class="hljs-string">\</span><br>    --name elasticsearch <span class="hljs-string">\</span><br>    --net elastic <span class="hljs-string">\</span><br>    -e ES_JAVA_OPTS=<span class="hljs-string">&quot;-Xms1g -Xmx1g&quot;</span> <span class="hljs-string">\</span><br>    -e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> <span class="hljs-string">\</span><br>    -e LANG=C.UTF-<span class="hljs-number">8</span> <span class="hljs-string">\</span><br>    -e LC_ALL=C.UTF-<span class="hljs-number">8</span> <span class="hljs-string">\</span><br>    elasticsearch:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="4-将容器内的文件复制到主机上"><a href="#4-将容器内的文件复制到主机上" class="headerlink" title="4. 将容器内的文件复制到主机上"></a>4. 将容器内的文件复制到主机上</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker cp elasticsearch:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>config <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span>/elasticsearch<br>docker cp elasticsearch:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>data <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span>/elasticsearch<br>docker cp elasticsearch:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>plugins <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span>/elasticsearch<br>docker cp elasticsearch:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>logs <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span>/elasticsearch<br></code></pre></td></tr></table></figure><h3 id="5-修改配置文件"><a href="#5-修改配置文件" class="headerlink" title="5. 修改配置文件"></a>5. 修改配置文件</h3><p><code>/etc/elk8.4.3/elasticsearch/config/elasticsearch.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">&quot;docker-cluster&quot;</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><br><span class="hljs-comment"># Enable security features</span><br><span class="hljs-attr">http.cors.enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">http.cors.allow-origin:</span> <span class="hljs-string">&quot;*&quot;</span><br><span class="hljs-attr">http.cors.allow-headers:</span> <span class="hljs-string">Authorization</span><br><br><span class="hljs-attr">xpack.security.enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">xpack.security.enrollment.enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">xpack.monitoring.collection.enabled:</span> <span class="hljs-literal">true</span><br><br><br><span class="hljs-comment"># Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents</span><br><span class="hljs-attr">xpack.security.http.ssl:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">keystore.path:</span> <span class="hljs-string">certs/http.p12</span><br><br><span class="hljs-comment"># Enable encryption and mutual authentication between cluster nodes</span><br><span class="hljs-attr">xpack.security.transport.ssl:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">verification_mode:</span> <span class="hljs-string">certificate</span><br>  <span class="hljs-attr">keystore.path:</span> <span class="hljs-string">certs/transport.p12</span><br>  <span class="hljs-attr">truststore.path:</span> <span class="hljs-string">certs/transport.p12</span><br></code></pre></td></tr></table></figure><h3 id="6-删除容器"><a href="#6-删除容器" class="headerlink" title="6. 删除容器"></a>6. 删除容器</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">docker rm <span class="hljs-string">/elasticsearch</span><br></code></pre></td></tr></table></figure><h3 id="7-修改docker启动脚本，增加-v挂载目录"><a href="#7-修改docker启动脚本，增加-v挂载目录" class="headerlink" title="7. 修改docker启动脚本，增加-v挂载目录"></a>7. 修改docker启动脚本，增加-v挂载目录</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -it \<br>    -d \<br>    -p <span class="hljs-number">9200</span>:<span class="hljs-number">9200</span> \<br>    -p <span class="hljs-number">9300</span>:<span class="hljs-number">9300</span> \<br>    --name elasticsearch \<br>    --net elastic \<br>    -e ES_JAVA_OPTS=<span class="hljs-string">&quot;-Xms1g -Xmx1g&quot;</span> \<br>    -e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> \<br>    -e LANG=C.UTF-<span class="hljs-number">8</span> \<br>    -e LC_ALL=C.UTF-<span class="hljs-number">8</span> \<br>    -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/elasticsearch/</span>config:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>config \<br>    -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/elasticsearch/</span>data:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>data \<br>    -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/elasticsearch/</span>plugins:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>plugins \<br>    -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/elasticsearch/</span>logs:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>logs \<br>    elasticsearch:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="8-设置用户密码"><a href="#8-设置用户密码" class="headerlink" title="8. 设置用户密码"></a>8. 设置用户密码</h3><ul><li>进入容器 <code>docker exec -it elk /bin/bash</code></li><li>进入bin目录 <code>cd bin</code></li><li>给elastic，kibana_system 设置密码为“sith-mes” ,执行<code>./elasticsearch-setup-passwords interactive </code>或<code>elasticsearch-reset-password -u elastic -i</code></li><li>重启容器</li></ul><h3 id="9-配置Monitoring监控日志"><a href="#9-配置Monitoring监控日志" class="headerlink" title="9. 配置Monitoring监控日志"></a>9. 配置Monitoring监控日志</h3><p>避免实例的大部分空间被监控索引占用，可通过以下两种方式进行优化（实际使用中，可以将以上两种方案结合使用）</p><p><a href="https://help.aliyun.com/zh/es/user-guide/configure-monitoring-indexes">如何配置Monitoring监控日志_检索分析服务 Elasticsearch版(ES)-阿里云帮助中心 (aliyun.com)</a></p><h2 id="2-3-安装Kibana"><a href="#2-3-安装Kibana" class="headerlink" title="2.3 安装Kibana"></a>2.3 安装Kibana</h2><h3 id="1-拉取镜像-1"><a href="#1-拉取镜像-1" class="headerlink" title="1. 拉取镜像"></a>1. 拉取镜像</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull kibana:<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="2-创建挂载目录并授权-1"><a href="#2-创建挂载目录并授权-1" class="headerlink" title="2. 创建挂载目录并授权"></a>2. 创建挂载目录并授权</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mkdir</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/kibana<br><span class="hljs-attribute">sudo</span> chown -R <span class="hljs-number">1000</span>:<span class="hljs-number">1000</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/kibana<br></code></pre></td></tr></table></figure><h3 id="3-第一次执行docker启动脚本-1"><a href="#3-第一次执行docker启动脚本-1" class="headerlink" title="3. 第一次执行docker启动脚本"></a>3. 第一次执行docker启动脚本</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run -<span class="hljs-literal">it</span> <span class="hljs-string">\</span><br>-d <span class="hljs-string">\</span><br>--restart=always <span class="hljs-string">\</span><br>--log-driver json-file <span class="hljs-string">\</span><br>--log-opt max-size=<span class="hljs-number">100m</span> <span class="hljs-string">\</span><br>--log-opt max-file=<span class="hljs-number">2</span> <span class="hljs-string">\</span><br>--name kibana <span class="hljs-string">\</span><br>-p <span class="hljs-number">5601</span>:<span class="hljs-number">5601</span> <span class="hljs-string">\</span><br>--net elastic <span class="hljs-string">\</span><br>kibana:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="4-将容器内的文件复制到主机上-1"><a href="#4-将容器内的文件复制到主机上-1" class="headerlink" title="4. 将容器内的文件复制到主机上"></a>4. 将容器内的文件复制到主机上</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker cp kibana:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>config <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>        <br>docker cp kibana:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>data <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>        <br>docker cp kibana:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>plugins <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span> <br>docker cp kibana:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>logs <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>  <br></code></pre></td></tr></table></figure><h3 id="5-修改配置文件-1"><a href="#5-修改配置文件-1" class="headerlink" title="5. 修改配置文件"></a>5. 修改配置文件</h3><p> <code>/etc/elk8.4.3/kibana/config/kibana.yml</code></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">server</span>.host: <span class="hljs-string">&quot;0.0.0.0&quot;</span><br><span class="hljs-attribute">server</span>.shutdownTimeout: <span class="hljs-string">&quot;5s&quot;</span><br><span class="hljs-attribute">elasticsearch</span>.hosts:<span class="hljs-meta"> [ &quot;http://192.168.3.17:9200&quot; ]</span><br><span class="hljs-attribute">elasticsearch</span>.username: <span class="hljs-string">&quot;kibana_system&quot;</span><br><span class="hljs-attribute">elasticsearch</span>.password: <span class="hljs-string">&quot;sith-mes&quot;</span><br><span class="hljs-attribute">monitoring</span>.ui.container.elasticsearch.enabled: true<br><span class="hljs-attribute">i18n</span>.locale: <span class="hljs-string">&quot;en&quot;</span><br><span class="hljs-attribute">xpack</span>.encryptedSavedObjects.encryptionKey: dcbf<span class="hljs-number">819</span>d<span class="hljs-number">8874</span>e<span class="hljs-number">8242</span>eaf<span class="hljs-number">107</span>d<span class="hljs-number">538</span>fe<span class="hljs-number">874</span><br><span class="hljs-attribute">xpack</span>.reporting.encryptionKey: ba<span class="hljs-number">2</span>d<span class="hljs-number">98</span>e<span class="hljs-number">6</span>dad<span class="hljs-number">4</span>fa<span class="hljs-number">73</span>d<span class="hljs-number">77</span>f<span class="hljs-number">5</span>f<span class="hljs-number">34</span>a<span class="hljs-number">568</span>cfdd<br><span class="hljs-attribute">xpack</span>.security.encryptionKey: <span class="hljs-number">3871</span>dfc<span class="hljs-number">1</span>bd<span class="hljs-number">945</span>e<span class="hljs-number">1141364</span>e<span class="hljs-number">4244800</span>b<span class="hljs-number">39</span><br></code></pre></td></tr></table></figure><p>⚠️<strong>这里的用户是 kibana_system</strong></p><h3 id="6-删除容器-1"><a href="#6-删除容器-1" class="headerlink" title="6. 删除容器"></a>6. 删除容器</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">docker rm <span class="hljs-string">/kibana</span><br></code></pre></td></tr></table></figure><h3 id="7-修改docker启动脚本，增加-v挂载目录-1"><a href="#7-修改docker启动脚本，增加-v挂载目录-1" class="headerlink" title="7. 修改docker启动脚本，增加-v挂载目录"></a>7. 修改docker启动脚本，增加-v挂载目录</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gradle">docker run -it \<br>  -d \<br>  --restart=always \<br>  --log-driver json-<span class="hljs-keyword">file</span> \<br>  --log-opt max-<span class="hljs-keyword">size</span>=<span class="hljs-number">100</span>m \<br>  --log-opt max-<span class="hljs-keyword">file</span>=<span class="hljs-number">2</span> \<br>  --name kibana \<br>  -p <span class="hljs-number">5601</span>:<span class="hljs-number">5601</span> \<br>  --net elastic \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>config:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>config \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>data:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>data \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>plugins:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>plugins \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/kibana/</span>logs:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/kibana/</span>logs \<br>  kibana:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span><br><br></code></pre></td></tr></table></figure><h3 id="8-配置索引生命周期"><a href="#8-配置索引生命周期" class="headerlink" title="8. 配置索引生命周期"></a>8. 配置索引生命周期</h3><ol><li><p>配置策略 Index Lifecycle Policies</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ao_623ea326-f24e-4ebb-9b9c-d41cc894e9ag.jpg" alt="img_v3_02ao_623ea326-f24e-4ebb-9b9c-d41cc894e9ag"></p></li><li><p>创建索引模板</p></li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;template&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;settings&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;lifecycle&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;自定义的policy&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;routing&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;allocation&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;include&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;_tier_preference&quot;</span>: <span class="hljs-string">&quot;data_content&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        <span class="hljs-attr">&quot;number_of_shards&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>,<br>        <span class="hljs-attr">&quot;number_of_replicas&quot;</span>: <span class="hljs-string">&quot;0&quot;</span><br>      &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;aliases&quot;</span>: &#123;&#125;,<br>    <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;&#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li><p>给索引策略上加索引模板</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/img_v3_02ao_a2e5305a-307f-4d19-a05a-17abb32f599g.jpg" alt="img_v3_02ao_a2e5305a-307f-4d19-a05a-17abb32f599g"></p></li></ol><h2 id="2-4-安装logstash"><a href="#2-4-安装logstash" class="headerlink" title="2.4 安装logstash"></a>2.4 安装logstash</h2><h3 id="1-拉取镜像-2"><a href="#1-拉取镜像-2" class="headerlink" title="1. 拉取镜像"></a>1. 拉取镜像</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull logstash:<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="2-创建挂载目录并授权-2"><a href="#2-创建挂载目录并授权-2" class="headerlink" title="2. 创建挂载目录并授权"></a>2. 创建挂载目录并授权</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mkdir</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/logstash<br><span class="hljs-attribute">sudo</span> chown -R <span class="hljs-number">1000</span>:<span class="hljs-number">1000</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/logstash<br></code></pre></td></tr></table></figure><h3 id="3-第一次执行docker启动脚本-2"><a href="#3-第一次执行docker启动脚本-2" class="headerlink" title="3. 第一次执行docker启动脚本"></a>3. 第一次执行docker启动脚本</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run -<span class="hljs-literal">it</span> <span class="hljs-string">\</span><br>-d <span class="hljs-string">\</span><br>--name logstash <span class="hljs-string">\</span><br>-p <span class="hljs-number">9600</span>:<span class="hljs-number">9600</span> <span class="hljs-string">\</span><br>-p <span class="hljs-number">5044</span>:<span class="hljs-number">5044</span> <span class="hljs-string">\</span><br>--net elastic <span class="hljs-string">\</span><br>logstash:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="4-将容器内的文件复制到主机上-2"><a href="#4-将容器内的文件复制到主机上-2" class="headerlink" title="4. 将容器内的文件复制到主机上"></a>4. 将容器内的文件复制到主机上</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker cp logstash:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/logstash/</span>config <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/logstash/</span> <br>docker cp logstash:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/logstash/</span>pipeline <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/logstash/</span> <br>sudo cp <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/elasticsearch/</span>config<span class="hljs-regexp">/certs /</span>etc<span class="hljs-regexp">/elk8.4.3/</span>logstash<span class="hljs-regexp">/config/</span>certs<br></code></pre></td></tr></table></figure><h3 id="5-修改配置文件-2"><a href="#5-修改配置文件-2" class="headerlink" title="5. 修改配置文件"></a>5. 修改配置文件</h3><ul><li><code>/etc/elk8.4.3/logstash/config/logstash.yml</code></li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">http<span class="hljs-selector-class">.host</span>: <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>xpack<span class="hljs-selector-class">.monitoring</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.hosts</span>: <span class="hljs-selector-attr">[ <span class="hljs-string">&quot;http://192.168.3.17:9200&quot;</span> ]</span><br>xpack<span class="hljs-selector-class">.monitoring</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.username</span>: elastic<br>xpack<span class="hljs-selector-class">.monitoring</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.password</span>: sith-mes<br></code></pre></td></tr></table></figure><ul><li><code>/etc/elk8.4.3/logstash/pipeline/logstash.conf</code></li></ul><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">input</span> &#123;<br>  beats &#123;<br>    <span class="hljs-attr">port</span> =&gt; <span class="hljs-number">5044</span><br>  &#125;<br>&#125;<br> <br><span class="hljs-keyword">filter</span> &#123;<br>      grok &#123;  <br>      <span class="hljs-attr">match</span> =&gt; &#123;<span class="hljs-string">&quot;message&quot;</span> =&gt; <span class="hljs-string">&quot;\[%&#123;TIMESTAMP_ISO8601:time&#125;\] \[%&#123;LOGLEVEL:level&#125;\] \[%&#123;NOTSPACE:threadName&#125;\] \[%&#123;DATA:logger&#125;\] \[%&#123;DATA:hostname&#125;\] \[%&#123;DATA:ip&#125;\] \[%&#123;DATA:loginName&#125;\] \[%&#123;DATA:applicationName&#125;\] \[%&#123;DATA:executor&#125;\] %&#123;GREEDYDATA:restInfo&#125;&quot;</span>&#125;<br>    &#125;<br><br>  <span class="hljs-keyword">date</span> &#123;<br>    <span class="hljs-attr">match</span> =&gt; [ <span class="hljs-string">&quot;@timestamp&quot;</span>, <span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span> ]<br>  &#125;<br>  <span class="hljs-keyword">mutate</span> &#123;<br>    <span class="hljs-attr">remove_field</span> =&gt; [<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;host&quot;</span>, <span class="hljs-string">&quot;[event][original]&quot;</span>]<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">output</span> &#123;<br>  elasticsearch &#123;<br>    <span class="hljs-attr">hosts</span> =&gt; [<span class="hljs-string">&quot;http://192.168.3.17:9200&quot;</span>]<br>    <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">&quot;log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>    <span class="hljs-comment"># ssl =&gt; true</span><br>    <span class="hljs-comment"># ssl_certificate_verification =&gt; false</span><br>    <span class="hljs-comment"># cacert =&gt; &quot;/usr/share/logstash/config/certs/http_ca.crt&quot;</span><br>    <span class="hljs-comment"># ca_trusted_fingerprint =&gt; &quot;第一次启动elasticsearch是保存的信息中查找&quot;</span><br>    <span class="hljs-attr">user</span> =&gt; <span class="hljs-string">&quot;elastic&quot;</span><br>    <span class="hljs-attr">password</span> =&gt; <span class="hljs-string">&quot;sith-mes&quot;</span><br>  &#125;<br></code></pre></td></tr></table></figure><h3 id="6-删除容器-2"><a href="#6-删除容器-2" class="headerlink" title="6. 删除容器"></a>6. 删除容器</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">docker rm <span class="hljs-string">/logstash</span><br></code></pre></td></tr></table></figure><h3 id="7-修改docker启动脚本，增加-v挂载目录-2"><a href="#7-修改docker启动脚本，增加-v挂载目录-2" class="headerlink" title="7. 修改docker启动脚本，增加-v挂载目录"></a>7. 修改docker启动脚本，增加-v挂载目录</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -it \<br>  -d \<br>  --name logstash \<br>  -p <span class="hljs-number">9600</span>:<span class="hljs-number">9600</span> \<br>  -p <span class="hljs-number">5044</span>:<span class="hljs-number">5044</span> \<br>  --net elastic \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/logstash/</span>config:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/logstash/</span>config \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/logstash/</span>pipeline:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/logstash/</span>pipeline \<br>  logstash:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h2 id="2-5-安装filebeat"><a href="#2-5-安装filebeat" class="headerlink" title="2.5 安装filebeat"></a>2.5 安装filebeat</h2><h3 id="1-拉取镜像-3"><a href="#1-拉取镜像-3" class="headerlink" title="1. 拉取镜像"></a>1. 拉取镜像</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull elastic/filebeat:<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h3 id="2-创建挂载目录并授权-3"><a href="#2-创建挂载目录并授权-3" class="headerlink" title="2. 创建挂载目录并授权"></a>2. 创建挂载目录并授权</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mkdir</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/filebeat<br><span class="hljs-attribute">sudo</span> chown -R <span class="hljs-number">1000</span>:<span class="hljs-number">1000</span> /etc/elk<span class="hljs-number">8</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>/filebeat<br></code></pre></td></tr></table></figure><h3 id="3-第一次执行docker启动脚本-3"><a href="#3-第一次执行docker启动脚本-3" class="headerlink" title="3. 第一次执行docker启动脚本"></a>3. 第一次执行docker启动脚本</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run -<span class="hljs-literal">it</span> <span class="hljs-string">\</span><br>-d <span class="hljs-string">\</span><br>--name filebeat <span class="hljs-string">\</span><br>--network host <span class="hljs-string">\</span><br>-e TZ=Asia/Shanghai <span class="hljs-string">\</span><br>elastic/filebeat:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span> <span class="hljs-string">\</span><br>filebeat -e  -c /usr/share/filebeat/filebeat.yml<br></code></pre></td></tr></table></figure><h3 id="4-将容器内的文件复制到主机上-3"><a href="#4-将容器内的文件复制到主机上-3" class="headerlink" title="4. 将容器内的文件复制到主机上"></a>4. 将容器内的文件复制到主机上</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker cp filebeat:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>filebeat.yml <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/filebeat/</span> <br>docker cp filebeat:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>data <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/filebeat/</span> <br>docker cp filebeat:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>logs <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/filebeat/</span> <br></code></pre></td></tr></table></figure><h3 id="5-修改配置文件-3"><a href="#5-修改配置文件-3" class="headerlink" title="5. 修改配置文件"></a>5. 修改配置文件</h3><ul><li><code>/etc/elk8.4.3/filebeat/filebeat.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">filebeat.config:</span><br>  <span class="hljs-attr">modules:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;path.config&#125;/modules.d/*.yml</span><br>    <span class="hljs-attr">reload.enabled:</span> <span class="hljs-literal">false</span><br><br><span class="hljs-attr">processors:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">add_cloud_metadata:</span> <span class="hljs-string">~</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">add_docker_metadata:</span> <span class="hljs-string">~</span><br><br><span class="hljs-attr">output.logstash:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># The Logstash hosts</span><br>  <span class="hljs-attr">hosts:</span> [<span class="hljs-string">&quot;192.168.3.17:5044&quot;</span>]<br> <br><span class="hljs-attr">filebeat.inputs:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">log</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">paths:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/share/filebeat/target/*/info.log</span>  <span class="hljs-comment"># 这个路径是需要收集的日志路径，是docker容器中的路径</span><br>  <span class="hljs-attr">scan_frequency:</span> <span class="hljs-string">10s</span><br>  <span class="hljs-attr">exclude_lines:</span> [<span class="hljs-string">&#x27;HEAD&#x27;</span>]<br>  <span class="hljs-attr">exclude_lines:</span> [<span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>]<br>  <span class="hljs-attr">multiline.pattern:</span> <span class="hljs-string">&#x27;^[[:space:]]+(at|\.&#123;3&#125;)\b|Exception|捕获异常&#x27;</span><br>  <span class="hljs-attr">multiline.negate:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">multiline.match:</span> <span class="hljs-string">after</span><br></code></pre></td></tr></table></figure><h3 id="6-删除容器-3"><a href="#6-删除容器-3" class="headerlink" title="6. 删除容器"></a>6. 删除容器</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">docker rm <span class="hljs-string">/filebeat</span><br></code></pre></td></tr></table></figure><h3 id="7-修改docker启动脚本，增加-v挂载目录-3"><a href="#7-修改docker启动脚本，增加-v挂载目录-3" class="headerlink" title="7. 修改docker启动脚本，增加-v挂载目录"></a>7. 修改docker启动脚本，增加-v挂载目录</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -it \<br>  -d \<br>  --name filebeat \<br>  --network host \<br>  -e TZ=Asia/Shanghai \<br>  -v <span class="hljs-regexp">/home/</span>sith<span class="hljs-regexp">/deploy/</span>backend<span class="hljs-regexp">/logs:/u</span>sr<span class="hljs-regexp">/share/</span>filebeat/target \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/filebeat/</span>filebeat.yml:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>filebeat.yml \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/filebeat/</span>data:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>data \<br>  -v <span class="hljs-regexp">/etc/</span>elk8.<span class="hljs-number">4.3</span><span class="hljs-regexp">/filebeat/</span>logs:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>logs \<br>  elastic/filebeat:<span class="hljs-number">8.4</span>.<span class="hljs-number">3</span> \<br>  filebeat -e  -c <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/filebeat/</span>filebeat.yml<br></code></pre></td></tr></table></figure><p>⚠️： ES映射的data和log比较大，建议放在磁盘空间比较足的目录。</p><p>附：docker-compose.yml文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">tms:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">elasticsearch:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">elasticsearch:8.4.3</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">&quot;root&quot;</span>  <span class="hljs-comment"># 设置容器内用户为 root</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">discovery.type=single-node</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ELASTIC_PASSWORD=plm1234567890</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9200</span><span class="hljs-string">:9200</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9300</span><span class="hljs-string">:9300</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/config:/usr/share/elasticsearch/config</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/data:/usr/share/elasticsearch/data</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/plugins:/usr/share/elasticsearch/plugins</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./elasticsearch/logs:/usr/share/elasticsearch/logs</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br><br>  <span class="hljs-attr">logstash:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">logstash:8.4.3</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">logstash</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">&quot;root&quot;</span>  <span class="hljs-comment"># 设置容器内用户为 root</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;5044:5044&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./logstash/config:/usr/share/logstash/config</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./logstash/pipeline:/usr/share/logstash/pipeline</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br><br>  <span class="hljs-attr">kibana:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">kibana:8.4.3</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kibana</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">&quot;root&quot;</span>  <span class="hljs-comment"># 设置容器内用户为 root</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">5601</span><span class="hljs-string">:5601</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./kibana/config:/usr/share/kibana/config</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./kibana/data:/usr/share/kibana/data</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./kibana/plugins:/usr/share/kibana/plugins</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./kibana/logs:/usr/share/kibana/logs</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br><br>  <span class="hljs-attr">filebeat:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">elastic/filebeat:8.4.3</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">filebeat</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">&quot;root&quot;</span>  <span class="hljs-comment"># 设置容器内用户为 root</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/Z004NNRE/tms/deploy/backend/assistant-service/logs:/usr/share/filebeat/target/assistant-service</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/Z004NNRE/tms/deploy/backend/auth-service/logs:/usr/share/filebeat/target/auth-service</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/Z004NNRE/tms/deploy/backend/user-service/logs:/usr/share/filebeat/target/user-service</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/Z004NNRE/tms/deploy/backend/tms-service/logs:/usr/share/filebeat/target/tms-service</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/Z004NNRE/tms/deploy/backend/gateway-server/logs:/usr/share/filebeat/target/gateway-server</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/Z004NNRE/tms/deploy/backend/eureka-server/logs:/usr/share/filebeat/target/eureka-server</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./filebeat/data:/usr/share/filebeat/data</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./filebeat/logs:/usr/share/filebeat/logs</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">logstash</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tms</span><br><br></code></pre></td></tr></table></figure><p><strong>注意：Docker中出现bash: vim: command not found解决方案</strong></p><p>解决这个问题其实非常简单：只需要在你的Docker容器内安装vim即可。具体步骤如下：</p><ol><li><p>首先打开你正在运行的docker容器：<br><code>docker exec -it [container_id] /bin/bash</code></p></li><li><p>进入到了docker环境后, 我们可以通过apt-get（如果您使用基于Debian或Ubuntu等Linux发行版）或yum（如果您使用基于CentOS等Linux发行版）来安装Vim：</p><ul><li><code>apt-get update &amp;&amp; apt-get install vim -y   </code>Debian&#x2F;Ubuntu等系统 </li><li>CentOS&#x2F;RHEL等系统<code>yum update &amp;&amp; yum install vim -y </code></li></ul></li><li><p>以上步骤虽然能够解决问题，但每次创建新的Docker容器时，都需要手动执行这些步骤，显然不是一个理想的解决方案。更好的方法是在Dockerfile中添加安装vim编辑器的命令。这样，在构建docker镜像时就会自动安装vim。</p><p>在你的Dockerfile中添加以下命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cobol">RUN apt-get update &amp;&amp; apt-get install vim -y  # Debian/Ubuntu等系统<br> <br>RUN yum update &amp;&amp; yum install vim -y  # CentOS/RHEL等系统<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>springboot引入flyway</title>
    <link href="/springboot%E5%BC%95%E5%85%A5flyway/"/>
    <url>/springboot%E5%BC%95%E5%85%A5flyway/</url>
    
    <content type="html"><![CDATA[<h1 id="1-flyway-是什么？"><a href="#1-flyway-是什么？" class="headerlink" title="1. flyway 是什么？"></a>1. flyway 是什么？</h1><p>Flyway 就是一款数据库界的版本控制工具，它可以记录数据库的变化记录</p><p><strong>为什么需要它？</strong></p><p>目前通过人工去维护、同步数据库脚本，但经常会遇到疏忽而遗漏的情况，比如我们在开发环境对某个表新增了一个字段，而部署到线上时却忘了执行该 SQL 脚本，导致出现 bug。</p><p>有了 Flyway，在Spring boot项目启动时，会自动执行flyway定义的 SQL ，而无需人为手工控制，再也不用担心因数据库不同步而导致的各种环境问题。</p><h1 id="2-springboot引入flyway"><a href="#2-springboot引入flyway" class="headerlink" title="2. springboot引入flyway"></a>2. springboot引入flyway</h1><h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><p>pom.xml增加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flywaydb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flyway-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-支持maven编译sql文件-根据情况，可以不配"><a href="#2-支持maven编译sql文件-根据情况，可以不配" class="headerlink" title="2. 支持maven编译sql文件(根据情况，可以不配)"></a>2. 支持maven编译sql文件(根据情况，可以不配)</h2><p>pom.xml增加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.sql<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-添加配置"><a href="#2-添加配置" class="headerlink" title="2. 添加配置"></a>2. 添加配置</h2><p>application.yml增加</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">flyway:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">## 开启flyway, sithMesDev不开启为false</span><br>    <span class="hljs-attr">baseline-on-migrate:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#对于已经存在的项目，数据库中存在数据，通过设置baseline告诉flyway，这个baseline及之前的sql脚本都不要执行了</span><br>    <span class="hljs-attr">locations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">classpath:db.migration</span> <span class="hljs-comment">#指定项目中需要迁移的sql文件在哪个位置，在springboot项目中classpath指的是resource文件夹</span><br>    <span class="hljs-attr">table:</span> <span class="hljs-string">flyway_schema_history_xxx</span> <span class="hljs-comment"># 版本控制日志表，默认flyway_schema_history,不同系统建议修改表名，如flyway_schema_history_admin</span><br></code></pre></td></tr></table></figure><h2 id="3-创建迁移所需要的脚本"><a href="#3-创建迁移所需要的脚本" class="headerlink" title="3. 创建迁移所需要的脚本"></a>3. 创建迁移所需要的脚本</h2><p>在项目src&#x2F;main&#x2F;resources下新建文件夹层级db&#x2F;migration，将需要执行的sql文件放进去</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231109154251326.png" alt="image-20231109154251326"></p><h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4 测试"></a>4 测试</h2><p>重启项目，可以观察控制会出现：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231109154142159.png" alt="image-20231109154142159"></p>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>权限系统设计</title>
    <link href="/%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    <url>/%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<p><strong>权限管理是公司数据安全的重要保证，针对不同的岗位，不同的级别看到的数据是不一样的，操作数据的限制也是不一样的。</strong></p><blockquote><p>如何让各个岗位的人在系统上各司其职，就是权限管理要解决的问题。</p></blockquote><h1 id="1-权限设计"><a href="#1-权限设计" class="headerlink" title="1. 权限设计"></a>1. 权限设计</h1><p>业务分类上来讲权限可以分为数据查看权限，数据修改权限等。</p><p>对应到系统设计中有页面权限、菜单权限、按钮权限等。菜单也分一级菜单、二级菜单甚至三级菜单，菜单对应的页面里又有很多按钮。</p><p>我们在设计的时候最好把权限设计成树形结构，这样在申请权限的时候就可以一目了然的看到菜单的结构，需要哪些权限就非常的明了了。</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005205506829.png" alt="image-20231005205506829" style="zoom:50%;" /><h1 id="2-权限模型的演进"><a href="#2-权限模型的演进" class="headerlink" title="2.权限模型的演进"></a>2.权限模型的演进</h1><p><code>RBAC</code>全称为基于角色的访问控制模型（<code>Role-based access control</code>），在该模型中，通过让权限与角色关联来实现授权，给用户分配一系列的角色来让注册用户得到这些角色对应的权限。</p><h3 id="1-RBAC0-x2F-基本模型"><a href="#1-RBAC0-x2F-基本模型" class="headerlink" title="1. RBAC0&#x2F;基本模型"></a>1. RBAC0&#x2F;基本模型</h3><p><code>RBAC0</code>是最基本的模型，未做特殊要求和扩展，在该模型中，一个用户可以同时拥有多个角色，每个角色可以拥有多个权限。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231121113023361.png" alt="image-20231121113023361"></p><p><strong>表设计</strong>：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231121114418238.png" alt="image-20231121114418238"></p><h3 id="2-RBAC1-x2F-角色继承的RBAC模型"><a href="#2-RBAC1-x2F-角色继承的RBAC模型" class="headerlink" title="2. RBAC1&#x2F;角色继承的RBAC模型"></a>2. RBAC1&#x2F;角色继承的RBAC模型</h3><p>由于具有公司的岗位具有上下级关系，且上级拥有下级的所有权限，所以不同的角色之间存在着重叠的权限，如：</p><ul><li><p>员工：员工的权限</p></li><li><p>主管：员工的权限、主管的权限</p></li><li><p>老板：员工的权限、主管的权限、老板的权限</p></li></ul><blockquote><p>存在的弊端是：每当增加一条员工的权限，都需要同时绑定给【员工】、【主管】和【老板】。倘若将【老板】漏了，那么就会出现【员工有权限，而老板没权限】的情况了。</p></blockquote><p><strong>设计思路</strong>：上层角色默认拥有下层角色的所有权限。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231121113513733.png" alt="image-20231121113513733"></p><p>表设计：需要在刚才的基础上增加角色继承表，来记录角色之间的继承关系，包括两个字段角色ID和父角色ID</p><h3 id="3-RBAC2-x2F-带约束的RBAC模型"><a href="#3-RBAC2-x2F-带约束的RBAC模型" class="headerlink" title="3. RBAC2&#x2F;带约束的RBAC模型"></a>3. RBAC2&#x2F;带约束的RBAC模型</h3><p>带约束的RBAC模型又称RBAC2模型。<strong>基于RBAC0模型的基础上，进行了角色的访问控制。</strong>此模型中常用以下限制：</p><ul><li><p>互斥角色：同一个用户在两个互斥角色中只能选择一个。</p></li><li><p>基数约束：一个用户拥有的角色是有限的，一个角色拥有的权限也是有限的。</p></li><li><p>先决条件约束：用户想要获得上层角色，首先必须拥有下层角色。</p></li><li><p>运行时互斥 ：允许一个用户具有两个角色，一次鉴权只能使用一个角色。</p></li></ul><h1 id="3-用户划分"><a href="#3-用户划分" class="headerlink" title="3. 用户划分"></a>3. 用户划分</h1><h2 id="1-用户组（组织）"><a href="#1-用户组（组织）" class="headerlink" title="1 用户组（组织）"></a>1 用户组（组织）</h2><p>如果用户数量比较庞大，可以加入用户组模式。需要给用户分组，每个用户组内有多个用户，可以给用户加角色外，也可以给用户组加角色。最终用户拥有的所有权限 &#x3D; 用户个人拥有的权限+该用户所在用户组拥有的权限。</p><p>优势：</p><ul><li><strong>实现权限分配的自动化：</strong> 和组织关系打通之后，按照组织来分配角色，如果有新入职的用户，被划分在某个组织下面之后，会自动获取该组织下所有的权限，无需人工分配。又比如有用户调岗，只需要把组织关系调整就可以了，权限会跟着组织关系自动调整。</li><li><strong>控制数据权限：</strong> 把角色关联到组织，组织里的成员只能看到本组织下的数据，比如市场推广和大客定制，市场推广针对的是零散的客户，大可定制针对的是有一定体量的客户，相互的数据虽然在一个平台，但是只能看自己组织下的数据。</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231121143805877.png" alt="image-20231121143805877"></p><p>表设计：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231121145331930.png" alt="image-20231121145331930"></p><h1 id="4-实战演练"><a href="#4-实战演练" class="headerlink" title="4. 实战演练"></a>4. 实战演练</h1><p>业务分类上来讲权限可以分为数据查看权限，数据修改权限等。</p><p>我们目前是基于<code>RBAC0</code>， 最基本的模型，未做特殊要求和扩展，在该模型中，一个用户可以同时拥有多个角色，每个角色可以拥有多个权限。</p><h2 id="1-表设计："><a href="#1-表设计：" class="headerlink" title="1. 表设计："></a>1. 表设计：</h2><p><strong>基础表：</strong></p><ul><li><p>用户 User：id, name</p></li><li><p>角色 Role:   id, name, code</p></li><li><p>权限模块 Acl_Module：name, parent_id, level, code</p></li><li><p>权限ACl : id, name, acl_module_id, parent_id, url, type(按钮，请求地址)</p></li></ul><p><strong>关系表：</strong></p><ul><li>用户-角色关系表</li><li>角色权限关系表</li></ul><h2 id="2-后端逻辑"><a href="#2-后端逻辑" class="headerlink" title="2. 后端逻辑"></a>2. 后端逻辑</h2><ol><li>新建权限点，菜单或者按钮（url是请求地址）</li><li>创建角色，设置角色名称， 角色读写权限等级（增&#x2F;删&#x2F;改&#x2F;查）中的组合。给这个权限配置新建的权限点以及对应的人</li></ol><p>（增删改查，分别对应2，3，5，7 这样的话，数据库只需要存一位去记录，当然存0101这种也行）</p><ol start="3"><li>在权限拦截器增加校验<ol><li>获取当前登录用户可以访问的权限列表</li><li>将权限列表和当前请求做比较，需满足以下两个条件，即可放行，否则提示没有权限<ul><li>请求URL在当前权限URL列表里</li></ul></li><li>当前访问的method也在权限URL列表里（这里需要后端使用restful请求，即增删改查对应 POST，DELETE， PUT，GET， 或者后端带标识过来）</li></ol></li></ol><h2 id="3-前端逻辑"><a href="#3-前端逻辑" class="headerlink" title="3. 前端逻辑"></a>3. 前端逻辑</h2><ol><li>前端在用户登录后，就在localstory里存储了，调用当前user的权限列表的结果，只有用户退出登录后，才会更新</li></ol><p>目前没有考虑角色继承和互斥，权限委托</p><h1 id="5-除了RBAC还有哪些实现权限的方式？"><a href="#5-除了RBAC还有哪些实现权限的方式？" class="headerlink" title="5. 除了RBAC还有哪些实现权限的方式？"></a>5. 除了RBAC还有哪些实现权限的方式？</h1>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>抽象工厂模式</title>
    <link href="/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>在工厂父类定义一个创建对象的接口，而工厂子类则负责生成<strong>一组相关的对象</strong>。这些对象之间通常有某种关联或依赖关系。</p><p>抽象工厂模式适用于需要创建多个相关对象并确保它们之间的一致性的情况。</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>客户端不依赖某个产品实例具体如何创建</li><li>强调一系列相关的产品对象一起创建使用</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li><p>用户只需要关心产品所需工厂，无需关心创建细节</p></li><li><p>将一个系列的产品族统一到一起创建：抽象工厂模式通过一组相关的工厂类来创建一系列相关或依赖的对象，确保了这些对象之间的一致性。这意味着创建的对象是相互配合、一起使用的，能够满足特定的需求或目标。</p></li></ul><p>缺点：</p><ul><li>产品族中扩展新的产品困难</li><li>增加了系统的抽象性和理解难度</li></ul><blockquote><p>产品族是指一组相关联或依赖的产品，它们在功能、特性或目标上具有一定的相似性或关联性。产品族通常由多个具体产品组成，每个具体产品属于同一个产品族。</p><p>举例来说，假设有一个汽车制造系统，其中包含了多个产品族：轿车产品族、SUV产品族和卡车产品族。每个产品族包含了各自的具体产品，如轿车产品族可能包含了轿车的具体型号（如小型轿车、中型轿车、豪华轿车等），SUV产品族可能包含了SUV的具体型号（如紧凑型SUV、中型SUV、全尺寸SUV等）</p></blockquote><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景： 不同的课程，配置的博客和视频都是不一样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 博客</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaArticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Article</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;编写Java课程博客&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PythonArticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Article</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;编写Python课程博客&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 视频</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaVideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;录制Java课程视频&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PythonVideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;录制Python课程视频&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 课程工厂接口，创建不同课程的视频和博客</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseFactory</span> </span>&#123;<br>    <span class="hljs-function">Video <span class="hljs-title">getVideo</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function">Article <span class="hljs-title">getArticle</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaCourseFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseFactory</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JavaVideo();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Article <span class="hljs-title">getArticle</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JavaArticle();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PythonCourseFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseFactory</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PythonVideo();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Article <span class="hljs-title">getArticle</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PythonArticle();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        CourseFactory courseFactory = <span class="hljs-keyword">new</span> JavaCourseFactory();<br>        Video video = courseFactory.getVideo();<br>        Article article = courseFactory.getArticle();<br>        video.produce();<br>        article.produce();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>录制Java课程视频<br>编写Java课程博客</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>工厂模式</title>
    <link href="/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>工厂模式，又称工厂方法模式。在工厂父类定义一个创建对象的接口，而工厂子类则负责生成具体的对象。每个具体工厂类根据需要创建不同的对象，从而实现了对象的创建和使用的解耦。</p><p>类型：创建型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>创建对象需要大量重复代码</li><li>客户端不依赖某个产品实例具体如何创建</li><li>一个类通过子类来指定创建哪个对象</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>用户只需要关心产品所需工厂，无需关心创建细节</li><li>符合开闭原则</li></ul><p>缺点：</p><ul><li>类的个数容易多，增加复杂度</li><li>增加了系统的抽象性和理解难度</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景： 需要根据电影类型创建电影</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 抽象产品类 ，定义具体产品的公共接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaVideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;录制Java课程视频&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PythonVideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;录制Python课程视频&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建抽象工厂类，定义具体工厂的公共接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoFactory</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaVideoFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">VideoFactory</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JavaVideo();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PythonVideoFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">VideoFactory</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PythonVideo();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        VideoFactory pythonVideoFactory = <span class="hljs-keyword">new</span> PythonVideoFactory();<br>        VideoFactory javaVideoFactory = <span class="hljs-keyword">new</span> JavaVideoFactory();<br>        Video pythonVideo = pythonVideoFactory.getVideo();<br>        pythonVideo.produce();<br>        Video javaVideo = javaVideoFactory.getVideo();<br>        javaVideo.produce();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>录制Python课程视频<br>录制Java课程视频</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>代理模式</title>
    <link href="/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>为对象提供代理，以控制对这个对象的访问</p><p>代理对象在客户端和目标对象之间起到中介作用</p><p><strong>分类</strong>：静态代理和动态代理</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>保护目标对象</li><li>增强目标对象</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>代理模式可以将代理对象和目标对象接耦，扩展性好</li><li>增强目标对象</li></ul><p>缺点：</p><ul><li>造成类数目增加</li><li>在客户端和目标对象间增加了一个代理对象，会导致请求速度变慢</li><li>增加系统复杂度</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：发送邮件前进行额外的操作</p><ul><li>静态代理</li></ul><p> 由程序员创建或特定工具自动生成源代码，再对其编译。在程序运行前，代理类的.class文件就已经存在了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Email</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlashEmail</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Email</span> </span>&#123;<br> <br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">// TODO Auto-generated method stub</span><br>            System.out.println(<span class="hljs-string">&quot;邮件发送中。。。。。&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 代理类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Email</span> </span>&#123;<br> <br>Email email;<br>  <br>  <span class="hljs-comment">//传入委托类初始化代理类</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EmailProxy</span><span class="hljs-params">(Email email)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">this</span>.email=email;<br>&#125;<br>  <br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;发送邮件前准备。。。&quot;</span>);<br>            email.send();<br>            System.out.println(<span class="hljs-string">&quot;邮件发送后。。。。。。&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br> <br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><span class="hljs-comment">//原始对象</span><br>   Email email=<span class="hljs-keyword">new</span> FlashEmail();<br>   EmailProxy emailProxy=<span class="hljs-keyword">new</span> EmailProxy(email);<br>   emailProxy.send();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>发送邮件前准备。。。<br>邮件发送中。。。。。<br>邮件发送后。。。。。。</p><ul><li><p>动态代理</p><p>动态代理类的字节码在程序运行时由Java反射机制动态生成，无需程序员手工编写它的源代码。</p><p>java.lang.reflect 包中的Proxy类和InvocationHandler 接口提供了生成动态代理类的能力。这一个类和接口是实现我们动态代理所必须用到的。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailDynamicProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br> <br>Object target;<span class="hljs-comment">//委托对象</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EmailDynamicProxy</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br><span class="hljs-keyword">super</span>();<br><span class="hljs-keyword">this</span>.target = obj;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">bind</span><span class="hljs-params">()</span></span>&#123;<br>Class cls = target.getClass();<br><span class="hljs-keyword">return</span> Proxy.newProxyInstance(cls.getClassLoader(),cls.getInterfaces(),<span class="hljs-keyword">this</span>);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>System.out.println(<span class="hljs-string">&quot;发送邮件前准备。。。&quot;</span>);<br>    <span class="hljs-comment">//从委托对象中，调用该对象的指定方法，这里相当于send方法</span><br>method.invoke(target);<br>System.out.println(<span class="hljs-string">&quot;发送后。。。。。。&quot;</span>);<br><span class="hljs-keyword">return</span> target;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Email email = <span class="hljs-keyword">new</span> FlashEmail();<br>        Email emailProxy = (Email) <span class="hljs-keyword">new</span> EmailDynamicProxy(email).bind();<br>        emailProxy.send();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>状态模式</title>
    <link href="/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>当一个对象内在状态改变时允许改变其行为。比如：停止状态下，不允许快进视频这个行为</p><p>类型：行为型</p><p><strong>核心角色</strong></p><ol><li>环境类（Context）：环境类是拥有状态的对象。它维护一个指向当前状态对象的引用，并将与状态相关的请求委托给状态对象进行处理。</li><li>抽象状态类（State）：抽象状态类定义了一个接口，用于封装与环境对象相关的行为。它可以根据具体的状态进行具体的行为实现。</li><li>具体状态类（Concrete State）：具体状态类实现了抽象状态类中定义的接口，提供了与具体状态相关的行为实现。</li></ol><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><p>一个对象存在多个状态（不同状态下行为不同），且状态可以转换</p><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>将不同状态隔离</li><li>将各种状态的转换逻辑，分布到state的子类中，减少互相依赖</li><li>增加新的状态简单</li></ul><p>缺点：</p><ul><li>状态多的场景下，导致类数目增加，系统变复杂</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：网站的课程视频有暂停，快进，停止，播放状态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 课程状态抽象类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseVideoState</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span> CourseVideoContext courseVideoContext;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCourseVideoContext</span><span class="hljs-params">(CourseVideoContext courseVideoContext)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideoContext = courseVideoContext;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">play</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">speed</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pause</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 播放状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CourseVideoState</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">play</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;正常播放课程视频状态&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">speed</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.SPEED_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pause</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.PAUSE_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.STOP_STATE);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 快进状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpeedState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CourseVideoState</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">play</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.PLAY_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">speed</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;快进播放课程视频状态&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pause</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.PAUSE_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.STOP_STATE);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 暂停状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PauseState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CourseVideoState</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">play</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.PLAY_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">speed</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.SPEED_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pause</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;暂停播放课程视频状态&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.STOP_STATE);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 停止状态</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StopState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CourseVideoState</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">play</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.courseVideoContext.setCourseVideoState(CourseVideoContext.PLAY_STATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">speed</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;ERROR 停止状态不能快进!!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pause</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;ERROR 停止状态不能暂停!!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;停止播放课程视频状态&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 课程状态上下文</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseVideoContext</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> CourseVideoState courseVideoState;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> PlayState PLAY_STATE = <span class="hljs-keyword">new</span> PlayState();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> StopState STOP_STATE = <span class="hljs-keyword">new</span> StopState();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> PauseState PAUSE_STATE = <span class="hljs-keyword">new</span> PauseState();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> SpeedState SPEED_STATE = <span class="hljs-keyword">new</span> SpeedState();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CourseVideoState <span class="hljs-title">getCourseVideoState</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> courseVideoState;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCourseVideoState</span><span class="hljs-params">(CourseVideoState courseVideoState)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideoState = courseVideoState;<br>        <span class="hljs-keyword">this</span>.courseVideoState.setCourseVideoContext(<span class="hljs-keyword">this</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">play</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideoState.play();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">speed</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideoState.speed();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideoState.stop();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pause</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideoState.pause();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        CourseVideoContext courseVideoContext = <span class="hljs-keyword">new</span> CourseVideoContext();<br>        courseVideoContext.setCourseVideoState(<span class="hljs-keyword">new</span> PlayState());<br><br>        System.out.println(<span class="hljs-string">&quot;当前状态:&quot;</span>+courseVideoContext.getCourseVideoState().getClass().getSimpleName());<br>        courseVideoContext.pause();<br><br>        System.out.println(<span class="hljs-string">&quot;当前状态:&quot;</span>+courseVideoContext.getCourseVideoState().getClass().getSimpleName());<br><br>        courseVideoContext.speed();<br><br>        System.out.println(<span class="hljs-string">&quot;当前状态:&quot;</span>+courseVideoContext.getCourseVideoState().getClass().getSimpleName());<br><br>        courseVideoContext.stop();<br><br>        System.out.println(<span class="hljs-string">&quot;当前状态:&quot;</span>+courseVideoContext.getCourseVideoState().getClass().getSimpleName());<br>        <br>        courseVideoContext.speed();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>当前状态:PlayState<br>当前状态:PauseState<br>当前状态:SpeedState<br>当前状态:StopState<br>ERROR 停止状态不能快进!!</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>访问者模式</title>
    <link href="/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><ul><li><p>它允许在不改变已有对象结构的情况下，定义对这些对象的新操作。</p></li><li><p>有两个核心角色：</p><ul><li>访问者（Visitor）：定义了可以对各种对象结构中元素进行的操作。它抽象出了可以对不同对象执行的操作，并通过不同的具体访问者来实现具体的操作逻辑。</li><li>元素（Element）：定义了一个接受访问者的方法，使得访问者可以访问它的内部状态。元素可以是单个对象，也可以是对象的集合。</li></ul></li><li><p>类型 : 行为型</p></li></ul><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>需要对对象结构中的元素进行多种不相关或不一致的操作，而不希望在元素类中增加这些操作的情况。</li><li>需要对不同类型的元素执行不同的操作，而又不希望使用条件语句或类型判断来实现的情况。</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>增加新的操作很容易 , 只需要增加一个新的访问者即可</li></ul><p>缺点：</p><ul><li><p>增加 新 数据结构比较困难</p></li><li><p>元素变更比较困难 ; 如为被访问的对象增加 &#x2F; 减少一些属性 , 相应的访问者也需要进行修改</p></li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：课程分为免费课程和VIP课程 , 用户分为 免费用户 和 VIP用户 ;不同的用户 , 访问不同的课程 , 各自有不同的效果 ;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当有访问者要访问课程时 , 将访问者传入该方法</span><br><span class="hljs-comment">     * 用于判定访问者是否有权限访问课程</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accept</span><span class="hljs-params">(IVisitor visitor)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreeCourse</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Course</span> </span>&#123;<br>    <br>  <span class="hljs-comment">// 免费课程，接受访问者，来判断访问者是否有权限访问课程</span><br>  <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accept</span><span class="hljs-params">(IVisitor visitor)</span> </span>&#123;<br>        visitor.visit(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VIPCourse</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Course</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> price;<br><br>    <span class="hljs-comment">// VIP课程，接受访问者，来判断访问者是否有权限访问课程</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accept</span><span class="hljs-params">(IVisitor visitor)</span> </span>&#123;<br>        visitor.visit(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 访问者接口, 封装多个Course的访问方式</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IVisitor</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">visit</span><span class="hljs-params">(FreeCourse freeCourse)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">visit</span><span class="hljs-params">(VIPCourse VIPCourse)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VIPVisitor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IVisitor</span> </span>&#123;<br><br>    <span class="hljs-comment">//访问免费课程，打印所有免费课程名称</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">visit</span><span class="hljs-params">(FreeCourse freeCourse)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;我是 VIP, 可以访问:免费课程:&quot;</span>+freeCourse.getName());<br>    &#125;<br><br>    <span class="hljs-comment">//访问VIP课程，打印所有VIP课程名称及价格</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">visit</span><span class="hljs-params">(VIPCourse VIPCourse)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;我是 VIP ,可以访问VIP课程:&quot;</span>+ VIPCourse.getName()+<span class="hljs-string">&quot; 价格:&quot;</span>+ VIPCourse.getPrice()+<span class="hljs-string">&quot;元&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        List&lt;Course&gt; courseList = <span class="hljs-keyword">new</span> ArrayList&lt;Course&gt;();<br><br>        FreeCourse freeCourse = <span class="hljs-keyword">new</span> FreeCourse();<br>        freeCourse.setName(<span class="hljs-string">&quot;SpringMVC数据绑定&quot;</span>);<br><br>        VIPCourse VIPCourse = <span class="hljs-keyword">new</span> VIPCourse();<br>        VIPCourse.setName(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>);<br>        VIPCourse.setPrice(<span class="hljs-number">299</span>);<br><br>        courseList.add(freeCourse);<br>        courseList.add(VIPCourse);<br><br>        <span class="hljs-keyword">for</span>(Course course : courseList)&#123;<br>            course.accept(<span class="hljs-keyword">new</span> VIPVisitor());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>我是 VIP, 可以访问:免费课程:SpringMVC数据绑定<br>我是 VIP ,可以访问VIP课程:Java设计模式精讲 价格:299元</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>责任链模式</title>
    <link href="/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>责任链模式为请求创建了一个接收者对象的链。在这种模式中，通常每个接收者都包含对另一个接收者的引用。如果一个对象不能处理该请求，那么它会把相同的请求传给下一个接收者，依此类推。</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>一个请求需要多个对象中的一个或者多个进行处理</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>责任链可以动态组合</li></ul><p>缺点：</p><ul><li>责任链太长或者处理时间太长，影响性能</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：发布一篇文章后，内容审查者审查内容，审查通过了后，视频审查者审查视频</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> String video;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Approver</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span> Approver approver;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNextApprover</span><span class="hljs-params">(Approver approver)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.approver = approver;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">check</span><span class="hljs-params">(Article article)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContentApprover</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Approver</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">check</span><span class="hljs-params">(Article article)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(article.getContent()))&#123;<br>            System.out.println(article.getName()+<span class="hljs-string">&quot;内容合规,批准&quot;</span>);<br>            <span class="hljs-keyword">if</span>(approver != <span class="hljs-keyword">null</span>)&#123;<br>                approver.check(article);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            System.out.println(article.getName()+<span class="hljs-string">&quot;内容不合规,不批准,流程结束&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoApprover</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Approver</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">check</span><span class="hljs-params">(Article article)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(article.getVideo()))&#123;<br>            System.out.println(article.getName()+<span class="hljs-string">&quot;视频内容合规,批准&quot;</span>);<br>            <span class="hljs-keyword">if</span>(approver != <span class="hljs-keyword">null</span>)&#123;<br>                approver.check(article);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            System.out.println(article.getName()+<span class="hljs-string">&quot;视频内容不合规,不批准,流程结束&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Approver contentApprover = <span class="hljs-keyword">new</span> ContentApprover();<br>        Approver videoApprover = <span class="hljs-keyword">new</span> VideoApprover();<br><br>        Article article = <span class="hljs-keyword">new</span> Article();<br>        article.setName(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>);<br>        article.setContent(<span class="hljs-string">&quot;Java设计模式精讲的内容&quot;</span>);<br>        article.setVideo(<span class="hljs-string">&quot;Java设计模式精讲的视频&quot;</span>);<br><br>        contentApprover.setNextApprover(videoApprover);<br><br>        contentApprover.check(article);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>中介者模式</title>
    <link href="/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>定义一个封装一组对象如何交互的对象</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>对象之间有复杂的通信关系：当对象之间的通信关系变得复杂时，使用中介者模式可以简化对象之间的交互，将复杂的通信逻辑转移到中介者中进行管理。</li><li>对象之间的耦合度较高：当对象之间的耦合度较高，彼此之间的依赖关系较为复杂时，可以使用中介者模式来解耦对象之间的关系，减少对象之间的直接依赖。</li><li>一对多的关系：中介者模式适用于一对多的关系，当一个对象需要与多个其他对象进行通信时，可以引入中介者来简化对象之间的通信。</li><li>分布式系统：中介者模式在分布式系统中也有应用。例如，分布式系统中的消息中间件可以看作是中介者，负责协调不同组件或服务之间的通信和数据交换。</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>解耦对象之间的关系：中介者模式通过将对象之间的通信集中在中介者对象中，将对象之间的直接耦合转换为对象与中介者的耦合。这样一来，对象之间的关系变得松散，可以独立地改变和复用对象和中介者。</li><li>简化对象协议：中介者模式可以简化对象之间的协议。对象只需要与中介者进行通信，不需要了解其他对象的具体实现细节，从而降低了对象之间的复杂性。</li><li>可扩展性和维护性：由于中介者模式将对象之间的通信集中管理，当系统需要增加新的对象时，只需与中介者进行交互即可，无需修改现有对象之间的通信逻辑。这提高了系统的可扩展性和维护性。</li></ul><p>缺点：</p><ul><li>中介者复杂化：随着系统中对象之间通信关系的增加，中介者对象可能变得复杂。它需要处理和管理多个对象之间的交互逻辑，可能会导致中介者本身的复杂性增加。</li><li>单点故障：中介者模式将对象之间的通信集中在中介者对象中，如果中介者对象出现问题或失败，可能会影响整个系统的正常运行。中介者的故障可能会导致通信链路中的所有对象无法正常通信。</li><li>违背单一职责原则：中介者模式可能导致中介者对象承担过多的责任。中介者需要了解和管理多个对象之间的通信关系，可能违背了单一职责原则，使得中介者对象变得庞大和复杂。</li><li>增加系统复杂性：引入中介者模式会增加系统中的额外类和对象，从而增加系统的复杂性。</li><li>通信效率降低：中介者模式可能导致通信效率降低。当系统中的对象需要频繁地进行通信时，由于通信都需要通过中介者进行转发，可能会导致通信的延迟增加。</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：</p><p>用户通过QQ群来进行聊天而不是直接面对面聊</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(String message)</span> </span>&#123;<br>        StudyGroup.showMessage(<span class="hljs-keyword">this</span>, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StudyGroup</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(User user, String message)</span></span>&#123;<br>        System.out.println(<span class="hljs-keyword">new</span> Date() + <span class="hljs-string">&quot; [&quot;</span> + user.getName() + <span class="hljs-string">&quot;] : &quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        User geely = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;Geely&quot;</span>);<br>        User tom= <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;Tom&quot;</span>);<br><br>        geely.sendMessage(<span class="hljs-string">&quot; Hey! Tom! Let&#x27;s learn Design Pattern&quot;</span>);<br>        tom.sendMessage(<span class="hljs-string">&quot;OK! Geely&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>Wed Oct 04 21:43:12 CST 2023 [Geely] :  Hey! Tom! Let’s learn Design Pattern<br>Wed Oct 04 21:43:12 CST 2023 [Tom] : OK! Geely</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>命令模式</title>
    <link href="/%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>将请求或操作封装成一个对象，<strong>从而使不同的请求可以被异步、延迟、排队，或者记录下来以备撤销或重做等操作</strong>。</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>撤销&#x2F;重做操作：当需要支持撤销和重做功能时，可以使用命令模式。命令对象可以记录操作的状态和参数，以便在需要时执行撤销操作</li><li>事务性操作：命令模式可以用于实现事务性操作，即一系列相关操作的执行要么全部成功，要么全部失败。通过将每个操作封装为一个命令对象，可以在需要时执行回滚操作，确保数据的一致性。</li><li>队列请求：命令模式可以用于构建请求队列。每个命令对象都表示一个请求，并且可以按顺序执行这些请求。这在需要按顺序执行一系列操作的情况下很有用。</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>降低耦合</li><li>容易扩展出新命令或者一组命令</li></ul><p>缺点：</p><ul><li>命令会扩展类的数量，从而提高系统复杂度</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：CEO下达打开课程视频和关闭课程视频的操作的命令，员工执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseVideo</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CourseVideo</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">open</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-keyword">this</span>.name+<span class="hljs-string">&quot;课程视频开放&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-keyword">this</span>.name+<span class="hljs-string">&quot;课程视频关闭&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Command</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenCourseVideoCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Command</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> CourseVideo courseVideo;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpenCourseVideoCommand</span><span class="hljs-params">(CourseVideo courseVideo)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideo = courseVideo;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>&#123;<br>        courseVideo.open();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CloseCourseVideoCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Command</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> CourseVideo courseVideo;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CloseCourseVideoCommand</span><span class="hljs-params">(CourseVideo courseVideo)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseVideo = courseVideo;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>&#123;<br>        courseVideo.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 员工记录需要执行的命令，进行执行</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Staff</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> List&lt;Command&gt; commandList = <span class="hljs-keyword">new</span> ArrayList&lt;Command&gt;();<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCommand</span><span class="hljs-params">(Command command)</span></span>&#123;<br>        commandList.add(command);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeCommands</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">for</span>(Command command : commandList)&#123;<br>            command.execute();<br>        &#125;<br>        commandList.clear();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        CourseVideo courseVideo = <span class="hljs-keyword">new</span> CourseVideo(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>);<br>        OpenCourseVideoCommand openCourseVideoCommand = <span class="hljs-keyword">new</span> OpenCourseVideoCommand(courseVideo);<br>        CloseCourseVideoCommand closeCourseVideoCommand = <span class="hljs-keyword">new</span> CloseCourseVideoCommand(courseVideo);<br><br>        Staff staff = <span class="hljs-keyword">new</span> Staff();<br>        staff.addCommand(openCourseVideoCommand);<br>        staff.addCommand(closeCourseVideoCommand);<br><br>        staff.executeCommands();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>Java设计模式精讲课程视频开放<br>Java设计模式精讲课程视频关闭</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>备忘录模式</title>
    <link href="/%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>保存一个对象的某种状态，以便在适当的时候来恢复对象</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><p>保存及恢复数据相关业务场景</p><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>为用户提供一种可恢复的机制</li><li>存档信息的封装</li></ul><p>缺点：</p><ul><li>资源占用</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：网站上发布博客，支持暂存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String title;<br>    <span class="hljs-keyword">private</span> String content;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ArticleMemento <span class="hljs-title">saveToMemento</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ArticleMemento(<span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">this</span>.content);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">undoFromMemento</span><span class="hljs-params">(ArticleMemento articleMemento)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.title = articleMemento.getTitle();<br>        <span class="hljs-keyword">this</span>.content = articleMemento.getContent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArticleMemento</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String title;<br>    <span class="hljs-keyword">private</span> String content;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 利用栈的先进后出来做备忘录</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArticleMementoManager</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Stack&lt;ArticleMemento&gt; ARTICLE_MEMENTO_STACK = <span class="hljs-keyword">new</span> Stack&lt;ArticleMemento&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ArticleMemento <span class="hljs-title">getMemento</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> ARTICLE_MEMENTO_STACK.pop();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addMemento</span><span class="hljs-params">(ArticleMemento articleMemento)</span></span><br><span class="hljs-function">    </span>&#123;<br>        ARTICLE_MEMENTO_STACK.push(articleMemento);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ArticleMementoManager articleMementoManager = <span class="hljs-keyword">new</span> ArticleMementoManager();<br>        Article article= <span class="hljs-keyword">new</span> Article(<span class="hljs-string">&quot;如影随行的设计模式A&quot;</span>,<span class="hljs-string">&quot;内容A&quot;</span>);<br><br>        <span class="hljs-comment">// 版本1保存到备忘录</span><br>        ArticleMemento articleMemento = article.saveToMemento();<br>        articleMementoManager.addMemento(articleMemento);<br>        System.out.println(<span class="hljs-string">&quot;标题:&quot;</span>+article.getTitle()+<span class="hljs-string">&quot; 内容:&quot;</span>+article.getContent()+<span class="hljs-string">&quot; 暂存成功&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;完整信息:&quot;</span>+article);<br><br>        System.out.println(<span class="hljs-string">&quot;============修改文章start============&quot;</span>);<br>        article.setTitle(<span class="hljs-string">&quot;如影随行的设计模式B&quot;</span>);<br>        article.setContent(<span class="hljs-string">&quot;内容B&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;============修改文章end============&quot;</span>);<br><br>        <span class="hljs-comment">// 版本2保存到备忘录</span><br>        articleMemento = article.saveToMemento();<br>        articleMementoManager.addMemento(articleMemento);<br>        System.out.println(<span class="hljs-string">&quot;标题:&quot;</span>+article.getTitle()+<span class="hljs-string">&quot; 内容:&quot;</span>+article.getContent()+<span class="hljs-string">&quot; 暂存成功&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;完整信息:&quot;</span>+article);<br><br>        <span class="hljs-comment">// 回退到版本2</span><br>        System.out.println(<span class="hljs-string">&quot;============暂存回退start============&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;回退出栈1次&quot;</span>);<br>        articleMemento = articleMementoManager.getMemento();<br>        article.undoFromMemento(articleMemento);<br><br>        <span class="hljs-comment">// 回退到版本1</span><br>        System.out.println(<span class="hljs-string">&quot;回退出栈2次&quot;</span>);<br>        articleMemento = articleMementoManager.getMemento();<br>        article.undoFromMemento(articleMemento);<br>        System.out.println(<span class="hljs-string">&quot;============暂存回退end============&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;完整信息:&quot;</span>+article);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>标题:如影随行的设计模式A 内容:内容A 暂存成功<br>完整信息:Article(title&#x3D;如影随行的设计模式A, content&#x3D;内容A)<br>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;修改文章start&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;修改文章end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>标题:如影随行的设计模式B 内容:内容B 暂存成功<br>完整信息:Article(title&#x3D;如影随行的设计模式B, content&#x3D;内容B)<br>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;暂存回退start&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>回退出栈1次<br>回退出栈2次<br>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;暂存回退end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>完整信息:Article(title&#x3D;如影随行的设计模式A, content&#x3D;内容A)</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>观察者模式</title>
    <link href="/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>定义了对象之间的一对多依赖。让多个观察者同时监听一个主题对象，当主题对象发生变化时，它的观察者都会收到通知并更新。</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><p>关联行为场景。建立一套触发机制</p><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>支持广播通信</li></ul><p>缺点：</p><ul><li>观察者之间有过多依赖的话，会提高程序复杂度</li><li>使用需要注意，避免观察者和被观察者循环调用</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：同学在网站上提出问题，老师收到通知</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 继承Observable表明他是被观察者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Observable</span></span>&#123;<br>    <span class="hljs-keyword">private</span> String courseName;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Course</span><span class="hljs-params">(String courseName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseName = courseName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCourseName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> courseName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produceQuestion</span><span class="hljs-params">(Course course, Question question)</span></span>&#123;<br>        System.out.println(question.getUserName()+<span class="hljs-string">&quot;在&quot;</span>+course.courseName+<span class="hljs-string">&quot;提交了一个问题&quot;</span>);<br>        <span class="hljs-comment">// 设置对象发生变化</span><br>        setChanged();<br>        <span class="hljs-comment">// 通知观察者</span><br>        notifyObservers(question);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Question</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-keyword">private</span> String questionContent;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  implements Observer表明Teacher是观察者类,</span><br><span class="hljs-comment"> *  复写update来指名接受到通知后执行的逻辑</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Teacher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Observer</span></span>&#123;<br>    <span class="hljs-keyword">private</span> String teacherName;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Teacher</span><span class="hljs-params">(String teacherName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.teacherName = teacherName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Observable o, Object arg)</span> </span>&#123;<br>        Course course = (Course)o;<br>        Question question = (Question)arg;<br>        System.out.println(teacherName+<span class="hljs-string">&quot;老师的&quot;</span>+course.getCourseName()+<span class="hljs-string">&quot;课程接收到一个&quot;</span>+question.getUserName()+<span class="hljs-string">&quot;提交的问答:&quot;</span>+question.getQuestionContent());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Course course = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>);<br>        Teacher teacher1 = <span class="hljs-keyword">new</span> Teacher(<span class="hljs-string">&quot;Alpha&quot;</span>);<br>        Teacher teacher2 = <span class="hljs-keyword">new</span> Teacher(<span class="hljs-string">&quot;Beta&quot;</span>);<br>        <br>        <span class="hljs-comment">// 添加观察者</span><br>        course.addObserver(teacher1);<br>        course.addObserver(teacher2);<br><br>        <span class="hljs-comment">//业务逻辑代码</span><br>        Question question = <span class="hljs-keyword">new</span> Question();<br>        question.setUserName(<span class="hljs-string">&quot;Geely&quot;</span>);<br>        question.setQuestionContent(<span class="hljs-string">&quot;Java的主函数如何编写&quot;</span>);<br><br>        course.produceQuestion(course,question);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>Geely在Java设计模式精讲提交了一个问题<br>Beta老师的Java设计模式精讲课程接收到一个Geely提交的问答:Java的主函数如何编写<br>Alpha老师的Java设计模式精讲课程接收到一个Geely提交的问答:Java的主函数如何编写</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>解释器模式</title>
    <link href="/%E8%A7%A3%E9%87%8A%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E8%A7%A3%E9%87%8A%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>给定一个语言，定义它文法的一种表示。并定义一个解释器，使用这个解释器来解释语言中的句子</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>可以将一个需要解释执行的语言中的句子表示为一个抽象语法树。 </li><li>一些重复出现的问题可以用一种简单的语言来进行表</li><li>一个简单语法需要解释的场景。</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>语法由很多类组成，便于扩展</li></ul><p>缺点：</p><ul><li>语法 规则太多时，增加了系统复杂度</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：定义表达式【6 100 11 +  * <em>】，计算逻辑为（100 + 11 ）</em> * 6</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Interpreter</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">interpret</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NumberInterpreter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Interpreter</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NumberInterpreter</span><span class="hljs-params">(<span class="hljs-keyword">int</span> number)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.number=number;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NumberInterpreter</span><span class="hljs-params">(String number)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.number=Integer.parseInt(number);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">interpret</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddInterpreter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Interpreter</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Interpreter firstExpression,secondExpression;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AddInterpreter</span><span class="hljs-params">(Interpreter firstExpression, Interpreter secondExpression)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.firstExpression=firstExpression;<br>        <span class="hljs-keyword">this</span>.secondExpression=secondExpression;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">interpret</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.firstExpression.interpret()+<span class="hljs-keyword">this</span>.secondExpression.interpret();<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;+&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiInterpreter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Interpreter</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Interpreter firstExpression,secondExpression;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MultiInterpreter</span><span class="hljs-params">(Interpreter firstExpression, Interpreter secondExpression)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.firstExpression=firstExpression;<br>        <span class="hljs-keyword">this</span>.secondExpression=secondExpression;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">interpret</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.firstExpression.interpret()*<span class="hljs-keyword">this</span>.secondExpression.interpret();<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;*&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyExpressionParser</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Stack&lt;Interpreter&gt; stack = <span class="hljs-keyword">new</span> Stack&lt;Interpreter&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">parse</span><span class="hljs-params">(String str)</span> </span>&#123;<br>        String[] strItemArray = str.split(<span class="hljs-string">&quot; &quot;</span>);<br>        <span class="hljs-keyword">for</span> (String symbol : strItemArray) &#123;<br>            <span class="hljs-keyword">if</span> (!isOperator(symbol)) &#123;<br>                Interpreter numberExpression = <span class="hljs-keyword">new</span> NumberInterpreter(symbol);<br>                stack.push(numberExpression);<br>                System.out.printf(<span class="hljs-string">&quot;入栈: %d%n&quot;</span>, numberExpression.interpret());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//是运算符号，可以计算</span><br>                Interpreter firstExpression = stack.pop();<br>                Interpreter secondExpression = stack.pop();<br>                System.out.printf(<span class="hljs-string">&quot;出栈: %d 和 %d%n&quot;</span>,<br>                        firstExpression.interpret(), secondExpression.interpret());<br>                Interpreter operator = getExpressionObject(firstExpression, secondExpression, symbol);<br>                System.out.printf(<span class="hljs-string">&quot;应用运算符: %s%n&quot;</span>, operator);<br>                <span class="hljs-keyword">int</span> result = operator.interpret();<br>                NumberInterpreter resultExpression = <span class="hljs-keyword">new</span> NumberInterpreter(result);<br>                stack.push(resultExpression);<br>                System.out.printf(<span class="hljs-string">&quot;阶段结果入栈: %d%n&quot;</span>, resultExpression.interpret());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">int</span> result = stack.pop().interpret();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isOperator</span><span class="hljs-params">(String symbol)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (symbol.equals(<span class="hljs-string">&quot;+&quot;</span>) || symbol.equals(<span class="hljs-string">&quot;*&quot;</span>));<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Interpreter <span class="hljs-title">getExpressionObject</span><span class="hljs-params">(Interpreter firstExpression, Interpreter secondExpression, String symbol)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (symbol.equals(<span class="hljs-string">&quot;+&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AddInterpreter(firstExpression, secondExpression);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (symbol.equals(<span class="hljs-string">&quot;*&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MultiInterpreter(firstExpression, secondExpression);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String geelyInputStr=<span class="hljs-string">&quot;6 100 11 + *&quot;</span>;<br>        MyExpressionParser expressionParser=<span class="hljs-keyword">new</span> MyExpressionParser();<br>        <span class="hljs-keyword">int</span> result=expressionParser.parse(geelyInputStr);<br>        System.out.println(<span class="hljs-string">&quot;解释器计算结果: &quot;</span>+result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>入栈: 6<br>入栈: 100<br>入栈: 11<br>出栈: 11 和 100<br>应用运算符: +<br>阶段结果入栈: 111<br>出栈: 111 和 6<br>应用运算符: *<br>阶段结果入栈: 666<br>解释器计算结果: 666</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>策略模式</title>
    <link href="/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>在策略模式定义了一系列算法或策略，并将每个算法封装在独立的类中，使得它们可以互相替换。通过使用策略模式，可以在运行时根据需要选择不同的算法，而不需要修改客户端代码。</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>一个系统需要动态在几种策略中选择一种</li><li>系统很多类，区别仅仅是行为不同</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>符合开闭原则</li><li>避免大量使用if…else, switch..case</li><li>提高算法的保密性和安全性</li></ul><p>缺点：</p><ul><li>客户端必须知道所有的策略类，并自行决定使用哪个类</li><li>产生很多策略类</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：慕课网活动促销，有多种方式：满减，返现，立减等，双11和618都采取不同的策略。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PromotionStrategy</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doPromotion</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmptyPromotionStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PromotionStrategy</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPromotion</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;无促销活动&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LiJianPromotionStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PromotionStrategy</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPromotion</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;立减促销,课程的价格直接减去配置的价格&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FanXianPromotionStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PromotionStrategy</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPromotion</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;返现促销,返回的金额存放到慕课网用户的余额中&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 促销活动</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PromotionActivity</span> </span>&#123;<br>  <span class="hljs-comment">// 促销策略</span><br>    <span class="hljs-keyword">private</span> PromotionStrategy promotionStrategy;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PromotionActivity</span><span class="hljs-params">(PromotionStrategy promotionStrategy)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.promotionStrategy = promotionStrategy;<br>    &#125;<br><br>  <span class="hljs-comment">// 执行促销</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executePromotionStrategy</span><span class="hljs-params">()</span></span>&#123;<br>        promotionStrategy.doPromotion();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        PromotionActivity promotionActivity618 = <span class="hljs-keyword">new</span> PromotionActivity(<span class="hljs-keyword">new</span> LiJianPromotionStrategy());<br>        PromotionActivity promotionActivity1111 = <span class="hljs-keyword">new</span> PromotionActivity(<span class="hljs-keyword">new</span> FanXianPromotionStrategy());<br><br>        promotionActivity618.executePromotionStrategy();<br>        promotionActivity1111.executePromotionStrategy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>立减促销,课程的价格直接减去配置的价格<br>返现促销,返回的金额存放到慕课网用户的余额中</p><p><strong>代码演进</strong></p><p>如果需要根据传过来的key，去选择对应的策略，使用共厂模式演进。。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PromotionStrategyFactory</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String,PromotionStrategy&gt; PROMOTION_STRATEGY_MAP = <span class="hljs-keyword">new</span> HashMap&lt;String, PromotionStrategy&gt;();<br>    <span class="hljs-keyword">static</span> &#123;<br>        PROMOTION_STRATEGY_MAP.put(PromotionKey.LIJIAN,<span class="hljs-keyword">new</span> LiJianPromotionStrategy());<br>        PROMOTION_STRATEGY_MAP.put(PromotionKey.FANXIAN,<span class="hljs-keyword">new</span> FanXianPromotionStrategy());<br>    &#125;<br><br>    <span class="hljs-comment">// 避免每次进来都需要new</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> PromotionStrategy NON_PROMOTION = <span class="hljs-keyword">new</span> EmptyPromotionStrategy();<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">PromotionStrategyFactory</span><span class="hljs-params">()</span></span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PromotionStrategy <span class="hljs-title">getPromotionStrategy</span><span class="hljs-params">(String promotionKey)</span></span>&#123;<br>        PromotionStrategy promotionStrategy = PROMOTION_STRATEGY_MAP.get(promotionKey);<br>        <span class="hljs-keyword">return</span> promotionStrategy == <span class="hljs-keyword">null</span> ? NON_PROMOTION : promotionStrategy;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PromotionKey</span></span>&#123;<br>        String LIJIAN = <span class="hljs-string">&quot;LIJIAN&quot;</span>;<br>        String FANXIAN = <span class="hljs-string">&quot;FANXIAN&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String promotionKey = <span class="hljs-string">&quot;LIJIAN&quot;</span>;<br>        PromotionActivity promotionActivity = <span class="hljs-keyword">new</span> PromotionActivity(PromotionStrategyFactory.getPromotionStrategy(promotionKey));<br>        promotionActivity.executePromotionStrategy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>立减促销,课程的价格直接减去配置的价格</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>迭代器模式</title>
    <link href="/%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>提供一种方法，顺序访问一个集合对象中的各个元素，而又不暴露该对象的内部展示</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li>访问一个集合的内容，而不暴露该对象的内部展示</li><li>为遍历不同的集合结构提供一个统一的接口</li></ul><blockquote><p>平时我们不太会自己写，因为已经有很多工具类写好了</p></blockquote><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>分离了集合对象的存储和遍历行为，由迭代器进行遍历</li></ul><p>缺点：</p><ul><li>类的个数成对增加，需要新增迭代器类</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景： 遍历课程列表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseAggregate</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addCourse</span><span class="hljs-params">(Course course)</span></span>;<br>    <span class="hljs-function">CourseIterator <span class="hljs-title">getIterator</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseAggregateImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseAggregate</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> List courseList;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CourseAggregateImpl</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseList = <span class="hljs-keyword">new</span> ArrayList();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCourse</span><span class="hljs-params">(Course course)</span> </span>&#123;<br>        courseList.add(course);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CourseIterator <span class="hljs-title">getIterator</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CourseIteratorImpl(courseList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseIterator</span> </span>&#123;<br>    <span class="hljs-function">Course <span class="hljs-title">nextCourse</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">hasNext</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseIteratorImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseIterator</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Course&gt; courseList;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> position;<br>    <span class="hljs-keyword">private</span> Course course;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CourseIteratorImpl</span><span class="hljs-params">(List&lt;Course&gt; courseList)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.courseList=courseList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Course <span class="hljs-title">nextCourse</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;返回课程,位置是: &quot;</span>+position);<br>        course=courseList.get(position);<br>        position++;<br>        <span class="hljs-keyword">return</span> course;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasNext</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(position&lt; courseList.size())&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Course course1 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java电商一期&quot;</span>);<br>        Course course2 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java电商二期&quot;</span>);<br>        Course course3 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>);<br>        Course course4 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Python课程&quot;</span>);<br>        Course course5 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;算法课程&quot;</span>);<br>        Course course6 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;前端课程&quot;</span>);<br><br><br>        CourseAggregate courseAggregate = <span class="hljs-keyword">new</span> CourseAggregateImpl();<br><br>        courseAggregate.addCourse(course1);<br>        courseAggregate.addCourse(course2);<br>        courseAggregate.addCourse(course3);<br>        courseAggregate.addCourse(course4);<br>        courseAggregate.addCourse(course5);<br>        courseAggregate.addCourse(course6);<br><br>        System.out.println(<span class="hljs-string">&quot;-----课程列表-----&quot;</span>);<br>        printCourses(courseAggregate);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printCourses</span><span class="hljs-params">(CourseAggregate courseAggregate)</span></span>&#123;<br>        CourseIterator courseIterator= courseAggregate.getIterator();<br>        <span class="hljs-keyword">while</span>(!courseIterator.hasNext())&#123;<br>            Course course=courseIterator.nextCourse();<br>            System.out.println(course.getName());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>返回课程,位置是: 0<br>Java电商一期<br>返回课程,位置是: 1<br>Java电商二期<br>返回课程,位置是: 2<br>Java设计模式精讲<br>返回课程,位置是: 3<br>Python课程<br>返回课程,位置是: 4<br>算法课程<br>返回课程,位置是: 5<br>前端课程</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>模版方法模式</title>
    <link href="/%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a><strong>1 概念</strong></h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a><strong>1 定义</strong></h2><p>定义一个算法的骨架，允许子类为一个或者多个步骤提供实现。</p><p>使子类在不改变算法结构的情况下，重新定义算法的某些步骤</p><p>类型：行为型</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a><strong>2 应用场景</strong></h2><ul><li><p>一次性实现一个算法不变的部分，并将可变的行为留给子类实现</p></li><li><p>将各类中公共的行为抽取出来到一个公共的父类中，避免代码重复</p></li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a><strong>3 优缺点</strong></h2><p>优点：</p><ul><li>提高复用性</li><li>提高扩展性</li><li>符合开闭原则</li></ul><p>缺点：</p><ul><li>类数目增加</li><li>增加系统复杂度</li><li>继承自身缺点，如果父类添加新的抽象方法，所有子类都需要改一遍。</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a><strong>2 代码实现</strong></h1><p>场景：</p><p>准备讲解前端和后端课程流程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ACourse</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">makeCourse</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.makePPT();<br>        <span class="hljs-keyword">this</span>.makeVideo();<br>        <span class="hljs-keyword">if</span>(needWriteArticle())&#123;<br>            <span class="hljs-keyword">this</span>.writeArticle();<br>        &#125;<br>        <span class="hljs-keyword">this</span>.prepareContentMaterial();<br>    &#125;<br><br>    <span class="hljs-comment">// 注意这里如果是必须要执行的步骤，必须加final，否则子类可以重写，就打乱了步骤</span><br>    <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">makePPT</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;制作PPT&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">makeVideo</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;制作视频&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeArticle</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;编写课堂笔记&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//钩子方法，注意这里不是final的子类可以复写它</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">needWriteArticle</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareContentMaterial</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BackEndCourse</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ACourse</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">prepareContentMaterial</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;提供课程Java源代码&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">needWriteArticle</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FECourse</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ACourse</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> needWriteArticleFlag = <span class="hljs-keyword">false</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">prepareContentMaterial</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;提供课程的前端代码&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;提供课程的图片等多媒体素材&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FECourse</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> needWriteArticleFlag)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.needWriteArticleFlag = needWriteArticleFlag;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">needWriteArticle</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.needWriteArticleFlag;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;后端设计模式课程start---&quot;</span>);<br>        ACourse designPatternCourse = <span class="hljs-keyword">new</span> BackEndCourse();<br>        designPatternCourse.makeCourse();<br>        System.out.println(<span class="hljs-string">&quot;后端设计模式课程end---&quot;</span>);<br><br><br>        System.out.println(<span class="hljs-string">&quot;前端课程start---&quot;</span>);<br>        ACourse feCourse = <span class="hljs-keyword">new</span> FECourse(<span class="hljs-keyword">false</span>);<br>        feCourse.makeCourse();<br>        System.out.println(<span class="hljs-string">&quot;前端课程end---&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>后端设计模式课程start—<br>制作PPT<br>制作视频<br>编写课堂笔记<br>提供课程Java源代码<br>后端设计模式课程end—<br>前端课程start—<br>制作PPT<br>制作视频<br>提供课程的前端代码<br>提供课程的图片等多媒体素材<br>前端课程end—</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>桥接模式</title>
    <link href="/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h2><p>桥接模式是将抽象部分与它的实现部分分离，使它们都可以独立地变化。它是用组合关系代替继承关系来实现，从而降低了抽象和实现这两个可变维度的耦合度。</p><p>类型：结构型</p><blockquote><p><strong>桥</strong>我们大家都熟悉，顾名思义就是用来将河的两岸联系起来的。而此处的桥是用来将两个独立的结构联系起来，而这两个被联系起来的结构可以独立的变化。</p></blockquote><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a>2 应用场景</h2><ul><li>一个类存在两个独立变化的维度，且这两个维度都需要进行扩展。（如中国工商银行 年付账号，会根据银行和存储方式两个维度进行扩展）</li><li>对于那些不希望使用继承或因为多层继承导致系统类的个数急剧增加的系统，桥接模式尤为适用。</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点：</p><ul><li>抽象与实现分离，扩展能力强</li><li>使用了组合，符合合成复用原则</li></ul><p>缺点：</p><ul><li>增加了系统的复杂度。要求开发者可以正确地识别出系统中两个独立变化的维度</li><li>增加了系统的设计难度。</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a>2 代码实现</h1><p>场景：</p><p>有一个银行类，他可以扩展出两个子类：中国工商银行和中国农业银行。希望这两个银行都支持月月存和年存这两种存储方式，由于已经有两个类，所以需要创建 中国工商银行+月月存，中国工商银行+年存，中国农业银行+月月存，中国农业银行+年存，这四种类来支持。</p><p>如果需要新增银行或者新增存储方式，将导致代码复杂程度指数增长。</p><p>解决：在银行和存储方式这两个独立的维度分别扩展，适用组合的方式建立关联。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Account</span> </span>&#123;<br>    <span class="hljs-function">Account <span class="hljs-title">createAccount</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MonthSavingAccount</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Account</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Account <span class="hljs-title">createAccount</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;新建一个月存储账号。。。&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MonthSavingAccount();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">YearSavingAccount</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Account</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Account <span class="hljs-title">createAccount</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;新建一个年存储账号。。。&quot;</span>);<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> YearSavingAccount();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bank</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span> Account account;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Bank</span><span class="hljs-params">(Account account)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.account = account;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">abstract</span> Account <span class="hljs-title">createAccount</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABCBank</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bank</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ABCBank</span><span class="hljs-params">(Account account)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(account);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function">Account <span class="hljs-title">createAccount</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打开中国农业银行账号管理系统。。。&quot;</span>);<br>        account.createAccount();<br>        <span class="hljs-keyword">return</span> account;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ICBCBank</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bank</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ICBCBank</span><span class="hljs-params">(Account account)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(account);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function">Account <span class="hljs-title">createAccount</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打开中国工商银行账号管理系统。。。&quot;</span>);<br>        account.createAccount();<br>        <span class="hljs-keyword">return</span> account;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">// 新建一个工商银行 + 月存储账号</span><br>        Bank icbcBank = <span class="hljs-keyword">new</span> ICBCBank(<span class="hljs-keyword">new</span> MonthSavingAccount());<br>        icbcBank.createAccount();<br><br>        <span class="hljs-comment">// 新建一个工商银行 + 年存储账号</span><br>        Bank icbcBank2 = <span class="hljs-keyword">new</span> ICBCBank(<span class="hljs-keyword">new</span> YearSavingAccount());<br>        icbcBank2.createAccount();<br><br>        <span class="hljs-comment">// 新建一个农业银行 + 年存储账号</span><br>        Bank abcBank = <span class="hljs-keyword">new</span> ABCBank(<span class="hljs-keyword">new</span> YearSavingAccount());<br>        abcBank.createAccount();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>打开中国工商银行账号管理系统。。。<br>新建一个月存储账号。。。<br>打开中国工商银行账号管理系统。。。<br>新建一个年存储账号。。。<br>打开中国农业银行账号管理系统。。。<br>新建一个年存储账号。。。</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>组合模式</title>
    <link href="/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h2><p>将对象组合成树形结构以表示“部分——整体”的层次结构</p><p>组合模式使客户端对单个对象和组合对象保持一致的处理方式</p><p>类型：结构型</p><h2 id="2-适用场景"><a href="#2-适用场景" class="headerlink" title="2 适用场景"></a>2 适用场景</h2><ul><li>希望客户端可以忽略组合对象和单个对象之前的差异</li><li>处理树形结构时</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点</p><ul><li>让客户端忽略了层次的差异，方便对整个层次进行控制。简化客户端代码</li><li>符合开闭原则</li></ul><p>缺点</p><ul><li>使设计变得抽象</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a>2 代码实现</h1><p>场景：打印课程目录和课程的层次关系。课程的主目录包括课程目录和课程。</p><p>有些课程属于某个子目录下，有些无法归类到子目录，直属于主目录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 目录组件</span><br><span class="hljs-comment"> *      目录 和 书籍 都继承 CatalogComponent 接口</span><br><span class="hljs-comment"> *      子类根据当前的的类型 , 选择性重写接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CatalogComponent</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(CatalogComponent catalogComponent)</span></span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsupportedOperationException(<span class="hljs-string">&quot;不支持添加操作&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">(CatalogComponent catalogComponent)</span></span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsupportedOperationException(<span class="hljs-string">&quot;不支持获取名称操作&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsupportedOperationException(<span class="hljs-string">&quot;不支持打印操作&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CatalogComponent</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> price;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Course</span><span class="hljs-params">(String name, <span class="hljs-keyword">double</span> price)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.price = price;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">(CatalogComponent catalogComponent)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getPrice</span><span class="hljs-params">(CatalogComponent catalogComponent)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.price;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Course Name:&quot;</span>+name+<span class="hljs-string">&quot; Price:&quot;</span>+price);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Catalog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CatalogComponent</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> List&lt;CatalogComponent&gt; items = <span class="hljs-keyword">new</span> ArrayList&lt;CatalogComponent&gt;();<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer level;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Catalog</span><span class="hljs-params">(String name, Integer level)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.level = level;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(CatalogComponent catalogComponent)</span> </span>&#123;<br>        items.add(catalogComponent);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">(CatalogComponent catalogComponent)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-keyword">this</span>.name);<br>        <span class="hljs-keyword">for</span>(CatalogComponent catalogComponent : items)&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.level != <span class="hljs-keyword">null</span>)&#123;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span>  i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.level; i++)&#123;<br>                    System.out.print(<span class="hljs-string">&quot;  &quot;</span>);<br>                &#125;<br>            &#125;<br>            catalogComponent.print();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        CatalogComponent linuxCourse = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Linux课程&quot;</span>,<span class="hljs-number">11</span>);<br>        CatalogComponent windowsCourse = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Windows课程&quot;</span>,<span class="hljs-number">11</span>);<br><br>        CatalogComponent javaCourseCatalog = <span class="hljs-keyword">new</span> Catalog(<span class="hljs-string">&quot;Java课程目录&quot;</span>,<span class="hljs-number">2</span>);<br><br>        CatalogComponent mmallCourse1 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java电商一期&quot;</span>,<span class="hljs-number">55</span>);<br>        CatalogComponent mmallCourse2 = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java电商二期&quot;</span>,<span class="hljs-number">66</span>);<br>        CatalogComponent designPattern = <span class="hljs-keyword">new</span> Course(<span class="hljs-string">&quot;Java设计模式&quot;</span>,<span class="hljs-number">77</span>);<br><br>        javaCourseCatalog.add(mmallCourse1);<br>        javaCourseCatalog.add(mmallCourse2);<br>        javaCourseCatalog.add(designPattern);<br><br>        CatalogComponent mainCourseCatalog = <span class="hljs-keyword">new</span> Catalog(<span class="hljs-string">&quot;课程主目录&quot;</span>,<span class="hljs-number">1</span>);<br>        mainCourseCatalog.add(linuxCourse);<br>        mainCourseCatalog.add(windowsCourse);<br>        mainCourseCatalog.add(javaCourseCatalog);<br><br>        mainCourseCatalog.print();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231004141724348.png" alt="image-20231004141724348" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>享元模式</title>
    <link href="/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>“享”就表示共享，“元”表示对象。如果在一个系统中存在多个相同的对象，那么只需要共享一份对象的拷贝,而不必为每一次使用都创建新的对象。目的是减少对象创建，减少内存占用，提高系统性能。</p><p>类型：结构型</p><blockquote><p>比如：去图书馆借书，如果书架上有这本书直接拿走，到借阅机上借阅就好了，如果没有，可以到图书管理处去拿一本新书。对于整个图书馆来说，书其实就是共享的。对于我们借书的流程和图书共享的方式就是享元模式。</p></blockquote><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a>2 应用场景</h2><ul><li>系统底层开发。比如Java的string类型，如果有则返回，没有则创建一个，保存在字符串缓存池里；数据库连接池。</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点：</p><ul><li>减少对象创建，减少内存占用，提高系统性能。</li></ul><p>缺点：</p><ul><li><p>关注内外部状态，关注线程安全问题。一般我们都用的HashMap,线程安全可以使用hashTable,提升效率可以concurentHashMap</p></li><li><p>提高了系统的复杂度</p></li></ul><h2 id="4-主要角色"><a href="#4-主要角色" class="headerlink" title="4 主要角色"></a>4 主要角色</h2><ul><li>抽象享元（Book）：定义需要共享的对象业务接口。享元类被创建出来总是为了实现某些特定的业务逻辑.</li><li>具体享元（ConcreteBook）：实现抽象享元类的接口，完成某一具体逻辑。在这里表示可以被借出。</li><li>享元工厂（Llibrary）：用于创建具体享元类，维护相同的享元对象。当请求对象已经存在时，直接返回对象，不存在时，在创建对象。在例子中的解释就是图书馆，保存了所有的书，当学生借书时，有就拿走，没有买一本新书。这里面其实是使用了单例模式的</li></ul><blockquote><p>享元工厂是享元模式的核心，它需要确保系统可以共享相同的对象。它会维护一个对象列表，当我们想要获取享元类时，如果请求的享元类已经被创建，则直接返回已有的享元类：若没有，则创建一个新的享元对象，并将它加入到维护队列中。</p></blockquote><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a>2 代码实现</h1><p>场景：去图书馆借书，如果书架上有这本书直接拿走，到借阅机上借阅就好了，如果没有，可以到图书管理处去拿一本新书。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Book</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">borrow</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcreteBook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Book</span> </span>&#123;<br>    <span class="hljs-comment">//被借出的书名,外部状态，不可以共享的状态，传入的书名不同，书不同</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">// 内部状态，这些书都属于新华书店，可共享的状态</span><br>    <span class="hljs-keyword">private</span> String librarySign = <span class="hljs-string">&quot;新华书店&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConcreteBook</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">borrow</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;图书馆借出一本书，书名为：&quot;</span> + <span class="hljs-keyword">this</span>.name );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 相当于bookFactory</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Library</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Book&gt; BOOK_MAP = <span class="hljs-keyword">new</span> HashMap&lt;String, Book&gt;();<br><br>    <span class="hljs-comment">//图书馆外借图书</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Book <span class="hljs-title">borrowBook</span><span class="hljs-params">(String bookName)</span></span>&#123;<br>        <span class="hljs-comment">//如果书架有，直接借出</span><br>        Book   book = BOOK_MAP.get(bookName);<br>        <span class="hljs-comment">//如果书架没有，那就调进来一本新书</span><br>        <span class="hljs-keyword">if</span>(book == <span class="hljs-keyword">null</span>)&#123;<br>            book = <span class="hljs-keyword">new</span> ConcreteBook(bookName);<br>            BOOK_MAP.put(bookName, book);<br>        &#125;<br>        <span class="hljs-keyword">return</span> book;<br>    &#125;<br><br>    <span class="hljs-comment">//图书馆书架上的书的数量</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAllBookSize</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BOOK_MAP.size();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] bookNames = &#123;<span class="hljs-string">&quot;白雪公主&quot;</span>,<span class="hljs-string">&quot;一千零一夜&quot;</span>,<span class="hljs-string">&quot;火烈鸟&quot;</span>,<span class="hljs-string">&quot;海蒂&quot;</span>&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> BOOK_SIZE = <span class="hljs-number">10</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; BOOK_SIZE; i++) &#123;<br>            <span class="hljs-keyword">int</span> randomIndex = <span class="hljs-keyword">new</span> Random().nextInt(bookNames.length);<br>            String bookName = bookNames[randomIndex];<br>            Book book = Library.borrowBook(bookName);<br>            book.borrow();<br>        &#125;<br>        <span class="hljs-comment">//输出一些学生一共借多少本书</span><br>        System.out.println(<span class="hljs-string">&quot;学生一共借了 &quot;</span> + BOOK_SIZE + <span class="hljs-string">&quot; 本书! &quot;</span>);<br>        <span class="hljs-comment">//输出一下图书馆一共借出多少本书</span><br>        System.out.println(<span class="hljs-string">&quot;图书馆实际借出&quot;</span> + Library.getAllBookSize() + <span class="hljs-string">&quot; 本书&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><p>图书馆借出一本书，书名为：海蒂<br>图书馆借出一本书，书名为：火烈鸟<br>图书馆借出一本书，书名为：一千零一夜<br>图书馆借出一本书，书名为：火烈鸟<br>图书馆借出一本书，书名为：火烈鸟<br>图书馆借出一本书，书名为：白雪公主<br>图书馆借出一本书，书名为：白雪公主<br>图书馆借出一本书，书名为：海蒂<br>图书馆借出一本书，书名为：海蒂<br>图书馆借出一本书，书名为：一千零一夜<br>学生一共借了 10 本书!<br>图书馆实际借出4 本书</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>适配器模式</title>
    <link href="/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h2><p>将一个类的接口转换成客户期望的另一个接口。使得原本不兼容的类，可以一起工作</p><p>类型：结构型</p><p>分类：</p><p>对象适配器：使用组合</p><p>类适配器：使用类继承</p><h2 id="2-适用场景"><a href="#2-适用场景" class="headerlink" title="2 适用场景"></a>2 适用场景</h2><ul><li>已经存在的类，他的方法和需求不匹配时（方法的结果相同或相似）</li><li>不是软件设计阶段考虑的设计模式，是随着软件的维护，由于不同产品，不同厂家造成功能类似而接口不相同情况下的解决方案</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点：</p><ul><li>提高类的透明性和复用，现有的类复用而不发生改变</li><li>目标类和适配器类解耦，提高程序扩展性</li><li>符合开闭原则</li></ul><p>缺点：</p><p>增加代码可读性的难度</p><h1 id="2-代码"><a href="#2-代码" class="headerlink" title="2 代码"></a>2 代码</h1><p>场景：将220V直流电，通过充电器转换成5V的交流电，从而给手机充电</p><h2 id="2-1-类适配器模式"><a href="#2-1-类适配器模式" class="headerlink" title="2.1 类适配器模式"></a>2.1 类适配器模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 被适配者</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AC220</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">outputAC220V</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">int</span> output = <span class="hljs-number">220</span>;<br>        System.out.println(<span class="hljs-string">&quot;输出交流电&quot;</span>+output+<span class="hljs-string">&quot;V&quot;</span>);<br>        <span class="hljs-keyword">return</span> output;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 目标输出</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">outputDC5V</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 适配器，使被适配者转换成目标类，并且有目标输出的接口方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PowerAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AC220</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">DC5</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">outputDC5V</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> adapterInput = <span class="hljs-keyword">super</span>.outputAC220V();<br>        <span class="hljs-comment">//变压器...</span><br>        <span class="hljs-keyword">int</span> adapterOutput = adapterInput/<span class="hljs-number">44</span>;<br>        System.out.println(<span class="hljs-string">&quot;使用PowerAdapter输入AC:&quot;</span>+adapterInput+<span class="hljs-string">&quot;V&quot;</span>+<span class="hljs-string">&quot;输出DC:&quot;</span>+adapterOutput+<span class="hljs-string">&quot;V&quot;</span>);<br>        <span class="hljs-keyword">return</span> adapterOutput;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Target adapterTarget = <span class="hljs-keyword">new</span> Adapter();<br>        adapterTarget.request();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-对象适配器"><a href="#2-2-对象适配器" class="headerlink" title="2.2 对象适配器"></a>2.2 对象适配器</h2><p>只有适配器的代码发生了改变</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PowerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">DC5</span></span>&#123;<br>    <span class="hljs-comment">// 这里使用组合的方式，将被适配者组合到了当前类</span><br>    <span class="hljs-keyword">private</span> AC220 ac220 = <span class="hljs-keyword">new</span> AC220();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">outputDC5V</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> adapterInput = ac220.outputAC220V();<br>        <span class="hljs-comment">//变压器...</span><br>        <span class="hljs-keyword">int</span> adapterOutput = adapterInput/<span class="hljs-number">44</span>;<br>        System.out.println(<span class="hljs-string">&quot;使用PowerAdapter输入AC:&quot;</span>+adapterInput+<span class="hljs-string">&quot;V&quot;</span>+<span class="hljs-string">&quot;输出DC:&quot;</span>+adapterOutput+<span class="hljs-string">&quot;V&quot;</span>);<br>        <span class="hljs-keyword">return</span> adapterOutput;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>装饰器模式</title>
    <link href="/%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1. 概念"></a>1. 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>在不改变原有对象的基础上，将功能附加到对象上</p><p>提供了比继承，更有弹性的替代方案（扩展原有对象功能）</p><p>类型：结构型</p><h2 id="2-适用场景"><a href="#2-适用场景" class="headerlink" title="2 适用场景"></a>2 适用场景</h2><ul><li><p>扩展一个类的功能，或者给一个类添加附加职责</p></li><li><p>动态的给一个对象添加功能，这些功能可以再动态撤销</p></li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点：</p><ul><li><p>继承的有力补充，比继承灵活，不改变原有对象的情况下，给一个对象添加功能</p></li><li><p>通过使用不同的装饰类以及这些装饰类的排列组合，可以实现不同的效果</p></li><li><p>符合开闭原则。装饰者和被装饰者可以独立变化</p></li></ul><p>缺点</p><ul><li><p>会出现更多的代码，更多的类，增加程序复杂性（各种抽象装饰类，抽象实体类）</p></li><li><p>动态装饰时，多层装饰会更复杂</p></li></ul><h2 id="4-使用"><a href="#4-使用" class="headerlink" title="4 使用"></a>4 使用</h2><ul><li>通常需要一个抽象的实体类，一个具体的实体类。一个抽象的装饰者，一个具体的装饰者。</li><li>通常会将被装饰者，以参数的方式传给装饰者的构造器</li></ul><h1 id="2-代码"><a href="#2-代码" class="headerlink" title="2 代码"></a>2 代码</h1><p>业务场景：烧烤店老板制作煎饼，有人加一个鸡蛋，一个肠。有人加两个鸡蛋一个肠</p><p>实体：煎饼</p><p>装饰者：鸡蛋，香肠</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABattercake</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">getDesc</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">int</span> <span class="hljs-title">cost</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Battercake</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ABattercake</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getDesc</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;煎饼&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">cost</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ABattercake</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> ABattercake aBattercake;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractDecorator</span><span class="hljs-params">(ABattercake aBattercake)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.aBattercake = aBattercake;<br>    &#125;<br><br>  <span class="hljs-comment">// 在制作煎饼和香肠时需要的一些额外的操作</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span>;<br>  <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getDesc</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.aBattercake.getDesc();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">cost</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.aBattercake.cost();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EggDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDecorator</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EggDecorator</span><span class="hljs-params">(ABattercake aBattercake)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(aBattercake);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getDesc</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.getDesc()+<span class="hljs-string">&quot; 加一个鸡蛋&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">cost</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.cost()+<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SausageDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDecorator</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SausageDecorator</span><span class="hljs-params">(ABattercake aBattercake)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(aBattercake);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getDesc</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.getDesc()+<span class="hljs-string">&quot; 加一根香肠&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">cost</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.cost()+<span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ABattercake aBattercake;<br>        aBattercake = <span class="hljs-keyword">new</span> Battercake();<br>        <span class="hljs-comment">// 加一个鸡蛋</span><br>        aBattercake = <span class="hljs-keyword">new</span> EggDecorator(aBattercake);<br>        <span class="hljs-comment">// 加一个鸡蛋</span><br>        aBattercake = <span class="hljs-keyword">new</span> EggDecorator(aBattercake);<br>        <span class="hljs-comment">// 加一根香肠</span><br>        aBattercake = <span class="hljs-keyword">new</span> SausageDecorator(aBattercake);<br><br>        System.out.println(aBattercake.getDesc()+<span class="hljs-string">&quot; 销售价格:&quot;</span>+aBattercake.cost());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：煎饼 加一个鸡蛋 加一个鸡蛋 加一根香肠 销售价格:12</p>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>外观模式</title>
    <link href="/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h2><p>外观模式（Facade Pattern）：又叫门面模式，引入一个外观角色来简化调用者与各个子系统之间的交互，向客户端提供了一个统一的接口，用来访问子系统中的一群接口。</p><p>类型： 结构型</p><h2 id="2-适用场景"><a href="#2-适用场景" class="headerlink" title="2 适用场景"></a>2 适用场景</h2><ul><li>当调用者需要调用多个子系统来完成自己的逻辑</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点：</p><ul><li>给各个子系统提供统一的入口，无需深入了解子系统，调用者使用起来很简单</li><li>把各个子系统和调用者解耦，扩展性会更好</li><li>更好的划分访问层次。有些子方法是不需要暴露给外部的，有些是需要的。我们把需要暴露的方法，集成在外观类上</li><li>符合迪米特法则，即最小知道法则。客户端只需要和外观类进行交互，不需要和子系统进行交互</li></ul><p>缺点：</p><p>如果设计不合理，增加新的子系统时可能需要修改外观类或调用者的源代码，违背了“开闭原则”</p><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a>2 代码实现</h1><p>场景：积分商城，根据已有积分购买商品。涉及到的子系统为：积分校验系统，支付系统，物流系统.</p><p>调用者不需要知道校验，支付，物流的情况，只需要知道要使用积分，兑换哪个商品即可，所以构建积分兑换类，使调用者直接使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointsGift</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PointsGift</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QualifyService</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAvailable</span><span class="hljs-params">(PointsGift pointsGift)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;校验&quot;</span>+pointsGift.getName()+<span class="hljs-string">&quot; 积分资格通过,库存通过&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointsPaymentService</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">pay</span><span class="hljs-params">(PointsGift pointsGift)</span></span>&#123;<br>        <span class="hljs-comment">//扣减积分</span><br>        System.out.println(<span class="hljs-string">&quot;支付&quot;</span>+pointsGift.getName()+<span class="hljs-string">&quot; 积分成功&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShippingService</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">shipGift</span><span class="hljs-params">(PointsGift pointsGift)</span></span>&#123;<br>        <span class="hljs-comment">//物流系统的对接逻辑</span><br>        System.out.println(pointsGift.getName()+<span class="hljs-string">&quot;进入物流系统&quot;</span>);<br>        String shippingOrderNo = <span class="hljs-string">&quot;666&quot;</span>;<br>        <span class="hljs-keyword">return</span> shippingOrderNo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GiftExchangeService</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> QualifyService qualifyService = <span class="hljs-keyword">new</span> QualifyService();<br>    <span class="hljs-keyword">private</span> PointsPaymentService pointsPaymentService = <span class="hljs-keyword">new</span> PointsPaymentService();<br>    <span class="hljs-keyword">private</span> ShippingService shippingService = <span class="hljs-keyword">new</span> ShippingService();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">giftExchange</span><span class="hljs-params">(PointsGift pointsGift)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(qualifyService.isAvailable(pointsGift))&#123;<br>            <span class="hljs-comment">//资格校验通过</span><br>            <span class="hljs-keyword">if</span>(pointsPaymentService.pay(pointsGift))&#123;<br>                <span class="hljs-comment">//如果支付积分成功</span><br>                String shippingOrderNo = shippingService.shipGift(pointsGift);<br>                System.out.println(<span class="hljs-string">&quot;物流系统下单成功,订单号是:&quot;</span>+shippingOrderNo);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        PointsGift pointsGift = <span class="hljs-keyword">new</span> PointsGift(<span class="hljs-string">&quot;T恤&quot;</span>);<br>        GiftExchangeService giftExchangeService = <span class="hljs-keyword">new</span> GiftExchangeService();<br>        giftExchangeService.giftExchange(pointsGift);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>docker+jenkins实现SpringBoot项目自动化部署</title>
    <link href="/docker+jenkins%E5%AE%9E%E7%8E%B0SpringBoot%E9%A1%B9%E7%9B%AE%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"/>
    <url>/docker+jenkins%E5%AE%9E%E7%8E%B0SpringBoot%E9%A1%B9%E7%9B%AE%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h1><p>当前有一个微服务项目，共包含4个常用的微服务子项目，原始项目升级方式为:</p><ol><li>修改application.yml文件，profile为product</li><li>在自己的电脑上手动利用maven打包，分为clean, package</li><li>分别进入4个项目的target目录下，将打好的jar包拷贝出来。</li><li>将本机拷贝出来的4个jar包上传到跳板机上</li><li>将上传到跳班机上的4个jar包拷贝出来，传到客户服务器上的指定目录</li><li>在服务器上依次执行jps -l（列出当前正在运行的Java进程和它们的进程PID），kill -9 , jar -jar xxx.jar命令</li><li>再次执行jps -l，查看服务是否正常启动</li></ol><p>流程不仅复杂，而且耗费时间，所以考虑自动化部署，来简化这一体系流程</p><h1 id="2-原理"><a href="#2-原理" class="headerlink" title="2 原理"></a>2 原理</h1><ol><li><p>从git仓库拉取最新代码</p></li><li><p>利用maven执行clean , package操作，进行打包</p></li><li><p>打包结果通知到飞书（可有可无）</p></li><li><p>将打好的jar包，发送到指定服务器上</p></li><li><p>执行部署脚本 包括kill -9 , jar -jar xxx.jar</p></li></ol><h1 id="3-具体步骤"><a href="#3-具体步骤" class="headerlink" title="3 具体步骤"></a>3 具体步骤</h1><h2 id="1-配置maven和jdk"><a href="#1-配置maven和jdk" class="headerlink" title="1. 配置maven和jdk"></a>1. 配置maven和jdk</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005191707787.png" alt="image-20231005191707787"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005191548704.png" alt="image-20231005191548704"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005191644036.png" alt="image-20231005191644036"></p><h2 id="2-新建Job"><a href="#2-新建Job" class="headerlink" title="2. 新建Job"></a>2. 新建Job</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005191359836.png" alt="image-20231005191359836"></p><h2 id="3-配置git仓库地址和分支名"><a href="#3-配置git仓库地址和分支名" class="headerlink" title="3. 配置git仓库地址和分支名"></a>3. 配置git仓库地址和分支名</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230315160535916.png" alt="img"></p><h2 id="4-配置构建环境"><a href="#4-配置构建环境" class="headerlink" title="4. 配置构建环境"></a>4. 配置构建环境</h2><p>每次构建前删除工作空间（避免由于类转移位置后，两个位置都存在类，引起同名bean冲突）</p><p>打印控制台输出时间戳，便于观察构建进度</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005191939745.png" alt="image-20231005191939745"></p><h2 id="5-配置编译使用的pom-xml文件"><a href="#5-配置编译使用的pom-xml文件" class="headerlink" title="5 配置编译使用的pom.xml文件"></a>5 配置编译使用的pom.xml文件</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005192206486.png" alt="image-20231005192206486"></p><h2 id="6-配置给飞书发送通知"><a href="#6-配置给飞书发送通知" class="headerlink" title="6 配置给飞书发送通知"></a>6 配置给飞书发送通知</h2><p>由于不论成功还是失败都需要给飞书发送通知，这里使用了<strong>Post build task</strong> 插件</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005192341444.png" alt="image-20231005192341444"></p><p>feishu.sh:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#！/bin/bash</span><br>jobName=<span class="hljs-variable">$JOB_BASE_NAME</span><br>json=$(curl -u admin:password https://xxx.com.cn/jenkins/job/<span class="hljs-variable">$jobName</span>/<span class="hljs-variable">$&#123;BUILD_NUMBER&#125;</span>/api/json)<br>state=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$json</span> | sed <span class="hljs-string">&#x27;s/,/\n/g&#x27;</span> | grep <span class="hljs-string">&quot;result&quot;</span> | sed <span class="hljs-string">&#x27;s/:/\n/g&#x27;</span> | sed <span class="hljs-string">&#x27;1d&#x27;</span> | sed <span class="hljs-string">&#x27;s/&#125;//g&#x27;</span>)<br>nowTime=$(TZ=UTC-8 date +%Y-%m-%d<span class="hljs-string">&quot; &quot;</span>%H:%M:%S)<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;state&#125;</span> == <span class="hljs-string">&quot;\&quot;SUCCESS\&quot;&quot;</span> ] ; <span class="hljs-keyword">then</span> stateText=<span class="hljs-string">&quot;成功&quot;</span>; <span class="hljs-keyword">else</span> stateText=<span class="hljs-string">&quot;失败&quot;</span>; <span class="hljs-keyword">fi</span><br>curl -X POST -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>        -d <span class="hljs-string">&#x27;&#123;&quot;msg_type&quot;:&quot;post&quot;,&quot;content&quot;: &#123;&quot;post&quot;: &#123;&quot;zh_cn&quot;: &#123;&quot;title&quot;: &quot;jenkins构建报告&quot;,&quot;content&quot;: [[&#123;&quot;tag&quot;: &quot;text&quot;,&quot;text&quot;: &quot;&#x27;</span><span class="hljs-string">&quot;名  称：<span class="hljs-variable">$jobName</span>\n编  号：<span class="hljs-variable">$&#123;BUILD_NUMBER&#125;</span>\n状  态:  <span class="hljs-variable">$stateText</span>\n时  间:  <span class="hljs-variable">$nowTime</span>\n详  情:  https://xxx.com.cn/jenkins/job/<span class="hljs-variable">$jobName</span>/<span class="hljs-variable">$&#123;BUILD_NUMBER&#125;</span>/console\n日  志：https://b1ortdxsoc.feishu.cn/wiki/RbAowYec2iUw72kWlJocapX8n2f&quot;</span><span class="hljs-string">&#x27;&quot;&#125;]]&#125; &#125; &#125;&#125;&#x27;</span> \<br>https://open.feishu.cn/open-apis/bot/v2/hook/ffb88764-379c-4a98-8496-b1a713114f3<br></code></pre></td></tr></table></figure><p>飞书收到的格式为：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005192946100.png" alt="image-20231005192946100"></p><h2 id="7-每个微服务单独建一个执行job"><a href="#7-每个微服务单独建一个执行job" class="headerlink" title="7 每个微服务单独建一个执行job"></a>7 每个微服务单独建一个执行job</h2><p>配置运行这个job时，将构建好的jar包上传到客户服务器上，并且执行部署脚本</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231005193534214.png" alt="image-20231005193534214"></p><p>deploy.sh：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /etc/profile<br>java -version<br>BUILD_ID=dontKillMe<br><span class="hljs-built_in">export</span> TERM=xterm<br>CURRENT_TIMESTAMP=$(date +%s)<br>NOW=$(date -d @<span class="hljs-variable">$CURRENT_TIMESTAMP</span> <span class="hljs-string">&quot;+%Y-%m-%d_%H-%M-%S&quot;</span>)<br>jar=<span class="hljs-variable">$1</span>-1.0.0-SNAPSHOT.jar<br>cp <span class="hljs-variable">$jar</span> <span class="hljs-variable">$1</span>-<span class="hljs-variable">$NOW</span>.jar<br>jar=`ls <span class="hljs-variable">$1</span>*.jar |sort -r|head -n 1`<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$jar</span><br><br>profile_active=sithMes<br><span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span> ]<br><span class="hljs-keyword">then</span><br>    profile_active=<span class="hljs-variable">$2</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;set profile_active: <span class="hljs-variable">$profile_active</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><br>log_output=/dev/null<br><span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$3</span>&quot;</span> ]<br><span class="hljs-keyword">then</span><br>    log_output=<span class="hljs-variable">$3</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;set log_output: <span class="hljs-variable">$log_output</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><br>ps -ef | grep java | grep <span class="hljs-variable">$1</span> | grep -v grep | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="hljs-built_in">kill</span> -9<br>nohup java -jar <span class="hljs-variable">$jar</span> --spring.profiles.active=<span class="hljs-variable">$profile_active</span> &gt;<span class="hljs-variable">$log_output</span> 2&gt;&amp;1 &amp;<br>sleep 30<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> $(pgrep -f <span class="hljs-variable">$jar</span>|wc -l) -eq 0<br><span class="hljs-keyword">then</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Start Failed&quot;</span><br>   <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">else</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Start Success&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;============================== 执行 top | head -50 =====================&#x27;</span><br><br>top -b| head -40<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;================================== 执行 jps -l ========================&#x27;</span><br><br>jps -l<br></code></pre></td></tr></table></figure><blockquote><p>这里 没查到jar包执行时，执行exit 1，会时jenkins当前job的状态变成黄色，而不是成功时的绿色。</p></blockquote><h1 id="4-常见问题"><a href="#4-常见问题" class="headerlink" title="4 常见问题"></a>4 常见问题</h1><h2 id="1-jenkins迁移时需要迁移哪些文件夹？"><a href="#1-jenkins迁移时需要迁移哪些文件夹？" class="headerlink" title="1 jenkins迁移时需要迁移哪些文件夹？"></a>1 jenkins迁移时需要迁移哪些文件夹？</h2><p>将老服务器<a href="https://so.csdn.net/so/search?q=jenkins&spm=1001.2101.3001.7020">jenkins</a>主目录下的config.xml文件以及jobs、users、workspace、plugins四个目录拷贝到新机器的jenkins主目录下。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker cp /Users/panyurou/.jenkins/<span class="hljs-built_in">jobs</span>  6257c7abfa11:/var/jenkins_home/<span class="hljs-built_in">jobs</span><br></code></pre></td></tr></table></figure><h2 id="2-使用docker增加前缀-x2F-jenkins"><a href="#2-使用docker增加前缀-x2F-jenkins" class="headerlink" title="2 使用docker增加前缀 &#x2F;jenkins"></a>2 使用docker增加前缀 &#x2F;jenkins</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker pull jenkins/jenkins:2.346<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -d -p 8089:8080  --name jenkins4 -e JENKINS_OPTS=<span class="hljs-string">&quot;--prefix=/jenkins&quot;</span> jenkins/jenkins:2.346<br></code></pre></td></tr></table></figure><h2 id="3-没权限"><a href="#3-没权限" class="headerlink" title="3 没权限"></a>3 没权限</h2><p>报错：I have experienced this when the $JENKINS_HOME&#x2F;jobs directory had incorrect permissions or ownership.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it --user root 7666058a5629 bash<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">chown -R jenkins:jenkins /var/jenkins_home<br></code></pre></td></tr></table></figure><h2 id="4-SSH服务器验证失败"><a href="#4-SSH服务器验证失败" class="headerlink" title="4 SSH服务器验证失败"></a>4 SSH服务器验证失败</h2><p>报错： stderr: No RSA host key is known for [xxx.xxx.xxx.xxx]:7999 and you have requested strict checking.</p><p>Manage Jenkins -&gt; Security -&gt; Configure Global Security</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003184529837.png" alt="image-20231003184529837"></p><h2 id="5-Docker部署jenkins配置公私钥拉取代码"><a href="#5-Docker部署jenkins配置公私钥拉取代码" class="headerlink" title="5 Docker部署jenkins配置公私钥拉取代码"></a>5 Docker部署jenkins配置公私钥拉取代码</h2><p><a href="https://blog.csdn.net/weixin_38080573/article/details/128482482">https://blog.csdn.net/weixin_38080573/article/details/128482482</a></p><h2 id="6-jdk，maven需要重新配置docker里安装的路径"><a href="#6-jdk，maven需要重新配置docker里安装的路径" class="headerlink" title="6 jdk，maven需要重新配置docker里安装的路径"></a>6 jdk，maven需要重新配置docker里安装的路径</h2><p>maven settings.xml 仓库需要配置成docker里的仓库</p><h2 id="7-设置开机自启docker"><a href="#7-设置开机自启docker" class="headerlink" title="7 设置开机自启docker"></a>7 设置开机自启docker</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">systemctl <span class="hljs-builtin-name">enable</span> docker<br></code></pre></td></tr></table></figure><h2 id="8-设置docker启动时，启动jenkins容器"><a href="#8-设置docker启动时，启动jenkins容器" class="headerlink" title="8 设置docker启动时，启动jenkins容器"></a>8 设置docker启动时，启动jenkins容器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker update --restart=always jenkins<br></code></pre></td></tr></table></figure><p>⚠️如果构建的是pipeline, 可参考以下脚本：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>  agent any<br>  stages &#123;<br>    stage(<span class="hljs-string">&#x27;Git Pull&#x27;</span>) &#123;<br>        steps &#123;<br>            <span class="hljs-comment">// 从 Git 仓库拉取代码</span><br>            deleteDir()<br>            echo <span class="hljs-string">&quot;start fetch code from git&quot;</span><br>            git <span class="hljs-attr">branch:</span> <span class="hljs-string">&#x27;sith_mom/master&#x27;</span>, <span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;sshkey-cre&#x27;</span>, <span class="hljs-attr">url:</span> <span class="hljs-string">&#x27;git@codeup.aliyun.com:61794b74d39c439da2ee88ff/SIEMENS_MMF/MMF.git&#x27;</span><br>        &#125;<br>    &#125;<br>    <br>    stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>        steps &#123;<br>            <span class="hljs-comment">// 打印当前 Java 版本</span><br>            sh <span class="hljs-string">&#x27;java -version&#x27;</span><br>            <span class="hljs-comment">// 设置 JAVA_HOME 环境变量为 JDK 1.8 的路径</span><br>            script &#123;<br>                env.JAVA_HOME = <span class="hljs-string">&#x27;/home/jdk1.8.0_381&#x27;</span><br>            &#125;<br><br>            <span class="hljs-comment">// 执行 Maven 编译</span><br>             sh <span class="hljs-string">&#x27;/home/apache-maven-3.6.3/bin/mvn -f mmf-backend/pom.xml -s /home/apache-maven-3.6.3/conf/my-settings.xml -gs /home/apache-maven-3.6.3/conf/my-settings.xml clean package -T 1C -Dmaven.test.skip=true -Dmaven.compile.fork=true&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>post &#123;<br>    always &#123;<br>        script &#123;<br>            sh <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                cd /home</span><br><span class="hljs-string">                bash feishu.sh</span><br><span class="hljs-string">             &#x27;&#x27;&#x27;</span><br>        &#125;<br>    &#125;<br>    success &#123;<br>        <span class="hljs-comment">// 构建成功后的操作</span><br>        echo <span class="hljs-string">&#x27;Build successful!&#x27;</span><br>    &#125;<br>    failure &#123;<br>        <span class="hljs-comment">// 构建失败后的操作</span><br>        echo <span class="hljs-string">&#x27;Build failed!&#x27;</span><br>    &#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>或许需要执行的操作：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">chmod</span> -R <span class="hljs-number">777</span> apache-maven-<span class="hljs-number">3</span>.<span class="hljs-number">6</span>.<span class="hljs-number">3</span><br><span class="hljs-attribute">chmod</span> <span class="hljs-number">755</span> /home/jdk<span class="hljs-number">1</span>.<span class="hljs-number">8</span>.<span class="hljs-number">0</span>_<span class="hljs-number">381</span>/bin<br><span class="hljs-attribute">chmod</span> -R <span class="hljs-number">777</span> /home/node-v<span class="hljs-number">14</span>.<span class="hljs-number">17</span>.<span class="hljs-number">1</span>-linux-x<span class="hljs-number">64</span>/bin<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>常用23种设计模式</title>
    <link href="/%E5%B8%B8%E7%94%A823%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%B8%B8%E7%94%A823%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h2><p><em>设计模式是一套被反复使用的、多数人知晓的、经过分类编目的、代码设计经验的总结。</em></p><p><strong>优点</strong></p><ul><li>重用代码</li><li>让代码更容易被他人理解</li><li>保证代码可靠性</li></ul><h2 id="2-六大原则"><a href="#2-六大原则" class="headerlink" title="2 六大原则"></a>2 六大原则</h2><ul><li><strong>开闭原则</strong>：<strong>对扩展开放，对修改关闭</strong>。在程序需要进行拓展的时候，不能去修改原有的代码，实现一个热插拔的效果。</li><li><strong>里氏代换原则</strong>：任何基类可以出现的地方，子类一定可以出现。</li><li><strong>依赖倒转原则</strong>：针对接口编程，依赖于抽象而不依赖于具体。</li><li><strong>接口隔离原则</strong>：使用多个隔离的接口，比使用单个接口要好。</li><li><strong>迪米特法则</strong>：又称最少知道原则。一个实体应当尽量少地与其他实体之间发生相互作用，使得系统功能模块相对独立。</li><li><strong>合成复用原则</strong>：尽量使用合成&#x2F;聚合的方式，而不是使用继承。</li></ul><h1 id="2-分类"><a href="#2-分类" class="headerlink" title="2 分类"></a>2 分类</h1><h2 id="1-创建型模式（五种）"><a href="#1-创建型模式（五种）" class="headerlink" title="1 创建型模式（五种）"></a>1 创建型模式（五种）</h2><p>这些模式提供了一种在创建对象的同时隐藏创建逻辑的方式，而不是使用 new 运算符直接实例化对象。</p><p><a href="https://pyr9.github.io/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">单例模式</a></p><p><a href="https://pyr9.github.io/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/">工厂模式</a></p><p><a href="https://pyr9.github.io/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/">抽象工厂模式</a></p><p><a href="https://pyr9.github.io/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/">建造者模式</a></p><p><a href="https://pyr9.github.io/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/">原型模式</a></p><h2 id="2-结构型模式（七种）"><a href="#2-结构型模式（七种）" class="headerlink" title="2. 结构型模式（七种）"></a>2. 结构型模式（七种）</h2><p>这些模式关注对象之间的组合和关系，旨在解决如何构建灵活且可复用的类和对象结构。</p><p><a href="https://pyr9.github.io/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/">适配器模式</a></p><p><a href="https://pyr9.github.io/%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/">装饰器模式</a></p><p><a href="https://pyr9.github.io/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">代理模式</a></p><p><a href="https://pyr9.github.io/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/">外观模式</a></p><p><a href="%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F">桥接模式</a></p><p><a href="https://pyr9.github.io/%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/">组合模式</a></p><p><a href="https://pyr9.github.io/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/">享元模式</a></p><h2 id="3-行为型模式（十一种）"><a href="#3-行为型模式（十一种）" class="headerlink" title="3 行为型模式（十一种）"></a>3 行为型模式（十一种）</h2><p>这些模式关注对象之间的通信和交互，旨在解决对象之间的责任分配和算法的封装。</p><p><a href="https://pyr9.github.io/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/">策略模式</a></p><p><a href="https://pyr9.github.io/%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/">模板方法模式</a></p><p><a href="https://pyr9.github.io/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/">观察者模式</a></p><p><a href="https://pyr9.github.io/%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/">迭代器模式</a></p><p><a href="https://pyr9.github.io/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/">责任链模式</a></p><p><a href="https://pyr9.github.io/%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F/">命令模式</a></p><p><a href="https://pyr9.github.io/%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F/">备忘录模式</a></p><p><a href="https://pyr9.github.io/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/">状态模式</a></p><p><a href="https://pyr9.github.io/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/">访问者模式</a></p><p><a href="https://pyr9.github.io/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F/">中介者模式</a></p><p><a href="https://pyr9.github.io/%E8%A7%A3%E9%87%8A%E5%99%A8%E6%A8%A1%E5%BC%8F/">解释器模式</a></p><h1 id="3-对比"><a href="#3-对比" class="headerlink" title="3 对比"></a>3 对比</h1><h2 id="1-享元模式与单例模式的区别"><a href="#1-享元模式与单例模式的区别" class="headerlink" title="1 享元模式与单例模式的区别"></a>1 享元模式与单例模式的区别</h2><ul><li><p>享元设计模式是一个类有很多对象，而单例是一个类仅一个对象。</p></li><li><p>享元模式是为了节约内存空间，提升程序性能，而单例模式则主要是出于共享一个实例的目的。</p></li></ul><h2 id="2-桥接模式和组合模式"><a href="#2-桥接模式和组合模式" class="headerlink" title="2 桥接模式和组合模式"></a>2 桥接模式和组合模式</h2><ul><li>组合模式强调部分和整体的组合</li><li>桥接模式强调平行级别上不同类的组合</li></ul><h2 id="3-桥接模式和适配器模式"><a href="#3-桥接模式和适配器模式" class="headerlink" title="3 桥接模式和适配器模式"></a>3 桥接模式和适配器模式</h2><p>共同点：都是为了让两个东西配合工作</p><p>区别</p><ul><li>适配器是改变已有的接口，使他们可以配合</li><li>桥接是使类的抽象和实现分离开，使层次结构组合起来</li></ul><h2 id="4-模版方法模式和策略模式"><a href="#4-模版方法模式和策略模式" class="headerlink" title="4 模版方法模式和策略模式"></a>4 模版方法模式和策略模式</h2><ul><li>策略模式可以改变算法的流程，模版方法模式不可以</li></ul><h1 id="4-项目使用"><a href="#4-项目使用" class="headerlink" title="4 项目使用"></a>4 项目使用</h1><ol><li><p>单例模式：</p><ul><li>线程池：Executors.newSingleThreadExecutor确保只有一个线程实例在运行。</li><li>数据库连接池： getInstance</li></ul></li><li><p>工厂模式：</p><ul><li>单元测试通过UserFactory， 创建测试数据</li><li>jpaQueryFactory创建一个select查询</li></ul></li><li><p>建造者模式：lombok的@Builder，创建对象。</p></li><li><p>原型模式：<code>java.lang.Cloneable</code>接口和<code>clone()</code>方法（原型模式：通过克隆现有的对象来创建新的对象）</p></li><li><p>代理模式：AOP切面，</p></li><li><p>模版方法模式：定义算法框架，允许子类重写某些步骤而不改变整体结构。</p><ul><li>工作流，conpleteFeedback(完成后回调)， getProcessDefinitionKey(获取流程定义key): 基类定义框架，子类实现</li><li>beforeSaveTrigger&#x2F;afterSaveTrigger</li></ul></li><li><p>观察者模式：ApplicationEventPublisher.publishEvent(aaa), @EventListener handle </p></li><li><p>责任链模式：Activiti 使用责任链模式处理任务分配和流程流转。<code>Command</code> 接口定义了一组操作命令，不同的 <code>Command</code> 实现类负责具体的业务逻辑（如启动流程、完成任务），<code>CommandExecutor</code> 将多个命令串联起来，按顺序执行。</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>原型模式</title>
    <link href="/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h2><p>原型模式（Prototype）是一种创建型设计模式，它通过克隆现有的对象来创建新的对象。部分场景下，性能要优于new来创建对象</p><h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2 应用场景"></a>2 应用场景</h2><ul><li>类初始化消耗比较多的资源</li><li>new一个对象需要很繁琐的过程（数据准备，访问权限等）</li><li>构造函数比较复杂</li><li>循环体中产生大量对象。（避免重复执行构造函数的操作，从而提高性能和效率）</li></ul><h2 id="3-优缺点"><a href="#3-优缺点" class="headerlink" title="3 优缺点"></a>3 优缺点</h2><p>优点：</p><ul><li>不需要调用构造函数，比直接new一个对象性能高</li><li>简化创建过程</li></ul><p>缺点：</p><ul><li>必须配备clone方法</li><li>深拷贝和浅拷贝容易引入bug</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a>2 代码实现</h1><p>我们可以使用<code>java.lang.Cloneable</code>接口和<code>clone()</code>方法来实现原型模式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Cloneable</span></span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Date birthday;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.clone();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException, NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;<br>        Date birthday = <span class="hljs-keyword">new</span> Date(<span class="hljs-number">0L</span>);<br>        Pig pig1 = <span class="hljs-keyword">new</span> Pig(<span class="hljs-string">&quot;佩奇&quot;</span>,birthday);<br>        Pig pig2 = (Pig) pig1.clone();<br>        System.out.println(pig1);<br>        System.out.println(pig2);<br><br>        pig1.getBirthday().setTime(<span class="hljs-number">666666666666L</span>);<br>        System.out.println(<span class="hljs-string">&quot;==================更新日期====================&quot;</span>);<br><br>        System.out.println(pig1);<br>        System.out.println(pig2);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003175638825.png" alt="image-20231003175638825"></p><p>可以看到，通过<code>clone()</code>方法通过调用复制构造函数来创建一个新的<code>Pig</code>对象，但是需要注意深拷贝与浅拷贝的问题。</p><p>在上面的例子中，我们期待的结果是只更新pig1的生日，但是由于pig1和pig2的生日是同一个引用，所以pīg2的生日也更新了。</p><p>clone方法做以下调整，将birthday也进行clone：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException </span>&#123;<br>    Pig pig = (Pig)<span class="hljs-keyword">super</span>.clone();<br>    <span class="hljs-comment">////深克隆</span><br>    pig.birthday = (Date) pig.birthday.clone();<br>    <span class="hljs-keyword">return</span> pig;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-克隆破坏单例"><a href="#3-克隆破坏单例" class="headerlink" title="3. 克隆破坏单例"></a>3. 克隆破坏单例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HungrySingleton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Cloneable</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> HungrySingleton hungrySingleton= <span class="hljs-keyword">new</span> HungrySingleton();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HungrySingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> hungrySingleton;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.clone();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException, NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;<br>        HungrySingleton hungrySingleton = HungrySingleton.getInstance();<br>        Method method = hungrySingleton.getClass().getDeclaredMethod(<span class="hljs-string">&quot;clone&quot;</span>);<br>        method.setAccessible(<span class="hljs-keyword">true</span>);<br>        HungrySingleton cloneHungrySingleton = (HungrySingleton) method.invoke(hungrySingleton);<br>        System.out.println(hungrySingleton);<br>        System.out.println(cloneHungrySingleton);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003181533190.png" alt="image-20231003181533190"></p><p>解决:</p><ol><li>修改clone方法</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException </span>&#123;<br>  <span class="hljs-keyword">return</span> getInstance();<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>避免单例类实现 Cloneable</li></ol><h1 id="3-JDK的使用"><a href="#3-JDK的使用" class="headerlink" title="3. JDK的使用"></a>3. JDK的使用</h1><p>实现了Cloneable的类</p><ul><li>arrayList</li><li>Hashmap</li><li>Object</li></ul>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>单例模式</title>
    <link href="/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1. 概念"></a>1. 概念</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><ul><li><p>单例模式（Singleton Pattern）是 Java 中最简单的设计模式之一。</p></li><li><p>这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。</p></li><li><p>这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。它分为懒汉式和饿汉式。注意：</p><ul><li><p>构造器必须私有化</p></li><li><p>对外必须获得一个公有的访问方式来获得实例。</p></li></ul></li></ul><h2 id="2-优缺点"><a href="#2-优缺点" class="headerlink" title="2 优缺点"></a>2 优缺点</h2><p>优点：</p><ul><li>在内存中只有一个实例，减少了内存开销</li><li>可以避免对资源的多重占用，不会出现对同一个文件同时进行写操作</li><li>设置全局访问点，严格控制访问</li></ul><p>缺点：</p><ul><li>没有接口，扩展困难</li></ul><h1 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2. 代码实现"></a>2. 代码实现</h1><h2 id="2-1-懒汉式"><a href="#2-1-懒汉式" class="headerlink" title="2.1  懒汉式"></a>2.1  懒汉式</h2><p>当程序第一次访问单例模式实例时才进行创建（延迟加载）。</p><h3 id="1-单线程实现"><a href="#1-单线程实现" class="headerlink" title="1  单线程实现"></a>1  单线程实现</h3><p> 缺点：只能在单线程下使用，多线程下会产生多个对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazySingleton</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LazySingleton singleton;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">LazySingleton</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LazySingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;<br><br>        <span class="hljs-keyword">if</span> (singleton == <span class="hljs-keyword">null</span>) &#123;<br>            singleton = <span class="hljs-keyword">new</span> LazySingleton();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> singleton;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="2-加锁多线程"><a href="#2-加锁多线程" class="headerlink" title="2  加锁多线程"></a>2  加锁多线程</h3><p>缺点：加锁进行同步，虽然可以保证单例，但效率太低，浪费大量时间。每一个线程进来调用getInstance()，都需要去获取锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Singleton2</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton2 singleton;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton2</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Singleton2 <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (singleton == <span class="hljs-keyword">null</span>) &#123;<br>            singleton = <span class="hljs-keyword">new</span> Singleton2();<br>        &#125;<br>        <span class="hljs-keyword">return</span> singleton;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-双重检查机制"><a href="#3-双重检查机制" class="headerlink" title="3  双重检查机制"></a>3  双重检查机制</h3><p>优点：保证单例的同时，也提高了效率。（每一个线程进来调用getInstance()，只有对象不为空，才需要去获取锁）</p><p>缺点：会被序列化和反射破坏单例（序列化可处理，反射不可处理）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyDoubleCheckSingleton</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> LazyDoubleCheckSingleton lazyDoubleCheckSingleton = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">LazyDoubleCheckSingleton</span><span class="hljs-params">()</span></span>&#123;<br><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LazyDoubleCheckSingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(lazyDoubleCheckSingleton == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">synchronized</span> (LazyDoubleCheckSingleton.class)&#123;<br>                <span class="hljs-keyword">if</span>(lazyDoubleCheckSingleton == <span class="hljs-keyword">null</span>)&#123;<br>                    lazyDoubleCheckSingleton = <span class="hljs-keyword">new</span> LazyDoubleCheckSingleton();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> lazyDoubleCheckSingleton;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>注意：singleton前面要加volatile关键字来保证程序运行的有序性，否则多线程访问下可能会出现对象未初始化错误！</p><blockquote><p>说明：在内存中，创建一个变量需要三步：1.申请一块内存 ；2.调用构造方法初始化 ；3 分配一个指针指向这块内存</p></blockquote><p>在编译原理中，有一个重要的内容叫做编译器优化，即在不改变原来语义的情况下，调整语句的执行顺序，来让程序运行的更快。因此存在这样一种情况，有两个线程A、B同时访问getInstance方法</p><ol><li><p>A线程判断对象为空，没来得及进行第二次判断，（时间片用完了，B线程进入）</p></li><li><p>B线程判断对象为空，执行创建变量的3步，先申请一块内存，后分配一个指针指向这块内存，但还没有进行初始化（时间片用完了，A线程进入）</p></li><li><p>A线程接着执行，发现此时singleton已经不为空了，所以直接返回，但此时返回的singleton对象虽然B线程已经new了，但还没有初始化这个实例并没有构造完成，此时如果A线程使用这个实例，程序就会出现对象未初始化错误了。</p></li></ol><h2 id="2-2-饿汉式"><a href="#2-2-饿汉式" class="headerlink" title="2.2 饿汉式"></a>2.2 饿汉式</h2><p>顾名思义，饿汉法就是在第一次引用该类的时候就创建对象实例，而不管实际是否需要创建。</p><p>优点：写法简单，在类加载的时候就完成实例化，避免线程同步。</p><h3 id="1-简单写法"><a href="#1-简单写法" class="headerlink" title="1 简单写法"></a>1 简单写法</h3><p>缺点：没有达到懒加载的效果，若果自始至终都没有用过这个对象，就会造成内存浪费。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HungrySingleton</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> HungrySingleton hungrySingleton= <span class="hljs-keyword">new</span> HungrySingleton();<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">HungrySingleton</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HungrySingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> hungrySingleton;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-静态内部类"><a href="#2-静态内部类" class="headerlink" title="2  静态内部类"></a>2  静态内部类</h3><p>这里采用了静态内部类实例singleton对象，静态内部类相当于一个静态属性，只有在第一次加载类时才会初始化，在类初始化时，别的线程是无法进入的，因此保证了线程安全。</p><p>缺点：会被序列化和反射破坏单例（序列化可处理，反射不可处理）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StaticInnerClassSingleton</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InnerClass</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> StaticInnerClassSingleton staticInnerClassSingleton = <span class="hljs-keyword">new</span> StaticInnerClassSingleton();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StaticInnerClassSingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> InnerClass.staticInnerClassSingleton;<br>    &#125;<br>  <br>  <span class="hljs-comment">// 避免反射攻击</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">StaticInnerClassSingleton</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(InnerClass.staticInnerClassSingleton != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;单例构造器禁止反射调用&quot;</span>);<br>        &#125;<br>    &#125;<br>  <span class="hljs-comment">// 避免序列化破坏单例</span><br>      <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">readResolve</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> InnerClass.staticInnerClassSingleton;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="3-枚举单例（推荐）"><a href="#3-枚举单例（推荐）" class="headerlink" title="3 枚举单例（推荐）"></a>3 枚举单例（推荐）</h3><p>对于这种方式的单例，不受反射和序列化的攻击，是最推荐的一种写法。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs wiki">单元素的枚举类型已经成为实现Singleton的最佳方法               -- 出自 《effective java》<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">EnumInstance</span> </span>&#123;<br>    INSTANCE;<br>    <span class="hljs-keyword">private</span> Object data;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getData</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> data;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setData</span><span class="hljs-params">(Object data)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.data = data;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EnumInstance <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试序列化和反序列化。可以看出枚举不受序列化影响</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestEnum</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        EnumInstance instance = EnumInstance.getInstance();<br>        instance.setData(<span class="hljs-keyword">new</span> Object());<br><br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;singleton_file&quot;</span>));<br>        oos.writeObject(instance);<br>        File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;singleton_file&quot;</span>);<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(file));<br>        EnumInstance newInstance = (EnumInstance) ois.readObject();<br><br>        System.out.println(instance.getData());<br>        System.out.println(newInstance.getData());<br>        System.out.println(instance.getData() == newInstance.getData());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003161934648.png" alt="image-20231003161934648"></p><p>测试反射。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestEnumReflect</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        EnumInstance instance = EnumInstance.getInstance();<br>        instance.setData(<span class="hljs-keyword">new</span> Object());<br><br>        <span class="hljs-comment">// enum没有无参构造器</span><br>        Constructor&lt;EnumInstance&gt; constructor = EnumInstance.class.getDeclaredConstructor(String.class, <span class="hljs-keyword">int</span>.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        EnumInstance newInstance = constructor.newInstance(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">111</span>);<br><br>        System.out.println(instance.getData());<br>        System.out.println(newInstance.getData());<br>        System.out.println(instance.getData() == newInstance.getData());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003163510478.png" alt="image-20231003163510478"></p><p>可以看到，报错 Cannot reflectively create enum objects，无法通过反射创建枚举对象</p><h1 id="3-序列化和反射破坏单例"><a href="#3-序列化和反射破坏单例" class="headerlink" title="3. 序列化和反射破坏单例"></a>3. 序列化和反射破坏单例</h1><h2 id="3-1-序列化破坏单例"><a href="#3-1-序列化破坏单例" class="headerlink" title="3.1 序列化破坏单例"></a>3.1 序列化破坏单例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HungrySingleton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> HungrySingleton hungrySingleton= <span class="hljs-keyword">new</span> HungrySingleton();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HungrySingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> hungrySingleton;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        HungrySingleton instance = HungrySingleton.getInstance();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;singleton_file&quot;</span>));<br>        oos.writeObject(instance);<br><br>        File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;singleton_file&quot;</span>);<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(file));<br>        HungrySingleton newInstance = (HungrySingleton) ois.readObject();<br><br>        System.out.println(instance);<br>        System.out.println(newInstance);<br>        System.out.println(instance == newInstance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003124316573.png" alt="image-20231003124316573"></p><p>解决方式：</p><p>HungrySingleton 增加readResolve()方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">readResolve</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-keyword">return</span> hungrySingleton;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-2-反射破坏单例"><a href="#3-2-反射破坏单例" class="headerlink" title="3.2 反射破坏单例"></a>3.2 反射破坏单例</h2><p>只可避免反射破坏饿汉式单例，无法避免反射破坏懒汉式单例。</p><h3 id="1-饿汉式单例"><a href="#1-饿汉式单例" class="headerlink" title="1. 饿汉式单例"></a>1. 饿汉式单例</h3><p>对于饿汉式，即在类初始化时创建对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestReflect</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        HungrySingleton instance = HungrySingleton.getInstance();<br><br>        Constructor&lt;HungrySingleton&gt; constructor = HungrySingleton.class.getDeclaredConstructor();<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        HungrySingleton newInstance = constructor.newInstance();<br><br>        System.out.println(instance);<br>        System.out.println(newInstance);<br>        System.out.println(instance == newInstance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003145832779.png" alt="image-20231003145832779"></p><p>由上可看出，通过反射创建了两个不同的实例。可做如下调整：</p><p>当使用无参构造器构建对象时，由于对象已经在类加载时创建，则不允许再创建新对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HungrySingleton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span>,<span class="hljs-title">Cloneable</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> HungrySingleton hungrySingleton;<br><br>    <span class="hljs-keyword">static</span>&#123;<br>        hungrySingleton = <span class="hljs-keyword">new</span> HungrySingleton();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">HungrySingleton</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(hungrySingleton != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;单例构造器禁止反射调用&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HungrySingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> hungrySingleton;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-懒汉式单例"><a href="#2-懒汉式单例" class="headerlink" title="2. 懒汉式单例"></a>2. 懒汉式单例</h3><p>即使在私有构造器中，增加了禁止反射调用的逻辑，也无法确保单例。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazySingleton</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LazySingleton lazySingleton = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">LazySingleton</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(lazySingleton != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;单例构造器禁止反射调用&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> LazySingleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(lazySingleton == <span class="hljs-keyword">null</span>)&#123;<br>            lazySingleton = <span class="hljs-keyword">new</span> LazySingleton();<br>        &#125;<br>        <span class="hljs-keyword">return</span> lazySingleton;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>当先通过反射创建对象，再通过方法调用创建对象的场景，就会产生两个不同的对象。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestReflect2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Constructor&lt;LazySingleton&gt; constructor = LazySingleton.class.getDeclaredConstructor();<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        LazySingleton newInstance = constructor.newInstance();<br><br>        LazySingleton instance = LazySingleton.getInstance();<br><br>        System.out.println(instance);<br>        System.out.println(newInstance);<br>        System.out.println(instance == newInstance);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003172322321.png" alt="image-20231003172322321"></p><p>当先通过方法调用创建对象的场景，再通过反射创建对象，则会根据逻辑阻止第二个对象的产生。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestReflect2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        LazySingleton instance = LazySingleton.getInstance();<br><br>        Constructor&lt;LazySingleton&gt; constructor = LazySingleton.class.getDeclaredConstructor();<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        LazySingleton newInstance = constructor.newInstance();<br>        <br>        System.out.println(instance);<br>        System.out.println(newInstance);<br>        System.out.println(instance == newInstance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20231003172354599.png" alt="image-20231003172354599"></p><blockquote><p> 因为二者虽然都会调用无参构造器，但是只有getInstance()方法才会将lazySingleton赋值。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>建造者模式</title>
    <link href="/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="建造者模式"><a href="#建造者模式" class="headerlink" title="建造者模式"></a>建造者模式</h1><h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1. 概念"></a>1. 概念</h1><ol><li><p>定义</p><p>将一个复杂对象的构建与他的表示分离，使得同样的构建过程可以创建不同的表示。</p></li><li><p>使用场景</p><ul><li>当对象有复杂的内部结构（很多属性）</li><li>当创造一个对象 需要很多步骤时 , 适合使用建造者模式 ;  当创造一个对象 只需要一个简单的方法就可以完成 , 适合使用工厂模式</li></ul></li><li><p>优缺点</p><ul><li><p>优点：</p><ul><li>创建和使用分离</li><li>建造类之间 相互独立 , 在 一定程度上解耦 ;</li></ul></li><li><p>缺点 :</p><ul><li><p>增加类数量 : 产生多余的 Builder 对象 ;</p></li><li><p>内部修改困难 : 如果 产品内部发生变化 , 建造者也要相应修改 ;</p></li></ul></li></ul></li><li><p>建造者模式 与 工厂模式 :</p><ul><li><p>注重点不同 : 建造者模式 更注重于 方法的调用顺序 ; 工厂模式 注重于 创建产品 , 不关心方法调用的顺序 ;</p></li><li><p>创建对象力度不同 : 创建对象的力度不同 , 建造者模式可以创建复杂的产品 , 由各种复杂的部件组成 , 工厂模式创建出来的都是相同的实例对象 ,</p></li></ul></li></ol><h1 id="2-代码"><a href="#2-代码" class="headerlink" title="2. 代码"></a>2. 代码</h1><p>教师创建课程</p><h2 id="2-1-版本1"><a href="#2-1-版本1" class="headerlink" title="2.1 版本1"></a>2.1 版本1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Coach</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> CourseBuilder courseBuilder;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCourseBuilder</span><span class="hljs-params">(CourseBuilder courseBuilder)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseBuilder = courseBuilder;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Course <span class="hljs-title">makeCourse</span><span class="hljs-params">(String courseName,String coursePPT,</span></span><br><span class="hljs-params"><span class="hljs-function">                             String courseVideo,String courseArticle,</span></span><br><span class="hljs-params"><span class="hljs-function">                             String courseQA)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.courseBuilder.buildCourseName(courseName);<br>        <span class="hljs-keyword">this</span>.courseBuilder.buildCoursePPT(coursePPT);<br>        <span class="hljs-keyword">this</span>.courseBuilder.buildCourseVideo(courseVideo);<br>        <span class="hljs-keyword">this</span>.courseBuilder.buildCourseArticle(courseArticle);<br>        <span class="hljs-keyword">this</span>.courseBuilder.buildCourseQA(courseQA);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.courseBuilder.makeCourse();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseBuilder</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseName</span><span class="hljs-params">(String courseName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCoursePPT</span><span class="hljs-params">(String coursePPT)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseVideo</span><span class="hljs-params">(String courseVideo)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseArticle</span><span class="hljs-params">(String courseArticle)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseQA</span><span class="hljs-params">(String courseQA)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Course <span class="hljs-title">makeCourse</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseActualBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CourseBuilder</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Course course = <span class="hljs-keyword">new</span> Course();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseName</span><span class="hljs-params">(String courseName)</span> </span>&#123;<br>        course.setCourseName(courseName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCoursePPT</span><span class="hljs-params">(String coursePPT)</span> </span>&#123;<br>        course.setCoursePPT(coursePPT);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseVideo</span><span class="hljs-params">(String courseVideo)</span> </span>&#123;<br>        course.setCourseVideo(courseVideo);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseArticle</span><span class="hljs-params">(String courseArticle)</span> </span>&#123;<br>        course.setCourseArticle(courseArticle);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildCourseQA</span><span class="hljs-params">(String courseQA)</span> </span>&#123;<br>        course.setCourseQA(courseQA);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Course <span class="hljs-title">makeCourse</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> course;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String courseName;<br>    <span class="hljs-keyword">private</span> String coursePPT;<br>    <span class="hljs-keyword">private</span> String courseVideo;<br>    <span class="hljs-keyword">private</span> String courseArticle;<br><br>    <span class="hljs-comment">//question &amp; answer</span><br>    <span class="hljs-keyword">private</span> String courseQA;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        CourseBuilder courseBuilder = <span class="hljs-keyword">new</span> CourseActualBuilder();<br>        Coach coach = <span class="hljs-keyword">new</span> Coach();<br>        coach.setCourseBuilder(courseBuilder);<br><br>        Course course = coach.makeCourse(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>,<br>                <span class="hljs-string">&quot;Java设计模式精讲PPT&quot;</span>,<br>                <span class="hljs-string">&quot;Java设计模式精讲视频&quot;</span>,<br>                <span class="hljs-string">&quot;Java设计模式精讲手记&quot;</span>,<br>                <span class="hljs-string">&quot;Java设计模式精讲问答&quot;</span>);<br>        System.out.println(course);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-版本2"><a href="#2-2-版本2" class="headerlink" title="2.2 版本2"></a>2.2 版本2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Course</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String courseName;<br>    <span class="hljs-keyword">private</span> String coursePPT;<br>    <span class="hljs-keyword">private</span> String courseVideo;<br>    <span class="hljs-keyword">private</span> String courseArticle;<br><br>    <span class="hljs-comment">//question &amp; answer</span><br>    <span class="hljs-keyword">private</span> String courseQA;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Course</span><span class="hljs-params">(CourseBuilder courseBuilder)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.courseName = courseBuilder.courseName;<br>        <span class="hljs-keyword">this</span>.coursePPT = courseBuilder.coursePPT;<br>        <span class="hljs-keyword">this</span>.courseVideo = courseBuilder.courseVideo;<br>        <span class="hljs-keyword">this</span>.courseArticle = courseBuilder.courseArticle;<br>        <span class="hljs-keyword">this</span>.courseQA = courseBuilder.courseQA;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseBuilder</span></span>&#123;<br>        <span class="hljs-keyword">private</span> String courseName;<br>        <span class="hljs-keyword">private</span> String coursePPT;<br>        <span class="hljs-keyword">private</span> String courseVideo;<br>        <span class="hljs-keyword">private</span> String courseArticle;<br><br>        <span class="hljs-comment">//question &amp; answer</span><br>        <span class="hljs-keyword">private</span> String courseQA;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> CourseBuilder <span class="hljs-title">buildCourseName</span><span class="hljs-params">(String courseName)</span></span>&#123;<br>            <span class="hljs-keyword">this</span>.courseName = courseName;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br><br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> CourseBuilder <span class="hljs-title">buildCoursePPT</span><span class="hljs-params">(String coursePPT)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.coursePPT = coursePPT;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> CourseBuilder <span class="hljs-title">buildCourseVideo</span><span class="hljs-params">(String courseVideo)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.courseVideo = courseVideo;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> CourseBuilder <span class="hljs-title">buildCourseArticle</span><span class="hljs-params">(String courseArticle)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.courseArticle = courseArticle;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> CourseBuilder <span class="hljs-title">buildCourseQA</span><span class="hljs-params">(String courseQA)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.courseQA = courseQA;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Course <span class="hljs-title">build</span><span class="hljs-params">()</span></span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Course(<span class="hljs-keyword">this</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Course course = <span class="hljs-keyword">new</span> Course.CourseBuilder()<br>                .buildCourseName(<span class="hljs-string">&quot;Java设计模式精讲&quot;</span>)<br>                .buildCoursePPT(<span class="hljs-string">&quot;Java设计模式精讲PPT&quot;</span>)<br>                .buildCourseVideo(<span class="hljs-string">&quot;Java设计模式精讲视频&quot;</span>)<br>                .build();<br>        System.out.println(course);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-Java的应用"><a href="#3-Java的应用" class="headerlink" title="3. Java的应用"></a>3. Java的应用</h1><ol><li>JDK 中StringBuilder, stringBuffer的append()</li></ol><ul><li><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230926215714433.png" alt="image-20230926215714433"><u></u></li></ul><ol start="2"><li><p>spring中BeanDefinitionBuilder</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230926221325746.png" alt="image-20230926221325746"></p></li><li><p>Mybatis 中MybatisSqlSessionFactoryBuilder</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230926221450251.png" alt="image-20230926221450251"></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>简单工厂模式</title>
    <link href="/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <url>/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h1><h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1. 概念"></a>1. 概念</h1><ul><li>定义：由一个工厂对象决定创建出哪一种对象的实例</li><li>优缺点：<ul><li>优点：只需要传入一个参数，就可以获取你所需要的对象，而无需知道细节</li><li>缺点：工厂的职责过重，增加新的产品，需要修改工厂的判断逻辑，违反开闭原则</li></ul></li></ul><h1 id="2-代码"><a href="#2-代码" class="headerlink" title="2. 代码"></a>2. 代码</h1><p>需求： 需要根据电影类型创建电影</p><h2 id="2-1-版本1：常规写法"><a href="#2-1-版本1：常规写法" class="headerlink" title="2.1 版本1：常规写法"></a>2.1 版本1：常规写法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaVideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;录制Java课程视频&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PythonVideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Video</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;录制Python课程视频&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        PythonVideo pythonVideo = <span class="hljs-keyword">new</span> PythonVideo();<br>        pythonVideo.produce();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-版本2：-使用简单工厂模式改造"><a href="#2-2-版本2：-使用简单工厂模式改造" class="headerlink" title="2.2 版本2： 使用简单工厂模式改造"></a>2.2 版本2： 使用简单工厂模式改造</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoFactory</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">(String type)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;java&quot;</span>.equalsIgnoreCase(type))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JavaVideo();<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;python&quot;</span>.equalsIgnoreCase(type))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PythonVideo();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        VideoFactory videoFactory = <span class="hljs-keyword">new</span> VideoFactory();<br>        Video video = videoFactory.getVideo(<span class="hljs-string">&quot;python&quot;</span>);<br>        <span class="hljs-keyword">if</span>(video == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        video.produce();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-版本3-基于反射改造，避免工厂里逻辑太复杂"><a href="#2-3-版本3-基于反射改造，避免工厂里逻辑太复杂" class="headerlink" title="2.3 版本3:  基于反射改造，避免工厂里逻辑太复杂"></a>2.3 版本3:  基于反射改造，避免工厂里逻辑太复杂</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoFactory</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Video <span class="hljs-title">getVideo</span><span class="hljs-params">(Class c)</span></span>&#123;<br>        Video video = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            video = (Video) Class.forName(c.getName()).newInstance();<br>        &#125; <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> video;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        VideoFactory videoFactory = <span class="hljs-keyword">new</span> VideoFactory();<br>        Video video = videoFactory.getVideo(JavaVideo.class);<br>        <span class="hljs-keyword">if</span>(video == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        video.produce();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="3-JDK的应用"><a href="#3-JDK的应用" class="headerlink" title="3 JDK的应用"></a>3 JDK的应用</h1><p>JDK1.8的应用：java.util.Calendar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Calendar <span class="hljs-title">createCalendar</span><span class="hljs-params">(TimeZone zone,</span></span><br><span class="hljs-params"><span class="hljs-function">                                           Locale aLocale)</span></span><br><span class="hljs-function">    </span>&#123;<br>        CalendarProvider provider =<br>            LocaleProviderAdapter.getAdapter(CalendarProvider.class, aLocale)<br>                                 .getCalendarProvider();<br>        <span class="hljs-keyword">if</span> (provider != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> provider.getInstance(zone, aLocale);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException iae) &#123;<br>                <span class="hljs-comment">// fall back to the default instantiation</span><br>            &#125;<br>        &#125;<br><br>        Calendar cal = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">if</span> (aLocale.hasExtensions()) &#123;<br>            String caltype = aLocale.getUnicodeLocaleType(<span class="hljs-string">&quot;ca&quot;</span>);<br>            <span class="hljs-keyword">if</span> (caltype != <span class="hljs-keyword">null</span>) &#123;<br>                cal = <span class="hljs-keyword">switch</span> (caltype) &#123;<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;buddhist&quot;</span> -&gt; <span class="hljs-keyword">new</span> BuddhistCalendar(zone, aLocale);<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;japanese&quot;</span> -&gt; <span class="hljs-keyword">new</span> JapaneseImperialCalendar(zone, aLocale);<br>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;gregory&quot;</span>  -&gt; <span class="hljs-keyword">new</span> GregorianCalendar(zone, aLocale);<br>                    <span class="hljs-keyword">default</span>         -&gt; <span class="hljs-keyword">null</span>;<br>                &#125;;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (cal == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// If no known calendar type is explicitly specified,</span><br>            <span class="hljs-comment">// perform the traditional way to create a Calendar:</span><br>            <span class="hljs-comment">// create a BuddhistCalendar for th_TH locale,</span><br>            <span class="hljs-comment">// a JapaneseImperialCalendar for ja_JP_JP locale, or</span><br>            <span class="hljs-comment">// a GregorianCalendar for any other locales.</span><br>            <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> The language, country and variant strings are interned.</span><br>            <span class="hljs-keyword">if</span> (aLocale.getLanguage() == <span class="hljs-string">&quot;th&quot;</span> &amp;&amp; aLocale.getCountry() == <span class="hljs-string">&quot;TH&quot;</span>) &#123;<br>                cal = <span class="hljs-keyword">new</span> BuddhistCalendar(zone, aLocale);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (aLocale.getVariant() == <span class="hljs-string">&quot;JP&quot;</span> &amp;&amp; aLocale.getLanguage() == <span class="hljs-string">&quot;ja&quot;</span><br>                       &amp;&amp; aLocale.getCountry() == <span class="hljs-string">&quot;JP&quot;</span>) &#123;<br>                cal = <span class="hljs-keyword">new</span> JapaneseImperialCalendar(zone, aLocale);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                cal = <span class="hljs-keyword">new</span> GregorianCalendar(zone, aLocale);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> cal;<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>设计模式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>mysql索引常见面试题</title>
    <link href="/mysql%E7%B4%A2%E5%BC%95%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/mysql%E7%B4%A2%E5%BC%95%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-mysql-为什么使用B-树？"><a href="#1-mysql-为什么使用B-树？" class="headerlink" title="1. mysql 为什么使用B+树？"></a>1. mysql 为什么使用B+树？</h1><ul><li><p>二叉树：单边增长的场景会导致全表扫描。</p></li><li><p>红黑树：相对平衡，比二叉树性能好，大数据下，红黑树的高度过高，会造成磁盘IO频繁。</p></li><li><p>Hash: 不支持范围查找和排序</p></li><li><p><strong>B树 VS B+树</strong>：</p></li></ul><ol><li>更高的节点利用率</li></ol><p>B+树与B树的一个关键区别在于B+树的所有数据都存储在叶子节点，而非叶子节点只存储键值和指向子节点的指针。这样可以使非叶子节点包含更多的键值和指针，提高了节点的利用率，从而减少了树的高度。</p><ol start="2"><li>更高的查询效率</li></ol><p>由于B+树的叶子节点形成了一个链表，所有的实际数据都存储在叶子节点中，这使得范围查询和顺序遍历更加高效。可以很容易地通过顺序访问叶子节点来实现范围查询，而不需要回溯。</p><ol start="3"><li>更适合磁盘存储</li></ol><p>数据库系统通常需要处理大量的数据，这些数据大部分存储在磁盘上。B+树设计更加适合磁盘存储，因为它减少了树的高度，进而减少了磁盘I&#x2F;O操作的次数。每个节点可以存储更多的指针，从而降低了访问数据时需要读取的磁盘块数量。</p><ol start="4"><li>更稳定的查询性能</li></ol><p>在B+树中，所有实际数据都在叶子节点上，非叶子节点仅作为索引使用，这意味着所有的查找操作所需的路径长度相同。因此，B+树的查询性能更加稳定。</p><p><strong>具体比较：B树 vs B+树</strong></p><ul><li><p><strong>节点结构</strong>：</p><ul><li><strong>B树</strong>：每个节点既包含键值也包含数据。</li><li><strong>B+树</strong>：所有数据都存储在叶子节点，非叶子节点只包含键值和指针。</li></ul></li><li><p><strong>数据存储位置</strong>：</p><ul><li><strong>B树</strong>：数据存储在各个节点中。</li><li><strong>B+树</strong>：数据存储在叶子节点中，且叶子节点形成链表。</li></ul></li><li><p><strong>查询性能</strong>：</p><ul><li><strong>B树</strong>：查找过程中可能在不同深度找到数据。</li><li><strong>B+树</strong>：查找路径长度相同，查询性能更稳定。</li></ul></li><li><p><strong>范围查询</strong>：</p><ul><li><p><strong>B树</strong>：范围查询需要遍历多个节点，不如B+树高效。</p></li><li><p><strong>B+树</strong>：叶子节点形成链表，顺序遍历和范围查询非常高效。</p></li></ul></li></ul><h1 id="2-聚簇索引和非聚簇索引"><a href="#2-聚簇索引和非聚簇索引" class="headerlink" title="2. 聚簇索引和非聚簇索引"></a>2. 聚簇索引和非聚簇索引</h1><h2 id="1-聚簇索引-Clustered-Index"><a href="#1-聚簇索引-Clustered-Index" class="headerlink" title="1. 聚簇索引 (Clustered Index)"></a>1. 聚簇索引 (Clustered Index)</h2><p><strong>定义</strong>： 聚簇索引将数据行的物理存储顺序与索引顺序一致。每张表只能有一个聚簇索引，因为数据行的物理存储顺序只能有一种。</p><p><strong>特点</strong>：</p><ul><li>数据行和索引存储在同一个结构中，索引叶子节点包含完整的数据行。</li><li>通常，表的主键会被作为聚簇索引。如果没有显式定义主键，MySQL 会选择一个唯一的非空索引作为聚簇索引；如果没有这样的索引，MySQL 会生成一个隐藏的行 ID 作为聚簇索引。</li><li>聚簇索引提高了基于主键的查询性能，因为索引和数据在同一个结构中，无需二次查找。</li><li>插入、更新和删除操作的性能可能会受到影响，因为数据行的物理位置可能需要调整以维持索引顺序。</li></ul><p><strong>示例</strong>： 假设有一张表 <code>employees</code>，它的主键是 <code>employee_id</code>，则 <code>employee_id</code> 字段是聚簇索引：</p><h2 id="2-非聚簇索引-Non-clustered-Index"><a href="#2-非聚簇索引-Non-clustered-Index" class="headerlink" title="2. 非聚簇索引 (Non-clustered Index)"></a>2. 非聚簇索引 (Non-clustered Index)</h2><p><strong>定义</strong>： 非聚簇索引的叶子节点包含指向数据行的指针（通常是聚簇索引键值或行 ID），而不是实际的数据行。</p><p><strong>特点</strong>：</p><ul><li>数据行的物理存储顺序与索引顺序无关。</li><li>每个表可以有多个非聚簇索引。</li><li>非聚簇索引的叶子节点存储索引键和指向数据行的指针。</li><li>通过非聚簇索引进行查询时，首先通过索引找到指针，然后根据指针找到实际的数据行，这需要一次额外的查找操作。</li></ul><p>假设有一张表 <code>employees</code>，你可以为 <code>name</code> 字段创建一个非聚簇索引：</p><h2 id="3-聚簇索引与非聚簇索引的区别"><a href="#3-聚簇索引与非聚簇索引的区别" class="headerlink" title="3 聚簇索引与非聚簇索引的区别"></a>3 聚簇索引与非聚簇索引的区别</h2><ol><li><strong>数据存储方式</strong>：<ul><li><strong>聚簇索引</strong>：数据行按索引顺序存储，叶子节点包含实际的数据行。</li><li><strong>非聚簇索引</strong>：索引结构和数据分开存储，叶子节点包含指向数据行的指针。</li></ul></li><li><strong>查询性能</strong>：<ul><li><strong>聚簇索引</strong>：对主键查询非常高效，因为不需要额外的查找操作。</li><li><strong>非聚簇索引</strong>：查询需要先通过索引找到指针，再通过指针找到数据行，有一定的查找开销。</li></ul></li><li><strong>插入、更新和删除性能</strong>：<ul><li><strong>聚簇索引</strong>：可能需要重排数据行以保持顺序，因此插入、更新和删除操作可能会更慢。</li><li><strong>非聚簇索引</strong>：只需更新索引结构，不影响数据行的物理顺序，操作相对较快。</li></ul></li><li><strong>空间使用</strong>：<ul><li><strong>聚簇索引</strong>：由于数据行存储在索引结构中，可能会占用更多的存储空间。</li><li><strong>非聚簇索引</strong>：索引结构较小，因为只包含索引键和指针。</li></ul></li></ol><h2 id="4-实际应用中的选择"><a href="#4-实际应用中的选择" class="headerlink" title="4 实际应用中的选择"></a>4 实际应用中的选择</h2><ul><li><strong>聚簇索引</strong>：适用于频繁的基于主键的查询操作，尤其是范围查询。例如，按日期或ID范围查询数据时，聚簇索引可以显著提高性能。</li><li><strong>非聚簇索引</strong>：适用于其他频繁查询的列，比如搜索、过滤和排序操作。非聚簇索引可以加快这些操作的速度，但要注意维护索引带来的额外开销。</li></ul><h1 id="3-InnoDB和MyISAM对比"><a href="#3-InnoDB和MyISAM对比" class="headerlink" title="3 InnoDB和MyISAM对比"></a>3 InnoDB和MyISAM对比</h1><p>存储引擎是对于表而言的，不同的表可以设置不同的存储引擎</p><h2 id="1-InnoDb"><a href="#1-InnoDb" class="headerlink" title="1 InnoDb"></a>1 InnoDb</h2><ul><li><p>适合需要事务和外键约束。</p></li><li><p>高度并发的读写操作性能较好。</p></li><li><p>支持行级锁定，提高并发处理能力。</p></li><li><p>支持聚簇索引和非聚簇索引。</p><ul><li>InnoDB 使用 B+ 树结构实现聚簇索引。每个 InnoDB 表都有一个聚簇索引，通常是表的主键。如果没有显式定义主键，InnoDB 会选择一个唯一的非空索引作为聚簇索引；如果没有这样的索引，InnoDB 会生成一个隐藏的行 ID 作为聚簇索引。</li><li>索引文件和数据文件是在一起的。 索引文件+ 数据文件 是xxx.ibd</li><li>叶子结点包含了完整的数据记录，data里存储的是：索引所在行的其他所有数据</li></ul></li></ul><h2 id="2-MyISAM索引"><a href="#2-MyISAM索引" class="headerlink" title="2 MyISAM索引"></a>2 MyISAM索引</h2><ul><li><p>不支持事务和外键约束。</p></li><li><p>适合读操作多于写操作的应用。</p></li><li><p>表级锁定，写操作会锁定整个表，适合低并发写操作的应用。</p></li><li><p>索引文件较小，适合大量读操作和全文索引。</p></li></ul><ul><li>只支持非聚簇索引，不支持聚簇索引。<ul><li>故MyISAM索引文件和数据文件是分离的。索引文件是xxx.MYI, 数据文件是xxx.MYD</li></ul></li></ul><blockquote><p>执行流程：当有一条查询语句：where Col1 &#x3D; 49， 先判断有没有走索引，走索引的话，先根据49快速在MYI文件中定位到结点，获取该结点存储的索引所在行的磁盘文件指针0x90，再去MYD中定位数据。</p></blockquote><h1 id="4-最左前缀法则"><a href="#4-最左前缀法则" class="headerlink" title="4 最左前缀法则"></a>4 最左前缀法则</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>对于一个多列索引，查询条件必须从索引的最左列开始并按顺序使用，否则索引不会被完全利用。MySQL 查询优化器会重新排列条件顺序，以充分利用索引。因此，即使条件顺序不同，只要包含索引的前缀部分，索引仍会被使用。</p><p>即：假设你建立了一个联合索引（A，B，C），那么在执行查询的时候  <code>where A=xx1 </code>或者 <code>where A=xx1 and B=xx2  </code>或者<code>where A=xx1 and B=xx2 and C=xx3 </code>会走索引进行查询优化，因为他们都是从最左列A开始。</p><p>比如： <code>where B=xx1 and C=xx2  </code> 就不会走索引</p><p> <code>where a=xx1 and C=xx2  </code> 就会走部分索引，即A的部分</p><h2 id="2-原因"><a href="#2-原因" class="headerlink" title="2. 原因"></a>2. 原因</h2><p>最左匹配原则都是针对联合索引来说的，所以我们可以从联合索引的原理来了解最左匹配原则。</p><p>索引的底层是一颗 B+ 树，那么联合索引当然还是一颗 B+ 树，只不过联合索引的键值数量不是一个，而是多个。构建一颗 B+ 树只能根据一个值来构建，因此数据库依据联合索引最左的字段来构建 B+ 树。形如(a,b,c)联合索引的 b+ 树。a 是有序的，而 b，c 都是无序的。但是当在 a 相同的时候，b 是有序的，b 相同的时候，c 又是有序的。即只有先确定了前一个（左侧的值）后，才能确定下一个值。</p><h1 id="5-为什么InnoDb表要尽量设定一个主键"><a href="#5-为什么InnoDb表要尽量设定一个主键" class="headerlink" title="5 为什么InnoDb表要尽量设定一个主键"></a>5 为什么InnoDb表要尽量设定一个主键</h1><ul><li>innnoDb表数据文件本身就是按B+tree组织的一个索引文件</li><li>主键是数据库确保数据行在整张表唯一性的保障.</li><li>设定了主键之后，在后续的删改查的时候可能更加快速以及确保操作数据范围安全。 </li><li>如果没有主键，InnoDB会选择一个唯一键来作为聚簇索 引，如果没有唯一键，会生成一个隐式的主键。</li></ul><h1 id="6-主键使用整型的自增ID而不是UUID？"><a href="#6-主键使用整型的自增ID而不是UUID？" class="headerlink" title="6 主键使用整型的自增ID而不是UUID？"></a>6 主键使用整型的自增ID而不是UUID？</h1><ul><li>查找元素的时候会涉及到大量的数据比较，整型比字符串快</li><li>UUID占用的存储空间会大于整形</li><li>叶子结点是按顺序排列的，如果主键索 引是自增ID，那么只需要不断向后排列即可，如果是UUID，由于到来的ID与原来的大小不确定，在维护B+树的过程中，会造成非常多的数据插入，数据移动，然后导致产生很多的内 存碎片，进而造成插入性能的下降。</li></ul><h1 id="7-联合索引是什么"><a href="#7-联合索引是什么" class="headerlink" title="7 联合索引是什么"></a>7 联合索引是什么</h1><ul><li>5个单值索引，对应5棵B+树，联合索引就只需要一棵树，所以日常推荐使用联合索引而不是单值索引。</li><li>索引排序的时候会按照字段顺序，逐个去排序</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230412331.png" alt="image-20230228230412331"></p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>zookeeper常见面试题</title>
    <link href="/zookeeper%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/zookeeper%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Zookeeper集群中有几个角色"><a href="#1-Zookeeper集群中有几个角色" class="headerlink" title="1. Zookeeper集群中有几个角色"></a>1. Zookeeper集群中有几个角色</h1><p>Zookeeper集群中有三个主要角色：</p><ul><li><strong>Leader</strong>：负责处理写请求和同步数据到Followers。</li><li><strong>Follower</strong>：处理读请求，参与选举过程。</li><li><strong>Observer</strong>：不参与投票选举，仅同步Leader的数据，用于扩展读取性能。</li></ul><h1 id="2-Zookeeper如何保证数据一致性？"><a href="#2-Zookeeper如何保证数据一致性？" class="headerlink" title="2.  Zookeeper如何保证数据一致性？"></a>2.  Zookeeper如何保证数据一致性？</h1><p>Zookeeper使用一种称为ZAB协议（Zookeeper Atomic Broadcast）的协议来保证数据的一致性。它确保所有写操作在Leader节点上进行，Leader通过广播将数据同步到Followers，从而确保数据一致性。</p><h1 id="3-什么是ZAB协议？"><a href="#3-什么是ZAB协议？" class="headerlink" title="3. 什么是ZAB协议？"></a>3. 什么是ZAB协议？</h1><p>ZAB协议（Zookeeper Atomic Broadcast）是Zookeeper用于保证数据一致性的核心协议。它包括两种主要模式：</p><ul><li><strong>消息广播模式</strong>：用于正常操作期间，将Leader上的数据更新广播到所有Followers。</li><li><strong>崩溃恢复模式</strong>：用于Leader崩溃时，选举新的Leader并同步数据。</li></ul><h1 id="4-Zookeeper集群需要多少个节点来保证高可用性？"><a href="#4-Zookeeper集群需要多少个节点来保证高可用性？" class="headerlink" title="4. Zookeeper集群需要多少个节点来保证高可用性？"></a>4. Zookeeper集群需要多少个节点来保证高可用性？</h1><p>Zookeeper集群通常由2N+1个节点组成，以保证在N个节点故障的情况下，集群仍能正常工作。例如，一个由5个节点组成的集群可以容忍2个节点故障。</p><h1 id="5-在什么情况下需要进行Leader选举？"><a href="#5-在什么情况下需要进行Leader选举？" class="headerlink" title="5. 在什么情况下需要进行Leader选举？"></a>5. 在什么情况下需要进行Leader选举？</h1><ul><li>Zookeeper集群启动时，没有Leader。</li><li>当前Leader节点崩溃或失联。</li><li>网络分区导致部分节点无法与Leader通信。</li></ul><h1 id="6-Zookeeper的选举机制是什么？"><a href="#6-Zookeeper的选举机制是什么？" class="headerlink" title="6. Zookeeper的选举机制是什么？"></a>6. Zookeeper的选举机制是什么？</h1><p>Zookeeper使用ZAB协议的Leader选举机制来选举新的Leader。选举机制主要分为以下几种情况：</p><ul><li><strong>启动期间的Leader选举</strong>：当Zookeeper集群启动时，没有Leader，所有节点会进行投票选举Leader。</li><li><strong>Leader崩溃后的Leader选举</strong>：如果Leader节点崩溃，剩余节点会重新选举新的Leader。</li></ul><h1 id="7-选举过程是怎样的？"><a href="#7-选举过程是怎样的？" class="headerlink" title="7. 选举过程是怎样的？"></a>7. 选举过程是怎样的？</h1><ol><li><p><strong>启动选举</strong>：当ZooKeeper集群启动时，所有节点（Server）都会处于 LOOKING 状态，表示它们在寻找一个领导者。</p></li><li><p><strong>投票阶段</strong>：</p><ul><li><p>每个节点向其他所有节点发送一条投票信息。投票信息包含节点自身的ID（myid）、其当前的ZXID（事务ID）、以及它认为的Leader的ID和ZXID。</p></li><li><p>节点在初始状态下会投自己作为Leader，并向其他节点发送这个投票。</p></li></ul></li><li><p><strong>接收投票</strong>：</p><ul><li><p>每个节点接收到来自其他节点的投票信息后，会对这些投票进行比较。</p></li><li><p>比较的依据是首先看ZXID，ZXID大的节点更有可能成为Leader。如果ZXID相同，则比较节点ID，ID大的节点会被选为Leader。</p></li></ul></li><li><p><strong>更新投票</strong>：</p><ul><li>如果一个节点接收到的投票信息中，存在一个比自己当前投票更高的（根据ZXID和节点ID比较），那么该节点会更新自己的投票信息，并重新发送投票。</li><li>这样不断地更新和传播投票信息，最终所有节点都会趋向于认可同一个Leader。</li></ul></li><li><p><strong>胜出者</strong>：</p><ul><li>当某个节点发现自己收到的大多数投票（超过半数）都认可同一个节点作为Leader时，这个节点就会认为选举完成，并将自己状态从LOOKING转换为FOLLOWING或LEADING。</li><li>Leader会将其他节点的状态从LOOKING转换为FOLLOWING或OBSERVING。</li></ul></li><li><p><strong>完成选举</strong>：一旦大多数节点达成一致，选举过程结束，Leader节点开始工作，Follower节点开始同步数据。。</p></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20240707232914392.png" alt="image-20240707232914392"></p><h1 id="8-Leader选举的算法是什么？"><a href="#8-Leader选举的算法是什么？" class="headerlink" title="8. Leader选举的算法是什么？"></a>8. Leader选举的算法是什么？</h1><p>Zookeeper使用Fast Paxos算法的一种变种进行Leader选举。选举过程通过比较每个节点的epoch（时代编号）和zxid（事务ID）来决定Leader，选择epoch和zxid最大的节点作为Leader。</p><h1 id="9-Zookeeper如何解决脑裂问题？"><a href="#9-Zookeeper如何解决脑裂问题？" class="headerlink" title="9.  Zookeeper如何解决脑裂问题？"></a>9.  Zookeeper如何解决脑裂问题？</h1><p>Zookeeper使用多数派机制来应对脑裂问题。在Zookeeper集群中：</p><ul><li>只有超过半数的节点同意的操作才会被执行（如写操作、Leader选举等）。即使原来的集群分裂成多个小集群，那么拥有超过原集群半数节点的集群至多只有一个，因此至多只会有一个小集群可以成功选举出leader，就避免了脑裂。</li><li>任何一个子集若未达到超过半数节点，则不能对外提供服务。</li></ul><p>具体措施包括：</p><ol><li><strong>ZAB协议</strong>：Zookeeper Atomic Broadcast协议确保在Leader崩溃后重新选举新的Leader，并同步数据，保证一致性。</li><li><strong>选举机制</strong>：Zookeeper通过快速选举算法选择新的Leader，确保选举过程高效可靠。</li><li><strong>同步机制</strong>：新的Leader当选后，会与Followers进行数据同步，确保所有节点数据一致。</li></ol><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>假设有一个由5个节点组成的Zookeeper集群：</p><ul><li>在正常情况下，所有5个节点互相通信，协调一致。</li><li>发生网络分区后，节点可能被分为两个子集，一个包含3个节点，另一个包含2个节点。</li><li>由于Zookeeper使用多数派机制，包含3个节点的子集可以继续对外提供服务（因为3 &gt; 5&#x2F;2），而包含2个节点的子集则暂停服务。</li></ul><p>通过这些机制，Zookeeper有效避免了脑裂问题，确保系统的一致性和正确性。</p><p><strong>ZooKeeper集群Leader选举中,为 什么必须超过集群总节点数量一半的节点收到相同投票,才能选举出 Leader?</strong></p><p>答:是为了防止因为集群脑裂导致整个ZooKeeper集群不可用。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>字符串旋转</title>
    <link href="/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%97%8B%E8%BD%AC/"/>
    <url>/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%97%8B%E8%BD%AC/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>股票买卖</title>
    <link href="/%E8%82%A1%E7%A5%A8%E4%B9%B0%E5%8D%96/"/>
    <url>/%E8%82%A1%E7%A5%A8%E4%B9%B0%E5%8D%96/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>二叉树算法题</title>
    <link href="/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%AE%97%E6%B3%95%E9%A2%98/"/>
    <url>/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%AE%97%E6%B3%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-基本二叉树遍历"><a href="#1-基本二叉树遍历" class="headerlink" title="1. 基本二叉树遍历"></a>1. 基本二叉树遍历</h1><h2 id="1-前序遍历（Pre-order-Traversal）"><a href="#1-前序遍历（Pre-order-Traversal）" class="headerlink" title="1. 前序遍历（Pre-order Traversal）"></a>1. 前序遍历（Pre-order Traversal）</h2><p>前序遍历的顺序是：根节点 -&gt; 左子树 -&gt; 右子树。</p><p><strong>算法步骤：</strong></p><ol><li>访问根节点。</li><li>前序遍历左子树。</li><li>前序遍历右子树。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BinaryTree</span> </span>&#123;<br>    <span class="hljs-comment">// 前序遍历 - 递归</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">preOrderTraverse</span><span class="hljs-params">(TreeNode node)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (node != <span class="hljs-keyword">null</span>) &#123;<br>            System.out.print(node.value + <span class="hljs-string">&quot; &quot;</span>);<br>            preOrderTraversal(node.left);<br>            preOrderTraversal(node.right);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-中序遍历-In-order-Traversal"><a href="#2-中序遍历-In-order-Traversal" class="headerlink" title="2. 中序遍历 (In-order Traversal)"></a>2. 中序遍历 (In-order Traversal)</h2><p>中序遍历的顺序是：<strong>左子树 -&gt; 根节点 -&gt; 右子树</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BinaryTree</span> </span>&#123;<br>    <span class="hljs-comment">// 中序遍历 - 递归</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inOrderTraverse</span><span class="hljs-params">(TreeNode node)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (node != <span class="hljs-keyword">null</span>) &#123;<br>            inOrderTraversal(node.left);<br>            System.out.print(node.value + <span class="hljs-string">&quot; &quot;</span>);<br>            inOrderTraversal(node.right);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-后序遍历-Post-order-Traversal"><a href="#3-后序遍历-Post-order-Traversal" class="headerlink" title="3. 后序遍历 (Post-order Traversal)"></a>3. 后序遍历 (Post-order Traversal)</h2><p>后序遍历的顺序是：<strong>左子树 -&gt; 右子树 -&gt; 根节点</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BinaryTree</span> </span>&#123;<br>    <span class="hljs-comment">// 后序遍历 - 递归</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postOrderTraverse</span><span class="hljs-params">(TreeNode node)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (node != <span class="hljs-keyword">null</span>) &#123;<br>            postOrderTraversal(node.left);<br>            postOrderTraversal(node.right);<br>            System.out.print(node.value + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20240526220416984.png" alt="image-20240526220416984"></p><h1 id="2-二叉树按层遍历"><a href="#2-二叉树按层遍历" class="headerlink" title="2. 二叉树按层遍历"></a>2. 二叉树按层遍历</h1><p>给你二叉树的根节点 <code>root</code> ，返回其节点值的 <strong>层序遍历</strong> 。 （即逐层地，从左到右访问所有节点）。</p><p><strong>示例 1：</strong></p><p><img src="https://assets.leetcode.com/uploads/2021/02/19/tree1.jpg" alt="img"></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs inform7">输入：root = <span class="hljs-comment">[3,9,20,null,null,15,7]</span><br>输出：<span class="hljs-comment">[<span class="hljs-comment">[3]</span>,<span class="hljs-comment">[9,20]</span>,<span class="hljs-comment">[15,7]</span>]</span><br></code></pre></td></tr></table></figure><p><strong>示例 2：</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua">输入：root = [<span class="hljs-number">1</span>]<br>输出：<span class="hljs-string">[[1]]</span><br></code></pre></td></tr></table></figure><p><strong>示例 3：</strong></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs inform7">输入：root = <span class="hljs-comment">[]</span><br>输出：<span class="hljs-comment">[]</span> <br></code></pre></td></tr></table></figure><p><strong>提示：</strong></p><ul><li>树中节点数目在范围 <code>[0, 2000]</code> 内</li><li><code>-1000 &lt;= Node.val &lt;= 1000</code></li></ul><h3 id="1-递归"><a href="#1-递归" class="headerlink" title="1. 递归"></a>1. 递归</h3><ol><li>相同层次的节点归入同一个数组</li><li>传入辅助的level参数决定层次</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;<br><br>    List&lt;List&lt;Integer&gt;&gt; levels = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; levelOrder(TreeNode root) &#123;<br>        <span class="hljs-keyword">if</span> (root == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> levels;<br>        &#125;<br>        helper(root, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> levels;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">helper</span><span class="hljs-params">(TreeNode node, <span class="hljs-keyword">int</span> level)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (levels.size() == level) &#123;<br>            levels.add(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;());<br>        &#125;<br>        levels.get(level).add(node.val);<br>        <span class="hljs-keyword">if</span> (node.left != <span class="hljs-keyword">null</span>) &#123;<br>            helper(node.left, level + <span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (node.right != <span class="hljs-keyword">null</span>) &#123;<br>            helper(node.right, level + <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-迭代"><a href="#2-迭代" class="headerlink" title="2. 迭代"></a>2. 迭代</h3><ol><li>特例处理： 当根节点为空，则返回空列表 [] 。</li><li>初始化： 打印结果列表 res &#x3D; [] ，包含根节点的队列 queue &#x3D; [root] 。</li><li>BFS 循环： 当队列 queue 为空时跳出。<ol><li>新建一个临时列表 tmp ，用于存储当前层打印结果。</li><li>当前层打印循环： 循环次数为当前层节点数（即队列 queue 长度）。<ol><li>出队： 队首元素出队，记为 node。</li><li>打印： 将 node.val 添加至 tmp 尾部。</li><li>添加子节点： 若 node 的左（右）子节点不为空，则将左（右）子节点加入队列 queue 。</li></ol></li><li>将当前层结果 tmp 添加入 res 。</li></ol></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; levelOrder(TreeNode root) &#123;<br>    List&lt;List&lt;Integer&gt;&gt; ret = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    Queue&lt;TreeNode&gt; queue = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>    queue.offer(root);<br>    <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>        List&lt;Integer&gt; level = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">int</span> currentLevelSize = queue.size();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= currentLevelSize; ++i) &#123;<br>            TreeNode node = queue.poll();<br>            level.add(node.val);<br>            <span class="hljs-keyword">if</span> (node.left != <span class="hljs-keyword">null</span>) &#123;<br>                queue.offer(node.left);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (node.right != <span class="hljs-keyword">null</span>) &#123;<br>                queue.offer(node.right);<br>            &#125;<br>        &#125;<br>        ret.add(level);<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p><code>queue.offer</code> 方法是 Java 中 <code>Queue</code> 接口的一部分，用于将元素插入到队列中。与 <code>add</code> 方法不同的是，<code>offer</code> 方法在无法插入元素时（例如队列已满的情况下）不会抛出异常。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>八股文</title>
    <link href="/%E5%85%AB%E8%82%A1%E6%96%87/"/>
    <url>/%E5%85%AB%E8%82%A1%E6%96%87/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="990cf299b562b99898c2e8bbb08ce5973cd334961c92345f25224d658311ca9e">a497b25e6862ef932bd8b8e9634b73107fd22b7c0b6aeb86f1e0db1a2c94058e2791e6883304c39a2e6156e35cf07b99817ab42434893fb4cd27fd45e3520ca6b82ade7e614a79938a947a10386348bd1c130358cb6ad33b0d989e00a81a865d716dc45dbbfe311c2668b19ee8a99d2f0ba445f8a0ab41f25b11e3e3269ea2123e4485bdf64ecf597297cb70b74a74cd4db42db6d371ed9303e6b6b5132ab8fbac7b231066e602b5439eb21bddff0b676eaa3e81a8ed634f66779be6f3604b344e451f40ce3763b9a31321c7f796144f25a10371e387e4136032fd5a076986e490ac4cea37c863fa2b647e98b2af1629aee0ad6b5976c105976f35ab756e4af370c405a31d97e0f082bebcfdb4504aaa1473d3d16c916d95df01e155aadcea9f3f0896ae945fb94ae16b302b688e09a4c5232e76d939cfe7949dee03a7fed10936781b43a2bd555dbf37b6e8c6f690895d56fb75d2605602a6d2cee7e703e86e47a66c89c35f24e7ddadbba859e4c78129b227861a7098ffa92c5b866cfe2c6fc942bbb8b01abc9e37e6c69c09d3f0155ca594be91f0a62f30ed99e3e12b16b0a8abf11e43a17820e31d071a5be29d52d691e1dca623f77fe5c5e68681930321612cc1521aebe0c013af8c08db800fdc26b8e3871b3039436116ff0fcd477d01f49565dff17146e65e9b243d14da3c8d0556ee2f6667bfb01f4ed092362fb14c031b91a291ae80efb773264882f53e76a508099392bbff87dfeabe4e5830bf8caf0507b0f27218b980b4d4b83317d604ddc3b80e7d03cbc59db549dc6e7b85aa21cdb1dec335308215380322a3bbfc2c9a6102b0f69a117b24d585daeae60d8b351a4d9635a0903afe3242a3aa78772bcac3fbf52576983d2c085db6bcea4c211082417682d2842373a337232d6259244dd62187fc40252c3d723e96cc0045f219430a133c84ccfb4245887b683a063d9d4d20ec22e25fa3502b63a97218972664d1b37c59948a3ae059c33ee3d9b6194768a77391c4ec08968c6d8e4bcd0530cb14afeeaad1b83fad90bd7769843442e2eaa3355bc9b59215d4d894f4fe76e97885ed7c2581ee4e55c2200736b78a7a62a28041eb5ecfc9ea478e2db6f8721463708a528c6acb1b6fd2f227ca91c9ee4b445b581378d8ca249324bc2fdc9d6b7d11c0d561003a95f502fb1fd1fb788c4dbd71f57d2293e7d0ab6d6b9b10e2fe5ce4ea09a9c17d76fc01f620f17571250d0c66bad081f879b38faa9744f900e8fb3c2ed76acb8467706be6e50e3762985710468709ea0d75af510bbe29f74663347c05e909b5ce12723bb7fab3cdacb18cc159908398f507036aecf9eed8454e9dc64a335a73f0d8fbf3d01a2d5bc18873babc122efe9ae5a1ebc6dd030d2f559bc1043eb7e99477fe011c3a319f6126d1db4ba6d1b7cddb56532b34d11b39e8e9b1a221c532a36eb1cf1e6860aafcb98a87390e7b74c4bd21729d2e7a737442c134e2320063499a238d089ca0a83cf27b99d2a51657ea01086bc9f4eaf492ea56f735ed11bc9bf01a43b7baead8c56456eae2300ac642aa3b42120e85bb91da84187516006f87e7959a4a60ae2d2e00ae23597ae8d482017ca04d10121c884a5ad00b6e2cd2bb360007f26aebccb720f45c3581945780baf37128b2aa830850e44bc6cdce31b89f214b6bb0e528adb2a203cccc20c5669f2834d870b8f05ab07fab4b9ab1188ff4c861ce989276f6f49458401d8c7152e7ddfb7b08c305ffddeff2a91ac5b5e2befe46ca906908693aee6720c748b8065421178e51c026c6309f706eef04a6129a8bfb672b66125c6660f4198708013a00700e8466b720a2bb8933f1f32fc06c68fc17599e5bd3f17484de70d080a4cf9eb08973b5e5d735c3e9a4dc36c0580f5ceac9e33fa7e7ce31eb86c29bc70f0fde62fd135f197f2e8570bd101629df98e9ff9f6bf4174664ee2fc6f7d85b78b7abd6a1c19fbc5533eda09a3f3567f82b5024fa0508a4169127962c0278bdb13eee418f3f1350c118f03251b2483fe27a4e87be2e07364f6bc4824ced7017dec447d6ef331610efc1df39e2795e7c891e2d2a51c355ac8d18d16a3c279ef00a256aada703eb790824753b406f624ff7e12327bc57fc7363d473625babce9cff23b12c8899a7bb57a5dea008457435fe6debe1b4f6ed969346f0113a68a66cfdd483187601fa1d4fc547dae7a63b7cadae41df714e5a722ad014e1543c89d6b6ba323759bd32cd359d277c4410980b0bb76656052374f588f82c7af568e58d5d297653d17e346fb8c411f26bcfd4088c42ffdaf26700df98f7804e4cfbc5d500a5e630efdc39ce52013a85949359489c6e23266b6794233715c29faa61d315d2a071729ed67ebe1f3059c10320959c91874740dc8f427ed035ab220f08bd8f4dddcb1586a8436a101f08e0ec5230d112638e1c36db7e36c2a51e5dac512c262e14d0c43012da22338785b71e8a7f8546ac9e21d11bdce69f22c5dcb59fbc8d9d2315bbcfa09c45b64fb897e845a7843917aab7616a2e1f76dbddf2c8a278abd0a5ab106bfbfbcbccddf7961c4316dcf34af7d612220d89613bbbe018c7931d3186b6205d594075cbdfef5a697012665cd4f87e5ac70b661dd215f174405565916794835f2b981bf20bac02ff755513f788e2732985d71cba16a90e9e29c0d4a81401024123c18eff838bf4c621398d4ee91368e84dac1d0e22d7e88ada9a549ddccf37f5b60f97cf59b2c44b05c7735b154baa83f29b6d00f29e14fad8d00bb8a32d4efe7fe84598e93e71e0909556a6844505b3f8826ea0bb8870bfe157153679bb3d93b486fefccbaa38e0b97e19ddcb70baa33975dd8a58359d2cd6ae496f8d10b25763a5e4c4f0f907466b3e74158cebfd15a87c1569044741e97cd670a4b0fb575b1b663d258ce1e2dcaf3a1ec74af58ad50c0836e49de50595e5ebdf7217d3a291598ebe627cbfe63f1742d52e0c266108f25a55e6fa4dc1547c8bb03f8133c25c3e7d47633e67b9f0b57954a8004623937f8331e35496e01b9e8bbf6818435eb047b2d94dc8df99d658e8d4b54822603bcd46c17475c08f7f1d410958d3377a5075ad8cd2ed62a2918007c820d46b978298b2e7e3afc1d700225d3df31e13a2582a7aa014d89a34ed4808c2b9cc49ac9e6a3dfef94d9c57f3e2332c8c5942a40c8eb5c1f91da44fc05e34df7aaa5a1b5ba5e620687245b26cdc9c8dca6ede611efa10940762f4b51cefb24253831973cc23ee4b488e81698efa26bb152ac3527ea7d392e641a34b1530c49771b94636678971a477ce7345630b57e6e0df878db36af74a56a1bc39d28fec67f128e595b5d876cf82703bbf75ff12b20560fbd1f5fc601ddadba9e3d3ec407ccc13e485cb023f413bd38d77089dacde2a09b1b9e1ccf263280b021cde7b01e7a3231fd5f1bbb31c5da9787a14945441e62f753080831a6396720ee2a34efb48696da7ada6e026a48cc9590f3a3f24fbae29937e872d1de4036f568e81737ded408befc92e6fc61b249c6adb27c8c0697217786c48a70778734cffc7cc5b6c255bc1fc69e113d4433298c275bb7b0b92653f1b444bc66b28053520e4f6b72c1c97c8caecd4637d12ddb4ca2baaf1048765faa184c9a6b9db45676bc7cfbc3578fe993e9d77d6c1490ed86106ae4d6ec4525a97d0f8340098b3e51f4412c59c27f66fc69008a927065298963a7e46582b8f76bede70d444fb27a3025fdcb9e0f1a60dab9126865b01c9c0bb9a02d897604014b34e149fecc2db407354e5977dcb8ce33a5ad425537869cea345170c0ad1c98bf19e6dde4460a1d1b0415bf5dcd843577de044418c7ee622c913bba7a31d87b43989dd812c6d9efcc54cc8390c61a235bc144fe28d0bcfa92bb9fc6b764f6b9955cc890b4d99d3aaef569fb79af85328ca3fa4d03cb60bb66558124a38ff4aedc086b220e61d8a0217134f37a3454364f2e98e6551c7746722b4887cd8dcc51629cd68f15d8f849776e762f2302e7786ccc0c8f5e0e7df11bf96d31cd3127b99a603c4cba3a99c2b790d3b45457ea9a7dc4f4c3c777105ae76cfd2d7ca7843df92d85f4662e77c7b1ed37a370500f6a1d24e2fb5caf8de7b5ad8160acbc5c8750a12be54d1ea9abb5109857a79c49d6981dacd405396f47f51fa343efc3b1eebd2f5d011e4cffa6d602b70009661fe0731c74cd87653825bfeddabde7b778715f3d7a40cb3742f4441baedec6dd99b27b7d8cb6b352d57065038072cf190d836547910a1656455ea1c4de6a7db024c613cbdd676b44e7ad7fe325f998a97262008b9f62655a9d16653efc68a150ddf92ffeddc651170d045b56367200b7f2c16de1d58252510e6c810f51855e6b5742758e6b8c2a54f40b878e1bbabd382f6934c6aa0db294d1b6012fd4e6b4d125d3d8f6b1a5771da98e2e817810fefefa08cdba776254ef3dd3542ae64be383455baab600feaef96197e0b6fd514500ce8ced002e367501d546af2b8d93c360348386e6cda36acda7f3ef02ef12d8baa4654928910e2bab3ea690bc72ae5bf0c78ee0850fd5134777a96c5d2c45ac00c42fa26086eb219dc851e135bc061bdd79e38c2f1378236ff8cc365ced9762b8035d6382532dbc795cdd6f7698825dc97dc62edded03c7908f11b907b86c3985cb77a8ffa23961a54cf1f73f38aca320a83fe32670fe902820d7ca560d54a79119310bef1e71b431cbacee3b89e3f7290690f836c2d4954290ab746de6e5d6af310d26d9eae41e437e206ad0b6dcf737eb5188e6cf7cf79cdec0682a35c87b55090782a91d0c1a0cdc6d14c5958bbebd8c88834158a7a68a7fccbceab158eca153ad4382ee623f7bd0b4342f3caa24453dbf25210c0b4628c85b861954991cce608dc653dcc3961e8112ed0f92db682fe5bc7524d14056854e1fff54d9bcd3b54980fcbedc2f21297cbae00e36a5d47aa65883b73e24c337c460108d1231886954f02850e1db0162335a699aa64069b9b251e1a322123143d28bc2818fc9781c383cdd6f1927eebca4ef026a7a172f198b41fb42787c23277e345d8893f93ea505263a376dd635c6beba4afe3ae4eac012d0ae97ff2f0fb149d8fbc341c09bb86d23139fb9c17732a9c28cd2f36f4bc23d39a31e0a2e705a40c5f4c290553a1e82a12f5fa8a5bbac266f3376c68d8f51bd66058dc1953db6d20abd1ed8d166cb8759b622ba7ee8d2308b1f4c31b7a8424a0c8b8339503de84bf0bd7b53c88239c3e5042349f492be7ea5da724b61ee4d5947f32b39b925ee59c04178ad6733abb1d3dd9f38ac9626e7a8e0bc904f7f1347bf5ad6d508d61affb83c2816bbd98ed8f593fd390f9723ce31bf383e266fc6b3173cc705c9b8277b2c22bdbe62d48c48ec1c771560fda11bc431c5299bfe2723b4f59dce3a98bada30b79125c2da0b2d5360fad5a94e7d32343bda5c9dfb8a634483bb11c7e0b9cd4f88c5d355298737c6c597cba4091b92edeeb8d491560dc0d6c552af0f6a6eea48a99251304656e440b4ce8c7313f7337182783640d34caefeba4242227cab606153950439d184ef82e5317998892fe615725edf9f81e70f7f6d5732b1f90af818da49b0cd1fe614fbb1d2285b62689ab323e4eeec391c07a39dee945dea85cec64b053b431514a57877ba7506aeef7a921a28bf823607478303191013ca7b82fde6c0d055c536d91d54bffb351a6cb0ebc60549821690b03fcff8061c01b1aca0ba877f49b3aee57fd0db2dad6c0a97d6b5e01e03e8b7208ef1fc6ee050f06f02e8ca0ef4e5c6ff0267106d63a2ba5e6b1e335e65e50244f834b4f7f7544d1d1c389bff6e18ab3667e7dc8f24aa0c0dbe424249842536026ebe01abb21792d8b033be866a2d8221f58e2ac8df7a9ae0560792bf97da1dc54ac35a39b32243a03c793a9b0299d2baa92ea26bd39074dfc62b40c4799741ce8106ac496c7770c55302344193ca26b056d010b56ca3299360c52542befb42c5b9a2189797a569b3e35355021ee70e82415228149ea4d6fe2d67ed732517e1de058797e79d409044f1640e8983af20fe3cc13be5aa369b578d3e3a4d156066e318e6d21fc7598913ada84d5b11dfafca3a18a3627efbaef11882d059f94be9eccf13afe05d9a2237b070a2ce7c960e8b9373c3c3329777d389f5d501e402df06625fd65879dcd81126fe939ea1e6019390e2d496633c7002bf37f25a5f410c1810044904c4de2aa96e73e4787eaedb054f565e8fbae08c3ceaa959fe0195c1906c174a4ae6072dfb5d8615245ad6b9e5de5b786209830c3613a0836dcbc1a80d90f0678b561aa884c7a3a40d32dd6082ae489b7086743ce4890dddbac8e2882bd98163844bd4029b1206ca3594896cfb347afdc732d3ab90f7e523972033a76663920de40c8c67567af349343da4d2d5f04c3dab536bd592ca697cf6d9e9584a0c3983f3e4368bdfb0c8c9f3db76da562c88f06716c18f7608d36ffb668d2115f33558fe8ba1355aafa48468449c821c0fe0032ed3fbcfecd925fc16b6f261f9f0f6251457123b903165ad17871c3f748af22547acc3e8f1491fe242daaa2315029832119bacec6b53930235abb80f8db39654068c30e180c35c11dc46741e1db2c8fe9cdd588050b011560a1b65bc0171a0fd0e6b3200410ea54d4b77beeb942ee60d1b98e54fb9ad06c1fcd0bec414195b0ee1e08cddfb209734664b90440d2f4e86fee69dc9918a25d07d8f15ad12088ec611bf4fa88d1b739287a4a04ffaf23fd0a77663fb5d3fb0b8d5221893cbdd91b91e5e4a6dd276c7a510fefdf09ec6be004cb464a39db7d0df10a10e0361349ea46f4193b9c87a7e56828860b200ed9bfe0875541691645c868456d28edb3405fa7afb24a53441ebe1dc8881776f96d7dccbfd59e9d8a5e2db7db58d971b5274844379786a34cdbf7ea5291c4ed9fd789fd35150566b64dbcb45fbeedca90fc970f9241f0f968323b25eccc562a2649c392e77f5da8a6e8e45b484cd0c0dfe9904c143310b935c75cd653348253526121e783bf13acdb49f104a0e87010fcb6d2fb715f7ddee8a65a41d3d06084d2c76e3466b16f6766cd6845b968169f2edb8ed5f0472d552dee13d7c1fd125a413b15bf514c75c710d474c98a756ed14fae9998e23606a6a88f6270f8361b1c07cdf68a8c95d1e6de1208b5c5d5da04b581f79cb08c07a65a71fea32f6427ecf4241d09d0b92aeb3f8bee0774d92d9c033a967dfd89fce089bdf165ceb2a90b9d2cae03dafc28637906f9c8fac19fbc3a7cc5fd361db732a12469988a2fe390bee6572d1ee7aee0eb2b59b5e5b4735cfe57048de40819cc6264abcc5d64b2b2cf71c0dd02ba8beac7715a672db77974c761ace21aa97929486ecf25427f34c53a8c2ce34cec21ef52eafc4c1e375c3d9cce077769e3c11bf20485f5e24be940f7e50c54afb587c0dd862698b87f2195b6ace20811f20871b4ad6c30541a7d3aebef89e2e789078c1250275c1d2ef134644f0e8e9b5272d710ed85e579bc93eb36bb6f84ede66a568f8ef9b67e66fac4ddbbe545b6b490c20ca7a81e8df95eadebb81f176333ecfd5ee5d45b6ea7dc15e274e95582abe0cb76c12f945766c0f3e81b6f7fc9d937d094a30659846248f58bcc0311581433cc01b8325d8e99500b0462e4dade7d186919d32757e84352f21b7cc59599dbbb3b68d7d0a61cc991a8d80d2c4603be3ab4cd20045c4af9c9f0e2c04bd331f1d9747c99a04c0a0602a9fe8153d84ab051893df08287cf4ecb5cf7695ce06dbb650e4b67fe399624f3c00973872db3a3523ff7ba330bef72af327a06d2dc8379782dc923b3774801ec7cb70ae502c0e06c59ca51974b78ef217eec9475bb2c615d12b0af570056c3314b70d5aef728989e32a8d85d72911fd3ced2e572109e0b39d95f8fc8611f3092041dce19e6d405faf6fb2161bd19de3aa63b448b82bec3e4479ed48df431f6346cb8d154b1b9b9bcc7f1765a2d0339f29997ca4591a40e93b12ea4148d9a50d2e20d7c75df042d9bfeb0315ef76a028061f816c2361181caebdcd1264ae48e6f4cb7c484f072b054c20f798528a4ac58a3837c4b876e59dd2c233d74b92e1b106838582ede77a0853e13246e586ca659a85d2cc3ac514207195ead502408a8eb16a96364d93c41f12013aa5aadf73e565997c86a118124fcb9247cacb827cc81db139e9d81e93ce5186f92ea4ff144211fe966f991bae5a6d4ace46afd4ee17443cb0795e8a32a27394fb85c6e6ae298b2399fabcef96c76d527114f328baecd4a346e3c093afef9078c8262ce9df388ff7e4517bb20402c302122d5a39d18acb301fd96b9c2e416b101bf4e0499184720769d8f1b5d73d8ff845049f97730c3174f145f3cf7701eebd510cc0c2f9c8585d3a4c06ca785596ea6e4efc885a6e82572b1134548b1d0579eaad39a4e75ba16fec77eee46881d53de13240256da0321759bb637fcdd60fd526b198ee6dbc3ff34d039b11876c79f5fab696d0ffc8204415fd665aefeb8df1c3d13e4db7e94f337161b4b3594af16dc5b25d97705058599eaa18d342769abfd31bb630223fc4a6435f0a4816cc29283307cea99fa1faacf9d452ee1475594355938f4b70f681de712f33dd7e83a2e40c5061d72a602cc1345c2443f42c22b4ecae52dfa90111f109f2067737447bce2e03ea19613eb29fc96594505e8f4da1948ece76db05341d8f86a373d7e0f2a4adc7c610272e7936b0f808b4fa862f6123090423248f8be3b7feb4fba0e2923b1d0675afa2b421ea694f1950424f17c8d0ab170de0711e16f9a0b071af9df68bd209e910af8cc367bf2a4b8f9c1be63b8aa0b5c161f521798470bdf07bac10d5c0fedaecf1377382d1223ce8e382f2c763e1e30386daca57cfcd160333cc57df09d1c5df4e05bb456a63dcb66f620149238655913ffccbf9521c87eb839250abd38b2b33c455ec84a23a2832038eecc875e7fc0b8daee14053a265e12a4694c4ff1c7d62f6f8f5f23b0be9aa43080a8934e94e8370e230bf456e9ce041bf618ca2e59ece6aa0a66c46c582806a0d3cb062140771fc67a4721203422d27e5f429b43a8f5093a14746b9cd8daaa03d4a98ea5d1753f75491c9c10105bce3696c543de53ccd025f92af7a37702f6e7624f3277751ec58898e42fe924ae5efbc4cd2f3cc99d7382eb98b60bfb64b34e042d4d0e6b2d2c12084760a889207339a73d5ea1887bb60b2149d48ee11a88dd4dda4f1bd94300a8d3fb688b10a5acea71a470c9bb5414acd1b20f0d1748d08cd4791e828639c3ae415b1e63d0060c407d963b708ac3da06b120820a29dbc238b2ebd83136eb1fce010d2261220f308d8f8569f7048ad5be396c09443348811699131deb7625d5530c6802e1cde4aaca53f396985077f15072177bed98762ec9f2e384e7ed1bf3eea3ba61bd3ec83967b3d7a63963f2f738471597fb8985a6626983d4168ca56810487e218b6a105639efb09f04a723a1f19df3d9a4b57dfbdee082718de5f34aeae65087bae7f52e58a2ad0cd8d7b013992f5be5c7f0b948227d18b36abb380c27ced68876670a43b5991dad40a6b9383af278ac5d42031a6a05571fff12a81336d6a57741e8cd865e25fe26130758b0e09c6033810c567d2bb15487e556235dfe766b1e077883fcb9388cb444ef252be0b12dfe19f2f260d6002a50b37d890868993f84272f81435d19221374b4f132ad655ff71f1b07323d933891c4168b8a9e1ff4bf8ca860b161f3c64d1595c9fa42e442c3e61b54829821dae7de7630c3ce5c3cae702c2e49f79e476efd4989b70f0a3fbf4b9b250f70bfe6fe80bb32ec0522bfffa0fa806415274f12fbb922938ea485cd221cb7954815a5a6374b494f463dd23eeb97e72dfef46f9bd0349a85f95bdb9062ebd23efd1ca4edfc2a8145d834d4bd433d057ee2a3acac3c3bff3ffdc66bd276ade9921f7f7e938330262fc64d0b7d9983200bcb90ee10f32d5d15ed7496a838df4e02df3c963abda977039bd5092d401c03e2f4444fe7dfade4ce1665b18baef033b774259d74eb5d7949b811d90a59a14282d396bab4f108ba5b974fa43d9119f9c6f05d423e9c3d8a4f8ed6580590bc38393458c580f92962ec36421699f63865291171bbd972e03c0f40f593504006005005475b9ccba51349b5b22d4c8c8e083e7678c0adf39f15fa2c1c2602138e24fc907b07c93a181b1148118ef8435b311618a30e87fa5c03547a7433bcfb8ef2c927f61e1b51356983262e82eedfcc3871fef83abc3a3d66e2a87c44558df27c109c4026916f693d23d03521968560a73405f924a419fb0b3dc3e1b53e76c672219629e1f2d9724e954c2599b77ad7e732324f3971a289547305017dcbd64cc863b9e8e17e3d82551864e32fd8b76dc07ff30c9c3cd4e2e57dfdc7d11c27ed667c80feebb4de30741b0ab9ad6cd417ffb82213d68f7e649cdc7f1c8225c3b7c3aacd5635550c5db0a7d8a5d07694e991952c9bce669aa92d0959c7f67986177047d6d47e5519cb8fd40c9b4a92227a208a6948ae195df65a3a9bb6b8ea6ec336de45aa85e95be9fa8ce202a0045b6c48cb7c80b55355dfc7c4570c9f96389616a4f7166a6aeffd2fd1e45dc5c9c44353cf81b7ebd8649e0b47923c8e068d0bf4a592b83a274fa761016495798c71023a4b3d91589c40fcef207c6f276ad9fc36010752444f59fb41dfddbf57eabc7cf92cca2eb424907cb38a997388e581c02292afe892b3582019e3ada1c6ac1c940f0c6bd788a34e038a251654310e43fde33b442bcbe0be641f72e48bebe5c4bdfc86dc2a2dbb4280a3857d54f496fe176dbef0b5af48382292e4be4c7ed5eef86d9a7f3c4441374e971f78e9dab516d0d8fee1b076ac10899560a69be6def6557a9cbd8e01876db20d927fcc0062948925983646ec33b0931540fb9342363ce1bf35f32e37ec0c80c8e3d049341e9310f0464d4dfc9604a709730ae9b8142bd40d3fa7c9ea73f73aad9f82300e541b763faf702b0d8250e0f64ddf4825591a89f5500d6b3941d33e717bdaf7c9086e53f58fc3a1c14a99d7eafaf3e76971fd67d05e02ddfebd754283d90b13c347a129b2eff47bc99289d31123600ab75627a3f102013ca4a8d1f71cd395a91cf2245badb899971c2f1f78c1b3343fd44a7911f1034a59b0250205364015a650add2bcd7732e3a68fb631b2760018172cc747b08e410a9afd8ddae55fc7134665bb4622b7f271d39c9f3d5754cefef4d7a57fb45257caa0903b109784c7084f25570d156dcd2b81b92c42e3cb62f2d8a7fd6fea2ee1640a3ca3922189d21b6aa3a94f6df905280436a2b4b39ca67bef8cfa1eda8fd5578b0bb3f04c19474ff11504ce1e21b1546eb4835c8c3d566c28181e3be4e00f4d323e6e11f7aab964cd1fb4aaa0c91526648e52243258820d98f54d9649e6d12754f6acba95ee9b252d96c006fd9b91c8fa3cbfaa5535335e5189d1648eafff1ceddc3cb718347532eb09d487fbf2850ce08275dc6646c4d2a02561686d8d737680eb9adb5f4d1e6d3a8a8b52ca90c2ee7dde63e765dcb035343747326094193bc47fdaf1dac1bd66a9d439b244323e29a1c7516e8232d25c188565fb477274f72c15877ed14e5bef8e6dec208666cc2bf6e5a29c2c2e48b3dc763d38e7c4ad9519baeb3b43da265b9d87f0ef7ca2cd4d07f0a6dd492b6ae5d35dd009e571a00afb65f1bcd744452c42027733541eb11093c6cc66ed4e0a0cb37a46865fc820b49bc9ad641419b578b1a7888ccc98d911ddd84eca7c69e191c603e898cdd8d7fbd171eb896f5a0d10a850824bcd6b35608ef692f026b66643aa24f69c25b5fc36cfb27ed6974fbebc5cbc1b16f7be4fb23f6094be456e95f8e4cc6c034ec3ac75efcdc24e1f2e945d7093b36306946f29dd5298d53d70ffe0377d8366848d8f89148bef8072e53fcbaba422f8b16190be1cbbaafec7a286046addaaa84cf39375e5e1847859b5e100523621de6d358d8bbb77f8de575bf850b3bd0a4d1c3b6a842b6a1f816cfbe6756a7f15ef077ca9beaad5e2270613e5e74d9b8edfa5e3332ae9730c097c17b9aa52821dc08b92384e08b18b118156c9daaf0bed66ff82bb549e479557d689bb4c45ac568c1b8ee6afd085e6b78fde762f19e7d90d366b47fc3da44226d64b657ef48de3022b573e232b8a921a6e105b79c6892c693985b135a0fd6a338fd9d54c7fe5bf39e569b1366f691c9cef3d71b83d4d6f206fdaa130a231b9a299bc984b4f31d45312d9131af4ada0523cf192e8a1703f7794a80560365e5fdb2b5492daf2ad1fe560f65211ba722cc4261f6dbd9ee9573c7bf3be8eedd52853a1672de6721cc740cf5bbc38a539f43d0ff45fd3ed4f2cc49e58071e9441e6452998c6f7d5a97a4509394e2c55d07404ab62ff6c06872eb47ddca17c9514593ebee69152dd185ad1c2005d8ff2856e224351bff86d9d01e473438c6a0de7f7fe13b35e8ef71060b231a308a7c10ac412e1be1e5122a7660ed71716bd4a692aa3f3665bada0b256e20992e48ec44a70bc1bc1571a65b7a47889fa79dfc5cd94e7b1f01010cae9bb54d34e9311ab4ba4f0d354796f9eaeaacb2c8ce3e9cc721212597e66ea954ba4910e1ae917fbede5a61ed69ff4f021a0cf1e5f0546afafd5f7fc97bbb72b565ead168ad072eab6e194e876935f08b5e704fdb5b99ebcd8d69c20c5ef5ce20d8ce68a076e9bf2723a8b3098b7d0b5de306d9a9ae3cc57fe7eb076b5bfb87288510f8918ab5f6602f4d47fe490aa0fe5fa0008d004353b0213dba8e1a9126763ab4eff71550b59bd90a28b78e874d0f60645c218176b80b1cd2302d03150d0c9b860c6c5c7bf70fdfe7f47c55d227147868234070551da77c36053b50aa14d8ae90632a9515d344995dd82e3e41d7585748abedc6cb90c75662fd6da81efe335b33bdf4321ceceb338cea784debdece460ce78f54362729b25365efc1b49434c7d9db58248eda2a79809367e3fa8025b7c020d6b8b612549d6b6e63a4b89d2090f1293228e231fa9ac1b1b32d783ccf604fccacd43fdc710ca8f3d10e8d634ed6d91e07e7a57e31ba4f788a8d32d97e022719d2e85647945e29e56a84348d87777fe33649f380afaf4c31049690e0f30ffa998b3d08ab99c2ea094a8111881efebbba0072a0e2c99c222e33ee5c925fe5ba4d1ba39c15bbb8f544d3cd82e35d77d2489ac812df362b996e4d232b9c5dd3fcacd76588f9dc967ff7d3a7173a8a6e12a411335f0f7e7512cd7f28d11a9f5662cced0f6c06f86ce0b63325f825a30041d44a30c2f55a056504c04bf07d38ec3fd12437f2f0d4722cfa5268ed82f25cbee6ff2d439da640a019cd173affc1f103a33522ae3b8fa64de46251eb47b6d19e549bdee0d9ace0f2e2abb0e7cf9ad5d3956ecf82670a125120d30fdc1970e8b31dd4169096864fa7bba4d8463dc5fac515fe001afe8a3c1bc1c7809c0f7134decabfeb4583fa6744c034c72ad1651b228429595706abb4d8ccc0f65f70ccd45c7e325e69efe8662a272549ec3951cbe1b502b9dad488b93c3fe6afac716df4ee22b0b9af0ce2fdc1ab3c74a65e385f2384c2de1a9a84ee915b886728b4dead6b631d16202ffb165c348407c1227e56312f0c9019b23220b80d597bd74249ea4112819ffba615a8c5376c3efbb265ebc53043fd323b4dbec50140445d5940f3239080860581e7fe181df18b76ff4423fa0a35c3c1a54b160247ac08d9feec60444f6c823febd1c330f0c534c7ab926d0c2037eec57740a1df477d3b94aaa8ae02fe42579d3c3e3b51fee22cfae86149172714bc6cb7decf529fc5f9c2bfc2ab153ba7e2f9531841c4b2c85d86ceb37aaaca7665b63328547ebee619358bef5051c515f9602218b9af38f51392d228bed22486e29b656b6a19c6dbdab45b43513bc34adf68f456f7a05b8d9a39a39dba504cfe6213aa2d023eea4858259d5d9d9d9f1b39ee03a34c486b872b49f468c8c852495f1efbe70289aabe1f5fbd4ad765368d11dda6494377e53f6b79d922d10b6cc02214b1fea45476edece8d5419023831bed5415432c238bb45872c2b61d3595184c53aaa59cde84b3b439ea6e114c69d63cc512ba20c41712f0e658ff02dc377e21e599e87aad192dd2fe1b0d0a23f3791aa81a7934f21eb9f3bca3aa5fcb70f1e6ef20afae32d65b2cd5e28db356592931d77006f691cf8f2cca8facedd04873fba7fb250b5613191423b064d4ac5493190c36e8fa6b5deea2030905d648e8a61ed95d21d31b084d13887a4c33605c2cb427ce3425963fa25f841eb4f211dcf6736103606682a7820fb776bba0898cabc23b9dac7c7d9c97542f758d465ed8d759b92365de83d97d2aab96846e4d496e4b8148cc6d4c010c34516f9737b1044cb4db666c93139a96fa47f62a94f20955829e355cfbc73cab58b878cfd4ee188a804c941106f9bd8b16ae759df9acd8e6bced10e470b36b7462d91e32d2986df53c19e9d6f308a96573e28f9fc307d72caf8867f45dad9c46a8f6f87741aaa8b171bea9b268b8e81975860b90172c15c758eb9a7915dd057bfaeebc8bb48ffa160d40b538679469cfea31fbe4f24160040beb672fa0c18f7560c70152049234d4e830e69dd4846f5a48a1537357fad10aadaea853d14bd070d383e97b0e53cb5422ca3f74ee6a0482533ead9447616a79d6a5f106be125467197b0d497c8df3f559d548fca1ef8dfe57d586d6de797bd0c86ae0c9948b16798b44e50a37be8fc86d2cf1bf985af7b8f40ea43a6144485c6ab57be3c2aec69a2cd4056ea11d75ef85d41efad25f3ded3658565d8845a3c4eb1698094adf5108a4a0f0fbf4492e36ffd1e38693f1f74e01f01759a38a89bb82e906310cebbbf60c85ce47dd86c6501b211def4c6f2ce78bed56e67e55b816e51c4f686bf7d4bce2080c9519e43923f81ae5f6fca6c1981c88d498a7018b553cc0eb047a6176f1af8215a0df40f5b1c0a110056b9dadd376dfcc9a0102f3b79613b19bc8f5f39a948464dac4529c3d7c7c2baeb4dc062aec98b71f5ce03f30d09d75e667eb64ce98a46b92a6abaf66095c360b5e926136d386b0abd109cb81caf5842b7ca27dadb4abe383fead352de7acbcb25cb70dc1f438d1d3b7a262321c6ade34a5208e1c3749f833869249e850e5904ab4dfccc167530fedd07d6ac1b3bd05d6e265a4a8a5770a95ba228e36f5f611de3949a09f519e29707b0df84d735c7cc6d0246a68cb2216112898ad87548a3d113c136d0a7c78f878a8e1680b9db6af922300a1a2b0f9135e434849481da960cde5e0b088df253a04189fa3d57ec687afab8aab3ae14b3c10a7f7b4c3c4707e32a29d0372ab52220ae234f51d8a3584170bfbf2c477c11bd6538abc5d0b0c211693fa68477832a5eff5f7310451a495ee72fd947167fe328fa60c9881452eb9330a1da5992434c0490290b36a370b007b70a89295fc3edd10b9ab2260951e3166f62fc2dbaf76104523c292f62c3883ee1a79b94d6a756df51da26eacc6469beadfa2007e678fa9fa8ee3aadfd1e7ba6a42ea713113b39179c3912b729f6ccf3b92f15f9f445bb9b64baf9e172048729006e82ca15b2179212c3e2f7588db63f81a77412c0ec7be315af095c281d47b1779160777efb08912cc3ce94c42378d99f1f8d3fb003e84dba0aa3c605e027a180b7c3dc0190db8f81fac2225f22bb8fb81e3de56c7516b5026287043ff4cffce3d54aea5fc1ea9bdb9948caa654f0e38d89e7aeb788ffed8767d67bd9ae574838a8a8019c69a72fafcabf96422f25d3cd8797e257c9975619d1dd6bd0092fe0ea8f3225b0a3eefd8125121954bf32ae23c72addf0dc8b64d94e4bd5f49585a050ff926033b67eb9b1940f4ad2baa5fe93e7eed50d969b9fdb7c4aeb48e3b7c5f60519e7602843bf9338f2e0d5dc5f6df3ba06bd08f58db367302b63bbde32696f5dd52d155b782aa63f45b60c12b962701a98aabcf18e233b44ea5543b544d5680e01d764028b120d465af5da9109cd82d2ea4ec75c4adada4ebbb8d58d469e31477b66ff06a8a28aba6386c58e7b890df9081a701130b2a8444c271d349501d55bd246fc11a61826691db53f59ce591760c961cbb8d1f942d3071da2f08084edcf0a9d3cb5da8976f531f2a9201b13e504cb071785a4446c70e77b38b30ca82eb6e1dc4886252c64fa6c556ab99f4f066dc51a661a8ec649de0f4357db4c9e187961b4018b29a111ec85b2c53ab9825242c397affd890736e07259a09b83f5583778cc0059890b8adbfb8b9bc1e7aa03b5d6ad4c2d65d3324f7d98b89064f6715887a8f0ffdadd5289703cdbff8ed9d3d642df74371421a8b48c72c76ddcce89aa0891607c0786e85e39802bb2ed38ba07b8706c9bd72478315a5786939c0555a87ef73476fa59d0a6eed81bca495d404e67cc4d275c179cda81b58b5a6b4f7a5fba1b9c980df1b2fc2d4940887dc27bc91ba78cacc9d213ec1f5577b6edde8db4fe230b889a794dc97c24ee7320693eb6e8501db1c2c622b98a550fcaf1f91f8e444121a2e668e653d8d3b31da8ed9f68a201e5a6bfbe1a63440c0a620e14686b4e364078f7bad92badef352b60d02d4f4036eb377e558d866da7915cf91460ff07c343ec897eff467695cb4108a9feba806a053a101dbd67b54ea35f52b13ed9e4e5bb61f7b72d7e5dc3afb92285993fa312c8d6a2dbd8885eb4b6edc27e2cafe3633459287f3f7c331b563bc24bf612217cc58d21fe8d2f028c12bd404f271d19bc99ce368d61e44b4589f0612af545a1f84951844f04405f8b0aebeb4c43d547483b3733ad942ca64ab8d63150a88f175e844d3f477286b04a0faa86900bc7a396942185e331d954efbd03a614e16b3dc6b0190f42782d56eff51b4ce74ff94a5b1ea76b04a48976f67fc0cc9fd8a2c9ee5f363428b7d12ae0502a6d75d454272c061b876c0c40d3a7573d385652b96ba97ea847dbc20b9cf90af1b6cf964d6ebb915cb0fb2f45c075a9274bb970c5c5108097e1402461eb8f4e28a579ebc416c5ec30aa4840eed70dd62ddf435799c51df49ec1f82ecf723a7b3b284df7ef07d7cb9d75caa3f49690a1aef0c2d796338bff0bde6b099facbed54a7282ab90f867e1803b946ae939a99b0b7a7811a2f89521b5df4d12e22147e9dfed8c72f01da654f1829f805c2682674dff2d240e37bb2c0b01e44c7492231f94a1312d9ae93bcbd7583688cb38fea6e8ac61a40c2380c997cfd0c02b5411a990141c126945674fe105a15629b9d29edb6c829ab2ad0ff8fb7dd7b687c40d0394fe1fd245a76873c311f9048f204edfecfb9fbda7a15fd8d4aa246953a26235283240b9bfe1dfd09ee3ba5649c9b03f8a4db77e613283832b849129257d2948aeb52ee49524b666780ad6af2824425691a701ce3307bb55e1ea19b9401edc852658576d41549fbaa84d629b324c58a50003d9723032ea28c240b0ba2809cbe0879b58f6f2733aedff1ccf0d01e4082577adf809116d83a95222fecaabd5e7fedb16cbc34d45d0fd73694deec610b3611067bb6f3302e8fbc521c1246f3a013a82edb211c4ae21603cc840105f7bfcfe61e18a0e9d4b3af1fee5db9b1c892ba6c22f8ac7e6dc81348e8f997d435c42eaf3a49c7f2deacd0b16be4b6669715fec8b6ee08a4a4d19251ad837fca56e8978b7f030a35858e4f008ede82bde9605fd28e9c89365ab2ff015dc56a5eec0b5675fbc72d531febc7e1fa89ac8d6f7a2671638af18282467ed2b6276c40d06bdc5f4a80727eddeb3b715b2b50c2bddf5eb99ea5fd6cc438b491b61357b20469c8d9f13aaa7945d729d31496b82c13bcfe5525a736361d87b4fc5113dddfe07556b4bcded982b5b3ee984f5225ad1e82a3e1aec8e9067211d3e1007600f7ea5daf884eff6fe3c98ef3a3b0b05b8e91a55f52c4590423c004c3b1a1b12b622654619c93ebd4e51380a6a8d3ef57903f6371379737380b5343a6e34b8e4574a05fbf9c6edb4eeaab270bcc3d3bc9aac99a33e42588d736c6373357c7e5dbf0fcb2a1982f503cdbd277234ada74d19026e4c80e80007abde3c0578e041e10d6070868801c867b32424bb3bdebc63af391bc8d4fbc8f61c0322a9ebacac8e5fded35d6b648aadea51678d3de370503b3d838a65e1c07c8522fad33dff25c917297596e3fccecde741992dbb3949d3d2b0255bb1014ff0ed470c8be8c1fe59a792937166d062318b92b4d3f8e60af6bf84854975d1ecb270bc022d97f349f5b036ec2cd8ac332f24f00a87c17fd0ec0cd84368001dbe11177c06de8469134bead9ec418820bfa601ca02b49d1f9cbc84e9fa8457da5f0cbd3c2eb2c430df7b4abf30efbd4e6207eb592022b48775dfaa2cbb24ce5d9f8dfdcc08798901ee2008eada275b5fcd73eb69daf3bfbce7d643deb151b1a2bbafb5444442241d721c96058a317630d2ed387656fb3c88a266b5428157ecce3b6ba810a7b6904d9930e41ad36364c80b6c04e0cc3a0de93fedab3c21396643885eb2c2404c4bb00f9b2b3edfffbc692fd5f44c60ff78c90fa7b6de30c05b9e82a0d7d426a44124e20967a4be0af792e33affa04a8f1da5f0e25cbebcf83f90e4c51d509966639cd2780bd36a3f13388d1397bbaf9d413b1de1be0bbda26708d90b1d9133dced5e0794e5b41f5c389d94a1762b86fa818b8bf8d9bc3f4f6b50b47af55309dc66ec21ec3c8dd43d13c5f3708cc7908394cdd0e42baa2ca38e72f3e84f830704eeee471fa40270a8afb1d8c468ae4a7798d7c08c762d6c4623dc85065a8bdc3873f2fe4a9f765597392f3a8eaff69284efb5850f501f716e987458ffda5980b9451a05b5c513ed2c904dffc380f9ad5416937a4e5dce77040a91e800088781293b0f76d6840b427e6ea088b34b98283f499f60640b0f6b138d42cf807cdad1cad62f8b1ed091949e3f10613f11b039526d43c4df4098741ea5f6810c391142123f8c0419518f65684bfe7e1641fcb487b3474e935754a6855c46d1ddc36b41c6cc6f6b75c14c435be7ca29a2cebb753be34f418d54102e673e0d158c15f2e72eef145b58f281314cae0e578eb704da7476ffac6f82927ce49e86334f099fed0bb40b41f2fb06f2a811345ff1e8ad154562c08d21be14fe61d80c38770f62229435fc0a72073d8b31065f1998c2337a05187b9f7d12629d929d16258996d4b28519a1f4aa018808db6f926acbabfd22e725da63786623c837dc5e85d6d2ea2a9a491aa77887c964cfcecddb420d62cad63303d1664622bf6131f0b231b3679dc4fc453ef83af34d97425d7210918ad68b71f83dca6c7d70a156e06826717c4245bc24b392889056218b2a4c8c279c1c28d71e4d3236c25afc78a33a05652cf515bc00cc4a5b0d5d69ac49fb722bccd1bdbe9d2229838dda6c26aa833faadc0ad6f03c8c3c81a58d104fcfad82f562df7673577f35791915fb942e8ccb6667d861d353bc9493ae6079854652ab90d7fac67aed55f3734c5bd829ad1976693e21b58bd33daaea14e706b1d129b36bf8e2ad29e1d9842019ed93ff341ab49d0d038171d3987b47dfe50f3fca38cb985475f06ace62bff8e2fb5772bc851715844c97e0151a89be335f4633abc5f43c77806d274ed3db9aaaa3e48a42c22a1d61ba54545fa36ffe5a484485a7a9c397579e85aaba4351e2ad3b490d38edc33ce54ba053bf7c37eaa043ba3c8dc73d6414b8b6631dc7108edefc62d582e0c4f682c2d9aa19a4a5e076534ce3cfb8a8c002e79ddd5fa05cddcb2f1f3ef13d3db973c07a5969e9de303513a57bd7790a0943d7b8e56c973767de3871480588ad7d27c8ebec37597f80c284bab6cfcebff6e950c4b5e74493decd14018e868cc78c96938135ead779a090c6da9a62994de1f1a1d6de634f4c70b1a471c2fb8f6129c8082f96c72e7f57a33b8a7334cd9b19182bba998a3f77a64e35f4d6d5d24f4ee0d22749d55921d141c2c222d2579088eef96e207320dec045c9e72bcbe2abc48d3498ebd2659720659fea6cda589c0ecd4b8d1156a9ad6051b7d86d479e3607dc7157815e467e402fafaec405c679e3bb803d6148ae58b7fcd56b528c395edbcc079e20edcf530778d11dd42ef900be651ce62b7c49110233c5bbe2f7ffaa7574a9e0239ab39d116a19b7aa7fd9afae7098187009d7050205149270c71df809bf4e9d1cf49692f6a9d985b61df80726d7dbbad577456b6f6f466ad8be9ae3ff172fbf29adfc7fd21dfcbfba0b3f5fe82ba2c575c980334f02aefe8ce46d1a5f1843b42d4153cd6e736a60d6931df61a8a332ca487a15187b71a79df6abd70a48cfff68f958604e9baf6df8b4f5df51fa168c2019b135f7a72bc91a838eb269ee1d3230847bac3076453d4c3147fe54b407fe16871bc6ab28c8d07188639910e964e6c0afd116845ace4bed9c62444275919653e81858451874d5cc83e45e5c4e640429704be65699a9697c394d3e7e657354c4089c6b64982b2a729b0e1c0bdad853e9109ead42fe337f95218efe8d404a3b73818056eff76a80003500c05193020a9e3b198c0f3c84455bdeb44fea9868d34a6b3ca7d6ac0d14261e75a150f89c5de45873a8b006e9e6ab343aca0b4a2f13846451481832286c929c65a44d42d9158bf7ee01d58e3a2a3b77356c4a017ead608008de55fd87161a19f8423fbff3a90c4be02d00d59e8ec9029fc8150ea78058ee35a8fb8ae4f50b56bb6d8927707814bae3de07faaf086412d289331a93f37256d710ca4ef8720d056fa892668ddd1c7bf70b6f80f03811235269549bfd47b64882dd235236a020ecf3eaf3f1c22bbd73f14e54bad8eb9845da48fda094737dd920ea309fda4457b96dfdee53fecbabcdd21c118124bca0feb22232f5cddc67f413a33b7cf3297b76e43d4b1cfc76ac40662a5ce27e8ddb53b9e61784380a47e59fd2336fc5eb85dbc5647d6014823aa4aa54ede71cdea9bded9692bae3694eee86ef46eb584ee4216f2d86b022d9741b1a5e80a5a1081a26b6a316f45e3b36779650c6ff5f7ecee873c900ae14461942132a8311c0dd5e091b576df9d893ea1b04d2081d975052583c2198099331d27b794948428276f517afab73994041a782c63d40308c87fc7d1b027746f9092f763004f36b51f9da832cf69789aa950699c78a97efd917789e965d3985f0a35c7e9a7207809a71310e92db02371702aece154409c6fba4ea23bbe883c6b7c718aad031f4eb9f953318f714c1904569dfebcb46291234e037c2ec1ef8bc92d15e99b73d9fc8c2086ea7331e3670c9bcce53cf99bb8e027bc9ea3c6d1fb7582f9c3a7e18b3ba09713cd49b401bad195d2a2dd322bc786f3d14413656e8586818586c4d54e77508e6ac10a158c3845a8114021a9b0abbc163a3a19765769f80337454cf9d1c94f19f4a6c05341abed869af984397d5b6720d5dd4078682838ddfd617848a4e4073da8ef74be94f6b05e341f23e21261eaeb0e3013d5028d745d9c3a41238f403411d26399b03657a46ab8335b261ad31401ddf3c0ae710285bf3084e7e84c48060504d4eb6cf407a41d90903ccfa11460547397f21717fbe8f4944f7fdf5959d62710825ca06e0bbab5ac5ae1791189e41867bde97a3a4187d238989024ba969785ff8deb1514af1ef2004f67f99f68edc3da0a0f403f331d9cc41bcce24c447e20d05fe0fc74719b7fbd90acea44dae84f9b9d00216e9dc885c9a9edde4c173abc08bee5a984bdbe882bf226672c05f3c301d1c09f10c9297fea2a0331912570fb75e7d97c41b01df3d25ed6412b471837cff4dbc0e4435ae0bd3a0072abd8c4cb58918743eb24e9226bd80707ee0c258f924614d10eb616c2669eac3922ba466ac8604eb510da8e5ba5765553432ecfc9fc7c11bfd164e188886fff00c72370050194201490139c9115d4558430fe4c3fd4bdd30aa3cee711f3220517fcb730dd9cf9a4f9aa353ff6689ee242225e327f92f9511dc30772c1a87209f078fa3e3e21804b0b8549fc22206014e1c4b7ccc7cfbc8c512a66808667279056bb9d514ba26d188745750188043991e87ee016f3b9cc0c23b37a48d330f31c6bf3eec3d327920776c686cff9e37adf1832718b0fe7109113c794cdde91e3ca6cd2245eace00a2b566ad12990bc22a7dc242b8e2f54e1eeddf39a7ba38212537a51790c1bb99049c9d837f36f03a939ed3a836646bc496ec2f3e823a2cf9363771b23bcd64243cce82334e85cca7ed5311cc348462ddc9131e569bfb5d4ed8bb3d877da10508719fe25578deaa47415664a3638603d1dd80a2e70295959664f1194aa2cf8cfa1b0a54ffff154c53b8b9c82d4ebc364dbc382e8ed027954ebe4a355fc739db4fe4d49359ccfb45e78c5c8d75d4410529f81c63802974f8ba58cf6305c2491924a06d12bd98a058ee92a2249c30f8b08cc8e718fe99e363a97f15321c6bf4dba2289a63e0c39a34d7700ef30b800d32bdb41d97ae87b3c6ec3382d666fb5815612a43a09dafe48ad1132bba4a18e81313414360e4c396602c41a4584c7c26255d841c5281629c5fb8ac4e7f5f6a7125e68e08f5dccc588f61fca8642632acfc26c85dd9f39a07757193a5e7e9dda290ba1a97415e4c387316be57d2d3ee07acbf42ff75e14762ecc429c5336a356d1736f486435c4ae29412fdb97c436f607685e6caeebf53502e8be52829c570b5f11d4d96899576cef474e2d0497909a445749fc8d6ab01bd2cf93dbb333b5ffa32fa8a587e4866e777f1bea7d116bbf5eab4f487e4280075ab2539b137bdb989575c5ba2f28c114e3c021143b0b51157e84d33944e36a398574ef2a5045547dda80a753578383693b293e14a19720b1033f46c055012cdd4f807296690d9c3113209798e6c94c55f74788d0ee3386ba2f9c4999b27ed88d05d998339111b9fe5fe48531a7a1c24cf534a0199072edaecdfac66db644889c0e119d134e14d59e34cd29cea5454dbc121a43b32aa247e82fa6a1a6ee380e8280dd1cfa718ec2953fba7cf34463f65f5d155e3f103a701e9bbb50d23d7fa2de53a71139576629b33b33188cbabe11939b7b087718522f92295274d75838885c08a8bd7673848d2828816a0d674f6c74d70cc7216480b68e7d5b067aa53a4a2a6bbdb7713cfc39b23a192b9994234fa06c8f9ae9ba736acc9b557091a077e7aa94c01f566def86bbac66f6d6b3f309f0cade7dbe19f7e1314216ac0a8ffbf35acb0ba0f9ffab96361738e1c9395599c2c13088d89460805de6a50b42cd89fc6dded22597fdafd6c1ef777791d53ed19fb2640e4aa462717d28fbb5e9f27e0d8758d9e79bc8d35ecccec0f3b1c805e553a722c1d384959af247c239d866d78656401d91f16514a178d8ef76d6dc2046d20648b368ba3c8cb864b6a5681c3557fe882a59a1e4b81853b60265fca9e293467eafaa75c27ed7426edb8253fb95f08379e9363ceb8b3d50703562c43157af444e21aa128e041c4bdb793694184cf4b9b9cef8bb1d88bb4f5ead2064aa6caf091534285d0596f9cd4f54421ebba4c4cb2e1dcdd8d73cc363478447b9b419f8042025f307d165f132b4992a292bf35c78d2e53a674ccf0994e328328280e31052b533902a5db6a160501e5d0e126d258232088abf1dc6201086d252c05ab3c9a1938eca0f725e05aba7f16db97a06b1461ca6facc72189b6e1c335b01cb166b1e446adf74ed2748d7ba89544df73babca3c2ca353815ff246212c55b67fd523d11a8d3429945c82eb6dd14ea7197454fdecd5ac6832c5aef7b94dce432cb5040cc1da81a9ec4d8ddc9afde26c0703a1a9b58fbf50c2a093cdbcd3dc12cb8093ee7f95672502612de9b4d19bc703e28b8a3cb39bedeeffe1c9ef2e325144ef90b1e4146fcefd3b1874e8af350cfdcc9b611becb7d3aed87400579f742c13387819ab7b39107fac08b50dc4c29fbcf96979e1d603c2a24b653352558107d3a06b1b4f5e986ddbaad3b879fb8bee149beab1de13a7fa01c9240117b90d6ab3a8b05d79a4ae4faa619c9a36e123ca5cd3b628672cacb8cad163ed1659f93abcd32d2b535263ab6aa5c58a309085b79bb657d6a9d341dcbdae08a0deafaaf6c581efc9e0b06189ac355e74bcbf19badcb50b69a6f34a2f5d149f5fe48f4504a065bb6580bbd9eeadda48a4d691df5b54f9b22d8342101d619f3e9b4e6336c80ba964c3905c84c2468ceb0d63ffb8d3f60fc4fbbe727ebac1a86528f4dd2d956e5d643e7e5f9298d03aa7ddd6a38cfb19d4782fcf8b361f5e25348551bf2b87a8a86b4fd57b96944e89e253d409232c4d72448ac58235210b8b73a71e9dd4ef0a0b0c18f5443aee0950446b18eed240b8d78ca731ddc8ed559ca62881527907ca0520faaa1bf613bb58b46522f588a7ef602d5888b2328fb157059c14f79af5c2ad8b57cad28d2fd76aa016149d400cde5464d64f41ced57d50f4135a4c09fa18c4e274e6bc45cf7919824c74727022ba5cb44cbeb837da383ba823db4fb1728980471594952540bb86454c2e1a202e49242905562faa519da2886943d56f624d700e69d384511e24863832335fa6711a4e419150c265e24f12c51322c8fd4ecae7fc1772b80f49da4b65203269b1f4ccc55ce5a2ce7a7a49f70aa41625ed3e74a7e0e849291fa75b9b8360a18e626ad8ba389594ebc8637c8c810e5169c1cbae86a523d9e335f83b899d129a277776d154fe8c80f71af1a01f98b7ed976b4f01ba0d5a86ece69e63b44d254ba75abfa1915175c62229cbd953e07732e4a506a415c04e80f5af4a0b48bd942ec8c2fc935797248583fdccc251cca790ca204045836df7353cf4091bc238e6dce2cb2f3616fa66ce6b43eee3c15b5665161d1e3a6caff7433c9dcbfc5af585f50c92f34b5d602ddfb2046863076ffae39ea63218f236745ecd3de29c1a01a4cb3fa6096d700fc6261acb273b58e0951ec73c55ef46902bcdecac1b0be0c8a17281bf8d9cdce74dd631b339da9b16e079502558c2991158bc097d26e35f9eddf518033c701d1caa86cb834ae4a2d9513ebabe0fa754265fde91ef0de9670ea7e90c4f94a1235711f6fe7682f91fb33b6e9ec2cd1c512e54e341c9c311ec81ed05db13e0e65764038deacc9ab651abbd5cc355bf4eb93dadd8afcf786a5a34b141ab48218bef7e34b670228bcf40407ebf3f1fd2966336b940a6baa80b5c43afd0312d3c8d65cfac0adb5b6db0ad42761a5015e80b420163d570641618494ea9006fbeb0ebb683a24c00672254328920cbfec4e0f16783f4b73b31af98dab1e464ee21895a6c4e4d4228b45eab315b731f581d69170e9a10c6694c60e701ecfd4a241eacf69742637b67ad1e6811c0c9f56b3456e63b4420e3b7f1931d4ba0fd49e167b9ae8a406fc66abb16ce6f27b74709eeddf2184bc35726c15cc3d71858a79728f603d43cf9a1711a2375fc8d63f285e00161dac28dbe95962d4e3b01e2b3fb8bf1062f84269252793d483eda0e7ea0555e10f593a15c44a20a9bce43bd9b856972c71ef43349f217c9e33ee159ff5327866ed5a6629ddad0736d54b213152f09c90ec95ffcf592818895138bfe1b1d85a7c3bde7c86e0ba301a3719c0d013afc23cae3b9c3863904706af463b533d69e9934ec9f09c43f95eae08f88c6954e35ec7f05fe1e03c99708e77cdfb88940b0e09e629c10592f5d24d2b2377445ce6f8ff6d6af2a3eede3e4a7d62737d039ab46b3b11954d3ba7382a11ac8dcf0b9b1b9fe2e5a89022c508827106ccca56e81e9eccf72faeb7a3d92244cbeff32c969cc0f58c1ccc5767ea455633c0151036291a26e3e3dcb6bbd78e0b5f17c9fbf6fe3ca728178172d840c5906911d2af50c297104bd9342de46501075f5c850f17890947e088cc7bf9765073d15a2a7c75d6e9615a6c81a8cd3d8da4cb911aac9dcb04f75fe07ae307122a510df387ea51b4015b97164103bd174255fe48cd3e3116ef6bb5f2f2fb112cf0eceeca6a5086acd81d74531b8b8ae7a01c30c295d676ce7f350413a0ebb27fd824051bf038e4c9e8e01ddb7a9702f4c7f2cb6dd6e46d974c299a5f7c6f222dad17c425e487cdd32b52560609fb4b37f488e5bb7651c61eb70543ec282f76c5475306a2427764dccd96ef5793659b0bde5e0b4a3444d9a039be9a46e7066cd4d5edd1aaccd36fe3b75fbd6ca4df7eab71fd4e1534435540d029806eb52f23ab6d554efc744021adc8756f8a00d6764d880d8d16cf1358b1bee0b1ba8f97146e53a36ae1362fca5e1c5b69b5f56fe569e27f96e2b831aa95b3c9821ea522e7c54d425f4271f65d9fcdda73fdebf74bc622ebed6a5a180a29e3bc59eb7c09f50ef426830ea7661d9568b66f51acc90b2d786626fa492b373167454be6231187623ef4116e38e07c7d8894131d629febfda9694c75ddb9c4b5c039142de19423b9d5c556e39d96213c55d20ee549fa2bd5b85f7c4ac4ca7107dc5c6c0aa68fe4d4a76e19bf3279bad31fa62f8e998fd7d6e66ed532782b717af828167ea5e47a349275093e261bf6bcebff384145f9898a24cdda636e7f6a4cf8b4727007855bc6bbc8cd60da4ab4ee2cf74da7684606938b1207fae516b4721c44442d5506392548405a9c555bc7865150d4f8470c99e2e93af5f3e09213213a9bc330e8c6903207fc440a06a10f604b085691a323049a35761717636d92a2c3c975fe17fba9c8882159be1f99f77550f3035aa4377e0b3cf4b11caf0decbe823abf39b71bf11bc63046fa5eba985bb8d511166de61f53b3746cd8328f9e83f386436d5414de71adf90083d3e4db68cf6d95e8abd030daae4ddf996ffc1826e3326808dabd801beadae04d9d483a9b5d278d5a63bc1803efd553f422cafe1c766485f78300fd66f75cb771017b08e08fc16d90d8e21f3ac7d05712f479f4efd3a464a848dbbb6563b193b0959fd64507b36b4a03671472ac3b4148ad7f4266c21960d65da968f09620743d31e16a55b62380df30d1b93abee659f4fbd59b13992b89ccadc2e2e3bc4bce25da00075f566f62787d0f61402a3db27924dfa59f43c928c3ddd77535096c00ccea28f2f21b4dcd5e9da972c2d8cb1ec2dffa29a7ad56d831d1f4d5c3444654cc6d3b3943aebfcca2dcc1eb840953be27eeed8a652816280a2611456a78987db99dd76eb9deef721e3ff578f5f9f7706a024962a5651240025b15beef01a5e7f596147e6faccf76942fc96ef8a0bd65045df021fa993bd2b7ef4521ef2a29f7734975c7e9539bd9569b3799d96a9948af19dd3d5244971b5b58bdb8edcf6a24064aa692c93dbec9036b87dde04e7c7dfca8f25bed8c94d6aa856c2ef4405c57e5f02c12590d80cd0585a9b284031eb82345749ea69556f54393d88733eace5028c28dcf3af62b46d66de1a7e69169df8443db043a2a64ef5e3db130a1b242190981360c7b278163ec2c78c9f6a2b5e0af3d5166c99ee09db4c7af6a54c878bda5833b9e7dd47e71caf0d5d752c7601153dbf49c89e6616ab5d841d6a6273708cdd52228765736ae0150f0732100f3515dca9a7ec2125bb7a4606d581d852642c2b59e8b60080be3e5a72e8a1f5f350bc98509fe6d9f03b0f74aef52c325cbe20416c4e1385799166fa2cd344aba95f7e0d2ae232d0f8714dccbc863db54592db65db025dc40d6b92eee0e611da5f5a52d33bbb7cf73c260a315a8347e37bdaeffecbf84ea8f85dbc0c86556759ee20fc77115d15f85e0f8d7632ebccc035d045c789bada065c89e0f432f4aeeb28a3e8c89261e227440233b42db34dea54cefe85a75e4aec2ed3ddd277633bdc4237353d56b4ab2f1b8153d4ac71aa08f93cd7de71ed611a98aad728dad8808e607e1ed7266cbe595760f86fdbcb875129874b4891e4b0feb689fd30afda409f9db1775f88e358992aefbfcbd6f5e9114529c0d9667edd3ff155d12e87c64d8f8b879aca4f3b405d66f7236fbd84fd375c9ec202d9fd8a7e17d75a9cf08728bfc857e37adb74440848a40b0e77aacbf48ae80331ddcd63b53573fd1265e9d643d580d7c697b8039d5f0ac4bb22f8d738f099799d54ee28c4211765ffdb86fc92855631fe576084cb8f278290cb30a1e713dbaa5fbc8d1823db02c9acf9e0c4a60439cc491e9ae839c9b9367561bf7973d3a72a2b865553dab2fbf303ad0f1f839cdac11b005dc16a10733cd6f0263964975a1c32b6d17dcc48cfb8137c4946dffb8efb42f643e3bee62057df8e492c4ea7436281f4ee4e0662725caf8f0c6283a11f64324b5583bb69325cbb6539f73070e5fbf51616ae6c97d301a8a3cc9bbe2beb4480a9c861528e0db52a399429b7168e15497ab07c8bde88083b52b519eb0096ad50fd7c6bba1c93af5518b5af8ea1ca9c6fb2a0932dfb3c1d9076bde4da467be14a1bd3268949791e2032285ed5c3c3e6fe37788c78eed3fd14714ad96a9cd277fdcb56ac288d983e097c3a900cdadb4abc46fe0d802e2a5a7adfe1de32259c1e83bbc6491e83a70d9e865784078740332ab1280ad9652a698cf507af799d768ed7e2303db083908bdf182adc0a5b931e14a8005027417dd69cd5560af91c9fef33c92f386be35b6426f9ecad19c99f39014c4ec01484c6e6b77ebf54155b6fdcfc06d2ff11f6bf44308a7074b71bd01d1bc2492a5105b60bfd6a14fe533888e2021212fbbd4996bd519d5f2b8f8a28b8f89b8b03e53a72b5642d2b620e1d1518832464dcdb1cf14f8229e986adb35cb74fc3e05fcdc4c480a95cef585d3982e869cd1983dae676040f07866d6ead76adb108f15fcffd1b42f1edb88ea6c40b5d0b89d3c5579f3ac3d4361d4e9dbe68f391a142abf6261561c701d00bb74c5fc70f1e0e0cb8dbfef2cf94dcf3d5d10c5ab7bd7ce35521a8f7246d7432a759d6f76c74ea07cab4b24e4ac04ef6dbc0d218bfa6674d4a247f28f5e34af6b6d30ca507ce08bcb81bbabac6aeec9c9e8f373ff1807bda198aa195cbf11be4a73ef909a44c19d170a1ee548aec1d4edb72973dd2261def388fa3aa024a4f77d8c0e2681ebe0011857c3c5ef48845e0b20c0ff23383d50edf64102488e80eddcea4045a8f4abad2baa2bbb9dea50feb24ed4230e176e535cbf783d0a1cc5fc72ed3aa3def114a9ac453ae4531cff4e09c70d549ab85166bf760563024476dacf9d576367c269957f98f5ac6a2155635daaf0770c03f7441831153dab82cc18dd16248e570bd520f4437eb4c869ae3305caf8384667bffb4b1658deaa73e2667434fb7afb9411375d8f1b7daa3b606e4d0a94a6702b3e5382685a3f595b590a35b58938afb6e455112e1500e1cd58c8b3e44ec735b916819e0b4a40b0f3aaf8303a25dcf5f4752c9329088950636c6672dc8e84902b2e3175260615772ee683b05ac70aba6eaa0f5fde5b8f2dfc038f5624d200a1f651cb0a3d2c0be8e5cd843ec0a7cc81cfbd2e75bdc8d51dfb730cef63b80e4f98838dcf4ee0b8ac9241ea83c833368a112b28f817c746e0e0fe364c03a87b2d34caf7f2a192693ad1eaa64db27243d5ae4bff17f0025ccb6c7c4cd6da085273def2c5d43270e61d1c3a26ff2ec5fa1bc7ccd1d78a3f295974d212723776187225a83a51cf832263fef8bd9a0bcead9de2aff0fbbf8772922b5b2befe001432c8740232cf66e7952a175ba21c498eb38633a39b87893d410914c9c2ae2ad9773e843f4ad704eae5200b08299c9e44e0351cd8911f1bed5bf05fc9b93d18a1e634d76a6d8243f5f68cfdf5b744d72a4e9eb0b60e0e65d726c013bfde0041ec228e635f2d50d8ab7ba13f3fb8956d4c20a2b2ceae9c327a8e73cee27100a8909a0847afa9da2963f4982151aa5ea697f907ebbeb6e1a2853d452e6e53fd8cc49c78a643b50f3d5c155da16d7774c15b20c081b9fbaf0349b671094ebe3da38171a8eca028b02480f51373e4cbc385a101344d0869ffbb803afc72cceeccb19201df6d41ae5c174d16fcbd45ff63daf20a275510a38f673f3147b8becf37b912637c44f0b07e8100a7e488a6a16e0b26b5dd43143887a6c4337c4f5feaaa378090d9c7c3744579e136cff1939e882a1423cac46ff8e8dac7ccd25d762a5209822897873689b078f075e3bc7f14396751595d650441ab65816fb671fb68d9726daa1fc686195d47872cd53b97cf59df846277ca43a9a82b283916e7f898d0d9cec657e35c28b86a7e41885bcb984520320089e7021b425d002edcd4bbcbd4156f1301603dacf3207506ce5b6498275b396c6a3a60a28aed5b8bdc85067e5fd3ebba7b5ffefa209c96d12c57b5702baeb75ea3fa7f6517e05dd70d5bdb651a0c15520fa89cec71cb869db009900608e750c84571ca267adaa334b7d4d2a8f32c4c5c1db00386e93644dfa8304a5bee63d9d7f61b963df976b049d42f44176c0703b380b795c628170fcb09301d5a160823df877fc33be2068fc0caed473c4a0e946798eaeacc5ba0bf582527abcad7fc9c1898a95e4a4f6c8198f4fb958c61190223415ba4b2d4ed53a597a92a54066995553d3140273cda81ed60c6af2378a8cfb5b0d28f400d1a8f10fa6ff01e7279b57f1da17756f279273eba07960dcc048a54a8bbb40155e068e62583b7cf749f07f373badc851c0a750204a2cd6de99b1492610c15ac0293c48580f353e01bf3605d317c09cb576ea4bbc017b7cb3157c8573ca3110f8e10817d355d9bc5205cb375699bed5d577bc5e86ec0184bf13b38a0904adcabd2e49095df03e3eddf18e50d9b80787cab43c1c4bc37a0496dbd09feb8c41dfbb762c4c4bb8919e07b3b00ce74975842f8f4cf5d76721b1c75d6bedaaf33ffcfa0f65871fc8f912dbb628efe1a8efcfe880902b160692703ebaa545ab0cea437b18f0719cf34d9c464461209075b20b3e6468552bfc24c451634038cb0f229585688b80ae81b0c8e0eac04c227303e34cfd44c3992e74e72b2c774d65a065c03c49b463187753c43c52d272422d8cbe3ba8d49b1c2ffdb4750d43c0b0da50aa6a3bc5d6f12d53a2ce9d1f7048455413b9ee961d1b35ff76e3c02139fbdfc5e3427815fa2415813cea9bcd526fd76ae826b3b7462b174f241c1ce88264f48aa21cd9ec17502939322a2a8822d25b470a60f8dca6b1db28d0b17018ab6765f8f7557e103ccdf06a5356286eeac74529bb4d9e070fc08d3cfea32dcc8c1a236b951103f17a2277687e4c5beff50bb58c114335e9b73f54c294460a81628cd00b2536e741e178390eaaccb3f3674fec3e15474ba8715f0ed47d483a71a5c15fd54f548b8926c2398f80508be0778aab702683ae8e221c2056072f9550a5535c23252b134209c9d313a3bb3f4662fdab94b12f0a65c04e70814c108706b5925613c4f012be5ec4b2c2c70d51cf8b2f9245f7d1f5515e5f47d1f9e7fdb21ed41aa3a2b1a9f1cc1ad12f9d2df205eda389008a87f9cdf3e40468125b5d2fb3a620b8921d103d28123418e8a9daf2e42b89ca76f54b601e7b8635c0bf6c8802c2e201a4b12df49fc4920bd8bacd90e08863fba1034453c8789407814eaa597193d2e799cc0881eb4f457e8a4f93a22560bb4ddd8f258b8149a5d85b9267c23bf5604afe5f00a323ab99e3d06bd772339c0a533a82959c382534a6c3799e71783d7e3c5531a7a014309ed56c619ac5d6d4102d8cfcdb4069ca21f613e4f2cb78465a6d26f30d809c203fbabf93fae76d34f3829a489bd78b309ef2e676dc2c128c63267dabc665b28eb9490acde77613523e58651a0a6de6368ba9f6ab3e9a0d043d9c1bb3d37c6cbc8c159af295442217b28c6235b005134e88adf269da46a357a2c683029d531880b63b248c618a5bce0020636a206558e8ecdf431587bca2f0fbbf02d8e36085c8f2b79e6b14f98e4a3d68d40228271aa35a2110e21a8d0b370bb18083d67be3b4d00875f0fc84eb67888c51b06be8617ab4f01f748978258aa93f5c0015bde7d242dbca45531204472f54f4b2059a452bfcbefaafcd243e2c0a21796251399bf6b1f1df41b7842ce57cc37070dcdc4a6f502763f40db837230176964ae2488fbaa6099164e40170e3ae9f6b623b81b56879df3ccad5a513d4296f28691c55def661325e065ad6d2541e0c5c5bebaafaef225bd1836362bf451228f0a9a3a813acbec2d410284a64bf1224a6fc8c70d764189f798cf61a1964adb9786d64b75f150b45ad90bae7591c1ff9bb1e98839c57d99c80b1480a0d9e31c90c09bfa6ad8a3f95e258532dbdff4453f9ed6c4e509f542975843c580c89ee8519309a7e5442e683c64d969b387afaf73ee5f899707ee2f7e9dd37984fe951d924e1898cf9fb18acc8940e16e7a00d63c484c312dff31149d8b852af108ab14af57a57a07466b77d148945ccc5430e2482150fd8b3eb806ddc7408b8100751ffe1f6120ba2155be0fdd22860c172c5c152131f123b7adb403bd6759e55fa745ce2adde726b2598c6ed5f85656680a2796d824f5300868e09aadd5e59a11af3db6b85235fe9a975682019cb9bcb984f730f7c47e87ae17daed4e8fe6986333db252422429be937177eae8421c4057735c978a0bc27b63429e5a7ba5c37b8013f1220a6a272b571570a1267cbbf89dd4b38a299803f0521aeb2bbd4fc8fd2b2f11de0d7c3cb5be6c549c7115b2691c1e7d4e1bb0693668df722df24a174b76bdb722e4d6b0aa9d59ababf1a987cf890b202290d6dcead0457996ce8ec4876c840bd0103bcbe4ad62caf51a74cfe97c21ac5e150fec0b83a2bd22976f445f1501b1e8c1e317abd46fb771740ef5946eb30e200b4d8d15d2697a32751069908c44be7a595f76dfb24222a2219c6416f6b01c4651b9fcef11343ea4e2991ac8ecaeb741fb96873a6a159a1342045e68f94e43b3245afc800b7f55b49bced65db2f0306384e118354978d6ccd4ef707434af00bb9cb400f20ad5ebfb21bd6141301c0b07ffc0a76f785e1c826d6a1ac38415af3db90d3fa22be05ed479f04aa16378731f16bd72a730cc1390d13d9e97d93fa8d6263136166799d090a6f1cc0f93276bf2ca2f86f122265a8615210fe6a16f6424c40a9c753893c235b644784d02d0f7c9530c693c99fa7de04e24b4cb26c5b3814f0d7bf20cfeee105fdf99c0ed8f135a313112e62e41451415d788eedfec130175e524aa84abe66cbce8df9319521a036aae34ad2b98a0de7a912e869b57334ba5063328f68b41ea5533ea3c8150e3f186d2352589b933c7c2a8892d8828ee2432f829cb15850d76dc1dffc5318f38daa06390f241b7a82a4e90947a1a694613f69a6e6b80e4b2df98c50e08d1a7421262c953480c7f3a471e163d87b40b210889e6f15477aabaded6e6650e8a8c66062059a1ec618f7e2e41f2ad8d411b447c09cbc673912e0229941a00774605a5de8d921d38f518a4418d3b2f27c80ac592b7f38f7865dea8e4b13bc0525ae8d46025e62aeb918dca6465bd3b27a697ccf9394290fdf2cf1017d7aa46c491ae93729b4cf71ee990146d9bd3a46608d5de18e3b94b4fb391a57f668fef26959e00d2678aec0976fbac8e9287e1a35e87456999e2e06a54d1e959d4148e80a363e88dbce78c86e19ef9b9722e3a5674047c000fdc959a55f89f86faa11ede7d60d595d678898e96f4a828fb16379eb45c2e6ad141aa0ba2c525564520d337139241439665571a86014a13adfab2f1341158123fdd88e3cf9c2205bcf22495fa2d12eff42adba3a15e0c51bb2d861c69784440579f7dbc412cf2a0b853a865c1e55be6293ae269444c3ba4176de43b70a26f6a8d128ecc70202d578d805f283583e1a84a2f431f82bd31ee90d9d0db8fcc01d6252287f93e1d7015d1b4d0a377a50e4e55c1c3920700aa274be398437395e2980675ede353cece26d6fcf1ad5e2b8fe12ab7be2f01369df78f69253f03be08db411b4d58c9c2e77922be3efdc3b6962993a528efde82eb0d90abad0fef71eee632a4f100c1dcfe18925b021258e6bd0c6a9fbc613a95b3479897c5619e3cec9bff6f44daf7308b363912b5fbb2467f01cd53ec66d978f0f400fd5fd0583210138afc3796705b6ef39dad33d22ec41fe5334f77431d2246b1a2f33a0d330395a5f8465a789f50dfcaa5eebfe89e547bfbcb69ff465fe66f2960cc0c82df2cf914ee2f85e2fc2ff349d23a41c8242b08fda14f2e84c7ba2ce7eddcc9280322bd949ed13d17788f712a37f187bb510054c6228d274c4c8d282cfc1bdde54c1567aeb2f7be801bc8438706297a1153d38fa60f7fbc1d87e42ad584af67a03af2509ecd5471c410e91f135679870fd02c1b2317eac4f25bd721c350899fb54485dc3cb0b7e5dbc0b999a0d2e3652aa80be06945909c2f4b0c06918401ece9cfdb2628549cae768a25c889f70aa63ca3fc67f0004e9c0af748f5b02d1efbb33762ded71bdc2093c5397216bb89245fd7546089c99309c7a2d8817b2b4645e69c00c1735ea294f2a70f1a8b339bc928522a68c7a34c55961f3c409168fb205f855e64bb2ea47f40badf2eec1ad0dcd945e92a53167a31834690079e5e4924c1ffeb0020f5662c4dbd8efb2ce6d993e4c5b16bb82655e07f49f18bf4db1052fa9540bb2b98450e7a2ebfdeeb800ae70d229d4a3c4e4b464d79cbc2f3feaa08b01647dfdae620eb0abf25430cdc9814e0658c44ab31209c142fba3c86c3798a01ba1393c7d0e8f94a1ff683c24a2db2601a7926797fd40c284c65d500583eed9cfabf3bf30907b7e6632720fac764c893eb1d559e261bad7eb0e2ad885a563634fd88ef04e78bc7ac7d46a0954f2201a8028b545fe28cdea2b01e7912ce3e9a0bcb1ab2435144ec15403441442b1977fa523745e88da3454875356a060b1ee8f967b84bcf286a38a5c7469438b4ae3355b9369163d87f9b2f7492068366ddb49aac48d22978fdd08cea18c94443aab2d16599019b860930df1442f7b5924213a31acf3838325a408e9e31d32094b7df8971906cde1f52c16f5ff8cd8a19af91a4142fcc9c60176815c1fe50434b8719c46bf344696c2b280915951c4e640d9e7020bba46aa0301fd4aaf859c9a4bd6ac0048a5c7aa4110e5be34682de51cbc5f027d414c6d4b2d9295cace00ddf3ebc71b88575092caa74fabc1c055ed2cd975e0f3a957d66e5e1eeed11beb530a131d8e9665b2cf1ed9aec1c60e45c808b0811c53951e2a930f0ab634a4d1d252b6f6162ecb2d1d97f336d7a00b0f5373a95e82f8bb5b9a225e21080d4589a32ba3547af710dc5f75cd3f92ecbce7bc21d65537df35ea1da8bf4e327b842d0e538142eaf2249e71950e6b591d4b939320f9e1dbb9d50c7a642f78850225bb17a56fa6ad8f6c56bc84a688ead3cc090a6e188f67ca8e6e8b0d3c1656d4e14766bf930592144e692480602e0c5e65eb3fd6677dceb85e1bd6593ecc05b64beb75faf78e9b738df5c3acabf28feb1906d55b03cf2fc104dedd0dc49795d267bb1e53d5682a52413a405898a9fd3be55c244998b9117bc72398e8112243022a9ceca193ee4f73991e54bcb693f772b476ffe5722095f55477deebb0eeb0f4a23d6899004ad2022617c2c2f19a185914557984f49735f8dfb5849c0999de8472e0261af8d7e2406a920a9b4c4a774a5ef5fa29ac6986f95c307482826d21e21be88d8e659406c621b69fcc1779d76cc5d1d39a4fbfc3ebd4b0056b3df574fe5740ae9f29c6b260f32e24de087fff5015596907f78377db610f19bfaa3866bab84d50fd66f3a219aa941bf288797c4963ebc2e3ee03ad35eca75968eea183288d074ecff13191515978b6501eb58f3718308a3511ebac017641f6de50093129318760192eccfa82b6ac57a1a407b0aaabd2cdee98b5ad4d29922402c55f2242289556a8ce33651ff0fc32797969c809ac0f09ba0b5c83590bc8ed882fde7031bf60ee4ba41acee1660985b787cd8f57e2815dc86225b92fb4e3db9dea087b530aff732e919cc4299b0967e6724b0c9cd5ede9a8a5ba2b2fc894d28379879f3349a3c8a3fc6bc14a6a882308f4e3fa2317d22dbe6fc33ae7b597ef54d6434c7cb251d4d2a938d679a5e5afa7dfc324960a7d3323b21f5b4fcaa0def2a11d56b6f781ac28c075e170cdf6e6c40959bf42b1193b3c094a1d729650575e9e14ba6e8a4a2770a6ca246cb74d97e989947d69799e54e6f6a5af31cc22690f2b2b9e8671f6f55e3a5885fc45b0f6af1fd5adad092459bac897463179830776d4f080ddba60d41178307b0f55c5137e0f9e6461e3e0d97d0a1de249884a96c2a4ab5fa905b66d15f3d9c803162fbb3920a65671bd1f342276ddc7e391f4031d1ad63c06e36a385de78a3ee5d64a3d05d8961c0d379fe821b063e3cbf9e92b6481a6d58a333f754770acf0470dec3beb870029607bd0a8a6c953930452150da30b788ceff97d93dc2054c8442253ac2890b050b5b1de3809fdf38defdf9b945346688546d482099f83575922d34cb923787fd998d819e746ce6ce7ed1206f667135fa8b575ac041f22d68001132b94d5c48eb6f1af6bafd69da41703b239b08669766ea4b4d02696e66ad82b30580bac3041c43073cf515e29adf46e69a8aff93ea9ac16077aff6f3c43b4b0ec92e3cb5dc7f28763b8e0e0adc09176fa45553e8429fb32c9be997d804fad57ed39c117150a4869a3888e4ec0fb5b926b88f5d5dead35acb36b539e58d115dd0a9a5f62f35b5944e6666da5ab5c18f71212b632d72d0886bb998978762def7904cc63f60651a57164884948bad3ea681fcc5eff732f8a97d42a9ffd0fb64a84ad7f7f706e7cbdada167312c0af041dc95058ed0cab5ac3e52cdb57e309deb2adc676f89b50a4d2548ddbc88f6a8400423cfdadbdb812b8ff985562b1275812821f2f4a8f8fb961f8057ebde69cdce29527124b3caa82d53df40b46b4b7cb5aa8366ca0b1fb62fb33cfbf37adfa30844c1b6064a82a2baf6f4f9ef8a7354ad28a77c2c4bcd0538c32e6d25688ef08fc4ecf1d58f8564a66bf350874e97ba0899d955a374ed7fdb77110df4deabe197dfd07c66bab8b156948c9dc45a0af49c7fbdd16dc81a488910588f1ef2802d0f105646c4b0b7e4469e0e8a40b4173d0c6e9a945267fd51fc248e871a824a91dfeeb03b0e627dbe955acf7feb724e09d2199a7eb502156818e9400a3b98890d4e3eeff0df7c857363c68637d361a7f418af39f89940e5b3d910995053b5d571e617c495826d241948f70a081036a00c50431f3d3ce6970835b4d64116a8d2ad48a5a29144de408f301f8ce548caabed85d0d4b904831225764015f56291d089d99acdd4efa7986a759df3cd742d73d424cefe6f30fe96c794737bbf9ea349d42e1198298c86900dd5f1969854e6841a4ce842b1b656737a7e6b4ddb260c31e3613fa6a06fe890f0217af1d33a950313cc59c6a826728efdbcf5229486d134d1b706c3977dd6f33d0ca28368e8b67cef33867426042b98e394373c75d19081ed434d10076623796d3322957357db69127405537ab57e3d26ddd2012d85300640bfac573e2111539ff7868eecbcbe3ad632c0e7397dd3ebbca811bbef43a4b2aab3e2eb4b51cfc4e3cbc28881bae18117aa38e5c82a65656ab17bbe1a8f1e49cb8138292e1527bfe78f64980c44d6653639ad587ce479f6ceb9afea95dc204ff8154b666283d58cecadab5c8d0a67049affb07ed569e7d16b34dbde3e36587db2fa1892705d9935e9f8da2d2cc5401b597d0311829a9d52ffe4efcf52a547b7aeaa58aeb9f78df2f1b2d2970225c1fd67a67aff52fa699891ad18faf16a09832c1cfe9e897b9a40b21a3e2498edab940d77cd01afa5fe1e3d191166777e1c5eae5bceb78c4ca184e70fa954bae5cf0526f44029adc2d80dfd33d6f488b5e2e3a4164b271f223926ff63dc65971c1dd51dcfee2b5cec1953d12b384b82c553ef3b5c13ff71214ce6a3e0b05cf52203e8648f7a93ea08d5ea03e14b375fe96809bb4e1fcef9a9faa3d39eade3bab05695424ce92322e07369534153a828dc47564d26681991137b4641f10676bde4469de8d683c95d96f8a0fd9a589ba88c50e73f4ad0d4f307d245867c479f2aad799078935b25394060b11fdeb56ab273547ece63ee17b3fcafdad7f8f42ba62362d5f991834d55f4e6bf0754c5f387d194062753f47c697d09625c43c0570310dc10a7966c0b8b7d01ab54df21d1e1daaba6a8007cdb198304d00081c0624ff0d0145c288bcd77ea3d95e80a36f5b0ac7e306eef8c665ad63f30dbb7285e4e734a38b48556b099471ce834b5450e96c10981ebffc3ea48602c457bffbf5ac01cc97f086592a394a6dce28f35b76f87f7e3f75b1b258925c415a44ea930a5cb185890edbb29299b4cdb536c1d30d48d495e7c6df1171c5d8aec7f40d15249c95fe2fd3cf801f4f93d4436004d6059c7da7b518c5d132d99f330705f5543607be3cdee54028801c8bc52ff5a8bde2e4b3a41ad8b4291d7ccacf3a3c7c2237b9b9d55887a764363a2bb3317dccb011e91c880e398c6ee8f64078469b2c1419008c83fd048ff578ddfd5e987605fa74b79d0b68a8f3a7e48b45174a5c0c7d3460cfe8165aeb81fd01420f217774e9f39fefbcf6455b715e8b65c48e080188030c4f1722b23f55a094b3e1a8dd48c1b2fcb5932b1e208819da5338346000884657065f273f62866ed0df32ce7405f6752dcdbf555bf0d0487e3e10c716aa75ecf519ddba5a1aafd5f8deefd607a2411c241ef6269c298d28e4ffb2c5558602c76adbb1296a13ccd5e867fbc42079b01202fce367ff1c39962317a7da46c631a32ac289580b2e2c4c3dd4da60786ad56056089dd8cc1e9ac526d09ed796c38723e4acb90478827b60ddd9887b61aa2ff084027ddb5a951cfcd91c0fc0a0c260509a0bbee11d3b7da388b243d8243d39d8a1083b21eb82b81960d5d832e4b7c7da97f396cfb7e3ad542f2a72ad0b4d04316bc72093468e0155290782067d36e451f62ac047b0888bdcfb954e051b633c26c83e0e8818fc72ee2068dc2a287165be7e9808b722b0d55ba7a7a8348cb151502def7e8eb90f4941fd59be2f1918c769cbd2a1d52b231cd685efdf7eccf0572c97a2dcccd23bdf8b91380d2a74e6c05b342e6878ead400face3130b14346019c1a5a4895a8acf2b197aa9b7571635952219264b2118ce9d59c098ad26ed8df9a87bd5a2aa4c35df173cbb25730ad2d80dddda3ada232d9c2df82477a69702e974f3a24e452dfded49e506df67bbe6d48204e7088725ee9309bc922cf1cb4de687ab00184dd0498578a0b4724cf6742350fef8a80d3fa98d8a314d3ac09667b9c08199ea00cd875c6484086c03e52d40f6bb3c734b93bbc5b198780a4c4002047222b06bafc1fcf5ae7db50033bcb12c26fc29a2c00db96d8b8851e214786eed50f92d658d95d546f987207caa716ba353a78a9a8fa59136a2c93bc21b9ee02ba7f228b556ed96ddaa1ed586746c6f3d4c0c866847ea4334843ae01c2f6a222b8d0495bcb8c3de0a0be684b7103bc98b5308dd021ea5042ec8d286a2db180a61dae39473722407b6cb633f881b3608e05134cd6ed79538de3241cce73a6d6347be5d5e6e9095bd2cd0736dab32b14fdae4403036174d4553d7b8ed98e7423ffea9dcccd281d687101aceb7abd68679eb5ab76f35b0be7d4f70ecde7ea0b33c986e09f384b614c2acf0b79af291e9e9766ce507793dfd16300cf1ea28f64dd845ba0df06860356fc4e58cb577ba8d5c8f451a1721f1e10caf6b99f5cbddc80099fb8b581992a9f75954d5a41afde440f9d4db7d3e8887eeef174c4faf856b08dd7c2f8ca20c185516c819725f762cfd410e0c8be6deab68b627384341d22c5bbf62437332d121a9e2b78b0569cc3a38b25261a772c9e46f5a6fc4ecfb4d19d3584f974ee7b88b8b02a165640394f9bc2c96a8c40408f047a7e0706fad61e4d36741dd90692e93e3d3739359ef2c52dd615d8419669df3df22ebda9283285e2a566e1be1142be9b3edc23e953d35bbd702a345bc505264c4445836f8b3ac84c174e3381a3c522b0e83c6994ba731ddb5f95d115ea718b9ea750776c429114c5c7936387f69ef222e3038d04258ca5219530560552a0a174fcf41c4607a20f65b1b8c964304d39b7eee25d8807b9261e73f356644203ef4bb64a179e16226e9526d8ca2f18c67248907485022624f5dcb233bd27eef0539af233a73a088ec7eaa79408074de9696b8b86258d55781a31c2bab011c2151a88e6a5467205029be7fce62f0a00784798b4ba41295517b2c6377cc8528dcf68076b9d1ecacf5ef718fc14db87ed5b5790e485ecc1e4f6855638bb7f03b58e62aaff9062c2d9ea3f08894ec5d895a6c268025f59a069a9ec4a90cf01956e326922f42a1f77ef146524c642b71aa56b49cbd3c2570c3391ca883da345f0048828cca735c58e4426c9477b6975b6c649644bbdf591ffe5b50489ff2489250eaf55d255a38570ca94effebac16d8a4283621349552285684ce8b46862c3cba6ce8de25c6739340a6a5556b3a1c546aa97d8f6c66b49295be6489a257685dc3fdbb1d166e7ad1c8bf45ec9ac8eeed6a9163b3a5b0a21f3228e8708dc5964f52bc342c55bb2f0e148abea75e52aaab2b36f516b46c99cb5924fda0bb759cad0ca94b2eb03ab91b3d1f73b9b9a0e43ca6868048f3692bb42a47d6f2534f05cdf106d00a69d6030fb3e659793dec1656775a79af37f4f4bd0a4fce0bf17dae0ce80c6c005b0804956dec0489b0056f0c9112c82441c0937dd4b0233d257c814b41ae77c18072f3f3e3dbf8f0cc8c750b1751007bb7a302b2e060d24f2ae7861e880575ee018a94f1b0bfa6cbe30139e2e676d2a0bf64af061975cab666abd889323f4a53bd21ba6a2659607f516cafe51fb69bc50437efec608b88a59875bd119fc41c94457205fd3beaf0d7c2d40e61aa30423b06afde45676c588830108452452e18e549d05e9434dbb9711524ad60529d690e52f3d075072c9064fa556728538f01a9a55025ccc6d17822354e4ba9d28bdd30319eda05e92396c08ebcdb3b001400afd71d1068984de8f93e55841659e9bc7065c7858fdfc1e87161ed1fa7d6f09de6d607b14d6723381851dae06a29878a6be69d6b370b0466ef191643a99d2ba4d50f44f2f751ae0e887aa2883f5839489c20afaa17cffd494bb85d4de7ed51fb948b482402acddebbe4d9587b026f91d6bde6ddbca16956291126398315689f49dd6dda44628573e62a5e8dda81a4e44d60dd1157eaec8e12c409eb4f0506402a19cf2269c412300b443fdcee9f49323a17d1eb5d5c6ba27ab78efe74c3f2c09610fc03bb4a5a447116db1212fa059e8dad3fec979430c25e9939e3492150c5102728a12de2e86103d58aab3bd51c49459835ed7d2987ddc97dbe608fe23d9de99f14dfa5803f11cb920ac2fe4252b5693b7c9314ecfe5985ac64de77edf2ee111fefc5e7dfafc68df040c6c0b35b6980142b3295b58048345afe574102573f5f3fc943e37a582ebe884492655251d4438dcc3f9f1f5843f7f2b4eabeb8cbdcb810c486c597e7170f7587f850b9d12e8c27269436f00e19068fae90213262959b23a546acf29b661f72e7db419ced65d7b8432ffa7c46e4a16d3a10597c280f48dce0a060edb1a15311a299ff8d6b790333ec4ba5d36ed47227439f8946c4b09a38516837e17b31b2525d007b38288de70430fdb63b06c409524ca5be1d1addfc5bcd09b90603fe758d480fd9b22ef43eac5915671ae5488e0d37d6bbb657c804bd3bcafd5a347cc861fd992da963eb3122a3aafd6ba009119c60942fae557f4774568c52eca28aca117875c95d032602e2b2af64f18870754b868d5c6981fe72c8a0d6b4350bfdb1b5508e7baf79a1e1b867e985c89e1c37bd2d96a6df9452773f8d322aef3c0c026a00eb5d6cc0511b3e5b694c1312cd9b5ebac49ba956224d6379848761ce4a5237fe589e8a52e4dc1e389d2115cbefba2258a4c39c3ab751bd92f391d014eaba100982e7dd98c4d1bcad4ea52ab8d59a458ad9bb4f7f1a9e05f3010e5158f662c597aaa838a39ae58e4a8fc34fecd08241596d66e5e1a083deb20aa2d47f3f3ff600ea453e97f4eeaed17345587ee463e15781bfccca8aee35b0246b81dffc1a74b85c04c0d87e9c13335d225295f4240f4451bf0fc3b5efdd969415d7c567ea3dd439ef41b90a036b2a8370ada34c110baaae4b82fcba5a18648f67bde172dd842cefa35f6c0383ca5f4dd00228e838b73ea4b26f9048c61f50730f17aaff16aea6560d949ee235c98ec0b41bf07d666ba7e46fde5791de0fa285f21800764244eaa76206952af58a40d9808c521e6f1c06267268968304b576119a7935c9baad71d1c4cb0e3c5f294d069adbf9ff163ee77a8200b8e6a6b3f472d05c07c7db536947afe70ac03437dbb36fdf4fbfbead4ea2604274addbcf8d36af7263cc46c0252bfbbd338780b1a4577eb29a1c28a8bcf6820012feeb8f1a0d0d5c46f79d5b0a81282d2767187abfabe38574e079ce41dfcd8c08e3cbe52c3eb21b77914fffd10cd40d107ed2667b593302e7a01173e8f32f9a01b4d57a4e4b85661aefe0446f27689ad39a0f420a7fbd3ca671535b43a488472d83a4c28363c74f831ce1d8bdb4972fe7289951cdf445671cec3d082c78a5407b4ffb36e6cb6719447d723f41cbd54bed853ba714ed56584bed113b05640d55fd94e3a4d2f063222aedeaff8016b97dae0377c43bc158dbd539932f81b02e758e66b6bdef37c23c23897c47ac8c095a701f882f0c9c14b8223a9daee7473ff5279da9932b4c1181ef3166045aa5eb1b53e6cff25d39d8f76a0f680c1a6296e220ea09ea8812437f5e535b5bba9c9a1ac0a0cdfc29f850387514e9bda90be2621ee825a28b279cda5468bae9361e1cc972236856907ae234d84048f6d5095ba20edaedc0140b7fb985a85831ccb901024a935af1849a671140e47765fe70155ca2563a61a6c12915dda702f63bdcbea4bc838123f4be489870fe4f5b7b2f2d1d5ea6a0b0bdf6420595b56ffead54006c0e272aa32d45d7fe1ad79bf5bcbca158c4a780cb34b9141bf3ae05fa6457da8c5fc1dcb7eea8f73a89d6036b532be45b7d3d651cc4c9ae1ea7d00aa4f19790290f63b779eee0b260d6ce1715c335b90ecfb8565027becb0907d3e4dd0d63013273b4737afb0474a1d84eac8f85018e5e8031e228ce77421f85aad4f1921a24b75609d0025c548542b9ac5341a79f62def48944caef59e63a7f40fe4558adf739c5048aa7491e83b75e86cf3d0d7354f22b377c3a47ad16667b8c3c9796cf40ecbd04e8d55739e8bcd53f934d8bbbea3c05035eccc1103c8f65631384ce34a254aac468664675ea56758b66d1767dec68fa484976bdda05d83eddd7ac9c3955c670998b3807c6ab396a22fd77233d247abc39264930beccd6ebd64a49e9a1cdcf40f1c354804f36b85713862d38849899a1a58c9657742abf00d593af21ef2ee068481035e81272185caf6bf0eb1fa748056c6345ab30f86c4b198deef51592ebf668257dae23adf5a717b6e7b992e6b98858361fdf611cca3cc5fc891959a9e693ae7eecb0b1ede281e6c441331cdd8b711bd06075d9dde0d2a2440e2b146c49f6ffe22e54f522cb8b7a9a8b149ccb6130a8cf2e98a8db8503684e77f3ec283183c8cf2d301cc773957568d11e74944e8b76ed079f2172068d0ad41f30928585374513b788fb902dc4d5875c493e382eac91395d5793a25d0faccd8ccb025589749c744401ec2c695e779efaa32ff95d10a093906890c687825b2bdbe662c4957c98a85a5718d75fc90376d301b619916d770025c84b1bfeccfffb7f6280e55d18c3cb641496f15f700b08d54424c6d8198b181cfbdfbc6273731a36edb35b33545dee6396cb50d264a7a5ad2a535a8ccf50c6b76e75946eafe8848dd4660c266d49d0629988dcac4916dc6223a039b2f2117e2ea29015ddca65c28935dbe57769620701c2bf37b631dc64f9eb98b5973d2aa9c953ebd076745cd5171b13753c82b4f7ff66d9e8ebd7e8cf0b0c194ef8a193fedde5418baf836dec513f630080eff2c4e5629fbbe6ce1f69ab9a76f003dbb390b6e248999c4e470f49c9e63832e05feeff54bc3f153451d16fa79ec3873f1479c60e1e3d025cc03519e8a439d6c82d48d3f8778422e1f2fc7aea3755deff7b6939e604f652e3d21bf86cad04530476d5d7bb39454b38724f066a3b5d07f80cde579183eae68b85e5b4eec0494aaf956174d4a3b9c9c33d06948ccaa57a408256b66b9041c2093ef3c880af26dfe829354c6e6d9dfc1e1f8b53a62cb457875a7f7684be7f73284e5837f0448416c685d41d11011894d695fbf0bdd3198605fb9855468141f36ea5654d00dfa68135dd4d11df8ace3623c17c62dbc1cc871791de661161b70b549d6a94ed1e1cb60d1abf138fe614994c72632e4997188678788065407f6573cfa6da6b0dee2e356144057de63a98afb662306d93304f61cf34dcfe4ff6903cbf964d91c41f2567aa2b09aaccdbaebcc6e93a56bc9d7f317c1ffba76072570de2ce6208378ac23c37d05be4f74e9c8deb009193fe3e19d5cbd3f540d83bfdecbcfec5bbc1c89ca4bfa9cc0aa7efd4e994f10d1a5a743b639b4ba83895acd9fb770a9213ab06678c710f3e5671c780d43574c5cba5a5c2d2094772a86850e13eed8a55ef7a8cf62bd5b31dd57f4d81bee67ba1f0438f201de2a671fb7beeb195e87d7fad51b5aed4e71d77ad014c5107d3f9e3bf8cbc1f5cb71c2a4e0a68981181d1fbbcd5efe00bd5f32df64c71a41b447afd18628f1604e7c807d7a95f43d3980aced6f45b83701f3a0f7656b80e87815b9d86e7659192a11d162d49f168b64d9b53b442c8845745c84fbba003e140602f2fb83025359c7cbfd9a932a40abc29f8386000765216b20e1016be16438032bc272196cfca196d1eeb125a1f7fa6545df5a8c5bbdc3806104bb331f41e71cd73f3541d42dff780ebbac525b453d1a76624be8d502727c0465c4f18cdb7b067c8d7be906da3c7258c837e4e2f1c08dffb5694ba54b162b9f04afe36d3763fe9c120dc56db42153c7bcef393a962a1c198779d0e851b3e8c35eb3972de1b7700e46060fa8ffe1fddc69ec3ac94a9eed2a84a3b3effb2d5a1215a5883250b08398a2ab4c95c87548d3cf8717e09073ed4d89963af296155c22b56c43d8bd785af202b1043f94a1dc148c89112659f2c14fe649b232456368030c61abab65848dfbfae778d0141a52933321e3201a243aa5acffbbe8111514a9f13dd631880489bf7b292f31cd5991a4d8b5421a51a97c240a278b0323b10bbe183819ede770bd23405f922db83df8cfb68b41c70ced80f6ca14277b495342cb2354525dbd61b6ebf1b92b7612ad3831f2f62a1298314b37b9208d69e7376ba5b12d048d2e5d21c1e01671c333644b3d6dbc499c76356fb57049836ba1806c98dd7ca90b4cdaeabcbe87ed90915cdb358016ee6ab3184698c262c26121c5f268c7385e57337173fb503a8655ee0693fa51b6044af3455094c2e31ccba1fc4b863198253d135831baf6eabdff7cb08792136b25af989024cdcb5ceda47636569378ec3349a9224b6a0b61a75f40a37e8ff6434c5f38cba1d73fbaaeb1a5253ea05f121dea3355bf9e5625f03506304cc78542ea203ebaf4761db5afbf20d57592e1fb46419af7469606dbc9ca3fcc5cd7229aa47f35ae39e720fcf510433c0a7d20197a5e682a58674b569c278fcba380b47177ce29913a9641f365a8ceb544886ed559bd54fc1080199aab57c7134ba21dac426938eecee222860a8ae7e0ddf592d93b3a8ba52db989c0b80f4b9c503e1faacdf9afe84e2c4acc5a5b3712d3e99e6ba7fa980429074fbdcf0d1a9c83eda543ef9a29c07b2fe4ba2578f9d59bf5856f41247b2c26b405493f14a17aae8d9cfb173d37d8625dfcf6b237765a04d3b82e1df98ce3e1c36d963aa64c9945c4dfb4b83e90713312bad2475f0b1fdad65de531930cbceadab01d64c7b609877f107b84b7497e9840c55992bf5e15190518ae9435ae60c58e8300de02ca2738f7cd7d0faa4bbd56ef23ab5da3c63eacfe5d0249c6d02b4251d0e1153fdac9a37c680e446a4ede8568541ec8643290af0546504f01cf2307c53d66f56650950178e0ffd316a292671690348a4bfe62362b222515fe7484db736624c81a38ff0fac811d594dcfa6598a427de50c5a6fed1854e6fc9cd5ef9d890d73dbd9c9fcdefe239ea754ca2ef11d5e27e34340a383956c805908796d3efbb2bb013e8806e2134313d20f6501da6f95465a25c90e80472ffd87a8c7f32cca3360515739906d8da0381a3e9602fb33084f67bdb4b001bb0991b5783b808491ef31fd3a735a9f4c2a04a122efe469d6bf5906d6b77669ecfd1ca907f693d4bc9d83dd0992c667b264f6d042a10f43877926765727043d36f8b61933d58ec89f374ad8f73814e7c8b48261a72b4cd3a29776dfe65af651eea1a8491a9b5e0235dfe60846db4926a4ae4bfd7103752eb032810086bd8689668ff55a795e0f4c854224ef47d86109bfa03b33a0806d052afb6413701c2f7d72df9d7d55e3f42a20c8e4cfdb29881b8b08d393e02b84a7d62cae3ae45421a61e1e71d9a059a0afa71b09d01d471e3dd3a2e2e3f6447b74b1193bf3d0b80829b702bcf2f8323667224527524f0d4b32df13ae1b2df554a8f79b687eaad1d125b5c768f7cd97125d337219f07d9b3648a43b9cb79836151c70a7b3f998ab259a92a14884e586b4d192bfdebbcad8794c907b4679d40210efca9cfcf8875f2df416dc3f9fac7dfce191c5b0ae200a48a6ea3969ba2d765917df648e416c19256c1142638757c4bbc62b4f6c77478416a107333c6fae29cd67cf643116ab99d7af97c3956658b9540d3892f4d676ca1519762242db4ced81591b4e434eea35b4f87f075c474438cbae348f7fe07bfdb71cbfe6977a5eef08a7576e570a9eb8a878b97aab81a7a2b5d2dc9bb7eeb21c85a910cc667d6d97e4940eb49d324166caa16c0bdf725b4bf4e8d66b788ba3c3f165f473ff76adf66f78baf951e843e71d3f55e913b9b467ea0f76df185155e3ffd99ac0a856852d4732caa23cc2f441ba0f8e7a773a649e0d40f95e841ef93479036d44c781a87554992688cbb86e895d4f0c2d20d7ff1da5b58083a91d034bc54558c933f8d1ca95a8a69fc5c372231f57c0eec07c739e26ba29aaf33210138118dfc4b163aa7a93ee55d380a22e548ae03d52c9901768791c17ccc37fb3e7964fb1355ec5a632f83157ed191bc6542f25178187930569f4443896e5d166ae270d3bb3cd5e8ff7c9e9f84b4dcb5c443d1cbaf173817247ac1f055d0d74cbf429d8b2572eb8635728838c4099d2821bf5e8fdb97e42d079c1acbbd631cb6cdbc87c3c63bb202b8743f2338eb8ac89e41a5c4e4c7ba0551af7df940830312ea04967f723faad2525e67ff61f033c380cbe443d9ee4a3762772829c7fc035466e5a045edbe29d9d5cdd0ac525855d55f5f763e9d44dfb5019d940f2ebbd64063ca14b6e35c8a3fa354412adce8ef3acb1955c7ee4d2e3703f0717fe1bd42dd0cf752d4de1044e612c131bffdc2b1449575</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>八股文</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>java锁常见面试题</title>
    <link href="/java%E9%94%81%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/java%E9%94%81%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-sychronized"><a href="#1-sychronized" class="headerlink" title="1. sychronized"></a>1. sychronized</h1><p>Synchronized是Java中解决并发问题的一种最常用的方法，Synchronized的作用主要有三个：</p><ul><li><strong>确保互斥访问</strong>。确保被同步的方法或代码块在同一时刻只能由一个线程执行，其他线程必须等待该线程执行完毕后才能进入。</li><li><strong>保证可见性</strong>。保证线程间对共享变量的修改是可见的。具体来说，当一个线程修改了共享变量的值后，<code>synchronized</code> 关键字确保其他线程能够立即看到这个修改。</li><li><strong>防止指令重排序</strong>。指令重排序是一种优化技术，编译器和处理器可能会重新排列指令的执行顺序，以提高性能。但是在多线程环境下，指令重排序可能会导致线程间的执行顺序和预期的不一致。<code>synchronized</code> 通过内存屏障（Memory Barrier）机制，确保在进入和退出同步块时，内存的读写操作不会被重排序。</li></ul><h2 id="1-应用方式"><a href="#1-应用方式" class="headerlink" title="1. 应用方式"></a>1. 应用方式</h2><p>synchronized关键字最主要有以下3种应用方式，下面分别介绍</p><p>1.修饰实例方法，作用于当前实例加锁，进入同步代码前要获得当前实例的锁</p><p>2.修饰静态方法，作用于当前类对象加锁，进入同步代码前要获得当前类对象的锁</p><p>3.修饰代码块，指定加锁对象，对给定对象加锁，进入同步代码库前要获得给定对象的锁。</p><h2 id="2-实现原理"><a href="#2-实现原理" class="headerlink" title="2. 实现原理"></a>2. 实现原理</h2><p>基于对象锁（monitor）机制。编译用sychronized修饰的同步代码块，再用javap -v查看字节码文件：执行同步代码块后首先要先执行monitorenter指令，退出的时候monitorexit指令。使用Synchronized进行同步，其关键就是必须要对对象的监视器monitor进行获取，当线程获取monitor后才能继续往下执行，否则就只能等待。而这个获取的过程是互斥的，即同一时刻只有一个线程能够获取到monitor。每个对象拥有一个计数器，当线程获取该对象锁后，计数器就会加一，释放锁后就会将计数器减一。</p><h2 id="3-Java虚拟机对synchronized的优化"><a href="#3-Java虚拟机对synchronized的优化" class="headerlink" title="3. Java虚拟机对synchronized的优化"></a>3. Java虚拟机对synchronized的优化</h2><p>Java虚拟机（JVM）对<code>synchronized</code>关键字进行了多种优化，旨在提高并发性能和减少线程阻塞的开销。</p><ol><li>偏向锁（Biased Locking）：当一个线程获取对象的锁时，JVM会将对象标记为偏向锁。这样，在后续的访问中，该线程可以无需竞争锁而直接获取资源，避免了不必要的锁竞争，提高了单线程场景下的性能。</li><li>轻量级锁（Lightweight Locking）：当多个线程竞争同一个对象的锁时，JVM会将锁从偏向锁升级为轻量级锁。在轻量级锁状态下，JVM会使用CAS（Compare and Swap）操作来实现对锁的获取和释放，避免了线程阻塞和上下文切换的开销。</li><li>自旋锁（Spin Locking）：当线程尝试获取轻量级锁时，如果发现锁被其他线程占用，它不会立即阻塞，而是进行一定次数的自旋尝试获取锁。自旋锁可以减少线程阻塞和恢复的开销，适用于锁占用时间短暂的情况。</li><li>锁消除（Lock Elimination）：JVM会通过逃逸分析技术分析代码，判断某些对象的锁并不会被其他线程访问，从而可以安全地消除对这些锁的使用。这样可以避免不必要的锁竞争，提高并发性能。</li><li>锁粗化（Lock Coarsening）：JVM会将多个连续的锁操作合并为一个较大的锁操作，减少锁的获取和释放次数。这样可以减少锁竞争和上下文切换的开销，提高并发性能。</li></ol><h2 id="4-synchronized-锁升级的顺序"><a href="#4-synchronized-锁升级的顺序" class="headerlink" title="4. synchronized 锁升级的顺序"></a>4. synchronized 锁升级的顺序</h2><p>在 Java 虚拟机 (JVM) 中，锁的升级是指在多线程环境下，当线程访问共享资源时，锁的状态从无锁到偏向锁，再到轻量级锁，最后可能升级为重量级锁的过程。</p><ol><li>无锁状态（Unlocked）：当没有线程访问共享资源时，该状态为无锁状态。</li><li>偏向锁状态（Biased Locking）：当只有一个线程访问共享资源时，JVM 会偏向于该线程，将对象的标记设置为偏向锁状态。这样，在后续的访问中，该线程可以无需竞争锁而直接获取资源，提高了性能。</li><li>轻量级锁状态（Lightweight Locking）：当多个线程竞争同一个偏向锁时，偏向锁会升级为轻量级锁。在轻量级锁状态下，JVM 会尝试使用 CAS（Compare and Swap）操作来实现对锁的获取和释放，避免了线程阻塞。如果 CAS 操作成功，线程可以继续执行临界区代码。如果 CAS 操作失败，说明有其他线程竞争锁，那么锁会升级为重量级锁。</li><li>重量级锁状态（Heavyweight Locking）：当轻量级锁无法满足线程竞争的需求时，JVM 会将锁升级为重量级锁。在重量级锁状态下，线程在获取锁时会进入阻塞状态，可能会导致线程切换和上下文切换的开销增加。</li></ol><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20240703102856049.png" alt="image-20240703102856049" style="zoom:50%;" /><h2 id="4-Lock和synchronized区别"><a href="#4-Lock和synchronized区别" class="headerlink" title="4. Lock和synchronized区别"></a>4. Lock和synchronized区别</h2><ol><li><p>Lock是一个接口，而synchronized是Java中的关键字,synchronized是内置的语言实现， lock是通过代码实现的.</p></li><li><p>synchronized在发生异常时，会自动释放线程占有的锁，因此不会导致死锁现象发生；而Lock在发生异常时，如果没有主动通过unLock()去释放锁，则很可能造成死锁现象，因此使用Lock时需要在finally块中释放锁；</p></li><li><p>通过Lock可以知道有没有成功获取锁，而synchronized却无法办到。</p></li><li><p>Lock可以提高多个线程进行读操作的效率。</p></li><li><p>Lock可以让等待锁的线程响应中断，线程可以中断去干别的事务，而synchronized却不行，使用synchronized时，等待的线程会一直等待下去，不能够响应中断；</p><p><strong>在性能上来说，如果竞争资源不激烈，两者的性能是差不多的，而当竞争资源非常激烈时（即有大量线程同时竞争），此时Lock的性能要远远优于synchronized。所以说，在具体使用时要根据适当情况选择。</strong></p></li></ol><h1 id="2-AQS"><a href="#2-AQS" class="headerlink" title="2. AQS"></a>2. AQS</h1><h2 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h2><p>AQS，全称为 <strong>AbstractQueuedSynchronizer</strong>，是 Java 中提供的一种实现同步器的框架。它是 <code>java.util.concurrent.locks</code> 包的一部分。其核心是维护一个同步状态 <code>state</code> 以及一个 FIFO 等待队列。它提供了多种方法来操纵同步状态，并管理进入等待队列的线程。</p><h4 id="同步状态"><a href="#同步状态" class="headerlink" title="同步状态"></a>同步状态</h4><p>同步状态是一个 <code>int</code> 类型的变量，通常用于表示资源的可用性。例如，在一个独占锁中，<code>state</code> 为 0 表示锁是可用的，1 表示锁已被持有。</p><h4 id="等待队列"><a href="#等待队列" class="headerlink" title="等待队列"></a>等待队列</h4><p>当一个线程尝试获取锁但失败时，它会被加入到 AQS 的等待队列中。这个等待队列是一个双向链表，所有尝试获取锁的线程都排成队列，等待被唤醒并再次尝试获取锁。</p><h2 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h2><p>AQS 通常不会直接使用，而是通过子类实现具体的同步器，如 <code>ReentrantLock</code>、<code>CountDownLatch</code>、<code>Semaphore</code> 等。</p><h1 id="3-ReentrantLock"><a href="#3-ReentrantLock" class="headerlink" title="3.  ReentrantLock"></a>3.  ReentrantLock</h1><h2 id="1-公平锁的加锁实现："><a href="#1-公平锁的加锁实现：" class="headerlink" title="1. 公平锁的加锁实现："></a>1. 公平锁的加锁实现：</h2><p>公平锁保证线程按照请求锁的顺序来获取锁.</p><p>1.加锁时会调用lock()方法去获取锁，lock()会调用用acquire()(AQS中)，而这个acquire方法内部又去调用了tryAcquire的方法</p><ol><li><p>tryAcquire方法通过getState获取当前同步状态</p><ul><li><p>发现state为0。</p><ol><li><strong>判断是否有比当前线程等待时间更长的线程</strong>。如果有，当前线程将等待。</li><li>没有的话，使用原子操作尝试将锁的状态从 0 改为 1，表示获取锁成功，设置锁的拥有者为当前线程， 获取成功，</li></ol></li><li><p>不为0，检查当前线程是否已经持有锁，判断重入锁的逻辑。</p><ol><li>是重入锁的话，增加重入次数， 也是获取成功，</li></ol></li></ul></li><li><p>获取失败时，调用 <code>addWaiter</code> 将当前线程加入等待队列。尝试通过CAS把当前现在追加到队尾，修改为节点为最新的节点，如果修改失败，意味着有并发，这个时候进入enq中的死循环，进行“自旋”的方式修改</p></li></ol><h2 id="2-公平锁的释放锁实现："><a href="#2-公平锁的释放锁实现：" class="headerlink" title="2. 公平锁的释放锁实现："></a>2. 公平锁的释放锁实现：</h2><ol><li><p>头节点在释放同步状态的时候，会调用unlock（），而unlock会调用release()，release()会调用tryRelease方法尝试释放当前线程持有的锁,先判断当前线程是否为持有锁的线程，如果是，则执行减减操作，否则抛出异常（同步状态）</p></li><li><p>成功的话调用unparkSuccessor() 唤醒后继线程，并返回true，否则直接返回false，</p><p>注意：</p><ul><li>只有线程A把此锁全部释放了，状态值减到0了，其他线程才有机会获取锁，当A把锁完全释放后，state恢复为0</li><li>队列中的节点在被唤醒之前都处于阻塞状态。当一个线程节点被唤醒然后取得了锁，对应节点会从队列中删除</li></ul></li></ol><h2 id="3-非公平锁的加锁实现："><a href="#3-非公平锁的加锁实现：" class="headerlink" title="3. 非公平锁的加锁实现："></a>3. 非公平锁的加锁实现：</h2><ul><li>非公平锁在尝试获取锁时，是先直接 CAS 设置 state 变量，如果设置成功，表明加锁成功，当前线程就成为了锁的持有者。</li><li>抢占失败,再调用 acquire 方法将线程置于队列尾部排队。</li></ul><blockquote><p>非公平锁的机制：如果新来了一个线程，试图访问一个同步资源，只需要确认当前没有其他线程持有这个同步状态，即可获取到。</p></blockquote><p>这个区别很重要，因为线程在阻塞和非阻塞之间切换时需要比较长的时间，如果刚好线程A释放了资源，A会去唤醒下一个排着队的Node节点，当这个唤醒操作还没完成的时候，这时又来了一个线程B，线程B发现当前没人持有这个资源，于是自己就迅速拿到了这个资源，充分利用了线程A去唤醒B的这一段时间，这就是公平锁和非公平锁之间的差异，这里也体现了非公平锁性能较高的地方。</p><h1 id="4-ReentrantReadWriteLock"><a href="#4-ReentrantReadWriteLock" class="headerlink" title="4. ReentrantReadWriteLock"></a>4. ReentrantReadWriteLock</h1><p>ReentrantReadWriteLock是 Lock 的另一种实现方式，我们已经知道了 ReentrantLock 是一个排他锁，同一时间只允许一个线程访问，而 ReentrantReadWriteLock 允许多个读线程同时访问，但不允许写线程和读线程、写线程和写线程同时访问。相对于排他锁，提高了并发性。</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="5-CountDownLatch-amp-CyclicBarrier"><a href="#5-CountDownLatch-amp-CyclicBarrier" class="headerlink" title="5. CountDownLatch &amp; CyclicBarrier"></a>5. CountDownLatch &amp; CyclicBarrier</h1><h2 id="1-CountDownLatch"><a href="#1-CountDownLatch" class="headerlink" title="1. CountDownLatch"></a>1. CountDownLatch</h2><p>CountDownLatch是一个计数器闭锁，通过它可以完成类似于阻塞当前线程的功能，即：一个线程或多个线程一直等待，直到其他线程执行的操作完成。</p><p>CountDownLatch用一个给定的计数器来初始化，该计数器的操作是原子操作，即同时只能有一个线程去操作该计数器。调用该类await方法的线程会一直处于阻塞状态，直到其他线程调用countDown方法使当前计数器的值变为零，每次调用countDown计数器的值减1。当计数器值减至零时，所有因调用await()方法而处于等待状态的线程就会继续往下执行。这种现象只会出现一次，因为计数器不能被重置，如果业务上需要一个可以重置计数次数的版本，可以考虑使用CycliBarrier。</p><h2 id="2-CyclicBarrier"><a href="#2-CyclicBarrier" class="headerlink" title="2 CyclicBarrier"></a>2 CyclicBarrier</h2><p>CyclicBarrier也是一个同步辅助类，它允许一组线程相互等待，直到到达某个公共屏障点（common barrier point）。</p><p>通过它可以完成多个线程之间相互等待，只有当每个线程都准备就绪后，才能各自继续往下执行后面的操作。类似于CountDownLatch，它也是通过计数器来实现的。当某个线程调用await方法时，该线程进入等待状态，且计数器加1，当计数器的值达到设置的初始值时，所有因调用await进入等待状态的线程被唤醒，继续执行后续操作。因为CycliBarrier在释放等待线程后可以重用，所以称为循环barrier。CycliBarrier支持一个可选的Runnable，在计数器的值到达设定值后（但在释放所有线程之前），该Runnable运行一次，注，Runnable在每个屏障点只运行一个。</p><h2 id="3-区别"><a href="#3-区别" class="headerlink" title="3. 区别"></a>3. 区别</h2><p>CountDownLatch主要是实现了1个或N个线程需要等待其他线程完成某项操作之后才能继续往下执行操作，描述的是1个线程或N个线程等待其他线程的关系。CyclicBarrier主要是实现了多个线程之间相互等待，直到所有的线程都满足了条件之后各自才能继续执行后续的操作，描述的多个线程内部相互等待的关系。<br>CountDownLatch是一次性的，而CyclicBarrier则可以被重置而重复使用。</p><h1 id="6-CAS"><a href="#6-CAS" class="headerlink" title="6 CAS"></a>6 CAS</h1><p>CAS（Compare and Swap）有3个操作数，内存值V，旧的预期值A，要修改的新值B。当且仅当预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做。</p><p>java.util.concurrent(J.U.C)种提供的atomic包中的类，使用的是乐观锁，用到的机制就是CAS，当多个线程尝试使用CAS同时更新一个变量时，只有其中一个线程可能更新变量的值，而其他线程都失败，失败的线程不会被挂起，而是被告知这次竞争失败，并可以再次尝试。</p><h2 id="1-AtomicInteger"><a href="#1-AtomicInteger" class="headerlink" title="1. AtomicInteger"></a>1. AtomicInteger</h2><p>以AtomicInteger为例，研究在没有锁的情况下是如何做到数据正确性的。<br>例如 AtomicInteger 中有一个原子方式 i++ 操作，即</p><ol><li>调用incrementAndGet(),而incrementAndGet() 调用 unsafe下的方法getAndAddInt()</li><li>getAndAddInt()中有一个 valueOffset 参数，这个值是 value 值在 AtomicInteger 类型中内存的偏移地址。传入的 valueOffset 参数会在后续方法中，直接从内存位置读取这个字段的值。</li><li>得到最新值后，调用 compareAndSwapInt 来更新最新值，如果对象 o 中 offset 偏移位置的值等于期望值(expected)，就将该 offset 处的值更新为 x，当更新成功时，返回 true。结合前面调用来看，如果当前值是 v，就设置为 v+1。否则重试直到成功为止。</li></ol><h2 id="2-CAS问题"><a href="#2-CAS问题" class="headerlink" title="2. CAS问题"></a>2. CAS问题</h2><ol><li><p><strong>ABA问题</strong>。<br>因为CAS需要在操作值的时候检查下值有没有发生变化，如果没有发生变化则更新，但是如果一个值原来是A，变成了B，又变成了A，那么使用CAS进行检查时会发现它的值没有发生变化，但是实际上却变化了。<br>ABA问题的解决思路就是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加一，那么A－B－A 就会变成1A-2B－3A。<br>从Java1.5开始JDK的atomic包里提供了一个类AtomicStampedReference来解决ABA问题。这个类的compareAndSet方法作用是首先检查当前引用是否等于预期引用，并且当前标志是否等于预期标志，如果全部相等，则以原子方式将该引用和该标志的值设置为给定的更新值。</p></li><li><p><strong>循环时间长开销大。</strong><br>自旋CAS如果长时间不成功，会给CPU带来非常大的执行开销。如果JVM能支持处理器提供的pause指令那么效率会有一定的提升，pause指令有两个作用，第一它可以延迟流水线执行指令（de-pipeline）,使CPU不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零。第二它可以避免在退出循环的时候因内存顺序冲突（memory order violation）而引起CPU流水线被清空（CPU pipeline flush），从而提高CPU的执行效率。</p></li><li><p><strong>只能保证一个共享变量的原子操作。</strong><br>当对一个共享变量执行操作时，我们可以使用循环CAS的方式来保证原子操作，但是对多个共享变量操作时，循环CAS就无法保证操作的原子性，这个时候就可以用锁，或者有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如有两个共享变量i＝2,j&#x3D;a，合并一下ij&#x3D;2a，然后用CAS来操作ij。从Java1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行CAS操作。</p></li></ol><h1 id="7-ThreadLocal"><a href="#7-ThreadLocal" class="headerlink" title="7 ThreadLocal"></a>7 ThreadLocal</h1><p>ThreadLocal 提供线程内部的局部变量，在本线程内随时随地可取，隔离其他线程</p><p><strong>早期设计：</strong></p><p>每个 ThreadLocal类都创建一个 Map，然后用线程的 ID threadID 作为 Map 的 key，要存储的局部变量作为 Map 的 value，这样就能达到各个线程的值隔离的效果。</p><p> <strong>JDK8 ThreadLocal 的设计：</strong></p><p>每个 Thread 维护一个 ThreadLocalMap 哈希表，这个哈希表的 key 是 ThreadLocal 实例本身，value才是真正要存储的值 Object。</p><p><strong>这样设计有如下几点优势：</strong><br>1） 这样设计之后每个 Map 存储的 Entry 数量就会变小，因为之前的存储数量由Thread 的数量决定，现在是由 ThreadLocal 的数量决定。<br>2） 当 Thread 销毁之后，对应的 ThreadLocalMap 也会随之销毁，生命周期与线程相同，能减少内存的使用。<br>注：ThreadLocalMap其实是线程自身的一个成员属性threadLocals的类型。也就是线程本地数据都存在这个threadLocals应用的ThreadLocalMap中。</p><h2 id="1-底层实现"><a href="#1-底层实现" class="headerlink" title="1. 底层实现"></a>1. 底层实现</h2><h2 id="1-set-Tvalue"><a href="#1-set-Tvalue" class="headerlink" title="1. set(Tvalue)"></a>1. set(Tvalue)</h2><p>1 ) 获取当前线程 Thread 对象，进而获取此线程对象中维护的 ThreadLocalMap 对象。<br>2 ) 判断当前的 ThreadLocalMap 是否存在：<br>如果存在，则调用 map.set 设置此实体 entry。<br>如果不存在，则调用 createMap 进行 ThreadLocalMap 对象的初始化，并将此实体 entry 作为第一个值存放至 ThreadLocalMap 中。</p><h2 id="2-get"><a href="#2-get" class="headerlink" title="2. get()"></a>2. get()</h2><ol><li><p>获取当前线程 Thread 对象，进而获取此线程对象中维护的 ThreadLocalMap 对象。</p></li><li><p>判断当前的 ThreadLocalMap 是否存在：</p><ul><li><p>如果存在，则以当前的 ThreadLocal 为 key，调用 ThreadLocalMap 中的 getEntry 方法获取对应的存储实体 e。找到对应的存储实体 e，获取存储实体 e 对应的 value 值，即为我们想要的当前线程对应此 ThreadLocal 的值，返回结果值。</p></li><li><p>如果不存在，则证明此线程没有维护的 ThreadLocalMap 对象，调用 setInitialValue 方法进行初始化。返回 setInitialValue 初始化的值。</p></li></ul></li><li><p>setInitialValue 方法的操作如下：</p><ol><li>调用 initialValue 获取初始化的值。</li><li>获取当前线程 Thread 对象，进而获取此线程对象中维护的 ThreadLocalMap 对象，并判断当前的 ThreadLocalMap 是否存在：<ul><li>如果存在，则调用 map.set 设置此实体 entry。</li><li>如果不存在，则调用 createMap 进行 ThreadLocalMap 对象的初始化，并将此实体 entry 作为第一个值存放至 ThreadLocalMap 中。</li></ul></li></ol></li></ol><h1 id="8-volatile"><a href="#8-volatile" class="headerlink" title="8. volatile"></a>8. volatile</h1><h2 id="1-volatile-关键字的作用"><a href="#1-volatile-关键字的作用" class="headerlink" title="1. volatile 关键字的作用"></a>1. volatile 关键字的作用</h2><p>volatile 关键字的主要作用是保证可见性和有序性,禁止编译器优化。</p><ul><li>保证可见性:当一个变量被声明为 volatile 之后,每次读取这个变量的值都会从主内存中读取,而不是从缓存中读取,这就保证了不同线程对这个变量操作的可见性。</li><li>有序性:volatile 关键字保证了不同线程对一个 volatile 变量的读写操作的有序性。</li><li>禁止编译器优化:编译器会对代码进行各种优化来提高性能,但是这些优化也可能让同步代码失效。volatile 关键字告诉编译器不要对这段代码做优化,从而避免一些不正确的优化。</li></ul><h2 id="2-volatile-实现原理"><a href="#2-volatile-实现原理" class="headerlink" title="2. volatile 实现原理"></a>2. volatile 实现原理</h2><p>volatile 关键字底层原理依赖于内存屏障和缓存一致性协议。</p><ul><li>内存屏障:内存屏障会强制让读和写操作都访问主内存,从而实现可见性。volatile 写操作后会加入写屏障,volatile 读操作前会加入读屏障。</li><li>缓存一致性协议:每个处理器都有自己的高速缓存,当某个处理器修改了共享变量,需要缓存一致性协议来保证其他处理器也看到修改后的值。缓存一致性协议会在读操作后和写操作前加入缓存刷新操作,保证其他处理器的缓存是最新值。</li></ul><h1 id="9-悲观锁与乐观锁"><a href="#9-悲观锁与乐观锁" class="headerlink" title="9 悲观锁与乐观锁"></a>9 悲观锁与乐观锁</h1><h2 id="1-悲观锁"><a href="#1-悲观锁" class="headerlink" title="1. 悲观锁"></a>1. 悲观锁</h2><p>这是一种对数据的修改持有悲观态度的并发控制方式。总是假设最坏的情况，每次读取数据的时候都默认其他线程会更改数据，因此需要进行加锁操作，当其他线程想要访问数据时，都需要阻塞挂起。悲观锁的实现：</p><ol><li>传统的关系型数据库使用这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</li><li>Java 里面的同步 synchronized 关键字的实现。</li></ol><p>悲观锁主要分为共享锁和排他锁：</p><ul><li>共享锁【shared locks】又称为读锁，简称S锁。顾名思义，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。</li><li>排他锁【exclusive locks】又称为写锁，简称X锁。顾名思义，排他锁就是不能与其他锁并存，如果一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据行读取和修改。</li></ul><h2 id="2-乐观锁"><a href="#2-乐观锁" class="headerlink" title="2. 乐观锁"></a>2. 乐观锁</h2><p>乐观锁是相对悲观锁而言的，乐观锁假设数据一般情况下不会造成冲突，所以<strong>在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则返回给用户错误的信息，让用户决定如何去做。乐观锁适用于读操作多的场景，这样可以提高程序的吞吐量。</strong></p><p>乐观锁的实现：CAS</p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>技术选型</title>
    <link href="/%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/"/>
    <url>/%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1-技术选型所要考虑的"><a href="#1-技术选型所要考虑的" class="headerlink" title="1. 技术选型所要考虑的"></a>1. 技术选型所要考虑的</h1><ul><li>切合业务：在当前的场景以及后续的一些模块的设计，都可以满足我们的业务</li><li>社区活跃度：活跃多，使用的人多，优点缺点都可以呈现出来，包括会遇到的问题</li><li>团队技术水平：针对开发周期的长短，需要考虑我们是采用老技术还是新技术。如果是新技术，团队没有几个人接触过的话，那么就需要整体的一个培训，来提高团队的技术水平。</li><li>版本更新迭代周期：如果版本更新迭代的比较快，可以优先考虑，因为如果你遇到了什么问题，但是版本停更了，就会对公司的业务多多少少造成一定的影响</li><li>试错精神：平时多接触各类技术，就可以有多种备选方案</li><li>安全性：某些技术曾经有安全问题，安全漏洞的话，要多斟酌再使用</li><li>成功案例：可以多使用一些有成功案例的</li><li>开源精神：如果这个技术会闭源的，需要考虑后期会收费的场景</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>幂等性</title>
    <link href="/%E5%B9%82%E7%AD%89%E6%80%A7/"/>
    <url>/%E5%B9%82%E7%AD%89%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="1-幂等性是什么？"><a href="#1-幂等性是什么？" class="headerlink" title="1. 幂等性是什么？"></a>1. 幂等性是什么？</h1><p>在一个系统中，一个接口，运行多次和运行一次的结果是一致的。</p><p>什么情况下需要幂等性？</p><p>重复提交、接口重试、前端窗口抖动等</p><p>业务场景：</p><ol><li>用户多次点击提交订单，后台应该只生成一个订单。</li><li>支付时，由于发生网络问题重试，应该只扣一次钱。</li></ol><p>保证幂等性的核心思想：通过唯一的业务单号保证幂等。</p><p>实现：</p><ul><li>非并发的情况下，查询业务单号有没有操作过，没有则执行操作</li><li>并发的情况下，整个过程加锁</li></ul><h1 id="2-具体CRUD操作的幂等性"><a href="#2-具体CRUD操作的幂等性" class="headerlink" title="2 具体CRUD操作的幂等性"></a>2 具体CRUD操作的幂等性</h1><h2 id="1-select操作的幂等性"><a href="#1-select操作的幂等性" class="headerlink" title="1. select操作的幂等性"></a>1. select操作的幂等性</h2><p>查询操作天然幂等。</p><h2 id="2-delete操作的幂等性"><a href="#2-delete操作的幂等性" class="headerlink" title="2 delete操作的幂等性"></a>2 delete操作的幂等性</h2><ul><li>有唯一的业务号，如id。<ul><li>第一次操作：根据唯一业务号删除</li><li>第二次操作：由于找不到记录，所以直接返回。可在删除前进行数据的查询。</li></ul></li><li>没有唯一的业务号，比如将审核未通过的商品删除。<ul><li>第一次操作：将所有审核未通过的商品删除</li><li>第二次操作前：又产生了新的审核未通过的商品。这时候需要根据业务需求去处理，新增的审核未通过的商品是否需要删除。</li></ul></li></ul><h2 id="3-update操作的幂等性"><a href="#3-update操作的幂等性" class="headerlink" title="3 update操作的幂等性"></a>3 update操作的幂等性</h2><p>update操作需要区分场景：</p><ul><li><p>比如是set去更新，那么多次set不会有什么问题</p></li><li><p>如果是在当前基础上自增，那么就需要处理 ，分场景：</p><ul><li><p>有唯一的业务号，如id。更新操作传入数据版本号，通过乐观锁实现。</p><ul><li><p>数据库增加版本version字段，用户在查询并展示当前数据时，将version放入隐藏域。当用户点击提交时，将版本号也一同提交。</p></li><li><p>后台去判断版本号，并且进行版本号+1操作</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">update <span class="hljs-keyword">user</span> <span class="hljs-keyword">set</span> xxx<span class="hljs-operator">=</span>$&#123;xxx&#125;, version<span class="hljs-operator">=</span>$&#123;version&#125;<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span>xxx <span class="hljs-keyword">and</span> version<span class="hljs-operator">=</span>$&#123;version&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>没有唯一的业务号，比如用户登录，注册</p><ul><li>采用token机制</li></ul></li></ul></li></ul><h2 id="4-insert操作的幂等性"><a href="#4-insert操作的幂等性" class="headerlink" title="4 insert操作的幂等性"></a>4 insert操作的幂等性</h2><ul><li><p>有唯一的业务号，如秒杀场景，商品ID+用户ID。</p><ul><li>解决方式：分布式锁业务执行完成后，不让锁释放，而是让其过期后释放。比如设置30s，则30s内只会有一个线程获取到锁，当用户点击多次，触发了其他线程，获取不到锁，直接返回。</li></ul></li><li><p>没有唯一业务单号，使用token保证幂等。</p><ul><li><p>具体流程</p><ul><li><p>当用户进入注册页面时，后端生成一个随机token，客户端将token放在隐藏域下，带着token提交。（分布式场景下，需要类似分布式ID的处理方式，保证token唯一）</p></li><li><p>根据token去获取分布式锁，完成insert后，不让锁释放，而是让其过期后释放</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertUser</span><span class="hljs-params">(SysUser user, String token)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>  InterProcessMutex lock =  <span class="hljs-keyword">new</span> InterProcessMutex(zkClient, <span class="hljs-string">&quot;/&quot;</span>+token);<br>  val isLock = lock.acquire(<span class="hljs-number">30</span>, TimeUnit.SECONDS);<br>  <span class="hljs-keyword">if</span>(isLock)&#123;<br>    <span class="hljs-keyword">return</span> sysUserMapper.insert(user);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h2 id="5-混合操作的幂等性"><a href="#5-混合操作的幂等性" class="headerlink" title="5 混合操作的幂等性"></a>5 混合操作的幂等性</h2><p>找到操作的唯一业务单号，有则使用分布式锁，无则通过token保证</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>postgresql 常用SQL整理</title>
    <link href="/postgresql-%E6%9F%A5%E8%AF%A2%E5%88%A0%E9%99%A4%E9%87%8D%E5%A4%8D%E8%A1%8C/"/>
    <url>/postgresql-%E6%9F%A5%E8%AF%A2%E5%88%A0%E9%99%A4%E9%87%8D%E5%A4%8D%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<ol><li>删除id最小的重复行</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> mes.stool_po <span class="hljs-keyword">where</span> id <span class="hljs-keyword">in</span>(<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(id) <span class="hljs-keyword">FROM</span> mes.stool_po <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> purchasing_doc_number, purchasing_doc_item_number <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(id) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span><br>)<br></code></pre></td></tr></table></figure><ol start="2"><li>查询根据purchasing_doc_number, purchasing_doc_item_number分组后，重复的数据id</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">array_agg</span>(id) <span class="hljs-keyword">FROM</span> mes.stool_po <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> purchasing_doc_number, purchasing_doc_item_number <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(id) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>docker</title>
    <link href="/docker/"/>
    <url>/docker/</url>
    
    <content type="html"><![CDATA[<h1 id="1-docker解决了什么问题？"><a href="#1-docker解决了什么问题？" class="headerlink" title="1 docker解决了什么问题？"></a>1 docker解决了什么问题？</h1><p>比如我们现在开发了一个应用程序比如淘宝App，程序员从头到尾搭建了一套环境开始写代码，比如安装JDK等，代码写完后需要交给测试同事去运行，这事测试同学也需要从头到尾搭建一套环境，但比如JDK版本和你安装的不同，导致无法在测试同学的机器上运行起来，找开发去看问题，此时开发也很无辜，“明明在我的机器上是可以跑起来的”。</p><p>在没有容器技术之前，我们可以采用搭建虚拟机，然后测试人员克隆一个同样的虚拟机。</p><p>但是虚拟机里面是有一套完整的操作系统的。单单运行起来都需要耗费很多资源。比如我们新装的系统，还没有装任何的软件，磁盘已经被占用了好几个G，导致我们无法部署更多的应用程序，此外，操作系统的启动也很缓慢。</p><p>因此出现了容器技术。容器和集装箱在概念上是很相似的。需要实现隔离，也就是多个应用程序在运行时互相不干扰。</p><p>容器技术只隔离应用程序运行时环境，但是共享同一个操作系统。这里的运行时环境指的是程序运行依赖的各种库以及配置。</p><p>因此，相比较虚拟机，容器更加的轻量且占用的资源更少。我们可以部署更多的应用程序，同时启动的速度也很快。</p><p>docker就是容器技术的一种实现。</p><h1 id="2-docker是什么"><a href="#2-docker是什么" class="headerlink" title="2 docker是什么"></a>2 docker是什么</h1><p>docker是一个用Go语言实现的开源项目，可以让我们方便的创建和使用容器，docker将程序以及程序所有的依赖都打包到docker container，这样你的程序可以在任何环境都会有一致的表现。</p><p>这里程序运行的依赖也就是容器就好比集装箱，容器所处的操作系统环境就好比货船或港口，<strong>程序的表现只和集装箱有关系(容器)，和集装箱放在哪个货船或者哪个港口(操作系统)没有关系</strong>。</p><p><strong>docker的底层实现</strong></p><p>docker基于<strong>Linux内核</strong>提供这样几项功能实现的：</p><ul><li><strong>NameSpace</strong>： 我们知道Linux中的PID、IPC、网络等资源是全局的，而NameSpace机制是一种资源隔离方案，在该机制下这些资源就不再是全局的了，而是属于某个特定的NameSpace，各个NameSpace下的资源互不干扰，这就使得每个NameSpace看上去就像一个独立的操作系统一样，但是只有NameSpace是不够。</li><li><strong>Control groups</strong>：虽然有了NameSpace技术可以实现资源隔离，但进程还是可以不受控的访问系统资源，比如CPU、内存、磁盘、网络等，为了控制容器中进程对资源的访问，Docker采用control groups技术(也就是cgroup)，有了cgroup就可以控制容器中进程对系统资源的消耗了，比如你可以限制某个容器使用内存的上限、可以在哪些CPU上运行等等。</li></ul><h1 id="3-Docker容器和虚拟机的区别是什么？"><a href="#3-Docker容器和虚拟机的区别是什么？" class="headerlink" title="3. Docker容器和虚拟机的区别是什么？"></a>3. <strong>Docker容器和虚拟机的区别是什么？</strong></h1><p>Docker容器在操作系统级别进行虚拟化，共享宿主机的内核。</p><p>虚拟机在硬件级别进行虚拟化，拥有独立的内核。</p><p>容器通常更轻量级、启动更快，资源占用更少。</p><h1 id="4-什么是Docker镜像？"><a href="#4-什么是Docker镜像？" class="headerlink" title="4. 什么是Docker镜像？"></a>4. <strong>什么是Docker镜像？</strong></h1><p>Docker镜像是一个轻量级、只读的模板，用于创建Docker容器。它包含运行容器所需的代码、库、环境变量和配置文件。</p><h1 id="5-Docker镜像和容器之间有什么区别？"><a href="#5-Docker镜像和容器之间有什么区别？" class="headerlink" title="5. Docker镜像和容器之间有什么区别？"></a>5. <strong>Docker镜像和容器之间有什么区别？</strong></h1><p>Docker镜像是静态的定义，类似于类；而容器是镜像的实例，类似于对象。</p><h1 id="6-什么是-DockerFile？"><a href="#6-什么是-DockerFile？" class="headerlink" title="6. 什么是 DockerFile？"></a>6. 什么是 DockerFile？</h1><p>Dockerfile 是一个文本文件，其中包含我们需要运行以构建 Docker 映像的所有命令。Docker 使用 Dockerfile 中的指令自动构建镜像。我们可以<code>docker build</code>用来创建按顺序执行多个命令行指令的自动构建。</p><h1 id="3-安装下载"><a href="#3-安装下载" class="headerlink" title="3 安装下载"></a>3 安装下载</h1><h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">brew cask install docker<br></code></pre></td></tr></table></figure><h2 id="2-修改镜像源"><a href="#2-修改镜像源" class="headerlink" title="2. 修改镜像源"></a>2. 修改镜像源</h2><p>这里是网易的镜像源</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>   <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span><br> ]<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230418145138450.png" alt="image-20230418145138450"></p><h1 id="4-docker容器生命周期管理"><a href="#4-docker容器生命周期管理" class="headerlink" title="4 docker容器生命周期管理"></a>4 docker容器生命周期管理</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230418150102287.png" alt="image-20230418150102287"></p><ul><li><p>从镜像仓库中拉取或者更新指定镜像</p><p><code>docker pull nginx</code></p></li><li><p>创建一个新的容器但不启动它</p><p><code>docker create nginx</code></p></li><li><p>列出所有在运行的容器信息。</p><p><code>docker ps</code></p></li><li><p>显示所有的容器，包括未运行的</p><p><code>docker ps -a</code><br><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230418151220544.png" alt="image-20230418151220544"></p></li><li><p>启动一个停止的容器</p></li></ul><p>  <code>docker start d7e105501d1f</code></p><ul><li><p>登录容器，在运行的容器中执行命令</p><p><code> docker exec -it d7e105501d1f /bin/bash</code></p></li><li><p>暂停容器中所有的进程</p><p><code>docker pause d7e105501d1f</code></p></li><li><p>恢复容器中所有的进程。</p><p><code>docker unpause d7e105501d1f</code></p></li><li><p>停止一个运行中的容器</p><p><code>docker stop d7e105501d1f</code></p></li><li><p>杀掉一个运行中的容器。</p><p><code>docker kill d7e105501d1f</code></p></li><li><p>删除一个或多个容器</p><p><code>docker rm -f d7e105501d1f</code></p></li><li><p>在后台启动一个容器</p><p><code>docker run -d redis</code></p></li><li><p>启动一个映射端口的容器</p><p><code>docker run -p 80:80 -d nginx </code></p></li></ul><h1 id="5-docker镜像构建"><a href="#5-docker镜像构建" class="headerlink" title="5 docker镜像构建"></a>5 docker镜像构建</h1><ol><li><p>创建并编辑Dockerfile</p><p><code> vim Dockerfile</code></p></li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">#Owner by Pan Yu Rou</span><br><span class="hljs-keyword">FROM</span> redis<br><span class="hljs-keyword">MAINTAINER</span> pyr<br><span class="hljs-keyword">RUN</span><span class="bash"> mkdir test01</span><br><span class="hljs-keyword">RUN</span><span class="bash"> touch test02</span><br><span class="hljs-keyword">COPY</span><span class="bash"> test3 .</span><br><span class="hljs-keyword">ADD</span><span class="bash"> test4.tar.gz .</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> [<span class="hljs-string">&quot;/bin/sh&quot;</span>]</span><br><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;ls -l&quot;</span>]</span><br></code></pre></td></tr></table></figure><ol start="2"><li>在Dockerfile所在路径下，运行<code>docker build -t your-image-name .</code></li></ol><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ruby">➜  docker_dir docker build -t mysh .<br>[+] Building <span class="hljs-number">0</span>.5s (<span class="hljs-number">10</span>/<span class="hljs-number">10</span>) FINISHED<br> =&gt; [internal] load build definition from Dockerfile                                                                                                                                                                                                                                              <span class="hljs-number">0</span>.0s<br> =&gt; =&gt; transferring <span class="hljs-symbol">dockerfile:</span> 199B                                                                                                                                                                                                                                                              <span class="hljs-number">0</span>.0s<br> =&gt; [internal] load .dockerignore                                                                                                                                                                                                                                                                 <span class="hljs-number">0</span>.0s<br> =&gt; =&gt; transferring <span class="hljs-symbol">context:</span> 2B                                                                                                                                                                                                                                                                   <span class="hljs-number">0</span>.0s<br> =&gt; [internal] load metadata for docker.io/library/<span class="hljs-symbol">redis:</span>latest                                                                                                                                                                                                                                   <span class="hljs-number">0</span>.0s<br> =&gt; [internal] load build context                                                                                                                                                                                                                                                                 <span class="hljs-number">0</span>.0s<br> =&gt; =&gt; transferring <span class="hljs-symbol">context:</span> 176B                                                                                                                                                                                                                                                                 <span class="hljs-number">0</span>.0s<br> =&gt; [<span class="hljs-number">1</span>/<span class="hljs-number">5</span>] FROM docker.io/library/redis                                                                                                                                                                                                                                                            <span class="hljs-number">0</span>.0s<br> =&gt; [<span class="hljs-number">2</span>/<span class="hljs-number">5</span>] RUN mkdir test01                                                                                                                                                                                                                                                                        <span class="hljs-number">0</span>.2s<br> =&gt; [<span class="hljs-number">3</span>/<span class="hljs-number">5</span>] RUN touch test02                                                                                                                                                                                                                                                                        <span class="hljs-number">0</span>.1s<br> =&gt; [<span class="hljs-number">4</span>/<span class="hljs-number">5</span>] COPY test3 .                                                                                                                                                                                                                                                                            <span class="hljs-number">0</span>.0s<br> =&gt; [<span class="hljs-number">5</span>/<span class="hljs-number">5</span>] ADD test4.tar.gz .                                                                                                                                                                                                                                                                      <span class="hljs-number">0</span>.0s<br> =&gt; exporting to image                                                                                                                                                                                                                                                                            <span class="hljs-number">0</span>.0s<br> =&gt; =&gt; exporting layers                                                                                                                                                                                                                                                                           <span class="hljs-number">0</span>.0s<br> =&gt; =&gt; writing image <span class="hljs-symbol">sha256:</span>679e723aa319cdb9d1aeb923534c200b6ddb60eb9a87c8e7a3814145f716b3ff                                                                                                                                                                                                      <span class="hljs-number">0</span>.0s<br> =&gt; =&gt; naming to docker.io/library/mysh<br></code></pre></td></tr></table></figure><ol start="3"><li>通过<code>docker run your-image-name</code>运行容器</li></ol><p>可以看到test01，test02， test4 都已经出现在了容器目录中，当不指定参数命令运行时，默认运行CMD里配置的命令，否则执行参数中的命令</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">➜  docker_dir docker run mysh<br>total 8<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root   <span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 18 </span>08:14 test01<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root      <span class="hljs-number"> 0 </span>Apr<span class="hljs-number"> 18 </span>08:14 test02<br>drwxr-xr-x<span class="hljs-number"> 2 </span><span class="hljs-number"> 501 </span>dialout<span class="hljs-number"> 4096 </span>Apr<span class="hljs-number"> 18 </span>08:11 test4<br></code></pre></td></tr></table></figure><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">➜  docker_dir docker <span class="hljs-built_in">run</span> mysh -c <span class="hljs-built_in">date</span><br>Tue Apr <span class="hljs-number">18</span> <span class="hljs-number">08</span>:<span class="hljs-number">16</span>:<span class="hljs-number">51</span> UTC <span class="hljs-number">2023</span><br></code></pre></td></tr></table></figure><h1 id="4-Dockerfile常用指令"><a href="#4-Dockerfile常用指令" class="headerlink" title="4 Dockerfile常用指令"></a>4 Dockerfile常用指令</h1><ul><li><p><strong>FROM</strong>：定制的镜像都是基于 某个 基础镜像，这里的FROM就是指定基础镜像。因此在Dockerfile中，FORM是必备指令，并且必须是第一条指令。</p></li><li><p><strong>RUN</strong>：用于执行后面跟着的命令行命令。</p></li><li><p><strong>COPY</strong>: 复制指令，从上下文目录中复制文件或者目录到容器里指定路径。</p></li><li><p><strong>ADD</strong>: ADD 指令和 COPY 的使用格类似（同样需求下，官方推荐使用 COPY）。功能也类似，不同之处如下：</p><ul><li><p>ADD 的优点：在执行 &lt;源文件&gt; 为 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，会自动复制并解压到 &lt;目标路径&gt;。</p></li><li><p>ADD 的缺点：在不解压的前提下，无法复制 tar 压缩文件。会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。具体是否使用，可以根据是否需要自动解压来决定。</p></li></ul></li><li><p><strong>CMD</strong>: </p><ul><li>类似于 RUN 指令，用于运行程序，但二者运行的时间点不同: CMD 在docker run 时运行，RUN 是在 docker build。</li><li>CMD 指令指定的程序可被 docker run 命令行参数中指定要运行的程序所覆盖。</li><li>如果 Dockerfile 中如果存在多个 CMD 指令，仅最后一个生效。</li></ul></li><li><p><strong>ENTRYPOINT</strong></p><ul><li>类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序。</li><li>如果运行 docker run 时使用了 –entrypoint 选项，将覆盖 ENTRYPOINT 指令指定的程序。</li><li>如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。</li></ul></li><li><p><strong>ENV</strong></p><ul><li><p>设置环境变量，定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。</p></li><li><p>格式：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">ENV <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span><br>ENV <span class="hljs-tag">&lt;<span class="hljs-name">key1</span>&gt;</span>=<span class="hljs-tag">&lt;<span class="hljs-name">value1</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">key2</span>&gt;</span>=<span class="hljs-tag">&lt;<span class="hljs-name">value2</span>&gt;</span>...<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>ARG</strong></p><ul><li>构建参数，与 ENV 作用一致。不过作用域不一样。ARG 设置的环境变量仅对 Dockerfile 内有效，也就是说只有 docker build 的过程中有效，构建好的镜像内不存在此环境变量。</li><li>构建命令 docker build 中可以用 –build-arg &lt;参数名&gt;&#x3D;&lt;值&gt; 来覆盖。</li><li>格式：<code>ARG &lt;参数名&gt;[=&lt;默认值&gt;]</code></li></ul></li><li><p><strong>EXPOSE</strong></p><ul><li>仅仅只是声明端口。</li></ul></li></ul><h1 id="6-docker数据持久化"><a href="#6-docker数据持久化" class="headerlink" title="6 docker数据持久化"></a>6 docker数据持久化</h1><p>摆放数据的持久化卷有两种常见的使用方法：Bing mounts 和 Volume</p><h2 id="1-Bind-Mounts（狩猎模式）"><a href="#1-Bind-Mounts（狩猎模式）" class="headerlink" title="1. Bind Mounts（狩猎模式）"></a>1. Bind Mounts（狩猎模式）</h2><p>Bind mounts 是由用户在主机上进行选择目录进行存储，方便指定特定文件或者目录</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">docker run -v <span class="hljs-tag">&lt;<span class="hljs-name">host_path:</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">container_path</span>&gt;</span> -d <br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  docker docker run -v <span class="hljs-variable">$PWD</span><span class="hljs-regexp">/data:/</span>data -d redis:<span class="hljs-number">3.2</span> redis-server<br>d7a6e3dccf100ea42bb1a8168dbf9ea27ed71b0b2837d19239f3eff8497fedd5<br>➜  docker docker ps<br>CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS      NAMES<br>d7a6e3dccf10   redis:<span class="hljs-number">3.2</span>   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   <span class="hljs-number">5</span> seconds ago   Up <span class="hljs-number">4</span> seconds   <span class="hljs-number">6379</span>/tcp   quizzical_swartz<br><span class="hljs-number">2</span>e3ce4212a25   redis       <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   <span class="hljs-number">2</span> hours ago     Up <span class="hljs-number">2</span> hours     <span class="hljs-number">6379</span>/tcp   charming_ritchie<br>➜  docker docker exec -it d7a6e3dccf10 <span class="hljs-regexp">/bin/</span>bash<br>root@d7a6e3dccf10:/data<span class="hljs-comment"># touch redis-logs</span><br>root@d7a6e3dccf10:/data<span class="hljs-comment"># exit</span><br><span class="hljs-keyword">exit</span><br>➜  docker ls<br>data         dockerfile01 dockerfile02<br>➜  docker cd data<br>➜  data ls<br>redis-logs<br></code></pre></td></tr></table></figure><h2 id="2-Volumes（靶场模式）"><a href="#2-Volumes（靶场模式）" class="headerlink" title="2. Volumes（靶场模式）"></a>2. Volumes（靶场模式）</h2><p>而Volume则统一将数据放到主机的、var&#x2F;lib&#x2F;docker&#x2F;volumes下，只能对应特定目录下的子目录，不支持文件，但是不容易乱，适合小白进行使用。两种主流volumn的创建方式：</p><ul><li><p>隐式创建卷：<code>docker run -v &lt;container_path&gt; -d </code></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  docker docker run -v data2 -d redis:<span class="hljs-number">3.2</span> redis-server<br><span class="hljs-number">829</span>ea54fbaeef20c7ea1f3f1e3a82d5dd7f7a73d099c74b758926a14b2c4f5ca<br>➜  docker docker ps<br>CONTAINER ID   IMAGE       COMMAND                  CREATED              STATUS              PORTS      NAMES<br><span class="hljs-number">829</span>ea54fbaee   redis:<span class="hljs-number">3.2</span>   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   <span class="hljs-number">4</span> seconds ago        Up <span class="hljs-number">3</span> seconds        <span class="hljs-number">6379</span>/tcp   awesome_euclid<br>d7a6e3dccf10   redis:<span class="hljs-number">3.2</span>   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   About a minute ago   Up About a minute   <span class="hljs-number">6379</span>/tcp   quizzical_swartz<br><span class="hljs-number">2</span>e3ce4212a25   redis       <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   <span class="hljs-number">2</span> hours ago          Up <span class="hljs-number">2</span> hours          <span class="hljs-number">6379</span>/tcp   charming_ritchie<br>➜  docker docker exec -it <span class="hljs-number">829</span>ea54fbaee <span class="hljs-regexp">/bin/</span>bash<br>root@<span class="hljs-number">829</span>ea54fbaee:/data<span class="hljs-comment"># touch redis-log2</span><br>root@<span class="hljs-number">829</span>ea54fbaee:/data<span class="hljs-comment"># exit</span><br><span class="hljs-keyword">exit</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  docker docker run -it --privileged --pid=host justincormack/nsenter1<br><br><span class="hljs-regexp">/ # cd var/</span>lib<span class="hljs-regexp">/docker/</span>volumes<span class="hljs-regexp">/b4778654451afef91ac2dbf8e6ce7881c065404ebc749d1bc7ea50fa93122e3d/</span>_data<br><span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>volumes<span class="hljs-regexp">/b4778654451afef91ac2dbf8e6ce7881c065404ebc749d1bc7ea50fa93122e3d/</span>_data <span class="hljs-comment"># ls</span><br>redis-log2<br></code></pre></td></tr></table></figure></li><li><p>显式创建卷：(先创建卷，再创建容器绑定卷)        <code>docker volume create data3</code></p></li></ul><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm"> ➜  docker docker volume create data<span class="hljs-number">3</span><br> ➜  docker docker run -v data<span class="hljs-number">3</span>:/data<span class="hljs-number">3</span> -d redis:<span class="hljs-number">3.2</span> redis-server<br>da<span class="hljs-number">981</span>af<span class="hljs-number">699805</span>bf<span class="hljs-number">18e87</span>ed<span class="hljs-number">7</span>d<span class="hljs-number">986e2</span>e<span class="hljs-number">9</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span><span class="hljs-keyword">c</span><span class="hljs-number">08220</span><span class="hljs-keyword">c</span><span class="hljs-number">67</span>f<span class="hljs-number">111</span><span class="hljs-keyword">c</span><span class="hljs-number">136597</span><span class="hljs-keyword">c</span><span class="hljs-number">62</span>d<span class="hljs-number">15</span>f<span class="hljs-number">144</span><span class="hljs-keyword">c</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">➜  docker docker run -it --privileged --pid=host justincormack/nsenter1<br><span class="hljs-regexp">/ #  ls -ld /</span>var<span class="hljs-regexp">/lib/</span>docker<span class="hljs-regexp">/volumes/</span>data3<br>drwx-----x    <span class="hljs-number">3</span> root     root          <span class="hljs-number">4096</span> Apr <span class="hljs-number">18</span> <span class="hljs-number">09</span>:<span class="hljs-number">31</span> <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>volumes/data3<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230418170422909.png" alt="image-20230418170422909"></p><h1 id="7-Docker仓库"><a href="#7-Docker仓库" class="headerlink" title="7 Docker仓库"></a>7 Docker仓库</h1><p>仓库（Repository）是集中存放镜像的地方。 总体来看Docker 仓库可以分为两大类：</p><ul><li>公共仓库：最经典的公共仓库就是Docker Hub。当Docker装好后，其默认的镜像源头就是这个功能仓库。当运行Docker run等命令时系统会自动从Docker Hub下载现有镜像到本地。除了Docker Hub之外还有一些第三方的公共仓库，对外提供服务，比如Quay、阿里云等。</li><li>私有仓库：私有仓库是互联网企业的生产中心的实际操作中的主流选择。不采用公共仓库通常出于以下两个原因：<ul><li>公共仓库通常建于海外，下载速度受限，对于大量节点频繁更新的互联网应用场景不太友好。</li><li>公共仓库位于外网，直接将生产中心的应用和外网相连，存在明显安全隐患。黑客等容易通过网络漏洞渗透到企业内网；并且公共仓库内的容器镜像未通过企业内部的静态文件扫描，无法保证镜像中所采用的运行时和依赖库的安全性。</li></ul></li></ul><h1 id="8-修改Docker默认镜像和容器存储位置"><a href="#8-修改Docker默认镜像和容器存储位置" class="headerlink" title="8 修改Docker默认镜像和容器存储位置"></a>8 修改Docker默认镜像和容器存储位置</h1><p><a href="https://so.csdn.net/so/search?q=Docker&spm=1001.2101.3001.7020">Docker</a> 默认安装的情况下，会使用 <code>/var/lib/docker/</code> 目录作为存储目录，用以存放拉取的镜像和创建的容器等。不过由于此目录一般都位于系统盘，遇到系统盘比较小，而镜像和容器多了后就容易磁盘空间不足</p><ul><li><p>查看当前<a href="https://so.csdn.net/so/search?q=docker&spm=1001.2101.3001.7020">docker</a>的默认存储目录 <code>docker info</code> ,默认为<code>/var/lib/docker/</code> </p></li><li><p>编辑 <code>/etc/docker/daemon.json</code> 文件</p><p><code>sudo vim /etc/docker/daemon.json </code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;data-root&quot;</span>: <span class="hljs-string">&quot;/home/docker&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>重启docker, 并查看 <code>docker info</code></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>单点登录</title>
    <link href="/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"/>
    <url>/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h1 id="1-跨域认证的问题"><a href="#1-跨域认证的问题" class="headerlink" title="1 跨域认证的问题"></a>1 跨域认证的问题</h1><p>互联网服务离不开用户认证。一般流程是下面这样。</p><p>1、用户向服务器发送用户名和密码。</p><p>2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。</p><p>3、服务器向用户返回一个 session_id，写入用户的 Cookie。</p><p>4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。</p><p>5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。</p><p>这种模式的问题在于，扩展性（scaling）不好。单机当然没有问题，如果是服务器集群，或者是跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。</p><p>举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？</p><ul><li>一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</li><li>另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。JWT 就是这种方案的一个代表。</li></ul><h1 id="2-JWT概述"><a href="#2-JWT概述" class="headerlink" title="2 JWT概述"></a>2 JWT概述</h1><p>JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案，JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;姓名&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-string">&quot;角色&quot;</span>: <span class="hljs-string">&quot;管理员&quot;</span>,<br>  <span class="hljs-string">&quot;到期时间&quot;</span>: <span class="hljs-string">&quot;2018年7月1日0点0分&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。</p><p>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展</p><h1 id="3-JWT-的数据结构"><a href="#3-JWT-的数据结构" class="headerlink" title="3 JWT 的数据结构"></a>3 JWT 的数据结构</h1><p>实际的 JWT 大概就像下面这样。<a href="https://jwt.io/">https://jwt.io/</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230320140654212.png" alt="image-20230320140654212"></p><p>它是一个很长的字符串，中间用点（<code>.</code>）分隔成三个部分。依次是：</p><ul><li>Header（头部）：Header 部分是一个 JSON 对象，描述 JWT 的元数据。上图中，<code>alg</code>属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；<code>typ</code>属性表示这个令牌（token）的类型（type），JWT 令牌统一写为<code>JWT</code>。</li><li>Payload（负载）：Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。除了官方字段，你还可以在这个部分定义私有字段</li><li>Signature（签名）：Signature 部分是对前两部分的签名，防止数据篡改。首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</li></ul><p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用”点”（<code>.</code>）分隔，就可以返回给用户。</p><p><strong>Base64URL</strong></p><p>Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。</p><p>JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com&#x2F;?token&#x3D;xxx）。Base64 有三个字符<code>+</code>、<code>/</code>和<code>=</code>，在 URL 里面有特殊含义，所以要被替换掉：<code>=</code>被省略、<code>+</code>替换成<code>-</code>，<code>/</code>替换成<code>_</code> 。这就是 Base64URL 算法。</p><h1 id="4-JWT-的使用方式"><a href="#4-JWT-的使用方式" class="headerlink" title="4 JWT 的使用方式"></a>4 JWT 的使用方式</h1><p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p><p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">Authorization:</span> Bearer <span class="hljs-params">&lt;token&gt;</span><br></code></pre></td></tr></table></figure><p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p><h1 id="5-JWT特点"><a href="#5-JWT特点" class="headerlink" title="5 JWT特点"></a>5 JWT特点</h1><p>（1）JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</p><p>（2）JWT 不加密的情况下，不能将秘密数据写入 JWT。</p><p>（3）JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</p><p>（4）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</p><p>（5）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</p><p>（6）为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>分布式ID</title>
    <link href="/%E5%88%86%E5%B8%83%E5%BC%8FID/"/>
    <url>/%E5%88%86%E5%B8%83%E5%BC%8FID/</url>
    
    <content type="html"><![CDATA[<h1 id="1-为什么需要分布式ID"><a href="#1-为什么需要分布式ID" class="headerlink" title="1. 为什么需要分布式ID"></a>1. 为什么需要分布式ID</h1><p>在单体结构的应用中，我们可以使用 MySQL 数据库的主键自增来为我们的数据设置唯一标识 ID，但是在分布式环境中，单个数据库的吞吐量成为整个应用的性能瓶颈，我们就可以搭建数据库集群来提升数据库的性能，此时如果还使用 MySQL 的主键自增来设置数据 ID 的话，就会出现重复的 ID，这样就会出现主键冲突的情况。</p><p>如果使用分布式的全局唯一 ID 就不用担心会出现这个问题了</p><h1 id="2-分布式ID"><a href="#2-分布式ID" class="headerlink" title="2 分布式ID"></a>2 分布式ID</h1><p>一个好的分布式ID，一般要满足下列特性：</p><ul><li><strong>唯一性</strong>：保证全局唯一</li><li><strong>高可用</strong>，可以由主从、集群等模式保证可用性</li><li><strong>高性能</strong>，比如基于内存</li><li><strong>递增性</strong>：适合作为数据库索引</li><li><strong>安全性</strong>：id如果是顺序递增，则容易暴露业务信息</li></ul><h1 id="3-全局唯一ID生成策略"><a href="#3-全局唯一ID生成策略" class="headerlink" title="3 全局唯一ID生成策略"></a>3 全局唯一ID生成策略</h1><h3 id="1-数据库自增ID"><a href="#1-数据库自增ID" class="headerlink" title="1. 数据库自增ID"></a>1. 数据库自增ID</h3><p>利用数据库的自增主键特性，每次插入记录时，数据库会自动生成一个唯一的ID。</p><p><strong>优点</strong>：</p><ul><li>简单易用，直接使用数据库提供的功能。</li><li>保证唯一性。</li></ul><p><strong>缺点</strong>：</p><ul><li>存在单点故障，数据库成为瓶颈。</li><li>考虑数据量大时，可能需要分库分表.</li></ul><h3 id="2-UUID（Universally-Unique-Identifier）"><a href="#2-UUID（Universally-Unique-Identifier）" class="headerlink" title="2. UUID（Universally Unique Identifier）"></a>2. UUID（Universally Unique Identifier）</h3><p>UUID 是一种标准的唯一标识符，通常为128位长，可以保证全局唯一性。在 Java 中可以使用 java.util.UUID 的 randomUUID() 方法来获得：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.util.UUID.randomUUID().toString();<br></code></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>生成简单，不依赖中心化服务。</li><li>唯一性强。</li></ul><p><strong>缺点</strong>：</p><ul><li>较长，占用空间大，不适合作为数据库索引。</li><li>无序，无法实现范围查询</li><li>插入时需要维护B＋树，而B＋树是有序的，因此插入操作的性能比自增ID要差，有些博客测评插入性能要差４倍</li></ul><blockquote><p>建议用自增ID作为主键，业务上采取UUID作为唯一标识</p></blockquote><h3 id="3-Twitter的Snowflake算法"><a href="#3-Twitter的Snowflake算法" class="headerlink" title="3. Twitter的Snowflake算法"></a>3. Twitter的Snowflake算法</h3><p>Snowflake 是 Twitter 开源的分布式ID生成算法，通过组合时间戳、机器ID和序列号生成ID。</p><p><strong>ID结构</strong>：</p><ul><li>1位符号位：始终为0。</li><li>41位时间戳：毫秒级时间戳，可使用69年。</li><li>10位机器ID：支持1024台机器。</li><li>12位序列号：每毫秒支持生成4096个ID。</li></ul><p><strong>优点</strong>：</p><ul><li>高性能，低延迟。</li><li>时间有序生成，适合数据库索引。</li></ul><p><strong>缺点</strong>：</p><ul><li>依赖机器时间，时钟回拨可能导致ID重复或冲突。</li></ul><blockquote><p>时钟回拨问题，在一些Snowflake的变种已经解决掉了，如百度的uid-generator</p></blockquote><h3 id="4-使用Redis生成ID"><a href="#4-使用Redis生成ID" class="headerlink" title="4. 使用Redis生成ID"></a>4. 使用Redis生成ID</h3><p>利用Redis的原子性递增操作，生成分布式唯一ID。使用 Redis 的 Incr 命令来把 &lt;key,value&gt; 中 key 的数值加 1 并返回，如果这个 key 不存在，则 key 值会被初始化为 0，再执行 Incr 命令来进行加 1 操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 使用 incr(key) 来让 key 加 1</span><br><span class="hljs-keyword">long</span> id = jedis.incr(<span class="hljs-string">&quot;id&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>简单，利用Redis的原子操作保证唯一性。</li><li>性能高，Redis操作速度快。</li></ul><p><strong>缺点</strong>：</p><ul><li>依赖Redis服务，可能成为瓶颈。</li><li>需要处理Redis的持久化和高可用性。</li></ul>]]></content>
    
    
    <categories>
      
      <category>分布式</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>jenkins部署vue项目</title>
    <link href="/jenkins%E9%83%A8%E7%BD%B2vue%E9%A1%B9%E7%9B%AE/"/>
    <url>/jenkins%E9%83%A8%E7%BD%B2vue%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="1-配置nodeJs"><a href="#1-配置nodeJs" class="headerlink" title="1 配置nodeJs"></a>1 配置nodeJs</h1><p>因为Jenkins容器中只有java环境支持运行jenkins，没有node环境，但是jenkins提供在线安装nodejs。<a href="https://plugins.jenkins.io/nodejs">官方文档</a></p><ol><li>系统管理—&gt;管理插件—&gt;下载NodeJS插件</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230315155958382.png" alt="image-20230315155958382"></p><ol start="2"><li>系统管理—&gt;全局工具配置—&gt;选择需要安装的nodejs版本</li></ol><p>Jenkins 会从nodejs官网下载安装，nodejs安装包在：$JENKINS_HOME&#x2F;tools目录下</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230315155909887.png" alt="image-20230315155909887"></p><p>注：这里也需要配置git</p><h1 id="2-新建一个任务"><a href="#2-新建一个任务" class="headerlink" title="2 新建一个任务"></a>2 新建一个任务</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230315160310957.png" alt="image-20230315160310957"></p><h1 id="3-配置仓库地址和分支名"><a href="#3-配置仓库地址和分支名" class="headerlink" title="3 配置仓库地址和分支名"></a>3 配置仓库地址和分支名</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230315160535916.png" alt="image-20230315160535916"></p><h1 id="4-配置构建环境"><a href="#4-配置构建环境" class="headerlink" title="4 配置构建环境"></a>4 配置构建环境</h1><p>构建环境勾选 Provide Node &amp; npm bin&#x2F;folder to PATH</p><ul><li>每次build，都会首先执行环境构建，环境构建无误后，才会开始真正的构建过程</li><li>会下载nodejs并安装配置，并把node添加到当前PATH环境变量中，这样就支持node和npm命令了</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230315160620905.png" alt="image-20230315160620905"></p><h1 id="5-配置shell"><a href="#5-配置shell" class="headerlink" title="5 配置shell"></a>5 配置shell</h1><p>执行：</p><p><code>npm install &amp;&amp; npm run build &amp;&amp; npm run domain &amp;&amp; npm run aliyun</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230322152124371.png" alt="image-20230322152124371"></p><p>至此，可以点击立即构建了</p><h1 id="6-配置远端服务器"><a href="#6-配置远端服务器" class="headerlink" title="6 配置远端服务器"></a>6 配置远端服务器</h1><p>注意：如果使用了echo,需要勾选Verbose output in console才可以在控制台，看到打印的日志</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230324163338300.png" alt="image-20230324163338300"></p><h1 id="7-使用打好的包替换服务器上的包"><a href="#7-使用打好的包替换服务器上的包" class="headerlink" title="7 使用打好的包替换服务器上的包"></a>7 使用打好的包替换服务器上的包</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230322154215106.png" alt="image-20230322154215106"></p><h1 id="8-遇到的问题"><a href="#8-遇到的问题" class="headerlink" title="8 遇到的问题"></a>8 遇到的问题</h1><p>记录下在windows搭建时遇到的问题</p><ol><li>Cannot run program “sh” (in directory “C:\ProgramData\Jenkins.jenkins\workspace\sith-front”): CreateProcess error&#x3D;2, 系统找不到指定的文件。</li></ol><p>解决：Manage Jenkins-&gt; Configure System-&gt; Shell-&gt; Shell execute </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">C:\Windows\system32\cmd.exe<br></code></pre></td></tr></table></figure><ol start="2"><li><p>ssh:&#x2F;&#x2F;&#x2F;<a href="mailto:&#103;&#105;&#x74;&#64;&#103;&#x69;&#116;&#x65;&#101;&#46;&#99;&#111;&#x6d;">&#103;&#105;&#x74;&#64;&#103;&#x69;&#116;&#x65;&#101;&#46;&#99;&#111;&#x6d;</a>:SIEMENS_MMF&#x2F;MMF.git +refs&#x2F;heads&#x2F;<em>:refs&#x2F;remotes&#x2F;origin&#x2F;</em>“ returned status code 128:<br>stdout:<br>stderr: ssh: connect to host  port 22: Connection refused<br>fatal: Could not read from remote repository.</p><p>Please make sure you have the correct access rights<br>and the repository exists.</p></li></ol><p>原因：Jenkins网页登录时，ssh连接使用的是Jenkins自身的账户，并不是我们登录电脑所使用的的账户，该账户下并没有ssh连接所需要的rsa文件，</p><p>解决：</p><p>成功执行git pull等命令的账户，在C:\Users\xxxxxx.ssh目录下（xxxxxx是登录电脑的用户名，不是git的用户名），会有id_rsa，id_rsa.pub，known_hosts文件，把这3个文件拷贝到C:\Windows\System32\config\systemprofile.ssh目录下，再执行jenkins就OK了</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>权限</title>
    <link href="/%E6%9D%83%E9%99%90/"/>
    <url>/%E6%9D%83%E9%99%90/</url>
    
    <content type="html"><![CDATA[<p>![image-20230227215016860](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227215016860.png)</p><p>![image-20230227215417463](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227215417463.png)</p><p>![image-20230227215912534](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227215912534.png)</p><p>![image-20230227220350015](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227220350015.png) </p><p>![image-20230227221024772](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227221024772.png)</p><p>![image-20230227221142243](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227221142243.png)</p><p>![image-20230227221149342](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227221149342.png)</p><ul><li>权限相关更新记录表</li></ul><p>![image-20230227221806073](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227221806073.png)</p><p>![image-20230227223420765](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230227223420765.png)</p><ul><li>null被索引的话，需要额外的一个字节</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Shiro入门</title>
    <link href="/Shiro%E5%85%A5%E9%97%A8/"/>
    <url>/Shiro%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-shiro-概念"><a href="#1-shiro-概念" class="headerlink" title="1. shiro 概念"></a>1. shiro 概念</h1><ul><li><strong>Apache Shiro™</strong>是一个强大且易用的Java安全框架,能够用于身份验证、授权、加密和会话管理</li><li>Shiro拥有易于理解的API,您可以快速、轻松地获得任何应用程序——从最小的移动应用程序到最大的网络和企业应用程序。</li></ul><h1 id="2-shiro优缺点"><a href="#2-shiro优缺点" class="headerlink" title="2. shiro优缺点"></a>2. shiro优缺点</h1><p>优点： </p><ul><li>提供了一套框架，易于使用</li><li>更灵活，应对需求能力强，web能力强</li><li>可与很多框架进行集成</li></ul><p>缺点：</p><ul><li>操作的界面需要自己实现</li></ul><h1 id="3-springboot集成shiro"><a href="#3-springboot集成shiro" class="headerlink" title="3 springboot集成shiro"></a>3 springboot集成shiro</h1><ol><li>引入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>创建自定义AuthRealm和密码校验规则</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-comment">// 认证登录</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken token)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) token;<br>        String username = usernamePasswordToken.getUsername();<br>        User user = userService.findByUsername(username);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(user, user.getPassword(), <span class="hljs-keyword">this</span>.getClass().getName());<br>    &#125;<br><br>    <span class="hljs-comment">// 授权</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principals)</span> </span>&#123;<br>        User user = (User) principals.fromRealm(<span class="hljs-keyword">this</span>.getClass().getName()).iterator().next();<br>        List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        List&lt;String&gt; roleNameList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        Set&lt;Role&gt; roleSet = user.getRoles();<br>        <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(roleSet)) &#123;<br>            <span class="hljs-keyword">for</span> (Role role : roleSet) &#123;<br>                roleNameList.add(role.getRname());<br>                Set&lt;Permission&gt; permissionSet = role.getPermissions();<br>                <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(permissionSet)) &#123;<br>                    <span class="hljs-keyword">for</span> (Permission permission : permissionSet) &#123;<br>                        permissionList.add(permission.getName());<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        SimpleAuthorizationInfo info = <span class="hljs-keyword">new</span> SimpleAuthorizationInfo();<br>        info.addStringPermissions(permissionList);<br>        info.addRoles(roleNameList);<br>        <span class="hljs-keyword">return</span> info;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自己实现密码校验规则</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CredentialMatcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleCredentialsMatcher</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">doCredentialsMatch</span><span class="hljs-params">(AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;<br>        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) token;<br>        String password = <span class="hljs-keyword">new</span> String(usernamePasswordToken.getPassword());<br>        String dbPassword = (String) info.getCredentials();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.equals(password, dbPassword);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="3"><li>添加配置类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.shiro.demo1.config;<br><br><span class="hljs-keyword">import</span> com.pyr.shiro.demo1.shiro.AuthRealm;<br><span class="hljs-keyword">import</span> com.pyr.shiro.demo1.shiro.CredentialMatcher;<br><span class="hljs-keyword">import</span> org.apache.shiro.cache.MemoryConstrainedCacheManager;<br><span class="hljs-keyword">import</span> org.apache.shiro.mgt.SecurityManager;<br><span class="hljs-keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;<br><span class="hljs-keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;<br><span class="hljs-keyword">import</span> org.apache.shiro.web.filter.mgt.DefaultFilter;<br><span class="hljs-keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.LinkedHashMap;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShiroConfiguration</span> </span>&#123;<br><br>    <span class="hljs-comment">//ShiroFilter过滤所有请求</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title">shiroFilter</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;securityManager&quot;)</span> SecurityManager manager)</span> </span>&#123;<br>        ShiroFilterFactoryBean bean = <span class="hljs-keyword">new</span> ShiroFilterFactoryBean();<br>        bean.setSecurityManager(manager);<br>        bean.setFilterChainDefinitionMap(filterChainDefinitionMap);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-comment">// 创建安全管理器</span><br>    <span class="hljs-meta">@Bean(&quot;securityManager&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> SecurityManager <span class="hljs-title">securityManager</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;authRealm&quot;)</span> AuthRealm authRealm)</span> </span>&#123;<br>        DefaultWebSecurityManager manager = <span class="hljs-keyword">new</span> DefaultWebSecurityManager();<br>        manager.setRealm(authRealm);<br>        <span class="hljs-keyword">return</span> manager;<br>    &#125;<br><br>    <span class="hljs-comment">// 创建自定义Realm</span><br>    <span class="hljs-meta">@Bean(&quot;authRealm&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> AuthRealm <span class="hljs-title">authRealm</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;credentialMatcher&quot;)</span> CredentialMatcher matcher)</span> </span>&#123;<br>        AuthRealm authRealm = <span class="hljs-keyword">new</span> AuthRealm();<br>        authRealm.setCacheManager(<span class="hljs-keyword">new</span> MemoryConstrainedCacheManager());<br>        authRealm.setCredentialsMatcher(matcher);<br>        <span class="hljs-keyword">return</span> authRealm;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean(&quot;credentialMatcher&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CredentialMatcher <span class="hljs-title">credentialMatcher</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CredentialMatcher();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * shiro和spring的配置</span><br><span class="hljs-comment">     * 设置spring使用的securityManager是我们自定义的securityManager</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="hljs-title">authorizationAttributeSourceAdvisor</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;securityManager&quot;)</span> SecurityManager securityManager)</span> </span>&#123;<br>        AuthorizationAttributeSourceAdvisor advisor = <span class="hljs-keyword">new</span> AuthorizationAttributeSourceAdvisor();<br>        advisor.setSecurityManager(securityManager);<br>        <span class="hljs-keyword">return</span> advisor;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="hljs-title">defaultAdvisorAutoProxyCreator</span><span class="hljs-params">()</span> </span>&#123;<br>        DefaultAdvisorAutoProxyCreator creator = <span class="hljs-keyword">new</span> DefaultAdvisorAutoProxyCreator();<br>        creator.setProxyTargetClass(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-keyword">return</span> creator;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="4-使用"><a href="#4-使用" class="headerlink" title="4. 使用"></a>4. 使用</h1><p>代码地址： <a href="https://github.com/pyr9/springboot-shiro-demo">https://github.com/pyr9/springboot-shiro-demo</a></p>]]></content>
    
    
    <categories>
      
      <category>权限管理</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Shiro</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>automation</title>
    <link href="/automation/"/>
    <url>/automation/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="4737e9db48166e363d2061002b5612af526733c1145cda8f56211600a401dda6">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c0e0109cd9ac79b3c6e509264a3591d85521fe71ab04726f7d774f359aa9951ac91825ad99409a0fd3ec64390c3d6caf8f1eb2abbc552db377af521e225afc37e8958a5041b099eed991b14eb697e2865b081ff53160752dab586928c2ba7d2bfb9aee0ae37e112dc9f09b26ff714fe72d7fdca6a34b00e70970391d7966c5ee05df481bf12df468d2465844ffe6346d94e33ff083d718f063357f3de6ac6cdfa711be4c847cdbd921037cec33930bd1bb0e75c00b9a2c68aab9c2e4ebfc626cdbc2a7b84f6651488e1f83d9e86740fd923851f0ddba20766726a263727c4151f5b3172dc0b028e92590f9fddf32da0a22fccd5355f786646167cb4a5b55cc1b6c788fdf4017864ee0dff6677dcbcd5f43525fa2f20f67398c0c8e1a1599d12e025f19dbcb20c371dd4cd806c7128a1dd911e55ac22d5475277a2a27388661a6ef291fda5b4185a1a3cbf878448928cbc7bc79f0687499937b19413710c1fd53c52d9e0d5b53a22174d1b111eaa092e07ef0c656a0dc5b1d9c5e7ec346df6cc6a220087f4b096a159a526fa7979dac0a9237e48275895cd74eaacac56f7af909381b307595dfd19e88ecebc5bbaa9de962878eda87780ef37affc78aea5eb6fea06849fe67858b57389b5ddbcb9e7548639d74833ddf88160e3f11b71355d648625f0ae18a5378ef3ea5b440e7951396ad2da355b5392bf120b98e1b21c59ba37b851135418165afc5b6e859e463addd68cad21a3b6968c43ef56bbe21803ed85b303f3c3887917cd17b05b391b45fd84592fd3675914789c3df69f0c063a5ad7fd65b654e547185118749ca71cfbd5bb69281f651fb1ee450c1848d01598efbc4b818fbbb76f6a868534bf0895f02c27b5c9c4f87d75509d8da1a0a897c9dccea8d66ccdbe2ee6b69c4a1cda016c228accbdecb6c7073aad66d62961de277ab04c484fae88cccd82b2b64011a9c25c6d707c4e4301415538a4ddec84ffc30f61c88a125f5cae92c7d986d7fbdeaaa136d3dacb0a25e52d7859e18ed746e83e03f29fa15b7c7f85c7e9b73ec03678674f01c8617e18088c1871ad06f9fa945d760f21d2d480438803be67c23a5e7dbf7157fd2c58f1e999c129f120186b7113e9c51fee473c42bb6f3cdd3d316ce8e61008eaf74cc86ed117f2eda9acdabb5b2d56d4c97b5878570795573db3b0cde9e8c9f8eb165c5602fa3ed4894806814d83c5dea8d17ff52033ad529d13bd82e2e185abd06a4fce0fdfbbf7b1afeda63dc520cf21bc9ba0414ad7fa9bc81dcd43204</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>SpringSecurity</title>
    <link href="/springSecurity/"/>
    <url>/springSecurity/</url>
    
    <content type="html"><![CDATA[<h1 id="1-权限管理"><a href="#1-权限管理" class="headerlink" title="1. 权限管理"></a>1. 权限管理</h1><h2 id="1-1-为什么需要权限管理"><a href="#1-1-为什么需要权限管理" class="headerlink" title="1.1. 为什么需要权限管理"></a>1.1. 为什么需要权限管理</h2><ul><li>安全性：误操作、认为破坏、数据泄漏等</li><li>数据隔离：不同的权限可以看到不同的数据</li><li>明确职责：销售、开发等不同角色，leader和dev不同级别，不同职责可以看到不同的数据</li></ul><h2 id="1-2-理想的权限管理"><a href="#1-2-理想的权限管理" class="headerlink" title="1.2. 理想的权限管理"></a>1.2. 理想的权限管理</h2><ul><li>能实现角色级权限</li><li>能实现功能级、数据级权限</li><li>简单、易操作、能够应对各种需求</li></ul><h1 id="2-SpringSecurity"><a href="#2-SpringSecurity" class="headerlink" title="2. SpringSecurity"></a>2. SpringSecurity</h1><h2 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1.  概念"></a>2.1.  概念</h2><ul><li><p>Spring Security 是 Spring 家族中的一个<strong>安全管理框架</strong>。相比与另外一个安全框架Shiro，它提供了更丰富的功能，社区资源也比Shiro丰富。</p></li><li><p>一般来说中大型的项目都是使用SpringSecurity 来做安全框架。小项目有Shiro的比较多，因为相比与SpringSecurity，Shiro的上手更加的简单。</p></li><li><p>一般Web应用的需要进行认证和授权。而<strong>认证和授权也是SpringSecurity作为安全框架的核心功能</strong>。</p><ul><li>认证：验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户</li><li>授权：经过认证后判断当前用户是否有权限进行某个操作</li></ul></li></ul><h2 id="2-2-优点和缺点"><a href="#2-2-优点和缺点" class="headerlink" title="2.2 优点和缺点"></a>2.2 优点和缺点</h2><p>优点：</p><ul><li>提供了很多用户认证的功能，实现相关接口即可，节省了大量开发工作</li><li>基于spring，易于集成</li></ul><p>缺点：</p><ul><li>配置文件多，角色被 “编码” 到配置文件和源文件中</li><li>对于系统中的用户、角色、权限之间的关系，没有可操作的界面。后台管理员没办法知道每个人的角色权限是什么样的，增大了管理的难度和分配权限的错误率。</li><li>由于配置多，没有可操作的界面，大数据量情况下，基本不可用。</li></ul><h2 id="2-3-springboot-整合-springSecurity"><a href="#2-3-springboot-整合-springSecurity" class="headerlink" title="2.3  springboot 整合 springSecurity"></a>2.3  springboot 整合 springSecurity</h2><ol><li>添加依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>添加配置文件</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.security.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        http.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>).permitAll()<br>                .anyRequest().authenticated()<br>                .and()<br>                .logout().permitAll()<br>                .and()<br>                .formLogin();<br>        http.csrf().disable();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        web.ignoring().antMatchers(<span class="hljs-string">&quot;/js/**&quot;</span>, <span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/images/**&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>测试</li></ol><p>根据配置文件，可以得知，所有人可访问”&#x2F;“，其他请求都需要登录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>&#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">index</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello springboot!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>测试访问 “&#x2F;“ 路径</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230226185258468.png" alt="image-20230226185258468"></p><ul><li><p>测试访问 “&#x2F;hello” ，会302重定向到shiro框架，默认的login界面（依赖版本不同，login页面会有差异）</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230226185524573.png" alt="image-20230226185524573"></p></li></ul><h2 id="2-4-存储用户信息"><a href="#2-4-存储用户信息" class="headerlink" title="2.4 存储用户信息"></a>2.4 存储用户信息</h2><h3 id="2-4-1-直接存储在内存中"><a href="#2-4-1-直接存储在内存中" class="headerlink" title="2.4.1 直接存储在内存中"></a>2.4.1 直接存储在内存中</h3><p>在SpringSecurityConfig，中重写configure方法，指定用户和角色：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>  auth.inMemoryAuthentication().passwordEncoder(<span class="hljs-keyword">new</span> BCryptPasswordEncoder()).withUser(<span class="hljs-string">&quot;admin&quot;</span>).password(<span class="hljs-keyword">new</span> BCryptPasswordEncoder().encode(<span class="hljs-string">&quot;111&quot;</span>)).roles(<span class="hljs-string">&quot;USER&quot;</span>);<br>  auth.inMemoryAuthentication().passwordEncoder(<span class="hljs-keyword">new</span> BCryptPasswordEncoder()).withUser(<span class="hljs-string">&quot;pyr&quot;</span>).password(<span class="hljs-keyword">new</span> BCryptPasswordEncoder().encode(<span class="hljs-string">&quot;pyr&quot;</span>)).roles(<span class="hljs-string">&quot;ADMIN&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="2-4-2-存储在数据库中"><a href="#2-4-2-存储在数据库中" class="headerlink" title="2.4.2 存储在数据库中"></a>2.4.2 存储在数据库中</h3><ol><li>定义UserService实现UserDetailsService</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyUserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;<br>        <span class="hljs-keyword">return</span>  userMapper.findByUsername(username);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-5-使用角色控制方法的访问权限"><a href="#2-5-使用角色控制方法的访问权限" class="headerlink" title="2.5 使用角色控制方法的访问权限"></a>2.5 使用角色控制方法的访问权限</h2><ol><li>当ADMIN角色的用户访问&#x2F;roleAuth时，正常访问。当其他角色用户，访问&#x2F;roleAuth时，返回403</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RoleVoter 里定义了角色名，使用的时候，都必须使用ROLE_作为前缀</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_ADMIN&#x27;)&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/roleAuth&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">role</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;admin Auth!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>当前登录的用户，有ADMIN或者MANAGER的角色</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_ADMIN&#x27;) or hasRole(&#x27;ROLE_MANAGER&#x27;)&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/roleAuth2&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">role2</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;admin Auth  222!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>传过来的id小于10 且 传过来的userName和数据库查出来的username相等</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(&quot;#id&lt; 10 and principal.username.equals(#username)&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/roleAuth3&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">role3</span><span class="hljs-params">(Integer id, String username)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;admin Auth  33!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码地址：</p><p><a href="https://github.com/pyr9/springboot-security-demo">https://github.com/pyr9/springboot-security-demo</a></p>]]></content>
    
    
    <categories>
      
      <category>权限管理</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringSecurity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——网关</title>
    <link href="/%E7%BD%91%E5%85%B3/"/>
    <url>/%E7%BD%91%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<blockquote><p> 网关用来控制流程的流向</p></blockquote><h1 id="1-排他网关ExclusiveGateway"><a href="#1-排他网关ExclusiveGateway" class="headerlink" title="1. 排他网关ExclusiveGateway"></a>1. 排他网关ExclusiveGateway</h1><h2 id="1-1-概念"><a href="#1-1-概念" class="headerlink" title="1.1 概念"></a>1.1 概念</h2><p>排他网关，用来在流程中实现决策。 当流程执行到这个网关，所有分支都会判断条件是否为true，如果为true则执行该分支，排他网关只会选择一个为true的分支执行。如果有两个分支条件都为true，排他网关会选择id值较小的一条分支去执行。</p><p><strong>为什么要用排他网关？</strong></p><p>不用排他网关也可以实现分支，如：在连线的condition条件上设置分支条件。</p><p>在连线设置condition条件的缺点：如果条件都不满足，流程就结束了(是异常结束)。如果从网关出去的线所有条件都不满足则系统抛出异常。</p><h2 id="1-2-案例"><a href="#1-2-案例" class="headerlink" title="1.2 案例"></a>1.2 案例</h2><p>出差申请大于等于3天需要先由总经理审批再由财务审批，小于3天直接由财务审批。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230213225917585.png" alt="image-20230213225917585"></p><p>测试：</p><p>当部门经理审批后，当出差天数为5时，会根据条件判断，当前需要走【总经理审批】，当前任务表：SELECT * FROM act_ru_task   </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230213232953567.png" alt="image-20230213232953567"></p><p>上图中：只有总经理审批是当前的任务在执行。</p><h1 id="2-并行网关ParallelGateway"><a href="#2-并行网关ParallelGateway" class="headerlink" title="2. 并行网关ParallelGateway"></a>2. 并行网关ParallelGateway</h1><h2 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h2><ul><li><p>并行网关允许将流程分成多条分支，也可以把多条分支汇聚到一起。</p></li><li><p>并行网关的功能是基于进入和外出顺序流的：</p><ul><li><p>分支：并行后的所有外出顺序流，为每个顺序流都创建一个并发分支。</p></li><li><p>join汇聚： 所有到达并行网关，在此等待的进入分支， 直到所有进入顺序流的分支都到达以后， 流程就会通过汇聚网关。</p></li></ul></li></ul><p>注意，如果同一个并行网关有多个进入和多个外出顺序流， 它就同时具有分支和汇聚功能。 这时，网关会先汇聚所有进入的顺序流，然后再切分成多个并行分支。</p><p><strong>与其他网关的主要区别是，并行网关不会解析条件。</strong> <strong>即使顺序流中定义了条件，也会被忽略。</strong></p><h2 id="2-2-案例"><a href="#2-2-案例" class="headerlink" title="2.2 案例"></a>2.2 案例</h2><p>出差申请由部门经理审批后，需要同时由总经理审批和财务审批，才可以结束。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230213230034272.png" alt="image-20230213230034272"></p><p>测试：</p><p>当部门经理审批后，当前需要走【财务审批+总经理审批】，当前任务表：SELECT * FROM act_ru_task   </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230213231916621.png" alt="image-20230213231916621"></p><p>上图中：财务审批、总经理审批 都是当前的任务，在并行执行。</p><h1 id="3-包含网关InclusiveGateway"><a href="#3-包含网关InclusiveGateway" class="headerlink" title="3.包含网关InclusiveGateway"></a>3.包含网关InclusiveGateway</h1><h2 id="3-1-概念"><a href="#3-1-概念" class="headerlink" title="3.1 概念"></a>3.1 概念</h2><ul><li><p>包含网关可以看做是排他网关和并行网关的结合体。 </p></li><li><p>和排他网关一样，你可以在外出顺序流上定义条件，包含网关会解析它们。 但是主要的区别是包含网关可以选择多于一条顺序流，这和并行网关一样。</p></li><li><p>包含网关的功能是基于进入和外出顺序流的：</p><ul><li>分支：所有外出顺序流的条件都会被解析，结果为true的顺序流会以并行方式继续执行， 会为每个顺序流创建一个分支。</li><li>汇聚：所有并行分支到达包含网关，会进入等待状态， 直到每个包含流程token的进入顺序流的分支都到达。 这是与并行网关的最大不同。换句话说，包含网关只会等待被选中执行了的进入顺序流。 在汇聚之后，流程会穿过包含网关继续执行。</li></ul></li></ul><h2 id="3-2-案例"><a href="#3-2-案例" class="headerlink" title="3.2 案例"></a>3.2 案例</h2><p>出差申请大于等于3天需要由总经理审批，小于3天由财务审批，出差申请必须经过部门经理审批。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230213225657718.png" alt="image-20230213225657718"></p><p>测试：</p><p>当出差天数为2时，会根据条件判断，当前需要走【财务审批+部门经理审批】，当前任务表：SELECT * FROM act_ru_task   </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230213231023874.png" alt="image-20230213231023874"></p><p>上图中：财务审批、部门经理审批 都是当前的任务，在并行执行。</p>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——组任务</title>
    <link href="/%E7%BB%84%E4%BB%BB%E5%8A%A1/"/>
    <url>/%E7%BB%84%E4%BB%BB%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<p>在流程定义中在任务结点的 assignee 固定设置任务负责人，在流程定义时将参与者固定设置在.bpmn 文件中，如果临时任务负责人变更则需要修改流程定义，系统可扩展性差。</p><p>针对这种情况可以给任务设置多个候选人，可以从候选人中选择参与者来完成任务。 </p><h1 id="1-设置任务候选人"><a href="#1-设置任务候选人" class="headerlink" title="1. 设置任务候选人"></a>1. 设置任务候选人</h1><p>在流程图中任务节点的配置中设置 candidate-users(候选人)，多个候选人之间用逗号分开。</p>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——分配任务负责人</title>
    <link href="/Activiti%E2%80%94%E2%80%94%E5%88%86%E9%85%8D%E4%BB%BB%E5%8A%A1%E8%B4%9F%E8%B4%A3%E4%BA%BA/"/>
    <url>/Activiti%E2%80%94%E2%80%94%E5%88%86%E9%85%8D%E4%BB%BB%E5%8A%A1%E8%B4%9F%E8%B4%A3%E4%BA%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="1-固定分配"><a href="#1-固定分配" class="headerlink" title="1 固定分配"></a>1 固定分配</h1><p>在进行业务流程建模时指定固定的任务负责人， 如图：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230210163130769.png" alt="image-20230210163130769"></p><h1 id="2-表达式分配"><a href="#2-表达式分配" class="headerlink" title="2 表达式分配"></a>2 表达式分配</h1><p>Activiti 使用 UEL 表达式， UEL 是 java EE6 规范的一部分， UEL（Unified Expression Language）即 统一表达式语言， activiti 支持两个 UEL 表达式： UEL-value 和 UEL-method。 </p><h2 id="2-1-UEL-value"><a href="#2-1-UEL-value" class="headerlink" title="2.1  UEL-value"></a>2.1  UEL-value</h2><ul><li>assignee 这个变量是 activiti 的一个流程变量，</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230210163518444.png" alt="image-20230210163518444"></p><ul><li>user 也是 activiti 的一个流程变量， user.name 表示通过调用 user 的 getter 方法获取值</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230210163909807.png" alt="image-20230210163909807"></p><h2 id="2-2-UEL-method"><a href="#2-2-UEL-method" class="headerlink" title="2.2  UEL-method"></a>2.2  UEL-method</h2><p>userBean 是 spring 容器中的一个 bean，表示调用该 bean 的 getUserId()方法。 </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230210164303115.png" alt="image-20230210164303115"></p><h2 id="2-3-其他"><a href="#2-3-其他" class="headerlink" title="2.3 其他"></a>2.3 其他</h2><p>表达式支持解析基础类型、 bean、 list、 array 和 map，也可作为条件判断。如下：<br>${order.price &gt; 100 &amp;&amp; order.price &lt; 250} </p><h1 id="3-监听器分配"><a href="#3-监听器分配" class="headerlink" title="3 监听器分配"></a>3 监听器分配</h1><p>可以使用监听器来完成很多Activiti流程的业务。</p><p>任务监听器是发生对应的任务相关事件时执行自定义 java 逻辑 或表达式。</p><p>任务相当事件包括：  </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/1577506842889.png" alt="1577506842889"></p>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——流程定义操作</title>
    <link href="/%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E6%93%8D%E4%BD%9C/"/>
    <url>/%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="1-流程定义信息查询"><a href="#1-流程定义信息查询" class="headerlink" title="1 流程定义信息查询"></a>1 流程定义信息查询</h1><p>查询流程相关信息，包含流程定义，流程部署，流程定义版本    -&gt; ACT_RE_PROCDEF</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryProcessDefinition</span><span class="hljs-params">()</span></span>&#123;<br>       ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>       RepositoryService repositoryService = processEngine.getRepositoryService();<br>       ProcessDefinitionQuery processDefinitionQuery = repositoryService.createProcessDefinitionQuery();<br>       List&lt;ProcessDefinition&gt; definitionList = processDefinitionQuery.processDefinitionKey(<span class="hljs-string">&quot;myProcess&quot;</span>)<br>               .orderByProcessDefinitionVersion()<br>               .desc()<br>               .list();<br>       <span class="hljs-keyword">for</span> (ProcessDefinition processDefinition : definitionList) &#123;<br>           System.out.println(<span class="hljs-string">&quot;流程定义 id=&quot;</span>+processDefinition.getId());<br>           System.out.println(<span class="hljs-string">&quot;流程定义 name=&quot;</span>+processDefinition.getName());<br>           System.out.println(<span class="hljs-string">&quot;流程定义 key=&quot;</span>+processDefinition.getKey());<br>           System.out.println(<span class="hljs-string">&quot;流程定义 Version=&quot;</span>+processDefinition.getVersion());<br>           System.out.println(<span class="hljs-string">&quot;流程部署ID =&quot;</span>+processDefinition.getDeploymentId());<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h1 id="2-流程定义删除"><a href="#2-流程定义删除" class="headerlink" title="2. 流程定义删除"></a>2. 流程定义删除</h1><p>说明：</p><ol><li><pre><code class="hljs">  使用repositoryService删除流程定义，历史表信息不会被删除</code></pre></li><li><pre><code class="hljs">  如果该流程定义下没有正在运行的流程，则可以用普通删除。</code></pre></li></ol><p>如果该流程定义下存在已经运行的流程，使用普通删除报错，可用级联删除方法将流程及相关记录全部删除。</p><p>先删除没有完成流程节点，最后就可以完全删除流程定义信息</p><p>项目开发中级联删除操作一般只开放给超级管理员使用.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteDeployment</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// 流程部署id</span><br>    String deploymentId = <span class="hljs-string">&quot;1&quot;</span>;<br><br>    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>    <span class="hljs-comment">// 通过流程引擎获取repositoryService</span><br>    RepositoryService repositoryService = processEngine<br>            .getRepositoryService();<br>    <span class="hljs-comment">//删除流程定义，如果该流程定义已有流程实例启动则删除时出错</span><br>    <span class="hljs-comment">//repositoryService.deleteDeployment(deploymentId);</span><br>    <span class="hljs-comment">//设置true 级联删除流程定义，即使该流程有流程实例启动也可以删除，设置为false非级别删除方式，如果流程</span><br>    repositoryService.deleteDeployment(deploymentId, <span class="hljs-keyword">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——流程实例</title>
    <link href="/%E6%B5%81%E7%A8%8B%E5%AE%9E%E4%BE%8B%E6%93%8D%E4%BD%9C/"/>
    <url>/%E6%B5%81%E7%A8%8B%E5%AE%9E%E4%BE%8B%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h2 id="1-概念"><a href="#1-概念" class="headerlink" title="1. 概念"></a>1. 概念</h2><p><strong>流程实例</strong>（ProcessInstance）代表流程定义的执行实例。例如：用户或程序按照流程定义内容发起一个流程，这就是一个流程实例。</p><p>流程定义和流程实例的图解：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230209223705740.png" alt="image-20230209223705740"></p><h2 id="2-启动流程实例-并添加Businesskey"><a href="#2-启动流程实例-并添加Businesskey" class="headerlink" title="2. 启动流程实例 并添加Businesskey"></a>2. 启动流程实例 并添加Businesskey</h2><ul><li>Businesskey：业务标识，通常为业务表的主键，业务标识和流程实例一一对应。业务标识来源于业务系统。存储业务标识就是根据业务标识来关联查询业务系统的数据。</li><li>启动流程实例时，指定的businesskey，就会在act_ru_execution #流程实例的执行表中存储businesskey。</li><li>比如：出差流程启动一个流程实例，就可以将出差单的id作为业务标识存储到activiti中，将来查询activiti的流程实例信息就可以获取出差单的id从而关联查询业务系统数据库得到出差单信息。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 启动流程实例，添加businessKey</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addBusinessKey</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-comment">//        1、得到ProcessEngine</span><br>        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br><span class="hljs-comment">//        2、得到RunTimeService</span><br>        RuntimeService runtimeService = processEngine.getRuntimeService();<br><span class="hljs-comment">//        3、启动流程实例，同时还要指定业务标识businessKey，也就是出差申请单id，这里是1001</span><br>        ProcessInstance processInstance = runtimeService.<br>                startProcessInstanceByKey(<span class="hljs-string">&quot;myProcess&quot;</span>,<span class="hljs-string">&quot;0001&quot;</span>);<br><span class="hljs-comment">//        4、输出processInstance相关属性</span><br>        System.out.println(<span class="hljs-string">&quot;业务id==&quot;</span>+processInstance.getBusinessKey());<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="3-挂起、激活流程实例"><a href="#3-挂起、激活流程实例" class="headerlink" title="3. 挂起、激活流程实例"></a>3. 挂起、激活流程实例</h2><p>某些情况可能由于流程变更需要将当前运行的流程暂停而不是直接删除，流程暂停后将不会继续执行。</p><h3 id="3-1-全部流程实例挂起"><a href="#3-1-全部流程实例挂起" class="headerlink" title="3.1 全部流程实例挂起"></a>3.1 全部流程实例挂起</h3><p>流程定义为挂起状态时：</p><ol><li>该流程定义将不允许启动新的流程实例，</li><li>该流程定义下所有的流程实例将全部挂起暂停执行。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SuspendAllProcessInstance</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-comment">//        获取processEngine</span><br>        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br><span class="hljs-comment">//        获取repositoryService</span><br>        RepositoryService repositoryService = processEngine.getRepositoryService();<br><span class="hljs-comment">//        查询流程定义的对象</span><br>        ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().<br>                processDefinitionKey(<span class="hljs-string">&quot;myProcess&quot;</span>).<br>                singleResult();<br><span class="hljs-comment">//        得到当前流程定义的实例是否都为暂停状态</span><br>        <span class="hljs-keyword">boolean</span> suspended = processDefinition.isSuspended();<br><span class="hljs-comment">//        流程定义id</span><br>        String processDefinitionId = processDefinition.getId();<br><span class="hljs-comment">//        判断是否为暂停</span><br>        <span class="hljs-keyword">if</span>(suspended)&#123;<br><span class="hljs-comment">//         如果是暂停，可以执行激活操作 ,参数1 ：流程定义id ，参数2：是否激活，参数3：激活时间</span><br>            repositoryService.activateProcessDefinitionById(processDefinitionId,<br>                    <span class="hljs-keyword">true</span>,<br>                    <span class="hljs-keyword">null</span><br>            );<br>            System.out.println(<span class="hljs-string">&quot;流程定义：&quot;</span>+processDefinitionId+<span class="hljs-string">&quot;,已激活&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-comment">//          如果是激活状态，可以暂停，参数1 ：流程定义id ，参数2：是否暂停，参数3：暂停时间</span><br>            repositoryService.suspendProcessDefinitionById(processDefinitionId,<br>                    <span class="hljs-keyword">true</span>,<br>                    <span class="hljs-keyword">null</span>);<br>            System.out.println(<span class="hljs-string">&quot;流程定义：&quot;</span>+processDefinitionId+<span class="hljs-string">&quot;,已挂起&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-单个流程实例挂起"><a href="#3-2-单个流程实例挂起" class="headerlink" title="3.2 单个流程实例挂起"></a>3.2 单个流程实例挂起</h3><p>单个流程实例挂起，则此流程不再继续执行，完成该流程实例的当前任务将报异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SuspendSingleProcessInstance</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-comment">//        获取processEngine</span><br>        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br><span class="hljs-comment">//        RuntimeService</span><br>        RuntimeService runtimeService = processEngine.getRuntimeService();<br><span class="hljs-comment">//        查询流程定义的对象</span><br>        ProcessInstance processInstance = runtimeService.<br>                createProcessInstanceQuery().<br>                processInstanceId(<span class="hljs-string">&quot;15001&quot;</span>).<br>                singleResult();<br><span class="hljs-comment">//        得到当前流程定义的实例是否都为暂停状态</span><br>        <span class="hljs-keyword">boolean</span> suspended = processInstance.isSuspended();<br><span class="hljs-comment">//        流程定义id</span><br>        String processDefinitionId = processInstance.getId();<br><span class="hljs-comment">//        判断是否为暂停</span><br>        <span class="hljs-keyword">if</span>(suspended)&#123;<br><span class="hljs-comment">//         如果是暂停，可以执行激活操作 ,参数：流程定义id</span><br>            runtimeService.activateProcessInstanceById(processDefinitionId);<br>            System.out.println(<span class="hljs-string">&quot;流程定义：&quot;</span>+processDefinitionId+<span class="hljs-string">&quot;,已激活&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-comment">//          如果是激活状态，可以暂停，参数：流程定义id</span><br>            runtimeService.suspendProcessInstanceById( processDefinitionId);<br>            System.out.println(<span class="hljs-string">&quot;流程定义：&quot;</span>+processDefinitionId+<span class="hljs-string">&quot;,已挂起&quot;</span>);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>SSH免密登录</title>
    <link href="/SSH%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/"/>
    <url>/SSH%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h1 id="1-客户端生成公私钥"><a href="#1-客户端生成公私钥" class="headerlink" title="1. 客户端生成公私钥"></a>1. 客户端生成公私钥</h1><ol><li><p>执行<code>ssh-keygen</code>在用户目录.ssh文件夹下创建公私钥:</p><ul><li><p>id_rsa （私钥）</p></li><li><p>id_rsa.pub (公钥)</p></li></ul></li></ol><h1 id="2-上传公钥到服务器"><a href="#2-上传公钥到服务器" class="headerlink" title="2. 上传公钥到服务器"></a>2. 上传公钥到服务器</h1><ol><li><p>进入服务端.ssh目录下 <code>cd ~/.ssh</code></p></li><li><p>将客户端生成的id_rsa.pub 复制到 authorized_keys 里 <code>vim authorized_keys</code></p></li></ol><h1 id="3-测试免密登录"><a href="#3-测试免密登录" class="headerlink" title="3. 测试免密登录"></a>3. 测试免密登录</h1><p><code>ssh root@localhost</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——数据表介绍</title>
    <link href="/Activiti%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%BB%8B%E7%BB%8D/"/>
    <url>/Activiti%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<p>Activiti 的表都以   ACT_   开头。 第二部分是表示表的用途的两个字母标识。 用途也和服务的 API 对应</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230202215607751.png" alt="image-20230202215607751"></p><h3 id="表的命名规则和作用"><a href="#表的命名规则和作用" class="headerlink" title="表的命名规则和作用"></a>表的命名规则和作用</h3><ul><li><strong>ACT_RE</strong> ：’RE’表示 repository。 这个前缀的表包含了流程定义和流程静态资源 （图片，规则，等等）。</li><li><strong>ACT_RU</strong>：’RU’表示 runtime。 这些运行时的表，包含流程实例，任务，变量，异步任务，等运行中的数据。 Activiti 只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。 这样运行时表可以一直很小速度很快。</li><li><strong>ACT_HI</strong>：’HI’表示 history。 这些表包含历史数据，比如历史流程实例， 变量，任务等等。</li><li><strong>ACT_GE</strong> ： GE 表示 general。 通用数据， 用于不同场景下</li></ul><table><thead><tr><th><strong>表分类</strong></th><th><strong>表名</strong></th><th><strong>解释</strong></th></tr></thead><tbody><tr><td>一般数据</td><td></td><td></td></tr><tr><td></td><td>[ACT_GE_BYTEARRAY]</td><td>通用的流程定义和流程资源</td></tr><tr><td></td><td>[ACT_GE_PROPERTY]</td><td>系统相关属性</td></tr><tr><td>流程历史记录</td><td></td><td></td></tr><tr><td></td><td>[ACT_HI_ACTINST]</td><td>历史的流程实例</td></tr><tr><td></td><td>[ACT_HI_ATTACHMENT]</td><td>历史的流程附件</td></tr><tr><td></td><td>[ACT_HI_COMMENT]</td><td>历史的说明性信息</td></tr><tr><td></td><td>[ACT_HI_DETAIL]</td><td>历史的流程运行中的细节信息</td></tr><tr><td></td><td>[ACT_HI_IDENTITYLINK]</td><td>历史的流程运行过程中用户关系</td></tr><tr><td></td><td>[ACT_HI_PROCINST]</td><td>历史的流程实例</td></tr><tr><td></td><td>[ACT_HI_TASKINST]</td><td>历史的任务实例</td></tr><tr><td></td><td>[ACT_HI_VARINST]</td><td>历史的流程运行中的变量信息</td></tr><tr><td>流程定义表</td><td></td><td></td></tr><tr><td></td><td>[ACT_RE_DEPLOYMENT]</td><td>部署单元信息</td></tr><tr><td></td><td>[ACT_RE_MODEL]</td><td>模型信息</td></tr><tr><td></td><td>[ACT_RE_PROCDEF]</td><td>已部署的流程定义 -&gt; 同一个流程，部署一次增加一条记录</td></tr><tr><td>运行实例表</td><td></td><td></td></tr><tr><td></td><td>[ACT_RU_EVENT_SUBSCR]</td><td>运行时事件</td></tr><tr><td></td><td>[ACT_RU_EXECUTION]</td><td>运行时流程执行实例</td></tr><tr><td></td><td>[ACT_RU_IDENTITYLINK]</td><td>运行时用户关系信息，存储任务节点与参与者的相关信息</td></tr><tr><td></td><td>[ACT_RU_JOB]</td><td>运行时作业</td></tr><tr><td></td><td>[ACT_RU_TASK]</td><td>运行时任务</td></tr><tr><td></td><td>[ACT_RU_VARIABLE]</td><td>运行时变量表</td></tr></tbody></table><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207214202834.png" alt="image-20230207214202834"></p><p>下面的数据是：一个流程，部署后，开启了两个assginee不同的流程实例：</p><ul><li>act_re_deployment：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221224629.png" alt="image-20230207221224629"></p><ul><li>act_re_procdef：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221402715.png" alt="image-20230207221402715"></p><ul><li>act_hi_procinst：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221437355.png" alt="image-20230207221437355"></p><ul><li>act_hi_actinst：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221609189.png" alt="image-20230207221609189"></p><ul><li>act_hi_taskinst：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221658209.png" alt="image-20230207221658209"></p><ul><li>act_hi_varinst：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221801474.png" alt="image-20230207221801474"></p><ul><li>act_hi_identitylink：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221833964.png" alt="image-20230207221833964"></p><ul><li>act_ru_task：</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230207221951039.png" alt="image-20230207221951039"></p>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti——基本操作</title>
    <link href="/activiti%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"/>
    <url>/activiti%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="1-流程定义"><a href="#1-流程定义" class="headerlink" title="1 流程定义"></a>1 流程定义</h1><ul><li><p>使用activiti流程建模工具(activity-designer)定义业务流程(.bpmn文件) 。</p></li><li><p>.bpmn文件就是业务流程定义文件，通过xml定义业务流程。</p></li><li><p>使用idea插件设置流程图， 设置流程中需要的节点，节点负责人。具体步骤参考：</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128164658.png"></p><h1 id="2-流程定义部署"><a href="#2-流程定义部署" class="headerlink" title="2 流程定义部署"></a>2 流程定义部署</h1><ul><li>activiti部署业务流程定义（.bpmn文件）。即：将流程图的内容存储到数据库</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr;<br><br><span class="hljs-keyword">import</span> org.activiti.engine.ProcessEngine;<br><span class="hljs-keyword">import</span> org.activiti.engine.ProcessEngines;<br><span class="hljs-keyword">import</span> org.activiti.engine.RepositoryService;<br><span class="hljs-keyword">import</span> org.activiti.engine.repository.Deployment;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActivitiDemo</span> </span>&#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDeployment</span><span class="hljs-params">()</span></span>&#123;<br>      <span class="hljs-comment">// 1. 创建ProcessEngine</span><br>        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>      <span class="hljs-comment">// 2. 获取RepositoryService</span><br>        RepositoryService repositoryService = processEngine.getRepositoryService();<br>      <span class="hljs-comment">// 3. 使用service进行流程的部署，定义流程名字，把bpmn部署到数据库中</span><br>        Deployment deploy = repositoryService.createDeployment()<br>                .name(<span class="hljs-string">&quot;话费报销&quot;</span>)<br>                .addClasspathResource(<span class="hljs-string">&quot;bpmn/phoneExpense.bpmn20.xml&quot;</span>)<br>                .deploy();<br>      <span class="hljs-comment">// 4. 输出部署信息</span><br>        System.out.println(<span class="hljs-string">&quot;流程部署id=&quot;</span>+deploy.getId());<br>        System.out.println(<span class="hljs-string">&quot;流程部署名字=&quot;</span>+deploy.getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128210614102.png" alt="image-20230128210614102"></p><p>流程定义部署后操作activiti的3张表如下：</p><ul><li><p>act_re_deployment 流程定义部署表，每部署一次增加一条记录</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128204308.png"></p></li><li><p>act_re_procdef 流程定义表，部署每个新的流程定义都会在这张表中增加一条记录。比如章三的话费报销是一条记录，李四的话费报销是一条记录。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128204451742.png" alt="image-20230128204451742"> <img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128204449359.png" alt="image-20230128204449359"></p></li><li><p>act_ge_bytearray 流程资源表</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128204546011.png" alt="image-20230128204546011"></p></li></ul><h1 id="3-启动流程实例"><a href="#3-启动流程实例" class="headerlink" title="3 启动流程实例"></a>3 启动流程实例</h1><p>启动一个流程实例表示开始一次业务流程的运行。</p><p>在员工请假流程定义部署完成后，如果张三要请假就可以启动一个流程实例，如果李四要请假也启动一个流程实例，两个流程的执行互相不影响。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStartProcess</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">// 1. 创建ProcessEngine</span><br>    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>    <span class="hljs-comment">// 2. 获取RuntimeService</span><br>    RuntimeService runtimeService = processEngine.getRuntimeService();<br>    <span class="hljs-comment">// 3. 根据流程ID启动流程</span><br>    ProcessInstance instance = runtimeService.startProcessInstanceByKey(<span class="hljs-string">&quot;myProcess&quot;</span>);<br>    <span class="hljs-comment">// 4. 输出</span><br>    System.out.println(<span class="hljs-string">&quot;流程定义id=&quot;</span>+instance.getProcessDefinitionId());<br>    System.out.println(<span class="hljs-string">&quot;流程实例id=&quot;</span>+instance.getId());<br>    System.out.println(<span class="hljs-string">&quot;当前活动的id=&quot;</span>+instance.getActivityId());<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128210529180.png" alt="image-20230128210529180"></p><p> 操作activiti的表如下：</p><p>​     act_hi_actinst 流程实例执行历史</p><p>​act_hi_identitylink 流程的参与用户历史信息</p><p>​act_hi_procinst 流程实例历史信息</p><p>​act_hi_taskinst 已经完成的任务信息</p><p>​act_ru_execution 流程执行信息</p><p>​act_ru_identitylink 流程的参与用户信息</p><p>​act_ru_task 当前代办的任务信息</p><h1 id="4-用户查询待办任务-Task"><a href="#4-用户查询待办任务-Task" class="headerlink" title="4 用户查询待办任务(Task)"></a>4 用户查询待办任务(Task)</h1><ul><li>因为现在系统的业务流程已经交给activiti管理，通过activiti就可以查询当前流程执行到哪了，当前用户需要办理什么任务了，这些activiti帮我们管理了，而不需要开发人员自己编写在sql语句查询。</li></ul><p>查询自己所能处理的任务 </p><pre><code class="hljs">   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindPersonalTasks</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">// 1. 创建ProcessEngine</span><br>    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>    <span class="hljs-comment">// 2. 获取taskService</span><br>    TaskService taskService = processEngine.getTaskService();<br>    <span class="hljs-comment">// 3. 根据流程key和任务负责人 查询任务</span><br>    List&lt;Task&gt; tasks = taskService.createTaskQuery()<br>            .processDefinitionKey(<span class="hljs-string">&quot;myProcess&quot;</span>)<br>            .taskAssignee(<span class="hljs-string">&quot;张三&quot;</span>)<br>            .list();<br>    <span class="hljs-comment">// 4. 输出</span><br>    tasks.forEach(task -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;流程实例id=&quot;</span>+task.getProcessInstanceId());<br>        System.out.println(<span class="hljs-string">&quot;任务id=&quot;</span>+task.getId());<br>        System.out.println(<span class="hljs-string">&quot;任务负责人=&quot;</span>+task.getAssignee());<br>        System.out.println(<span class="hljs-string">&quot;任务名称=&quot;</span>+task.getName());<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure></code></pre><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128210841640.png" alt="image-20230128210841640"></p><h1 id="5-用户处理任务"><a href="#5-用户处理任务" class="headerlink" title="5 用户处理任务"></a>5 用户处理任务</h1><p>用户查询待办任务后，就可以办理某个任务，如果这个任务办理完成还需要其它用户办理，比如采购单创建后由部门经理审核，这个过程也是由activiti帮我们完成了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompleteTask</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">// 1. 创建ProcessEngine</span><br>    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>    <span class="hljs-comment">// 2. 获取taskService</span><br>    TaskService taskService = processEngine.getTaskService();<br>    <span class="hljs-comment">// 3. 根据任务id完成任务</span><br>    taskService.complete(<span class="hljs-string">&quot;2505&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>操作activiti的表如下：</p><p>act_hi_taskinst:  已经完成的历史任务信息 -&gt; 插入新数据; 更新完成任务的结束时间</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128213152660.png" alt="image-20230128213152660"></p><p>act_ru_task：当前代办的任务信息 -&gt; 删除旧数据，插入新数据</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128213015838.png" alt="image-20230128213015838"></p><p>​       act_hi_identitylink: 流程的参与用户历史信息  -&gt; 插入新数据</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128213626199.png" alt="image-20230128213626199"></p><p>​  </p><p><strong>更加灵活的完成个人任务：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompleteTask2</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">// 1. 创建ProcessEngine</span><br>    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>    <span class="hljs-comment">// 2. 获取taskService</span><br>    TaskService taskService = processEngine.getTaskService();<br>    <span class="hljs-comment">// 3. 如果可以确定是一个任务，可以直接通过singleResult获得，依次修改taskAssignee为直线经理，部门经理，财务人员</span><br>    Task task = taskService.createTaskQuery()<br>            .processDefinitionKey(<span class="hljs-string">&quot;myProcess&quot;</span>)<br>            .taskAssignee(<span class="hljs-string">&quot;财务人员&quot;</span>)<br>            .singleResult();<br>    <span class="hljs-comment">// 3. 根据任务id完成任务</span><br>    taskService.complete(task.getId());<br>    System.out.println(<span class="hljs-string">&quot;DONE!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>此时查看act_ru_task表，已经没有数据了，因为任务执行完了</p><p>查看act_hi_actinst，可以看到END_TIME都已经填充上了</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128231354324.png" alt="image-20230128231354324"></p><h1 id="6-流程结束"><a href="#6-流程结束" class="headerlink" title="6 流程结束"></a>6 流程结束</h1><p>当任务办理完成没有下一个任务结点了，这个流程实例就完成了。</p><h1 id="7-流程历史信息的查看"><a href="#7-流程历史信息的查看" class="headerlink" title="7. 流程历史信息的查看"></a>7. 流程历史信息的查看</h1><p>即使流程定义已经删除了，流程执行的历史信息通过前面的分析，依然保存在activiti的act_hi_*相关的表中。所以我们还是可以查询流程执行的历史信息，可以通过HistoryService来查看相关的历史记录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">findHistoryInfo</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-comment">//      获取引擎</span><br>        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br><span class="hljs-comment">//        获取HistoryService</span><br>        HistoryService historyService = processEngine.getHistoryService();<br><span class="hljs-comment">//        获取 actinst表的查询对象</span><br>        HistoricActivityInstanceQuery instanceQuery = historyService.createHistoricActivityInstanceQuery();<br><span class="hljs-comment">//        查询 actinst表，条件：根据 InstanceId 查询</span><br><span class="hljs-comment">//        instanceQuery.processInstanceId(&quot;2501&quot;);</span><br><span class="hljs-comment">//        查询 actinst表，条件：根据 DefinitionId 查询</span><br>        instanceQuery.processDefinitionId(<span class="hljs-string">&quot;process-variable:3:c8b43296-a886-11ed-90d9-9ec8af959357&quot;</span>);<br><span class="hljs-comment">//        增加排序操作,orderByHistoricActivityInstanceStartTime 根据开始时间排序 asc 升序</span><br>        instanceQuery.orderByHistoricActivityInstanceStartTime().asc();<br><span class="hljs-comment">//        查询所有内容</span><br>        List&lt;HistoricActivityInstance&gt; activityInstanceList = instanceQuery.list();<br><span class="hljs-comment">//        输出</span><br>        <span class="hljs-keyword">for</span> (HistoricActivityInstance hi : activityInstanceList) &#123;<br>            System.out.println(hi.getActivityId());<br>            System.out.println(hi.getActivityName());<br>            System.out.println(hi.getProcessDefinitionId());<br>            System.out.println(hi.getProcessInstanceId());<br>            System.out.println(<span class="hljs-string">&quot;&lt;==========================&gt;&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230209233245014.png" alt="image-20230209233245014"></p><h1 id="8-实战使用"><a href="#8-实战使用" class="headerlink" title="8 实战使用"></a>8 实战使用</h1><p><strong>准备工作：</strong></p><ol><li><p>定义BPMN文件</p></li><li><p>myActProcessDefinitionRegister注册entity对应的工作流信息：entityName, definitionKey，name</p></li><li><p>EmActProcessStatus: entity上存储的taskDefinitionKey，可在这张表查询到对应的中文翻译</p><ul><li><p>processRegisterId</p></li><li><p>taskDefinitionKey</p></li><li><p>name</p></li></ul></li><li><p>entity上冗余了工作流字段：</p><ul><li><p>task1Assignee，taskAssignee2:   任务受理人，根据bpmn文件定义的task数量定义，每个task对应一个受理人</p></li><li><p>currentTaskDefinitionKey:  当前记录的流程状态，即task的标识</p></li></ul></li></ol><p><strong>流程：</strong></p><ol><li>新增entity，afterSaveTrigger发送mq启动流程实例 <ul><li>definitionKey: 根据entityName查询emActProcessDefinitionRegister</li><li>businessKey: entityId</li><li>variables： entity复写自己的</li></ul></li><li>查看认领任务：根据前端传过来的loginName, processDefinitionKeyList查看任务列表</li><li>候选人认领任务（如果有callBack,调用callback）: taskService.claim(task.getId(), claimTaskForm.getUserLoginName());</li><li>查看待办任务：根据前端传过来的loginName, processDefinitionKeyList查看任务列表</li><li>完成任务：completeTask</li><li>执行完成任务回调completeFeedback， 比如：当前流程的填充审批完成时间</li></ol>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Activiti BPMN visualizer 的安装和使用</title>
    <link href="/Activiti-BPMN-visualizer-%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
    <url>/Activiti-BPMN-visualizer-%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-安装"><a href="#1-安装" class="headerlink" title="1 安装"></a>1 安装</h1><p>插件里搜索Activiti BPMN visualizer安装</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128163406.png"></p><h1 id="2-画一个流程图"><a href="#2-画一个流程图" class="headerlink" title="2 画一个流程图"></a>2 画一个流程图</h1><h2 id="1-右键生成一个bpmn20-xml文件"><a href="#1-右键生成一个bpmn20-xml文件" class="headerlink" title="1. 右键生成一个bpmn20.xml文件"></a>1. 右键生成一个bpmn20.xml文件</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128163554.png"></p><h2 id="2-在文件的任意位置点击右键：view-bpmn-Activiti-Diagram"><a href="#2-在文件的任意位置点击右键：view-bpmn-Activiti-Diagram" class="headerlink" title="2. 在文件的任意位置点击右键：view bpmn(Activiti)Diagram"></a>2. 在文件的任意位置点击右键：view bpmn(Activiti)Diagram</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301281638479.png"></p><h2 id="3-打开可视化编辑器，"><a href="#3-打开可视化编辑器，" class="headerlink" title="3. 打开可视化编辑器，"></a>3. 打开可视化编辑器，</h2><ol><li>右键start events –&gt;start event画一个开始事件。</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128163950.png"></p><ol start="2"><li><p>用户任务</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128164045.png"></p></li><li><p>添加结束</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128164125.png"></p></li><li><p>连线</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128164453.png"></p></li><li><p>查看更新后的xml文件</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128164612.png"></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>jenkins集成部署环境构建</title>
    <link href="/jenkins%E9%9B%86%E6%88%90%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA/"/>
    <url>/jenkins%E9%9B%86%E6%88%90%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<p>更新机制是指项目如何进行更新，主要有两种方式：一种是自动推送，另外一种是手动拉取。前者用于开发环境、后者可以用于所有环境</p><h1 id="1-手动拉取"><a href="#1-手动拉取" class="headerlink" title="1. 手动拉取"></a>1. 手动拉取</h1><p>拉取更新流程：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230126125309.png" style="zoom:40%;" /><ol><li>sudo -i 输入密码，进入root目录</li><li>上述流程由 deploy.sh 脚本实现：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash -e</span><br><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;`dirname <span class="hljs-variable">$0</span>`&quot;</span><br>. ./pom.sh<br><br><span class="hljs-comment">#1. download war, ready env</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deploy time: <span class="hljs-variable">$work_time</span>&quot;</span><br>mkdir -p war/<br>war=war/<span class="hljs-variable">$pom_a</span>-<span class="hljs-variable">$pom_v</span>.war<br>download_path=<span class="hljs-string">&quot;<span class="hljs-variable">$nexus_redirect</span>?r=<span class="hljs-variable">$pom_r</span>&amp;g=<span class="hljs-variable">$pom_g</span>&amp;a=<span class="hljs-variable">$pom_a</span>&amp;v=<span class="hljs-variable">$pom_v</span>&amp;e=war&quot;</span><br>wget  <span class="hljs-variable">$download_path</span> -O <span class="hljs-variable">$war</span><br><br>deploy_war<br></code></pre></td></tr></table></figure><p>pom.sh 脚本内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml">#!/bin/bash -e<br>. ../bin/env-set.sh<br><br>pom_g=org.example<br>pom_a=test-jenkins<br>pom_v=1.0-SNAPSHOT<br>pom_r=snapshots<br><br><br>deploy_war() &#123;<br>        target_d=war/$&#123;pom_a&#125;-$&#123;pom_v&#125;-$work_time<br>        target_dir=`pwd`/$target_d<br>        if [ ! -f &quot;$war&quot; ]; then<br>                echo &quot;war not exist: $war&quot;<br>                exit 1<br>        fi<br>        unzip -q $war -d $target_dir<br>        rm -rf appwar<br>        ln -sf $target_d appwar<br><br>        ./tomcat.sh stop<br><br>        target_ln=`pwd`/appwar<br>        echo &#x27;<span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;&#x27;$target_ln&#x27;&quot;</span> <span class="hljs-attr">allowLinking</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span>&#x27; &gt; conf/Catalina/localhost/ROOT.xml<br>        ./tomcat.sh start<br>&#125;<br></code></pre></td></tr></table></figure><p>tomcat.sh 内容：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;`whoami`&quot;</span> != <span class="hljs-string">&quot;root&quot;</span> ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Error: You must be apps to run this command.&quot;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;`dirname <span class="hljs-variable">$0</span>`&quot;</span><br>. ../bin/env-set.sh<br>. ./pom.sh<br><br><span class="hljs-built_in">export</span> CATALINA_BASE=<span class="hljs-string">&quot;`pwd`&quot;</span><br>tomcat <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;pom_a&#125;</span>-<span class="hljs-variable">$&#123;pom_v&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><p> env-set.sh内容：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash -e</span><br><span class="hljs-comment">#当前时间</span><br><span class="hljs-built_in">export</span> now_time=$(date +%Y-%m-%d_%H-%M-%S)<br><span class="hljs-comment">#整个期间的开始时间</span><br>[ -z <span class="hljs-string">&quot;<span class="hljs-variable">$work_time</span>&quot;</span> ] &amp;&amp; <span class="hljs-built_in">export</span> work_time=$(date +%Y-%m-%d_%H-%M-%S)<br><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$g_env_set</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">unset</span> JRE_HOME JAVA_HOME CLASSPATH<br><span class="hljs-built_in">export</span> nexus_redirect=<span class="hljs-string">&quot;http://localhost:8081/nexus/service/local/artifact/maven/redirect&quot;</span><br><span class="hljs-built_in">export</span> data_home=<span class="hljs-string">&quot;/var/root/svr&quot;</span><br><span class="hljs-built_in">export</span> server_home=<span class="hljs-string">&quot;<span class="hljs-variable">$data_home</span>/services&quot;</span><br><span class="hljs-built_in">export</span> JAVA_HOME=<span class="hljs-string">&quot;<span class="hljs-variable">$data_home</span>/jdk&quot;</span><br><span class="hljs-built_in">export</span> CATALINA_HOME=<span class="hljs-string">&quot;<span class="hljs-variable">$data_home</span>/apache-tomcat&quot;</span><br><span class="hljs-built_in">export</span> CATALINA_BASE=<span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA_HOME</span>&quot;</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> g_env_set=<span class="hljs-literal">true</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">#能够输入2个grep的字符串用来查找</span><br><span class="hljs-function"><span class="hljs-title">proc_find</span></span>() &#123;<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$#</span>&quot;</span> = 2 ]; <span class="hljs-keyword">then</span><br>                ps -eo pid,cmd|grep -v <span class="hljs-string">&#x27;cmd\|grep&#x27;</span>|grep <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span>|grep <span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span>|sed <span class="hljs-string">&#x27;s/^ *\(.*\) *$/\1/&#x27;</span><br>        <span class="hljs-keyword">else</span><br>                ps -eo pid,cmd|grep -v <span class="hljs-string">&#x27;cmd\|grep&#x27;</span>|grep <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span>|sed <span class="hljs-string">&#x27;s/^ *\(.*\) *$/\1/&#x27;</span><br>        <span class="hljs-keyword">fi</span><br>&#125;<br><span class="hljs-comment">#能够输入2个grep的字符串用来查找</span><br><span class="hljs-function"><span class="hljs-title">proc_pid</span></span>() &#123;<br>        proc_find <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span> | cut -d <span class="hljs-string">&#x27; &#x27;</span> -f1<br>&#125;<br><span class="hljs-comment">#$1: 要重试的次数，超过此次数后使用kill -9</span><br><span class="hljs-comment">#$2: 能够输入2个grep的字符串用来查找</span><br><span class="hljs-function"><span class="hljs-title">proc_kill</span></span>() &#123;<br>        grep_args=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;@:2&#125;</span>&quot;</span><br>        <span class="hljs-keyword">for</span> ((i=1;i&lt;=<span class="hljs-variable">$1</span>;++i))<br>        <span class="hljs-keyword">do</span><br>                pids=(`proc_pid <span class="hljs-string">&quot;<span class="hljs-variable">$grep_args</span>&quot;</span>`)<br>                [ <span class="hljs-variable">$&#123;#pids[@]&#125;</span> = 0 ] &amp;&amp; <span class="hljs-built_in">return</span> 0<br><br>                <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;n=<span class="hljs-variable">$i</span> kill <span class="hljs-variable">$&#123;pids[@]&#125;</span>&quot;</span><br>                <span class="hljs-built_in">kill</span> <span class="hljs-variable">$&#123;pids[@]&#125;</span><br>                sleep 1s<br>        <span class="hljs-keyword">done</span><br>        pids=(`proc_pid <span class="hljs-string">&quot;<span class="hljs-variable">$grep_args</span>&quot;</span>`)<br>        [ <span class="hljs-variable">$&#123;#pids[@]&#125;</span> = 0 ] || <span class="hljs-built_in">kill</span> -9 <span class="hljs-variable">$&#123;pids[@]&#125;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">tomcat_start0</span></span>() &#123;<br><br>[ <span class="hljs-string">&quot;<span class="hljs-variable">$JAVA_OPTS</span>&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ] &amp;&amp; <span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">&quot;-server -XX:MaxPermSize=128m -Xms512m -Xmx512m&quot;</span><br>[ <span class="hljs-string">&quot;`echo &quot;</span><span class="hljs-variable">$JAVA_OPTS</span><span class="hljs-string">&quot;|grep &#x27;\-Djava.security.egd=&#x27;`&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ] &amp;&amp; <span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">&quot;<span class="hljs-variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom&quot;</span><br><span class="hljs-comment">#防止X11导致awt在X11关闭后异常</span><br><span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">&quot;-Djava.awt.headless=true <span class="hljs-variable">$JAVA_OPTS</span> -<span class="hljs-variable">$grep_server</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;START <span class="hljs-variable">$grep_server</span>: JAVA_OPTS=<span class="hljs-variable">$JAVA_OPTS</span>&quot;</span><br><span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA_HOME</span>&quot;</span>/bin/startup.sh<br>&#125;<br><span class="hljs-function"><span class="hljs-title">tomcat_stop0</span></span>() &#123;<br>proc_kill 3 <span class="hljs-string">&quot;<span class="hljs-variable">$grep_server</span>&quot;</span><br>&#125;<br><span class="hljs-function"><span class="hljs-title">tomcat_status0</span></span>() &#123;<br>tmp=`proc_find <span class="hljs-string">&quot;<span class="hljs-variable">$grep_server</span>&quot;</span>`<br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$tmp</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$grep_server</span> stopped.&quot;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$grep_server</span> running: <span class="hljs-variable">$tmp</span>&quot;</span><br><span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">tomcat</span></span>() &#123;<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;Usage: %s &#123;start|stop|restart|status&#125; ????\n&#x27;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$prog</span>&quot;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;java -Dmykey=$&#123;mykey&#125; miss: mykey&#x27;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA_BASE</span>&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;miss: $CATALINA_BASE=&#x27;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA_BASE</span>&quot;</span><br><span class="hljs-built_in">export</span> grep_server=<span class="hljs-string">&quot;Dmykey=<span class="hljs-variable">$&#123;2&#125;</span>x&quot;</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span><br>start)<br>tmp=`proc_find <span class="hljs-string">&quot;<span class="hljs-variable">$grep_server</span>&quot;</span>`<br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$tmp</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>tomcat_start0<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$grep_server</span> already running: <span class="hljs-variable">$tmp</span>&quot;</span><br><span class="hljs-keyword">fi</span><br>sleep 1s<br><span class="hljs-comment">#tomcat_status0</span><br>;;<br>stop)<br>tomcat_stop0<br>tomcat_status0<br>;;<br>status)<br>tomcat_status0<br>;;<br>restart)<br>tomcat_stop0<br>tomcat_start0<br>sleep 1s<br>tomcat_status0<br>;;<br>*)<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;Usage: %s &#123;start|stop|restart|status&#125; ????\n&#x27;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$prog</span>&quot;</span><br><span class="hljs-built_in">exit</span> 1<br>;;<br><span class="hljs-keyword">esac</span><br>&#125;<br></code></pre></td></tr></table></figure><p>项目打包完成后，运行<code>deploy.sh</code>完成更新</p><p><strong>代码地址</strong>：<a href="https://github.com/pyr9/jenkins-script">pyr9&#x2F;jenkins-script (github.com)</a></p><h1 id="2-自动推送"><a href="#2-自动推送" class="headerlink" title="2 自动推送"></a>2 自动推送</h1><p>自动推送方式采用在 jenkins 构建完成之后，执行远程 sh 脚本用于下载本次构建 WAR 包，在自动部署重启。</p><h3 id="1-jenkins-授予可读权限"><a href="#1-jenkins-授予可读权限" class="headerlink" title="1. jenkins 授予可读权限"></a>1. jenkins 授予可读权限</h3><p>不配置会403</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230206160008255.png" alt="image-20230206160008255"></p><h3 id="2-jenkins-配置执行脚本"><a href="#2-jenkins-配置执行脚本" class="headerlink" title="2. jenkins 配置执行脚本"></a>2. jenkins 配置执行脚本</h3><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230206154056839.png" alt="image-20230206154056839"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">BUILD_ID=dontKillMe<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$BUILD_ID</span><br>ssh root@localhost BUILD_URL=<span class="hljs-variable">$BUILD_URL</span> /var/root/svr/services/test-jenkins-demo/jenkins.sh<br></code></pre></td></tr></table></figure><p> jenkins.sh内容：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash -e</span><br><span class="hljs-built_in">source</span> /etc/profile<br><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;`dirname <span class="hljs-variable">$0</span>`&quot;</span><br>. ./pom.sh<br><br><br><span class="hljs-comment">#1. download war, ready env</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deploy time: <span class="hljs-variable">$work_time</span>&quot;</span><br>mkdir -p war/<br><span class="hljs-comment"># 配置下载存放目录</span><br>war=war/<span class="hljs-variable">$pom_a</span>-<span class="hljs-variable">$pom_v</span>.war<br><span class="hljs-comment"># 基于远程传过来的 BUILD_URL下载本次构建</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;BUILD_URL&#125;</span><span class="hljs-variable">$&#123;pom_g&#125;</span>\$<span class="hljs-variable">$&#123;pom_a&#125;</span>/artifact/<span class="hljs-variable">$pom_g</span>/<span class="hljs-variable">$pom_a</span>/<span class="hljs-variable">$pom_v</span>/<span class="hljs-variable">$pom_a</span>-<span class="hljs-variable">$pom_v</span>.war&quot;</span><br>/opt/homebrew/bin/wget  <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;BUILD_URL&#125;</span><span class="hljs-variable">$&#123;pom_g&#125;</span>\$<span class="hljs-variable">$&#123;pom_a&#125;</span>/artifact/<span class="hljs-variable">$pom_g</span>/<span class="hljs-variable">$pom_a</span>/<span class="hljs-variable">$pom_v</span>/<span class="hljs-variable">$pom_a</span>-<span class="hljs-variable">$pom_v</span>.war&quot;</span> -O <span class="hljs-variable">$war</span><br><span class="hljs-comment"># 执行部署函数</span><br>deploy_war<br></code></pre></td></tr></table></figure><h3 id="3-ssh设置免密登录"><a href="#3-ssh设置免密登录" class="headerlink" title="3. ssh设置免密登录"></a>3. ssh设置免密登录</h3><p>（添加公钥到服务器）<a href="https://pyr9.github.io/SSH%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/">SSH免密登录 - 楼上有只喵 (pyr9.github.io)</a></p><p>注意事项⚠️：</p><ol><li>上面如果使用wget 而不是&#x2F;opt&#x2F;homebrew&#x2F;bin&#x2F;wget 会出现  404 Not Found</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>项目部署到tomcat的三种方式</title>
    <link href="/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%88%B0tomcat/"/>
    <url>/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%88%B0tomcat/</url>
    
    <content type="html"><![CDATA[<h1 id="1-项目直接放入-webapps-目录中"><a href="#1-项目直接放入-webapps-目录中" class="headerlink" title="1.项目直接放入 webapps 目录中"></a>1.<strong>项目直接放入 webapps 目录中</strong></h1><ol><li>把项目打包，放入webapps目录下</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301242001681.png"></p><ol start="2"><li><p>依次运行tomcat 的bin目录下<code>shutdown.sh</code>,<code>startup.sh</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230124200306.png"></p></li><li><p>在浏览器输入：<a href="http://localhost:8080/%E9%A1%B9%E7%9B%AE%E5%90%8D%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%9B%E5%85%A5%E5%88%B0%E9%A1%B9%E7%9B%AE%E7%9A%84index%E9%A1%B5%E9%9D%A2">http://localhost:8080/项目名，就可以进入到项目的index页面</a></p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230124200912.png"  /><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230124200828.png"></p></li></ol><h1 id="2-修改-conf-x2F-server-xml-文件"><a href="#2-修改-conf-x2F-server-xml-文件" class="headerlink" title="2 修改 conf&#x2F;server.xml 文件"></a>2 <strong>修改 conf&#x2F;server.xml 文件</strong></h1><p>进入tomcat下conf&#x2F;server.xml，在<code>&lt;Host&gt; &lt;/Host&gt;</code>标签之间输入项目配置信息</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/test01&quot;</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;/Users/xxx/test-jenkins-1.0-RELEASE&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><ul><li><p><strong>path</strong>:浏览器访问时的路径名</p></li><li><p><strong>docBase</strong>:web项目的WebRoot所在的路径，注意是WebRoot的路径，不是项目的路径，其实也<strong>就是编译后的项目路径</strong>（解压后的j ar包路径）。</p></li><li><p><em><strong>reloadble</strong>:设定项目有改动时，tomcat是否重新加载该项目</em></p></li></ul><h1 id="3-conf-x2F-Catalina"><a href="#3-conf-x2F-Catalina" class="headerlink" title="3 conf&#x2F;Catalina"></a>3 <strong>conf&#x2F;Catalina</strong></h1><ol><li><p>入到 apache-tomcat-7.0.52\conf\Catalina\localhost 目录，新建一个 <code>ROOT.xml</code> 文件</p></li><li><p>在那个新建的 xml 文件中，增加下面配置语句</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">docBase</span>=<span class="hljs-string">&quot;/Users/panyurou/test-jenkins-1.0-RELEASE&quot;</span> <span class="hljs-attr">reloadable</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在浏览器输入路径：localhost:8080</p></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230126154643.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>版本快速迭代流程设计</title>
    <link href="/%E7%89%88%E6%9C%AC%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1/"/>
    <url>/%E7%89%88%E6%9C%AC%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="1-整体流程设计"><a href="#1-整体流程设计" class="headerlink" title="1 整体流程设计"></a>1 整体流程设计</h1><ol><li>不同的开发提交当天的变动到统一的代码仓库</li><li>jenkins集成部署到开发环境</li><li>测试手动从jenkins的test仓库拉取打好的jar包，部署到测试环境，进行测试</li><li>测试完成后由运维从jenkins的release仓库拉取打好的jar包，部署到生产环境</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230124123255413.png" alt="image-20230124123255413"></p><h1 id="2-发布窗口机制"><a href="#2-发布窗口机制" class="headerlink" title="2. 发布窗口机制"></a>2. 发布窗口机制</h1><p>上述发布流程是比较重的，我们不可能每天走一遍。可以设置一个固定的发布时间，一般设置在周四。</p><ul><li><p>比如周四下午四点，如果这个点还没有来得及实现或者完成测试，则需要等到下个窗口才能发布。</p></li><li><p>这样的目的：是为了让团队的每个人有一个清晰的时间观念，知道什么时候干什么事，避免手忙脚乱脚乱的随意发布。</p></li></ul><h1 id="3-发布计划"><a href="#3-发布计划" class="headerlink" title="3. 发布计划"></a>3. 发布计划</h1><ul><li><p>很多时候我们的需求之间是有联系的，因此我们需要提前计划好下个窗口能上线的需求，避免A需求上线时，他所依赖的B需求不能上线。</p></li><li><p>中间随意添加需求，会使发布变的困难。</p></li></ul><h1 id="4-实施计划"><a href="#4-实施计划" class="headerlink" title="4 实施计划"></a>4 实施计划</h1><p>除了发布计划，我们需要有实施说明，比如：需要更新那些sql脚本，修改哪些配置文件</p><h1 id="5-时间节点"><a href="#5-时间节点" class="headerlink" title="5 时间节点"></a>5 时间节点</h1><p>整个过程涉及团队协作，只要有一方延误，就会造成其他方等待或者工作推迟发生。为避免这种情况我们需要设计精细的时间节点如下：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230128200518146.png" alt="image-20230128200518146" style="zoom:50%;" />]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>mac下启动tomcat</title>
    <link href="/mac%E4%B8%8B%E5%90%AF%E5%8A%A8tomcat/"/>
    <url>/mac%E4%B8%8B%E5%90%AF%E5%8A%A8tomcat/</url>
    
    <content type="html"><![CDATA[<h1 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h1><p>登录Apache Tomcat官网，地址 <a href="http://tomcat.apache.org/">http://tomcat.apache.org</a> ，左边的Download，点击选择需要下载的版本 Tomcat8</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115204748.png"></p><h2 id="2-启动"><a href="#2-启动" class="headerlink" title="2 启动"></a>2 启动</h2><p>下载下来解压，进入bin目录，运行<code>./startup.sh</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115205133.png"></p><p>停止运行 <code>./shutdown.sh</code></p><h1 id="3-修改默认端口号"><a href="#3-修改默认端口号" class="headerlink" title="3 修改默认端口号"></a>3 修改默认端口号</h1><p>不修改的话，可以直接访问8080端口，我这里修改成了8888</p><ol><li>进入conf 目录 <code>cd conf</code></li><li>修改server.xml  <code>vim server.xml</code></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115205500.png"></p><h1 id="4-设置用户信息"><a href="#4-设置用户信息" class="headerlink" title="4 设置用户信息"></a>4 设置用户信息</h1><p>如果需要manager App，还需要增加用户名和密码</p><ol><li><p>进入conf 目录 <code>cd conf</code></p></li><li><p>修改server.xml  <code>vim tomcat-users.xml</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115205918.png"></p></li></ol><h1 id="5-访问-8888端口"><a href="#5-访问-8888端口" class="headerlink" title="5 访问 8888端口"></a>5 访问 8888端口</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115210632.png"></p>]]></content>
    
    
    <categories>
      
      <category>tomcat</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>nexus私服搭建与核心功能</title>
    <link href="/nexus%E7%A7%81%E6%9C%8D%E6%90%AD%E5%BB%BA%E4%B8%8E%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/"/>
    <url>/nexus%E7%A7%81%E6%9C%8D%E6%90%AD%E5%BB%BA%E4%B8%8E%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<h1 id="1-私服是什么？"><a href="#1-私服是什么？" class="headerlink" title="1. 私服是什么？"></a>1. 私服是什么？</h1><p>私服是一个特殊的远程仓库，它是架设在局域网内的仓库服务。私服代理广域网上的远程仓库，供局域网内的Maven用户使用。</p><p>当Maven需要下载构建的使用，它先从私服请求，如果私服上没有的话，则从外部的远程仓库下载，然后缓存在私服上，再为Maven的下载请求提供服务。</p><p><strong>使用私服的好处</strong></p><ul><li>节省自己的外网带宽：大量的对于外部远程仓库的重复请求会消耗很大的带宽</li><li>加速Maven的构建：不停的请求外部仓库无疑是比较耗时的， 但Maven的一些内部机制（如快照检测）要求Maven在执行构建的时候不停地检查远程仓库的数据。因此当配置了很多远程仓库时，构建的速度会被大大降低。</li><li>部署第三方构件：当某个构件无法从外部远程仓库下载。如Oracle的JDBC驱动由于版权原因不能发布到外网的中心仓库，建立私服之后便可以将这些构件部署到本地私服中，供内部的Maven项目使用。</li><li>提高稳定行，增强控制。Maven构建搞定依赖于远程仓库，因此，当Internet不稳定的时候，Maven构建也会变的不稳定，甚至无法构建。使用私服后即使暂时没有Internet连接Maven也可以正常运行，因为私服中缓存了大量的构件。此外一些私服软件（如：Nexus）还提供了很多额外的功能，如权限管理，RELEASE&#x2F;SNAPSHOT区分等，管理员可以对仓库进行一些更高级的控制。</li><li>降低中央仓库的负荷。数百万的请求，存储数T的数据，需要相相当大的财力。使用私服可以避免很多对中央仓库的重复请求。</li></ul><h1 id="2-nexus-是什么？"><a href="#2-nexus-是什么？" class="headerlink" title="2 nexus 是什么？"></a>2 nexus 是什么？</h1><p>Nexus 是 Sonatype 公司发布的一款仓库（Repository）管理软件，常用来搭建 Maven 私服，所以也有人将 Nexus 称为“Maven仓库管理器”。</p><p>Nexus 开源版具有以下特性：</p><ul><li>占用内存小（28 M 左右）</li><li>具有基于 ExtJs 得操作界面，用户体验较好</li><li>使用基于 Restlet 的完全 REST API</li><li>支持代理仓库、宿主仓库和仓库组</li><li>基于文件系统，不需要依赖数据库</li><li>支持仓库索引以及搜索</li><li>支持在界面上上传构件</li><li>安全控制</li></ul><h1 id="3-nexus安装"><a href="#3-nexus安装" class="headerlink" title="3 nexus安装"></a>3 nexus安装</h1><ol><li><p>进入<a href="https://help.sonatype.com/repomanager2">Repository Manager 2 (sonatype.com)</a>，选择对应的版本进行下载</p></li><li><p>下载解压后，进入bin目录，运行 <code>./nexus start</code></p></li><li><p>访问<a href="http://localhost:8081/nexus">http://localhost:8081/nexus</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230116212514.png"></p></li></ol><p>注：nexus启动失败，查看报错日志（nexus-2.15.1-02&#x2F;logs&#x2F;wrapper.log）</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230116212959.png"></p><p>修复：将javax.activation-1.2.0.jar 和jaxb-api-2.3.0.jar包放到nexus的lib下</p><p>4  登陆nexus，nexus2 默认用户名和密码是<code>admin</code> and <code>admin123</code> .不确定的可以查看官方文档<a href="https://help.sonatype.com/repomanager2/installing-and-running/running">Running (sonatype.com)</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230116215507.png"></p><ol start="5"><li><p>查看仓库</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230116220006.png"></p></li></ol><p>​       如果私服下载不到，就会去远端仓库下载，远端仓库的下载路径就是Central配置的地址，这里我修改成阿里镜像地址</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230117095523.png"></p><h1 id="4-配置从nexus下载依赖"><a href="#4-配置从nexus下载依赖" class="headerlink" title="4 配置从nexus下载依赖"></a>4 配置从nexus下载依赖</h1><ol><li>pom.xml里配置仓库，仓库地址就是nexus的public Repositories的地址，如果有多个项目可以直接配到setting.xml中</li></ol>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;repositories&gt;<br>&lt;repository&gt;<br>&lt;id&gt;nexus-repository&lt;/id&gt;<br>&lt;name&gt;nexus repository&lt;/name&gt;<br>&lt;url&gt;http:<span class="hljs-comment">//localhost:8081/nexus/content/groups/public/&lt;/url&gt;</span><br>&lt;/repository&gt;<br>&lt;/repositories&gt;<br></code></pre></td></tr></table></figure><ol start="2"><li><p>测试</p><p>删除项目已有的依赖，重新compile项目，可以看到是从nexus去下载的依赖，我这里是测试的junit4</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230117100714.png"></p></li></ol><p>​      此时进入public仓库，可以看到私服里已经多了junit</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230117100859.png"></p><h1 id="5-配置发布到nexus"><a href="#5-配置发布到nexus" class="headerlink" title="5 配置发布到nexus"></a>5 配置发布到nexus</h1><ol><li>修改pom.xml，配置发布版本和快照版本的仓库地址</li></ol>   <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">distributionManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>release-repository<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>release repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://localhost:8081/nexus/content/repositories/releases/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">snapshotRepository</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>snapshots-repository<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>snapshots repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://localhost:8081/nexus/content/repositories/snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">snapshotRepository</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">distributionManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><p>修改setting.xml，配置服务用户名和密码（上传到私服需要有权限）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>release-repository<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>deployment<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>deployment123<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>snapshots-repository<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>deployment<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>deployment123<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>部署项目</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230117111441.png"></p></li></ol><p>​        由于我的项目是快照版本（pom.xm配置的<version>1.0-SNAPSHOT</version>），所以上传到了快照仓库里如果需要上传到发               布仓库里修改pom.xml</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301171117149.png"></p><p>可以看到目前项目上传到了release仓库</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230117113859.png"></p>]]></content>
    
    
    <categories>
      
      <category>maven</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>jenkins之war包部署</title>
    <link href="/jekins%E6%94%AFwar%E5%8C%85%E9%83%A8%E7%BD%B2/"/>
    <url>/jekins%E6%94%AFwar%E5%8C%85%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="1-插件安装"><a href="#1-插件安装" class="headerlink" title="1. 插件安装"></a>1. 插件安装</h1><ul><li><p>Maven Integration</p></li><li><p>Pipeline Maven Integration</p></li><li><p>Deploy to container</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115200509.png"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115200537.png"></p><h1 id="2-新建任务"><a href="#2-新建任务" class="headerlink" title="2. 新建任务"></a>2. 新建任务</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301152009848.png"></p><h1 id="3-源码配置"><a href="#3-源码配置" class="headerlink" title="3 源码配置"></a>3 源码配置</h1><ul><li>Credentials 需要选择在用户列表，配置了该仓库ssh key的用户</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115201137.png"></p><h1 id="4-构建后操作"><a href="#4-构建后操作" class="headerlink" title="4 构建后操作"></a>4 构建后操作</h1><h2 id="4-1-部署到服务器"><a href="#4-1-部署到服务器" class="headerlink" title="4.1 部署到服务器"></a>4.1 部署到服务器</h2><p>构建后，部署war包到指定服务器，我这里是部署在了本地的tomcat服务上</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301152014790.png"></p><p>注意：</p><ul><li><p>war文件地址，如果不在当前项目的target下，需要写成类似 <code>**/target/*.war</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115202448.png"></p></li></ul><h2 id="4-2-上传到私服"><a href="#4-2-上传到私服" class="headerlink" title="4.2 上传到私服"></a>4.2 上传到私服</h2><p>我这里是上传到了nexus上</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230122205100.png"></p><p>对英需要修改setting.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>deployment<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>deployment123<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>deployment<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>deployment123<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="5-构建项目"><a href="#5-构建项目" class="headerlink" title="5  构建项目"></a>5  构建项目</h1><p>如果构建失败，可以在控制台查看报错信息</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230115202724.png"></p><h1 id="6-启动tomcat"><a href="#6-启动tomcat" class="headerlink" title="6 启动tomcat"></a>6 启动tomcat</h1><p>可以查看已经部署成功的服务了</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301152016375.png"></p><h1 id="7-登陆nexus"><a href="#7-登陆nexus" class="headerlink" title="7. 登陆nexus"></a>7. 登陆nexus</h1><p>可以看到war包已经上传到了nexus</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301222054195.png"></p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>IDEA解决resources资源找不到</title>
    <link href="/IDEA%E8%A7%A3%E5%86%B3resources%E8%B5%84%E6%BA%90%E6%89%BE%E4%B8%8D%E5%88%B0/"/>
    <url>/IDEA%E8%A7%A3%E5%86%B3resources%E8%B5%84%E6%BA%90%E6%89%BE%E4%B8%8D%E5%88%B0/</url>
    
    <content type="html"><![CDATA[<p>pom中删除<code>&lt;packaging&gt;pom&lt;/packaging&gt;</code>。加了这个pom不会处理resources目录</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301121549744.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Mac下安装jenkins</title>
    <link href="/Mac%E4%B8%8B%E5%AE%89%E8%A3%85jekins/"/>
    <url>/Mac%E4%B8%8B%E5%AE%89%E8%A3%85jekins/</url>
    
    <content type="html"><![CDATA[<h1 id="1-可持续化集成CI"><a href="#1-可持续化集成CI" class="headerlink" title="1. 可持续化集成CI"></a>1. 可持续化集成CI</h1><p>​      持续集成即CI（Continuous integration）是一种软件开发实践,可以让团队在持续的基础上不断收到反馈并进行改进，不必等到开发周期后期才寻找缺陷。持续集成要点：</p><ul><li>统一的代码库 git</li><li>统一的依赖包管理 nexus</li><li>测试自动化</li><li>构建全自动化 maven</li><li>部署自动化</li><li>可追踪的集成记录 ：某一次有问题，可以找到上次集成。或者上上次集成，然后代码回滚</li></ul><p>持续集成的流程：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230108202610.png"></p><h1 id="2-jenkins概述"><a href="#2-jenkins概述" class="headerlink" title="2 jenkins概述"></a>2 jenkins概述</h1><p>jenkins就是为了满足上述持续集成的要点而设计的一款工具，主体框架是采用java开发，实质内部功能都是通过插件实现，极大程度提高了系统的扩展性。</p><p>其不仅可以满足java系统的集成，也可以实现PHP等语言的集成发布。</p><p>通过pipeline插件，用户可以随自己需要定制集成流程。</p><h1 id="3-mac-下安装-jenkins"><a href="#3-mac-下安装-jenkins" class="headerlink" title="3 mac 下安装 jenkins"></a>3 mac 下安装 jenkins</h1><p>用brew 安装</p><p><code> brew install jenkins</code></p><p>启动jenkins</p><p><code>brew services start jenkins</code></p><p>停止jenkins</p><p><code> brew services stop jenkins</code></p><h1 id="4-修改jenkins默认端口配置"><a href="#4-修改jenkins默认端口配置" class="headerlink" title="4 修改jenkins默认端口配置"></a>4 修改jenkins默认端口配置</h1><h2 id="1-查看jenkins安装路径"><a href="#1-查看jenkins安装路径" class="headerlink" title="1.查看jenkins安装路径"></a>1.查看jenkins安装路径</h2><ul><li><code>brew list jenkins</code></li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230110221220.png" style="zoom:150%;" /><h2 id="2-修改homebrew-mxcl-jenkins-plist"><a href="#2-修改homebrew-mxcl-jenkins-plist" class="headerlink" title="2. 修改homebrew.mxcl.jenkins.plist"></a>2. 修改homebrew.mxcl.jenkins.plist</h2><ul><li><p>打开文件 <code>vim /opt/homebrew/Cellar/jenkins/2.385/homebrew.mxcl.jenkins.plist</code></p></li><li><p>修改默认端口号</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230110221801.png"></p></li></ul><h2 id="3-修改jenkins系统配置url"><a href="#3-修改jenkins系统配置url" class="headerlink" title="3. 修改jenkins系统配置url"></a>3. 修改jenkins系统配置url</h2><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230110222629.png"  /><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/202301221541401.png"></p><h1 id="5-pipeline-集成原理"><a href="#5-pipeline-集成原理" class="headerlink" title="5 pipeline 集成原理  "></a>5 pipeline 集成原理  <img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230124113315.png"></h1>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>工作流</title>
    <link href="/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    <url>/%E5%B7%A5%E4%BD%9C%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h1 id="1-工作流是什么？"><a href="#1-工作流是什么？" class="headerlink" title="1. 工作流是什么？"></a>1. 工作流是什么？</h1><p>工作流就是计算机对业务流程自动化执行管理。有了工作流可以更好的管理业务流程，提高系统扩展性。</p><h1 id="2-Activity-7"><a href="#2-Activity-7" class="headerlink" title="2. Activity 7"></a>2. Activity 7</h1><ul><li>activity是一个工作流引擎，activity可以将业务系统中复杂的业务流程抽取出来，使用专门的建模语言BPMN2.0进行定义。</li><li>业务流程按照预先定义的流程进行执行，实现了系统的流程由activiti进行管理，减少业务系统由于流程变更进行系统升级改造的工作量，从而提高系统的健壮性，同时也减少了系统开发的维护成本。</li></ul><h1 id="3-BPMN"><a href="#3-BPMN" class="headerlink" title="3 BPMN"></a>3 BPMN</h1><p>BPMN（Business Process Model AndNotation）- 业务流程模型和符号 是由BPMI（BusinessProcess Management Initiative）<strong>开发的一套标准的业务流程建模符号</strong>，使用BPMN提供的<strong>符号</strong>可以创建业务流程。</p><h1 id="4-使用步骤"><a href="#4-使用步骤" class="headerlink" title="4.  使用步骤"></a>4.  使用步骤</h1><h2 id="4-1-流程定义"><a href="#4-1-流程定义" class="headerlink" title="4.1 流程定义"></a>4.1 流程定义</h2><p>使用activiti流程建模工具(activity-designer)定义业务流程(.bpmn文件) 。</p><h2 id="4-1-流程定义部署"><a href="#4-1-流程定义部署" class="headerlink" title="4.1 流程定义部署"></a>4.1 流程定义部署</h2><ul><li><p>activiti部署业务流程定义（.bpmn文件）</p></li><li><p>使用activiti提供的api把流程定义内容存储起来，在Activiti执行过程中可以查询定义的内容</p></li><li><p>Activiti执行把流程定义内容存储在数据库中</p></li></ul><h2 id="4-2-启动一个流程实例"><a href="#4-2-启动一个流程实例" class="headerlink" title="4.2 启动一个流程实例"></a>4.2 启动一个流程实例</h2><ul><li>流程实例也叫：ProcessInstance</li><li>启动一个流程实例表示开始一次业务流程的运行。</li><li>在员工请假流程定义部署完成后，如果张三要请假就可以启动一个流程实例，如果李四要请假也启动一个流程实例，两个流程的执行互相不影响。</li></ul><h2 id="4-3-用户查询待办任务-Task"><a href="#4-3-用户查询待办任务-Task" class="headerlink" title="4.3 用户查询待办任务(Task)"></a>4.3 用户查询待办任务(Task)</h2><p>因为现在系统的业务流程已经交给activiti管理，通过activiti就可以查询当前流程执行到哪了，当前用户需要办理什么任务了，这些activiti帮我们管理了，而不需要开发人员自己编写在sql语句查询。</p><h2 id="4-4-用户办理任务"><a href="#4-4-用户办理任务" class="headerlink" title="4.4 用户办理任务"></a>4.4 用户办理任务</h2><p>用户查询待办任务后，就可以办理某个任务，如果这个任务办理完成还需要其它用户办理，比如采购单创建后由部门经理审核，这个过程也是由activiti帮我们完成了。</p><h2 id="4-5-流程结束"><a href="#4-5-流程结束" class="headerlink" title="4.5 流程结束"></a>4.5 流程结束</h2><p>当任务办理完成没有下一个任务结点了，这个流程实例就完成了。</p><h1 id="5-spring集成activiti"><a href="#5-spring集成activiti" class="headerlink" title="5 spring集成activiti"></a>5 spring集成activiti</h1><h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">slf4j.version</span>&gt;</span>1.6.6<span class="hljs-tag">&lt;/<span class="hljs-name">slf4j.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">log4j.version</span>&gt;</span>1.2.12<span class="hljs-tag">&lt;/<span class="hljs-name">log4j.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">activiti.version</span>&gt;</span>7.0.0.Beta1<span class="hljs-tag">&lt;/<span class="hljs-name">activiti.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- bpmn 模型处理 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-bpmn-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- bpmn 转换 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-bpmn-converter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- bpmn json数据转换 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-json-converter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- bpmn 布局 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-bpmn-layout<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- activiti 云支持 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-cloud-services-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- mysql驱动 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- mybatis --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- 链接池 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span> <span class="hljs-comment">&lt;!-- log start --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-增加activiti配置文件"><a href="#2-增加activiti配置文件" class="headerlink" title="2. 增加activiti配置文件"></a>2. 增加activiti配置文件</h2><p>resources下增加activiti配置文件activiti.cfg.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/tx&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">                    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/contex</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/tx</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql:///activiti&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;19980617pyr&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxActive&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;3&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--    默认方式下bean的id 固定为processEngineConfiguration--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;processEngineConfiguration&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 引用数据源 上面已经设置好了--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!-- activiti数据库表处理策略 databaseSchemaUpdate：如果数据库中已经存在相应的表直接使用，不存在，直接创建--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;databaseSchemaUpdate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-生成activiti需要的表"><a href="#3-生成activiti需要的表" class="headerlink" title="3 生成activiti需要的表"></a>3 生成activiti需要的表</h2><p>利用测试类生成activiti需要的表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.activiti.engine.ProcessEngine;<br><span class="hljs-keyword">import</span> org.activiti.engine.ProcessEngines;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCreate</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成 activiti的数据库表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreateDbTable</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 使用classpath下的activiti.cfg.xml中的配置创建processEngine</span><br><span class="hljs-comment">         * getDefaultProcessEngine会默认从resources下读取名字为activiti.cfg.xml文件</span><br><span class="hljs-comment">         * 创建processEngine时，就会创建mysql表</span><br><span class="hljs-comment">         */</span><br>        ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();<br>        System.out.println(processEngine);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行以上代码，会在数据库里生成25张表</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20230128155215.png"></p>]]></content>
    
    
    <categories>
      
      <category>Activiti</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>maven基本概念</title>
    <link href="/maven%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"/>
    <url>/maven%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/</url>
    
    <content type="html"><![CDATA[<h2 id="maven遵循约定大于配置"><a href="#maven遵循约定大于配置" class="headerlink" title="maven遵循约定大于配置"></a>maven遵循约定大于配置</h2><ul><li>maven编译的路径为 src&#x2F;main&#x2F;java</li><li>maven 打包后的路径在 &#x2F;target&#x2F;classes</li><li>maven项目的配置文件存储在&#x2F;resources目录下</li><li>maven打包就是，运行<code>mvn package</code>把 &#x2F;target&#x2F;classes下的文件，打成一个jar包或者war包，打在target目录下</li><li>maven运行测试用例，运行<code>mvn test</code>，将运行src&#x2F;test下以test开后的文件里的，以test开头的方法、  如果引入了junit，将会运行以@test注解的方法。</li></ul><h2 id="maven-生命周期"><a href="#maven-生命周期" class="headerlink" title="maven 生命周期"></a>maven 生命周期</h2><ul><li>Maven 的内部有三个标准生命周期</li><li>生命周期中的阶段是有严格的执行顺序的。比如：必须执行完compile才会执行package</li><li>生命周期中的阶段是有执行逻辑的。即当你执行一个阶段时，其前面的阶段会自动执行。</li><li>生命周期的阶段可以绑定具体的插件和目标</li></ul><h2 id="Clean-生命周期"><a href="#Clean-生命周期" class="headerlink" title="Clean 生命周期"></a>Clean 生命周期</h2><p>当我们执行 mvn post-clean 命令时，Maven 调用 clean 生命周期，它包含以下阶段：</p><ul><li>pre-clean：执行一些需要在clean之前完成的工作</li><li>clean：移除所有上一次构建生成的文件</li><li>post-clean：执行一些需要在clean之后立刻完成的工作</li></ul><h2 id="Default-Build-生命周期"><a href="#Default-Build-生命周期" class="headerlink" title="Default (Build) 生命周期"></a>Default (Build) 生命周期</h2><p>这是 Maven 的主要生命周期，被用于构建应用，包括 23 个阶段，核心阶段包括：</p><table><thead><tr><th>核心阶段</th><th>详解</th></tr></thead><tbody><tr><td>validate</td><td>验证项目是否正确，所有必要信息是否可用<code>（很少单独使用）</code></td></tr><tr><td>compile</td><td>编译项目的源代码（将src&#x2F;main中的java代码编译成class文件，输出到targe目录下）</td></tr><tr><td>test</td><td>将单元测试的资源文件和代码进行编译，生成的文件位于target&#x2F;test-classes （打包部署请跳过该阶段）</td></tr><tr><td>package</td><td>把class文件，resources文件打包成jar包（也可以是war包），生成的jar包位于target目录下</td></tr><tr><td>verify</td><td>检查包是否有效<code>（很少单独使用）</code></td></tr><tr><td>install</td><td>将jar部署到本地仓库，本地的其他模块依赖该jar包时，可以直接从本地仓库去获取</td></tr><tr><td>deploy</td><td>将jar包部署到远端仓库，需要在maven的setting.xml中配置私服的用户名和密码，以及在pom.xml配置</td></tr></tbody></table><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221227224007.png"></p><h2 id="Site-生命周期"><a href="#Site-生命周期" class="headerlink" title="Site 生命周期"></a>Site 生命周期</h2><p>Maven Site 插件一般用来创建新的报告文档、部署站点等。包括4各阶段</p><ul><li>pre-site：执行一些需要在生成站点文档之前完成的工作</li><li>site：生成项目的站点文档</li><li>post-site： 执行一些需要在生成站点文档之后完成的工作，并且为部署做准备</li><li>site-deploy：将生成的站点文档部署到特定的服务器上</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>vue的生命周期选项</title>
    <link href="/vue%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
    <url>/vue%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="1-beforeCreate"><a href="#1-beforeCreate" class="headerlink" title="1. beforeCreate"></a>1. beforeCreate</h2><ul><li><p>在组件实例初始化之后调用，也就是new Vue()之后</p></li><li><p>初始化了主要的生命周期函数</p></li></ul><h2 id="2-created"><a href="#2-created" class="headerlink" title="2. created"></a>2. created</h2><ul><li>初始化了data()，computed()，methods()，watch()</li><li>使用场景：调用ajax来获取自己的首屏数据</li></ul><h2 id="3-beforeMount"><a href="#3-beforeMount" class="headerlink" title="3.beforeMount"></a>3.beforeMount</h2><ul><li>内存中已经编译生成好了html结构，但是还没有渲染。</li></ul><blockquote><p>mount表示挂载的意思，就是说要将内存中渲染的html结构，渲染到页面上。</p></blockquote><h2 id="4-mounted"><a href="#4-mounted" class="headerlink" title="4. mounted"></a>4. mounted</h2><ul><li>内存中渲染好的html结构，替换到页面上</li><li>其自身的 DOM 树已经创建完成并插入了父容器中。</li><li>所有同步子组件都已经被挂载</li></ul><p><strong>使用场景</strong>：</p><p>在此处发送 异步请求 （ajax，fetch，axios等），获取服务器上的数据，显示在DOM里。</p><p>比如：根据输入框里输入的元素，去服务器查询数据</p><h2 id="5-beforeUpdate"><a href="#5-beforeUpdate" class="headerlink" title="5. beforeUpdate"></a>5. <strong>beforeUpdate</strong></h2><ul><li>组件更新（数据更新）之前执行的函数</li></ul><h2 id="6-updated"><a href="#6-updated" class="headerlink" title="6.updated"></a>6.<strong>updated</strong></h2><p>组件更新（数据更新）后执行的函数</p><h2 id="7-beforeDestroy"><a href="#7-beforeDestroy" class="headerlink" title="7. beforeDestroy"></a>7. beforeDestroy</h2><ul><li>vue（组件）对象销毁之前</li></ul><h2 id="8-destroyed"><a href="#8-destroyed" class="headerlink" title="8. destroyed"></a>8. destroyed</h2><ul><li>组件销毁后</li></ul>]]></content>
    
    
    <categories>
      
      <category>Vue</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>响应式开发</title>
    <link href="/Bootstrap%E4%BD%BF%E7%94%A8/"/>
    <url>/Bootstrap%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-响应式开发"><a href="#1-响应式开发" class="headerlink" title="1 响应式开发"></a>1 响应式开发</h1><h2 id="1-1-响应式开发原理"><a href="#1-1-响应式开发原理" class="headerlink" title="1.1 响应式开发原理"></a>1.1 响应式开发原理</h2><p>响应式开发就是使用媒体查询，针对不同宽度的设备进行布局和样式的调整，从而适配不同设备。</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127201119.png" style="zoom:50%;" /><h2 id="1-2-案例"><a href="#1-2-案例" class="headerlink" title="1.2 案例"></a>1.2 案例</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs css"><br><span class="hljs-comment">/*1. 超小屏幕下 小于768 容器宽度为100%*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">767px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*2. 小屏幕下 &gt;= 768, 容器布局改为750px*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">750px</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*2. 中等屏幕 &gt;= 992, 容器布局改为970px*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">992px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">970px</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*2. 小屏幕下 &gt;= 1200, 容器布局改为1170px*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1200px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">1170px</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127201326.png" style="zoom:70%;" />]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>响应式开发</title>
    <link href="/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%BC%80%E5%8F%91/"/>
    <url>/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%BC%80%E5%8F%91/</url>
    
    <content type="html"><![CDATA[<h1 id="1-响应式开发"><a href="#1-响应式开发" class="headerlink" title="1 响应式开发"></a>1 响应式开发</h1><h2 id="1-1-响应式开发原理"><a href="#1-1-响应式开发原理" class="headerlink" title="1.1 响应式开发原理"></a>1.1 响应式开发原理</h2><p>响应式开发就是使用媒体查询，针对不同宽度的设备进行布局和样式的调整，从而适配不同设备。</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127201119.png" style="zoom:50%;" /><h2 id="1-2-案例"><a href="#1-2-案例" class="headerlink" title="1.2 案例"></a>1.2 案例</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs css"><br><span class="hljs-comment">/*1. 超小屏幕下 小于768 容器宽度为100%*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">767px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*2. 小屏幕下 &gt;= 768, 容器布局改为750px*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">750px</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*2. 中等屏幕 &gt;= 992, 容器布局改为970px*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">992px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">970px</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*2. 小屏幕下 &gt;= 1200, 容器布局改为1170px*/</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1200px</span>) &#123;<br>    <span class="hljs-selector-class">.container</span> &#123;<br>        <span class="hljs-attribute">width</span>: <span class="hljs-number">1170px</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127201326.png" style="zoom:70%;" />]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS定位</title>
    <link href="/CSS%E5%AE%9A%E4%BD%8D/"/>
    <url>/CSS%E5%AE%9A%E4%BD%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="1-为什么需要定位？"><a href="#1-为什么需要定位？" class="headerlink" title="1. 为什么需要定位？"></a>1. 为什么需要定位？</h1><p>有些场景，使用标准流和浮动都没办法实现。比如：</p><ul><li>某个元素可以随意在一个盒子内移动位置，并且压住其他盒子。</li><li>滚动窗口的时候，盒子是固定在某个位置的。</li></ul><h1 id="2-定位是什么？"><a href="#2-定位是什么？" class="headerlink" title="2 定位是什么？"></a>2 定位是什么？</h1><ul><li><p>定位组成：定位 &#x3D; 定位模式 + 边偏移</p></li><li><p>定位特性：</p><ol><li><p>绝对定位和固定定位和浮动类似</p><ul><li>行内元素添加绝对定位或固定定位，可以直接设置宽度和高度</li><li>块级元素添加绝对定位或固定定位，如果没有设置宽度和高度，默认大小是内容的大小。</li></ul></li><li><p>绝对定位和固定定位会压住它下面标准流的盒子</p></li></ol></li></ul><h2 id="2-1-定位模式"><a href="#2-1-定位模式" class="headerlink" title="2.1 定位模式"></a>2.1 定位模式</h2><p>定位模式，决定元素的定位方式，通过CSS的position属性来设置，分为4种：</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127143043.png" style="zoom:70%;" /><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127175619.png" style="zoom:70%;" /><h2 id="2-2-边偏移"><a href="#2-2-边偏移" class="headerlink" title="2.2 边偏移"></a>2.2 边偏移</h2><p>边偏移，决定元素的最终位置，有top,bottom,left,right 4个属性</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127143307.png" style="zoom:70%;" /><h1 id="3-定位方式"><a href="#3-定位方式" class="headerlink" title="3 定位方式"></a>3 定位方式</h1><h2 id="3-1-静态定位"><a href="#3-1-静态定位" class="headerlink" title="3.1 静态定位"></a>3.1 静态定位</h2><ul><li>定义：静态定位是元素的默认定位方式，即无定位。</li><li>语法：<code>&#123;position： static&#125;</code></li><li>特点：<ul><li>按照标准流的特性，没有位偏移</li></ul></li><li>应用：<ul><li>静态定位在布局时很少用到</li></ul></li></ul><h2 id="3-2-相对定位"><a href="#3-2-相对定位" class="headerlink" title="3.2 相对定位"></a>3.2 相对定位</h2><ul><li>定义： 相对定位是元素在移动位置的时候，相对它原来的位置来说的。</li><li>语法 ：<code>&#123;position： relative&#125;</code></li><li>特点：<ul><li>移动的位置是参照自己原先的位置</li><li>不脱标，继续保留原来的位置</li></ul></li><li>应用：<ul><li>给决定定位当爹</li></ul></li></ul><h2 id="3-3-绝对定位"><a href="#3-3-绝对定位" class="headerlink" title="3.3 绝对定位"></a>3.3 绝对定位</h2><ul><li>定义：绝对定位是元素在移动位置的时候，相对它<strong>祖辈元素</strong>的位置来说的。</li><li>语法：<code>&#123;position： absolute&#125;</code></li><li>特点：<ul><li>如果没有祖先元素，或祖先元素没有定位，则以浏览器为准定位（Document文档）</li><li>如果祖先元素有定位（相对，绝对，固定定位），则以最近一级有定位的祖先元素，为参考点移动位置。</li><li>绝对定位不再占有原先的位置（脱标）</li></ul></li></ul><p><strong>子绝父相的由来</strong></p><ul><li>意思是：子级是绝对定位的话，父级要是相对定位</li><li>理由：<ul><li>父级需要占有位置，所以是相对定位</li><li>子级需要不占有位置，并且可以放到父盒子的任意一个地方。所以是绝对定位。</li></ul></li></ul><h2 id="3-4-固定定位"><a href="#3-4-固定定位" class="headerlink" title="3.4 固定定位"></a>3.4 固定定位</h2><ul><li>定义：固定定位是元素固定于浏览器的可视区的位置</li><li>语法：<code>&#123;position： fixed&#125;</code></li><li>特点：<ul><li>以浏览器的可视窗口为参照点移动元素</li><li>浏览器滚动时，元素的位置不会改变</li><li>跟父元素没有关系</li><li>不占有原先的位置（脱标）</li></ul></li></ul><blockquote><p>固定定位可以看做是一种特殊的绝对定位</p></blockquote><h2 id="3-5-粘性定位"><a href="#3-5-粘性定位" class="headerlink" title="3.5 粘性定位"></a>3.5 粘性定位</h2><ul><li>定义：粘性定位可以看做相对定位和固定定位的混合。一般跟页面滚动条搭配使用</li><li>语法：<code>&#123;position： sticky; top: 10px&#125;</code>（刚开始随滚动条滚动，等到达了距距离浏览器可视窗口上方的10px后，就固定在了窗口上）</li><li>特点：<ul><li>以浏览器的可视窗口为参照点移动元素</li><li>不脱标，继续保留原来的位置</li><li>必须添加top，left,  right， bottom中的一个才有效</li><li>兼容性差，不支持IE</li></ul></li></ul><h1 id="4-定位叠放次序"><a href="#4-定位叠放次序" class="headerlink" title="4 定位叠放次序"></a>4 定位叠放次序</h1><ul><li>定义： 使用定位布局时，可能会出现盒子的重叠情况。此时，使用z-index 来设置叠放次序</li><li>语法：<code>&#123;z-index: 1&#125;</code></li><li>特点：<ul><li>数值可以是正整数、负整数、0，默认是auto</li><li>数值越大，盒子越靠上</li><li>数字后面不能加单位</li><li>只有定位的盒子才能有z-index属性</li></ul></li></ul><h1 id="5-绝对定位盒子居中"><a href="#5-绝对定位盒子居中" class="headerlink" title="5 绝对定位盒子居中"></a>5 绝对定位盒子居中</h1><ul><li>加了绝对定位的盒子不能通过<code>margin: 0 auto</code>水平居中，但是可以通过以下计算方法实现居中。<ol><li><code>left: 50%</code>: 让盒子的左侧移动父容器宽度的一半</li><li><code>margin-left: -0.5*自身宽度 px</code>: 让盒子向左移动自身盒子宽度的一般</li></ol></li></ul>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS元素显示模式</title>
    <link href="/CSS%E5%85%83%E7%B4%A0%E6%98%BE%E7%A4%BA%E6%A8%A1%E5%BC%8F/"/>
    <url>/CSS%E5%85%83%E7%B4%A0%E6%98%BE%E7%A4%BA%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-定义"><a href="#1-定义" class="headerlink" title="1 定义"></a>1 定义</h1><ul><li><p>元素显示模式就是：元素（标签）以什么方式进行显示。比如<div>自己占一行，一行可以放多个<span></p></li><li><p>html元素一般可以分为：块元素和行元素</p></li></ul><h1 id="2-块元素"><a href="#2-块元素" class="headerlink" title="2 块元素"></a>2 块元素</h1><p>常见的块级元素有div、hr、p、h1 - h6, ul , ol , form , table</p><h2 id="2-1-特点"><a href="#2-1-特点" class="headerlink" title="2.1 特点"></a>2.1 特点</h2><ul><li>独占一行</li><li>可以控制：宽度，高度，内外边距</li><li>宽度默认是父容器的100%</li><li>是一个容器，里面可以放行内元素或者块级元素</li></ul><p>注意：文字类的元素内不能使用块级元素。如<code>&lt;p&gt;, &lt;h1&gt;~&lt;h6&gt;</code>里面不可以使用div</p><h1 id="3-行内元素"><a href="#3-行内元素" class="headerlink" title="3 行内元素"></a>3 行内元素</h1><p>常见的行内元素有a, span, a, i ,em 等</p><h2 id="3-1-特点"><a href="#3-1-特点" class="headerlink" title="3.1 特点"></a>3.1 特点</h2><ul><li><p>行内元素在一行可以显示多个</p></li><li><p>高和宽设置是无效的</p></li><li><p>宽度默认就是他本身内容的宽度</p></li><li><p>行内元素只能容纳文本或者其他行内元素</p></li></ul><p><strong>注意：</strong></p><ul><li>链接里面不能再放链接</li></ul><h1 id="4-行内块元素"><a href="#4-行内块元素" class="headerlink" title="4 行内块元素"></a>4 行内块元素</h1><p> 常见的行内块元素有：input, img, td。他们同事具有块元素和行内元素的特点。</p><h2 id="4-1-特点"><a href="#4-1-特点" class="headerlink" title="4. 1 特点"></a>4. 1 特点</h2><ul><li>一行可以显示多个，但是多个间会有空白缝隙。</li><li>宽度默认就是他本身内容的宽度</li><li>可以控制：宽度，高度，内外边距</li></ul><h1 id="5-元素显示模式的转换"><a href="#5-元素显示模式的转换" class="headerlink" title="5 元素显示模式的转换"></a>5 元素显示模式的转换</h1><p>常见的操作：想增加a链接的触发范围</p><ul><li>转为块元素：<code>display:block</code></li><li>转为行内元素：<code>display:inline</code></li><li>转为行内块元素：<code>display:inline-block</code></li></ul>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>解决手机端1像素边框问题</title>
    <link href="/%E8%A7%A3%E5%86%B3%E6%89%8B%E6%9C%BA%E7%AB%AF1%E5%83%8F%E7%B4%A0%E8%BE%B9%E6%A1%86%E9%97%AE%E9%A2%98/"/>
    <url>/%E8%A7%A3%E5%86%B3%E6%89%8B%E6%9C%BA%E7%AB%AF1%E5%83%8F%E7%B4%A0%E8%BE%B9%E6%A1%86%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-定义border-css文件"><a href="#1-定义border-css文件" class="headerlink" title="1. 定义border.css文件"></a>1. 定义border.css文件</h1><p><a href="https://github.com/panyuro/Travel/blob/main/src/assets/styles/border.css">Travel&#x2F;border.css at main · panyuro&#x2F;Travel (github.com)</a></p><h1 id="2-在main-js引入"><a href="#2-在main-js引入" class="headerlink" title="2. 在main.js引入"></a>2. 在main.js引入</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./assets/styles/border.css&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS浮动</title>
    <link href="/CSS%E6%B5%AE%E5%8A%A8/"/>
    <url>/CSS%E6%B5%AE%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>多个块级元素纵向排列找标准流，横向排列找浮动。</p></blockquote><h1 id="1-普通流（标准流）"><a href="#1-普通流（标准流）" class="headerlink" title="1 普通流（标准流）"></a>1 普通流（标准流）</h1><h2 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h2><p>标准流就是标签按照规定好默认方式排列。标准流是最基本的布局方式。</p><ol><li>块级元素会独占一行，从上到下顺序排列。如：div、hr、p、h1 - h6, ul , ol , form , table</li><li>行内元素会按照顺序，从左往右排序,如：span, a, i ,em</li></ol><h1 id="2-浮动"><a href="#2-浮动" class="headerlink" title="2 浮动"></a>2 浮动</h1><h2 id="2-1-为什么需要浮动？"><a href="#2-1-为什么需要浮动？" class="headerlink" title="2.1 为什么需要浮动？"></a>2.1 为什么需要浮动？</h2><ul><li>有很多布局效果，标准流没有办法完成。比如：多个块级盒子一行没有缝隙排列。</li><li>浮动，可以改变元素标签的默认排列方式。</li><li>浮动最初产生的目的：做文字环绕。</li></ul><h2 id="2-2-什么是浮动？"><a href="#2-2-什么是浮动？" class="headerlink" title="2.2 什么是浮动？"></a>2.2 什么是浮动？</h2><ul><li><p>float属性，用于创建浮动框，将其移动到一边，直至左边缘或者右边缘触及到包含块或者另一个浮动框的边缘</p></li><li><p>语法：<code>&#123;float: 属性值&#125;</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221126195705.png"></p></li></ul><h2 id="2-3-浮动特性"><a href="#2-3-浮动特性" class="headerlink" title="2.3 浮动特性"></a>2.3 浮动特性</h2><ol><li><p>设置了浮动的元素，脱离了标准流的控制（简称“脱标”）。浮动的盒子不再保留原来的位置。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221126200811.png"></p></li><li><p>如果多个盒子都设置了浮动，则他们会按照属性值，一行显示并且顶端对齐排列。</p><ul><li><p>注意：浮动的元素是互相贴在一起的（不会有缝隙），如果父级元素装不下这些浮动的盒子，多出的盒子会另起一行对齐。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221126222207.png"></p></li></ul></li><li><p>设置了浮动的元素，会具有行内块元素的特性</p><ul><li>块级元素，没有设置宽度时，默认宽度和父级一样。但是添加浮动后，他的大小根据内容来决定。</li><li>行内元素，添加浮动后，就可以直接设置高度和宽度。</li></ul></li><li><p>浮动不会压住它下面标准流盒子里的文字。因为他最初设置的目的就是为了做文字环绕。</p></li></ol><h2 id="2-4-浮动布局的注意点"><a href="#2-4-浮动布局的注意点" class="headerlink" title="2.4 浮动布局的注意点"></a>2.4 浮动布局的注意点</h2><h3 id="2-4-1-浮动和标准流父级搭配使用"><a href="#2-4-1-浮动和标准流父级搭配使用" class="headerlink" title="2.4.1  浮动和标准流父级搭配使用"></a>2.4.1  浮动和标准流父级搭配使用</h3><p>为了约束浮动元素的位置，我们一般采取的策略是：<strong>先用标准流的父元素排列上下位置，之后内部元素采取浮动，排列左右位置。</strong></p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221126230639.png" style="zoom:50%;" /><h3 id="2-4-2-一个元素浮动了，理论上其余的兄弟元素都应该浮动"><a href="#2-4-2-一个元素浮动了，理论上其余的兄弟元素都应该浮动" class="headerlink" title="2.4.2 一个元素浮动了，理论上其余的兄弟元素都应该浮动"></a>2.4.2 一个元素浮动了，理论上其余的兄弟元素都应该浮动</h3><p>浮动的盒子，只会影响他后面的标准流，不会影响前面的标准流。因为前面的标准流已经独占一行了</p><h1 id="2-5-清除浮动"><a href="#2-5-清除浮动" class="headerlink" title="2.5 清除浮动"></a>2.5 清除浮动</h1><h3 id="2-5-1-为什么需要清除浮动？"><a href="#2-5-1-为什么需要清除浮动？" class="headerlink" title="2.5.1 为什么需要清除浮动？"></a>2.5.1 为什么需要清除浮动？</h3><p>在某些情况下，如：文字长短不定，列表展示高度不定。父盒子不方便给高度。</p><p>但是子盒子浮动又不占有位置，最后会导致父盒子不占用原文档流的位置，高度为0，会影响后面的元素排版。</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127000827.png" style="zoom:50%;" /><h3 id="2-5-2-清除浮动的本质"><a href="#2-5-2-清除浮动的本质" class="headerlink" title="2.5.2 清除浮动的本质"></a>2.5.2 清除浮动的本质</h3><p>清除浮动之后，父级就会根据浮动的子盒子自动检测高度。父级有了高度，就不会影响后面的元素排版了。</p><h3 id="2-5-3-清除浮动的方式"><a href="#2-5-3-清除浮动的方式" class="headerlink" title="2.5.3 清除浮动的方式"></a>2.5.3 清除浮动的方式</h3><ul><li><p>语法：<code>&#123;clear: 属性值&#125;</code>，实际工作中，几乎只用clear:both</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20221127112835.png" style="zoom:50%;" /></li></ul><h4 id="1-额外标签法"><a href="#1-额外标签法" class="headerlink" title="1 额外标签法"></a>1 额外标签法</h4><ul><li><p>定义： 额外标签法也称之为<strong>隔墙法</strong>， 是W3C最推荐的做法。</p></li><li><p>使用：在浮动元素末尾添加一个空的标签，例如：<code>&lt;div style=&quot;clear: both&quot;&gt;&lt;/div&gt;</code></p></li><li><p>优缺点：</p><ul><li>优点：通俗易懂，书写方便</li><li>缺点：增加了无意义的标签，结构化差</li></ul></li></ul><h4 id="2-给父级添加overflow"><a href="#2-给父级添加overflow" class="headerlink" title="2 给父级添加overflow"></a>2 给父级添加overflow</h4><ul><li>使用：给父级添加overflow属性，将其属性值设置为：hidden, auto 或 scroll</li><li>优缺点：<ul><li>优点：代码简介</li><li>缺点： 无法展示溢出的部分</li></ul></li></ul><h4 id="3-after-伪元素法"><a href="#3-after-伪元素法" class="headerlink" title="3 :after 伪元素法"></a>3 :after 伪元素法</h4><ul><li>使用：after方式是额外标签法的升级版。只需要给父类元素添加：</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.clearfix</span>:after &#123;<br>    content: <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-attribute">display</span>: block;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;<br>    <span class="hljs-attribute">clear</span>: both;<br>    <span class="hljs-attribute">visibility</span>: hidden;<br>&#125;<br><br><span class="hljs-selector-class">.clearfix</span> &#123;<br>    <span class="hljs-comment">/*IE6,IE7*/</span><br>    zoom: <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>优缺点：<ul><li>优点：没有增加标签，结构简单</li><li>缺点：需要照顾低版本浏览器</li></ul></li><li>代表网站：百度，淘宝，网易</li></ul><h4 id="4-双伪元素法"><a href="#4-双伪元素法" class="headerlink" title="4. 双伪元素法"></a>4. 双伪元素法</h4><ul><li>使用：父元素添加：</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.clearfix</span>:before, .clearfix:after &#123;<br>    content: <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-attribute">display</span>: table;<br>&#125;<br><span class="hljs-selector-class">.clearfix</span>:after &#123;<br>    clear: both;<br>&#125;<br><span class="hljs-selector-class">.clearfix</span> &#123;<br>    <span class="hljs-comment">/*IE6,IE7*/</span><br>    zoom: <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>优缺点：<ul><li>优点：代码更简洁</li><li>缺点：需要照顾低版本浏览器</li></ul></li><li>代表网站：小米，腾讯</li></ul>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS盒子模型</title>
    <link href="/CSS%E7%9B%92%E5%AD%90%E6%A8%A1%E5%9E%8B/"/>
    <url>/CSS%E7%9B%92%E5%AD%90%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1-块级元素水平居中"><a href="#1-块级元素水平居中" class="headerlink" title="1 块级元素水平居中"></a>1 块级元素水平居中</h1><ol><li>必须满足两个条件<ul><li>盒子必须指明了宽度</li><li>盒子左右的外边剧都设置为auto</li></ul></li><li>常规写法<ul><li>margin-left: auto ; margin-right: auto</li><li>margin: auto</li><li>margin: 0 auto</li></ul></li></ol><h1 id="2-行内元素或者行内块元素水平居中"><a href="#2-行内元素或者行内块元素水平居中" class="headerlink" title="2 行内元素或者行内块元素水平居中"></a>2 行内元素或者行内块元素水平居中</h1><p>解决方案：给父元素添加： text-align: center</p><h1 id="3-嵌套块元素垂直外边距塌陷"><a href="#3-嵌套块元素垂直外边距塌陷" class="headerlink" title="3 嵌套块元素垂直外边距塌陷"></a>3 嵌套块元素垂直外边距塌陷</h1><p>对于两个嵌套关系（父子关系）的块元素，父元素和子元素同时都有上外边距，此时父元素会塌陷较大的外边距值</p><p>解决方案</p><ul><li>给父元素定义上边框</li><li>给父元素定义上内边距</li><li>给父元素添加：overflow: hidden</li></ul><h1 id="4-清除内外边距"><a href="#4-清除内外边距" class="headerlink" title="4 清除内外边距"></a>4 清除内外边距</h1><p>网页元素很多都带有默认的内外边距，不同的浏览器默认的也不一致。因此我们在布局前，需要清除下网页元素的内外边距。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">* &#123;<br>  padding: 0; /* 清除内边距 */<br>  margin: 0; /* 清除外边距 */<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="5-Padding-会影响盒子的大小"><a href="#5-Padding-会影响盒子的大小" class="headerlink" title="5 Padding 会影响盒子的大小"></a>5 Padding 会影响盒子的大小</h1><ul><li>如果盒子已经有了宽度和高度，此时再指定内边距，会撑大盒子</li></ul><p>​解决方案：让width和height减去多出来的内边距大小</p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h8bv0i7jx1j314g0u0aet.jpg" style="zoom: 33%;" /><ul><li>如果盒子本身没有指定宽度和高度，则此时padding不会撑大盒子</li></ul><h1 id="6-padding-bottom实现普通元素固定宽高比"><a href="#6-padding-bottom实现普通元素固定宽高比" class="headerlink" title="6 padding-bottom实现普通元素固定宽高比"></a>6 padding-bottom实现普通元素固定宽高比</h1><p>将<code>div</code>元素的高度设为了<code>0</code>，通过<code>padding-bottom</code>来撑开盒子的高度</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;father&quot;</span>&gt;<br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;son&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">.father &#123;<br>  <span class="hljs-attr">width</span>: <span class="hljs-number">50</span>%;<br>  background-color: #25a4bb;<br>&#125;<br><br>.son &#123;<br>  <span class="hljs-attr">height</span>: <span class="hljs-number">0</span>;<br>  padding-bottom: <span class="hljs-number">50</span>%; <span class="hljs-comment">//规定基于父元素的宽度的百分比的内边距。</span><br>  background-color: red;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ESLint</title>
    <link href="/ESLint/"/>
    <url>/ESLint/</url>
    
    <content type="html"><![CDATA[<h1 id="1-ESLint是什么？"><a href="#1-ESLint是什么？" class="headerlink" title="1 ESLint是什么？"></a>1 ESLint是什么？</h1><p>ESLint最初是由<a href="http://nczonline.net/">Nicholas C. Zakas</a> 于2013年6月创建的开源项目。它的目标是提供一个插件化的javascript代码检测工具。</p><ul><li>ESLint 的初衷是为了让程序员可以创建自己的检测规则</li><li>ESLint 并不推荐任何编码风格，规则是自由的</li></ul><p><strong>官网：</strong><a href="https://eslint.bootcss.com/">ESLint - 插件化的 JavaScript 代码检测工具 - ESLint中文文档 (bootcss.com)</a></p><h1 id="2-优势"><a href="#2-优势" class="headerlink" title="2 优势"></a>2 优势</h1><h3 id="2-1-避免低级bug，找出可能发生的语法错误"><a href="#2-1-避免低级bug，找出可能发生的语法错误" class="headerlink" title="2.1. 避免低级bug，找出可能发生的语法错误"></a>2.1. 避免低级bug，找出可能发生的语法错误</h3><blockquote><p>使用未声明变量、修改 const 变量……</p></blockquote><h3 id="2-2-提示删除多余的代码"><a href="#2-2-提示删除多余的代码" class="headerlink" title="2.2. 提示删除多余的代码"></a>2.2. 提示删除多余的代码</h3><blockquote><p>声明而未使用的变量、重复的 case ……</p></blockquote><h3 id="2-3-统一团队的代码风格"><a href="#2-3-统一团队的代码风格" class="headerlink" title="2.3. 统一团队的代码风格"></a>2.3. 统一团队的代码风格</h3><blockquote><p>加不加分号？使用 tab 还是空格？</p></blockquote><h1 id="3-ESLint检查语法的规则"><a href="#3-ESLint检查语法的规则" class="headerlink" title="3 ESLint检查语法的规则"></a>3 ESLint检查语法的规则</h1><p><a href="http://eslint.cn/docs/rules/">List of available rules - ESLint中文</a></p><h1 id="4-Eslint-配置"><a href="#4-Eslint-配置" class="headerlink" title="4 Eslint 配置"></a>4 Eslint 配置</h1><p><strong>1 可以通过vue脚手架创建项目时自动下载配置</strong></p><p><strong>2 项目已经创建好，手动下载配置</strong></p><ul><li><p>安装并初始化配置文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">npm install eslint --save-dev   <span class="hljs-comment">// 安装并保存到项目开发依赖</span><br>./node_modules/.bin/eslint -- --init <span class="hljs-comment">// 初始化命令</span><br></code></pre></td></tr></table></figure></li><li><p>ESLint 会询问一系列问题，根据你的回答生成对应的<code>.eslintrc.js</code>配置文件。<img src="https://tva1.sinaimg.cn/large/008vxvgGly1h8bjfywzaxj31k80iqgr7.jpg"></p></li></ul><h1 id="5-配置文件介绍"><a href="#5-配置文件介绍" class="headerlink" title="5 配置文件介绍"></a>5 配置文件介绍</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">module</span>.exports = &#123;<br>    <span class="hljs-string">&quot;env&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;browser&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;es6&quot;</span>: <span class="hljs-literal">true</span><br>    &#125;,<br>    <span class="hljs-string">&quot;extends&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>    <span class="hljs-string">&quot;globals&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;Atomics&quot;</span>: <span class="hljs-string">&quot;readonly&quot;</span>,<br>        <span class="hljs-string">&quot;SharedArrayBuffer&quot;</span>: <span class="hljs-string">&quot;readonly&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;parserOptions&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;ecmaVersion&quot;</span>: <span class="hljs-number">2018</span>,<br>        <span class="hljs-string">&quot;sourceType&quot;</span>: <span class="hljs-string">&quot;module&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;plugins&quot;</span>: [<br>        <span class="hljs-string">&quot;vue&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;rules&quot;</span>: &#123;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="5-1-env"><a href="#5-1-env" class="headerlink" title="5.1 env"></a>5.1 env</h2><p>告诉eslint，当前代码是运行在哪些环境中</p><ul><li><p>开发中经常会用到 一些运行环境自带的 api，如：</p><ul><li><p>浏览器中的 <strong>window&#x2F;document</strong> 等</p></li><li><p>nodejs中的 <strong>__dirname</strong> 等</p></li></ul></li><li><p>如果不指定的话，检查时就会报错</p></li></ul><h2 id="5-2-extends"><a href="#5-2-extends" class="headerlink" title="5.2 extends"></a>5.2 extends</h2><p> 直接使用别人已经写好的 lint 规则，方便快捷。扩展一般支持三种类型：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;extends&quot;</span>: [<br>    <span class="hljs-string">&quot;eslint:recommended&quot;</span>,<br>    <span class="hljs-string">&quot;plugin:react/recommended&quot;</span>,<br>    <span class="hljs-string">&quot;eslint-config-standard&quot;</span>,<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ESLint 官方的扩展:  一共有两个：<code>eslint:recommended</code> 、<code>eslint:all</code></li><li>插件类型。</li><li>npm 包的扩展。官方规定 npm 包的扩展必须以 <code>eslint-config-</code> 开头，使用时可以省略这个头，上面案例中 <code>eslint-config-standard</code> 可以直接简写成 <code>standard</code>。</li></ul><h2 id="5-3-globals"><a href="#5-3-globals" class="headerlink" title="5.3 globals"></a>5.3 globals</h2><p>在 ESLint 中定义全局变量</p><ul><li>当访问当前源文件内未定义的变量时，<a href="https://link.juejin.cn/?target=https://eslint.bootcss.com/docs/rules/no-undef">no-undef</a> 规则将发出警告。</li><li>如果你想在一个源文件里使用全局变量，推荐你在 ESLint 中定义这些全局变量，这样 ESLint 就不会发出警告了。</li></ul><h2 id="5-4-parserOptions"><a href="#5-4-parserOptions" class="headerlink" title="5.4  parserOptions"></a>5.4  parserOptions</h2><p>ESLint 解析器 解析代码时，可以指定 用哪个 js 的版本</p><ul><li>ecmaVersion： <em>你可以使用 6、7、8、9 或 10 来指定你想要使用的 ECMAScript 版本。你也可以用使用年份命名的版本号指定为 2015（同 6），2016（同 7），或 2017（同 8）或 2018（同 9）或 2019 (same as 10)</em></li><li>sourceType： sourceType 有两个值，script 和 module。 对于 ES6+ 的语法和用 import &#x2F; export 的语法必须用 module.</li></ul><h2 id="5-5-plugins"><a href="#5-5-plugins" class="headerlink" title="5.5 plugins"></a>5.5 plugins</h2><p>许多 ESLint 插件为使用特定的库和框架提供了额外的规则。</p><ul><li><p>官方的规则只能检查标准的 JavaScript 语法，如果你写的是 JSX 或者 Vue 单文件组件，就需要安装 ESLint 的插件，来定制一些特定的规则进行检查。</p></li><li><p>ESLint 的插件与扩展一样有固定的命名格式，以 <code>eslint-plugin-</code> 开头，使用的时候也可以省略这个头。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;plugins&quot;</span>: [<br>    <span class="hljs-string">&quot;react&quot;</span>, <span class="hljs-comment">// eslint-plugin-react</span><br>    <span class="hljs-string">&quot;vue&quot;</span>,   <span class="hljs-comment">// eslint-plugin-vue</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>或者是在扩展中引入插件，前面有提到 <code>plugin:</code> 开头的是扩展是进行插件的加载。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;extends&quot;</span>: [<br>    <span class="hljs-string">&quot;plugin:react/recommended&quot;</span>,<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-6-rules"><a href="#5-6-rules" class="headerlink" title="5.6 rules"></a>5.6 rules</h2><p>ESLint 附带有<a href="https://link.zhihu.com/?target=https://cn.eslint.org/docs/rules/">大量的规则</a>，你可以在配置文件的 <code>rules</code> 属性中配置你想要的规则</p>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>代码规范</tag>
      
      <tag>eslint</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java泛型</title>
    <link href="/Java%E6%B3%9B%E5%9E%8B/"/>
    <url>/Java%E6%B3%9B%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1-泛型概念"><a href="#1-泛型概念" class="headerlink" title="1.泛型概念"></a>1.泛型概念</h1><h2 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h2><p>泛型是JDK5中引入的特性，可以在编译阶段约束操作的数据类型，并进行检查</p><ul><li>java范型在生成字节码的时候会进行擦除</li><li>范型格式：<code>&lt;数据类型&gt;</code></li><li>注意：泛型只能支持引用数据类型，因为定义的范型，其实在存入的时候还是会变成Object类型，而基本数据类型，不可以变成Object类型</li><li>指定范型类型后，可以传入该类类型及其子类类型</li></ul><h2 id="1-2-好处"><a href="#1-2-好处" class="headerlink" title="1.2 好处"></a>1.2 好处</h2><ul><li>统一数据类型</li><li>运行时期的问题，提到了编译期间，避免了强制类型转换出现的异常。</li></ul><h1 id="2-使用场景"><a href="#2-使用场景" class="headerlink" title="2 使用场景"></a>2 使用场景</h1><h2 id="2-1-范型类"><a href="#2-1-范型类" class="headerlink" title="2.1 范型类"></a>2.1 范型类</h2><h3 id="2-1-定义"><a href="#2-1-定义" class="headerlink" title="2.1 定义"></a>2.1 定义</h3><p>当编写一个类时，如果不确定类型，那么这个类就称为范型类,.如： ArrayList</p><ul><li>创建这个类的时候，就可以确定类型</li><li>这里的类型可以定义为变量，是用来记录数据的类型的，可以写成T，E，K , V，也可以写成其他变量</li></ul><h3 id="2-2-格式"><a href="#2-2-格式" class="headerlink" title="2.2 格式"></a>2.2 格式</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">修饰符 <span class="hljs-keyword">class</span> 类名&lt;<span class="hljs-symbol">E</span>&gt;&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-示例"><a href="#2-3-示例" class="headerlink" title="2.3 示例"></a>2.3 示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyArray</span>&lt;<span class="hljs-title">E</span>&gt; </span>&#123;<br>  Object[] obj = <span class="hljs-keyword">new</span> Object[<span class="hljs-number">10</span>];<br>  <span class="hljs-keyword">int</span> size;<br><br>  <span class="hljs-comment">// E表示不确定的类型，该类型在类后面定义过了</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>    obj[size] = e;<br>    size++;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> (E) obj[index];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>  MyArray&lt;String&gt; myArray = <span class="hljs-keyword">new</span> MyArray&lt;&gt;();<br>  myArray.add(<span class="hljs-string">&quot;q&quot;</span>);<br>  System.out.println(myArray.get(<span class="hljs-number">0</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-范型方法"><a href="#2-2-范型方法" class="headerlink" title="2.2 范型方法"></a>2.2 范型方法</h2><h3 id="2-2-1-使用类型后面定义的类型"><a href="#2-2-1-使用类型后面定义的类型" class="headerlink" title="2.2.1 使用类型后面定义的类型"></a>2.2.1 使用类型后面定义的类型</h3><ul><li><p>方法中形参类型不确定时，可以使用类型后面定义的类型。</p></li><li><p>所有的方法都可以使用这个类型</p></li></ul><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyArray</span>&lt;<span class="hljs-title">E</span>&gt; </span>&#123;    <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> (E) obj[index];<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-2-在方法上定义自己的类型"><a href="#2-2-2-在方法上定义自己的类型" class="headerlink" title="2.2.2 在方法上定义自己的类型"></a>2.2.2 <strong>在方法上定义自己的类型</strong></h3><p>只能在本方法中使用</p><h4 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">修饰符&lt;E&gt; 返回值类型 方法名(类型 变量名)&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span>&lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">(T t)</span></span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">List&lt;T&gt; <span class="hljs-title">buildList</span><span class="hljs-params">(T... t)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> Arrays.asList(t);<br>&#125;<br><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getValue</span><span class="hljs-params">(T t)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> t;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>  List&lt;Integer&gt; integers = buildList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);<br>  System.out.println(integers);<br><br>  Integer value = getValue(<span class="hljs-number">1</span>);<br>  System.out.println(value);<br><br>  String str = getValue(<span class="hljs-string">&quot;111&quot;</span>);<br>  System.out.println(str);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-范型接口"><a href="#2-3-范型接口" class="headerlink" title="2.3 范型接口"></a>2.3 范型接口</h2><p>当编写一个接口时，如果不确定类型，那么这个类就称为范型接口，如： list</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">修饰符 <span class="hljs-class"><span class="hljs-keyword">interface</span> 接口名&lt;<span class="hljs-title">E</span>&gt;</span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">修饰符 <span class="hljs-class"><span class="hljs-keyword">interface</span> 接口名&lt;<span class="hljs-title">E</span>&gt;</span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-使用一：-实现类给出具体类型"><a href="#1-使用一：-实现类给出具体类型" class="headerlink" title="1 使用一： 实现类给出具体类型"></a>1 使用一： 实现类给出具体类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyList</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">String</span>&gt; </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(String s)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>  MyList list = <span class="hljs-keyword">new</span> MyList();<br>  list.add(<span class="hljs-string">&quot;string&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-使用二：实现类继续延续泛型，创建对象时再确定"><a href="#2-使用二：实现类继续延续泛型，创建对象时再确定" class="headerlink" title="2 使用二：实现类继续延续泛型，创建对象时再确定"></a>2 使用二：实现类继续延续泛型，创建对象时再确定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyList2</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">E</span>&gt; </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>  MyList2&lt;String&gt; list2 = <span class="hljs-keyword">new</span> MyList2();<br>  list2.add(<span class="hljs-string">&quot;string&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-泛型通配符"><a href="#3-泛型通配符" class="headerlink" title="3 泛型通配符"></a>3 泛型通配符</h1><ul><li><p><code>?</code>可以表示不确定的类型</p></li><li><p><code>? extends E</code>: 表示只能传递E或者E的子类</p></li><li><p><code>? super E</code>: 表示只能传递E或者E的父类</p></li></ul><h2 id="3-1-示例"><a href="#3-1-示例" class="headerlink" title="3.1 示例"></a>3.1 示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Father</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> String id;<br>  <span class="hljs-keyword">public</span> String name;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Father</span><span class="hljs-params">(String id, String name)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.id = id;<br>    <span class="hljs-keyword">this</span>.name = name;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">study</span><span class="hljs-params">()</span></span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;学习状态中------&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Son</span><span class="hljs-params">(String id, String name)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(id, name);<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GrandSon</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Son</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GrandSon</span><span class="hljs-params">(String id, String name)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(id, name);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>? extends Son</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">study</span><span class="hljs-params">(List&lt;? extends Son&gt; array)</span> </span>&#123;<br>        array.forEach(Son::study);<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h80c7s1nt7j30p20cmgmq.jpg" style="zoom:50%;" /><ul><li>? extends Son</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">study</span><span class="hljs-params">(List&lt;? <span class="hljs-keyword">super</span> Son&gt; array)</span> </span>&#123;<br>  array.forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h80cw8fu3wj30p00bumy2.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>泛型</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ES6语法学习笔记</title>
    <link href="/ES6%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/ES6%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Let和const"><a href="#1-Let和const" class="headerlink" title="1 Let和const"></a>1 Let和const</h1><ul><li>Let:  所声明的变量，只在let命令所在的代码块内有效。</li><li><code>const</code>声明一个只读的<code>常量</code>。一旦声明，常量的值就不能改变。const一旦声明变量，就必须立即<code>初始化</code>，不能留到以后赋值。类似final</li></ul><h1 id="2-解构赋值"><a href="#2-解构赋值" class="headerlink" title="2 解构赋值"></a>2 解构赋值</h1><ul><li>ES6 允许按照一定模式，从<strong>数组和对象</strong>中提取值，对变量进行赋值，这被称为<code>解构</code>（Destructuring）。</li><li>本质上，这种写法属于<code>“模式匹配”</code>，只要等号两边的模式相同，左边的变量就会被赋予对应的值</li></ul><h2 id="2-1-数组的解构赋值"><a href="#2-1-数组的解构赋值" class="headerlink" title="2.1  数组的解构赋值"></a>2.1  数组的解构赋值</h2><ul><li><p>可以从数组中提取值，按照对应位置，对变量赋值。</p></li><li><p>数组的元素是按次序排列的，变量的取值由它的位置决定</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> [a, b, c] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br><br><span class="hljs-keyword">let</span> [ , , third] = [<span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>, <span class="hljs-string">&quot;baz&quot;</span>];<br><br><span class="hljs-keyword">let</span> [head, ...tail] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];<br>head <span class="hljs-comment">// 1</span><br>tail <span class="hljs-comment">// [2, 3, 4]</span><br><br><span class="hljs-keyword">let</span> [x, y, ...z] = [<span class="hljs-string">&#x27;a&#x27;</span>];<br>x <span class="hljs-comment">// &quot;a&quot;</span><br>y <span class="hljs-comment">// undefined</span><br>z <span class="hljs-comment">// []</span><br><br><span class="hljs-keyword">let</span> [x, y, z] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>([<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>])<br></code></pre></td></tr></table></figure></li><li><p>解构赋值<code>允许指定</code>默认值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> [foo = <span class="hljs-literal">true</span>] = [];<br>foo <span class="hljs-comment">// true</span><br><span class="hljs-keyword">let</span> [x, y = <span class="hljs-string">&#x27;b&#x27;</span>] = [<span class="hljs-string">&#x27;a&#x27;</span>]; <span class="hljs-comment">// x=&#x27;a&#x27;, y=&#x27;b&#x27;</span><br><br><span class="hljs-comment">// 只有当一个数组成员严格等于undefined，默认值才会生效。</span><br><span class="hljs-keyword">let</span> [x, y = <span class="hljs-string">&#x27;b&#x27;</span>] = [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-literal">undefined</span>]; <span class="hljs-comment">// x=&#x27;a&#x27;, y=&#x27;b&#x27;</span><br><br><span class="hljs-keyword">let</span> [x = <span class="hljs-number">1</span>] = [<span class="hljs-literal">null</span>];<br>x <span class="hljs-comment">// null</span><br></code></pre></td></tr></table></figure><h2 id="2-2-对象的解构赋值"><a href="#2-2-对象的解构赋值" class="headerlink" title="2.2 对象的解构赋值"></a>2.2 对象的解构赋值</h2><ul><li>对象的属性没有次序，<code>变量</code>必须与<code>属性</code>同名，才能取到正确的值。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> &#123; foo, bar &#125; = &#123; <span class="hljs-attr">foo</span>: <span class="hljs-string">&#x27;aaa&#x27;</span>, <span class="hljs-attr">bar</span>: <span class="hljs-string">&#x27;bbb&#x27;</span> &#125;;<br>foo <span class="hljs-comment">// &quot;aaa&quot;</span><br>bar <span class="hljs-comment">// &quot;bbb&quot;</span><br><br><span class="hljs-keyword">let</span> &#123;foo&#125; = &#123;<span class="hljs-attr">bar</span>: <span class="hljs-string">&#x27;baz&#x27;</span>&#125;;<br>foo <span class="hljs-comment">// undefined</span><br><br><span class="hljs-keyword">const</span> &#123; log &#125; = <span class="hljs-built_in">console</span>;<br>log(<span class="hljs-string">&#x27;hello&#x27;</span>) <span class="hljs-comment">// hello</span><br></code></pre></td></tr></table></figure><p>如果变量名与属性名不一致，必须写成下面这样。</p><p>foo是匹配的模式，baz才是变量。真正被赋值的是变量baz，而不是模式foo。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> &#123; <span class="hljs-attr">foo</span>: baz &#125; = &#123; <span class="hljs-attr">foo</span>: <span class="hljs-string">&#x27;aaa&#x27;</span>, <span class="hljs-attr">bar</span>: <span class="hljs-string">&#x27;bbb&#x27;</span> &#125;;<br>baz <span class="hljs-comment">// &quot;aaa&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>解构也可以用于嵌套结构的对象</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> obj = &#123;<br>  <span class="hljs-attr">p</span>: [<br>    <span class="hljs-string">&#x27;Hello&#x27;</span>,<br>    &#123; <span class="hljs-attr">y</span>: <span class="hljs-string">&#x27;World&#x27;</span> &#125;<br>  ]<br>&#125;;<br><span class="hljs-keyword">let</span> &#123; <span class="hljs-attr">p</span>: [x, &#123; y &#125;] &#125; = obj;<br>x <span class="hljs-comment">// &quot;Hello&quot;</span><br>y <span class="hljs-comment">// &quot;World&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>对象<code>的</code>解构<code>也可以指定</code>默认值</p><ul><li>默认值生效的条件是，对象的<code>属性值</code>严格等于<code>undefined</code>。</li><li>null与undefined不严格相等，所以是个有效的赋值，导致默认值不会生效。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> &#123;x, y = <span class="hljs-number">5</span>&#125; = &#123;<span class="hljs-attr">x</span>: <span class="hljs-number">1</span>&#125;;<br>x <span class="hljs-comment">// 1</span><br>y <span class="hljs-comment">// 5</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="2-3-字符串的解构赋值"><a href="#2-3-字符串的解构赋值" class="headerlink" title="2.3 字符串的解构赋值"></a>2.3 字符串的解构赋值</h2><ul><li>字符串被转换成了一个类似数组的对象</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> [a, b, c, d, e] = <span class="hljs-string">&#x27;hello&#x27;</span>;<br></code></pre></td></tr></table></figure><ul><li>类似数组的对象都有一个<code>length</code>属性，因此还可以对这个属性解构赋值</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> &#123;<span class="hljs-attr">length</span> : len&#125; = <span class="hljs-string">&#x27;hello&#x27;</span>;<br>len <span class="hljs-comment">// 5</span><br></code></pre></td></tr></table></figure><h2 id="2-4-用途"><a href="#2-4-用途" class="headerlink" title="2.4 用途"></a>2.4 用途</h2><ol><li><strong>交换变量的值</strong></li></ol><p>交换变量<code>x</code>和<code>y</code>的值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">[x, y] = [y, x];<br></code></pre></td></tr></table></figure><ol start="2"><li><p><strong>从函数返回多个值</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 返回一个数组</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">example</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>&#125;<br><span class="hljs-keyword">let</span> [a, b, c] = example();<br><br><span class="hljs-comment">// 返回一个对象</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">example</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">bar</span>: <span class="hljs-number">2</span><br>  &#125;;<br>&#125;<br><span class="hljs-keyword">let</span> &#123; foo, bar &#125; = example();<br></code></pre></td></tr></table></figure></li><li><p><strong>提取 JSON 数据</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> jsonData = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-number">42</span>,<br>  <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;OK&quot;</span>,<br>  <span class="hljs-attr">data</span>: [<span class="hljs-number">867</span>, <span class="hljs-number">5309</span>]<br>&#125;;<br><span class="hljs-keyword">let</span> &#123; id, status, <span class="hljs-attr">data</span>: number &#125; = jsonData;<br><span class="hljs-built_in">console</span>.log(id, status, number);<br><span class="hljs-comment">// 42, &quot;OK&quot;, [867, 5309]</span><br></code></pre></td></tr></table></figure></li><li><p><strong>遍历 Map 结构</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [key, value] <span class="hljs-keyword">of</span> map) &#123;<br>  <span class="hljs-built_in">console</span>.log(key + <span class="hljs-string">&quot; is &quot;</span> + value);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取键名</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [key] <span class="hljs-keyword">of</span> map) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-comment">// 获取键值</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [,value] <span class="hljs-keyword">of</span> map) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>输入模块的指定方法</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; SourceMapConsumer, SourceNode &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;source-map&quot;</span>);<br></code></pre></td></tr></table></figure></li></ol><h1 id="3-函数的扩展"><a href="#3-函数的扩展" class="headerlink" title="3. 函数的扩展"></a>3. 函数的扩展</h1><h2 id="3-1-参数设置默认值"><a href="#3-1-参数设置默认值" class="headerlink" title="3.1 参数设置默认值"></a>3.1 参数设置默认值</h2><ul><li><p>ES6 允许为函数的参数设置默认值，即直接写在参数定义的后面。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">x, y = <span class="hljs-string">&#x27;World&#x27;</span></span>) </span>&#123;<br>  <span class="hljs-built_in">console</span>.log(x, y);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params">&#123;x, y = <span class="hljs-number">5</span>&#125;</span>) </span>&#123;<br>  <span class="hljs-built_in">console</span>.log(x, y);<br>&#125;<br>foo(&#123;&#125;) <span class="hljs-comment">// undefined 5</span><br>foo(&#123;<span class="hljs-attr">x</span>: <span class="hljs-number">1</span>&#125;) <span class="hljs-comment">// 1 5</span><br>foo(&#123;<span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">2</span>&#125;) <span class="hljs-comment">// 1 2</span><br></code></pre></td></tr></table></figure></li><li><p>由于大括号被解释为代码块，所以如果箭头函数直接返回一个对象，必须在对象外面加上括号，否则会报错。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> getTempItem = <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> (&#123; <span class="hljs-attr">id</span>: id, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Temp&quot;</span> &#125;);<br></code></pre></td></tr></table></figure></li><li><p>ES6 引入<code>rest 参数</code>（形式为 …变量名 ），用于获取函数的多余参数，这样就不需要使用 arguments 对象了。rest 参数搭配的变量是一个<code>数组</code>，该变量将多余的参数放入数组中。</p><p>⚠️： rest 参数之后不能再有其他参数（即只能是最后一个参数），否则会报错。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">...values</span>) </span>&#123;<br>  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> val <span class="hljs-keyword">of</span> values) &#123;<br>    sum += val;<br>  &#125;<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br><br><span class="hljs-comment">// 利用 rest 参数，可以向该函数传入任意数目的参数。</span><br>add(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>) <span class="hljs-comment">// 10</span><br></code></pre></td></tr></table></figure></li></ul><h1 id="4-数组的扩展"><a href="#4-数组的扩展" class="headerlink" title="4 数组的扩展"></a>4 数组的扩展</h1><p><code>扩展运算符</code>（spread）是三个点（ … ）。它好比 rest 参数的逆运算，将一个数组转为用逗号分隔的参数序列。</p><p><strong>任何定义了遍历器（Iterator）接口的对象（参阅 Iterator 一章），都可以用扩展运算符转为真正的数组。</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">console</span>.log(...[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br><span class="hljs-comment">// 1 2 3</span><br></code></pre></td></tr></table></figure><p>用途：</p><ul><li><p>该运算符主要用于<code>函数调用</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">x, y</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> x + y;<br>&#125;<br><br><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">4</span>, <span class="hljs-number">38</span>];<br>add(...numbers) <span class="hljs-comment">// 42</span><br></code></pre></td></tr></table></figure></li><li><p>应用 Math.max 方法，简化求出一个数组最大元素的写法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">Math</span>.max(...[<span class="hljs-number">14</span>, <span class="hljs-number">3</span>, <span class="hljs-number">77</span>])<br></code></pre></td></tr></table></figure></li><li><p>push 函数，将一个数组添加到另一个数组的尾部。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> arr1 = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>];<br><span class="hljs-keyword">let</span> arr2 = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br>arr1.push(...arr2);<br></code></pre></td></tr></table></figure></li><li><p>复制数组</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> a1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>];<br><span class="hljs-comment">// 写法一</span><br><span class="hljs-keyword">const</span> a2 = [...a1];<br><span class="hljs-comment">// 写法二</span><br><span class="hljs-keyword">const</span> [...a2] = a1;<br></code></pre></td></tr></table></figure></li><li><p><strong>合并数组</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> arr1 = [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>];<br><span class="hljs-keyword">const</span> arr2 = [<span class="hljs-string">&#x27;c&#x27;</span>];<br><span class="hljs-keyword">const</span> arr3 = [<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>];<br>[...arr1, ...arr2, ...arr3]<br><span class="hljs-comment">// [ &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27; ]</span><br></code></pre></td></tr></table></figure></li><li><p><strong>与解构赋值结合</strong>，<strong>生成数组</strong></p><p>如果将扩展运算符用于数组赋值，只能放在参数的最后一位，否则会报错。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> [first, ...rest] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br>first <span class="hljs-comment">// 1</span><br>rest  <span class="hljs-comment">// [2, 3, 4, 5]</span><br><br><span class="hljs-keyword">const</span> [first, ...rest] = [];<br>first <span class="hljs-comment">// undefined</span><br>rest  <span class="hljs-comment">// []</span><br><br><span class="hljs-keyword">const</span> [first, ...rest] = [<span class="hljs-string">&quot;foo&quot;</span>];<br>first  <span class="hljs-comment">// &quot;foo&quot;</span><br>rest   <span class="hljs-comment">// []</span><br></code></pre></td></tr></table></figure></li><li><p>将<code>字符串</code>转为真正的<code>数组</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">[...<span class="hljs-string">&#x27;hello&#x27;</span>]<br><span class="hljs-comment">// [ &quot;h&quot;, &quot;e&quot;, &quot;l&quot;, &quot;l&quot;, &quot;o&quot; ]</span><br></code></pre></td></tr></table></figure></li><li><p>map获取key</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> map = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>([<br>  [<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;one&#x27;</span>],<br>  [<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;two&#x27;</span>],<br>  [<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;three&#x27;</span>],<br>]);<br><span class="hljs-keyword">let</span> arr = [...map.keys()]; <span class="hljs-comment">// [1, 2, 3]</span><br></code></pre></td></tr></table></figure></li></ul><h1 id="5-对象的扩展"><a href="#5-对象的扩展" class="headerlink" title="5 对象的扩展"></a>5 对象的扩展</h1><h2 id="5-1-属性的简洁表示法"><a href="#5-1-属性的简洁表示法" class="headerlink" title="5.1 属性的简洁表示法"></a>5.1 属性的简洁表示法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">x, y</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> &#123;x, y&#125;;<br>&#125;<br><br><span class="hljs-comment">// 等同于</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">x, y</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> &#123;<span class="hljs-attr">x</span>: x, <span class="hljs-attr">y</span>: y&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> Person = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;张三&#x27;</span>,<br>  <span class="hljs-comment">//等同于birth: birth</span><br>  birth,<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-2-日志的打印"><a href="#5-2-日志的打印" class="headerlink" title="5.2 日志的打印"></a>5.2 日志的打印</h2><p>输出 user 和 foo 两个对象时，就是两组键值对，可能会混淆。把它们放在大括号里面输出，就变成了对象的简洁表示法，每组键值对前面会打印对象名，这样就比较清晰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> user = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;test&#x27;</span><br>&#125;;<br><span class="hljs-keyword">let</span> foo = &#123;<br>  <span class="hljs-attr">bar</span>: <span class="hljs-string">&#x27;baz&#x27;</span><br>&#125;;<br><br><span class="hljs-built_in">console</span>.log(user, foo)<br><span class="hljs-comment">// &#123;name: &quot;test&quot;&#125; &#123;bar: &quot;baz&quot;&#125;</span><br><span class="hljs-built_in">console</span>.log(&#123;user, foo&#125;)<br><span class="hljs-comment">// &#123;user: &#123;name: &quot;test&quot;&#125;, foo: &#123;bar: &quot;baz&quot;&#125;&#125;</span><br></code></pre></td></tr></table></figure><h2 id="5-3-解构赋值"><a href="#5-3-解构赋值" class="headerlink" title="5.3 解构赋值"></a>5.3 解构赋值</h2><ul><li><p>对象的<code>解构赋值</code>用于从一个对象<code>取值</code>，所有的键和它们的值，都会拷贝到新对象上面。</p></li><li><p>解构赋值要求等号右边是一个对象，所以如果等号右边是 undefined 或 null ，就会报错，因为它们无法转为对象。</p></li><li><p>解构赋值必须是最后一个参数，否则会报错。</p></li><li><p>解构赋值<code>的拷贝是</code>浅拷贝</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> &#123; x, y, ...z &#125; = &#123; <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">a</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">4</span> &#125;;<br>x <span class="hljs-comment">// 1</span><br>y <span class="hljs-comment">// 2</span><br>z <span class="hljs-comment">// &#123; a: 3, b: 4 &#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> z = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">4</span> &#125;;<br><span class="hljs-keyword">let</span> n = &#123; ...z &#125;;<br>n <span class="hljs-comment">// &#123; a: 3, b: 4 &#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> foo = &#123; ...[<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>] &#125;;<br>foo<br><span class="hljs-comment">// &#123;0: &quot;a&quot;, 1: &quot;b&quot;, 2: &quot;c&quot;&#125;</span><br></code></pre></td></tr></table></figure><ul><li>如果扩展运算符后面是字符串，它会自动转成一个类似数组的对象</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;...<span class="hljs-string">&#x27;hello&#x27;</span>&#125;<br><span class="hljs-comment">// &#123;0: &quot;h&quot;, 1: &quot;e&quot;, 2: &quot;l&quot;, 3: &quot;l&quot;, 4: &quot;o&quot;&#125;</span><br></code></pre></td></tr></table></figure><h2 id="5-4-链判断运算符"><a href="#5-4-链判断运算符" class="headerlink" title="5.4 链判断运算符"></a>5.4 链判断运算符</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> firstName = message?.body?.user?.firstName || <span class="hljs-string">&#x27;default&#x27;</span>;<br></code></pre></td></tr></table></figure><p>?. 运算符，直接在链式调用的时候判断，左侧的对象是否为 null 或 undefined 。如果是的，就不再往下运算，而是返回 undefined </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js">a?.b<br><span class="hljs-comment">// 等同于</span><br>a == <span class="hljs-literal">null</span> ? <span class="hljs-literal">undefined</span> : a.b<br>a?.[x]<br><span class="hljs-comment">// 等同于</span><br>a == <span class="hljs-literal">null</span> ? <span class="hljs-literal">undefined</span> : a[x]<br>a?.b()<br><span class="hljs-comment">// 等同于</span><br>a == <span class="hljs-literal">null</span> ? <span class="hljs-literal">undefined</span> : a.b()<br>a?.()<br><span class="hljs-comment">// 等同于</span><br>a == <span class="hljs-literal">null</span> ? <span class="hljs-literal">undefined</span> : a()<br><br>表单可能没有 checkValidity 这个方法，这时 ?. 运算符就会返回 <span class="hljs-literal">undefined</span> ，判断语句就变成了 <span class="hljs-literal">undefined</span> === <span class="hljs-literal">false</span> ，所以就会跳过下面的代码。<br><span class="hljs-keyword">if</span> (myForm.checkValidity?.() === <span class="hljs-literal">false</span>) &#123;<br>  <span class="hljs-comment">// 表单校验失败</span><br>  <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-5-判断运算符"><a href="#5-5-判断运算符" class="headerlink" title="5.5   ?? 判断运算符"></a>5.5   ?? 判断运算符</h2><p> <code>||</code>: 左侧的值如果为 null，undefined，空字符串， false ， 0 ，默认值会生效</p><p><code>??</code>: 左侧的值为 null 或 undefined 时，默认值会生效</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> headerText = response.settings.headerText || <span class="hljs-string">&#x27;Hello, world!&#x27;</span>;<br><span class="hljs-keyword">const</span> headerText = response.settings.headerText ?? <span class="hljs-string">&#x27;Hello, world!&#x27;</span>;<br></code></pre></td></tr></table></figure><h1 id="6-对象的新增方法"><a href="#6-对象的新增方法" class="headerlink" title="6 对象的新增方法"></a>6 对象的新增方法</h1><h2 id="6-1-Object-is"><a href="#6-1-Object-is" class="headerlink" title="6.1 Object.is()"></a>6.1 Object.is()</h2><ul><li><p><code>严格相等运算符</code>（ &#x3D;&#x3D;&#x3D; ） </p><ul><li>类型不同，直接返回false</li><li>两个复合类型（对象、数组、函数）的数据比较时，不是比较它们的值是否相等，而是比较它们是否指向同一个对象。</li><li>同一类型的原始类型的值（数值、字符串、布尔值）比较时，值相同就返回true，值不同就返回false</li><li>undefined 和 null 与自身严格相等</li></ul></li><li><p><code>相等运算符</code>（ &#x3D;&#x3D; ）</p><ul><li>在比较不同类型的数据时，相等运算符会先将数据进行类型转换，然后再用严格相等运算符比较</li></ul></li><li><p>Object.is()</p><ul><li><p>它用来比较两个值是否严格相等，与严格比较运算符（&#x3D;&#x3D;&#x3D;）的行为基本一致。</p></li><li><p>不同之处只有两个：一是 +0 不等于 -0 ，二是 NaN 等于自身。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">Object</span>.is(+<span class="hljs-number">0</span>, -<span class="hljs-number">0</span>) <span class="hljs-comment">// false</span><br><span class="hljs-built_in">Object</span>.is(<span class="hljs-literal">NaN</span>, <span class="hljs-literal">NaN</span>) <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="6-2-Object-assign"><a href="#6-2-Object-assign" class="headerlink" title="6.2 Object.assign()"></a>6.2 Object.assign()</h2><p>Object.assign方法用于对象的合并，将源对象（source）的所有可枚举属性，复制到目标对象（target）</p><ul><li><code>Object.assign</code>方法实行的是<code>浅拷贝</code>，</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> target = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> &#125;;<br><span class="hljs-keyword">const</span> source1 = &#123; <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> &#125;;<br><span class="hljs-keyword">const</span> source2 = &#123; <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> &#125;;<br><span class="hljs-built_in">Object</span>.assign(target, source1, source2);<br>target <span class="hljs-comment">// &#123;a:1, b:2, c:3&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>es6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bootstrap基本样式</title>
    <link href="/bootstrap%E5%9F%BA%E6%9C%AC%E6%A0%B7%E5%BC%8F/"/>
    <url>/bootstrap%E5%9F%BA%E6%9C%AC%E6%A0%B7%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="边框"><a href="#边框" class="headerlink" title="边框"></a>边框</h1><ul><li>class&#x3D;”border”  添加边框属性，</li><li>class&#x3D;”border-top” 显示指定边框。</li><li>class&#x3D;””border-0”：边框-删除</li><li>class&#x3D;”border-top-0“： 删除或显示特定边框</li><li><code>.rounded</code>元素可以轻松的定义四个圆角的孤度及显示效果</li></ul><h1 id="文本颜色"><a href="#文本颜色" class="headerlink" title="文本颜色"></a>文本颜色</h1><ul><li>.text-danger</li><li>.text-secondary</li><li>.text-success</li></ul><p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h7ku4yzhrwj305n05fjrb.jpg"></p><h1 id="Flex弹性布局"><a href="#Flex弹性布局" class="headerlink" title="Flex弹性布局"></a>Flex弹性布局</h1><ul><li><p><code>d-flex </code>将 <strong>直属内部子元素</strong> 转换为flex属性</p></li><li><p><code>.flex-row</code> 可设置子元素水平方向排版呈现【单行】</p></li><li><p><code>.flex-row-reverse</code> 可实现元素在水平上作反方向排列, 右对齐</p></li><li><p><code>.flex-column</code> 设置垂直方向布局</p></li><li><p><code>.flex-column-reverse</code> 实现垂直方向的反转布局（从底向上铺开）</p></li><li><p><code>justify-content-*</code> 通用样式可以改变flx项目在主轴上的对齐，选方向（值）包括： <code>start</code> (浏览器默认值),、<code>end</code>、 <code>center</code>、 <code>between</code>、 <code>around</code></p></li><li><p><code>.flex-fill</code>在一系列兄弟元素上使用该类来强制它们变成相等的宽度，同时占据所有可用的水平空间。<a href="https://getbootstrap.net/docs/4.1/components/navs/#working-with-flex-utilities">特别适用于等宽或正确的导航。</a></p></li><li><p>向右推两个项目(<code>.mr-auto</code>)、向左推两个项目 (<code>.ml-auto</code>)，<strong>IE10和IE11不能正确支持在父层具有非默认的 <code>justify-content</code> 值自边距浮动auto margin</strong> </p><p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h7ksut55d5j30vj01m0sm.jpg"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;d-flex&quot;</span>&gt;<br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;mr-auto p-2&quot;</span>&gt;</span>Flex item<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;p-2&quot;</span>&gt;</span>Flex item<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;p-2&quot;</span>&gt;</span>Flex item<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p><code>order-*</code>排序方法的响应式属性：</p></li><li><p><code>align-content</code> 通用样式定义，可以将flex物价于横轴上 <em>一起对齐</em>，适用于多行的Flex项目</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring Data JPA 使用JPQL和SQL</title>
    <link href="/Spring-Data-JPA-%E4%BD%BF%E7%94%A8JPQL%E5%92%8CSQL/"/>
    <url>/Spring-Data-JPA-%E4%BD%BF%E7%94%A8JPQL%E5%92%8CSQL/</url>
    
    <content type="html"><![CDATA[<h1 id="2-spring-Data-JPA-使用JPQL"><a href="#2-spring-Data-JPA-使用JPQL" class="headerlink" title="2 spring Data JPA 使用JPQL"></a>2 spring Data JPA 使用JPQL</h1><p>JPQL（Java Presistence Query Language ）是EJB3.0中的JPA造出来的对象查询语言。JPQL是完全面向对象的，具备继承、多态和关联等特性，和hibernate HQL很相似。</p><ul><li>Repository 方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr.repositories;<br><br><span class="hljs-keyword">import</span> org.pyr.entity.Customer;<br><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.Modifying;<br><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.Query;<br><span class="hljs-keyword">import</span> org.springframework.data.repository.PagingAndSortingRepository;<br><span class="hljs-keyword">import</span> org.springframework.data.repository.query.Param;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CustomerJPQLRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PagingAndSortingRepository</span>&lt;<span class="hljs-title">Customer</span>, <span class="hljs-title">Long</span>&gt; </span>&#123;<br><br>    <span class="hljs-meta">@Query(&quot;From Customer where custName = :custName&quot;)</span><br>    <span class="hljs-function">Customer <span class="hljs-title">findCustomerByCustName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;custName&quot;)</span> String custName)</span></span>;<br><br>    <span class="hljs-meta">@Query(&quot;From Customer where custName = ?1&quot;)</span><br>    <span class="hljs-function">Customer <span class="hljs-title">findCustomerByCustName2</span><span class="hljs-params">(String custName)</span></span>;<br><br>    <span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// 通常在业务逻辑中service增加，而不是这里</span><br>    <span class="hljs-meta">@Modifying</span><br>    <span class="hljs-meta">@Query(&quot;UPDATE Customer set custName = :custName where custId = :custId&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateCutomserNameById</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;custName&quot;)</span> String custName, <span class="hljs-meta">@Param(&quot;custId&quot;)</span> <span class="hljs-keyword">long</span> custId)</span></span>;<br><br>    <span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// 通常在业务逻辑中service增加，而不是这里</span><br>    <span class="hljs-meta">@Modifying</span><br>    <span class="hljs-meta">@Query(&quot;DELETE from Customer where custId = :custId&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteCutomserById</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;custId&quot;)</span> <span class="hljs-keyword">long</span> custId)</span></span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>测试方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.pyr.config.JPAConfig;<br><span class="hljs-keyword">import</span> org.pyr.entity.Customer;<br><span class="hljs-keyword">import</span> org.pyr.repositories.CustomerJPQLRepository;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.test.context.ContextConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br><br><span class="hljs-meta">@ContextConfiguration(classes = JPAConfig.class)</span><br><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JPATest2</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    CustomerJPQLRepository customerJPQLRepository;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindByName</span><span class="hljs-params">()</span></span>&#123;<br>        Customer customer = customerJPQLRepository.findCustomerByCustName(<span class="hljs-string">&quot;徐庶143&quot;</span>);<br>        System.out.println(customer);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindById</span><span class="hljs-params">()</span></span>&#123;<br>        Customer customer = customerJPQLRepository.findCustomerByCustName2(<span class="hljs-string">&quot;徐庶143&quot;</span>);<br>        System.out.println(customer);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUpdate</span><span class="hljs-params">()</span></span>&#123;<br>        customerJPQLRepository.updateCutomserNameById(<span class="hljs-string">&quot;lisa&quot;</span>, <span class="hljs-number">2L</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelete</span><span class="hljs-params">()</span></span>&#123;<br>        customerJPQLRepository.deleteCutomserById(<span class="hljs-number">2L</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-spring-Data-JPA-使用SQL"><a href="#3-spring-Data-JPA-使用SQL" class="headerlink" title="3  spring Data JPA 使用SQL"></a>3  spring Data JPA 使用SQL</h1><ul><li>Repository 方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Query(value = &quot;select * from cst_customer where cust_name = :custName&quot;, nativeQuery = true)</span><br><span class="hljs-function">Customer <span class="hljs-title">findCustomerByCustNameWithNative</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;custName&quot;)</span> String custName)</span></span>;<br></code></pre></td></tr></table></figure><ul><li>测试</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindCustomerByCustNameWithNative</span><span class="hljs-params">()</span></span>&#123;<br>    Customer customer = customerJPQLRepository.findCustomerByCustNameWithNative(<span class="hljs-string">&quot;aa&quot;</span>);<br>    System.out.println(customer);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JPA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>springData JPA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring Data JPA 使用QueryDSL</title>
    <link href="/Spring-Data-JPA-%E4%BD%BF%E7%94%A8QueryDSL/"/>
    <url>/Spring-Data-JPA-%E4%BD%BF%E7%94%A8QueryDSL/</url>
    
    <content type="html"><![CDATA[<h1 id="1-QueryDSL-是什么？"><a href="#1-QueryDSL-是什么？" class="headerlink" title="1 QueryDSL 是什么？"></a>1 QueryDSL 是什么？</h1><ul><li><p>QueryDSL是基于ORM框架或SQL平台上的<strong>一个通用查询框架</strong>。借助QueryDSL可以在任何支持的ORM框架或SQL平台 <strong>上以通用API方式构建查询。</strong></p></li><li><p>JPA是QueryDSL的主要集成技术，是JPQL和Criteria查询的代替方法。目前QueryDSL支持的平台包括 JPA,JDO,SQL,Mongodb 等等</p></li><li><p>Querydsl扩展能让我们以<strong>链式方式代码编写查询方法</strong>。该扩展需要一个接口QueryDslPredicateExecutor，它定义了很多查询方法。</p></li></ul><h1 id="2-Spring-Data-JPA-使用QueryDSL"><a href="#2-Spring-Data-JPA-使用QueryDSL" class="headerlink" title="2 Spring Data JPA 使用QueryDSL"></a>2 Spring Data JPA 使用QueryDSL</h1><h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1. 引入依赖"></a>1. 引入依赖</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java">    &lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-data-jpa&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;<br>            &lt;artifactId&gt;druid&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">1.2</span><span class="hljs-number">.8</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- https:<span class="hljs-comment">//mvnrepository.com/artifact/com.querydsl/querydsl-jpa --&gt;</span><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.querydsl&lt;/groupId&gt;<br>            &lt;artifactId&gt;querydsl-jpa&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">4.1</span><span class="hljs-number">.4</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">5.3</span><span class="hljs-number">.19</span>&lt;/version&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.mysema.maven&lt;/groupId&gt;<br>            &lt;artifactId&gt;apt-maven-plugin&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">1.1</span><span class="hljs-number">.3</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.querydsl&lt;/groupId&gt;<br>            &lt;artifactId&gt;querydsl-apt&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">4.2</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>            &lt;scope&gt;provided&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br>&lt;!--  Spring不同模块或者与外部进行集成时，依赖处理就需要各自对应版本号。BOM是由Maven提供的功能，用以统一间接或者直接依赖的类库版本--&gt;<br>&lt;!--    在maven的pom.xml中无需指定具体的类库版本，直接使用，即默认使用bom中指定的版本<br>&lt;dependencyManagement&gt;<br>        &lt;dependencies&gt;<br>            &lt;dependency&gt;<br>                &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;<br>                &lt;artifactId&gt;spring-data-bom&lt;/artifactId&gt;<br>                &lt;version&gt;<span class="hljs-number">2021.1</span><span class="hljs-number">.0</span>&lt;/version&gt;<br>                &lt;scope&gt;<span class="hljs-keyword">import</span>&lt;/scope&gt;<br>                &lt;type&gt;pom&lt;/type&gt;<br>            &lt;/dependency&gt;<br>        &lt;/dependencies&gt;<br>    &lt;/dependencyManagement&gt;<br>    &lt;build&gt;<br>        &lt;plugins&gt;<br>            &lt;!--该插件可以生成querysdl需要的查询对象(命名方式为：<span class="hljs-string">&quot;Q&quot;</span>+对应实体名，执行mvn compile即可--&gt;<br>            &lt;plugin&gt;<br>                &lt;groupId&gt;com.mysema.maven&lt;/groupId&gt;<br>                &lt;artifactId&gt;apt-maven-plugin&lt;/artifactId&gt;<br>                &lt;executions&gt;<br>                    &lt;execution&gt;<br>                        &lt;goals&gt;<br>                            &lt;goal&gt;process&lt;/goal&gt;<br>                        &lt;/goals&gt;<br>                        &lt;configuration&gt;<br>                            &lt;outputDirectory&gt;target/generated‐sources/queries&lt;/outputDirectory&gt;<br>                            &lt;processor&gt;com.querydsl.apt.jpa.JPAAnnotationProcessor&lt;/processor&gt;<br>                            &lt;logOnlyOnError&gt;<span class="hljs-keyword">true</span>&lt;/logOnlyOnError&gt;<br>                        &lt;/configuration&gt;<br>                    &lt;/execution&gt;<br>                &lt;/executions&gt;<br>            &lt;/plugin&gt;<br>        &lt;/plugins&gt;<br>    &lt;/build&gt;<br></code></pre></td></tr></table></figure><h2 id="2-添加实体类和Jpa的配置"><a href="#2-添加实体类和Jpa的配置" class="headerlink" title="2 . 添加实体类和Jpa的配置"></a>2 . 添加实体类和Jpa的配置</h2><p>参考：[Spring data JPA的CRUD - 楼上有只喵 (pyr9.github.io)](<a href="https://pyr9.github.io/Spring">https://pyr9.github.io/Spring</a> data JPA的CRUD&#x2F;)</p><h2 id="3-编写Repository"><a href="#3-编写Repository" class="headerlink" title="3. 编写Repository"></a>3. 编写Repository</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr.repositories;<br><br><span class="hljs-keyword">import</span> org.pyr.entity.Customer;<br><span class="hljs-keyword">import</span> org.springframework.data.querydsl.QuerydslPredicateExecutor;<br><span class="hljs-keyword">import</span> org.springframework.data.repository.CrudRepository;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CustomerRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CrudRepository</span>&lt;<span class="hljs-title">Customer</span>, <span class="hljs-title">Long</span>&gt; , <span class="hljs-title">QuerydslPredicateExecutor</span>&lt;<span class="hljs-title">Customer</span>&gt; </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-编写测试类"><a href="#4-编写测试类" class="headerlink" title="4 编写测试类"></a>4 编写测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pry;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.pyr.config.JPAConfig;<br><span class="hljs-keyword">import</span> org.pyr.entity.Customer;<br><span class="hljs-keyword">import</span> org.pyr.entity.QCustomer;<br><span class="hljs-keyword">import</span> org.pyr.repositories.CustomerRepository;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.test.context.ContextConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br><br><span class="hljs-meta">@ContextConfiguration(classes = JPAConfig.class)</span><br><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueryDslTest</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    CustomerRepository customerRepository;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindOne</span><span class="hljs-params">()</span> </span>&#123;<br>        QCustomer qCustomer = QCustomer.customer;<br>        Customer customer = customerRepository.findOne(<br>                qCustomer.custId.eq(<span class="hljs-number">4L</span>)<br>                        .and(qCustomer.custName.eq(<span class="hljs-string">&quot;aa&quot;</span>))<br>        ).orElse(<span class="hljs-keyword">null</span>);<br>        System.out.println(customer);<br>    &#125;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindAll</span><span class="hljs-params">()</span> </span>&#123;<br>        QCustomer qCustomer = QCustomer.customer;<br>        Iterable&lt;Customer&gt; customers = customerRepository.findAll(<br>                qCustomer.custId.in(<span class="hljs-number">4L</span>, <span class="hljs-number">5L</span>, <span class="hljs-number">6L</span>, <span class="hljs-number">7L</span>)<br>                        .and(qCustomer.custName.eq(<span class="hljs-string">&quot;aa&quot;</span>))<br>        );<br>        System.out.println(customers);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JPA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springdata jpa</tag>
      
      <tag>queryDSL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring data JPA的CRUD</title>
    <link href="/Spring%20data%20JPA%E7%9A%84CRUD/"/>
    <url>/Spring%20data%20JPA%E7%9A%84CRUD/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Spring-data-JPA的CRUD"><a href="#1-Spring-data-JPA的CRUD" class="headerlink" title="1 Spring data JPA的CRUD"></a>1 Spring data JPA的CRUD</h1><h2 id="1-1-引入依赖"><a href="#1-1-引入依赖" class="headerlink" title="1.1 引入依赖"></a>1.1 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml">dependencies&gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.data<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.19<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.data<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-data-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2021.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="1-2-配置spring-Data-JPA"><a href="#1-2-配置spring-Data-JPA" class="headerlink" title="1.2 配置spring Data JPA"></a>1.2 配置spring Data JPA</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSource;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;<br><span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;<br><span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;<br><span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;<br><span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;<br><br><span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableJpaRepositories(&quot;org.pyr.repositories&quot;)</span><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JPAConfig</span> </span>&#123;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">dataSource</span><span class="hljs-params">()</span> </span>&#123;<br>    DruidDataSource dataSource = <span class="hljs-keyword">new</span> DruidDataSource();<br>    dataSource.setUsername(<span class="hljs-string">&quot;root&quot;</span>);<br>    dataSource.setPassword(<span class="hljs-string">&quot;19980617pyr&quot;</span>);<br>    dataSource.setDriverClassName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>    dataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/springdata_jpa&quot;</span>);<br>    <span class="hljs-keyword">return</span> dataSource;<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title">entityManagerFactory</span><span class="hljs-params">()</span> </span>&#123;<br><br>    HibernateJpaVendorAdapter vendorAdapter = <span class="hljs-keyword">new</span> HibernateJpaVendorAdapter();<br>    vendorAdapter.setGenerateDdl(<span class="hljs-keyword">true</span>);<br><br>    LocalContainerEntityManagerFactoryBean factory = <span class="hljs-keyword">new</span> LocalContainerEntityManagerFactoryBean();<br>    factory.setJpaVendorAdapter(vendorAdapter);<br>    factory.setPackagesToScan(<span class="hljs-string">&quot;org.pyr.entity&quot;</span>);<br>    factory.setDataSource(dataSource());<br>    <span class="hljs-keyword">return</span> factory;<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(EntityManagerFactory entityManagerFactory)</span> </span>&#123;<br><br>    JpaTransactionManager txManager = <span class="hljs-keyword">new</span> JpaTransactionManager();<br>    txManager.setEntityManagerFactory(entityManagerFactory);<br>    <span class="hljs-keyword">return</span> txManager;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-3-添加实体类"><a href="#1-3-添加实体类" class="headerlink" title="1.3 添加实体类"></a>1.3 添加实体类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr.entity;<br><br><span class="hljs-keyword">import</span> javax.persistence.*;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;cst_customer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Customer</span></span>&#123;<br><br>    <span class="hljs-meta">@Id</span> <span class="hljs-comment">//声明主键的配置</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span> <span class="hljs-comment">//:配置主键的生成策略: .IDENTITY ：自增，mysql</span><br>    <span class="hljs-meta">@Column(name = &quot;cust_id&quot;)</span> <span class="hljs-comment">// 配置属性和字段的映射关系  name：数据库表中字段的名称</span><br>    <span class="hljs-keyword">private</span> Long custId; <span class="hljs-comment">//客户的主键</span><br><br>    <span class="hljs-meta">@Column(name = &quot;cust_name&quot;)</span><br>    <span class="hljs-keyword">private</span> String custName;<span class="hljs-comment">//客户名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustId</span><span class="hljs-params">(Long custId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.custId = custId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustName</span><span class="hljs-params">(String custName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.custName = custName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Customer&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;custId=&quot;</span> + custId +<br>                <span class="hljs-string">&quot;, custName=&#x27;&quot;</span> + custName + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-4-编写Repository"><a href="#1-4-编写Repository" class="headerlink" title="1.4 编写Repository"></a>1.4 编写Repository</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr.repositories;<br><br><span class="hljs-keyword">import</span> org.pyr.entity.Customer;<br><span class="hljs-keyword">import</span> org.springframework.data.repository.CrudRepository;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CustomerRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CrudRepository</span>&lt;<span class="hljs-title">Customer</span>, <span class="hljs-title">Long</span>&gt; </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-4-编写测试类"><a href="#1-4-编写测试类" class="headerlink" title="1.4 编写测试类"></a>1.4 编写测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.pyr;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.pyr.config.JPAConfig;<br><span class="hljs-keyword">import</span> org.pyr.entity.Customer;<br><span class="hljs-keyword">import</span> org.pyr.repositories.CustomerRepository;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.test.context.ContextConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br><br><span class="hljs-keyword">import</span> java.util.Optional;<br><br><span class="hljs-meta">@ContextConfiguration(classes = JPAConfig.class)</span><br><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JPATest</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    CustomerRepository customerRepository;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFind</span><span class="hljs-params">()</span></span>&#123;<br>        Optional&lt;Customer&gt; customer = customerRepository.findById(<span class="hljs-number">3L</span>);<br>        System.out.println(customer.get());<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSave</span><span class="hljs-params">()</span></span>&#123;<br>        Customer customer = <span class="hljs-keyword">new</span> Customer();<br>        customer.setCustName(<span class="hljs-string">&quot;aa&quot;</span>);<br>        customerRepository.save(customer);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUpdate</span><span class="hljs-params">()</span></span>&#123;<br>        Customer customer = <span class="hljs-keyword">new</span> Customer();<br>        customer.setCustId(<span class="hljs-number">3L</span>);<br>        customer.setCustName(<span class="hljs-string">&quot;aa123&quot;</span>);<br>        customerRepository.save(customer);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelete</span><span class="hljs-params">()</span></span>&#123;<br>        Customer customer = <span class="hljs-keyword">new</span> Customer();<br>        customer.setCustId(<span class="hljs-number">3L</span>);<br>        customer.setCustName(<span class="hljs-string">&quot;aa123&quot;</span>);<br>        customerRepository.delete(customer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JPA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>springData JPA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于JPA的数据库操作</title>
    <link href="/%E5%9F%BA%E4%BA%8EJPA%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/"/>
    <url>/%E5%9F%BA%E4%BA%8EJPA%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<p>产生原因：<strong>如果单独使用hibernate的API来进行持久化操作，则不能随意切换其他ORM框架</strong></p><h1 id="1-操作步骤"><a href="#1-操作步骤" class="headerlink" title="1 操作步骤"></a>1 操作步骤</h1><h2 id="1-1-导入依赖"><a href="#1-1-导入依赖" class="headerlink" title="1.1 导入依赖"></a>1.1 导入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.29<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.6.8.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="1-2-添加META-INF-persistence-xml"><a href="#1-2-添加META-INF-persistence-xml" class="headerlink" title="1.2 添加META-INF\persistence.xml"></a>1.2 添加META-INF\persistence.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">persistence</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;2.0&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--需要配置persistence‐unit节点持久化单元：name：持久化单元名称</span><br><span class="hljs-comment">    transaction‐type：事务管理的方式 JTA：分布式事务管理 RESOURCE_LOCAL：本地事务管理--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">persistence-unit</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hibernateJPA&quot;</span> <span class="hljs-attr">transaction-type</span>=<span class="hljs-string">&quot;RESOURCE_LOCAL&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--        jpa的实现方式 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">provider</span>&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--            配置jpa实现方的配置信息--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;javax.persistence.jdbc.url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/springdata_jpa&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;javax.persistence.jdbc.user&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;javax.persistence.jdbc.password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;19980617pyr&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;javax.persistence.jdbc.driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span><br>            <span class="hljs-comment">&lt;!--            配置jpa实现方(hibernate)的配置信息--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hibernate.show_sql&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hibernate.format_sql&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;update&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hibernate.dialect&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;org.hibernate.dialect.MySQL5InnoDBDialect&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">persistence-unit</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">persistence</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="1-3-增加测试实体类"><a href="#1-3-增加测试实体类" class="headerlink" title="1.3 增加测试实体类"></a>1.3 增加测试实体类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> entity;<br><br><span class="hljs-keyword">import</span> javax.persistence.*;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;cst_customer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Customer</span></span>&#123;<br><br>    <span class="hljs-meta">@Id</span> <span class="hljs-comment">//声明主键的配置</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span> <span class="hljs-comment">//:配置主键的生成策略: .IDENTITY ：自增，mysql</span><br>    <span class="hljs-meta">@Column(name = &quot;cust_id&quot;)</span> <span class="hljs-comment">// 配置属性和字段的映射关系  name：数据库表中字段的名称</span><br>    <span class="hljs-keyword">private</span> Long custId; <span class="hljs-comment">//客户的主键</span><br><br>    <span class="hljs-meta">@Column(name = &quot;cust_name&quot;)</span><br>    <span class="hljs-keyword">private</span> String custName;<span class="hljs-comment">//客户名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustId</span><span class="hljs-params">(Long custId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.custId = custId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustName</span><span class="hljs-params">(String custName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.custName = custName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Customer&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;custId=&quot;</span> + custId +<br>                <span class="hljs-string">&quot;, custName=&#x27;&quot;</span> + custName + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="1-4-测试"><a href="#1-4-测试" class="headerlink" title="1.4 测试"></a>1.4 测试</h2><p><strong>准备工作</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    EntityManager entityManager;<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        EntityManagerFactory entityManagerFactory = Persistence.createEntityManagerFactory(<span class="hljs-string">&quot;hibernateJPA&quot;</span>);<br>        entityManager = entityManagerFactory.createEntityManager();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Save"><a href="#Save" class="headerlink" title="Save"></a>Save</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSave</span><span class="hljs-params">()</span> </span>&#123;<br>       EntityTransaction transaction = entityManager.getTransaction();<br>       transaction.begin();<br><br>       Customer customer = <span class="hljs-keyword">new</span> Customer();<br>       customer.setCustName(<span class="hljs-string">&quot;张三&quot;</span>);<br>       entityManager.persist(customer);<br><br>       transaction.commit();<br>       entityManager.close();<br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRemove</span><span class="hljs-params">()</span> </span>&#123;<br>        EntityTransaction transaction = entityManager.getTransaction();<br>        transaction.begin();<br><span class="hljs-comment">//        Customer customer =new Customer();</span><br><span class="hljs-comment">//        customer.setCustId(3L);</span><br>        Customer customer = entityManager.find(Customer.class, <span class="hljs-number">3L</span>);<br>        entityManager.remove(customer);<br>        transaction.commit();<br>        entityManager.close();<br>    &#125;<br></code></pre></td></tr></table></figure><p>⚠️：这里要删除的对象需要是数据库里查询到的，和entityManager发生过关联的对象，即持久状态。或者使用HQL。new出来的对象无法完成删除逻辑。</p><h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUpdate</span><span class="hljs-params">()</span> </span>&#123;<br>    EntityTransaction transaction = entityManager.getTransaction();<br>    transaction.begin();<br><br>    Customer customer = <span class="hljs-keyword">new</span> Customer();<br>    customer.setCustName(<span class="hljs-string">&quot;张三123&quot;</span>);<br>    customer.setCustId(<span class="hljs-number">3L</span>);<br>    <span class="hljs-comment">// 指定id即更新，没有id就新增</span><br>    Customer rs = entityManager.merge(customer);<br>    System.out.println(rs);<br>    transaction.commit();<br>    entityManager.close();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>HQLUpdate</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHQLUpdate</span><span class="hljs-params">()</span> </span>&#123;<br>    EntityTransaction transaction = entityManager.getTransaction();<br>    transaction.begin();<br><br>    String sqlQuery = <span class="hljs-string">&quot;update Customer set custName=:name where custId=:id&quot;</span>;<br>    entityManager.createQuery(sqlQuery)<br>            .setParameter(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;徐庶143&quot;</span>)<br>            .setParameter(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">2L</span>)<br>            .executeUpdate();<br><br>    transaction.commit();<br>    entityManager.close();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Sql查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSQLUpdate</span><span class="hljs-params">()</span> </span>&#123;<br>    EntityTransaction transaction = entityManager.getTransaction();<br>    transaction.begin();<br><br>    String sqlQuery = <span class="hljs-string">&quot;update cst_customer set cust_id=:name where cust_name=:id&quot;</span>;<br>    entityManager.createNativeQuery(sqlQuery)<br>            .setParameter(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;徐庶123&quot;</span>)<br>            .setParameter(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">2L</span>)<br>            .executeUpdate();<br><br>    transaction.commit();<br>    entityManager.close();<br>&#125;<br></code></pre></td></tr></table></figure><p>⚠️：这里使用createNativeQuery，表明和字段名都换成小写</p><h3 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h3><ul><li>立即查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFind</span><span class="hljs-params">()</span> </span>&#123;<br>    EntityTransaction transaction = entityManager.getTransaction();<br>    transaction.begin();<br><br>    Customer rs = entityManager.find(Customer.class, <span class="hljs-number">3L</span>);<br>    System.out.println(<span class="hljs-string">&quot;========================&quot;</span>);<br>    System.out.println(rs);<br>    transaction.commit();<br>    entityManager.close();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>懒加载查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLazyFind</span><span class="hljs-params">()</span> </span>&#123;<br>    EntityTransaction transaction = entityManager.getTransaction();<br>    transaction.begin();<br><br>    Customer rs = entityManager.getReference(Customer.class, <span class="hljs-number">3L</span>);<br>    System.out.println(<span class="hljs-string">&quot;========================&quot;</span>);<br>    System.out.println(rs);<br>    transaction.commit();<br>    entityManager.close();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>HQL查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.junit.<span class="hljs-function">Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHQLSelect</span><span class="hljs-params">()</span> </span>&#123;<br>    EntityTransaction transaction = entityManager.getTransaction();<br>    transaction.begin();<br><br>    String sqlQuery = <span class="hljs-string">&quot;select c from Customer c&quot;</span>;<br>    Query query = entityManager.createQuery(sqlQuery);<br>    List&lt;Customer&gt; resultList = query.getResultList();<br>    resultList.forEach(System.out::println);<br><br>    transaction.commit();<br>    entityManager.close();<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JPA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于Hibernate数据库操作</title>
    <link href="/%E5%9F%BA%E4%BA%8EHibernate%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/"/>
    <url>/%E5%9F%BA%E4%BA%8EHibernate%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="1-基于Hibernate数据库操作"><a href="#1-基于Hibernate数据库操作" class="headerlink" title="1 基于Hibernate数据库操作"></a>1 基于Hibernate数据库操作</h1><h2 id="1-1-操作步骤"><a href="#1-1-操作步骤" class="headerlink" title="1.1 操作步骤"></a>1.1 操作步骤</h2><h3 id="1-1-1-导入依赖"><a href="#1-1-1-导入依赖" class="headerlink" title="1.1.1 导入依赖"></a>1.1.1 导入依赖</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;mysql&lt;/groupId&gt;<br>    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">8.0</span><span class="hljs-number">.29</span>&lt;/version&gt;<br>    &lt;scope&gt;test&lt;/scope&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;<br>    &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">5.6</span><span class="hljs-number">.8</span>.Final&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><h3 id="1-1-2-增加实体类"><a href="#1-1-2-增加实体类" class="headerlink" title="1.1.2 增加实体类"></a>1.1.2 增加实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> tt.pyr.entity;<br><br><span class="hljs-keyword">import</span> javax.persistence.*;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;cst_customer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Customer</span> </span>&#123;<br><br>    <span class="hljs-meta">@Id</span> <span class="hljs-comment">//声明主键的配置</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span> <span class="hljs-comment">//:配置主键的生成策略: .IDENTITY ：自增，mysql</span><br>    <span class="hljs-meta">@Column(name = &quot;cust_id&quot;)</span> <span class="hljs-comment">// 配置属性和字段的映射关系  name：数据库表中字段的名称</span><br>    <span class="hljs-keyword">private</span> Long custId; <span class="hljs-comment">//客户的主键</span><br><br>    <span class="hljs-meta">@Column(name = &quot;cust_name&quot;)</span><br>    <span class="hljs-keyword">private</span> String custName;<span class="hljs-comment">//客户名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustId</span><span class="hljs-params">(Long custId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.custId = custId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustName</span><span class="hljs-params">(String custName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.custName = custName;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-1-3-配置hibernate-cfg-xml"><a href="#1-1-3-配置hibernate-cfg-xml" class="headerlink" title="1.1.3 配置hibernate.cfg.xml"></a>1.1.3 配置<strong>hibernate.cfg.xml</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version = <span class="hljs-string">&quot;1.0&quot;</span> encoding = <span class="hljs-string">&quot;utf-8&quot;</span>?&gt;<br>&lt;!DOCTYPE hibernate-configuration PUBLIC<br>        <span class="hljs-string">&quot;-//Hibernate/Hibernate Configuration DTD 3.0//EN&quot;</span><br>        <span class="hljs-string">&quot;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&quot;</span>&gt;<br>&lt;hibernate-configuration&gt;<br>    &lt;session-factory&gt;<br>        &lt;property name=<span class="hljs-string">&quot;hibernate.connection.url&quot;</span>&gt;jdbc:mysql:<span class="hljs-comment">//localhost:3306/springdata_jpa&lt;/property&gt;</span><br>        &lt;property name=<span class="hljs-string">&quot;hibernate.connection.username&quot;</span>&gt;root&lt;/property&gt;<br>        &lt;property name=<span class="hljs-string">&quot;hibernate.connection.password&quot;</span>&gt;19980617pyr&lt;/property&gt;<br>        &lt;property name=<span class="hljs-string">&quot;hibernate.connection.driver_class&quot;</span>&gt;com.mysql.cj.jdbc.Driver&lt;/property&gt;<br>        &lt;property name=<span class="hljs-string">&quot;hibernate.show_sql&quot;</span>&gt;<span class="hljs-keyword">true</span>&lt;/property&gt;<br>        &lt;property name=<span class="hljs-string">&quot;format_sql&quot;</span>&gt;<span class="hljs-keyword">true</span>&lt;/property&gt;<br>        &lt;property name=<span class="hljs-string">&quot;hbm2ddl.auto&quot;</span>&gt;update&lt;/property&gt;<br>        &lt;mapping <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;tt.pyr.entity.Customer&quot;</span>&gt;&lt;/mapping&gt;<br>    &lt;/session-factory&gt;<br>&lt;/hibernate-configuration&gt;<br><br></code></pre></td></tr></table></figure><h3 id="1-1-4-编写测试用例"><a href="#1-1-4-编写测试用例" class="headerlink" title="1.1.4 编写测试用例"></a>1.1.4 编写测试用例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> test;<br><br><span class="hljs-keyword">import</span> org.hibernate.Session;<br><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;<br><span class="hljs-keyword">import</span> org.hibernate.Transaction;<br><span class="hljs-keyword">import</span> org.hibernate.boot.MetadataSources;<br><span class="hljs-keyword">import</span> org.hibernate.boot.registry.StandardServiceRegistry;<br><span class="hljs-keyword">import</span> org.hibernate.boot.registry.StandardServiceRegistryBuilder;<br><span class="hljs-keyword">import</span> org.junit.Before;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> tt.pyr.entity.Customer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HibernateTest</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> SessionFactory sf;<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        StandardServiceRegistry registry = <span class="hljs-keyword">new</span> StandardServiceRegistryBuilder().configure(<span class="hljs-string">&quot;/hibernate.cfg.xml&quot;</span>).build();<br>        <span class="hljs-comment">//2. 根据服务注册类创建一个元数据资源集，同时构建元数据并生成应用一般唯一的的session工厂</span><br>        sf = <span class="hljs-keyword">new</span> MetadataSources(registry).buildMetadata().buildSessionFactory();<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInsert</span><span class="hljs-params">()</span> </span>&#123;<br>        Session sess = sf.openSession();<br>        Transaction tx = sess.beginTransaction();<br>        Customer customer = <span class="hljs-keyword">new</span> Customer();<br>        customer.setCustName(<span class="hljs-string">&quot;张三&quot;</span>);<br>        sess.save(customer);<br>        tx.commit();<br>        sess.close();<br>        sf.close();<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSaveOrUpdate</span><span class="hljs-params">()</span> </span>&#123;<br>        Session sess = sf.openSession();<br>        Transaction tx = sess.beginTransaction();<br>        Customer customer = <span class="hljs-keyword">new</span> Customer();<br>        customer.setCustName(<span class="hljs-string">&quot;里斯&quot;</span>);<br>        sess.saveOrUpdate(customer);<br>        tx.commit();<br>        sess.close();<br>        sf.close();<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRemove</span><span class="hljs-params">()</span> </span>&#123;<br>        Session sess = sf.openSession();<br>        Transaction tx = sess.beginTransaction();<br>        Customer customer = <span class="hljs-keyword">new</span> Customer();<br>        customer.setCustId(<span class="hljs-number">1L</span>);<br>        sess.remove(customer);<br>        tx.commit();<br>        sess.close();<br>        sf.close();<br>    &#125;<br>  <br>      <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHQL</span><span class="hljs-params">()</span> </span>&#123;<br>        Session sess = sf.openSession();<br>        Transaction tx = sess.beginTransaction();<br><br>        String sql = <span class="hljs-string">&quot;Update Customer set custName=:custName where custId=:id&quot;</span>;<br>        sess.createQuery(sql).setParameter(<span class="hljs-string">&quot;custName&quot;</span>, <span class="hljs-string">&quot;徐庶&quot;</span>).setParameter(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">2L</span>).executeUpdate();<br>        tx.commit();<br>        sess.close();<br>        sf.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-HQL"><a href="#1-2-HQL" class="headerlink" title="1.2 HQL"></a>1.2 HQL</h2><h3 id="1-2-1-是什么？"><a href="#1-2-1-是什么？" class="headerlink" title="1.2.1 是什么？"></a>1.2.1 是什么？</h3><ul><li>HQL是Hibernate Query Language（Hibernate 查询语言）的缩写，提供更加丰富灵活、更为强大的查询能力；HQL更接近SQL语句查询语法。</li><li>Hibernate查询语言(HQL)与SQL(结构化查询语言)相同，但不依赖于数据库表。 我们在HQL中使用类名，而不是表名,它是数据库独立的查询语言。</li></ul><h3 id="1-1-2-HQL查询的步骤"><a href="#1-1-2-HQL查询的步骤" class="headerlink" title="1.1.2 HQL查询的步骤"></a>1.1.2 HQL查询的步骤</h3><ul><li>获得Hibernate Session对象</li><li>编写HQL语句</li><li>调用Session的createQuery方法创建查询对象</li><li>如果HQL语句包含参数，则调用Query的setXxx方法为参数赋值</li><li>调用Query对象的list等方法返回查询结果。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> test;<br><br><span class="hljs-keyword">import</span> org.hibernate.Session;<br><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;<br><span class="hljs-keyword">import</span> org.hibernate.Transaction;<br><span class="hljs-keyword">import</span> org.hibernate.boot.MetadataSources;<br><span class="hljs-keyword">import</span> org.hibernate.boot.registry.StandardServiceRegistry;<br><span class="hljs-keyword">import</span> org.hibernate.boot.registry.StandardServiceRegistryBuilder;<br><span class="hljs-keyword">import</span> org.junit.Before;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> tt.pyr.entity.Customer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HibernateTest</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> SessionFactory sf;<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        StandardServiceRegistry registry = <span class="hljs-keyword">new</span> StandardServiceRegistryBuilder().configure(<span class="hljs-string">&quot;/hibernate.cfg.xml&quot;</span>).build();<br>        sf = <span class="hljs-keyword">new</span> MetadataSources(registry).buildMetadata().buildSessionFactory();<br>    &#125;<br>  <br>      <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHQL</span><span class="hljs-params">()</span> </span>&#123;<br>        Session sess = sf.openSession();<br>        Transaction tx = sess.beginTransaction();<br><br>        String sql = <span class="hljs-string">&quot;Update Customer set custName=:custName where custId=:id&quot;</span>;<br>        sess.createQuery(sql).setParameter(<span class="hljs-string">&quot;custName&quot;</span>, <span class="hljs-string">&quot;徐庶&quot;</span>).setParameter(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">2L</span>).executeUpdate();<br>        tx.commit();<br>        sess.close();<br>        sf.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JPA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
      <tag>Hibernate</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JPA和hibernate和SpringDataJpa</title>
    <link href="/JPA%E5%92%8Chibernate%E5%92%8CSpringDataJpa/"/>
    <url>/JPA%E5%92%8Chibernate%E5%92%8CSpringDataJpa/</url>
    
    <content type="html"><![CDATA[<p>Java访问持久层的两种方式</p><ul><li>以Sql为核心，封装一定程度的JDBC操作，比如mybatis</li><li>以Java实体类为核心，将实体类和数据表之间建立连接，也就是我们说的ORM框架，比如：Hibernate,SpringData jpa</li></ul><h1 id="1-JPA"><a href="#1-JPA" class="headerlink" title="1. JPA"></a>1. JPA</h1><p>JPA顾名思义就是Java Persistence API的意思</p><ul><li>使用注解或XML描述对象－关系表的映射关系</li><li>将运行期的实体对象持久化到数据库中</li><li>定义了一些接口。</li></ul><h1 id="2-hibernate"><a href="#2-hibernate" class="headerlink" title="2. hibernate"></a>2. hibernate</h1><p>Hibernate就是实现了JPA接口的ORM框架。</p><h1 id="3-Spring-Data-JPA"><a href="#3-Spring-Data-JPA" class="headerlink" title="3 Spring Data JPA"></a>3 <strong>Spring Data JPA</strong></h1><h2 id="3-1-定义"><a href="#3-1-定义" class="headerlink" title="3.1 定义"></a>3.1 定义</h2><ul><li><p>Spring Data JPA是spring提供的一套 <strong>JPA 应用框架</strong>。</p></li><li><p>SpringDataJpa可以理解为JPA规范的再次封装抽象，底层还是使用了Hibernate的Jpa技术实现。</p></li><li><p>Spring Data JPA旨在通过将统一ORM框架的访问持久层的操作，来提高开发人的效率。</p></li><li><p>虽然ORM框架都实现了JPA规范，但是在不同的ORM框架之间切换仍然需要编写不同的代码，而使用<strong>Spring Data JPA能够方便大家在不同的ORM框架之间进行切换而不需要更改代码</strong>。</p></li><li><p>按照约定好的规则进行【方法命名】去写dao层接口，就可以在不写接口实现的情况下，实现对数据库的访问和操作。同时提供了很多除了CRUD之外的功能，如分页、排序、复杂查询等等</p></li><li><p>Spring Data JPA 让我们解脱了DAO层的操作，基本上所有CRUD都可以依赖于它来实现,</p></li></ul><h2 id="3-2-Spring-Data-JPA给我们提供的主要的类和接口"><a href="#3-2-Spring-Data-JPA给我们提供的主要的类和接口" class="headerlink" title="3.2  Spring Data JPA给我们提供的主要的类和接口"></a>3.2  <strong>Spring Data JPA给我们提供的主要的类和接口</strong></h2><ul><li><p>Repository 接口：</p><ul><li><p>Repository</p></li><li><p>CrudRepository</p></li><li><p>JpaRepository &#x3D; 基本<code>CRUD</code>功能+分页+按“实例”查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">ID</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">PagingAndSortingRepository</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">ID</span>&gt;, <span class="hljs-title">QueryByExampleExecutor</span></span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>Repository 实现类：</p><ul><li><p>SimpleJpaRepository</p></li><li><p>QueryDslJpaRepository</p></li></ul></li></ul><h1 id="4-JPA、hibernate、Spring-Data-Jpa关系"><a href="#4-JPA、hibernate、Spring-Data-Jpa关系" class="headerlink" title="4 JPA、hibernate、Spring Data Jpa关系"></a>4 JPA、hibernate、Spring Data Jpa关系</h1><ul><li><p>JPA是一个规范，也就是说它仅仅定义了一些接口</p></li><li><p>Hibernate就是实现了JPA接口的ORM框架</p></li><li><p>SpringDataJpa是Spring提供的一套简化JPA开发的框架。可以理解为JPA规范的再次封装抽象，底层还是使用了Hibernate的Jpa技术实现。</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230320175230013.png" alt="image-20230320175230013"></p><h1 id="5-Spring-Data-JPA和Hibernate的关系"><a href="#5-Spring-Data-JPA和Hibernate的关系" class="headerlink" title="5 Spring Data JPA和Hibernate的关系"></a>5 <strong>Spring Data JPA和Hibernate的关系</strong></h1><ul><li>Hibernate其实是JPA的一种实现，而Spring Data JPA是一个JPA数据访问抽象。</li><li>pring Data JPA不是一个实现或JPA提供的程序，它只是一个抽象层，主要用于减少为各种持久层存储实现数据访问层所需的样板代码量。但是它还是需要JPA提供实现程序。</li><li>Spring Data JPA是一种JPA的抽象层，底层依赖Hibernate</li></ul><h1 id="6-mybatis-和hibernate的对比？"><a href="#6-mybatis-和hibernate的对比？" class="headerlink" title="6 mybatis 和hibernate的对比？"></a>6 mybatis 和hibernate的对比？</h1><p>（1）hibernate是全自动，而mybatis是半自动。</p><p>hibernate完全可以通过对象关系模型实现对数据库的操作，拥有完整的JavaBean对象与数据库的映射结构来自动生成sql。而mybatis仅有基本的字段映射，对象数据以及对象实际关系仍然需要通过手写sql来实现和管理。</p><p>（2）hibernate数据库移植性远大于mybatis</p><p>hibernate通过它强大的映射结构和hql语言，大大降低了对象与数据库（Oracle、MySQL等）的耦合性，而mybatis由于需要手写sql，因此与数据库的耦合性直接取决于程序员写sql的方法，如果sql不具通用性而用了很多某数据库特性的sql语句的话，移植性也会随之降低很多，成本很高。</p><p>（3）hibernate拥有完整的日志系统，mybatis则欠缺一些</p><p>hibernate日志系统非常健全，涉及广泛，包括：sql记录、关系异常、优化警告、缓存提示、脏数据警告等；而mybatis则除了基本记录功能外，功能薄弱很多。</p><p>（4）sql直接优化上，mybatis要比hibernate方便很多</p><p>由于mybatis的sql都是写在xml里，因此优化sql比hibernate方便很多。而hibernate的sql很多都是自动生成的，无法直接维护sql；</p>]]></content>
    
    
    <categories>
      
      <category>JPA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JPA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Vue入门</title>
    <link href="/Vue%E5%85%A5%E9%97%A8/"/>
    <url>/Vue%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Vue是什么？"><a href="#1-Vue是什么？" class="headerlink" title="1 Vue是什么？"></a>1 Vue是什么？</h1><ul><li>vue是一套JavaScript框架</li><li>Vue可以简化Dom操作</li><li>响应式数据驱动</li></ul><h1 id="2-hello-world"><a href="#2-hello-world" class="headerlink" title="2 hello world"></a>2 hello world</h1><ol><li>导入Vue</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><ol start="2"><li>创建Vue实例对象，设置el属性和data属性</li><li>使用简洁的模板语法把数据渲染到页面上</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;body&gt;<br>  &lt;div id=&quot;app&quot;&gt;<br>    &#123;&#123;message&#125;&#125;<br>  &lt;/div&gt;<br>  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;&gt;&lt;/script&gt;<br>  &lt;script&gt;<br>   var app = new Vue(&#123;<br>     el:&quot;#app&quot;,<br>     data:&#123;<br>       message: &quot;hello world!&quot;<br>     &#125;<br>   &#125;)<br>  &lt;/script&gt;<br>&lt;/body&gt;<br></code></pre></td></tr></table></figure><h1 id="3-el挂载点"><a href="#3-el挂载点" class="headerlink" title="3 el挂载点"></a>3 el挂载点</h1><ul><li><p>el是用来设置<strong>vue实例挂载</strong>的元素</p></li><li><p>Vue会管理el选项<strong>命中的元素</strong>以及其内部的<strong>后代元素</strong></p></li><li><p>可以使用其他的选择器，但是<strong>建议使用id选择器</strong></p></li><li><p>可以使用其他的双标签，不能使用HTML或者body</p></li></ul><h1 id="4-data数据对象"><a href="#4-data数据对象" class="headerlink" title="4 data数据对象"></a>4 data数据对象</h1><ul><li>vue中用到的对象定义在data中</li><li>Data中可以写复杂类型的数据，比如对象，数组</li><li>渲染复杂类型的数据，遵循js的语法即可</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;body&gt;<br>  &lt;div id=&quot;app&quot;&gt;<br>    &#123;&#123;message&#125;&#125;<br>    &#123;&#123;school.name&#125;&#125;<br>    &#123;&#123;school.age&#125;&#125;<br>    &lt;ul&gt;<br>      &lt;li&gt;&#123;&#123;hoobies[0]&#125;&#125;&lt;/li&gt;<br>      &lt;li&gt;&#123;&#123;hoobies[2]&#125;&#125;&lt;/li&gt;<br>    &lt;/ul&gt;<br>  &lt;/div&gt;<br>  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;&gt;&lt;/script&gt;<br>  &lt;script&gt;<br>    var app = new Vue(&#123;<br>      el: &quot;#app&quot;,<br>      data: &#123;<br>        message: &quot;hello world!&quot;,<br>        school: &#123;<br>          name: &quot;张三&quot;,<br>          age: 14<br>        &#125;,<br>        hoobies: [&quot;唱歌&quot;, &quot;跳舞&quot;, &quot;弹琴&quot;]<br>      &#125;<br>    &#125;)<br>  &lt;/script&gt;<br>&lt;/body&gt;<br></code></pre></td></tr></table></figure><h2 id="5-模版语法"><a href="#5-模版语法" class="headerlink" title="5 模版语法"></a>5 模版语法</h2><ul><li><code> &#123;&#123; message &#125;&#125;</code> 展示字符串文本</li><li><code>v-bind:class=&quot;&#39;btnb tn-sm&#39;&quot;</code> 绑定属性</li></ul><img src="/Users/panyurou/Library/Application Support/typora-user-images/image-20221023232100807.png" alt="image-20221023232100807" style="zoom:50%;" /><ul><li><p><code>v-html</code>: 翻译成html标签</p></li><li><p><code>&#123;&#123; ok ? 'YES':'No' &#125;&#125;</code> 三元运算</p></li><li><p><code>&#123;&#123; message.spilt('').join(',') &#125;&#125;</code>:  vue支持js表达式</p></li><li><p>V-if 控制元素是否切换</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;div id=&quot;app-3&quot;&gt;<br>  &lt;p v-if=&quot;seen&quot;&gt;现在你看到我了&lt;/p&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> app3 = <span class="hljs-keyword">new</span> Vue(&#123;<br>  <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app-3&#x27;</span>,<br>  <span class="hljs-attr">data</span>: &#123;<br>    <span class="hljs-attr">seen</span>: <span class="hljs-literal">true</span><br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>@click 绑定事件</li></ul><img src="/Users/panyurou/Library/Application Support/typora-user-images/image-20221023231840513.png" alt="image-20221023231840513" style="zoom:50%;" /> <p>![image-20221023232442286](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20221023232442286.png)</p><ul><li>可以定义请求返回的数据的格式</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">data</span>: function () &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>        isEdit: <span class="hljs-literal">false</span>,<br>        businessDataFromApi: <span class="hljs-literal">null</span><br>    &#125;<br>&#125;<br><br> getBusinessDataByQueryApi() &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.queryApi !== undefined) &#123;<br>                let url = `$&#123;<span class="hljs-keyword">this</span>.$store.state[<span class="hljs-keyword">this</span>.entity].baseModuleUrl&#125;/$&#123;<span class="hljs-keyword">this</span>.entity&#125;/` + <span class="hljs-keyword">this</span>.queryApi;<br>                <span class="hljs-keyword">this</span>.$store.dispatch(<span class="hljs-string">&#x27;api/post&#x27;</span>, &#123;<br>                    url: url,<br>                    <span class="hljs-keyword">data</span>: &#123;<br>                        idFilter: <span class="hljs-keyword">this</span>.businessData.id === undefined ? <span class="hljs-keyword">this</span>.$route.query.id : <span class="hljs-keyword">this</span>.businessData.id<br>                    &#125;<br>                &#125;).then(response =&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (response.<span class="hljs-keyword">data</span>.list.length === <span class="hljs-number">1</span>) &#123;<br>                        <span class="hljs-keyword">this</span>.businessDataFromApi = response.<span class="hljs-keyword">data</span>.list[<span class="hljs-number">0</span>];<br>                    &#125;<br>                &#125;)<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><ul><li>![image-20221024231200647](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20221024231200647.png)</li></ul><p>![image-20221024231215526](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20221024231215526.png)</p><p>- </p><ul><li><pre><code class="hljs">handleClick(col, $event) </code></pre></li><li><p>@click&#x3D;”handleClick()” 和@click&#x3D;”handleClick”的区别在于：第一个拿不到event事件，如果要拿到事件，需要写成@click&#x3D;”handleClick($event)”</p></li><li><p>阻止默认行为@click.prevent</p></li><li><p>@click.once 只执行一次事件触发</p></li><li><p>@click.self 只有e.target &#x3D; e.currentTarget的时候才会执行</p><img src="/Users/panyurou/Library/Application Support/typora-user-images/image-20221108210854373.png" alt="image-20221108210854373" style="zoom: 33%;" /></li></ul>]]></content>
    
    
    <categories>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mongodb集群</title>
    <link href="/Mongodb%E9%9B%86%E7%BE%A4/"/>
    <url>/Mongodb%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="1-主从模式"><a href="#1-主从模式" class="headerlink" title="1. 主从模式"></a>1. 主从模式</h1><p>主从最大的问题就是无法自动故障转移，对于简单的主从复制无法自动故障转移的缺陷，各个数据库都在改进，MySQL推出的Fabric ，Redis的哨兵，Mongodb的复制集。</p><h1 id="2-复制集模式"><a href="#2-复制集模式" class="headerlink" title="2. 复制集模式"></a>2. 复制集模式</h1><ul><li>Mongodb复制集（Replication Set）由一组Mongod实例（进程）组成，包含一个 Primary节点和多个Secondary节点</li><li>Mongodb Driver（客户端）的所有数据都写入 ，Primary，Secondary从Primary同步写入的数据，以保持复制集内所有成员存储相同的数据集，提供数据的高可用</li><li>从节点会从oplog拉数据，类似mysql的binlog</li><li>在实现高可用的同时，复制集实现了其他几个附加作用: <ul><li>数据分发: 将数据从一个区域复制到另一个区域，减少另一个区域的读延迟 </li><li>读写分离: 不同类型的压力分别在不同的节点上执行 </li><li>异地容灾: 在数据中心故障时候快速切换到异地</li></ul></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224723229.png" alt="image-20230228224723229"></p><h2 id="2-1-三节点复制集模式"><a href="#2-1-三节点复制集模式" class="headerlink" title="2.1 三节点复制集模式"></a>2.1 <strong>三节点复制集模式</strong></h2><p>常见的复制集架构由3个成员节点组成，其中存在几种不同的模式</p><h3 id="2-1-1-PSS模式（官方推荐模式）"><a href="#2-1-1-PSS模式（官方推荐模式）" class="headerlink" title="2.1.1 PSS模式（官方推荐模式）"></a>2.1.1 <strong>PSS模式（官方推荐模式）</strong></h3><ul><li><p>PSS模式由一个主节点和两个备节点所组成，即Primary+Secondary+Secondary</p></li><li><p>此模式始终提供数据集的两个完整副本，如果主节点不可用，则复制集选择备节点作为主节 点并继续正常操作。</p></li><li><p>旧的主节点在可用时重新加入复制集。</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224732217.png" alt="image-20230228224732217"></p><h3 id="2-1-2-PSA模式（官方推荐模式）"><a href="#2-1-2-PSA模式（官方推荐模式）" class="headerlink" title="2.1.2 *PSA模式（官方推荐模式）*"></a>2.1.2 *<em><strong>PSA</strong>模式（官方推荐模式）</em>*</h3><ul><li>PSA模式由一个主节点、一个备节点和一个仲裁者节点组成，即 Primary+Secondary+Arbiter </li><li>此模式仅提供数据的一个完整副本，如果主节点不可用，则复制 集将选择备节点作为主节点。</li><li>Arbiter节点不存储数据副本，也不提供业务的读写操作。Arbiter节点发生故障不影 响业务，仅影响选举投票。因为需要半数选举，但机器成本不够再申请一台</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224740040.png" alt="image-20230228224740040"></p><h1 id="3-分片集群架构"><a href="#3-分片集群架构" class="headerlink" title="3 分片集群架构"></a>3 <strong>分片集群架构</strong></h1><p>MongoDB 分片集群（Sharded Cluster）是对数据进行水平扩展的一种方式</p><h2 id="3-1-使用场景"><a href="#3-1-使用场景" class="headerlink" title="3.1 使用场景"></a>3.1 使用场景</h2><ul><li>写IOPS超出单个MongoDB节点的写服务能力</li><li>存储容量需求超出单机的磁盘容量。 </li><li>活跃的数据集超出单机内存容量，导致很多请求都要从磁盘读取数据，影响性 能</li></ul>]]></content>
    
    
    <categories>
      
      <category>MongoDB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>集群</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch集群架构</title>
    <link href="/ElasticSearch%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/"/>
    <url>/ElasticSearch%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="1-ES集群架构"><a href="#1-ES集群架构" class="headerlink" title="1 ES集群架构"></a>1 <strong>ES集群架构</strong></h1><ul><li><p>一个集群可以有一个或者多个节点 </p></li><li><p>不同的集群通过不同的名字来区分，默认名字“elasticsearch“ </p></li><li><p>通过配置文件修改，或者在命令行中 -E cluster.name&#x3D;es-cluster进行设定</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221740498.png" alt="image-20230228221740498"></p><h1 id="2-集群节点类型"><a href="#2-集群节点类型" class="headerlink" title="2  集群节点类型"></a>2  集群节点类型</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221752056.png" alt="image-20230228221752056"></p><ul><li><p>Master Node：主节点 </p><ul><li><p>处理创建，删除索引等请求，负责索引的创建与删除</p></li><li><p>决定分片被分配到哪个节点</p></li><li><p>管理集群节点状态</p></li></ul></li><li><p>Master eligible nodes：</p><ul><li>可以参与选举的合格节点 </li><li>每个节点启动后，默认就是一个Master eligible节点</li></ul></li><li><p>Data Node：数据节点 </p><ul><li>可以保存数据的节点，负责数据写入与搜索</li><li>节点启动后，默认就是数据节点。可以设置node.data: false 禁止</li></ul></li><li><p>Coordinating Node：协调节点</p><ul><li>负责接受Client的请求， 将请求分发到合适的节点，最终把结果汇集到一起 </li><li>每个节点默认都起到了Coordinating Node的职责</li></ul></li></ul><h1 id="3-分片和副本"><a href="#3-分片和副本" class="headerlink" title="3 分片和副本"></a>3 分片和副本</h1><h2 id="3-1-分片"><a href="#3-1-分片" class="headerlink" title="3.1 分片"></a>3.1 分片</h2><ul><li><p>ES 通过水平拆分的方式将一个索引上的数据拆分出来分配到不同的数据块上，分布在多台服务器上存储，拆分出来的数据库块称之为一个分片。</p></li><li><p>一个索引（index）由多个shard（分片）组成，而分片是分布在不同的服务器上的</p></li><li><p>主分片数在索引创建时指定，后续不允许修改，除非Reindex</p></li></ul><h2 id="3-2-副本"><a href="#3-2-副本" class="headerlink" title="3.2 副本"></a>3.2 副本</h2><ul><li>用以解决数据高可用的问题。 副本分片是主分片的拷贝 </li><li>副本分片数，可以动态调整 </li><li>增加副本数，还可以在一定程度上提高服务的可用性(读取的吞 吐)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span> # 指定索引的主分片和副本分片数 <br>  PUT /blogs  &#123;<br> <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>   <span class="hljs-string">&quot;number_of_shards&quot;</span>: <span class="hljs-number">3</span>,<br>   <span class="hljs-string">&quot;number_of_replicas&quot;</span>: <span class="hljs-number">1</span> <br> &#125; &#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221807970.png" alt="image-20230228221807970"></p><h2 id="3-2-1-设置副本分片数"><a href="#3-2-1-设置副本分片数" class="headerlink" title="3.2.1 设置副本分片数"></a>3.2.1 <strong>设置副本分片数</strong></h2><p>副本是主分片的拷贝： </p><ul><li><p>提高系统可用性︰响应查询请求，防止数据丢失 </p></li><li><p>需要占用和主分片一样的资源</p></li></ul><p>对性能的影响：</p><ul><li><p>分片间的数据同步会占用一定的网络带宽，影响效率</p></li><li><p>会减缓对主分片的查询压力，但是会消耗同样的内存资源。如果机器资源充分， 提高副本数，可以提高整体的查询QPS</p></li></ul><h1 id="4-Elasticsearch文档写入原理"><a href="#4-Elasticsearch文档写入原理" class="headerlink" title="4 Elasticsearch文档写入原理"></a>4 Elasticsearch文档写入原理</h1><ol><li>客户端选择一个node发送请求过去，这个node就是coordinating node (协调节 点)</li><li>coordinating node计算得到文档要写入的分片。默认是 <code>hash(文档的id) % 主分片数</code></li><li>coordinating node，对document进行路由，将请求转发给对应的node </li><li>node上的primary shard处理请求，然后将数据同步到replica node </li><li>coordinating node如果发现primary node和所有的replica node都保存好了文档， 就会返回请求到客户端</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221821340.png" alt="image-20230228221821340"></p><h1 id="5-ES读取数据的过程"><a href="#5-ES读取数据的过程" class="headerlink" title="5 ES读取数据的过程"></a>5 <strong>ES读取数据的过程</strong></h1><h2 id="5-1-根据id查询数据的过程"><a href="#5-1-根据id查询数据的过程" class="headerlink" title="5. 1 根据id查询数据的过程"></a>5. 1 <strong>根据id查询数据的过程</strong></h2><ol><li>客户端发送请求到任意一个 node，成为 coordinate node</li><li>coordinate node 对 doc id 进行哈希路由，将请求转发到对应的 node，此时会 使用 round-robin 随机轮询算法，在 primary shard 以及其所有 replica 中随机选择一个，让读请求负载均衡。</li><li>接收请求的 node 返回 document 给 coordinate node</li><li>coordinate node 返回 document 给客户端。</li></ol><blockquote><p>根据 doc id 进行 hash，判断出来当时把 doc id 分配到了哪个 shard 上面去，从那个 shard 去查询。</p></blockquote><h2 id="5-2-根据关键词查询数据的过程"><a href="#5-2-根据关键词查询数据的过程" class="headerlink" title="5.2 根据关键词查询数据的过程"></a>5.2 <strong>根据关键词查询数据的过程</strong></h2><ol><li>客户端发送请求到一个 coordinate node 。</li><li>协调节点将查询请求广播到每一个数据节点，这些数据节点的分片会处理该查询请求 </li><li><strong>query phase</strong>：每个 shard 将自己的搜索结果（包括：文档ID、节点信息、分片信息）返回给协调节点，由协调节点进行 数据的合并、排序、分页等操作，产出最终结果</li><li><strong>fetch phase：</strong>接着由协调节点根据 doc id 去各个节点上拉取实际的 document 数据，最终返回给客户端。</li></ol>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>集群</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch知识点总结</title>
    <link href="/ElasticSearch%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"/>
    <url>/ElasticSearch%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Es是什么？"><a href="#1-Es是什么？" class="headerlink" title="1 Es是什么？"></a>1 Es是什么？</h1><ul><li>Elasticsearch是用Java开发并且是当前最流行的开源的<strong>企业级搜索引擎</strong>。</li><li>能够达到实时搜索，稳定，可靠，快速，安装使用方便。</li><li>客户端支持Java、.NET（C#）、PHP、Python、Ruby等多种语言。</li></ul><h1 id="2-为什么要使用ES"><a href="#2-为什么要使用ES" class="headerlink" title="2 为什么要使用ES?"></a>2 为什么要使用ES?</h1><ul><li>数据量在几万或者几十万时候，所以采用以往的模糊查询，实时与数据库交互，会导致效率特别低下</li><li>不能将搜索词拆分开来，如果采用以往的模糊查询，比如 <code>name</code> &#x3D;’手机%’， 只能搜索名字是“手机”开头的手机商品，如果想搜出“华为手机”或者”手机壳“那是搜索不出来的。</li></ul><h1 id="3-Es和传统关系性数据库比较"><a href="#3-Es和传统关系性数据库比较" class="headerlink" title="3 Es和传统关系性数据库比较"></a>3 Es和传统关系性数据库比较</h1><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224035138.png" alt="image-20230228224035138"></p><h1 id="4-什么是全文检索"><a href="#4-什么是全文检索" class="headerlink" title="4 什么是全文检索"></a>4 什么是全文检索</h1><ul><li>全文检索是指：通过一个程序扫描文本中的每一个单词，针对单词建立索引，并保存该单词在文本中的位置、以及出现的次数。</li><li>用户查询时，通过之前建立好的索引来查询，将索引中单词对应的文本位置、出现的次数返回给用户，因为有了具体文本的位置，所以就可以将具体内容读取出来了</li></ul><h1 id="5-什么是倒排索引？"><a href="#5-什么是倒排索引？" class="headerlink" title="5 什么是倒排索引？"></a>5 什么是倒排索引？</h1><p>对于关系型数据库mysql来说，<strong>普通的索引结构就是“id-&gt;题目-&gt;内容”，</strong>在我们搜索的时候，如果我们知道id或者题目<strong>，那么检索效率是很高效的，因为“id”、“题目”是很方便创建索引的。</strong></p><p>那么<strong>倒排序索引</strong>的结构是怎样的呢？简单来讲<strong>就是“以内容的关键词”建立索引，</strong>映射关系为<strong>“内容的关键词-&gt;ID”。</strong>这样的话，我们只需要在“关键词”中进行检索</p><h1 id="6-Elasticsearch中的核心概念"><a href="#6-Elasticsearch中的核心概念" class="headerlink" title="6 Elasticsearch中的核心概念"></a>6 Elasticsearch中的核心概念</h1><h2 id="6-1-索引index"><a href="#6-1-索引index" class="headerlink" title="6.1 索引index"></a>6.1 索引index</h2><p>类似于数据库中的<strong>库</strong>，存放拥有某些共同特征的文档的集合。</p><h2 id="6-2-字段类型Type"><a href="#6-2-字段类型Type" class="headerlink" title="6.2 字段类型Type"></a>6.2 字段类型Type</h2><p>类似于数据库中的<strong>表</strong>， 在7.0开始，一个索引只能建一个Type为<code>_doc</code></p><h2 id="6-4-字段Field"><a href="#6-4-字段Field" class="headerlink" title="6.4 字段Field"></a>6.4 字段Field</h2><p>相当于是数据表的字段|列</p><h2 id="6-5-文档document"><a href="#6-5-文档document" class="headerlink" title="6.5 文档document"></a>6.5 文档document</h2><p>一个文档是一个可被索引的基础信息单元，类似一条记录。文档以JSON（JavascriptObjectNotation）格式来表示；</p><h2 id="6-6-映射mapping"><a href="#6-6-映射mapping" class="headerlink" title="6.6 映射mapping"></a>6.6 映射mapping</h2><p>mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分词器、是否被索引等等，这些都是映射里面可以设置的</p>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql分库分表</title>
    <link href="/mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"/>
    <url>/mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-分库分表是什么"><a href="#1-分库分表是什么" class="headerlink" title="1 分库分表是什么"></a>1 分库分表是什么</h1><ul><li>分库：从单个数据库拆分成多个数据库的过程，将数据散落在多个数据库中。</li><li>分表：从单张表拆分成多张表的过程，将数据散落在多张表内。</li></ul><h1 id="2-分库分表有什么用"><a href="#2-分库分表有什么用" class="headerlink" title="2 分库分表有什么用"></a>2 <strong>分库分表有什么用</strong></h1><p>分库分表就是为了解决由于数据量过大而导致数据库性能降低的问题</p><h1 id="3-分库分表的方式"><a href="#3-分库分表的方式" class="headerlink" title="3 分库分表的方式"></a>3 <strong>分库分表的方式</strong></h1><ul><li>分库分表包含分库和分表 两个部分，而这两个部分可以统称为数据分片，其目的都是将数据拆分成不同的存储单元。</li><li>从分拆的角度上，可以分为垂直分片和水平分片</li></ul><h2 id="3-1-垂直分片"><a href="#3-1-垂直分片" class="headerlink" title="3.1 垂直分片"></a>3.1 垂直分片</h2><ul><li>按照业务来对数据进行分片，按照业务将表进行归类，分布到不同的数据库或表中，从而将压力分散至不同的数据库或表。</li><li>如果垂直分片之后，表中的数据量依然超过单节点所能承载的阈值，则需要水平分片来进一步处理。</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221440881.png" alt="image-20230228221440881"></p><h2 id="3-2-水平分片"><a href="#3-2-水平分片" class="headerlink" title="3.2 水平分片"></a>3.2 水平分片</h2><ul><li>又称横向分片。通过某个字段(或某几个字段)，根据某种规则将数据分散至多个库或表中，每个分片仅包含数据的一部分</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221453079.png" alt="image-20230228221453079"></p><h3 id="3-2-1-水平分片常用的分片策略"><a href="#3-2-1-水平分片常用的分片策略" class="headerlink" title="3.2.1 水平分片常用的分片策略"></a>3.2.1 水平分片常用的分片策略</h3><ul><li>精准分片，比如：取余\取模 。 优点均匀存放数据，缺点 扩容非常麻烦，如果新加一台服务器，之前的老数据就得做迁移</li><li>按照范围分片 ： 当我们 SQL中的分片健字段用到 <code>BETWEEN AND</code>操作符会使用到此算法，比如订单id在1至100存放到一张表，200到300在另一张。</li></ul><h1 id="4-分库分表要解决哪些问题"><a href="#4-分库分表要解决哪些问题" class="headerlink" title="4 分库分表要解决哪些问题"></a>4 分库分表要解决哪些问题</h1><ul><li>事务一致性问题</li></ul><p>原本单机数据库有很好的事务机制能够帮我们保证数据一致性。但是分库分表后，由于数据分布在不同库甚至不同服务器，不可避免会带来分布式事务问题。</p><ul><li>跨节点关联查询问题</li></ul><p>在没有分库时，我们可以进行很容易的进行跨表的关联查询。但是在分库后，表被分散到了不同的数据库，就无法进行关联查询了。这时就需要将关联查询拆分成多次查询，然后将获得的结果进行拼装。</p><ul><li>跨节点分页、排序函数</li></ul><p>跨节点多库进行查询时，limit分页、order by排序等问题，就变得比较复杂了。需要先在不同的分片节点中将数据进行排序并返回，然后将不同分片返回的结果集进行汇总和再次排序。这时非常容易出现内存崩溃的问题。</p><ul><li>主键避重问题</li></ul><p>在分库分表环境中，由于表中数据同时存在不同数据库中，主键值平时使用的自增长将无用武之地，某个分区数据库生成的ID无法保证全局唯一。因此需要单独设计全局主键，以避免跨库主键重复问题。</p><ul><li>公共表处理</li></ul><p>实际的应用场景中，参数表、数据字典表等都是数据量较小，变动少，而且属于高频联合查询的依赖表。这一类表一般就需要在每个数据库中都保存一份，并且所有对公共表的操作都要分发到所有的分库去执行。</p><ul><li>运维工作量</li></ul><p>面对散乱的分库分表之后的数据，应用开发工程师和数据库管理员对数据库的操作都变得非常繁重。对于每一次数据读写操作，他们都需要知道要往哪个具体的数据库的分表去操作，这也是其中重要的挑战之一。</p><h1 id="5-什么时候需要分库分表？"><a href="#5-什么时候需要分库分表？" class="headerlink" title="5 什么时候需要分库分表？"></a>5 <strong>什么时候需要分库分表？</strong></h1><p>在阿里巴巴公布的开发手册中，建议MySQL单表记录如果达到500W这个级别，或者单表容量达到2GB，一般就建议进行分库分表。</p><h1 id="6-常见的分库分表组件"><a href="#6-常见的分库分表组件" class="headerlink" title="6 常见的分库分表组件"></a>6 <strong>常见的分库分表组件</strong></h1><p>ShardingSphere，mycat， DBLE</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分库分表</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitMq集群</title>
    <link href="/rabbitMq%E9%9B%86%E7%BE%A4/"/>
    <url>/rabbitMq%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="普通集群模式"><a href="#普通集群模式" class="headerlink" title="普通集群模式"></a>普通集群模式</h1><ul><li><p><strong>queue的消息</strong>，只会放在<strong>一个rabbtimq实例</strong>上。<strong>每个实例都同步queue的结构和queue消息的真正位置</strong>。</p></li><li><p>消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从queue所在实例上拉取数据过来。</p></li></ul><p>这种集群模式的消息可靠性不是很高。因为如果其中有个节点服务宕机了，那这个节点上的数据就无法消费了，需要等到这个节点服务恢复后才能消费。</p><h1 id="镜像集群模式"><a href="#镜像集群模式" class="headerlink" title="镜像集群模式"></a>镜像集群模式</h1><ul><li><p>这种模式是在普通集群模式基础上的一种增强方案，这也就是RabbitMQ的官方HA高可用方案。</p></li><li><p>这种模式会在镜像节点中间主动进行消息同步，而不是在客户端拉取消息时临时同步。这种模式的消息可靠性更高，因为每个节点上都存着全量的消息。</p></li><li><p>他的弊端也是明显的，集群内部的网络带宽会被这种同步通讯大量的消耗，进而降低整个集群的性能。这种模式下，队列数量最好不要过多。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>集群</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mysql集群</title>
    <link href="/Mysql%E9%9B%86%E7%BE%A4/"/>
    <url>/Mysql%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="1-主从模式"><a href="#1-主从模式" class="headerlink" title="1 主从模式"></a>1 主从模式</h1><ul><li>一个master可以拥有多个slave，一个slave只对应一个master</li><li><strong>一主多从，主负责写，并且将数据复制到其它的 slave 节点，从节点负责读</strong>。</li><li>所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑<strong>读高并发</strong>。</li><li>一主多从的结构，主要目的是实现数据的多点备份（没有故障自动转移和负载均衡）</li></ul><p>缺点：</p><ul><li>从库要从binlog获取数据并重放，这肯定与主库写入数据存在时间延迟，因此从库的数据总是要滞后主库。</li><li>对主库与从库之间的网络延迟要求较高，若网络延迟太高，将加重上述的滞后，造成最终数据的不一致。</li><li>单一的主节点挂了，将不能对外提供写服务。</li></ul><h2 id="1-1-Mysql主从复制工作原理"><a href="#1-1-Mysql主从复制工作原理" class="headerlink" title="1.1 Mysql主从复制工作原理"></a>1.1 Mysql主从复制工作原理</h2><p>数据库的主从同步，就是为了要保证多个数据库之间的数据保持一致。</p><ul><li><p>最简单的方式就是使用数据库的导入导出工具，定时将主库的数据导出，再导入到从库当中。这是一种很常见，也很简单易行的数据库集群方式。但是这种方式进行数据同步的实时性比较差。</p></li><li><p>如果要保证数据能够实时同步，对于MySQL，通常就要用到他自身提供的一套通过Binlog日志在多个MySQL服务之间进行同步的集群方案。</p></li></ul><p><strong>Binlog复制流程详解：</strong></p><ul><li>主库上打开Binlog日志，记录对数据的每一步操作</li><li>当主库有数据更新的时候，会通知从库</li><li>从库会向主库请求binlog日志，但为了保证日志接收的稳定性，并不会立即重演Binlog数据操作，而是先将接收到的Binlog日志写入到自己的RelayLog日志当中</li><li>从库检测到RelayLog中的操作日志有更新，就会在自己数据库中进行异步重演。</li></ul><blockquote><p>MySQL的BinLog日志能够比较实时的记录主库上的所有日志操作，因此他也被很多其他工具用来实时监控MySQL的数据变化。如：</p><ul><li>转发到Redis实现缓存一致</li><li>ClickHouse也支持将自己模拟成一个MySQL的从节点，接收MySQL的Binlog日志，实时同步MySQL的数据。这个功能目前还在实验阶段。</li></ul></blockquote><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224830814.png" alt="image-20230228224830814"></p><h2 id="1-2-主从复制的策略"><a href="#1-2-主从复制的策略" class="headerlink" title="1.2 主从复制的策略"></a>1.2 主从复制的策略</h2><ol><li><strong>「同步策略」</strong>：Master会等待所有的Slave都回应后才会提交，这个主从的同步的性能会严重的影响。</li><li><strong>「半同步策略」</strong>：Master至少会等待一个Slave回应并写入relay log后提交。</li><li><strong>「异步策略」</strong>：Master不用等待Slave回应就可以提交。</li></ol><h2 id="1-3-日志记录上position方式和GTID方式区别"><a href="#1-3-日志记录上position方式和GTID方式区别" class="headerlink" title="1.3 日志记录上position方式和GTID方式区别"></a>1.3 <strong>日志记录上position方式和GTID方式区别</strong></h2><ul><li>主从复制,默认是通过pos复制(postion)方式,将用户进行的每一项操作都进行编号(pos)，在配置从服务时，就需要通过这个Position通知从服务从哪个地方开始记录binLog。</li><li>GTID (Global Transaction ID全局事务ID)就是类似于pos的一个作用,全局通用并且日志文件里事件的GTID值是一致的。不用以前那样在需要找log_file和log_Pos。</li><li>从架构设计的角度，GTID是一种很好的分布式ID实践方式</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224842796.png" alt="image-20230228224842796"></p><h1 id="2-MySQL-Fabric-模式"><a href="#2-MySQL-Fabric-模式" class="headerlink" title="2 MySQL Fabric 模式"></a>2 MySQL Fabric 模式</h1><ul><li>MySQL Fabric能“组织”多个MySQL数据库，是应用系统将大于几TB的表分散到多个数据库，即数据分片(Data Shard)。</li><li>在同一个分片内又可以含有多个数据库，并且由Fabric<strong>自动</strong>挑选一个适合的作为主数据库，其他的数据库配置成从数据库，来做主从复制。</li><li>在主数据库挂掉时，从各个从数据库中挑选一个提升为主数据库。</li></ul><h1 id="3-MySQL-Cluster-模式"><a href="#3-MySQL-Cluster-模式" class="headerlink" title="3 MySQL Cluster 模式"></a>3 MySQL Cluster 模式</h1><ul><li>MySQL Cluster是多主多从结构的</li></ul><p>可参考redis cluster</p><h1 id="4-第三方优化"><a href="#4-第三方优化" class="headerlink" title="4 第三方优化"></a>4 第三方优化</h1><h2 id="4-1-MMM-模式"><a href="#4-1-MMM-模式" class="headerlink" title="4.1 MMM 模式"></a>4.1 MMM 模式</h2><ul><li><p>MMM（Master Replication Manager for MySQL）是<strong>双主多从</strong>结构。</p></li><li><p>这是Google的开源项目，使用Perl语言来对MySQL 主从做扩展，提供一套支持双主故障切换和双主日常管理的脚本程序，主要用来监控mysql主主复制并做失败转移。</p></li><li><p>他需要两个Master，同一时间只有一个Master对外提供服务，可以说是主备模式。</p></li><li><p>他是通过一个VIP(虚拟IP)的机制来保证集群的高可用。整个集群中，在主节点上会通过一个VIP地址来提供数据读写服务，而当出现故障时，VIP就会从原来的主节点漂移到其他节点，由其他节点提供服务。</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224851424.png" alt="image-20230228224851424"></p><h3 id="4-1-1优点："><a href="#4-1-1优点：" class="headerlink" title="4.1.1优点："></a>4.1.1优点：</h3><ul><li><p>提供了读写VIP的配置，使读写请求都可以达到高可用</p></li><li><p>工具包相对比较完善，不需要额外的开发脚本</p></li><li><p>完成故障转移之后可以对MySQL集群进行高可用监控</p></li></ul><h3 id="4-1-2-缺点："><a href="#4-1-2-缺点：" class="headerlink" title="4.1.2 缺点："></a><em>4.1.2 缺点：</em></h3><ul><li><p>故障简单粗暴，容易丢失事务，建议采用半同步复制方式，减少失败的概率</p></li><li><p>目前MMM社区已经缺少维护，不支持基于GTID的复制</p></li></ul><h3 id="4-1-3-适用场景："><a href="#4-1-3-适用场景：" class="headerlink" title="4.1.3 适用场景："></a>4.1.3 <strong>适用场景：</strong></h3><ul><li><p>读写都需要高可用的</p></li><li><p>基于日志点的复制方式</p></li></ul><h2 id="4-2-MHA-模式"><a href="#4-2-MHA-模式" class="headerlink" title="4.2 MHA 模式"></a>4.2 <strong>MHA</strong> 模式</h2><ul><li>MHA（Master High Availability）是<strong>多主多从</strong>结构，</li><li>是由日本人开发的一个基于Perl脚本写的工具。这个工具专门用于监控主库的状态，当发现master节点故障时，会提升其中拥有新数据的slave节点成为新的master节点，在此期间，MHA会通过其他从节点获取额外的信息来避免数据一致性方面的问题。</li><li>MHA还提供了mater节点的在线切换功能，即按需切换master-slave节点。MHA能够在30秒内实现故障切换，并能在故障切换过程中，最大程度的保证数据一致性。</li></ul><h3 id="4-2-1-优点："><a href="#4-2-1-优点：" class="headerlink" title="4.2.1 优点："></a>4.2.1 优点：</h3><ul><li><p>MHA除了支持日志点的复制还支持GTID的方式</p></li><li><p>同MMM相比，MHA会尝试从旧的Master中恢复旧的二进制日志，只是未必每次都能成功。如果希望更少的数据丢失场景，建议使用MHA架构。</p></li></ul><h3 id="4-2-2-缺点："><a href="#4-2-2-缺点：" class="headerlink" title="4.2.2 缺点："></a>4.2.2 缺点：</h3><ul><li><p>MHA需要自行开发VIP转移脚本。</p></li><li><p>MHA只监控Master的状态，未监控Slave的状态</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>集群</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>zookeeper的使用场景</title>
    <link href="/zookeeper%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/"/>
    <url>/zookeeper%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="1-ZooKeeper-实现分布式-ID"><a href="#1-ZooKeeper-实现分布式-ID" class="headerlink" title="1 ZooKeeper 实现分布式 ID"></a>1 ZooKeeper 实现分布式 ID</h1><h2 id="1-1-为什么需要分布式ID"><a href="#1-1-为什么需要分布式ID" class="headerlink" title="1.1 为什么需要分布式ID"></a>1.1 为什么需要分布式ID</h2><p>在单体结构的应用中，我们可以使用 MySQL 数据库的主键自增来为我们的数据设置唯一标识 ID，但是在分布式环境中，单个数据库的吞吐量成为整个应用的性能瓶颈，我们就可以搭建数据库集群来提升数据库的性能，此时如果还使用 MySQL 的主键自增来设置数据 ID 的话，就会出现重复的 ID，这样就会出现主键冲突的情况。</p><p>如果使用分布式的全局唯一 ID 就不用担心会出现这个问题了</p><h2 id="1-2-实现方式"><a href="#1-2-实现方式" class="headerlink" title="1.2 实现方式"></a>1.2 实现方式</h2><h3 id="1-2-1-UUID实现分布式-ID"><a href="#1-2-1-UUID实现分布式-ID" class="headerlink" title="1.2.1 UUID实现分布式 ID"></a>1.2.1 <strong>UUID实现分布式 ID</strong></h3><ul><li>在 Java 中可以使用 java.util.UUID 的 randomUUID() 方法来获得：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.util.UUID.randomUUID().toString();<br></code></pre></td></tr></table></figure><p>UUID 可以在本地生成，生成速度快，不依赖网络和其它服务，但是 UUID 没有可以识别的特点，也没有顺序性。</p><h3 id="1-2-2-Redis实现分布式-ID"><a href="#1-2-2-Redis实现分布式-ID" class="headerlink" title="1.2.2 Redis实现分布式 ID"></a>1.2.2 <strong>Redis实现分布式 ID</strong></h3><p>使用 Redis 的 Incr 命令来把 &lt;key,value&gt; 中 key 的数值加 1 并返回，如果这个 key 不存在，则 key 值会被初始化为 0，再执行 Incr 命令来进行加 1 操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 使用 incr(key) 来让 key 加 1</span><br><span class="hljs-keyword">long</span> id = jedis.incr(<span class="hljs-string">&quot;id&quot;</span>);<br></code></pre></td></tr></table></figure><p>使用 Redis 的方式生成分布式 ID 需要依赖 Redis 服务，还要保证 Redis 的高可用，否则 Redis 服务宕机会影响整个应用。</p><h3 id="1-2-3-Zookeeper-实现分布式-ID"><a href="#1-2-3-Zookeeper-实现分布式-ID" class="headerlink" title="1.2.3 Zookeeper 实现分布式 ID"></a>1.2.3 Zookeeper 实现分布式 ID</h3><p>在 Zookeeper 中，我们可以使用 Zookeeper 的 顺序节点来完成分布式 ID 的生成</p><p>顺序节点，在 Zookeeper 客户端创建顺序节点时，Zookeeper 会根据创建的时间顺序，在节点名称后添加 10 位的顺序编号。</p><h1 id="2-Zookeeper-实现负载均衡"><a href="#2-Zookeeper-实现负载均衡" class="headerlink" title="2  Zookeeper 实现负载均衡"></a>2  Zookeeper 实现负载均衡</h1><h2 id="2-1-为什么需要做负载均衡"><a href="#2-1-为什么需要做负载均衡" class="headerlink" title="2.1 为什么需要做负载均衡"></a>2.1 为什么需要做负载均衡</h2><p>在分布式的环境中，我们常常使用集群部署的方式来提高某个服务的可用性，为了让高并发的请求能够平均的分配到集群中的每一个服务，避免有些服务压力过大，而有些服务处于空闲状态这样的情况，我们需要制定一些规则来把请求进行路由，这种分配请求的做法就叫做负载均衡，路由请求的规则就是负载均衡的策略。</p><h2 id="2-2-负载均衡的策略"><a href="#2-2-负载均衡的策略" class="headerlink" title="2.2 负载均衡的策略"></a>2.2 负载均衡的策略</h2><h3 id="3-2-1-轮询策略"><a href="#3-2-1-轮询策略" class="headerlink" title="3.2.1 轮询策略"></a>3.2.1 <strong>轮询策略</strong></h3><ul><li>轮询策略就是按照集群的服务列表的顺序，依次进行请求的分配，直到列表中所有的服务都分配了一次请求，就完成了一轮的请求分配，然后再从第一个服务开始分配请求。</li><li>轮询策略是很多负载均衡技术的默认策略，这样的方式保证了的每个服务所承受的请求压力是平均的，我们可以把服务列表按照顺序放到一个数组来循环分配请求。</li></ul><h3 id="3-2-2-随机策略"><a href="#3-2-2-随机策略" class="headerlink" title="3.2.2 随机策略"></a>3.2.2 <strong>随机策略</strong></h3><ul><li>随机策略就是根据随机算法把请求随机的分配给服务列表中的任意一个服务。</li><li>随机策略的实现方式：我们可以把服务列表放到一个数组，然后根据数组的长度来获取随机数，取到的随机数就是服务在数组中的索引，根据这个索引，我们就可以拿到服务地址来发送请求了</li></ul><h3 id="3-2-3-一致性哈希策略"><a href="#3-2-3-一致性哈希策略" class="headerlink" title="3.2.3 一致性哈希策略"></a>3.2.3 <strong>一致性哈希策略</strong></h3><ul><li>一致性哈希策略的实现方式：我们先把服务列表中的地址进行哈希计算，把计算后的值放到哈希环上，接收到请求后，根据请求的固定属性值来进行哈希计算，然后根据请求的哈希值在哈希环上顺时针寻找服务地址的哈希值，寻找到哪个服务地址的哈希值，就把请求分配给哪个服务。</li></ul><h3 id="3-2-4-加权轮询策略"><a href="#3-2-4-加权轮询策略" class="headerlink" title="3.2.4 加权轮询策略"></a>3.2.4 <strong>加权轮询策略</strong></h3><p>加权轮询策略就是在轮询策略的基础上，对 Server 地址进行加权处理，除了按照服务地址列表的顺序来分配请求外，还要按照权重大小来决定请求的分配次数。加权的目的是为了让性能和网络较好的服务多承担请求分配的压力。</p><p>比如 Server_1 的权重是 3，Server_2 的权重是 2，Server_3 的权重是 1，那么在进行请求分配时，Server_1 会被分配 3 次请求，Server_2 会被分配 2 次请求，Server_3 会被分配 1 次请求，就这样完成一轮请求的分配，然后再从 Server_1 开始进行分配。</p><h3 id="3-2-5-加权随机策略"><a href="#3-2-5-加权随机策略" class="headerlink" title="3.2.5 加权随机策略"></a>3.2.5 <strong>加权随机策略</strong></h3><p>加权随机策略就是在随机策略的基础上，对 Server 地址进行加权处理，Server 地址的加权有多少，那么 Server 地址的数组中的地址就会有几个，然后再从这个数组中进行随机选址。</p><h3 id="3-2-6-最小连接数策略"><a href="#3-2-6-最小连接数策略" class="headerlink" title="3.2.6 最小连接数策略"></a>3.2.6 <strong>最小连接数策略</strong></h3><p>最小连接数策略，就是根据客户端与服务端会话数量来决定请求的分配情况，它会把请求分配到会话数量小的服务，会话的数量越少，也能说明服务的性能和网络较好。</p><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><p>把ZooKeeper作为一个服务的<a href="https://cloud.tencent.com/product/tse?from=10680">注册中心</a>，在其中登记每个服务，每台服务器知道自己是属于哪个服务，在服务器启动时，自己向所属服务进行登记，这样，一个树形的服务结构就呈现出来了</p><p>服务的调用者到注册中心里面查找：能提供所需服务的服务器列表，然后自己根据负载均衡算法，从中选取一台服务器进行连接</p><h1 id="3-Zookeeper-实现配置中心"><a href="#3-Zookeeper-实现配置中心" class="headerlink" title="3 Zookeeper 实现配置中心"></a>3 Zookeeper 实现配置中心</h1><p>配置中心来更新配置的方式有两种，一种是由配置中心的配置更新后向服务推送更新的配置，另一种是服务定时轮询的方式的去配置中心拉取配置，发现配置中心的配置被更新就更新自己的配置。</p><p>Zookeeper 实现配置中心的方式：服务把自己的配置信息存储到 Zookeeper 节点的 data 上，并且对这个节点开启 Watch 监听，只要这个节点的数据发生变化，Zookeeper 就会把这个消息推送给服务，服务在回调事件中去获取该节点的数据，然后使用新的数据更新自己的配置。那么根据这个思路，我们就开始使用 Zookeeper 来实现配置中心。</p><h1 id="4-Zookeeper-实现分布式锁"><a href="#4-Zookeeper-实现分布式锁" class="headerlink" title="4 Zookeeper 实现分布式锁"></a>4 Zookeeper 实现分布式锁</h1><p><a href="https://pyr9.github.io/Zookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">Zookeeper实现分布式锁 - 楼上有只喵 (pyr9.github.io)</a></p><h1 id="5-Zookeeper-实现注册中心"><a href="#5-Zookeeper-实现注册中心" class="headerlink" title="5 Zookeeper 实现注册中心"></a>5 Zookeeper 实现注册中心</h1><p><a href="https://pyr9.github.io/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/">注册中心 - 楼上有只喵 (pyr9.github.io)</a></p>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>zookeeper节点介绍</title>
    <link href="/zookeeper%E8%8A%82%E7%82%B9%E4%BB%8B%E7%BB%8D/"/>
    <url>/zookeeper%E8%8A%82%E7%82%B9%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Zookeeper-数据模型"><a href="#1-Zookeeper-数据模型" class="headerlink" title="1 Zookeeper 数据模型"></a>1 Zookeeper 数据模型</h1><ul><li>Zookeeper 数据模型的结构是基于节点的，我们把这种节点叫做 <strong>Znode</strong> 。</li><li>节点之下可以包含子节点，这种结构和数据结构中的树类似，也和文件系统的目录类似。</li></ul><ul><li>每个节点拥有唯一的路径path.</li></ul><img src="https://tva1.sinaimg.cn/large/008i3skNly1gycegg0aihj30u00v0wgk.jpg" style="zoom: 33%;" /><h1 id="2-节点的结构"><a href="#2-节点的结构" class="headerlink" title="2 节点的结构"></a>2 节点的结构</h1><ul><li><strong>path</strong>:唯一路径 </li><li><strong>childNode</strong>：子节点</li><li><strong>stat</strong>:状态属性:即path对应的值</li><li><strong>type</strong>:节点类型</li></ul><h1 id="3-节点类型"><a href="#3-节点类型" class="headerlink" title="3 节点类型"></a>3 节点类型</h1><table><thead><tr><th align="left">类型</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">PERSISTENT</td><td align="left">持久节点</td></tr><tr><td align="left">PERSISTENT_SEQUENTIAL</td><td align="left">持久序号节点</td></tr><tr><td align="left">EPHEMERAL</td><td align="left">临时节点(不可在拥有子节点)</td></tr><tr><td align="left">EPHEMERAL_SEQUENTIAL</td><td align="left">临时序号节点(不可在拥有子节点)</td></tr></tbody></table><h2 id="3-1-PERSISTENT（持久节点）"><a href="#3-1-PERSISTENT（持久节点）" class="headerlink" title="3.1 PERSISTENT（持久节点）"></a>3.1 PERSISTENT（持久节点）</h2><ul><li>持久化保存的节点，也是默认创建的</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-operator">/</span>test<br></code></pre></td></tr></table></figure><h2 id="3-2-PERSISTENT-SEQUENTIAL-持久序号节点"><a href="#3-2-PERSISTENT-SEQUENTIAL-持久序号节点" class="headerlink" title="3.2 PERSISTENT_SEQUENTIAL(持久序号节点)"></a>3.2 PERSISTENT_SEQUENTIAL(持久序号节点)</h2><p>创建时zookeeper 会在路径上加上序号作为后缀。非常适合用于分布式锁、分布式选举等场景。创建时添加 -s 参数即可。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>s  <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>seq<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">13</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<br>Created <span class="hljs-operator">/</span>temp0000000004<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">14</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<br>Created <span class="hljs-operator">/</span>temp0000000005<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">15</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<br>Created <span class="hljs-operator">/</span>temp0000000006<br></code></pre></td></tr></table></figure><h2 id="3-3-EPHEMERAL（临时节点）"><a href="#3-3-EPHEMERAL（临时节点）" class="headerlink" title="3.3 EPHEMERAL（临时节点）"></a>3.3 EPHEMERAL（临时节点）</h2><ul><li>只存在于当前会话，当对话断开后会被删除。创建的时候增加 -e</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>seq<br></code></pre></td></tr></table></figure><ul><li>适用于心跳，服务发现等场景。如下图当node1挂掉了，它zookeeper1中创建的临时节点和其存储的数据就会就会被删除，zookeeper1就知道node1挂掉了。</li></ul><img src="/Users/panyurou/Library/Application Support/typora-user-images/image-20220116230200083.png" alt="image-20220116230200083" style="zoom: 33%;" /><h2 id="3-4-EPHEMERAL-SEQUENTIAL（临时序号节点）"><a href="#3-4-EPHEMERAL-SEQUENTIAL（临时序号节点）" class="headerlink" title="3.4 EPHEMERAL_SEQUENTIAL（临时序号节点）"></a>3.4 EPHEMERAL_SEQUENTIAL（临时序号节点）</h2><p>与持久序号节点类似，不同之处在于EPHEMERAL_SEQUENTIAL是临时的会在会话断开后删除。创建时添加 -e -s </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>seq<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">2</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c1<br>Created <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c10000000000<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">3</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c1<br>Created <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c10000000001<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">4</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c1<br>Created <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c10000000002<br></code></pre></td></tr></table></figure><h1 id="4-节点属性"><a href="#4-节点属性" class="headerlink" title="4 节点属性"></a>4 节点属性</h1><ul><li>查看节点属性</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">stat <span class="hljs-operator">/</span>temp<br></code></pre></td></tr></table></figure><ul><li>属性说明</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">cZxid <span class="hljs-operator">=</span> <span class="hljs-number">0x2</span>   #创建节点的事务ID<br>ctime <span class="hljs-operator">=</span> Mon Jan <span class="hljs-number">17</span> <span class="hljs-number">21</span>:<span class="hljs-number">09</span>:<span class="hljs-number">16</span> CST <span class="hljs-number">2022</span> #创建节点的时间<br>mZxid <span class="hljs-operator">=</span> <span class="hljs-number">0x2</span> #修改当前节点数据的事务ID<br>mtime <span class="hljs-operator">=</span> Mon Jan <span class="hljs-number">17</span> <span class="hljs-number">21</span>:<span class="hljs-number">09</span>:<span class="hljs-number">16</span> CST <span class="hljs-number">2022</span> #最后修改时间<br>pZxid <span class="hljs-operator">=</span> <span class="hljs-number">0x5</span> #子节点变更（包括自节点的删除和增加，不包括修改）的事务ID<br>cversion <span class="hljs-operator">=</span> <span class="hljs-number">3</span>  #这表示对此znode的子节点进行的更改次数，只包括自节点的删除和增加<br>dataVersion <span class="hljs-operator">=</span> <span class="hljs-number">0</span> #数据版本，当前节点数据变更次数<br>aclVersion <span class="hljs-operator">=</span> <span class="hljs-number">0</span> #权限版本，变更次数<br>ephemeralOwner <span class="hljs-operator">=</span> <span class="hljs-number">0x0</span> #临时节点所属会话ID，永久节点值为<span class="hljs-number">0x0</span><br>dataLength <span class="hljs-operator">=</span> <span class="hljs-number">0</span> #数据长度<br>numChildren <span class="hljs-operator">=</span> <span class="hljs-number">3</span> #子节点数(不包括子子节点)<br></code></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h1 id="5-Znode-节点的操作"><a href="#5-Znode-节点的操作" class="headerlink" title="5 Znode 节点的操作"></a>5 Znode 节点的操作</h1><h2 id="5-1-创建节点：-create"><a href="#5-1-创建节点：-create" class="headerlink" title="5.1 创建节点： create"></a>5.1 <strong>创建节点：</strong> <code>create</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建一个持久节点</span><br>create /persistent_node<br><span class="hljs-comment"># 创建一个持久的顺序节点</span><br>create -s /persistent_sequential_node<br><span class="hljs-comment"># 创建一个临时节点</span><br>create -e /ephemeral_node<br><span class="hljs-comment"># 创建一个临时的顺序节点</span><br>create -s -e /ephemeral_sequential_node<br><br><br>代码块12345678<br></code></pre></td></tr></table></figure><p>- </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"># 创建一个持久节点<br>create /persistent_node<br># 创建一个持久的顺序节点<br>create -s /persistent_sequential_node<br># 创建一个临时节点<br>create -e /ephemeral_node<br># 创建一个临时的顺序节点<br>create -s -e /ephemeral_sequential_node<br></code></pre></td></tr></table></figure><h2 id="5-2-删除节点：-delete"><a href="#5-2-删除节点：-delete" class="headerlink" title="5.2 删除节点： delete"></a>5.2 <strong>删除节点：</strong> <code>delete</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">delete /config/topics/test<br></code></pre></td></tr></table></figure><h2 id="5-3-获得一个节点的数据：-get"><a href="#5-3-获得一个节点的数据：-get" class="headerlink" title="5.3 获得一个节点的数据： get"></a>5.3 <strong>获得一个节点的数据：</strong> <code>get</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">get /persistent_node<br></code></pre></td></tr></table></figure><h2 id="5-4-设置一个节点的数据："><a href="#5-4-设置一个节点的数据：" class="headerlink" title="5.4 设置一个节点的数据："></a>5.4 <strong>设置一个节点的数据：</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">set /brokers myNewData<br></code></pre></td></tr></table></figure><h2 id="5-5-获取子节点："><a href="#5-5-获取子节点：" class="headerlink" title="5.5 获取子节点："></a>5.5 <strong>获取子节点：</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"># 获取根节点下的子节点<br>ls /<br># 根节点下的子节点有 zk-watcher-<span class="hljs-number">2</span>，zookeeper<br>[zk-watcher-<span class="hljs-number">2</span>, zookeeper]<br></code></pre></td></tr></table></figure><h1 id="6-节点的监听"><a href="#6-节点的监听" class="headerlink" title="6 节点的监听"></a>6 节点的监听</h1><p>客户添加 -w 参数可实时监听节点与子节点的变化，并且实时收到通知。非常适用保障分布式情况下的数据一致性。其使用方式如下：</p><table><thead><tr><th align="left">命令</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">ls -w path</td><td align="left">监听子节点的变化（增，删）</td></tr><tr><td align="left">get -w path</td><td align="left">监听节点数据的变化</td></tr><tr><td align="left">stat -w path</td><td align="left">监听节点属性的变化</td></tr><tr><td align="left">printwatches on|off</td><td align="left">触发监听后，是否打印监听事件(默认on)</td></tr></tbody></table><h2 id="6-1-监听节点数据的变化"><a href="#6-1-监听节点数据的变化" class="headerlink" title="6.1 监听节点数据的变化"></a>6.1 监听节点数据的变化</h2><ul><li><p>step1：打开客户端A</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">get</span> <span class="hljs-operator">-</span>w  <span class="hljs-operator">/</span>temp<br></code></pre></td></tr></table></figure></li><li><p>Step2：打开客户端B:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-operator">/</span>temp &quot;aaa&quot;<br></code></pre></td></tr></table></figure></li><li><p>此时客户端A，出现：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">8</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">-</span>w  <span class="hljs-operator">/</span>temp<br><span class="hljs-keyword">null</span><br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">9</span>]<br>WATCHER::<br><br>WatchedEvent state:SyncConnected type:NodeDataChanged path:<span class="hljs-operator">/</span>temp<br></code></pre></td></tr></table></figure></li><li><p>再次在客户端B输入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-operator">/</span>temp &quot;ddd&quot;<br></code></pre></td></tr></table></figure><p>此时可以发现，客户端A没有收到任何通知，故这里的watch是一次性的，第二次触发不再生效。</p></li></ul><h2 id="6-2-监听子节点的变化"><a href="#6-2-监听子节点的变化" class="headerlink" title="6.2 监听子节点的变化"></a>6.2 监听子节点的变化</h2><ul><li><p>step1：打开客户端A</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">ls <span class="hljs-operator">-</span>w  <span class="hljs-operator">/</span>temp<br></code></pre></td></tr></table></figure></li><li><p>Step2：打开客户端B:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>c1<br></code></pre></td></tr></table></figure></li><li><p>此时客户端A，出现：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">9</span>] ls <span class="hljs-operator">-</span>w <span class="hljs-operator">/</span>temp<br>[c10000000000, c10000000001, c10000000002]<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">10</span>]<br>WATCHER::<br><br>WatchedEvent state:SyncConnected type:NodeChildrenChanged path:<span class="hljs-operator">/</span>temp<br></code></pre></td></tr></table></figure></li></ul><h1 id="7-Zookeeper权限控制"><a href="#7-Zookeeper权限控制" class="headerlink" title="7 Zookeeper权限控制"></a>7 Zookeeper权限控制</h1><ul><li>ACL全称为Access Control List（访问控制列表），用于控制资源的访问权限。   </li><li>ZooKeeper使用ACL来控制对其znode的防问。</li><li>基于<code>scheme:id:permission</code>的方式进行权限控制。scheme表示授权模式、id模式对应值、permission即具体的增删改权限位。</li></ul><h2 id="7-1-scheme-授权模型"><a href="#7-1-scheme-授权模型" class="headerlink" title="7.1 scheme:授权模型"></a>7.1 scheme:授权模型</h2><table><thead><tr><th align="left">方案</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">world</td><td align="left">开放模式，world表示全世界都可以访问（这是默认设置）</td></tr><tr><td align="left">ip</td><td align="left">ip模式，限定客户端IP防问</td></tr><tr><td align="left">auth</td><td align="left">用户密码认证模式，只有在会话中添加了认证才可以防问</td></tr><tr><td align="left">digest</td><td align="left">与auth类似，区别在于auth用明文密码，而digest 用sha-1+base64加密后的密码。在实际使用中digest 更常见。</td></tr></tbody></table><h2 id="7-2-permission权限位"><a href="#7-2-permission权限位" class="headerlink" title="7.2 permission权限位"></a>7.2 <strong>permission权限位</strong></h2><table><thead><tr><th align="left">权限位</th><th align="left">权限</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">c</td><td align="left">CREATE</td><td align="left">可以创建子节点</td></tr><tr><td align="left">d</td><td align="left">DELETE</td><td align="left">可以删除子节点（仅下一级节点）</td></tr><tr><td align="left">r</td><td align="left">READ</td><td align="left">可以读取节点数据及显示子节点列表</td></tr><tr><td align="left">w</td><td align="left">WRITE</td><td align="left">可以设置节点数据</td></tr><tr><td align="left">a</td><td align="left">ADMIN</td><td align="left">可以设置节点访问控制列表权限</td></tr></tbody></table><h2 id="7-3-acl-相关命令"><a href="#7-3-acl-相关命令" class="headerlink" title="7.3 acl 相关命令"></a>7.3 acl 相关命令</h2><table><thead><tr><th align="left">命令</th><th align="left">使用方式</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">getAcl</td><td align="left">getAcl <path></td><td align="left">读取ACL权限</td></tr><tr><td align="left">setAcl</td><td align="left">setAcl <path> <acl></td><td align="left">设置ACL权限</td></tr><tr><td align="left">addauth</td><td align="left">addauth <scheme> <auth></td><td align="left">添加认证用户</td></tr></tbody></table><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><ul><li>world</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">11</span>] getAcl <span class="hljs-operator">/</span>temp<br><span class="hljs-string">&#x27;world,&#x27;</span>anyone<br>: cdrwa<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">12</span>] setAcl <span class="hljs-operator">/</span>temp world:anyone:rwa<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">13</span>] getAcl <span class="hljs-operator">/</span>temp<br><span class="hljs-string">&#x27;world,&#x27;</span>anyone<br>: rwa<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">14</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>temp<br>ddd<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">15</span>] <span class="hljs-keyword">set</span> <span class="hljs-operator">/</span>temp &quot;bbb&quot;<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">16</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>t<br>Insufficient permission : <span class="hljs-operator">/</span>temp<span class="hljs-operator">/</span>t<br></code></pre></td></tr></table></figure><ul><li><p>IP</p><p>语法： setAcl <path> ip:&lt;ip地址|地址段&gt;:&lt;权限位&gt;</p></li></ul><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[zk: localhost<span class="hljs-function">:2181</span><span class="hljs-params">(CONNECTED)</span> 18] <span class="hljs-keyword">set</span>Acl <span class="hljs-string">/temp</span> ip<span class="hljs-function">:192.168.2.103</span><span class="hljs-function">:ra</span><br>[zk: localhost<span class="hljs-function">:2181</span><span class="hljs-params">(CONNECTED)</span> 19] getAcl <span class="hljs-string">/temp</span><br>Insufficient permission : <span class="hljs-string">/temp</span><br></code></pre></td></tr></table></figure><ul><li><p>auth</p><p>语法： </p><ol><li>setAcl <path> auth:&lt;用户名&gt;:&lt;密码&gt;:&lt;权限位&gt;</li><li>addauth digest &lt;用户名&gt;:&lt;密码&gt;</li></ol></li><li><p>digest</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  <span class="hljs-operator">~</span> echo <span class="hljs-operator">-</span>n pyr:<span class="hljs-number">123456</span> <span class="hljs-operator">|</span> openssl dgst <span class="hljs-operator">-</span><span class="hljs-type">binary</span> <span class="hljs-operator">-</span>sha1 <span class="hljs-operator">|</span> openssl base64<br>zj9LbzdoKijw<span class="hljs-operator">/</span>kCo1pQJnXBFiq4<span class="hljs-operator">=</span><br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">zk: localhost:2181(CONNECTED) 28</span>] create /temp2<br>Created /temp2<br>[<span class="hljs-meta">zk: localhost:2181(CONNECTED) 30</span>] getAcl /temp2<br><span class="hljs-string">&#x27;world,&#x27;</span>anyone<br>: cdrwa<br>[<span class="hljs-meta">zk: localhost:2181(CONNECTED) 31</span>] setAcl /temp2 digest:pyr:zj9LbzdoKijw/kCo1pQJnXBFiq4=:rwa<br>[<span class="hljs-meta">zk: localhost:2181(CONNECTED) 32</span>] getAcl /temp2<br>Insufficient permission : /temp2<br>[<span class="hljs-meta">zk: 127.0.0.1:2181(CONNECTED) 45</span>] addauth digest pyr:<span class="hljs-number">123456</span><br>[<span class="hljs-meta">zk: 127.0.0.1:2181(CONNECTED) 46</span>] <span class="hljs-keyword">get</span> /temp2<br><span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zookeeper实现分布式锁</title>
    <link href="/Zookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/Zookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="1基于ZooKeeper的分布式锁。"><a href="#1基于ZooKeeper的分布式锁。" class="headerlink" title="1基于ZooKeeper的分布式锁。"></a>1基于ZooKeeper的分布式锁。</h1>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式锁</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis实现分布式锁</title>
    <link href="/Redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/Redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h2 id="1-基于Redis实现分布式锁"><a href="#1-基于Redis实现分布式锁" class="headerlink" title="1 基于Redis实现分布式锁"></a>1 <strong>基于Redis实现分布式锁</strong></h2><h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式锁</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>注册中心</title>
    <link href="/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"/>
    <url>/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/</url>
    
    <content type="html"><![CDATA[<h1 id="1-什么是注册中心"><a href="#1-什么是注册中心" class="headerlink" title="1 什么是注册中心"></a>1 什么是注册中心</h1><p>在微服务架构中，注册中心是核心的基础服务之一。</p><p>注册中心可以说是微服务架构中的”通讯录“，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到这里，当服务需要调用其它服务时，就到这里找到服务的地址，进行调用。</p><h1 id="2-为什么要有注册中心"><a href="#2-为什么要有注册中心" class="headerlink" title="2 为什么要有注册中心"></a>2 为什么要有注册中心</h1><p>通常，在微服务系统中，如果我们现在的会员服务要调订单服务，就只能把ip写死，一旦Ip变更，或者扩容（再增加机器），会员服务就感受不到</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221602827.png" alt="image-20230228221602827"></p><p>所以需要手动维护一个注册表，增加订单服务的时候，去注册表里注册（<strong>服务注册</strong>），需要调用的时候，先去注册表里查（<strong>服务发现</strong>），再调用。但是当某个节点宕机的时候，我们再去调用就有问题，所以需要借助某些手段可以自动感知到服务下线。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221614178.png" alt="image-20230228221614178"></p><h2 id="3-注册中心实现"><a href="#3-注册中心实现" class="headerlink" title="3 注册中心实现"></a>3 注册中心实现</h2><p>注册中心去实现的时候得支持服务注册和服务发现</p><ul><li>服务注册：就是需要维护一个注册表，存储服务和服务地址的映射关系。<strong>所以需要可以存储数据</strong></li><li>服务发现：当服务要调用的时候，通过读取服务注册表获取可用的服务信息，客户端可以通过此信息连接服务器</li></ul><p>注：</p><ol><li><p>为了提高性能，可以在server端，自己维护一份注册中心的缓存，只有第一次调用时才需要连接zookeeper或者redis</p></li><li><p>同一个server, 每次新加一个ip都需要重新查询一次,从而更新缓存。因此zookeeper和redis还能做注册中心的一个条件是，他们能够监听数据的变化（redis具有消费订阅，zookeeper具有watch机制），当数据发生改变时，会收到消息，从而更新列表 </p></li><li><p>某个IP对应的服务挂掉的时候，也需要更新注册表，因此需要类似心跳机制，来检测服务是否挂掉，挂掉后，需要移除该服务。（redis的过期时间，zookeeper的临时节点）</p></li></ol><h2 id="3-1-基于mysql-实现注册中心"><a href="#3-1-基于mysql-实现注册中心" class="headerlink" title="3.1 基于mysql 实现注册中心"></a>3.1 基于mysql 实现注册中心</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221628038.png" alt="image-20230228221628038"></p><ul><li>订单服务启动时，调用注册接口，也就是insert，将服务名，ip，端口以及状态进行存储，对应生成注册表</li><li>每次调用订单服务前，都先去注册表里查询服务列表，执行select</li><li>维护 一个心跳，定期去感应下节点状态是否正常，比如ping一下端口，如果不正常，修改此时节点状态</li></ul><h2 id="3-2-基于zookeeper实现注册中心"><a href="#3-2-基于zookeeper实现注册中心" class="headerlink" title="3.2 基于zookeeper实现注册中心"></a>3.2 基于zookeeper实现注册中心</h2><ul><li>创建父节点，用于管理服务节点</li><li>订单服务启动时，在这个父节点上创建临时子节点，用来存储服务和服务地址的映射关系，对应生成注册表</li><li>每次调用订单服务前，都先去注册表里查询服务列表</li><li>zookeeper有监听通知机制，可以天然感受到服务是否在线，如果对某个节点进行监听，当这个节点被删除，或者被修改时，监听方会感知到修改消息。所以这里，我们只需要监听父节点</li></ul><blockquote><p>创建该节点的 Zookeeper 客户端与 Zookeeper 服务端断开连接时，该节点会被 Zookeeper 服务端移除。使用临时节点来维护 Server 的地址列表就保证了请求不会被分配到已经停机的服务上。</p></blockquote><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228221650614.png" alt="image-20230228221650614"></p><h2 id="3-3-redis-实现注册中心"><a href="#3-3-redis-实现注册中心" class="headerlink" title="3.3 redis 实现注册中心"></a>3.3 redis 实现注册中心</h2>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>注册中心</tag>
      
      <tag>mysql实现注册中心</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM调优</title>
    <link href="/JVM%E8%B0%83%E4%BC%98/"/>
    <url>/JVM%E8%B0%83%E4%BC%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-调优原则"><a href="#1-调优原则" class="headerlink" title="1 调优原则"></a>1 调优原则</h1><ul><li><p><strong>多数导致GC问题的Java应⽤，都不是因为我们参数设置错误，⽽是代码问题</strong>；</p></li><li><p>实际使用中，分析GC优化代码，比优化JVM参数效果要好，JVM 参数的默认（推荐）值都是经过 JVM 团队的反复测试和前人的充分验证得出的比较合理的值，因此通常来说是比较靠谱和通用的，一般不会出大问题。</p></li><li><p>如果满足下面的指标，则一般不需要进行GC：</p><ul><li>Minor GC执行时间不到50ms，不低于10秒一次；</li><li>Full GC执行时间不到1s，不低于一小时1次；</li></ul></li></ul><h1 id="2-检查Full-GC-是否频繁"><a href="#2-检查Full-GC-是否频繁" class="headerlink" title="2. 检查Full GC 是否频繁"></a>2. 检查Full GC 是否频繁</h1><p>可以通过<code>jstat -gc pid interval count</code>，每隔interval秒，打印count次，pid进程下GC压力整体情况。观察是否出现频繁Full GC</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20240612121617021.png" alt="image-20240612121617021" style="zoom: 100%;" /><p>参数说明：</p><ul><li><p><strong>S0C</strong> 和 <strong>S1C</strong>：幸存区 0 和幸存区 1 的容量分别为 14336 KB 和 10752 KB。</p></li><li><p><strong>S0U</strong> 和 <strong>S1U</strong>：幸存区 0 没有使用，幸存区 1 使用了 10724.4 KB。</p></li><li><p><strong>EC</strong> 和 <strong>EU</strong>：伊甸园区的容量为 215040 KB，使用了 20511.6 KB。</p></li><li><p><strong>OC</strong> 和 <strong>OU</strong>：老年代的容量为 139776 KB，使用了 18056.9 KB。</p></li><li><p><strong>MC</strong> 和 <strong>MU</strong>：元空间的容量为 45184 KB，使用了 42025.9 KB。</p></li><li><p><strong>CCSC</strong> 和 <strong>CCSU</strong>：压缩类空间的容量为 6272 KB，使用了 5667.6 KB。</p></li><li><p><strong>YGC</strong> 和 <strong>YGCT</strong>：年轻代垃圾回收次数为 5 次，垃圾回收总时间为 0.068 秒。</p></li><li><p><strong>FGC</strong> 和 <strong>FGCT</strong>：完全垃圾回收次数为 2 次，垃圾回收总时间为 0.054 秒。</p></li><li><p><strong>CGC</strong> 和 <strong>CGCT</strong>：并发垃圾回收次数和时间未显示（可能是因为没有启用或发生）。</p></li><li><p><strong>GCT</strong>：垃圾回收总时间为 0.122 秒。</p></li></ul><h1 id="3-JVM参数"><a href="#3-JVM参数" class="headerlink" title="3  JVM参数"></a>3  JVM参数</h1><p>可以考虑<a href="https://pyr9.github.io/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">JVM内存模型</a>：</p><p>设置格式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java ‐Xms2048M ‐Xmx2048M ‐Xmn1024M ‐Xss512K ‐XX:MetaspaceSize=256M ‐XX:MaxMetaspaceSize=256M ‐jar microservice‐eureka‐server.jar <br></code></pre></td></tr></table></figure><p><strong>堆</strong>：</p><ul><li><code>-Xms</code>：设置初始堆大小。</li><li><code>-Xmx</code>：设置最大堆大小。</li></ul><p><strong>年轻代：</strong></p><ul><li><code>-Xmn&lt;size&gt;</code>：设置年轻代内存大小。（老年代的大小等于堆内存大小减去年轻代的大小）</li></ul><p><strong>Eden区与Survivor区的比例：</strong></p><ul><li><code>-XX:SurvivorRatio=&lt;ratio&gt;</code>：设置Eden区与Survivor区的比例。</li></ul><p><strong>年轻代与老年代</strong>：</p><ul><li><code>-XX:NewRatio=&lt;ratio&gt;</code>：设置年轻代与老年代的比例。</li></ul><p><strong>永久代&#x2F;元空间：</strong></p><ul><li><p><code>-XX:MaxPermSize=&lt;size&gt;</code>：设置永久代的最大大小（仅适用于Java 7及之前版本）。</p></li><li><p><code>-XX:MetaspaceSize=&lt;size&gt;</code>：设置元空间的初始大小。</p></li><li><p><code>-XX:MaxMetaspaceSize=&lt;size&gt;</code>：设置元空间的最大大小（适用于Java 8及之后版本）</p></li></ul><p><strong>栈</strong>：</p><ul><li><code>-Xss&lt;size&gt;</code>：设置每个线程的堆栈大小。</li></ul><p><strong>垃圾收集器</strong></p><ul><li><code>-XX:+UseSerialGC</code>：使用串行垃圾收集器。</li><li><code>-XX:+UseParallelGC</code>：使用并行垃圾收集器（Parallel GC）。</li><li><code>-XX:+UseConcMarkSweepGC</code>：使用并发标记清除垃圾收集器（CMS）。</li><li><code>-XX:+UseG1GC</code>：使用G1垃圾收集器。</li><li><code>-XX:+UseZGC</code>：使用ZGC垃圾收集器。</li><li><code>-XX:+UseShenandoahGC</code>：使用Shenandoah垃圾收集器。</li></ul><p><strong>垃圾收集调优</strong></p><ul><li><code>-XX:MaxGCPauseMillis=&lt;ms&gt;</code>：设置最大GC暂停时间。</li><li><code>-XX:G1HeapRegionSize=&lt;size&gt;</code>：设置G1垃圾收集器的堆区域大小。</li><li><code>-XX:InitiatingHeapOccupancyPercent=&lt;percent&gt;</code>：设置触发混合GC的堆占用百分比（用于G1）。</li><li><code>-XX:ParallelGCThreads=&lt;n&gt;</code>：设置用于并行垃圾收集的线程数。</li></ul><h1 id="4-JVM调优案例"><a href="#4-JVM调优案例" class="headerlink" title="4. JVM调优案例"></a>4. JVM调优案例</h1><p><a href="https://pyr9.github.io/JVM%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/">案例</a></p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>垃圾收集器之ZGC收集器</title>
    <link href="/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B9%8BZGC%E6%94%B6%E9%9B%86%E5%99%A8/"/>
    <url>/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B9%8BZGC%E6%94%B6%E9%9B%86%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="ZGC收集器-XX-UseZGC"><a href="#ZGC收集器-XX-UseZGC" class="headerlink" title="ZGC收集器(-XX:+UseZGC)"></a><strong>ZGC收集器</strong>(-XX:+UseZGC)</h1><p>ZGC是一款JDK 11中新加入的具有实验性质的低延迟垃圾收集器。JDK 11只支持linux系统，JDK 14才支持了macOs和Windows系统</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225702509.png" alt="image-20230228225702509"></p><h2 id="一-特点"><a href="#一-特点" class="headerlink" title="一 特点"></a>一 特点</h2><h3 id="1-支持TB量级的堆。"><a href="#1-支持TB量级的堆。" class="headerlink" title="1. 支持TB量级的堆。"></a>1. <strong>支持TB量级的堆</strong>。</h3><p>这应该可以满足未来十年内，所有JAVA应用的需求了 吧。</p><h3 id="2-最大GC停顿时间不超10ms。"><a href="#2-最大GC停顿时间不超10ms。" class="headerlink" title="2. 最大GC停顿时间不超10ms。"></a>2. <strong>最大GC停顿时间不超10ms</strong>。</h3><ul><li>目前一般线上环境运行良好的JAVA应用Minor GC停顿时间在10ms左右， Major GC一般都需要100ms以上</li><li>G1可以调节停顿时间，但是如果调的过低的话，反而会适得其反</li></ul><h3 id="3-最糟糕的情况下吞吐量会降低15-。"><a href="#3-最糟糕的情况下吞吐量会降低15-。" class="headerlink" title="3. 最糟糕的情况下吞吐量会降低15%。"></a>3. 最糟糕的情况下吞吐量会降低15%。</h3><p>它的停顿时间不会随着堆的增大而增长！也就是说，几十G堆的停顿时间是 10ms以下，几百G甚至上T堆的停顿时间也是10ms以下</p><h3 id="4-不分代-暂时"><a href="#4-不分代-暂时" class="headerlink" title="4. 不分代(暂时)"></a>4. <strong>不分代(暂时)</strong></h3><p>分代的原因是因为每个对象的生命周期不同，我们需要回收的时间也不同。ZGC不分代是因为暂时还没有实现这个功能，实现起来比较麻烦。</p><h3 id="5-ZGC的Region可以具有大、-中、-小三类容量"><a href="#5-ZGC的Region可以具有大、-中、-小三类容量" class="headerlink" title="5. ZGC的Region可以具有大、 中、 小三类容量"></a>5. ZGC的Region可以具有大、 中、 小三类容量</h3><p>小型Region（Small Region） ： 容量固定为2MB， 用于放置小于256KB的小对象。 </p><p>中型Region（Medium Region） ： 容量固定为32MB， 用于放置大于等于256KB但小于4MB的对象。 </p><p>大型Region（Large Region） ： 容量不固定， 可以动态变化， 但必须为2MB的整数倍， 用于放置4MB或 以上的大对象。 每个大型Region中 ，只会存放一个大对象</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225713386.png" alt="image-20230228225713386"></p><h2 id="二-ZGC存在的问题"><a href="#二-ZGC存在的问题" class="headerlink" title="二 ZGC存在的问题"></a>二 <strong>ZGC存</strong>在的问题</h2><ul><li>ZGC最大的问题是<strong>浮动垃圾</strong>。1 ZGC没有分代概念，每次都需要进行全堆扫描，导致一些“朝生夕死”的对象没能及时的被回收。 所以就不存在Young GC、Old GC，所有的GC行为都是Full GC</li><li>ZGC的停顿时间是在10ms以下，但是ZGC的执行时间还是远远大于这个时间的。</li></ul><p><strong>解决方案</strong> </p><p>目前唯一的办法是增大堆的容量，使得程序得到更多的喘息时间，但是这个也是一个治标不治本的方案。如果需要从根 本上解决这个问题，还是需要引入分代收集，让新生对象都在一个专门的区域中创建，然后专门针对这个区域进行更频繁、更快的收集。 </p><h2 id="三-ZGC运作过程"><a href="#三-ZGC运作过程" class="headerlink" title="三 ZGC运作过程"></a>三 <strong>ZGC运作过程</strong></h2><h3 id="1-并发标记（Concurrent-Mark）"><a href="#1-并发标记（Concurrent-Mark）" class="headerlink" title="1. 并发标记（Concurrent Mark）"></a>1. 并发标记（Concurrent Mark）</h3><ul><li>相当于SMS收集器的初始标记+并发标记+重新标记。</li><li>初始标记 (<strong>Mark Start</strong>)和最终标记(<strong>Mark End</strong>)也会出现短暂的停顿</li><li>G1不同的是， ZGC的标记是在指针上而不是在对象上进行的， 标记阶段会更新染色指针中的Marked 0、 Marked 1标志位。</li></ul><h3 id="2-并发预备重分配（Concurrent-Prepare-for-Relocate）"><a href="#2-并发预备重分配（Concurrent-Prepare-for-Relocate）" class="headerlink" title="2. 并发预备重分配（Concurrent Prepare for Relocate）"></a>2. 并发预备重分配（Concurrent Prepare for Relocate）</h3><ul><li>这个阶段需要根据特定的查询条件统计得出本次收 集过程要清理哪些Region，将这些Region组成重分配集（Relocation Set）。</li><li>ZGC每次回收都会扫描所有的 Region，用范围更大的扫描成本换取省去G1中记忆集的维护成本。</li></ul><h3 id="3-并发重分配（Concurrent-Relocate）"><a href="#3-并发重分配（Concurrent-Relocate）" class="headerlink" title="3. 并发重分配（Concurrent Relocate）"></a>3. 并发重分配（Concurrent Relocate）</h3><ul><li>重分配是ZGC执行过程中的核心阶段，这个过程要把重分配集中的存活对象复制到新的Region上，并为重分配集中的每个Region维护一个<strong>转发表（Forward Table）</strong>，记录从旧对象到新对象的转向关系。</li><li>如果用户线程此时并 发访问了位于重分配集中的对象，这次访问将会根据Region上的转发表记录将访问转发到新复制的对象上，并同时修正更新该引用的值，使其直接指向新对象，ZGC将这种行为称为指 针的“自愈”（Self-Healing）能力。 </li><li>ZGC的颜色指针因为“自愈”（Self‐Healing）能力，所以只有第一次访问旧对象会变慢， <strong>一旦重分配集中某个Region的存活对象都复制完毕 后， 这个Region就可以立即释放用于新对象的分配</strong>，但是转发表还得留着不能释放掉， 因为可能还有访问在使用这个转发表。</li></ul><h3 id="4-并发重映射（Concurrent-Remap）"><a href="#4-并发重映射（Concurrent-Remap）" class="headerlink" title="4. 并发重映射（Concurrent Remap）"></a>4. <strong>并发重映射（Concurrent Remap）</strong></h3><ul><li>重映射所做的就是修正整个堆中指向重分配集中旧对象的所有引用，</li><li>但 是ZGC中对象引用存在“自愈”功能，所以这个重映射操作并不是很迫切。</li><li>ZGC很巧妙地把并发重映射阶段要做的 工作，合并到了下一次垃圾收集循环中的并发标记阶段里去完成，反正它们都是要遍历所有对象的，这样合并就节 省了一次遍历对象图的开销。一旦所有指针都被修正之后， 原来记录新旧对象关系的转发表就可以释放掉了。</li></ul><blockquote><p>2，3，4 步相当于是实现了CSM的并发清除，但是是使用的复制算法，</p></blockquote><blockquote><p>G1 在这一步是STW的，直接复制完需要存活的对象，修正对象的引用到新引用上就可以。ZGC需要再保留一份旧对象到新对象的转向关系，而且还需要再做一次旧数据的重映射。</p></blockquote><h2 id="四-ZGC触发时机"><a href="#四-ZGC触发时机" class="headerlink" title="四 ZGC触发时机"></a>四 <strong>ZGC触发时机</strong></h2><p>ZGC目前有4中机制触发GC： </p><ul><li><p>定时触发，默认为不使用，可通过ZCollectionInterval参数配置。 </p></li><li><p>预热触发，最多三次，在堆内存达到10%、20%、30%时触发，主要时统计GC时间，为其他GC机制使用。 </p></li><li><p>分配速率，基于正态分布统计，计算内存99.9%可能的最大分配速率，以及此速率下内存将要耗尽的时间点， 在耗尽之前触发GC（耗尽时间 - 一次GC最大持续时间 - 一次GC检测周期时间）。 </p></li><li><p>主动触发，（默认开启，可通过ZProactive参数配置） 距上次GC堆内存增长10%，或超过5分钟时，对比距上 次GC的间隔时间跟（49 * 一次GC的最大持续时间），超过则触发。</p></li></ul><h2 id="五-如何选择垃圾收集器"><a href="#五-如何选择垃圾收集器" class="headerlink" title="五 如何选择垃圾收集器"></a>五 <strong>如何选择垃圾收集器</strong></h2><ol><li><p>优先调整堆的大小让服务器自己来选择 </p></li><li><p>如果内存小于100M，使用串行收集器 </p></li><li><p>如果是单核，并且没有停顿时间的要求，串行或JVM自己选择 </p></li><li><p>如果允许停顿时间超过1秒，选择并行或者JVM自己选 </p></li><li><p>如果响应时间最重要，并且不能超过1秒，使用并发收集器 </p></li><li><p>4G以下可以用parallel，4-8G可以用ParNew+CMS，8G以上可以用G1，几百G以上用ZGC</p></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225722421.png" alt="image-20230228225722421"></p><blockquote><p><strong>JDK 1.8默认使用 Parallel(年轻代和老年代都是)</strong> </p></blockquote><blockquote><p><strong>JDK 1.9默认使用 G1</strong></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
      <tag>垃圾收集器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>垃圾收集器之G1收集器</title>
    <link href="/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B9%8BG1%E6%94%B6%E9%9B%86%E5%99%A8/"/>
    <url>/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B9%8BG1%E6%94%B6%E9%9B%86%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="G1收集器-XX-UseG1GC"><a href="#G1收集器-XX-UseG1GC" class="headerlink" title="G1收集器(-XX:+UseG1GC)"></a><strong>G1收集器</strong>(<strong>-XX:+UseG1GC</strong>)</h1><p><strong>G1 (Garbage-First)是一款面向服务器的垃圾收集器,主要针对配备多核处理器及大容量内存的机器</strong>. 满足<strong>可预测的停顿时间停顿时间的同时,还具备高吞吐量性能特征.</strong> </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232909465.png" alt="image-20230228232909465"></p><h2 id="一-特点"><a href="#一-特点" class="headerlink" title="一 特点"></a>一 特点</h2><h3 id="1-分代收集"><a href="#1-分代收集" class="headerlink" title="1. 分代收集"></a>1. 分代收集</h3><ul><li><p>虽然G1可以不需要其他收集器配合就能独立管理整个GC堆，但是还是保留了分代的概念</p></li><li><p>G1将Java堆划分为多个大小相等的独立区域（<strong>Region</strong>），一般Region大小等于堆大小除以2048，JVM最多可以有2048个Region。 </p></li><li><p>这些Region中包含了逻辑上的年轻代和老年代，但不再是物理隔阂了，它们都是（可以不连续）Region的集合。</p></li><li><p>默认年轻代对堆内存的占比是5%，可以通过“-XX:G1NewSizePercent”设置年轻代初始占比。</p></li><li><p>在系统运行中，JVM会不停的给年轻代增加更多的Region，但最多新生代的占比不会超过60%，可以通过“</p><p>-XX:G1MaxNewSizePercent”调整。</p></li><li><p>年轻代中的Eden和 Survivor对应的region也跟之前一样，默认8:1:1，假设年轻代现在有1000个region，eden区对应800个，s0对应100 个，s1对应100个</p></li><li><p>一个Region可能之前是年轻代，如果Region进行了垃圾回收，之后可能又会变成老年代，也就是说Region的区域功能可能会动态变化。</p></li></ul><h3 id="2-并行与并发"><a href="#2-并行与并发" class="headerlink" title="2. 并行与并发"></a>2. <strong>并行与并发</strong></h3><ul><li>并行性: G1能充分利用CPU、多核环境下的硬件优势，通过多个GC线程同时工作，来缩短Stop-The-World停顿时间。</li><li>并发性: G1拥有与应用程序交替执行的能力,部分工作可以和应用程序同时执行,因此,一般来说,不会在整个回收阶段发生完全阻塞应用程序的情况</li></ul><blockquote><p><strong>并发和并行的区别</strong></p><p>并行，指的是多个事情，在<strong>同一时间点上</strong>同时发生了。并行的多个任务之间是不互相抢占资源的，系统要有多个CPU才会出现并行</p><p>并发，指的是多个事情，在<strong>同一时间段内</strong>同时发生了。  并发的多个任务之间是互相抢占资源的，整个过程中看似是多个任务同时完成的的，但其实是CPU在多次切换。</p></blockquote><h3 id="3-空间整合"><a href="#3-空间整合" class="headerlink" title="3. 空间整合"></a>3. 空间整合</h3><ul><li>G1将内存划分为一个个的region。 内存的回收是<strong>以region作为基本单位的</strong>。</li><li>Region之间是复制算法,但整体上实际可看作是<strong>标记- 整理算法</strong>,两种算法都可以避免内存碎片。</li></ul><h3 id="4-可预测的停顿"><a href="#4-可预测的停顿" class="headerlink" title="4. 可预测的停顿"></a>4. 可预测的停顿</h3><ul><li>降低停顿时间是G1 和 CMS 共同的关注点，但G1 除了追求低停顿外，还能建立<strong>可预测的停顿时间模型</strong>，能让使用者明确指定在一个长度为M毫秒的时间片段(通过参数”<strong>-</strong> <strong>XX:MaxGCPauseMillis</strong>“指定)内完成垃圾收集。</li><li>这里设置的“期望值”必须是符合实际的， 它默认的停顿目标为两百毫秒， 一般来说， 回收阶段占到几十到一百甚至接近两百毫秒都很正常， 但如果我们把停顿时间调得非常低， 譬如设置为二十毫秒， 很可能出现的结果就是由于停顿目标时间太短， 导致每次选出来的回收集只占堆内存很小的一部分， 收集器收集的速度逐渐跟不上分配器分配的速度， 导致垃圾慢慢堆积。 最终占满堆引发 Full GC反而降低性能。</li></ul><h2 id="二-GC的运作过程"><a href="#二-GC的运作过程" class="headerlink" title="二 GC的运作过程"></a>二 GC的运作过程</h2><h3 id="1-初始标记（initial-mark，STW）"><a href="#1-初始标记（initial-mark，STW）" class="headerlink" title="1.初始标记（initial mark，STW）"></a>1.<strong>初始标记</strong>（initial mark，STW）</h3><p>暂停所有的其他线程，并记录下gc roots直接能引用的对象，<strong>速度很快</strong> </p><h3 id="2-并发标记（Concurrent-Marking）"><a href="#2-并发标记（Concurrent-Marking）" class="headerlink" title="2. 并发标记（Concurrent Marking）"></a>2. 并发标记（Concurrent Marking）</h3><p>同CMS的并发标记 </p><h3 id="3-最终标记（Remark，STW）"><a href="#3-最终标记（Remark，STW）" class="headerlink" title="3. 最终标记（Remark，STW）"></a>3. <strong>最终标记</strong>（Remark，STW）</h3><p>同CMS的重新标记 </p><h3 id="4-筛选回收（Cleanup，STW）"><a href="#4-筛选回收（Cleanup，STW）" class="headerlink" title="4. 筛选回收（Cleanup，STW）"></a>4. <strong>筛选回收</strong>（Cleanup，STW）</h3><p>筛选回收阶段首先对各个Region的回收价值和成本进行排序，根据用户所期望的GC停顿时间(可以用JVM参数 -XX:MaxGCPauseMillis指定)来制定回收计划。</p><ul><li><strong>G1收集器在后台维护了一个优先列表，每次根据允许的收集时间，优先选择回收价值最大的Region</strong>，比如一个Region花200ms能回收10M垃圾，另外一个Region花50ms能回收20M垃圾，在回收时间有限情况下，G1当然会优先选择后面这个Region回收。这种使用Region划分内存空间以及有优先级的区域回收方式，保证了G1收集器在有限时间内可以尽可能高的收集效率。</li><li>比如说老年代此时有1000个 Region都满了，但是因为根据预期停顿时间，本次垃圾回收可能只能停顿200毫秒，那么通过之前回收成本计算得知，可能回收其中800个Region刚好需要200ms，那么就只会回收800个Region(<strong>Collection Set</strong>，要回收的集 合)，尽量把GC导致的停顿时间控制在我们指定的范围内。这个阶段其实也可以做到与用户程序一起并发执行，但是因为只回收一部分Region，时间是用户可控制的，而且停顿用户线程将大幅提高收集效率。</li><li>CMS回收阶段是跟用户线程一起并发执行的，G1因为内部实现太复杂暂时没实现并发回收，不过到了Shenandoah就实现了并发收集，Shenandoah可以看成是G1的升级版本</li></ul><h2 id="三-G1垃圾收集分类"><a href="#三-G1垃圾收集分类" class="headerlink" title="三 G1垃圾收集分类"></a>三 <strong>G1垃圾收集分类</strong></h2><h3 id="1-YoungGC"><a href="#1-YoungGC" class="headerlink" title="1. YoungGC"></a>1. <strong>YoungGC</strong></h3><ul><li>YoungGC并不是说现有的Eden区放满了就会马上触发，</li><li>G1会计算下现在Eden区回收大概要多久时间，如果回收时 间远远小于参数 -XX:MaxGCPauseMills 设定的值，那么增加年轻代的region，继续给新对象存放，不会马上做Young GC，直到下一次Eden区放满，G1计算回收时间接近参数 -XX:MaxGCPauseMills 设定的值，那么就会触发Young GC</li></ul><h3 id="2-MixedGC"><a href="#2-MixedGC" class="headerlink" title="2. MixedGC"></a>2. <strong>MixedGC</strong></h3><ul><li>不是FullGC，老年代的占用空间达到整堆的阈值(<strong>-XX:InitiatingHeapOccupancyPercent</strong>设定的值，默认45%)则触发，回收所有的 Young和部分Old(根据期望的GC停顿时间确定old区垃圾收集的优先顺序)以及大对象区，</li><li>正常情况G1的垃圾收集是先做 MixedGC，主要使用复制算法，需要把各个region中存活的对象拷贝到别的region里去，拷贝过程中如果发现<strong>没有足够</strong> <strong>的空region</strong>能够承载拷贝对象就会触发一次Full GC</li></ul><h3 id="3-Full-GC"><a href="#3-Full-GC" class="headerlink" title="3. Full GC"></a><strong>3. Full GC</strong></h3><ul><li><p>停止系统程序，然后采用单线程进行标记、清理和压缩整理，好空闲出来一批Region来供下一次MixedGC使用</p></li><li><p>这个过程是非常耗时的。(Shenandoah优化成多线程收集了) 。Full GC的时候除了收集年轻代和老年代之外，也会将Humongous区一并回收。</p></li></ul><h2 id="四-G1-大对象的处理"><a href="#四-G1-大对象的处理" class="headerlink" title="四 G1 大对象的处理"></a>四 G1 大对象的处理</h2><ul><li>G1有专门分配 大对象的Region叫<strong>Humongous区</strong>，而不是让大对象直接进入老年代的Region中。</li><li>在G1中，大对象的判定规则就是一个大对象超过了一个Region大小的50%，比如按照上面算的，每个Region是2M，只要一个大对象超过了1M，就会被放 入Humongous中，而且一个大对象如果太大，可能会横跨多个Region来存放。</li><li>Humongous区专门存放短期巨型对象，不用直接进老年代，可以节约老年代的空间，避免因为老年代空间不够的GC开 销。</li></ul><h2 id="五-G1收集器参数设置"><a href="#五-G1收集器参数设置" class="headerlink" title="五 G1收集器参数设置"></a>五 <strong>G1收集器参数设置</strong></h2><ul><li><p>-XX:+UseG1GC:使用G1收集器</p></li><li><p>-XX:ParallelGCThreads:指定GC工作的线程数量</p></li><li><p>-XX:G1HeapRegionSize:指定分区大小(1MB~32MB，且必须是2的N次幂)，默认将整堆划分为2048个分区</p></li><li><p><strong>-XX:MaxGCPauseMillis</strong>:目标暂停时间(默认200ms)</p></li><li><p>-XX:G1NewSizePercent:新生代内存初始空间(默认整堆5%，值配置整数，默认就是百分比)</p></li><li><p>-XX:G1MaxNewSizePercent:新生代内存最大空间</p></li><li><p>-XX:TargetSurvivorRatio:Survivor区的填充容量(默认50%)，Survivor区域里的一批对象(年龄1+年龄2+年龄n的多个年龄对象)总和超过了Survivor区域的50%，此时就会把年龄n(含)以上的对象都放入老年代</p></li><li><p>-XX:MaxTenuringThreshold:最大年龄阈值(默认15)</p></li><li><p>**-XX:InitiatingHeapOccupancyPercent:**老年代占用空间达到整堆内存阈值(默认45%)，则执行新生代和老年代的混合收集(<strong>MixedGC</strong>)，比如我们之前说的堆默认有2048个region，如果有接近1000个region都是老年代的region，则可能就要触发MixedGC了</p></li><li><p><strong>-XX:G1MixedGCLiveThresholdPercent(默认85%)</strong>  region中的存活对象低于这个值时才会回收该region，如果超过这个值，存活对象过多，回收的的意义不大。</p></li><li><p><strong>-XX:G1MixedGCCountTarget</strong>:在一次回收过程中指定做几次筛选回收(默认8次)，在最后一个筛选回收阶段可以回收一会，然后暂停回收，恢复系统运行，一会再开始回收，这样可以让系统不至于单次停顿时间过长。</p></li><li><p>-XX:G1HeapWastePercent(默认5%): gc过程中空出来的region是否充足阈值，在混合回收的时候，对Region回收都是基于复制算法进行的，都是把要回收的Region里的存活对象放入其他Region，然后这个Region中的垃圾对象全部清理掉，这样的话在回收过程就会不断空出来新的Region，一旦空闲出来的Region数量达到了堆内存的5%，此时就会立即停止混合回收，意味着本次混合回收就结束了。</p></li></ul><blockquote><p>-XX 后面带的X越多，说明这个参数越不稳定，后面可能会被废弃掉，比如java –version，这种事最稳定的</p></blockquote><h2 id="六-G1垃圾收集器优化建议"><a href="#六-G1垃圾收集器优化建议" class="headerlink" title="六 G1垃圾收集器优化建议"></a>六 <strong>G1垃圾收集器优化建议</strong></h2><p>调节 -XX:MaxGCPauseMills 这个参数的值，避免 -XX:MaxGCPauseMills过大用户体验不好，-XX:MaxGCPauseMills过小，垃圾堆积至占满整个堆，触发full GC。</p><ul><li><p>假设参数 -XX:MaxGCPauseMills 设置的值很小， 譬如设置为二十毫秒， 很可能出现的结果就是由于停顿目标时间太短， 导致每次选出来的回收集只占堆内存很小的一部分， 收集器收集的速度逐渐跟不上分配器分配的速度， 导致垃圾慢慢堆积。 最终占满堆引发 Full GC反而降低性能</p></li><li><p>假设参数 -XX:MaxGCPauseMills 设置的值很大，导致系统停顿很久，用户体验不好。</p></li></ul><h2 id="七-G1的使用场景"><a href="#七-G1的使用场景" class="headerlink" title="七 G1的使用场景"></a>七 <strong>G1的使用场景</strong></h2><h3 id="1-希望消除长时间的GC停顿（超过0-5-1秒）"><a href="#1-希望消除长时间的GC停顿（超过0-5-1秒）" class="headerlink" title="1. 希望消除长时间的GC停顿（超过0.5-1秒）"></a>1. 希望消除长时间的GC停顿（超过0.5-1秒）</h3><p>对于类似Kafka的系统，因为他需要支持每秒处理百万级的消息，所以一般需要大内存机器来部署，比如三四十G，对于这么大的内存，minor GC 即使使用复制算法，也就不再快了，很可能会出现系统每运行一两分钟就会因为minor gc卡顿几秒钟没法处理新消息，这显然是不可以的。使用G1收集器就可以消除长时间的GC停顿，比如设置停顿时间是50ms，后50ms的卡顿其实完全能够接受，用户几乎无感知，那么整个系统就可以在卡顿几乎无感知的情况下一边处理业务一边收集垃圾。</p><h3 id="2-想要更可控、可预期的GC停顿周期"><a href="#2-想要更可控、可预期的GC停顿周期" class="headerlink" title="2. 想要更可控、可预期的GC停顿周期"></a>2. 想要更可控、可预期的GC停顿周期</h3><h3 id="3-多核CPU，大内存"><a href="#3-多核CPU，大内存" class="headerlink" title="3. 多核CPU，大内存"></a>3. 多核CPU，大内存</h3><p>8GB以上的堆内存(建议值)，因为g1算法很复杂，内存不够大，就不要用了</p><h3 id="4-？？"><a href="#4-？？" class="headerlink" title="4. ？？"></a>4. ？？</h3><ul><li><p>对象分配或者晋升的速度变化大  ？？</p></li><li><p>实时数据占用超过一半的堆空间  ？？</p></li></ul><h2 id="八-CMS收集器和G1收集器的区别"><a href="#八-CMS收集器和G1收集器的区别" class="headerlink" title="八 CMS收集器和G1收集器的区别"></a>八 CMS收集器和G1收集器的区别</h2><h3 id="1-使用范围不一样"><a href="#1-使用范围不一样" class="headerlink" title="1. 使用范围不一样"></a>1. 使用范围不一样</h3><ul><li>CMS收集器是老年代的收集器，可以配合新生代的Serial和ParNew收集器一起使用</li><li>G1收集器收集范围是老年代和新生代。不需要结合其他收集器使用</li></ul><h3 id="2-STW的时间"><a href="#2-STW的时间" class="headerlink" title="2. STW的时间"></a>2. STW的时间</h3><ul><li>CMS收集器以最小的停顿时间为目标的收集器。只有初始标记和重新标记需要STW</li><li>G1收集器可预测垃圾回收的停顿时间（建立可预测的停顿时间模型）。除了初始标记和重新标记需要STW，筛选回收时也需要STW，不过停顿时间可预测</li></ul><h3 id="3-垃圾碎片"><a href="#3-垃圾碎片" class="headerlink" title="3. 垃圾碎片"></a>3. 垃圾碎片</h3><ul><li>CMS收集器是使用“标记-清除”算法进行的垃圾回收，容易产生内存碎片</li><li>G1收集器使用的是“标记-整理”算法，进行了空间整合，降低了内存空间碎片。</li></ul><h3 id="4-垃圾回收的过程不一样"><a href="#4-垃圾回收的过程不一样" class="headerlink" title="4. 垃圾回收的过程不一样"></a>4. 垃圾回收的过程不一样</h3><ul><li>CMS: 初始标记 + 并发标记 + 重新标记 + 并发清除</li><li>G1: 初始标记 + 并发标记 + 最终标记 + 筛选回收</li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
      <tag>垃圾收集器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>垃圾收集器</title>
    <link href="/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/"/>
    <url>/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-垃圾收集算法"><a href="#1-垃圾收集算法" class="headerlink" title="1 垃圾收集算法"></a>1 <strong>垃圾收集算法</strong></h1><h2 id="1-1-标记-清除算法"><a href="#1-1-标记-清除算法" class="headerlink" title="1.1 标记 - 清除算法"></a>1.1 <strong>标记 - 清除算法</strong></h2><p>算法分为“标记”和“清除”两个阶段:首先标记出所有需要回收的对象，在标记完成后统一回收所有被标记的对象。<br>缺点:<br>（1）效率问题， 标记和清除两个过程的效率都不高；<br>（2）空间问题，标记清除之后会产生大量不连续的内存碎片，空间碎片太多可能会导致以后在程序运行过程中需要分配较大对象时，无法找到足够的连续内存面不得不提前触发另一次垃圾收集动作。</p><h2 id="1-2-标记-整理算法"><a href="#1-2-标记-整理算法" class="headerlink" title="1.2 标记 - 整理算法"></a>1.2 <strong>标记 - 整理算法</strong></h2><p> 让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存。<br>优点: 不会产生内存碎片<br>不足: 需要移动大量对象，处理效率比较低。</p><h2 id="1-3-复制算法"><a href="#1-3-复制算法" class="headerlink" title="1.3 复制算法"></a>1.3 <strong>复制算法</strong></h2><p>将内存划分为大小相等的两块，每次只使用其中一块，当这一块内存用完了就将还存活的对象复制到另一块上面，然后再把使用过的内存空间进行一次清理。</p><p>新生代的对象每次在每次垃圾收集时都会有大批对象死去，只有少量存活，因此我们不需要按照1:1划分内存空间而是 将内存分为一块较大的 Eden 空间和两块较小的 Survivor 空间，每次使用 Eden 和其中一块Survivor。</p><p>在回收时，将 Eden 和 Survivor 中还存活着的对象全部复制到另一块 Survivor 上，最后清理 Eden 和使用过的那一块 Survivor空间。（HotSpot 虚拟机的 Eden 和 Survivor 大小比例默认为 8:1:1）</p><h2 id="1-4-分代收集算法"><a href="#1-4-分代收集算法" class="headerlink" title="1.4 分代收集算法"></a>1.4 <strong>分代收集算法</strong></h2><p>当前虚拟机的垃圾收集都采用分代收集算法，只是根据对象存活周期的不同将内存分为几块。一般将java堆分为新生代和老年代，这样我们就可以根据各个年代的特点选择合适的垃圾收集算法。</p><ul><li><p>新生代使用：复制算法</p><p>新生代中，每次收集都会有大量对象(近99%)死去，所以可以选择复制算法，只需要付出少量对象的复制成本就可以完成每次垃圾收集。</p></li><li><p>老年代使用：标记 - 清除 或者 标记 - 整理 算法</p><p>而老年代的对象存活几率是比较高的，而且没有额外的空间对它进行分配担保，所以我们必须选择“标记-清除”或“标记-整理”算法进行垃圾收集。<strong>“标记-清除”或“标记-整理”算法会比复制算法慢10倍以 上。</strong></p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232824370.png" alt="image-20230228232824370"></p><h1 id="2-垃圾收集器"><a href="#2-垃圾收集器" class="headerlink" title="2 垃圾收集器"></a>2 <strong>垃圾收集器</strong></h1><p><strong>如果说收集算法是内存回收的方法论，那么垃圾收集器就是内存回收的具体实现。</strong> </p><p>虽然我们对各个收集器进行比较，但并非为了挑选出一个最好的收集器。因为直到现在为止还没有最好的垃圾收集器出现，更加没有万能的垃圾收集器，<strong>我们能做的就是根据具体应用场景选择适合自己的垃圾收集器</strong>。</p><p>对于JDK8默认的垃圾回收器是-XX:+UseParallelGC(年轻代)和-XX:+UseParallelOldGC(老年代)，如果内存较大(超过4个G，只是经验值)，系统对停顿时间比较敏感，我们可以使用<strong>ParNew+CMS(</strong>-XX:+UseParNewGC -XX:+UseConcMarkSweepGC**)** </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232833764.png" alt="image-20230228232833764"></p><h2 id="2-1-Serial收集器"><a href="#2-1-Serial收集器" class="headerlink" title="2.1 Serial收集器"></a>2.1 Serial收集器</h2><ul><li><strong>-XX:+UseSerialGC -XX:+UseSerialOldGC</strong></li><li>Serial（串行）收集器是最基本、历史最悠久的垃圾收集器了。</li><li>它是单线程的收集器，只会使用一个线程进行垃圾收集工作。进行垃圾收集时必须暂停其他所有的工作线程(<strong>“Stop The World”</strong>) ，直到它收集结束。</li><li>它的优点是简单高效，在单个 CPU 环境下，由于没有线程交互的开销，因此拥有最高的单线程收集效率。</li><li><strong>Serial Old收集器是Serial收集器的老年代版本</strong>，它同样是一个单线程收集器。它主要有两大用途：一种用途是在JDK1.5 以及以前的版本中与Parallel Scavenge收集器搭配使用，<strong>另一种用途是作为CMS收集器的后备方案</strong>。</li></ul><blockquote><p><strong>新生代采用复制算法，老年代采用标记-整理算法。</strong> </p></blockquote><h2 id="2-2-Parallel-Scavenge收集器"><a href="#2-2-Parallel-Scavenge收集器" class="headerlink" title="2.2 Parallel Scavenge收集器"></a>2.2 <strong>Parallel Scavenge收集器</strong></h2><ul><li><strong>-XX:+UseParallelGC(年轻代),-XX:+UseParallelOldGC(老年代)</strong></li><li><strong>Parallel</strong>收集器其实<strong>就是Serial收集器的多线程版本</strong>，除了使用多线程进行垃圾收集外，其余行为（控制参数、收集算法、回收策略等等）和Serial收集器类似。</li><li>默认的收集线程数跟cpu核数相同，当然也可以用参数(- XX:ParallelGCThreads)指定收集线程数，但是一般不推荐修改。 </li><li><strong>Parallel Scavenge收集器关注点是吞吐量（高效率的利用CPU，获取最短的垃圾回收时间）</strong></li><li><strong>Parallel Old收集器是Parallel Scavenge收集器的老年代版本</strong>。使用多线程和“标记-整理”算法。在注重吞吐量以及 CPU资源的场合，都可以优先考虑 Parallel Scavenge收集器和Parallel Old收集器(<strong>JDK8默认的新生代和老年代收集器</strong>)。</li></ul><blockquote><p><strong>新生代采用复制算法，老年代采用标记-整理算法。</strong></p></blockquote><h2 id="2-3-ParNew收集器"><a href="#2-3-ParNew收集器" class="headerlink" title="2.3 ParNew收集器"></a>2.3 ParNew收集器</h2><ul><li><p><strong>-XX:+UseParNewGC</strong></p></li><li><p>ParNew收集器其实<strong>跟Parallel收集器很类似</strong>，区别主要在于它可以和CMS收集器配合使用。</p></li></ul><blockquote><p><strong>新生代采用复制算法，老年代采用标记-整理算法。</strong> </p></blockquote><h2 id="2-4-CMS收集器"><a href="#2-4-CMS收集器" class="headerlink" title="2.4 CMS收集器"></a>2.4 <strong>CMS收集器</strong></h2><ul><li><p><strong>-XX:+UseConcMarkSweepGC(old)</strong></p></li><li><p><strong>CMS（Concurrent Mark Sweep）收集器是一种以获取最短回收停顿时间为目标的收集器。它非常符合在注重用户体</strong> <strong>验的应用上使用，它是HotSpot虚拟机第一款真正意义上的并发收集器，它第一次实现了让垃圾收集线程与用户线程</strong> <strong>（基本上）同时工作</strong></p></li><li><p>整个过程分为四个步骤： </p><ul><li>初始标记：仅仅只是标记一下 GC Roots 能直接关联到的对象，速度很快，需要停顿。</li><li>并发标记：进行 GC Roots Tracing 的过程，它在整个回收过程中耗时最长，不需要停顿。</li><li>重新标记：为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，需要停顿。</li><li>并发清除：用户可同时运行的，耗时较长。</li></ul></li><li><p>优缺点：</p><ul><li>优点：<strong>并发收集、低停顿</strong>。由于在整个过程和中最耗时的并发标记和 并发清除过程收集器程序都可以和用户线程一起工作，所以总体来说，Cms收集器的内存回收过程是与用户线程一起并发执行的。</li><li>缺点：<ul><li>对CPU敏感，并发阶段，虽然不会导致用户线程停顿，但是会因为占用了一部分线程使应用程序变慢，总吞吐量会降低</li><li>CMS基于标记 - 清除算法，会导致空间碎片，往往出现老年代空间剩余，但无法找到足够大连续空间来分配当前对象，不得不提前触发一次 Full GC。，当然通过参数- XX:+UseCMSCompactAtFullCollection可以让jvm在执行完标记清除后再做整理 </li><li>无法处理浮动垃圾。浮动垃圾是指并发清除阶段由于用户线程继续运行而产生的垃圾，这部分垃圾只能到下一次 GC 时才能进行回收。由于浮动垃圾的存在，因此需要预留出一部分内存，意味着 CMS 收集不能像其它收集器那样等待老年代快满的时候再回收。如果预留的内存不够存放浮动垃圾，就会出现 Concurrent Mode Failure，这时虚拟机将临时启用 Serial Old 来替代 CMS。</li></ul></li></ul></li><li><p><strong>CMS的相关核心参数</strong></p></li></ul><ol><li><p>-XX:+UseConcMarkSweepGC：启用cms </p></li><li><p>-XX:ConcGCThreads：并发的GC线程数 </p></li><li><p>-XX:+UseCMSCompactAtFullCollection：FullGC之后做压缩整理（减少碎片） </p></li><li><p>-XX:CMSFullGCsBeforeCompaction：多少次FullGC之后压缩一次，默认是0，代表每次FullGC后都会压缩一次</p></li><li><p><strong>-XX:CMSInitiatingOccupancyFraction</strong>: 当老年代使用达到该比例时会触发FullGC（默认是92，这是百分比） </p></li><li><p>-XX:+UseCMSInitiatingOccupancyOnly：只使用设定的回收阈值(-XX:CMSInitiatingOccupancyFraction设定的值)，如果不指定，JVM仅在第一次使用设定值，后续则会自动调整 </p></li><li><p>-XX:+CMSScavengeBeforeRemark：在CMS GC前启动一次minor gc，目的在于减少老年代对年轻代的引用，降低CMS GC的标记阶段时的开销，一般CMS的GC耗时 80%都在标记阶段 </p></li><li><p>-XX:+CMSParallellnitialMarkEnabled：表示在初始标记的时候多线程执行，缩短STW </p></li><li><p>-XX:+CMSParallelRemarkEnabled：在重新标记的时候多线程执行，缩短STW;</p></li></ol><blockquote><p><strong>只可以用在老年代，使用“标记-清除”算法</strong></p></blockquote><h2 id="2-5-G1收集器"><a href="#2-5-G1收集器" class="headerlink" title="2.5 G1收集器"></a>2.5 <strong>G1收集器</strong></h2><p><a href="https://pyr9.github.io/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B9%8BG1%E6%94%B6%E9%9B%86%E5%99%A8/">垃圾收集器之G1收集器 - 楼上有只喵 (pyr9.github.io)</a></p><h2 id="2-6-ZGC收集器"><a href="#2-6-ZGC收集器" class="headerlink" title="2.6 ZGC收集器"></a>2.6 ZGC收集器</h2><p><a href="https://pyr9.github.io/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B9%8BZGC%E6%94%B6%E9%9B%86%E5%99%A8/">垃圾收集器之ZGC收集器 - 楼上有只喵 (pyr9.github.io)</a></p><h1 id="3-垃圾回收器选择"><a href="#3-垃圾回收器选择" class="headerlink" title="3. 垃圾回收器选择?"></a>3. 垃圾回收器选择?</h1><ul><li><strong>JDK 1.8默认使用 Parallel</strong>，<strong>JDK 1.9默之后认使用 G1</strong></li><li>100M以下用Serial，简单+高效</li><li>4G以下可以用parallel，并发收集 + 高吞吐量。（标记整理，STW）</li><li>4-8G可以用ParNew+CMS，并发收集 + 低停顿(注重用户体验）</li><li>8G以上可以用G1，避免长时间的停顿+可预期的GC停顿周期 + 高吞吐量(筛选回收时需要STW)</li><li>几百G以上用ZGC，支持TB量级的堆+ 最大GC停顿时间不超10ms</li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
      <tag>垃圾收集算法</tag>
      
      <tag>垃圾收集器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>对象内存分配</title>
    <link href="/%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/"/>
    <url>/%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="对象内存分配策略"><a href="#对象内存分配策略" class="headerlink" title="对象内存分配策略"></a>对象内存分配策略</h1><ul><li>JVM通过<strong>逃逸分析</strong>确定该对象不会被外部访问。如果不会逃逸可以将该对象在<strong>栈上分配</strong>内存</li><li>大多数情况下，对象在新生代中 Eden 区分配。</li><li><strong>大对象直接进入老年代</strong></li><li><strong>长期存活的对象将进入老年代</strong> </li><li><strong>对象动态年龄判断</strong></li><li><strong>老年代空间分配担保机制</strong></li></ul><h2 id="对象栈上分配"><a href="#对象栈上分配" class="headerlink" title="对象栈上分配"></a><strong>对象栈上分配</strong></h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul><li><p>我们通过JVM内存分配可以知道JAVA中的对象都是在堆上进行分配，当对象没有被引用的时候，需要依靠GC进行回收内存，如果对象数量较多的时候，会给GC带来较大压力，也间接影响了应用的性能。</p></li><li><p>为了减少临时对象在堆内分配的数量，JVM通过<strong>逃逸分析</strong>确定该对象不会被外部访问。如果不会逃逸可以将该对象在<strong>栈上分配</strong>内存，这样该对象所占用的内存空间就可以随栈帧出栈而销毁，就减轻了垃圾回收的压力。</p></li></ul><h3 id="对象逃逸分析"><a href="#对象逃逸分析" class="headerlink" title="对象逃逸分析"></a>对象逃逸分析</h3><p><strong>对象逃逸分析</strong>：就是分析对象动态作用域，当一个对象在方法中被定义后，它可能被外部方法所引用，例如作为调用参数传递到其他地方中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">test1</span><span class="hljs-params">()</span> </span>&#123;<br>  User user = <span class="hljs-keyword">new</span> User();<br>  user.setId(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">return</span> user;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span> </span>&#123;<br>  User user = <span class="hljs-keyword">new</span> User();<br>  user.setId(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>显然，test1方法中的user对象被返回了，这个对象的作用域范围不确定，test2方法中的user对象我们可以确定当方法结 束这个对象就可以认为是无效对象了，对于这样的对象我们其实可以将其分配在栈内存里，让其在方法结束时跟随栈内 存一起被回收掉。</p><p>JVM对于这种情况可以通过开启逃逸分析参数(-XX:+DoEscapeAnalysis)来优化对象内存分配位置，使其通过<strong>标量替换</strong>优先分配在栈上(<strong>栈上分配</strong>），JDK7之后默认开启逃逸分析，如果要关闭使用参数(-XX:-DoEscapeAnalysis)</p><blockquote><p><strong>标量替换：</strong>通过逃逸分析确定该对象不会被外部访问，并且对象可以被进一步分解时，<strong>JVM不会创建该对象</strong>，而是将该对象成员变量分解若干个被这个方法使用的成员变量所代替，这些代替的成员变量在栈帧或寄存器上分配空间，这样就不会因为没有一大块连续空间导致对象内存不够分配。开启标量替换参数(-XX:+EliminateAllocations)，JDK7之后默认开启</p></blockquote><h3 id="栈上分配示例"><a href="#栈上分配示例" class="headerlink" title="栈上分配示例"></a><strong>栈上分配示例</strong></h3><p>代码调用了1亿次test()，如果是分配到堆上，大概需要1GB以上堆空间，如果堆空间小于该值，必然会触发GC。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoEscapeAnalysis</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000000</span>; i++) &#123;<br>      test();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>    User user = <span class="hljs-keyword">new</span> User();<br>    user.setId(<span class="hljs-number">1</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>使用如下参数不会发生GC</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">‐Xmx15m ‐Xms15m ‐XX:+DoEscapeAnalysis ‐XX:+PrintGC ‐XX:+EliminateAllocations<br></code></pre></td></tr></table></figure><p>  <img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232619185.png" alt="image-20230228232619185"></p><ul><li>使用如下参数都会发生大量GC</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">‐Xmx15m ‐Xms15m ‐XX:‐DoEscapeAnalysis ‐XX:+PrintGC ‐XX:+EliminateAllocations<br>‐Xmx15m ‐Xms15m ‐XX:+DoEscapeAnalysis ‐XX:+PrintGC ‐XX:‐EliminateAllocations<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232628497.png" alt="image-20230228232628497"></p><h2 id="对象在Eden区分配"><a href="#对象在Eden区分配" class="headerlink" title="对象在Eden区分配"></a><strong>对象在Eden区分配</strong></h2><ul><li><p>大多数情况下，对象在新生代中 Eden 区分配。当 Eden 区没有足够空间进行分配时，虚拟机将发起一次Minor GC。</p></li><li><p><strong>Eden与Survivor区默认8:1:1</strong> </p></li><li><p>过程</p><ul><li>大量的对象被分配在eden区，eden区满了后会触发minor gc，可能会有99%以上的对象成为垃圾被回收掉</li><li>剩余存活的对象会被挪到为空的那块survivor区</li><li>下一次eden区满了后又会触发minor gc，把eden区和survivor区垃圾对象回收，把剩余存活的对象一次性挪动到另外一块为空的survivor区</li><li>因为新生代的对象都是朝生夕死的，存活时间很短，所以JVM默认的8:1:1的比例是很合适的，<strong>让eden区尽量的大，survivor区够用即可</strong></li><li>JVM默认有这个参数-XX:+UseAdaptiveSizePolicy(默认开启)，会导致这个8:1:1比例自动变化，如果不想这个比例有变化可以设置参数-XX:-UseAdaptiveSizePolicy</li></ul></li></ul><h2 id="大对象直接进入老年代"><a href="#大对象直接进入老年代" class="headerlink" title="大对象直接进入老年代"></a><strong>大对象直接进入老年代</strong></h2><p>大对象就是需要大量连续内存空间的对象（比如：字符串、数组）。JVM参数 -XX:PretenureSizeThreshold 可以设置大对象的大小，如果对象超过设置大小会直接进入老年代，不会进入</p><p><strong>为什么要这样呢？</strong></p><p>为了避免为大对象GC时，多次在survivor上来回复制而降低效率。</p><h2 id="长期存活的对象进入老年代"><a href="#长期存活的对象进入老年代" class="headerlink" title="长期存活的对象进入老年代"></a>长期存活的对象进入老年代</h2><ul><li><p>为每个对象定义年龄计数器，对象在 Eden 出生并经过 Minor GC 依然存活，将移动到 Survivor 中，年龄就增加 1 岁，增加到一定年龄则移动到老年代中。（默认 15 岁，CMS收集器默认6岁，不同的垃圾收集器会略微有点不同)</p></li><li><p>对象晋升到老年代的年龄阈值，可以通过参数 -XX:MaxTenuringThreshold 来设置</p></li></ul><h2 id="对象动态年龄判断"><a href="#对象动态年龄判断" class="headerlink" title="对象动态年龄判断"></a><strong>对象动态年龄判断</strong></h2><ul><li><p>当前放对象的Survivor区域里(其中一块区域，放对象的那块s区)，一批对象的总大小大于这块Survivor区域内存大小的 50%(XX:TargetSurvivorRatio可以指定)，那么此时<strong>大于等于</strong>这批对象年龄最大值的对象，就可以直接进入老年代了， </p></li><li><p>例如Survivor区域里现在有一批对象，年龄1+年龄2+年龄n的多个年龄对象总和超过了Survivor区域的50%，此时就会把年龄n(含)以上的对象都放入老年代。</p></li><li><p><strong>对象动态年</strong> <strong>龄判断机制一般是在minor gc之后触发的。</strong></p></li></ul><p><strong>为什么要这样呢</strong>？</p><p>这个规则其实是希望那些可能是长期存活的对象，尽早进入老年代。</p><h2 id="老年代空间分配担保机制"><a href="#老年代空间分配担保机制" class="headerlink" title="老年代空间分配担保机制"></a><strong>老年代空间分配担保机制</strong></h2><ul><li>在发生 Minor GC 之前，虚拟机先检查老年代最大可用的连续空间是否大于新生代所有对象总空间，</li><li>如果条件成立的话，那么 Minor GC 可以确认是安全的。</li><li>如果不成立的话虚拟机会查看 “-XX:-HandlePromotionFailure” 的参数是否设置了(jdk1.8默认就设置了)，也就是是否允许担保失败，<ul><li>如果允许，就会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试着进行一次 Minor GC；如果小于，会触发full gc。</li><li>不允许，会触发Full GC</li></ul></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232645030.png" alt="image-20230228232645030"></p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM内存参数设置</title>
    <link href="/JVM%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE/"/>
    <url>/JVM%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="JVM内存参数设置"><a href="#JVM内存参数设置" class="headerlink" title="JVM内存参数设置"></a><strong>JVM内存参数设置</strong></h1><h2 id="JVM参数设置格式"><a href="#JVM参数设置格式" class="headerlink" title="JVM参数设置格式"></a>JVM参数设置格式</h2><p>Spring Boot程序的JVM参数设置格式(Tomcat启动直接加在bin目录下catalina.sh文件里)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java ‐Xms2048M ‐Xmx2048M ‐Xmn1024M ‐Xss512K ‐XX:MetaspaceSize=256M ‐XX:MaxMetaspaceSize=256M ‐jar microservice‐eureka‐server.jar <br></code></pre></td></tr></table></figure><h2 id="元空间的JVM参数"><a href="#元空间的JVM参数" class="headerlink" title="元空间的JVM参数"></a>元空间的JVM参数</h2><ul><li><p>关于元空间的JVM参数有两个：-XX:MetaspaceSize&#x3D;N和 -XX:MaxMetaspaceSize&#x3D;N</p><ul><li><p><strong>-XX：MaxMetaspaceSize</strong>： 设置元空间最大值， 默认是-1， 即不限制， 或者说只受限于本地内存大小。 </p></li><li><p><strong>-XX：MetaspaceSize</strong>： 指定元空间触发Fullgc的初始阈值(元空间无固定初始大小)， 以字节为单位，默认是21M，达到该值就会触发full gc， 同时收集器会对该值进行调整： 如果释放了大量的空间， 就适当降低该值； 如果释放了很少的空间， 那么在不超过-XX：MaxMetaspaceSize（如果设置了的话） 的情况下， 适当提高该值。（比如初始值是21M，full gc后，释放了20M，只剩1M，那么垃圾收集器就会将该值调成2M；相反，如果释放了1M，还剩20M，下次就会调整到40M）</p></li></ul></li><li><p>由于调整元空间的大小需要Full GC，这是非常昂贵的操作，如果应用在启动的时候发生大量Full GC，通常都是由于永久代或元空间发生 了大小调整，基于这种情况，一般建议在JVM参数中将MetaspaceSize和MaxMetaspaceSize设置成一样的值，并设置得比初始值要大。</p></li><li><p>对于8G物理内存的机器来说，一般我会将这两个值都设置为256M。常见的问题：项目jar包只有1G，但是启动了好久，就可能是因为由于元空间设置的太小，一直在触发full GC。</p></li></ul><h2 id="栈的JVM参数"><a href="#栈的JVM参数" class="headerlink" title="栈的JVM参数"></a>栈的JVM参数</h2><p>Xss设置越小，说明一个线程栈里能分配的栈帧就越少，但是对JVM整体来说能开启的线程数会更多 </p><p><strong>StackOverflowError</strong>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackOverflowTest</span> </span>&#123;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">redo</span><span class="hljs-params">()</span> </span>&#123;<br>        count++;<br>        redo();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            redo();<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>            t.printStackTrace();<br>            System.out.println(count);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行代码：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224131501.png" alt="image-20230228224131501"></p><p>调整-Xss参数：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224141154.png" alt="image-20230228224141154"></p><p>打印结果：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224149027.png" alt="image-20230228224149027"></p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM内存模型</title>
    <link href="/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"/>
    <url>/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="JVM内存模型"><a href="#JVM内存模型" class="headerlink" title="JVM内存模型"></a>JVM内存模型</h1><p>JVM内存模型总体来说分为五大块。分别是：java堆，方法区（1.8后叫元空间）虚拟机栈，本地方法栈，以及程序计数器。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyOTIyNjQ3,size_16,color_FFFFFF,t_70.png" alt="img"></p><h2 id="1-堆"><a href="#1-堆" class="headerlink" title="1 堆"></a>1 堆</h2><p>java堆是java虚拟机所管理的内存中最大的一块。它用来存放对象实例和数组。</p><ul><li><p>在 Java 中，堆被划分成两个不同的区域：新生代 ( Young )、老年代 ( Old )， 1.8之前还包括方法区。新生代 ( Young ) 又被划分为三个区域：Eden、From Survivor、To Survivor。</p></li><li><p>线程共享。java堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。</p></li><li><p>java堆是垃圾收集器管理的主要区域，因此很多时候也被称作 “GC堆”（Garbage Collection Heap）。</p></li><li><p>java堆可以处于物理不连续的内存空间中，只要逻辑上连续即可。</p></li><li><p>如果在堆中没有内存完成实例分配，并且堆也无法再扩展时，则会抛出Out Of Memory Error 。</p></li><li><p>其大小通过-Xms(最小值)和-Xmx(最大值)参数设置（最大最小值都要小于1G），前者为启动时申请的最小内存，默认为操作系统物理内存的1&#x2F;64，后者为JVM可申请的最大内存,默认为物理内存的1&#x2F;4，默认当空余堆内存小于40%时，JVM会增大堆内存到-Xmx指定的大小，可通过-XX:MinHeapFreeRation&#x3D;来指定这个比列。</p></li><li><p>在我们垃圾回收的时候，我们往往将堆内存分成新生代和老生代（大小比例1：2），新生代中由Eden和Survivor0，Survivor1组成，三者的比例是8：1：1，新生代的回收机制采用复制算法，在Minor GC的时候，我们都留一个存活区用来存放存活的对象，真正进行的区域是Eden+其中一个存活区，当我们的对象时长超过一定年龄时（默认15，可以通过参数设置），将会把对象放入老生代，当然大的对象会直接进入老生代，老生代采用的回收算法是标记整理算法。</p></li></ul><h2 id="2-方法区"><a href="#2-方法区" class="headerlink" title="2 方法区"></a>2 方法区</h2><ul><li><p>方法区与java堆一样，是线程共享的区域，它里面存储已被虚拟机加载的<strong>类信息、字段信息、方法信息、静态变量、常量</strong>等数据。</p></li><li><p>方法区类似Java的接口，而虚拟机的实现方式，在1.8之前是永久代，1.8之后是元空间。</p></li></ul><p><strong>为什么要将永久代替换成元空间呢？</strong></p><p>因为永久代使用的是虚拟机设置的内存，有一个 JVM 本身设置的固定大小上限，无法进行调整，而元空间使用的是直接内存，受本机可用内存的限制，虽然元空间仍旧可能溢出，但是比原来出现的几率会更小，并且可以加载更多的类。</p><h2 id="3-栈"><a href="#3-栈" class="headerlink" title="3 栈"></a>3 栈</h2><p>   虚拟机栈（Java Virtual Machine Stacks）描述的是java方法（也就是字节码）执行的内存模型：每个方法在执行的时候都有一个栈帧,用于存储局部变量表，操作数栈，动态链接，方法出口等信息。每一个方法从调用到执行就对应了一个栈帧在虚拟机栈中入栈到出栈的过程。</p><ul><li>线程私有。生命周期与线程相同。</li><li>在java虚拟机规范中，这个区域规定了两种异常状况。一是 Stack Overflow Error 异常，表示当前线程请求的栈深度大于虚拟机所允许的深度</li><li>二是Out Of Memory Error 如果所在虚拟机可以扩展，当它扩展时无法得到足够的内存，则会抛出该异常。</li></ul><h2 id="4-本地方法栈"><a href="#4-本地方法栈" class="headerlink" title="4 本地方法栈"></a>4 本地方法栈</h2><p>   本地方法栈（Native Method Stack）与虚拟机栈发挥的作用是相似的，不同点在于虚拟机栈执行的是java方法服务，而本地方法栈是为虚拟机使用到的Native方法服务。有的虚拟机直接把虚拟机栈和本地方法栈合二为一，与虚拟机栈一样，本地方法栈也会抛出Stack Overflow Error和Out Of Memory Error异常。</p><h2 id="5-程序计数器"><a href="#5-程序计数器" class="headerlink" title="5 程序计数器"></a>5 程序计数器</h2><p>   程序计数器（Program Counter Register）是一块较小的内存空间，可看做当前线程所执行的字节码行号指令器，字节码解释器工作时就是通过改变这个计数器的值来选择下一条需要执行的字节码指令。</p><ul><li>线程私有。每个线程都需要一个独立的程序计数器，个线程之间计数器互不影响，独立存储</li><li>如果线程正在执行的是一个java方法，则计数器记录的是正在执行的虚拟机字节码指令的地址；如果正在执行的是native方法，则这个计数器为空。</li><li>此内存区域是唯一一个在java虚拟机中没有规定 Out Of Memory Error情况的区域。</li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java命令--jmap工具</title>
    <link href="/java%E5%91%BD%E4%BB%A4--jmap%E5%B7%A5%E5%85%B7/"/>
    <url>/java%E5%91%BD%E4%BB%A4--jmap%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h1 id="Jmap"><a href="#Jmap" class="headerlink" title="Jmap"></a><strong>Jmap</strong></h1><p>命令jmap是一个多功能的命令。它可以生成 java 程序的 dump 文件， 也可以查看堆内对象示例的统计信息、查看 ClassLoader 的信息以及 finalizer 队列。</p><p><strong>系统中内存飙升了，怎么办？</strong></p><p>使用jmap看看是否有大量类生成</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231003015.png" alt="image-20230228231003015"></p><h3 id="histo"><a href="#histo" class="headerlink" title="- histo"></a>- histo</h3><p>查看堆内存信息，实例个数以及占用内存大小 </p><ul><li>命令： <code> ~ jmap -histo 91656 &gt; ./log.txt</code></li><li>结果分析<ul><li>num：序号 </li><li>instances：实例数量 </li><li>bytes：占用空间大小 </li><li>class name：类名称   [C is a char[]，[S is a short[]，[I is a int[]，[B is a byte[]，[[I is a int[][]</li></ul></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231003015.png"></p><h3 id="‐dump"><a href="#‐dump" class="headerlink" title="‐dump"></a>‐dump</h3><p>生成Java虚拟机的堆转储快照dump文件</p><ul><li><p>命令 <code>jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</code></p></li><li><p>运行结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  ~ jmap -dump:live,format=b,file=eureka.hprof <span class="hljs-number">3548</span><br>Dumping heap to /Users/panyurou/eureka.hprof ...<br></code></pre></td></tr></table></figure></li><li><p>也可以设置内存溢出自动导出dump文件(内存很大的时候，可能会导不出来) </p><ul><li>-XX:+HeapDumpOnOutOfMemoryError </li><li>-XX:HeapDumpPath&#x3D;.&#x2F; （路径）</li></ul></li><li><p><strong>示例代码：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OOMTest</span> </span>&#123;<br>  <span class="hljs-comment">// JVM设置 :‐Xms10M ‐Xmx10M ‐XX:+PrintGCDetails</span><br>  <span class="hljs-comment">// ‐XX:+HeapDumpOnOutOfMemoryError ‐XX:HeapDumpPath=/Users/panyurou/jvm.hprof</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    List&lt;Object&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      list.add(<span class="hljs-keyword">new</span> User(i++));<br>      <span class="hljs-keyword">new</span> User(j--);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行配置：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231024765.png" alt="image-20230228231024765"></p><p>运行结果：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231032270.png" alt="image-20230228231032270"></p></li><li><p>用jvisualvm命令工具导入该dump文件分析</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231039259.png" alt="image-20230228231039259"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
      <tag>java命令</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka的消息零丢失方案</title>
    <link href="/kafka%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%B6%E4%B8%A2%E5%A4%B1%E6%96%B9%E6%A1%88/"/>
    <url>/kafka%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%B6%E4%B8%A2%E5%A4%B1%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h1 id="Kafka如何保证消息的可靠性？"><a href="#Kafka如何保证消息的可靠性？" class="headerlink" title="Kafka如何保证消息的可靠性？"></a>Kafka如何保证消息的可靠性？</h1><h2 id="哪些环节会有丢消息的可能？"><a href="#哪些环节会有丢消息的可能？" class="headerlink" title="哪些环节会有丢消息的可能？"></a>哪些环节会有丢消息的可能？</h2><p><a href="https://pyr9.github.io/RabbitMQ%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%B6%E4%B8%A2%E5%A4%B1%E6%96%B9%E6%A1%88/#%E5%93%AA%E4%BA%9B%E7%8E%AF%E8%8A%82%E4%BC%9A%E6%9C%89%E4%B8%A2%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E8%83%BD%EF%BC%9F">RabbitMQ的消息零丢失方案 - 楼上有只喵 (pyr9.github.io)</a></p><h2 id="Kafka怎么保证消息可靠性"><a href="#Kafka怎么保证消息可靠性" class="headerlink" title="Kafka怎么保证消息可靠性?"></a>Kafka怎么保证消息可靠性?</h2><h3 id="1-生产者保证消息正确发送到Kafka"><a href="#1-生产者保证消息正确发送到Kafka" class="headerlink" title="1. 生产者保证消息正确发送到Kafka?"></a>1. 生产者保证消息正确发送到Kafka?</h3><p>Kafka通过配置request.required.acks属性来确认消息的生产：</p><ul><li>0 生产者将数据发送出去就不管了，不去等待任何返回。这种情况下数据传输效率最高，但是数据可靠性确是最低的，存在丢消息：数据还没写入leader，leader就挂了</li><li>1（默认） 数据发送到Kafka后，经过leader成功接收消息的的确认，就算是发送成功了。在这种情况下，如果leader宕机了，则会丢失数据。</li><li>-1或all producer需要等待ISR中的所有副本都确认接收到数据后才算一次发送完成，可靠性最高。当ISR中所有副本都向Leader发送ACK时，leader才commit，这时候producer才能认为一个请求中的消息都commit了。这种性能不高，一般是金融级别或者和钱打交道的时候采用。</li></ul><p><strong>避免消息丢失就可以将ack设置成-1或all</strong></p><blockquote><p>ISR**(InSyncRepli)** ：与leader保持一定同步程度的副本们（包括leader）。是replicas的一个子集</p></blockquote><h3 id="2-Kafka消息备份和同步"><a href="#2-Kafka消息备份和同步" class="headerlink" title="2. Kafka消息备份和同步"></a>2. Kafka消息备份和同步</h3><ul><li>afka通过分区的多副本策略来解决消息的备份问题。在kafka中，实现副本的目的就是冗余备份，且仅仅是冗余备份，所有的读写请求都是由leader副本进行处理的。follower副本仅有一个功能，那就是从leader副本拉取消息，尽量让自己跟leader副本的内容一致。</li><li>给包含重要消息的队列建立一个远端备份。</li></ul><h3 id="3-Kafka消息存盘不丢消息"><a href="#3-Kafka消息存盘不丢消息" class="headerlink" title="3. Kafka消息存盘不丢消息?"></a>3. Kafka消息存盘不丢消息?</h3><p>Kafka提供消息持久化，所有数据都会立即被写入文件系统的持久化日志中。kafka一般不会删除消息，不管这些消息有没有被消费。只会根据配置的日志保留时间(log.retention.hours)确认消息多久被删除，默认保留最近一周的日志消息。</p><h3 id="4-Kafka消费者不丢失消息"><a href="#4-Kafka消费者不丢失消息" class="headerlink" title="4. Kafka消费者不丢失消息?"></a>4. <strong>Kafka消费者不丢失消息</strong>?</h3><ul><li>RabbitMQ在消费消息时可以指定是自动应答，还是手动应答。将Kafka的应答模式设定为手动应答可以提高消息消费的可靠性。</li><li>设置了手动确认，则需要在业务处理成成功后，手动调用<code>consumer.commitSync()</code></li></ul><p><strong>最后，任何用户态的应用程序都无法保证绝对的数据安全，所以，备份与恢复的方案也需要考虑到。</strong></p>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MQ</tag>
      
      <tag>消息可靠性</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ的高级特性</title>
    <link href="/RabbitMQ%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/"/>
    <url>/RabbitMQ%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ的高级特性"><a href="#RabbitMQ的高级特性" class="headerlink" title="RabbitMQ的高级特性"></a>RabbitMQ的高级特性</h1><h2 id="如何保证消息的顺序？"><a href="#如何保证消息的顺序？" class="headerlink" title="如何保证消息的顺序？"></a><strong>如何保证消息的顺序？</strong></h2><p>消息的顺序是指的是，一个组内消息的顺序，而不是整个mq里的消息顺序。比如一个下单过程需要完成扣款，减库存，通知快递发货，这一组消息的顺序不能乱。</p><ul><li><p>发送端：一组有序消息，只发到一个队列中，利用队列的FIFO特性保证消息在发送时顺序不会乱。</p><p>如果发送端配置了重试机制，就可能出现发送方发送时是1，2，3，但1发送失败，重试发送1，这样收到的消息就是2，3，1。这种情况下，需要同步的去发消息，只有第一个消息发送成功了，再去发送2，3。</p></li><li><p>消费者端：进行消费时，保证只有一个消费者，同时指定prefetch属性为1，即每次RabbitMQ都只往消费端推送一个消息。这样可以保证消费时的有序。</p></li></ul><p><strong>显然，这是以极度消耗性能作为代价的，在实际适应过程中，应该尽量避免这种场景。</strong></p><h2 id="消息积压和解决"><a href="#消息积压和解决" class="headerlink" title="消息积压和解决"></a>消息积压和解决</h2><h3 id="1-发送方发送流量太大"><a href="#1-发送方发送流量太大" class="headerlink" title="1.发送方发送流量太大"></a>1.发送方发送流量太大</h3><ul><li>降低消息生产的速度。生产者端产生消息的速度通常是跟业务息息相关的，一般情况下不太好直接优化。但是可以采用批量发送消息的方式，降低IO频率。</li></ul><h3 id="2-消费者能力不足"><a href="#2-消费者能力不足" class="headerlink" title="2. 消费者能力不足"></a>2. 消费者能力不足</h3><ul><li><p>修改消费端程序，写一个临时的分发数据的 consumer 程序，将收到的消息快速转发给临时建立好原先 10 倍的 queue， 接着临时征用 10 倍的机器来部署 consumer，每一个 consumer 消费一个临时 queue 的数据。</p></li><li><p>上线专门的消费者组。专门用来将消息快速转录。保存到数据库或者Redis，然后再慢慢进行处理。</p></li><li><p>对于单个消费者端，可以通过配置提升消费者端的吞吐量。例如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"># 单次推送消息数量<br>spring.rabbitmq.listener.simple.prefetch=<span class="hljs-number">1</span><br># 消费者的消费线程数量<br>spring.rabbitmq.listener.simple.concurrency<br></code></pre></td></tr></table></figure></li></ul><h3 id="3-消费者有bug或者宕机了"><a href="#3-消费者有bug或者宕机了" class="headerlink" title="3.消费者有bug或者宕机了"></a>3.消费者有bug或者宕机了</h3><ul><li>将消费不成功的消息转发到其他队列里，类似死信队列，后面再慢慢分析。kafka没有死信队列需要自己实现。</li></ul><h4 id="其他解决方式"><a href="#其他解决方式" class="headerlink" title="其他解决方式"></a>其他解决方式</h4><ul><li>RabbitMQ服务端：尝试使用新推出的Quorum以及Stream队列，也能很好的提高服务端的消息堆积能力。但是这两种队列的稳定性和周边生态都还不够完善。</li><li>RabbitMQ一直以来，就是对于消息堆积问题的处理不好。当RabbitMQ中有大量消息堆积时，整体性能会严重下降。不行就换kafka</li></ul><h2 id="MQ中消息失效"><a href="#MQ中消息失效" class="headerlink" title="MQ中消息失效"></a>MQ中消息失效</h2><p>RabbtiMQ 是可以设置过期时间 的，也就是 TTL。如果消息在 queue 中积压超过一定的时间就会被 RabbitMQ 给清理掉，这个数据就没了。</p><p>解决：批量重导。就是大量积压的时候，我们当时就 直接丢弃数据了，然后等过了高峰期以后。将丢失的那批数据，写个临时程序，一点一点的查出来，然后重新灌入 mq 里面去</p><h2 id="消息的幂等性"><a href="#消息的幂等性" class="headerlink" title="消息的幂等性"></a>消息的幂等性</h2><p>造成消息重复的根本原因是：网络不可达。 </p><p>所以解决这个问题的办法就是绕过这个问题。那么问题就变成了：如果消费端收 到两条一样的消息，应该怎样处理？ </p><p>方案一： 利用一张日志表来记录已经处理成功的消息的 ID，如 果新到的消息 ID 已经在日志表中，那么就不再处理这条消息。 </p><p>方案二：消息生成唯一的id，存储在redis中。</p><p>方案二：</p><ul><li><p>第一次 执行更新语句的是一样，version &#x3D;1 </p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">update account <span class="hljs-keyword">set</span> price = price <span class="hljs-number">-100</span>, <span class="hljs-built_in">version</span> = <span class="hljs-built_in">version</span> + <span class="hljs-number">1</span>, <span class="hljs-keyword">where</span> <span class="hljs-built_in">id</span> = <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">version</span> = <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li></ul><ul><li><p>第二次, 执行更新语句的是一样，version 已经变成了2，此时找<code>where version = 1 </code> 就无法找到</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">update account <span class="hljs-keyword">set</span> price = price <span class="hljs-number">-100</span>, <span class="hljs-built_in">version</span> = <span class="hljs-built_in">version</span> + <span class="hljs-number">1</span>, <span class="hljs-keyword">where</span> <span class="hljs-built_in">id</span> = <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">version</span> = <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="消费端限流"><a href="#消费端限流" class="headerlink" title="消费端限流"></a>消费端限流</h2><ul><li>在<a href="rabbit:listener-container">rabbit:listener-container</a> 中配置<code>prefetch</code>属性设置消费端一次拉取多少消息</li><li>消费端的确认模式需要是手动确认</li></ul><h2 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h2><ol><li>TTL全称：time to live 消息存活时间或消息过期时间</li><li>消息达到了存活时间后，如果还没被消费，会被自动移除</li><li>RabbitMQ可以对消息设置过期时间，也可以对整个队列设置过期时间。</li></ol><h2 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h2><ul><li><p>当消息成为死信后，可以被重新发送到一个交换机，这个交换机就是死信交换机，它绑定的队列就是死信队列</p></li><li><p>成为死信的条件：</p><ul><li>消息达到了存活时间，还没有被消费。</li><li>消费者拒收消息，并且不重回队列。  </li><li>队列到达了指定的长度限制</li></ul></li><li><p>代码</p><ul><li><p>producer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"># 指定了消息的过期时间为10s <br>AMQP.BasicProperties properties = <span class="hljs-keyword">new</span> AMQP.BasicProperties.Builder()<br>                .deliveryMode(<span class="hljs-number">2</span>)<br>                .contentEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>)<br>                .expiration(<span class="hljs-string">&quot;10000&quot;</span>)<br>                .build();<br>  channel.basicPublish(exchange, routingKey, <span class="hljs-keyword">true</span>, properties, msg.getBytes());<br></code></pre></td></tr></table></figure></li><li><p>consumer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">String exchangeName = <span class="hljs-string">&quot;test_dlx_exchange&quot;</span>;<br>channel.exchangeDeclare(exchangeName, <span class="hljs-string">&quot;topic&quot;</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br># 在队列加上一个参数，指定死信队列<br>Map&lt;String, Object&gt; agruments = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();<br>agruments.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, <span class="hljs-string">&quot;dlx.exchange&quot;</span>);<br>channel.queueDeclare(queueName, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, agruments);<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h2><p>延迟队列，消息进入队列后，不会立即被消费，而是等到一定的时间，才会被消费。</p><p>使用场景：</p><ol><li>用户下单后，30分钟未支付，取消订单，回滚库存</li><li>新用户注册7天后，发送短信问候</li></ol><blockquote><p>当然上面的场景也可以用定时器实现</p></blockquote><p>rabbitmq现在不支持延迟队列，延迟队列的实现需要借助TTL和死信队列。具体实现流程：</p><ul><li>用户下单，把消息发送到Queue1中，不设置Consumer1，设置Queue1队列里的消息存活时间为30分钟，等待30分钟后，消息成为死信。</li><li>死信的消息发送到Queue2，添加Consumer2监听Queue2</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233554129.png" alt="image-20230228233554129"></p><h4 id="死信队列和延时队列的区别"><a href="#死信队列和延时队列的区别" class="headerlink" title="死信队列和延时队列的区别"></a>死信队列和延时队列的区别</h4><ul><li>死信队列，监听的是Queue1,成为死信的消息会被丢到DLX中，或者不处理自己清理掉</li><li>延迟队列，监听的是死信队列</li></ul>]]></content>
    
    
    <categories>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>消息中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rabbitMQ入门</title>
    <link href="/rabbitMQ%E5%85%A5%E9%97%A8/"/>
    <url>/rabbitMQ%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="MQ介绍"><a href="#MQ介绍" class="headerlink" title="MQ介绍"></a>MQ介绍</h1><h2 id="什么是MQ？"><a href="#什么是MQ？" class="headerlink" title="什么是MQ？"></a>什么是MQ？</h2><ul><li>MQ：MessageQueue，消息队列。 队列，是一种FIFO 先进先出的数据结构。</li><li>消息由生产者发送到MQ进行排队，然后按原来的顺序交由消息的消费者进行处理。</li><li>QQ和微信就是典型的MQ。</li></ul><h2 id="MQ的的优点："><a href="#MQ的的优点：" class="headerlink" title="MQ的的优点："></a>MQ的的优点：</h2><ul><li><p><strong>异步</strong>：相比于传统的串行、并行执行，可以提高吞吐量。 比如：发快递的时候，我们不需要等待用户接收到快递，而是把快递放进菜鸟驿站，发消息后，离开，用户闲暇时去取快递。</p></li><li><p><strong>解偶</strong>：服务之间进行解耦，才可以减少服务之间的影响。提高系统整体的稳定性以及可扩展性。比如用户下单的场景，用户下单后，订单系统需要通知库存系统减库存，传统的模式，当库存系统无法访问时，用户调用接口失败，从而导致下单失败。但引入MQ后，用户下单后，将下单消息写入消息队列，然后返回用户下单成功，库存系统去订阅下单的消息，去拉取下单信息，从而进行减库存，这时即使库存系统不可用，依旧可以下单成功，实现了订单系统和库存系统的解耦。</p></li><li><p><strong>削峰</strong>：可以通过消息队列长度控制请求量；可以缓解短时间内的高并发请 求。 比如双十一，请求量比较大的时候，我们可以把请求放到MQ里，下游服务再慢慢消费。</p></li></ul><h2 id="MQ的缺点"><a href="#MQ的缺点" class="headerlink" title="MQ的缺点"></a><strong>MQ的缺点</strong></h2><ul><li>系统可用性降低。系统引入的外部依赖增多，系统的稳定性就会变差。一旦MQ宕机，对业务会产生影响。这就需要考虑如何保证MQ的高可用</li><li>系统复杂度提高。引入MQ后系统的复杂度会大大提高。以前服务之间可以进行同步的服务调用，引入MQ后，会变为异步调用，数据的链路就会变得更复杂。并且还会带来其他一些问题。比如：如何保证消费不会丢失？不会被重复调用？怎么保证消息的顺序性等问题</li><li>消息一致性问题。A系统处理完业务，通过MQ发送消息给B、C系统进行后续的业务处理。如果B系统处理成功，C系统处理失败怎么办？这就需要考虑如何保证消息数据处理的一致性。</li></ul><h1 id="什么是RabbitMQ？"><a href="#什么是RabbitMQ？" class="headerlink" title="什么是RabbitMQ？"></a><strong>什么是RabbitMQ？</strong></h1><p>RabbitMQ是一款开源的，Erlang编写的，基于AMQP协议的消息中间件</p><h1 id="为什么选择rabbitmq？"><a href="#为什么选择rabbitmq？" class="headerlink" title="为什么选择rabbitmq？"></a>为什么选择rabbitmq？</h1><ul><li>支撑高并发、高吞吐、性能很高，同时有非常完善便捷的后台管理界面可以使用。 </li><li>支持集群化、高可用部署架构、消息高可靠支持，功能较为完善。</li><li>开 源的，比较稳定的支持，活跃度也高</li></ul><blockquote><p>缺点： 确实 erlang 语言阻止了大量的 Java 工程师 去深入研究和掌控它，对公司而言，几乎处于不可控的状态，</p></blockquote><h1 id="RabbitMQ的基本概念"><a href="#RabbitMQ的基本概念" class="headerlink" title="RabbitMQ的基本概念"></a>RabbitMQ的基本概念</h1><ul><li>connection： 客户端与RabbitMQ进行交互，首先就需要建立一个TPC连接，这个连接就是Connection</li></ul><ul><li><p>Broker： 简单来说就是消息队列服务器实体 </p></li><li><p>Exchange： 消息交换机，它指定消息按什么规则，路由到哪个队列 </p></li><li><p>Queue： 消息队列载体，每个消息都会被投入到一个或多个队列 </p></li><li><p>Binding： 绑定，它的作用就是把exchange和queue按照路由规则绑定起来 </p></li><li><p>Routing Key： 路由关键字，exchange根据这个关键字进行消息投递 </p></li><li><p>VHost： vhost 可以理解为虚拟 broker ，即 mini-RabbitMQ server。其内部 均含有独立的 queue、exchange 和 binding 等，但最最重要的是，其拥有独立的 权限系统，可以做到 vhost 范围的用户控制。当然，从 RabbitMQ 的全局角度，类似mysql中的database创建一个table 需要指明用哪个数据库。</p></li></ul><h1 id="channel信道"><a href="#channel信道" class="headerlink" title="channel信道"></a>channel信道</h1><ul><li>信道是生产者&#x2F;消费者与rbabitmq通信的渠道。生产者publish或者消费者consume一个队列都是通过信道完成的。</li><li>多线程时，rabbitMQ在一条tcp上建立多个信道来处理多线程。</li><li>每个信道在rabbitmq上有唯一的id,保证一个信道对应一个线程使用。</li></ul><h1 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h1><ul><li><p>交换机就类似是路由器，他会根据路由键（在rabbitMQ就是routing key），将消息分发到相应的队列上去。</p></li><li><p>交换机的四种类型</p><ul><li>fanout: 把所有发送到该交换器的消息路由到所有与该交换器绑定的队列中。(1:N)</li><li>Direct :   把消息路由到BindingKey和RoutingKey完全匹配的队列中。(1:1)</li><li>topic: 可以根据模糊匹配，可以将多个消息路由到同一个队列，比如一个队列的routing_key是’’.test”那么凡是到达路由器的消息的后缀为“.test”，都会进到这个队列。<ul><li>“* ”只能是一个单词，如“”aa.test“</li><li>“#”可以是&gt;&#x3D; 0的单词，如“”test“,”aa.bb.test”</li></ul></li><li><code>headers</code>:不依赖路由键匹配规则路由消息。是根据发送消息内容中的<code>headers</code>属性进行匹配。性能差，基本用不到。</li></ul></li></ul><h1 id="交换机-1"><a href="#交换机-1" class="headerlink" title="交换机"></a>交换机</h1><ul><li><p>交换机就类似是路由器，他会根据路由键（在rabbitMQ就是routing key），将消息分发到相应的队列上去。</p></li><li><p>交换机的四种类型</p><ul><li>fanout: 把所有发送到该交换器的消息路由到所有与该交换器绑定的队列中。(1:N)</li><li>Direct :   把消息路由到BindingKey和RoutingKey完全匹配的队列中。(1:1)</li><li>topic: 可以根据模糊匹配，可以将多个消息路由到同一个队列，比如一个队列的routing_key是’’.test”那么凡是到达路由器的消息的后缀为“.test”，都会进到这个队列。<ul><li>“* ”只能是一个单词，如“”aa.test“</li><li>“#”可以是&gt;&#x3D; 0的单词，如“”test“,”aa.bb.test”</li></ul></li><li><code>headers</code>:不依赖路由键匹配规则路由消息。是根据发送消息内容中的<code>headers</code>属性进行匹配。性能差，基本用不到。</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>消息中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>知识点汇总</title>
    <link href="/%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87/"/>
    <url>/%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="ddd227fe8659d7620d8f370281c742ffe6762a665f6b4cc1ae5c92660b6b5cfa">ffda66bfab181c2acf199c136e56147374682d524a8b022b9f8c35ea0638a7c0072d1b33d658d4b2baf1c0fa50def23c5480504f6a79e1624bf1b6b822972e416e10d4c06496abe5fea9b6d7ab0a31f7292dd3cd6971083a178232ab65102071ab3473c665c3c378983a8f4ac0ac4ae959fdce7c787214a2e42859d680577b7e45194074c3da87785a15c32e130579f613d9738b191060d3721e0c7320fc8b53f3079658ba67bb9116f0a3bfb724de650eeb70e287fa83978695ebaf0841e680cb41a7d559128c62de13bf7636deea823694253d284436d0d0d582954d0f849e9eef4e243cce365a9c6ac5662299b94aeb3c9c4c6db4e7bf62c916f950761b28ecbd0fdd9beb7db5bc15f5d2ff78d28f5f4c77c78bd8ba2e6910d6d1f041818c0cbae27caa3e8566189c5e18d50fb6f9cb020f0ee65e66e7fcd4576b30ca0046b4355a88d9183c366048061a32f4ae3440cde9d15d984c41f00b51597165527dfb3ec5ec9ace816e5036ce5d165547780984d8f5f306df26506b3efc60dcd799658787a9e1dca8a205df412532448abb834e9a8a2ff5bd0fe0b3ec23d7776f769d3880a3f26bdee2127344182b08f16419db559ff4223ea3913402baa77b78355add6b9d933433ca60835b816b7abd89b446b9794064809d6629acffe4fd6438e7c9c569131684bb2fade0375cd86ba0096da15c21e6db5a987402a4e00968644fdcba60180534c3d3da2b7b328fcbebc678b64994c8d57b3a16887e692184bd36a6995038ea0fb686b732b356e41116b91096c734fcde72b0d3d9624c7865e97ed0c2b44aabe4c5538cdffd209384011df8b14d5f3dee3c83fc8027045696a99dab35eeadba19389e997532f86a2031d9b972359bcfc68964de46910723c46185797ca0424a161c4ea1940368eebc1862b8ae64204730e82a6b2747fbcb49ec03a1cb858525519ed9fb685c81ba918b9017e9ba341666354ac30414cf766f25818141ed7bd8d683b9f378e2a19d2fc63faf0a890b5c935ffefc2739a7f0c7b0cf2ad276977515e198310b1e7fa8f09258956cf30525f5841e1bce51d598876d7e543d3d9b388b0fd00b7169d0d019adaa85c18ae5d21fdd0acf3e5c1314c687353673d0ae4d9a9abf028efdca55c891df7cb48417a6780969d50e14fe73d42192ca08ce8cb41e82b72a2b9723942f6fc63572ee4fa9758cfcbc915689dfd526ecc18531a45e7f9362f34c163d398c4d96497c1a489e4f2dc3448f96dcacd8c312a42b4ca4762209e59c004e98eac5c2e863408f305c6af43ab60d91003b367b5e85df0582cf3c15d3c55d35705bab6fa77e3945960dc4f9e53cafa5a4033767a92459e43284df13fab6dc6787ac5b3b3a2b738b7ea492e493250054cad73cf23e1190473bfcc3125cd8b1924f642f4af56dc77c3296168c477dc9fef83099c509a3d8fad46158bf076cc6b10d58c49f4f14dd840db5d58535cf4d60e0b2119149e150cab02d6c02813bc45684984fce453e78e7555793830acc583a9edcaeebddec94cdd6a76627fa76c4d07d79148ce630e5abcd96d9a185226b86c4a40796aeb39c95714ce162f3b0fb7ba48a20073f0fb55ece752577835bdb0557d273f95a7f23f03f5cbf8669b66f613df64eb55917fa2f8cdd5c74f11449d6a4597b6f07e5133766eb4c6e35e2d3de2876cf7025cb5b8b1daf1962f4007f52370e73c5e655e8a8bcca0a97c2719b5b12f9d212c3d652f0eab442686d3009a1f76c1080df9178d36005c226c71cc64813f0bbc45e8a56d2acb75f76f327c3bad0f0973c1a41a25a455bff6cd3f3dc1d38d77692b2d8a9ca22923a84154dd18813de71b3b632ab898035a8e7e34eca5314ceab8fcfaf12f4456ad6c15ad0b3bf281fc841fc6a8469a7cd61751d18409eaea657da992a5caa69c097013edd0f2393b37ce659d90bd5a49878fa82d30401e7168ad7b0bd38cc9ed8f1ad4fab8c0ad89532975b300ba21da51bfaabbdf60962afc09ec16ad9a2b92ee951a790bb0833fe453462272fa76907e7cf3b20d66de5450d132d2ae04e453109d2f12163c9a202dd2244050b45d636ae62c36a3347dba9536d0f7f22dfdb92969c0f94a4f5970e4f65656d6d6149e12b761ddba0c38a9d989b8214b163ab3a972ee5505f24775ab68b4fff72736fe51a4d22fc73048e854beb2efbf66455624a5ddb28bf732b3991d25c269c124d9fa786ad9265f47e2839ee623ba86696b0cbaeceb892d4069fe84e57dde1dbb922916ed3cbf949338c093085ec23dd80a6bce106ba43473fe4b3aab9afcc5d30896741f007a1bca088b275cd5d5d7b569bf924f01b9a2d4224515210ba36d602dbd070caba9de15c8b32d5000cb085709f1c5ff119474b60a50b8cb7cdad0dc103a37666faa722feda05552f2d5ef509f3d231801039e22ecebb6da13975da918f4b6dc038d01c0bd17ce332c0c4291a47ecdc5b6852d116c9bd94f5f0c17d93d11f51a6f4cae9bcb7e1a23fb4e2bd818021f674c18fd7757feefe61ef82b241d651ded0606ff8d8d3b4add93e5e4dcc927f4e771639823d6fd5aaa560a366c21776ebad6153ea05a96432b78b379cd9a83ecf65680e95bb5e4de84833d785462b4a180f8fa240503e381d09e9eec7d8b81e5c2f238286f0074046c5a14814a83b88fe053d3a7444e1d65e4e5023cb5b4df85979d92f78587a4800a4fdd1b3bf1801b8ffc681676649175f5f4342cc0f2810a8495a1f217ba3b06191d3c202415ac532da9c78de46ddd31dc5c098c3901ccfcb018f3192a46289eff9258eef63fd4347872673862ae6c2ad6509866c0338798d89acff44f919b27140f80ad7cdb848e6c58ca2d41c791b5bd183889d95e81001c770983882daac75ddd36ea38ee229010841c7d31a720b397837ff677b81a1289b31ccc79b4b858e2879128565c19aad6a55d152cccae06a8c77cae86d82adc9d2faeab5c55f75ea76e53ab983c44bb54e3ff5c48ab90fa77acefc4ee1fdee74ee228d9c156a185b8bba224d0e00a1fae9a3b05895cd308b59713ea7fe6f85b871e4dbc8307ab6ced11bbdbab08a2e6efc0366bcde24ae7d891b7d81f39ce88f988a9b218c16468af2a768ad3e8f69b883f322e3eb32be1539c7238d1d9f3edbaa615b544a366381b640eb7a086669e31805d569c625aed7c38c83ce155c13f824562327dabd41c69eacb16c00d4013fb7ae3ed47d1c3fc172bf9f9bf557c402e6871a789c15e56f3289f5e9da094bc3aa93864a55968e9b82e50fb3c8ec06f7286be3dbe0703467b658971aec3e8af0909de5f327819f30c66dc2b637629fb0c67f6fcc924cbad8955ab43b40d56bd2ed17350c312171646f68d38ee97fa9e7c183489b7a50f0d290044e5d0ccf49f0cf4bdf7f6879f70790d6f9b2d8c78de362eea63d1c0f02d76527fee42bf508bddddaa1a1350b95f9c7aa1429ab6b84882ce959bafb10bd6b1d3f8a4214ae50dd8d9fc2465bc4b1d11cea251cb498eb103163d1f6954608533ef52434a8113cede1e666e5ee16a99b345fe9940f9a34d74a26f478a7238fa2cadc231fff50ccb2dc3c40026a3a883e2a1bfa31a58ab09e83cdfc348243e6f77b9e4f822dd1d6e820266b427a8d3a00483826df1bfdb7f1987c31fee89674db4326c956fe21fc4377e753525208324454fa67ea590cb29db4104cdb1cf8c03026f2ff9abebe7b30697c981d41b1515250a864f5354b4b55af972888e23bb392f4dbc13130cb44e81b3580d1c7be0394dc232553775bcc3dd2b8bafbdc1ef374ecdf674f30119549428a98878dc92247b03a167c5b8126ae63ceccec975f727a3de7b359553f723f66e77120a256053d3d688ba99945f0641fc0f7be54eda27897055eb8fc25f97b778820f83a366bf78ea8ebe0a880cd514c776697f64f28a76b4e2ace307750bc57410f9ac3f1cc01fc4bf94165cd82684115815e3314986928c6afb92e46ac4163f6b136ff53e95b36d017c7e99ab16d8777566af757af836031294d5a5974cf457926717637caaa374bf8b087a0489bf5eff0dca3ec10d1c14780356179aaeff17c8bdc98b1aace3bcd3ace34c1b2908e4a717b9063416bba12bf93f9889f8b8ecc374725e7b1deac17cc834ed6a3c69b3dbfc096ad1cf602f58c02548369af29171e40b45d1294c80d0267493cb179c4189739a17434c619da586efb0f0991c610fe85ec83f4edec778edcd993ea5eb04912158f5a7ee19887b8e0c42e497728ed40ecce600d164846f9e02ff06a68b951e500bbf601aa30d6b6a2a52a498f964e23c3ca3f2f0fa026e0a5013df11186fb92a1f9da9c571b45c4ad629d7e9a66ccbe144ffec10b84a0892492a86b4bb5ef06a6604283fd7295c796111cd2547229851e61649548d5a0f2972efbaf1de82eee0b1c3d3b4921fb94b347c933ad5671f9f93f61003cb7773fc3869d58d420ddc99867117716605012d88207d0fd4df828e15f45587ca27635e419026c9b63922b62605e1e08e3444544f96683e3a01517180dd9b58e5917bd6c425ef1f77d7e3cc2965c7039f4803dd1cd52161b35d2514a7c471c91add63ac1295f7757e1d9cdb4b82963d9795e9276e4775afbae20810bd80de9ac36633a6b29f61cdf81d6c51b131609ee4db26f8919123bd6251c9eb76985971b43743f7e47f1c92ef05ab4c6f3b77ffca648cf5768761f66f6356e83bc81eec6c228049a82aefc186839b200b9212a780c8d2da1825016e18e4c692b7c3998acc81decec04d214cc6fe35d6268b1b103c85e38c2efe26024c0972ab33716220bd6fe17a7c9881857fa911ea208e25098b2c23db81ed1136d2448cce7fa02737d6046df44dfb85b2e06716c406066d5225426cb879b00a963edf67cc44a77d8c1bfb9e48e917f387becbfddccce1690019e7ed0aa03ce0b9d6567fdbf4e78742089753943e63fdf9ea9aa7282a9a17f75b5218ea004a696b62f5f8e553075c168ddad59eec26b8d508c7518ce4c09775ff45cf3bb3ac27d70cea56faedd39cf1fba955ea776f758da1c6d657fa5d334ce855c2adb7fca4c90ef8f0cb5a15bba5aa234e5aa97bde335dea1613b3a45cadeea6d04b0780375aaaf3d3335d64c1f12ac4c3ef53d300cf7e4b47b6fe7ce9c8eee7030187a8dcf07804f27357f90ff7827917b42e327e6cd7657249afe8d88abb6740b06d5086367b0acbf70cae86003594477c38f669ecaf61711fbd61340cd98958250d3b114a00ac443d2f36d136a9f2abada92dcb94bd1d0659171608334279d898ca882ddd85cb8b1add465f0e6089193676b40a122313f220b7697796dd56a9eee7a1576f79b4aefdcb08f8b2c2325794bd2f0abcf84227059c851a7af92709b955f5bc8a8f56c0c2b1c0b9eb32cbaee9461b6fe8c969a597b4176ad6d6232e41f3a60af88da01ab6117d25b50cf7d72ef7cb5d538e62fe02bb349ae69631387b4ee0033c5ff4ca4f212385b921d6e084632f40cdd250da8b4dcf53ec6d72e3f20ca177b2d0dcdb48b69c569b96169e1363490c4f84ee4f341582cc6c07b3e3b30cb9566f30683bb6f6ebcacc30ab5af42be0cc50af9c0caf622f44f3c0c44cea00b98eea1848b5dabc30f28cf7a11d3cd0f5e046be940418a52e4434e56ccee5a54447407e6ced62cda18028785383183700a47c110852fd0a0c1088b95f68266cfe30551c486ee0d436b178a3a3e04bc9cd6d24e600d36aa004c63e77c8f3ff546c8388e53a46702b53b48d17765a5ca55d3e353517470659ae64204afaf139f548ddbb5148c6da4fed85a592f858e527901dd58629e94b51e9f93a76253c828b2df4081ff5bdc954a940192684b35573614b1c9813165e066f452092706b18026a64a02028d15a97b34934ab459e8bc41a9f8191f66554135b6d021143b95e2c5bdfd099de54a04e341e994e73fd2fca03146db5546cdacdee02d3439480d745bdbaf0addb5cfd9ad66ac47b85146a84bf3100f96855badbd5efcd5811f427618414c613036fc01b3dedd33553dda7c615f199cd9c0d3cad125d7694e25558c734604165526b449dc13d6bea6c0cec308cb5cb48d8a6c566f789f78d311ad11178fc320b79cd75f2e9a899d56c615202a8d75d0d7557c7128b8405d72ecb6e20e1e12daee4bb25a27193ebe90b4f83cc6a5b9d62034fe8fd6ab4fca1bccd6121ce27dba4ff9279ef153252f480e41ee0860c0062188236544159f487ccdf1d0a0d375530c172f7bbcced3ddf842290ed76e1561ca2e245908d61b407f79cefb8ec8ad6b51c8ef505fdad38d5ccc8688331f2a166f621fc1574d83a6f63e812488bfa82bf676a19e4d03aa40bfbb36d8157196238f77fa000fb5aa513ea1be1e7c7ac14738cb50ae702b17bbaa74fe486aaec8c58127540fe2733586df0156c232d9378873535b8643d0004c057d7679882d92e09e12407456f1d0f3a2644147a93a1ffb054487d3d1c3802f34ccc950d86baf20c78563ea201d6160b62f682ca8fd0f790ab9e98a8f927df129e58325c4323b2c4f92aae177f7323a7e8c61b9201dcc7573664a57b0de7494bb9453a76b8d3cf1974909a50631c62b0131b9e0083a50ae1117e15ea7f35734538c671d5e7892cd13d23bc5d4eddd4e5e3a94579cce31f7f4d0e4e9b650bb4ed72be7e293e122cb19e5d850eb435ce0b357114592fcb60a2b56e4bed55a22705897ca4d37e8b79478f4ef35ddc201595890e6c65527da5376527f50ab6d571da9e1213d1a0d2477d09517f6e281631e22fd05ee221bfa5dc08933863b3839a0124dfe693545c2438f8229ff6e3661f63006c4b7799df3122751ebbbf7bcc2f80b3558c0a55cb46640eb65d4369d6da0ecd81b12ec8740bca7f90625a579fec865f9c275df1fa1dd63cea210d96d6045b4ab72e11b51b8d22cf7c3fd7788d122958ee6b9700f87f24f3e987116aba0672caeedd89ede9ded36bc26eee4a97348e83048806bff60f583e1c655aa3de9735d3cba93a8e9c247bdcea2c3314c8206a59899303e1ccf846c55aa473cbe2e32623428c7cd04935f5ee52ba603bdca498d08b141de4505301c3a96320308ba6b539e9d5f2e08c346fe6d000d3cf4f4ba6176fdbef4ca115b7c0a1c1f99db1054d466561931effbc5fa5473f55f21d6bfada75b659703503cea5aac9f433a6e6a65dcd619e462f0d7d9273956545c445d5d350abb5b0522061d0213812d75f58b20a2d8d383a861c7d458db31166f3a430d7f73b14fa4709df5f852e349dd22b7a4964f952a329eec0bacac114e848a153112528eb93157424fb96c6f277262d36559de92454954b47895ac11110849084e3e8705a09a0ba7a6dc418345d91e805f3f78ad197ea4077e11e2c8994bfa3eae69baea9845288e4a65bd0cbf71633f877757b1d3b63366b10066a6bf672cb45127c585e7e1edf6bceaf6d538311e414d79c8265a486f5414c21a2700d7339937f8b9c04bb9822ac42e775b2654f9345b34c51856107169fe7f4516c3e1756fdd699558172b55b42cfc2df9752199fcb578eacde84824eafff289daed4bb1e2883866cb38157d756e6adb1be8a4f35288ce810c94e1adc0324074a57b18a1f294e006ad965e89267b0f71a495c54ae4eec070acfcb7d10514ef913ee3b33b54963a31b5bf5ec6f782d53d429dade3c9b46da9bffa457a24f9b0a402659355bce246ca61244295fd8132b4e532f5cf5cf7c950afa210bdf314075abed115c1cb5ba861127a267d904601132583b2d991f69f8e0ce1b802a789b3984dcae9d4c52b00662c86756177ddca9ac58c86bdaef13221b430be70eca9a2d6b95e6a108ca3313dcb11da7930874e5cc50ac3fb069a8489d31282b2e46bf7d4c5947964cbf7eea6bae6e90e732bfd36c74f924d793c5818aca8490272ef8e939cb96aa212</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>springCloud知识点整理</title>
    <link href="/springCloud%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/"/>
    <url>/springCloud%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="1-为什么会出现SpringCloud"><a href="#1-为什么会出现SpringCloud" class="headerlink" title="1. 为什么会出现SpringCloud?"></a>1. 为什么会出现SpringCloud?</h2><p>单体架构的优缺点</p><p>优点：</p><ul><li>部署简单：只有一个包</li><li>技术单一：同一个架构来说，基本上是一个一种技术，类似springboot + java</li><li>用人成本低：因为只需要一种技术</li></ul><p>缺点：</p><ul><li>代码结构混乱：业务复杂，导致代码量很大，管理会越来越困难。</li><li>经常需要解决冲突，开发效率低：开发人员同时维护同一套代码，很难避免代码冲突。开发过程中会伴随解决冲突，严重影响开发效率。</li><li>排查解决问题成本高：线上发现了bug，可能bu g很简单，但是由于只有一套代码，需要编译打包上线，成本很高。</li><li>监控很难：很多功能点，杂在一个系统中。</li></ul><p>由于单体结构的应用随着系统复杂度的增高，会暴露出各种各样的问题。近些年来，微服务架构逐渐取代了单体架构，且这种趋势将会越来越流行。</p><h2 id="2-什么是Spring-Cloud？"><a href="#2-什么是Spring-Cloud？" class="headerlink" title="2. 什么是Spring Cloud？"></a>2. <strong>什么是Spring Cloud</strong>？</h2><p>SpringCloud是基于SpringBoot的一整套实现微服务的<strong>框架</strong>。它提供了微服务开发所需的服务注册与发现,服务调用,负载均衡,API网关</p><p>配置管理,熔断器</p><p><strong>springCloud的优缺点</strong></p><p>优点：</p><ul><li>产出于Spring大家族，Spring在企业级开发框架中无人能敌，来头很大，可以保证后续的更新、完善 。</li><li>组件丰富，功能齐全。Spring Cloud 为微服务架构提供了非常完整的支持。例 如、配置管理、服务发现、断路器、微服务网关等； </li><li>Spring Cloud 社区活跃度很高，教程很丰富，遇到问题很容易找到解决方案</li><li>服务拆分粒度更细，耦合度比较低，有利于资源重复利用，有利于提高开发效率</li><li>减轻团队的成本，可以并行开发，不用关注其他人怎么开发，先关注自己的开发 </li><li>微服务可以是跨平台的，可以用任何一种语言开发</li></ul><p>缺点：</p><ul><li>微服务过多，治理成本高，不利于维护系统 </li><li>分布式系统开发的成本高（容错，分布式事务等）对团队挑战大</li></ul><h2 id="3-springboot-和springCloud-的区别和联系"><a href="#3-springboot-和springCloud-的区别和联系" class="headerlink" title="3. springboot 和springCloud 的区别和联系"></a>3. springboot 和springCloud 的区别和联系</h2><ul><li>springCloud 是基于Springboot 构建的，他里面的每个子项目就是一个springboot项目。SpringBoot可以离开SpringCloud独立使用开发项目， 但是SpringCloud离不 开SpringBoot ，属于依赖的关系 </li><li>SpringBoot专注于快速方便的开发单个个体微服务。 SpringCloud是关注全局的微服务协调整理治理框架，为微服务架构提供了非常完整的支持。例如、配置管理、服务发现、断路器、微服务网关等</li></ul><h2 id="4-Spring-Cloud-Netflix核心组件？"><a href="#4-Spring-Cloud-Netflix核心组件？" class="headerlink" title="4. Spring Cloud Netflix核心组件？"></a>4. <strong>Spring Cloud Netflix</strong>核心组件？</h2><p>Netflix OSS 开源组件集成，包括Eureka、Hystrix、Ribbon、Feign、Zuul等 核心组件。</p><ul><li><p>Eureka：服务治理组件，包括服务端的注册中心和客户端的服务发现机制； </p></li><li><p>Ribbon：负载均衡的服务调用组件，具有多种负载均衡调用策略； </p></li><li><p>Feign：基于Ribbon和Hystrix的声明式服务调用组件； </p></li><li><p>Zuul：API网关组件，对请求提供路由及过滤功能。</p></li><li><p>Hystrix：服务容错组件，实现了断路器模式，为依赖服务的出错和延迟提供了 容错能力； </p></li><li><p>Bus:</p></li></ul><h1 id="5-微服务架构组成"><a href="#5-微服务架构组成" class="headerlink" title="5. 微服务架构组成"></a>5. 微服务架构组成</h1><h2 id="5-1-服务注册与发现"><a href="#5-1-服务注册与发现" class="headerlink" title="5.1 服务注册与发现"></a>5.1 服务注册与发现</h2><h3 id="1-服务注册和发现是什么"><a href="#1-服务注册和发现是什么" class="headerlink" title="1. 服务注册和发现是什么"></a>1. 服务注册和发现是什么</h3><ul><li>服务注册 ，就是将提供某个服务的模块信息 (通常是这个服务的ip和端口)注册到1个公共的组件上去。</li><li>服务发现 ，就是新<strong>注册的这个服务模块能够及时的被其他调用者发现。</strong></li></ul><h3 id="2-什么是注册中心"><a href="#2-什么是注册中心" class="headerlink" title="2. 什么是注册中心"></a>2. 什么是注册中心</h3><p>注册中心可以说是微服务架构中的”通讯录“，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到这里，当服务需要调用其它服务时，就到这里找到服务的地址，进行调用。</p><h3 id="3-注册中心的实现方式"><a href="#3-注册中心的实现方式" class="headerlink" title="3 注册中心的实现方式"></a>3 注册中心的实现方式</h3><ul><li>mysql: 将服务和服务地址的映射关系insert到数据库中，调用服务前去select。维护 一个心跳，定期去感应下节点状态是否正常，比如ping一下端口，如果不正常，修改此时节点状态</li><li>zookeeper：在这个父节点上创建临时子节点，用来存储服务和服务地址的映射关系，对应生成注册表。调用服务前去节点里查询节点数据，zookeeper有监听通知机制，我们对某个节点进行监听，当这个节点被删除时，监听方会感知到重新拉取服务列表。</li><li>Eureka</li></ul><h3 id="4-Spring-Cloud-如何实现服务注册和发现？"><a href="#4-Spring-Cloud-如何实现服务注册和发现？" class="headerlink" title="4. Spring Cloud 如何实现服务注册和发现？"></a>4. Spring Cloud 如何实<strong>现服务注册和发现？</strong></h3><p>由于所有服务都在 Eureka 服务器上注册并 通过调用 Eureka 服务器完成查找，因此无需处理服务地点的任何更改和处理。</p><p><a href="https://pyr9.github.io/CAP%E5%8E%9F%E5%88%99%E4%BB%A5%E5%8F%8Aeureka%E5%92%8Czookeeper%E7%9A%84%E5%AF%B9%E6%AF%94/">CAP原则以及eureka和zookeeper的对比</a></p><h2 id="5-2-服务调用"><a href="#5-2-服务调用" class="headerlink" title="5.2 服务调用"></a>5.2 服务调用</h2><h2 id="5-3-负载均衡"><a href="#5-3-负载均衡" class="headerlink" title="5.3 负载均衡"></a>5.3 负载均衡</h2><h2 id="5-4-API网关"><a href="#5-4-API网关" class="headerlink" title="5.4 API网关"></a>5.4 API网关</h2><h3 id="Spring-Cloud-Gateway-和zuul"><a href="#Spring-Cloud-Gateway-和zuul" class="headerlink" title="Spring Cloud Gateway 和zuul"></a>Spring Cloud Gateway 和zuul</h3><p>相同点：二者都是可以用来实现API网关</p><p>不同点：</p><ul><li>开发团队不同。<ul><li>zuul是netfix开发的</li><li>spring Cloud Gateway是Spring Cloud官方推出的第二代网关框架，用来取代Zuul网关。</li></ul></li><li>zuul性能相对gateway较差。<ul><li>Zuul1.* 是一个极具阻塞IO的API GateWay，每次IO操作都是从工作线程中选择一个执行，请求线程被阻塞到工作线程完成。所以zuul的性能较差。zuu2理念更先进，基于netty非阻塞，但是springCloud还没有整合。</li><li>Spring Cloud Gateway 是基于 WebFlux 框架实现的，而 WebFlux 框架底层则使用了高性能的 Reactor 模式通信框架 Netty。高并发和非阻塞通信就非常有优势</li><li>Spring Cloud Gateway还支持webSocket，并且与spring有很好的集成</li></ul></li></ul><blockquote><p>WebSocket 协议,大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于<a href="https://en.wikipedia.org/wiki/Push_technology">服务器推送技术</a>的一种。</p></blockquote><p> 多方面比较，gateWay是很理想的网关选择。</p><h2 id="5-5-配置管理"><a href="#5-5-配置管理" class="headerlink" title="5.5 配置管理"></a>5.5 配置管理</h2><h3 id="1-springCloud-config-是什么？"><a href="#1-springCloud-config-是什么？" class="headerlink" title="1 springCloud config 是什么？"></a>1 springCloud config 是什么？</h3><ul><li>Spring Cloud Config 是由 Spring Cloud 团队开发的项目，它可以为微服务架构中各个微服务提供集中化的外部配置支持。</li><li>Spring Cloud Config 可以将各个微服务的配置文件集中存储在一个外部的存储仓库或系统（例如 Git 、SVN 等）中，对配置的统一管理，以支持各个微服务的运行。</li><li>Spring Cloud Config 包含以下两个部分：<ul><li>Config Server：也被称为分布式配置中心，它是一个独立运行的微服务应用，用来连接配置仓库并为客户端提供获取配置信息、加密信息和解密信息的访问接口。</li><li>Config Client：指的是微服务架构中的各个微服务，它们通过 Config Server 对配置进行管理，并从 Config Sever 中获取和加载配置信息。</li></ul></li></ul><h2 id="5-6-熔断器"><a href="#5-6-熔断器" class="headerlink" title="5.6 熔断器"></a>5.6 熔断器</h2><h3 id="1-什么是服务熔断？"><a href="#1-什么是服务熔断？" class="headerlink" title="1. 什么是服务熔断？"></a>1. 什么是服务熔断？</h3><ul><li>服务熔断就是对服务的调用执行熔断，对于后续的请求，不再调用目标服务，而是直接返回一个合理的信息，比如说请求量太大，返回一个”此时服务过载”，从而可以快速释放资源</li><li>保护系统</li></ul><h3 id="2-为什么会有这种熔断机制的出现"><a href="#2-为什么会有这种熔断机制的出现" class="headerlink" title="2 为什么会有这种熔断机制的出现?"></a>2 为什么会有这种熔断机制的出现?</h3><p>在微服务相互调用的时候可能会出现服务调用发生异常或调用超时,多此请求造成服务积压导致服务无法使用后接着级联导致调用此服务的消费者也出现异常或调用超时,最后导致整个系统的全部崩溃.这就是雪崩效应.</p><blockquote><p><a href="https://so.csdn.net/so/search?q=%E7%BA%A7%E8%81%94&spm=1001.2101.3001.7020">级联</a>(失败)雪崩：一个服务失败，导致整条链路的服务都失败的情形。</p></blockquote><h3 id="3-熔断器的功能"><a href="#3-熔断器的功能" class="headerlink" title="3. 熔断器的功能"></a>3. 熔断器的功能</h3><ul><li>异常处理。需要可以根据异常的类型，去处理异常</li><li>日志记录。记录失败的数目，才可以开启熔断</li><li>测试失败的操作。周期性的检查来测试服务是否健康。</li><li>手动复位。管理员可以强行关闭断路器，重置故障的计数器</li><li>并发。断路器可以支持大并发量</li><li>加速断路：检测出问题的速度要快，及时响应</li><li>重试失败请求：在服务可用时，可以安排重试</li></ul><h3 id="4-熔断和降级的区别"><a href="#4-熔断和降级的区别" class="headerlink" title="4 熔断和降级的区别"></a>4 熔断和降级的区别</h3><p>相同点：</p><ul><li>目的一致。通过技术手段来保护系统</li><li>表现类似：让用户体验到某些服务暂时不可用</li><li>粒度相同：都是基于服务的</li></ul><p>不同点</p><ul><li>触发条件不同<ul><li>服务熔断：服务熔断由链路上某个服务故障引起的</li><li>服务降级，整体负荷来考虑。比如：原本有一个系统可以承载100个请求，但是后面由于请求数降低，相应的服务数量也需要降低</li></ul></li><li>管理目标层级不同<ul><li>服务熔断：服务熔断是一个框架层次的处理，</li><li>服务降级：服务降级是业务层次的处理。降级一般是从外围服务开始</li></ul></li></ul><h3 id="5-熔断的意义？"><a href="#5-熔断的意义？" class="headerlink" title="5. 熔断的意义？"></a>5. 熔断的意义？</h3><ul><li>让系统更加稳定</li><li>减少性能损耗<ul><li>响应很简单，所以产生的性能很小。</li><li>用户知道服务有问题了，就不再调用，避免一直重试，也可以减少性能损耗。</li></ul></li><li>及时响应。不需要其他计算，直接就可以返回一个简单的响应。</li><li>阀值可定制，比如请求到达10000，就开启熔断器</li></ul><h3 id="6-Spring-Cloud-如何实现服务服务熔断"><a href="#6-Spring-Cloud-如何实现服务服务熔断" class="headerlink" title="6. Spring Cloud 如何实现服务服务熔断"></a>6. Spring Cloud 如何实<strong>现服务服务熔断</strong></h3><ul><li>Feign是Netflix开发的一款服务容错和保护组件</li><li>当出现服务异常或调用超时时，Hystrix 定义了一个回退方法，与公开服 务相同的返回类型。如果暴露服务中出现异常，则回退方法将返回一些值。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br><span class="hljs-meta">@HystrixCommand(fallbackMethod=&quot;defaultCities&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-keyword">return</span> cityClient.listCity();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">defaultCities</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Micro weather city eureka is down!&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-7-消息总线"><a href="#5-7-消息总线" class="headerlink" title="5.7 消息总线"></a>5.7 消息总线</h2><h3 id="1-Spring-Cloud-Bus"><a href="#1-Spring-Cloud-Bus" class="headerlink" title="1. Spring Cloud Bus"></a>1. Spring Cloud Bus</h3><ul><li>Spring Cloud Bus 又被称为消息总线，它能够通过轻量级的消息代理（例如 RabbitMQ、Kafka 等）来构建一个公用的<strong>消息主题</strong>，将微服务架构中的各个服务都连接上来起来，从而实现广播状态更改、事件推送等功能，还可以实现微服务之间的通信功能。</li><li>目前 Spring Cloud Bus 支持两种消息代理：RabbitMQ 和 Kafka。</li></ul><h2 id="Spring-Cloud-Bus-的基本原理"><a href="#Spring-Cloud-Bus-的基本原理" class="headerlink" title="Spring Cloud Bus 的基本原理"></a>Spring Cloud Bus 的基本原理</h2><ul><li>Spring Cloud Bus 会使用一个轻量级的消息代理来构建一个公共的消息主题 Topic（默认为“springCloudBus”），<strong>这个 Topic 中的消息会被所有服务实例监听和消费</strong>。</li><li>当其中的一个服务刷新数据时，Spring Cloud Bus 会把信息保存到 Topic 中，这样监听这个 Topic 的服务就收到消息并自动消费。</li></ul><h2 id="Spring-Cloud-Bus-动态刷新配置的原理"><a href="#Spring-Cloud-Bus-动态刷新配置的原理" class="headerlink" title="Spring Cloud Bus 动态刷新配置的原理"></a>Spring Cloud Bus 动态刷新配置的原理</h2><ul><li>当 Git 仓库中的配置发生了改变，我们只需要向某一个服务Config 服务端，也可以是 Config 客户端发送一个 POST 请求，Spring Cloud Bus 就可以通过消息代理通知其他服务重新拉取最新配置，以实现配置的动态刷新。</li><li>利用 Spring Cloud Bus 的特殊机制可以实现很多功能，其中配合 Spring Cloud Config 实现配置的动态刷新就是最典型的应用场景之一。</li></ul><h2 id="Spring-Cloud-Bus-整合Spring-Cloud-Config实现配置的动态刷新"><a href="#Spring-Cloud-Bus-整合Spring-Cloud-Config实现配置的动态刷新" class="headerlink" title="Spring Cloud Bus 整合Spring Cloud Config实现配置的动态刷新"></a>Spring Cloud Bus 整合Spring Cloud Config实现配置的动态刷新</h2><ol><li>当 Git 仓库中的配置发生改变后，运维人员向 Config 服务端发送一个 POST 请求，请求路径为“&#x2F;actuator&#x2F;refresh”。</li><li>Config 服务端接收到请求后，会将该请求转发给服务总线 Spring Cloud Bus。</li><li>Spring Cloud Bus 接到消息后，会通知给所有 Config 客户端。</li><li>Config 客户端接收到通知，请求 Config 服务端拉取最新配置。</li><li>所有 Config 客户端都获取到最新的配置。</li></ol><h3 id="Ribbon-和-Feign-的区别和联系"><a href="#Ribbon-和-Feign-的区别和联系" class="headerlink" title="Ribbon 和 Feign 的区别和联系"></a>Ribbon 和 Feign 的区别和联系</h3><ul><li><p>相同点：二者都是Netflix开发的，可以用来实现服务间的调用以及负载均衡。Feign 是在 Ribbon的基础上进行了一次改进，是一个使用起来更加方便的 HTTP 客户端。</p></li><li><p>调用方式不同</p><ul><li><p>ribbon是一个基于 HTTP 和 TCP <strong>客户端</strong>的负载均衡的工具。简单来说，rubbon &#x3D; 负载均衡+ restTemplate，需要自己构建请求，步骤相当繁琐。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//面向微服务编程，即通过微服务的名称来获取调用地址</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String REST_URL_PREFIX = <span class="hljs-string">&quot;http://micro-weather-city-eureka&quot;</span>;<br>    <br> <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br> <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>&#123;<br>   <span class="hljs-keyword">return</span> restTemplate.getForObject(REST_URL_PREFIX + <span class="hljs-string">&quot;/cities&quot;</span>, String.class);<br> &#125;<br></code></pre></td></tr></table></figure></li><li><p>采用接口的方式， <strong><code>只需要创建一个接口，然后在上面添加注解@FeignClient即可</code></strong> ，将需要调用的其他服务的方法定义成抽象方法即可， 不需要自己构建http请求。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;micro-weather-city-eureka&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CityClient</span> </span>&#123;<br>  <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>  <span class="hljs-function">String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>启动类上使用的注解不同</p><p>Ribbon用的是@RibbonClient，Feign用的是@EnableFeignClients。</p></li></ul><p> 由于Ribbon写起来还需要自己拼请求，所以采用了更简单的Feign</p>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>整理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>单体架构的优缺点</title>
    <link href="/%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9/"/>
    <url>/%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="单体架构的优缺点"><a href="#单体架构的优缺点" class="headerlink" title="单体架构的优缺点"></a>单体架构的优缺点</h1><p>优点：</p><ul><li><p>部署简单：只有一个包</p></li><li><p>技术单一：同一个架构来说，基本上是一个一种技术，类似springboot + java</p></li><li><p>用人成本低：因为只需要一种技术</p></li></ul><p>缺点：</p><ul><li><p>代码结构混乱：业务复杂，导致代码量很大，管理会越来越困难。</p></li><li><p>开发效率低：开发人员同时维护同一套代码，很难避免代码冲突。开发过程中会伴随解决冲突，严重影响开发效率。</p></li><li><p>排查解决问题成本高：线上发现了bug，可能bu g很简单，但是由于只有一套代码，需要编译打包上线，成本很高。</p></li><li><p>监控很难：很多功能点，杂在一个系统中。</p></li></ul><h1 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h1><ul><li>由很多服务组成，每个服务都可以独立部署，每个服务之间以一种轻量级的通讯方式进行交互，例如http。这些服务之间没有很强的技术关联，可以A用java，B用Go.</li><li>设计原则：<ul><li>拆分足够的微。颗粒太大，没法发挥微服务的优势，颗粒太小，管理混乱。</li><li>轻量级通信。rest，消息中间件</li><li>领域驱动原则。比如客户是一个领域，表单是一个领域</li><li>单一指责。服务应该尽可能不依赖其他服务，边界应该足够清晰，而且接口应该妥善设计，隐藏内部细节。</li><li>DevOps</li><li>不限技术栈。比如mongo, pg</li></ul></li><li>如何设计：<ul><li>服务拆分</li><li>服务注册。多个服务间的通信，需要一个服务注册机制。服务启动的时候，要将服务注册到注册中心；服务中心和微服务之间通过某种机制关联，例如心跳机制；不同服务之间可以进行发现，从服务注册中心，获取要调用的服务的信息。</li><li>服务消费，调用其他服务，调用方相当于是服务消费者，被调用方是服务供应商</li><li>统一入口，服务数量多起来之后，每一个消费者要记住所有服务的名称是比较困难的，所以需要一个统一的入口，我们只需要知道入口的名称，而不需要知道具体服务提供者的名称。</li><li>配置的管理。配置文件里写上不同服务需要的配置，不同服务去做个性化配置。</li><li>熔断机制：某个微服务出现异常时（请求反应慢或宕机），其整个流程还是可以友好的进行下去。即向调用方返回一个符合预期的、可处理的备选响应(FallBack)，而不是长时间的等待或者抛出调用方无法处理的异常，这样就可以保证调用方的线程不会被长时间、无厘头滴占用，从而保护整个系统，避免崩溃。</li><li>自动扩展：服务可以根据当前附在状况可以自动扩展。比如当前有10个实例，当负荷突然增大，比如请求数增大，可以自动扩展成20个。</li></ul></li><li>拆分的意义<ul><li>易于实现：服务更小，代码更少，更加利于理解，实现。</li><li>易于维护：更少的代码，更容易维护</li><li>易于部署：每个服务都是轻量级实现，jar包比较小</li><li>易于更新：服务之间都是隔离的，所以每个服务都可以独立更新，不会影响其他服务。</li></ul></li><li>拆分的方法<ul><li>横向拆分。数据采集，数据存储，数据查询，数据展示</li><li>纵向拆分。基础设施层，领域层，应用层，用户界面</li><li>使用DDD。不同的领域</li></ul></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>postgreSQL、mysql、Mongoldb、redis的对比</title>
    <link href="/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94/"/>
    <url>/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94/</url>
    
    <content type="html"><![CDATA[<h1 id="1-postgreSQL-和-mysql的对比"><a href="#1-postgreSQL-和-mysql的对比" class="headerlink" title="1 postgreSQL 和 mysql的对比"></a>1 postgreSQL 和 mysql的对比</h1><p>目前国内Mysql是主流，PG屈于二线。</p><ul><li><p>mysql和Pg早期就是两个极端，mysql基本上就是满足数据库语法的大号KV，对关系型数据库的高级语法支持的不是很好。早期的很多互联网公司只是使用它存储，而复杂的一些计算都在服务器完成，由于确实部分高级功能和数据一致性保障，mysql支持简单SQL更加具备速度优势。</p></li><li><p>mysql多线程模型，并发支持良好，PG是多进程模型，创建进程更慢</p></li><li><p>PostgreSQL支持的数据类型比MySQL更为丰富。如array, xml，JSONB(二进制格式的JSON, 读取更快)， timestamptz(带时区的时间戳) ,numrange(数值的范围)等</p></li><li><p>事务的支持：PostgreSQL支持事务的强一致性，事务保证性好，完全支持ACID特性。MySQL只有innodb引擎支持事务，mysiam不支持事务。</p></li><li><p>PG SQL支持的索引类型很多，如：GiST（Generalized Search Tree，通用搜索树）、GIN（Generalized Inverted Index，通用倒排索引）和BRIN（Block Range INdex，块范围索引）等，可以根据不同的查询需求和数据类型选择合适的索引。这种灵活性使得PG在处理复杂查询和大数据量时更具优势。&#96;&#96;</p></li></ul><p>总之，MySQL 简单易用、性能优越，适用于处理大量读操作和小型项目；而 PostgreSQL 强大灵活、具备丰富的数据类型和高级特性，适用于处理复杂数据和大型项目。</p><blockquote><p><strong>JSON 和JSONB</strong>对比</p><ul><li><strong>JSON</strong>：以文本格式存储JSON数据，保留了JSON数据的原始格式，包括键之间的空格、键的顺序以及重复的键。当从数据库中检索JSON数据时，需要再次解析这些数据。</li><li><strong>JSONB</strong>：以二进制格式存储JSON数据，这种格式在存储前会先对数据进行解析和规范化。因此，JSONB在读取时不需要重新解析，从而提高了性能。</li></ul><p>如果你的应用只需要将JSON数据保存到数据库中，并且很少进行读取和查询操作，那么JSON可能是一个更好的选择。</p><p>如果你的应用需要在数据库中频繁地读取和查询JSON数据，或者需要在JSON列上使用索引来提高查询性能，那么JSONB将是更好的选择。</p></blockquote><h1 id="2-Mysql-和Mongoldb对比"><a href="#2-Mysql-和Mongoldb对比" class="headerlink" title="2 Mysql 和Mongoldb对比"></a>2 Mysql 和Mongoldb对比</h1><ul><li>postgresql是关系型数据库，Mongoldb 是非关系型数据库，</li><li>查询语法不同。postgresql使用基本的sql操作，mongodb使用pipeline，比如pg join ，mongo $lookup</li><li>mongodb的优势就是文档存储，业务经常变动，需要不时的添加字段，那么mongodb比较适合</li><li>对于那些需要对多个文档（在单个或多个集合中）进行原子性读写的场景，MongoDB支持了<strong>多文档事务</strong>。</li><li>mysql集群主要模式是：主从+哨兵+cluster，mongoDb的是主从+复制集+分片集群</li></ul><h1 id="3-Redis"><a href="#3-Redis" class="headerlink" title="3 Redis"></a>3 Redis</h1><ul><li>非常丰富的数据结构</li><li>Redis提供了事务的功能，可以保证一串 命令的原子性，中间不会被任何操作打断；</li><li>数据存在内存中，读写非常的高速，可以达到10w&#x2F;s的频率</li></ul><h1 id="4-es和mongo"><a href="#4-es和mongo" class="headerlink" title="4 es和mongo"></a>4 es和mongo</h1><p>相同点：</p><ul><li><code>MongoDB</code>和<code>Elasticsearch</code>都属于NoSQL大家族, 且都属于文档型数据存储</li><li>两者都通过分片支持水平扩展，分片将数据进行水平切分之后，将其存储到多个不同的服务器节点上的一 种扩展方式。</li></ul><blockquote><p> 水平分片: 通过某个字段(或某几个字段)，根据某种规则将数据分散至多个库或表中，每个分片仅包含数据的一部分。取模，范围</p><p> 垂直分片: 按照业务将表进行归类，分布到不同的数据库或表</p></blockquote><p>不同点：</p><ul><li>定位不同<ul><li>MongoDB 是 <strong>文档型数据库</strong>, 提供 <strong>数据存储和管理服务</strong></li><li><a href="https://so.csdn.net/so/search?q=Elasticsearch&spm=1001.2101.3001.7020">Elasticsearch</a> 是<strong>搜索服务</strong>, 提供 <strong>数据检索服务</strong></li></ul></li><li>使用场景：<ul><li>如果你有一批数据要看, 但是不经常进行修改, 这个时候毫无疑问可以用es</li><li>如果你还打算继续修改数据, 最好就是使用MongoDB</li></ul></li></ul><h1 id="5-influxDb是什么？"><a href="#5-influxDb是什么？" class="headerlink" title="5. influxDb是什么？"></a>5. influxDb是什么？</h1><p>InfluxDB 是一个高性能、开源的时间序列数据库，专门设计用于存储和管理时间序列数据，如监控数据、物联网数据和实时分析数据。</p><p>我们团队使用的场景是：opc数据采集，需要定时去采集设备的主轴数据。如：主轴转速、主轴负载、主轴倍率等</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>面试题</tag>
      
      <tag>redis</tag>
      
      <tag>mysql</tag>
      
      <tag>postgreSQL</tag>
      
      <tag>mongo</tag>
      
      <tag>es</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka知识点整理</title>
    <link href="/kafka%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/kafka%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h3 id="kafka和RabbitMq的对比"><a href="#kafka和RabbitMq的对比" class="headerlink" title="kafka和RabbitMq的对比"></a>kafka和RabbitMq的对比</h3><ol><li><p>存储上：</p><ul><li>kafka支持了分布式存储，也就是分区。相当于把原来rabbitMq 的queue拆分成了很多个小队列，分布式存储在不同的服务上，提高了消息的发送的效率（一次可以发到多个分区），提高了消费效率，不同分区，使用不同的消费者，提高了并发处理能力。</li></ul></li><li><p>应用场景上：</p><ul><li>RabbitMQ,遵循AMQP协议，用在实时的对可靠性要求比较高的消息传递上。</li><li>kafka它主要用于处理活跃的流式数据,大数据量的数据处理上。</li></ul></li><li><p>吞吐量上：</p><ul><li>rabbitMQ在吞吐量方面稍逊于kafka，他们的出发点不一样，rabbitMQ支持对消息的可靠的传递，支持事务，不支持批量的操作</li><li>kafka具有高的吞吐量，内部采用消息的批量处理，zero-copy机制，数据的存储和获取是本地磁盘顺序批量操作，具有O(1)的复杂度，消息处理的效率很高。</li></ul></li><li><p>在可用性方面:</p><ul><li>rabbitMQ支持miror的queue，主queue失效，miror queue接管。</li><li>kafka的broker支持主备模式。</li></ul></li><li><p>在集群负载均衡方面:</p><ul><li>rabbitMQ的负载均衡需要单独的loadbalancer进行支持。</li><li>kafka采用zookeeper对集群中的broker、consumer进行管理，可以注册topic到zookeeper上；通过zookeeper的协调机制，producer保存对应topic的broker信息，可以随机或者轮询发送到broker上；并且producer可以基于语义指定分片，消息发送到broker的某分片上。</li></ul></li><li><p>消息的删除时间上：</p><ol><li>rabbitMQ 消费完了就删除。</li><li>kafka一般不会删除消息，不管这些消息有没有被消费。只会根据配置的日志保留时间(log.retention.hours)确认消息多久被删除，默认保留最近一周的日志消息。这些日志可以被重复读取和无限期保留。</li></ol></li></ol><h3 id="为什么要对Topic下数据进行分区存储？"><a href="#为什么要对Topic下数据进行分区存储？" class="headerlink" title="为什么要对Topic下数据进行分区存储？"></a>为什么要对Topic下数据进行分区存储？</h3><ol><li>commit log文件会受到所在机器的文件系统大小的限制，分区之后可以将不同的分区放在不同的机器上，相当于对</li></ol><p>数据做了<strong>分布式存储</strong>，理论上一个topic可以处理任意数量的数据。 </p><p>  2、为了<strong>提高并行度</strong>，consumer可以并行去处理不同分区拿到的数据。</p><h3 id="怎么理解Topic，Partition和Broker-？"><a href="#怎么理解Topic，Partition和Broker-？" class="headerlink" title="怎么理解Topic，Partition和Broker ？"></a>怎么理解<strong>Topic，Partition和Broker</strong> ？</h3><ol><li><p>一个topic，代表逻辑上的一个业务数据集，比如按数据库里不同表的数据操作消息区分放入不同topic。</p></li><li><p>订单相关操作消息放入订单topic，用户相关操作消息放入用户topic，对于大型网站来说，后端数据都是海量的，订单消息很可能是非常巨量的，比如有几百个G甚至达到TB级别，如果把这么多数据都放在一台机器上可定会有容量限制问题，那么就可以在 topic内部划分多个partition来分片存储数据。</p></li><li><p>不同的partition可以位于不同的机器上，每台机器上都运行一个Kafka的进程Broker。</p></li></ol><h3 id="kafka的消费者是-pull-拉-还是push-推-模式，这种模式有什么好处？"><a href="#kafka的消费者是-pull-拉-还是push-推-模式，这种模式有什么好处？" class="headerlink" title="kafka的消费者是**pull(拉)还是push(推)**模式，这种模式有什么好处？"></a><strong>kafka</strong>的消费者是**pull(<strong>拉</strong>)<strong>还是</strong>push(<strong>推</strong>)**模式，这种模式有什么好处？</h3><p>Kafka 遵循了一种大部分消息系统共同的传统的设计：producer 将消息推送到 broker，consumer 从broker 拉取消息。</p><p>优点：pull模式消费者自主决定是否批量从broker拉取数据，而push模式在无法知道消费者消费能力情况下，不易控制推送速度，太快可能造成消费者奔溃，太慢又可能造成浪费。</p><p>缺点：如果 broker 没有可供消费的消息，将导致 consumer 不断在循环中轮询，直到新消息到到达。为了避免这点，Kafka 有个参数可以让 consumer阻塞直到新消息到达，当然也可以阻塞直到消息的数量达到某个特定的量这样就可以批量发送。</p><h2 id="集群消费"><a href="#集群消费" class="headerlink" title="集群消费"></a>集群消费</h2><ul><li>leader处理所有的针对这个partition的读写请求。</li><li>而followers被动复制leader的结果，不提供读写(主要是为了保证多副本数据与消费的一致性）。如果这个leader失效了，其中的一个follower将会自动的变成新的leader。</li></ul><h2 id="消费顺序怎么保证？"><a href="#消费顺序怎么保证？" class="headerlink" title="消费顺序怎么保证？"></a>消费顺序怎么保证？</h2><h4 id="方案一："><a href="#方案一：" class="headerlink" title="方案一："></a>方案一：</h4><ul><li><p><strong>发送端：</strong>发送消息的时候，往一个partition 中去发。</p><p>如果发送端配置了重试机制，就可能出现发送方发送时是1，2，3，但1发送失败，重试发送1，这样收到的消息就是2，3，1。这种情况下，需要同步的去发消息，只有第一个消息发送成功了，再去发送2，3。</p></li><li><p><strong>消费端：</strong>取消息的时候也从一个partition 中去取。一个partition同一个时刻，在一个consumer group里只能有一个consumer去消费，从而保证消费顺序。</p></li></ul><h4 id="方案二："><a href="#方案二：" class="headerlink" title="方案二："></a>方案二：</h4><ul><li><strong>发送端：</strong>发送消息的时候，往多个partition 中去发。</li><li><strong>消费端：</strong>只设置一个consumer，消息来了不立即处理，而是自己逻辑排序后处理。搞一个类似CountDownLatch，比如总共有3条消息，就只有当3条消息都接受到了后，才进行处理，consumer端自己可以在业务逻辑中排序，比如给消息里加上一个type类型，检测是下单的消息，就优先处理，然后再处理减库存，通知快递。如果考虑到性能还不够高，可以在consumer端，考虑增加<strong>多线程</strong>去处理。</li></ul><p>注意：</p><ul><li>consumer group中保证，consumer 的数量 &lt; partition的数量，否则多出的consumer得不到信息。</li><li>如果有在总体上保证消费顺序的需求，那么我们可以通过将topic的partition数量设置为1，将consumer group中的consumer 数量也设置为1，但是这样会影响性能，所以kafka的顺序消费很少用。</li></ul><h2 id="消息积压和解决"><a href="#消息积压和解决" class="headerlink" title="消息积压和解决"></a>消息积压和解决</h2><h3 id="1-生产者发送流量太大"><a href="#1-生产者发送流量太大" class="headerlink" title="1.生产者发送流量太大"></a>1.生产者发送流量太大</h3><ul><li>降低消息生产的速度。生产者端产生消息的速度通常是跟业务息息相关的，一般情况下不太好直接优化。但是可以采用批量发送消息的方式，降低IO频率。</li></ul><h3 id="2-消费者能力不足"><a href="#2-消费者能力不足" class="headerlink" title="2. 消费者能力不足"></a>2. 消费者能力不足</h3><ul><li>修改消费端程序，写一个临时的分发数据的 consumer 程序，将收到的消息快速转发给指定的新创建的topic，给这个topic设置原来10倍的分区。临时征用 10 倍的机器来部署 consumer，每一个 consumer 消费一个新主题的分区。</li><li>将消息快速转录。保存到数据库或者Redis，然后再慢慢进行处理。</li><li>kafka消费能力不足，则可以考虑增加Topic的Partition的个数，同时提升消费者组的消费者数量。</li></ul><h3 id="3-数据格式变动或者消费者有bug"><a href="#3-数据格式变动或者消费者有bug" class="headerlink" title="3. 数据格式变动或者消费者有bug"></a>3. 数据格式变动或者消费者有bug</h3><ul><li>将消费不成功的消息转发到其他队列里，类似死信队列，后面再慢慢分析。kafka没有死信队列需要自己实现。</li></ul><h3 id="kafka-如何不消费重复数据？"><a href="#kafka-如何不消费重复数据？" class="headerlink" title="kafka 如何不消费重复数据？"></a>kafka 如何不消费重复数据？</h3><p>重复数据的产生：</p><ul><li><p>发送方：发送消息如果配置了重试机制，比如网络抖动时间过长导致发送端发送超时，实际broker可能已经接收到消息，但发送方会重新发送消息</p></li><li><p>消费方：如果消费这边配置的是自动提交，刚拉取了一批数据处理了一部分，但还没来得及提交，服务挂了，下次重启又会拉取相同的一批数据重复处理。</p></li></ul><p> 解决方式：</p><ul><li><p>消费消息服务做幂等校验，比如：数据库&#x2F;redis：设置一个唯一的id去标志这条消息，消费时去查询一下，如果已经消费过了，则不进行消费。 </p></li><li><p>将<code>enable.auto.commit</code>参数设置为 false，关闭自动提交，开发者在代码中手动提交 offset。那么这里会有个问题：</p><p>什么时候提交offset合适？</p><ul><li>处理完消息再提交：依旧有消息重复消费的风险，和自动提交一样</li><li>拉取到消息即提交：会有消息丢失的风险。允许消息延时的场景，一般会采用这种方式。然后，通过定时任务在业务不繁忙（比如凌晨）的时候做数据兜底。</li></ul></li><li><h1 id="6-Zookeeper-在-Kafka-中的作用"><a href="#6-Zookeeper-在-Kafka-中的作用" class="headerlink" title="6 Zookeeper 在 Kafka 中的作用?"></a>6 Zookeeper 在 Kafka 中的作用?</h1><p>ZooKeeper 主要为 Kafka 提供元数据的管理的功能。</p><ol><li><p><strong>Broker 注册</strong> ：在Zookeeper上会有一个专门<strong>用来进行Broker服务器列表记录</strong>的节点&#x2F;brokers&#x2F;ids，每个Broker在启动时，都会到Zookeeper上进行注册，即到&#x2F;brokers&#x2F;ids下创建属于自己的节点，如&#x2F;brokers&#x2F;ids&#x2F;[0…N]。Kafka使用了全局唯一的数字来指代每个Broker服务器，不同的Broker必须使用不同的Broker ID进行注册，创建完节点后，<strong>每个Broker就会将自己的IP地址和端口信息记录</strong>到该节点中去。其中，Broker创建的节点类型是临时节点，一旦Broker宕机，则对应的临时节点也会被自动删除。</p></li><li><p><strong>Topic 注册</strong>： 在 Kafka 中，同一个<strong>Topic 的消息会被分成多个分区</strong>并将其分布在多个 Broker 上，<strong>这些分区信息及与 Broker 的对应关系</strong>也都是由 Zookeeper 在维护。比如我创建了一个名字为 my-topic 的主题并且它有两个分区，对应到 zookeeper 中会创建这些文件夹：<code>/brokers/topics/my-topic/Partitions/0</code>、<code>/brokers/topics/my-topic/Partitions/1</code></p></li><li><p><strong>负载均衡</strong> ：Kafka 通过给特定 Topic 指定多个 Partition, 而各个 Partition 可以分布在不同的 Broker 上, 这样便能提供比较好的并发能力。 对于同一个 Topic 的不同 Partition，Kafka 会尽力将这些 Partition 分布到不同的 Broker 服务器上。当生产者产生消息后也会尽量投递到不同 Broker 的 Partition 里面。<strong>当 Consumer 消费的时候，Zookeeper 可以根据当前的 Partition 数量以及 Consumer 数量来实现动态负载均衡。</strong></p></li><li><p>之前，在消费者对指定消息分区进行消息消费的过程中，<strong>需要定时地将分区消息的消费进度Offset记录到Zookeeper上</strong>，以便在该消费者进行重启或者其他消费者重新接管该消息分区的消息消费后，能够从之前的进度开始继续进行消息消费。</p></li></ol></li></ul><h2 id="消费进度Offset的理解"><a href="#消费进度Offset的理解" class="headerlink" title="消费进度Offset的理解"></a>消费进度Offset的理解</h2><ul><li><p>在消费者对指定消息分区进行消息消费的过程中，<strong>需要定时地将分区消息的消费进度Offset记录到Zookeeper上</strong>，以便在该消费者进行重启或者其他消费者重新接管该消息分区的消息消费后，能够从之前的进度开始继续进行消息消费。</p></li><li><p>现在是放在了一个叫做__consumer_offset 的topic 里，<strong>key是</strong> consumerGroupId+topic+分区号，value就是当前offset的值。默认是50个分区，由consumer自己管理。 </p></li><li><p><strong>每个consumer是基于自己在commit log中的消费进度(offset)来进行工作的</strong>。</p></li><li><p>这意味kafka中的consumer对集群的影响是非常小的，添加一个或者减少一个consumer，对于集群或者其他consumer 来说，都是没有影响的，因为每个consumer维护各自的消费offset。</p></li><li><p>一般情况下我们按照顺序逐条消费commit log中的消息，当然我可以通过指定offset来重复消费某些消息， 或者跳过某些消息。</p></li></ul><h2 id="延迟队列的实现"><a href="#延迟队列的实现" class="headerlink" title="延迟队列的实现"></a>延迟队列的实现</h2><ol><li>发送延时消息时先把消息按照不同的延迟时间段发送到指定的队列中（topic_1s，topic_5s，topic_10s，…topic_2h，这个一 般不能支持任意时间段的延时）。</li><li>consumer通过定时器进行轮训消费这些topic，查看消息是否到期，如果到期就把这个消息发送到具体业务处理的topic中。提交时需要带上offset，便于下次知道从哪里开始消费。</li><li>队列中消息越靠前的到期时间越早，具体来说就是定时器在一次消费过程中，对消息的发送时间做判断，看下是否延迟到对 应时间了，如果到了就转发，如果还没到这一次定时任务就可以提前结束了。</li></ol><h2 id="kafka-高性能的原因？"><a href="#kafka-高性能的原因？" class="headerlink" title="kafka 高性能的原因？"></a>kafka 高性能的原因？</h2><ul><li><p>磁盘顺序读写：kafka消息不能修改以及不会从文件中间删除保证了磁盘顺序读，kafka的消息写入文件都是追加在文件末尾， </p><p>不会写入文件中的某个位置(随机写)保证了磁盘顺序写。 </p></li><li><p>读写数据的批量batch处理以及压缩传输 。Kafka采用的数据压缩的方式，以时间换空间，通过cpu时间的增加来尽量的减少磁盘空间的占用和网络IO的传输量，Kafka中消息的压缩是发生在生产者和Broker端的。</p><ul><li>在生产者端，消息发送的时候将消息进行压缩，可以通过参数来配置进行压缩的算法</li><li>在消费者端就需要对消息进行解压缩操作</li></ul></li><li><p>数据传输的零拷贝</p><ul><li><p>传统的IO流程，某台机器将一份数据（比如一个文件）通过网络传输到另外一台机器，主要包括 read 和 write 过程。</p><ul><li>read：把数据从磁盘读取到内核缓冲区，再拷贝到用户缓冲区</li><li>write：先把用户缓冲区的数据写入到 socket缓冲区，最后写入网卡设备</li></ul></li><li><p>需要经过四次拷贝和四次状态的转换</p><ul><li><p>用户空间的应用程序通过read()函数，向操作系统发起IO调用，<strong>上下文从用户态到切换到内核态（切换1）</strong>，然后再通过 DMA 控制器将数据从【磁盘文件】拷贝到【操作系统内核缓冲区】</p></li><li><p>CPU将数据从【内核缓冲区】拷贝到【用户缓冲区】，<strong>上下文从内核态转为用户态（切换2）</strong>，read函数返回。</p></li><li><p>用户应用进程通过write函数，发起IO调用，<strong>上下文从用户态转为内核态（切换3）</strong>，CPU将数据从【用户缓冲区】拷贝到【内核中Socket缓冲区】</p></li><li><p>MA控制器把数据从【内核中Socket缓冲区】拷贝到【内核中网卡的缓冲区】<strong>上下文从内核态切换回用户态（切换4）</strong>，write函数返回</p></li></ul></li><li><p>Kafka 使用sendfile 来实现零拷贝</p><ul><li>数据从从【磁盘文件】拷贝到【操作系统内核缓冲区】后，直接让操作系统内核缓冲区的数据发送到网卡，跳过了两次CPU拷贝数据的步骤。减少了内核态和用户态上下文状态的切换</li></ul></li></ul><p>注：<strong>其实零拷贝，并不是说拷贝的次数为零，只是说没有cup拷贝的过程，这里的零拷贝指的是cpu拷贝次数为零</strong>，</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228234101159.png" alt="image-20230228234101159"></p></li></ul><blockquote><p> 什么是用户态、内核态?</p></blockquote><blockquote><ul><li>如果进程运行于内核空间，被称为进程的内核态</li><li>如果进程运行于用户空间，被称为进程的用户态。</li></ul><p>操作系统为每个进程都分配了内存空间，一部分是用户空间，一部分是内核空间。<strong>内核空间是操作系统内核访问的区域，是受保护的内存空间，而用户空间是用户应用程序访问的内存区域</strong></p></blockquote><h2 id="设计一个MQ的思路"><a href="#设计一个MQ的思路" class="headerlink" title="设计一个MQ的思路"></a>设计一个MQ的思路</h2><ul><li>可伸缩性：需要的时候快速扩容，就可以增加吞吐量和容量。参照一下 kafka 的设计理念， broker -&gt; topic -&gt; partition，每个 partition 放一个机器，就存一部分数据。 如果现在资源不够了，给 topic 增加 partition。</li><li>持久化：mq 的数据要落地磁盘，参考kafka顺序写，顺序读。这样就没有磁盘随机读写的寻址开销，磁盘顺序读写的性能是很高的</li><li>高可用性：多副本 -&gt; leader &amp; follower，broker 挂了重新选举 leader</li><li>数据 0 丢失：参考：<a href="https://pyr9.github.io/RabbitMQ%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%B6%E4%B8%A2%E5%A4%B1%E6%96%B9%E6%A1%88/">RabbitMQ的消息零丢失方案 - 楼上有只喵 (pyr9.github.io)</a>， <a href="https://pyr9.github.io/kafka%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%B6%E4%B8%A2%E5%A4%B1%E6%96%B9%E6%A1%88/">kafka的消息零丢失方案 - 楼上有只喵 (pyr9.github.io)</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>整理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java 代理</title>
    <link href="/java-%E4%BB%A3%E7%90%86/"/>
    <url>/java-%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><p> 代理是一种设计模式</p><ul><li>定义：通过代理对象访问目标对象。</li><li>好处：可以在不修改目标对象的基础上，扩展目标对象的功能</li></ul><p> 代理类可以分为静态代理和动态代理。</p><h2 id="1-静态代理和动态代理"><a href="#1-静态代理和动态代理" class="headerlink" title="1.静态代理和动态代理"></a><strong>1.静态代理</strong>和动态代理</h2><h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h3><ol><li><p>定义： 通过声明一个明确的代理类来访问源对象。需要和目标对象一起实现相同的接口或者继承相同的父类。</p></li><li><p>特点：在编译器确定代理对象，在程序运行前，代理类的.class文件就已经存在了。</p></li><li><p>优点：可以做到不修改目标对象的前提下，对目标对象的方法进行扩展。</p></li><li><p>缺点：</p><ul><li><p>代理类需要和目标类实现相同的接口，同时要实现相同的方法，这样就出现了很多重复代码。</p></li><li><p>如果接口增加一个方法，代理类和目标类都需要实现这个方法，增加了代码维护的复杂度。</p></li></ul></li></ol><h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><h4 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h4><ol><li><p>定义：使用JDK官方的Proxy类创建代理对象。</p></li><li><p>特点：在程序运行过程中，动态生成代理类，代理类需要实现<strong>InvocationHandler</strong>，重写invoke方法。</p></li><li><p>优点：</p><ul><li>接口中声明的所有方法被迁移到代理类中的invoke方法进行实现，这样，如果接口方法很多的话，不需要为每一个方法进行中转，可以灵活处理。</li></ul></li></ol><h4 id="CGLIB动态代理"><a href="#CGLIB动态代理" class="headerlink" title="CGLIB动态代理"></a>CGLIB动态代理</h4><ol><li><p>使用：第三方CGLib的Enhancer类创建代理对象, 设置Superclass为目标类， 使用的是方法拦截器 <strong>MethodInterceptor</strong>，重写intercept方法。</p></li><li><p>特点：Cglib是通过生成子类来实现的，代理对象既可以赋值给实现类，又可以赋值给接口。</p></li><li><p>优点：Cglib速度比jdk动态代理更快，性能更好。</p></li></ol><h2 id="静态代理程序示例"><a href="#静态代理程序示例" class="headerlink" title="静态代理程序示例"></a>静态代理程序示例</h2><p>step1:定义委托类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Email</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">()</span></span>;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlashEmail</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Email</span> </span>&#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">// TODO Auto-generated method stub</span><br>            System.out.println(<span class="hljs-string">&quot;邮件发送中。。。。。&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">// TODO Auto-generated method stub</span><br>       System.out.println(<span class="hljs-string">&quot;邮件接受中..........&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>step2:定义代理类，与委托类有同样的接口</p><p> 不改变原接口实现类的情况下，就可以对接口的功能进行需求变更</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Email</span> </span>&#123;<br><br>Email email;<br>     <span class="hljs-comment">//传入委托类初始化代理类</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EmailProxy</span><span class="hljs-params">(Email email)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">this</span>.email=email;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;发送邮件前准备。。。&quot;</span>);<br>    email.send();<br>    System.out.println(<span class="hljs-string">&quot;发送后。。。。。。&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">revieve</span><span class="hljs-params">()</span> </span>&#123;<br><br>System.out.println(<span class="hljs-string">&quot;接受邮件前准备。。。&quot;</span>); <br>email.receive();<br>System.out.println(<span class="hljs-string">&quot;接受邮件成功....&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>step3:测试代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><span class="hljs-comment">//原始对象</span><br>   Email email=<span class="hljs-keyword">new</span> FlashEmail();<br>   <span class="hljs-comment">//接口的代理类</span><br>   EmailProxy ep=<span class="hljs-keyword">new</span> EmailProxy(email);<br>   ep.send();<br>   System.out.println(<span class="hljs-string">&quot;-----------------------------------------&quot;</span>);<br>   ep.receive();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>测试结果：</p><p>发送邮件前准备。。。<br> 邮件发送中。。。。。<br> 发送后。。。。。。<br> -—————————————-<br> 接受邮件前准备。。。<br> 邮件接受中……….<br> 接受邮件成功….</p><h3 id="2-JDK动态代理程序示例"><a href="#2-JDK动态代理程序示例" class="headerlink" title="2 JDK动态代理程序示例"></a>2 JDK动态代理程序示例</h3><p>Step1: 定义接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Email</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">revieve</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>step1:定义委托类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlashEmail</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Email</span> </span>&#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">// TODO Auto-generated method stub</span><br>            System.out.println(<span class="hljs-string">&quot;邮件发送中。。。。。&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">// TODO Auto-generated method stub</span><br>       System.out.println(<span class="hljs-string">&quot;邮件接受中..........&quot;</span>);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>step2:在使用动态代理时，我们需要定义一个位于代理类与委托类之间的中介类，也叫动态代理类，以完成代理要完成的具体操作，这个类被要求实现<strong>InvocationHandler</strong>接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.my.test.proxy;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>Object obj;<span class="hljs-comment">//委托对象</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EmailProxy</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br><span class="hljs-keyword">super</span>();<br><span class="hljs-keyword">this</span>.obj = obj;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;send&quot;</span>.equals(method.getName())) &#123;<br> System.out.println(<span class="hljs-string">&quot;发送邮件前准备。。。&quot;</span>);<br> method.invoke(obj);<span class="hljs-comment">//从委托对象中，调用该对象的指定方法，这里相当于send方法</span><br>     System.out.println(<span class="hljs-string">&quot;发送后。。。。。。&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;receive&quot;</span>.equals(method.getName())) &#123;<br>System.out.println(<span class="hljs-string">&quot;接受邮件前准备。。。&quot;</span>); <br>method.invoke(obj);<br>System.out.println(<span class="hljs-string">&quot;接受邮件成功....&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>step4:测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Email email=<span class="hljs-keyword">new</span> FlashEmail();<br>    Email emailProxy=(Email) Proxy.newProxyInstance(<br>      email.getClass().getClassLoader(),<br>      email.getClass().getInterfaces(),<br>      <span class="hljs-keyword">new</span> EmailProxy(email) );<br>    emailProxy.send();<br>    System.out.println(<span class="hljs-string">&quot;---------------------------------------------------&quot;</span>);<br>    emailProxy.receive();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>测试结果：</p><p>发送邮件前准备。。。<br> 邮件发送中。。。。。<br> 发送后。。。。。。<br> -—————————————-<br> 接受邮件前准备。。。<br> 邮件接受中……….<br> 接受邮件成功….</p><h3 id="CGLIB动态代理程序示例"><a href="#CGLIB动态代理程序示例" class="headerlink" title="CGLIB动态代理程序示例"></a>CGLIB动态代理程序示例</h3><p>Step1: 引入cglib依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>  &lt;groupId&gt;cglib&lt;/groupId&gt;<br>  &lt;artifactId&gt;cglib&lt;/artifactId&gt;<br>  &lt;version&gt;<span class="hljs-number">3.2</span><span class="hljs-number">.5</span>&lt;/version&gt;<br>  &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>Step2: 定义委托类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlashEmail</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">()</span> </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;邮件发送中。。。。。&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">()</span> </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;邮件接受中..........&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Step3: 创建一个拦截器，实现接口net.sf.cglib.proxy.MethodInterceptor，用于方法的拦截回调。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MethodInterceptor</span> </span>&#123;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">intercept</span><span class="hljs-params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>    Object result = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;send&quot;</span>.equals(method.getName())) &#123;<br>      System.out.println(<span class="hljs-string">&quot;发送邮件前准备。。。&quot;</span>);<br>      result = methodProxy.invokeSuper(proxy,args);<br>      System.out.println(<span class="hljs-string">&quot;发送后。。。。。。&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;receive&quot;</span>.equals(method.getName())) &#123;<br>      System.out.println(<span class="hljs-string">&quot;接受邮件前准备。。。&quot;</span>);<br>      result = methodProxy.invokeSuper(proxy,args);<br>      System.out.println(<span class="hljs-string">&quot;接受邮件成功....&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Step4: 测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> proxy;<br><br><span class="hljs-keyword">import</span> net.sf.cglib.proxy.Enhancer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    <span class="hljs-comment">// 创建Enhancer对象，类似于JDK动态代理的Proxy类</span><br>    Enhancer enhancer = <span class="hljs-keyword">new</span> Enhancer();<br>    enhancer.setSuperclass(FlashEmail.class);<br>    enhancer.setCallback(<span class="hljs-keyword">new</span> LogInterceptor());<br>    <span class="hljs-comment">// create方法正式创建代理类</span><br>    FlashEmail emailProxy = (FlashEmail)enhancer.create();<br>    emailProxy.send();<br>    emailProxy.receive();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试结果：</p><p>发送邮件前准备。。。<br> 邮件发送中。。。。。<br> 发送后。。。。。。<br> -—————————————-<br> 接受邮件前准备。。。<br> 邮件接受中……….<br> 接受邮件成功….</p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>面试题</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring知识点整理</title>
    <link href="/Spring%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/Spring%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Spring是什么？有什么优点"><a href="#1-Spring是什么？有什么优点" class="headerlink" title="1. Spring是什么？有什么优点"></a>1. Spring是什么？有什么优点</h1><ul><li>Spring是一个轻量级的java框架，Spring的核心是IOC和AOP。主要的优点包括：<ul><li>方便解耦，简化开发。通过Spring提供的IOC容器，我们可以将对象的依赖关系交给Spring进行控制，避免硬编码造成的耦合性高。简单来说，之前，如果我们controller 需要一个service，则需要new service，现在是Spring发现你的controller 需要service，就给你自动注入。</li><li>AOP编程的支持。Spring提供面向切面编程，方便的实现对程序进行拦截，运行监控等。主要通过BeanPostProcessor 的postProcessBeforeInitialization，postProcessAfterInitialization， + 动态代理实现。（有接口就用JDK的动态代理，否则CJLIB）</li><li>声明式事务的支持。只需要配置就可以实现对事务的管理，而无需手动编程。</li><li>对Junit支持，方便程序测试。<ul><li>集成了各种优秀框架，如mybatis, quartz。</li></ul></li></ul></li></ul><h1 id="2-在-Spring-中，Bean-是如何生成的？-x2F-bean-的生命周期"><a href="#2-在-Spring-中，Bean-是如何生成的？-x2F-bean-的生命周期" class="headerlink" title="2 在 Spring 中，Bean 是如何生成的？&#x2F; bean 的生命周期"></a>2 在 Spring 中，Bean 是如何生成的？&#x2F; bean 的生命周期</h1><ul><li>Spring扫描class 文件，得到BeanDefinition</li><li>根据BeanDefinition去生成bean<ul><li>实例化阶段：根据构造函数来完成实例化 （<strong>未属性注入以及初始化的对象</strong> 这里简称为 <strong>原始对象</strong>）</li><li>属性注入阶段：对 Bean 的属性进行依赖注入 （这里就是<strong>发生循环依赖问题的环节</strong>）</li><li>如果 Bean 的某个方法有AOP操作，则需要根据原始对象生成<strong>代理对象</strong>。（beanPostProcessor）</li></ul></li><li>最后把代理对象放入单例池（一级缓存singletonObjects）中，下次获取对象就直接从单例池中获取。</li></ul><h1 id="3-Spring的循环依赖"><a href="#3-Spring的循环依赖" class="headerlink" title="3. Spring的循环依赖"></a>3. Spring的循环依赖</h1><p>循环依赖就是在创建bean的过程中（实例化 Bean 后会进行 属性注入（依赖注入）），A对象依赖了B对象，B对象依赖了A对象，导致A，B两个对象都创建不出来。</p><blockquote><p> ABean 创建–&gt;依赖了 B 属性–&gt;触发 BBean 创建—&gt;B 依赖了 A 属性—&gt;需要 ABean（但 ABean 还在创建过程中）</p></blockquote><p>而这种情况只会在将Bean交给Spring管理的时候才会出现，因为上面的这些属性注入操作都是Spring去做的，如果只是我们自己在Java中创建对象可以不去注入属性，让成员属性为NULL也可以正常执行的，这样也就不会出现循环依赖的问题了。</p><p>在 Spring 中，通过<strong>三级缓存</strong>机制帮开发者解决了部分循环依赖的问题。</p><ul><li>一级缓存为：<strong>singletonObjects</strong>: 缓存已经经历了完整生命周期的 bean 对象。</li><li>二级缓存为：<strong>earlySingletonObjects</strong>: 缓存的是早期的 bean 对象。表示 Bean 的生命周期还没走完就把这个 Bean 放入了 earlySingletonObjects。</li><li>三级缓存为：<strong>singletonFactories</strong>: 缓存的是 ObjectFactory，对象工厂，用来创建早期 bean 对象的工厂。实际上是一个 Lambda 表达式， 执行lambda表达式，得到就是对应的代理对象。</li></ul><p>简单点说，Spring解决循环依赖的思路就是：当A的bean需要B的bean的时候，提前将A的bean放在缓存中（实际是将A的ObjectFactory放到三级缓存），然后再去创建B的bean，但是B的bean也需要A的bean，那么这个时候就去缓存中拿A的bean，B的bean创建完毕后，再回来继续创建A的bean，最终完成循环依赖的解决。</p><p>Spring 利用 三级缓存 巧妙地将出现 循环依赖 时的 AOP 操作 提前到了 属性注入 之前（通过第三级缓存实现的），解决了循环依赖问题。</p><h1 id="4-Spring前后置环绕异常通知"><a href="#4-Spring前后置环绕异常通知" class="headerlink" title="4 Spring前后置环绕异常通知"></a>4 Spring前后置环绕异常通知</h1><ul><li>before: 方法执行前执行，如果通知抛出异常，则方法无法执行。</li><li>after: 方法执行后执行，不论方法中是否抛出异常。主要用来清理现场。</li><li>around：环绕通知，方法执行前后分别执行，必须手动调用目标方法。</li><li>afterReturning: 方法执行后执行，可以获得方法的返回值，方法中抛出异常则无法执行。</li><li>afterThrowing: 方法抛出异常后执行。</li></ul><h1 id="5-Spring事务传播行为（多个事务存在是怎么处理的？）"><a href="#5-Spring事务传播行为（多个事务存在是怎么处理的？）" class="headerlink" title="5 Spring事务传播行为（多个事务存在是怎么处理的？）"></a>5 Spring事务传播行为（多个事务存在是怎么处理的？）</h1><ul><li><p>equired(需要)： 默认值。如果当前存在事务则加入这个事务，如果当前没有事务就新创建一个。</p></li><li><p>supports(支持)：如果当前存在事务，就加入这个事务，否则就以非事务的方式运行。</p></li><li><p>Mandatory(必须，强制)：如果当前存在事务，就加入这个事务，如果当前没有事务，就抛出异常。</p></li><li><p>Requires_new: 如果当前存在事务，就将该事务挂起。创建一个新的事务来运行。</p></li><li><p>Not_supported: 如果当前存在事务，就将该事务挂起。以非事务的方式运行。</p></li><li><p>never:  如果当前存在事务，就抛出异常，以非事务的方式运行。</p></li><li><p>nested(嵌套)：  如果当前存在事务，就创建一个事务当作当前事务的嵌套事务来运行，如果当前没有事务，就创建一个事务。</p><p>(加入<em>3+ 挂起</em> * 2+ 异常 * 1 + 嵌套事务 *1 s)</p></li></ul><h1 id="6-Resource和-Autowired的区别？"><a href="#6-Resource和-Autowired的区别？" class="headerlink" title="6. @Resource和@Autowired的区别？"></a>6. @Resource和@Autowired的区别？</h1><ol><li>来源不同</li></ol><p>@Autowired 是 Spring 定义的注解，而 @Resource 是 JDK 定义的注解，</p><ol start="2"><li>依赖查找顺序不同</li></ol><ul><li><p>@Autowired 是先根据类型（byType）查找，如果存在多个 Bean 再根据名称（byName）进行查找，，可以通过 <code>@Qualifier</code> 注解指定要注入的 bean 名称。</p></li><li><p>@Resource 是先根据名称查找，如果（根据名称）查找不到，再根据类型进行查找</p></li></ul><ol start="3"><li>依赖注入的用法支持不同</li></ol><ul><li>@Autowired 既支持构造方法注入，又支持属性注入和 Setter 注入</li><li>@Resource 只支持属性注入和 Setter 注入；</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>整理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>死锁</title>
    <link href="/%E6%AD%BB%E9%94%81/"/>
    <url>/%E6%AD%BB%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><ul><li><p>定义：死锁是两个或两个以上的线程互相都持有对方所需要的资源，导致这些线程都处于等待状态。</p></li><li><p>死锁产生的条件：</p><ul><li>互斥条件：一个资源只能被一个进程占用。</li><li>请求和保持条件：一个进程因请求被占用资源而发生阻塞时，对已获得的资源保持不变。</li><li>不剥夺条件：任何一个资源在没被该进程释放之前，其他线程都无法对他剥夺占用。</li><li>循环等待：当发生死锁时，所等待的线程会进入一个类似死循环，造成阻塞。</li></ul></li><li><p>如何避免</p><ul><li>设置加锁顺序。当多个线程需要一些相同的锁时，按照不同的加锁顺序去加锁。这种需要你事先知道所有的锁，但某些情况是未知的。</li><li>设置加锁时限。当一个线程在制定时限内没有获取到所需要的锁，则会释放已经获取到的锁，然后等待一段时间再重试。</li></ul></li><li><p>死锁检查</p></li><li><p>方式一：jps+jstack</p><ul><li>运行<code>jps</code>，查看当前所有java进程的pid</li><li><code>jstack pid</code> 查看当前进程的堆栈状态，如果有死锁会打印出来found 1 deadLock</li></ul></li><li><p>方式二：jvisualvm</p><p>代码运行起来后，启动jvisualvm，在线程页面会直接有一个红色的显示：监测到死锁</p></li><li><p>参考地址：<a href="https://pyr9.github.io/java%E5%91%BD%E4%BB%A4-jstack-%E5%B7%A5%E5%85%B7/">java命令–jstack的使用 - 楼上有只喵 (pyr9.github.io)</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>整理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NIO,BIO,AIO</title>
    <link href="/NIO-BIO-AIO/"/>
    <url>/NIO-BIO-AIO/</url>
    
    <content type="html"><![CDATA[<h3 id="1-BIO、NIO、AIO定义"><a href="#1-BIO、NIO、AIO定义" class="headerlink" title="1.BIO、NIO、AIO定义"></a>1.BIO、NIO、AIO定义</h3><p>Java共支持3种<a href="https://so.csdn.net/so/search?q=%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B&spm=1001.2101.3001.7020">网络编程</a>模型IO模式</p><ul><li><p><strong>BIO</strong>：(blocking io）同步并阻塞（传统阻塞型），服务器实现模式为一个连接一个线程，即客户端有连接请求时，服务器就要启动一个线程进行处理，如果这个链接不做任何事，就容易造成不必要的线程开销。当一个线程调用 <code>read()</code> 或 <code>write()</code> 时，该线程被阻塞，直到有一些数据被读取，或数据完全写入。该线程在此期间不能再干任何事情了。</p></li><li><p><strong>NIO</strong>：(non blocking io 或 new io)异步非阻塞，NIO相对于BIO来说出现了几个核心的组件，分别是 Channle（通道） 和 Buffer（缓冲区）、Selector（选择器）  。NIO出现于JDK 1.4之后。</p><ul><li><p>Channel：NIO的所有IO操作都从Channl开始： </p><ul><li>从通道进行数据读取 ：创建一个缓冲区，然后请求通道读取数据。</li><li>从通道进行数据写入 ：创建一个缓冲区，填充数据，并要求通道写入数据。</li></ul></li><li><p>Buffer: 缓冲区的出现导致了NIO和BIO的不同：读数据时可以先读一部分到缓冲区中，然后处理其他事情；写数据时可以先写一部分到缓冲区中，然后处理其他事情。读和写操作可以不再持续，所以不会阻塞。当缓冲区满后才会将其放入真正地读&#x2F;写。</p></li></ul></li><li><p><strong>Selector</strong>：选择器可以让单个线程处理多个通道，达到复用的目的。</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h57mhubk5zj210y0u0acq.jpg" style="zoom:50%;" /></li><li><p><strong>AIO</strong>:异步非阻塞：AIO出现于JDK 1.7，是NIO的改进版。它的特点是由操作系统完成后，才通知服务器启动线程去处理。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>计算机网络知识点整理</title>
    <link href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-get和post的区别"><a href="#1-get和post的区别" class="headerlink" title="1. get和post的区别"></a>1. get和post的区别</h1><ul><li>表现形式<ul><li>get 请求的数据会附在url之后，以？形式分割URL和传输的数据，参数之间以&amp;连接。</li><li>post请求的数据是提交在HTTP的包体中。</li></ul></li><li>对数据长度的限制<ul><li>get是通过URl提交数据，所以他的长度受浏览器的限制</li><li>post是没有数据长度的限制的，起限制作用的是：服务器的处理能力。</li></ul></li><li>安全性<ul><li>与post相比，Get安全性较差。get提交数据的时候，用户名和密码都会明文的出现在URL上。因为登录页面有可能被浏览器缓存，所以其他人查看浏览器的记录，就可以拿到你的账户密码了。</li><li>post参数不会保留在浏览器历史中。</li></ul></li></ul><h1 id="2-http的常用方法"><a href="#2-http的常用方法" class="headerlink" title="2. http的常用方法"></a>2. http的常用方法</h1><ul><li>Get: 使用给定的URL请求资源</li><li>post：将数据发送到服务器，用来创建或者更新资源</li><li>head: 获取报文首部</li><li>Put: 传输数据，与post不同的是，他制定了资源的存放位置，post是由服务器自己决定。</li><li>Delete: 删除文件</li><li>trace: 追踪路径</li><li>permission：访问支持的方法。</li></ul><h1 id="3-TCP和UDP的区别与联系"><a href="#3-TCP和UDP的区别与联系" class="headerlink" title="3. TCP和UDP的区别与联系"></a>3. TCP和UDP的区别与联系</h1><ul><li><p>相同点：都是基于IP协议的传输协议。</p></li><li><p>不同点：</p><ul><li><p>TCP: 面向连接，传输速度慢，可靠性高（TCP在传输数据之前，都会通过三次握手来建立连接），保证数据的准确性，面向字节流</p></li><li><p>UDP: 面向无连接，传输速度快，可靠性低（尽最大可能交付，如果网络质量不好，就可能丢包），面向报文</p></li></ul></li><li><p>使用场景：</p><ul><li>TCP：对通信质量有要求的时候，比如：Http、https、FTP等传输文件的协议，SMTP等传输邮件的协议。kafka中服务端和客户端之间的通信。</li><li>UDP: 通信质量要求不高，但是要求网络通讯速度尽可能快，比如：QQ语音，QQ视频</li></ul></li><li><p>TCP存在拆包，粘包问题。因为他是面向字节流的，不向UDP那样首部有数据长度，而发送数据，是缓冲区满才会发送，容易造成粘包。接受数据，是缓冲区满了，才会接受，接受时也会造成粘包。</p><ul><li>解决拆包和粘包问题的方式：<ul><li>发送端给数据加首部</li><li>设置数据包为制定长度，不够用空格来补</li><li>给数据加分界标记</li></ul></li></ul></li></ul><h1 id="4-HTTP的长连接和短连接"><a href="#4-HTTP的长连接和短连接" class="headerlink" title="4. HTTP的长连接和短连接"></a>4. HTTP的长连接和短连接</h1><ul><li>http的长连接和短连接本质上就是：Tcp的长连接和短连接</li><li>在http1.0 中默认使用短连接，客户端和服务端每进行一次HTTP操作，就建立一次短连接，任务结束就中断。从HTTP1.0 起，默认使用长连接，当一个网页打开完成后，客户端和服务器之间用户传输HTTP数据的TCP连接就不会关闭，客户端再次访问这个服务器，会使用这一条已经建立的连接。可以设置这个保持时间。</li><li>通过心跳机制维护长连接，客户端发送一个心跳给服务器，服务器给客户一个心跳应答，这样双方就可以知道他们的连接没有断开。</li></ul><p><strong>应用场景：</strong></p><ul><li>长连接：多用于操作频繁，点对点的通讯。</li><li>短连接：web网站的Http服务一般都使用短连接，因为长连接比较耗费资源。</li></ul><h1 id="5-HTTP和HTTPs的区别"><a href="#5-HTTP和HTTPs的区别" class="headerlink" title="5. HTTP和HTTPs的区别"></a>5. HTTP和HTTPs的区别</h1><ul><li><p>Http明文传输，数据都是未加密的，安全性比较差，https（ssl+http）传输过程是加密的，安全性较好，采用混合加密算法。</p></li><li><p>Http使用80端口，https使用的是443端口</p></li><li><p>https协议需要到CA（Certificate Authority，数字证书认证机构）去申请证书，一般免费证书比较少，需要一定的费用。</p></li><li><p>https除了TCP连接响应外，还要进行SSL通信，所以通信速率较低且由于加密解密，也会消耗更多的服务器资源。</p><blockquote><ul><li><p>SSL是独立与TCP的协议，他也可用来对其他协议的加密</p></li><li><p>Https 其实就是在HTTP协议的基础上加了：通信加密，证书认证，报文完整性保护，他在所以HTTPS要比HTTP更加耗费资源。</p></li></ul></blockquote></li></ul><h1 id="6-加密方式"><a href="#6-加密方式" class="headerlink" title="6 加密方式"></a>6 加密方式</h1><h4 id="对称加密："><a href="#对称加密：" class="headerlink" title="对称加密："></a>对称加密：</h4><ul><li>定义：服务器和客户端都拥有一把相同的钥匙，对报文的加密和解密都用的是这把钥匙。</li><li>流程：刚开始的时候B没有钥匙，A有，那A需要将钥匙发给B，在这个过程中一旦钥匙被攻击者X获取到，加密就失了意义。</li></ul><h4 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h4><ul><li>定义：一把共有密钥，一把私有密钥。公有密钥是公开的，任何人都可以获取，私有的不公开。发送方用公有密钥进行加密，接受方用私有密钥解密。</li><li>流程：刚开始的时候A拥有一把私有密钥和一把公有公钥，B没有公钥匙，A将公钥发给B，再将通过私有密钥加密后的内容发给B，即使攻击者窃取也只能拿到公钥和加密后的明文，所以比较安全，但是性能比较低。</li></ul><h4 id="混合加密"><a href="#混合加密" class="headerlink" title="混合加密"></a>混合加密</h4><ul><li>http首先通过非对称加密来对对称密钥加密，当对称密钥安全传输后，双方则采取对称密钥的方式来进行传输。</li></ul><h1 id="7-cookie-和session-的区别和联系"><a href="#7-cookie-和session-的区别和联系" class="headerlink" title="7 cookie 和session 的区别和联系"></a>7 cookie 和session 的区别和联系</h1><ul><li>session是存储在服务器端的，cookie是存储在客户端的。</li><li>cookie不是很安全，因为别人可以分析你存放在本地的cookie进行cookie欺骗，考虑到安全应该放到session。</li><li>由于session存放在服务器上，所以当访问增多的时候，会比较占用服务器的性能，考虑到服务器性能，</li><li>session一般是通过cookie来实现会话跟踪的。第一次创建session的时候，服务器告诉客户端需要在cookie里记录一个session_id&#x3D;XX，之后客户端通过http请求来访问服务端的时候，都在请求里带上这个session_id，就可以告诉服务器我是谁了。如果客户端禁用cookie，就需要通过url重写的方式来记录，就是URL上附加一个sid&#x3D;XXX，这样服务器就知道你是谁了。</li></ul>]]></content>
    
    
    <categories>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>整理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>三次握手</title>
    <link href="/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/"/>
    <url>/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h1><ol><li><p>定义：三次握手，顾名思义，就是客户端与服务端的三次通信</p></li><li><p>流程：</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h57al19dnpj211a0u077e.jpg" style="zoom:50%;" /></li></ol><ul><li>第一次握手：建立连接。客户端发送请求连接报文段，然后客户端进入SYN_SEND（连接请求）状态，等待服务端的确认。</li><li>第二次握手：服务端收到客户端的SYN报文段，对这个报文段进行确认，同时，自己还要发送请求建立连接信息，服务端要将所有的信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务端进入SYN_RCVD（接受请求）状态。</li><li>第三次握手：客户端收到服务端的SYN+ACK报文段。向服务端发送ACK报文段，这个报文段发送完毕后，客户端和服务端都进入ESTABLISH状态，完成TCP三次握手。</li></ul><ol start="3"><li>为什么要进行三次握手？</li></ol><p>三次握手的目的就是：建立可靠的通信渠道。确认双方的发送和接收都是正常的。</p><ul><li>第一次握手：客户端什么都不能确认，服务端能确认客户端发送数据是正常的，自己接受数据正常的。</li><li>第二次握手：客户端可以确认自己：接受和发送数据都是正常的， 服务端发送数据，接受数据是正常的。</li><li>第三次握手：服务端可以确认自己发送和接受正常，客户端发送和接受正常。</li></ul><p>假设不考虑三次握手，会出现的一种情况是：</p><p>已经实效的报文段突然传送到了主机B，因而产生错误。</p><p>考虑这样一种情况：当A发送连接请求，但因连接请求报文丢失而未收到确认。于是A再重传一次。第二个报文段到达了主机B，收到了确认，建立了连接。传输完毕后，就释放连接。       </p><p>   现假定出现另一种情况：A发送的第一个请求报文段并没有丢失，而是在某些网点滞留时间太长，以致延误到这次的连接释放后才到大主机B，本来这已经是一个已经失效的报文段，但主机B收到这个报文段，却误认为主机A又发送了一次新的请求，于是向A发送确认报文段，同意建立连接。</p><p>  主机A并没有要求建立连接，因此不会理睬主机B的确认，也不会向主机B发送数据，但主机B却以为连接已经建立，并且一直等待主机A发送数据，于是主机B的许多资源就这样被浪费了。</p><p>   而如果采用了三次连接就可以防止以上现象的发生。例如在刚才的情况下，主机A不会再向主机B的确认发送确认。主机B收不到确认，就建立不了连接。</p>]]></content>
    
    
    <categories>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>TCP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>四次挥手</title>
    <link href="/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/"/>
    <url>/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h1><ol><li><p>定义：四次挥手就是客户端和服务端释放连接时的四个步骤。</p></li><li><p>产生原因：TCP连接是全双工的，因此每个方向都需要单独关闭，一方发送FIN只表示自己发完了要发送的数据。</p></li><li><p>流程：</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h578ibfbfnj20yk0qeq6p.jpg" style="zoom:50%;" /><ol><li><p>第一次挥手：当客户端不再向服务端发送数据了。客户端先向TCP发出连接释放请求，TCP通知服务端需要释放从客户端到服务端的这个连接，客户端进入FIN_WAIT-1 （终止等待状态）。</p></li><li><p>第二次挥手：服务端收到客户端的释放连接请求后，立即释放连接。这样客户端到服务端的连接就释放了，服务端进入CLOSE_WAIT（半关闭状态）。相当于客户端对服务端说：我已经发完了我要发的数据，但仍然可以接收你发的数据。</p></li><li><p>第三次挥手：当服务端不再向客户端发送数据了。服务端先向TCP发出连接释放请求，TCP通知客户端需要释放从服务端到客户端的这个连接，服务端进入LAST_WAIT（最后确认状态）。</p></li><li><p>第四次挥手：客户端收到服务端的释放请求后，进入2MSL（一个报文的来回时间）的TIME_WAIT（时间等待）状态，接着发送一个ACK给服务端，服务端进入CLOSE（关闭状态）整个连接全部释放。客户端在2MSL的TIME_WAIT后进入CLOSE状态。</p></li></ol></li></ol><p><strong>以上释放过程是4次联络，也可以看成2个2次联络。</strong></p><ol start="4"><li><p>TIME_WAIT的状态必须等待2MSL的原因？</p><ul><li><p>保证当客户端最后一个ACK丢失后，能收到服务端重传的FIN包。这个ACK报文段可能丢失，因而处于LAST_ACK状态的B可能收不到对已发送的FIN+ACK报文段的确认，服务端会超时重传这个报文段，则客户端就可以在2MSL这个时间内收到这个重传的FIN+ACK报文段。接着客户端会重传一次确认，然后启动2MSL计时器。</p></li><li><p>如果客户端在TIME_WAIT这个状态不等待一段时间，而是在发送ACK报文段后立即释放连接，那么就无法收到服务端重传的FIN+ACK报文段，因而也不会再发送一次确认报文段，B则无法按正常步骤进入CLOSED状态。（注：TIME_WAIT状态一般维持在1-4分钟）</p></li></ul></li></ol>]]></content>
    
    
    <categories>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>TCP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>动态代理的实现方式</title>
    <link href="/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/"/>
    <url>/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>User_setting 的表结构(last_visted_project_id)+ 切面(el-&gt; app -&gt;) </p><p>动态代理： c g li b+ jdk</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">InvocationHandler</span> ： 该类必须有接口<br></code></pre></td></tr></table></figure><p> c g li b：Enhancer ：是基于<strong>父子类</strong>的，被代理类（UserService）是父类，代 </p><p>理类是子类，代理对象就是代理类的实例对象</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">invoke</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Kafka 持久化</title>
    <link href="/Kafka%20%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <url>/Kafka%20%E6%8C%81%E4%B9%85%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Kafka-持久化"><a href="#1-Kafka-持久化" class="headerlink" title="1 Kafka 持久化"></a>1 Kafka 持久化</h1><ul><li>每个 Topic 将消息分成多 Partition，每个 Partition 在存储层面是 append log 文件。</li><li>任何发布到此 Partition 的消息都会被直接追加到 log 文件的尾部，每条消息在文件中的位置称为 Offest（偏移量）</li><li>Partition 是以文件的形式存储在文件系统中</li><li>log 文件根据 Broker 中的配置保留一定时间后删除来释放磁盘空间。</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228234231530.png" alt="image-20230228234231530"></p>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>消息队列</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka入门</title>
    <link href="/kafka%E5%85%A5%E9%97%A8/"/>
    <url>/kafka%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-kafka-是什么？"><a href="#1-kafka-是什么？" class="headerlink" title="1 kafka 是什么？"></a>1 kafka 是什么？</h1><p>Kafka 是一个分布式，支持分区（partition）, 多副本（replication）,基于zookeeper 的分布式消息系统。它最大的特性就是可以实时的处理大数据量。</p><p>Kafka的使用场景：</p><ul><li>日志的收集：记录各种服务的log。，通过kafka以统一接口服务的方式开放给各种 consumer，例如hadoop、Hbase、Solr等。</li><li>消息系统：解耦和生产者和消费者、缓存消息等。</li><li>用户活动跟踪：Kafka经常被用来记录web用户或者app用户的各种活动，如浏览网页、搜索、点击等活动，这些活动信息被各个服务器发布到kafka的topic中，然后订阅者通过订阅这些topic来做实时的监控分析，或者装载到hadoop、数据仓库中做离线分析和掘。</li><li>运营指标：Kafka也经常用来记录运营监控数据。包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告。</li></ul><h1 id="2-kafka-的整体设计"><a href="#2-kafka-的整体设计" class="headerlink" title="2 kafka 的整体设计"></a>2 kafka 的整体设计</h1><p>从一个较高的层面上来看，producer通过网络发送消息到Kafka集群，然后consumer来进行消费，如下图</p><blockquote><p>服务端(brokers)和客户端(producer、consumer)之间通信通过<strong>TCP协议</strong>来完成。 </p></blockquote><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231340194.png" alt="image-20230228231340194"></p><p>还有几个概念：</p><ul><li><p>Producer: 消息生产者，向Broker发送消息的客户端 。</p></li><li><p>Broker: 消息中间件处理节点，一个Kafka实例就是一个broker，一个或者多个Broker可以组成一个Kafka集群。</p></li><li><p>Topic：Kafka根据topic对消息进行归类，发布到Kafka集群的每条消息都需要指定一个topic ，类似activeMq的queue</p></li><li><p>Partition: 一个topic可以分为多个partition，每个 partition内部消息是有序的.</p></li><li><p>ConsumerGroup:每个Consumer属于一个特定的Consumer Group，一条消息可以被多个不同的Consumer Group消费，但是一个 </p><p>Consumer Group中只能有一个Consumer能够消费该消息</p></li><li><p>Consumer: 消息消费者，从Broker读取消息的客户端</p></li></ul><h1 id="3-Kafka-的基本使用"><a href="#3-Kafka-的基本使用" class="headerlink" title="3 Kafka 的基本使用"></a>3 Kafka 的基本使用</h1><ol><li><p>启动zookeeper <a href="https://pyr9.github.io/2021/09/22/zookeeper%E7%89%B9%E6%80%A7%E4%B8%8E%E8%8A%82%E7%82%B9%E4%BB%8B%E7%BB%8D/">zookeeper特性与节点介绍 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>下载并解压： <a href="https://kafka.apache.org/downloads">Apache Kafka</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cd kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件config&#x2F;server.properties，根据需要修改:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">broker.id=<span class="hljs-number">0</span>     <span class="hljs-comment">//如果是单机安装则不用修改，如果是集群安装则要保证每个broker.id配置不同的值</span><br>log.dirs=/Tools/kafka_2<span class="hljs-number">.13</span>-<span class="hljs-number">2.4</span><span class="hljs-number">.1</span>/logs    <span class="hljs-comment">//日志位置，该文件夹必须存在，否则启动时会报错</span><br>zookeeper.connect=localhost:<span class="hljs-number">2181</span>     <span class="hljs-comment">//zookeeper的连接地址，多个地址用逗号分隔</span><br></code></pre></td></tr></table></figure></li><li><p>启动服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">bin/kafka-server-start.sh -daemon  config/server.properties<br></code></pre></td></tr></table></figure><ul><li>server.properties的配置路径是一个强制的参数</li><li>­daemon表示以后台进程运行</li></ul><p><strong>我们进入zookeeper目录通过zookeeper客户端查看下zookeeper的目录树</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">2</span>] ls /<br>[admin, brokers, cluster, config, consumers, controller, controller_epoch, feature, isr_change_notification, latest_producer_id_block, log_dir_event_notification, zookeeper]<br></code></pre></td></tr></table></figure><p><strong>查看kafka节点</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">3</span>]  ls /brokers/ids<br>[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure></li><li><p>停止服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">bin/kafka‐server‐stop.sh<br></code></pre></td></tr></table></figure></li><li><p>创建主题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-topics.sh --create --topic test --bootstrap-server localhost:<span class="hljs-number">9092</span><br>Created topic test.<br></code></pre></td></tr></table></figure></li><li><p>查看kafka中目前存在的topic </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span>  bin/kafka-topics.sh --list --bootstrap-server localhost:<span class="hljs-number">9092</span><br>test<br></code></pre></td></tr></table></figure></li><li><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-console-producer.sh --topic test --bootstrap-server localhost:<span class="hljs-number">9092</span><br>&gt;my first event<br>&gt;my second event<br></code></pre></td></tr></table></figure></li><li><p>消费消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-console-consumer.sh --topic test --from-beginning --bootstrap-server localhost:<span class="hljs-number">9092</span><br><br>my first event<br>my second event<br></code></pre></td></tr></table></figure><blockquote><p>–from-beginning 可选，加上的话，就可以收到历史已经发送的数据。默认不加的话，是消费最新的消息</p></blockquote></li><li><p>单播消费</p><ul><li>一条消息只能被某一个消费者消费的模式。类似queue模式。</li><li>只需让所有消费者在同一个消费组里即可。</li></ul><p>分别在两个客户端执行如下消费命令，然后往主题里发送消息，结果只有一个客户端能收到消息 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-console-consumer.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --consumer-property group.id=group1 --topic test<br></code></pre></td></tr></table></figure></li><li><p>多播消费</p><ul><li>一条消息能被多个消费者消费的模式，类似publish-subscribe模式。</li><li>针对Kafka同一条消息只能被同一个消费组下的某一个消费者消费的特性，要实现多播只要保证这些消费者属于不同的消费组即可。</li><li>我们再增加一个消费者，该消费者属于group2消费组，结果两个客户端都能收到消息</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java'">➜  kafka_2.12-3.2.1 bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --consumer-property group.id=group2 --topic test<br></code></pre></td></tr></table></figure></li><li><p>查看消费组名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-consumer-groups.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --list<br>testGroup1<br>group2<br>group1<br></code></pre></td></tr></table></figure></li><li><p>查看消费组的消费偏移量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-consumer-groups.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --describe --group group1<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231400113.png" alt="image-20230228231400113"></p><ul><li>current-offset：当前消费组的已消费偏移量</li><li>log-end-offset：主题对应分区消息的结束偏移量(HW) </li><li>lag：当前消费组未消费的消息数</li></ul></li></ol><h1 id="4-Topic-和-partition-详解"><a href="#4-Topic-和-partition-详解" class="headerlink" title="4 Topic 和 partition 详解"></a>4 Topic 和 partition 详解</h1><ul><li><p>topic 是一个类别的名称，同类消息，发送到一个topic下，对于每一个topic可以有多个分区(partition)。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231408951.png" alt="image-20230228231408951"></p></li><li><p>partition 是一个有序的message序列，这些message将按顺序添加到commitlog文件中。一个partition 对应一个commit log 文件，对应存放在配置的log文件中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> cd /tmp/kafka-logs<br>➜  kafka-logs cd test-<span class="hljs-number">0</span><br>➜  test-<span class="hljs-number">0</span> ls<br><span class="hljs-number">00000000000000000000.</span>index     <span class="hljs-number">00000000000000000000.</span>timeindex partition.metadata<br><span class="hljs-number">00000000000000000000.</span>log       leader-epoch-checkpoint<br>➜  test-<span class="hljs-number">0</span> cat <span class="hljs-number">00000000000000000000.</span>log<br>F_:�����<span class="hljs-number">6</span>����<span class="hljs-number">6</span>�(my first eventG�����������*my second event&gt;I=;���R����R�<br></code></pre></td></tr></table></figure></li><li><p>每个partion 中的消息都有一个唯一的编号，叫做offset，用来标识这条消息。</p></li><li><p>创建多个分区的主题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-topics.sh --create --topic test2 --bootstrap-server localhost:<span class="hljs-number">9092</span> ‐‐replication‐factor <span class="hljs-number">1</span> ‐‐partitions <span class="hljs-number">2</span><br>Created topic test2.<br></code></pre></td></tr></table></figure></li></ul><h1 id="5-Kafka副本集"><a href="#5-Kafka副本集" class="headerlink" title="5 Kafka副本集"></a>5 <strong>Kafka副本集</strong></h1><ul><li>Kafka副本集是指将日志复制多份，我们知道Kafka的数据是存储在日志文件中的，这就相当于数据的备份、冗余</li><li>Kafka可以为每个Topic设置副本集，Kafka中的Topic只是个逻辑概念，实际存储数据的是Partition，所以真正被复制的也是Partition，副本集是相对于Partition来说的</li><li>一个Topic的副本集可以分布在多个Broker中，当一个Broker挂掉了，其他的Broker上还有数据，这就提高了数据的可靠性，这也是副本集的主要作用。</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231420153.png" alt="image-20230228231420153"></p><ul><li>查看下topic的情况</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-topics.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --describe --topic test2<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231430788.png" alt="image-20230228231430788"></p><ul><li>leader节点负责给定partition的所有读写请求。</li><li>replicas 表示某个partition在哪几个broker上存在备份。不管这个几点是不是”leader“，甚至这个节点挂了，也会列出。</li><li>isr**(InSyncRepli)** ：leader副本保持一定同步程度的副本（包括leader）组成ISR。是replicas的一个子集。</li></ul><h1 id="6-Kafka节点故障原因及处理方式"><a href="#6-Kafka节点故障原因及处理方式" class="headerlink" title="6 Kafka节点故障原因及处理方式"></a>6 <strong>Kafka节点故障原因及处理方式</strong></h1><p>Kafka节点（Broker）故障的两种情况：</p><ul><li>Kafka节点与Zookeeper心跳未保持视为节点故障</li><li>当follower的消息落后于leader太多也会视为节点故障</li></ul><p>Kafka对节点故障的处理方式：</p><ul><li>Kafka会对故障节点进行移除，所以基本不会因为节点故障而丢失数据</li><li>Kafka的语义担保也很大程度上避免了数据丢失</li><li>Kafka会对消息进行集群内平衡，减少消息在某些节点热度过高</li></ul>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
      <tag>消息队列</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka集群</title>
    <link href="/kafka%E9%9B%86%E7%BE%A4/"/>
    <url>/kafka%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="kafka-集群"><a href="#kafka-集群" class="headerlink" title="kafka 集群"></a>kafka 集群</h1><h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><ul><li><p>Kafka集群依赖于Zookeeper进行协调，Kafka节点只要注册到同一个Zookeeper上就代表它们是同一个集群的</p></li><li><p>Kafka通过brokerId来区分集群中的不同节点</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231625775.png" alt="image-20230228231625775"></p></li></ul><h1 id="2-Kafka集群中的几个角色："><a href="#2-Kafka集群中的几个角色：" class="headerlink" title="2 Kafka集群中的几个角色："></a>2 <strong>Kafka集群中的几个角色：</strong></h1><ul><li>Broker：一般指Kafka的部署节点</li><li>Leader：用于处理消息的接收和消费等请求，也就是说producer是将消息push到leader，而consumer也是从leader上去poll消息</li><li>Follower：主要用于备份消息数据，一个leader会有多个follower，不提供读写(主要是为了保证多副本数据与消费的一致性）。如果这个leader失效了，其中的一个follower将会自动的变成新的leader。</li></ul><h1 id="3-kafka配置中request-required-acks"><a href="#3-kafka配置中request-required-acks" class="headerlink" title="3 kafka配置中request.required.acks"></a>3 kafka配置中request.required.acks</h1><p><strong>Kafka通过配置request.required.acks属性来确认消息的生产</strong></p><ul><li>0 生产者将数据发送出去就不管了，不去等待任何返回。这种情况下数据传输效率最高，但是数据可靠性确是最低的，存在丢消息：数据还没写入leader，leader就挂了</li><li>1（默认） 数据发送到Kafka后，经过leader成功接收消息的的确认，就算是发送成功了。在这种情况下，如果leader宕机了，则会丢失数据。</li><li>-1或all producer需要等待ISR中的所有副本都确认接收到数据后才算一次发送完成，可靠性最高。当ISR中所有副本都向Leader发送ACK时，leader才commit，这时候producer才能认为一个请求中的消息都commit了。这种性能不高，一般是金融级别或者和钱打交道的时候采用。</li></ul><p><strong>避免消息丢失就可以将ack设置成-1或all</strong></p><h1 id="4-producer-的写入流程"><a href="#4-producer-的写入流程" class="headerlink" title="4 producer 的写入流程"></a>4 producer 的写入流程</h1><ol><li>producer 先从 zookeeper 的 “&#x2F;brokers&#x2F;…&#x2F;state” 节点找到该 partition 的 leader </li><li>producer 将消息发送给该 leader </li><li>leader 将消息写入本地 log </li><li>followers 从 leader pull  消息，写入本地 log 后 leader 发送 ACK </li><li>leader 收到所有 ISR 中的 replica 的 ACK 后，增加 HW（high watermark，最后 commit 的 offset） 并向 producer 发送 ACK</li></ol><h1 id="5-Partition副本选举Leader机制"><a href="#5-Partition副本选举Leader机制" class="headerlink" title="5 Partition副本选举Leader机制"></a>5 Partition副本选举Leader机制</h1><ul><li>如果有接触过其他一些分布式组件就会了解到大部分组件都是通过投票选举来在众多节点中选举出一个leader，但在Kafka中没有采用投票选举来选举leader</li><li>Kafka会动态维护一组Leader数据的副本（ISR）</li><li>Kafka会在ISR列表里挑第一个broker作为leader(第一个broker最先放进ISR列表，可能是同步数据最多的副本)</li></ul><p>Kafka有一种无奈的情况，就是ISR中副本全部宕机。对于这种情况，Kafka默认会进行unclean leader选举。Kafka提供了两种不同的方式进行处理：</p><ol><li>等待ISR中任一Replica恢复，并选它为Leader</li></ol><ul><li>等待时间较长，会降低可用性，或ISR中的所有Replica都无法恢复或者数据丢失，则该Partition将永不可用</li></ul><ol><li>选择第一个恢复的Replica为新的Leader，无论它是否在ISR中</li></ol><ul><li>并未包含所有已被之前Leader Commit过的消息，因此会造成数据丢失，但可用性较高</li></ul><h1 id="6-Controller"><a href="#6-Controller" class="headerlink" title="6 Controller"></a>6 Controller</h1><p>在kafka集群启动的时候，会自动选举一台broker作为controller，它负责管理整个集群中所有分区和副本的状态。</p><ul><li>当某个分区的leader副本出现故障时，由控制器负责为该分区<strong>选举新的leader</strong>副本。</li><li>当检测到某个分区的ISR集合发生变化时，由控制器负责<strong>通知所有broker更新其元数据信息</strong>。</li><li>当使用kafka-topics.sh脚本为某个topic<strong>增加分区数量</strong>时，同样还是由控制器负责让新分区被其他节点感知到。</li></ul><h1 id="7-Controller选举机制"><a href="#7-Controller选举机制" class="headerlink" title="7 Controller选举机制"></a>7 Controller选举机制</h1><ul><li>集群中每个broker都会尝试在zookeeper上创建一个 &#x2F;controller 临时节点</li><li>zookeeper会保证有且仅有一个broker能创建成功，这个broker就会成为集群的总控器controller</li><li>当这个controller角色的broker宕机了，此时zookeeper临时节点会消失，集群里其他broker会一直监听这个临时节点，发现临时节点消失了，就竞争再次创建临时节点</li></ul><h1 id="3-集群配置流程"><a href="#3-集群配置流程" class="headerlink" title="3 集群配置流程"></a>3 集群配置流程</h1><ol><li><p>编写配置文件</p><ul><li><p><code>vim config/server.properties</code></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">broker</span>.id=<span class="hljs-number">0</span>     //如果是单机安装则不用修改，如果是集群安装则要保证每个broker.id配置不同的值<br><span class="hljs-attribute">listeners</span>=PLAINTEXT://localhost:<span class="hljs-number">9092</span> <br><span class="hljs-attribute">log</span>.dirs=/Tools/kafka_<span class="hljs-number">2</span>.<span class="hljs-number">13</span>-<span class="hljs-number">2</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span>/logs    //日志位置，该文件夹必须存在，否则启动时会报错<br><span class="hljs-attribute">zookeeper</span>.connect=localhost:<span class="hljs-number">2181</span>     //zookeeper的连接地址，多个地址用逗号分隔<br></code></pre></td></tr></table></figure></li></ul></li><li><p>建立好其他2个broker的配置文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">cp config/server.properties config/server‐<span class="hljs-number">1.</span>properties<br>cp config/server.properties config/server‐<span class="hljs-number">2.</span>properties<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">broker</span>.id=<span class="hljs-number">1</span>     //如果是单机安装则不用修改，如果是集群安装则要保证每个broker.id配置不同的值<br><span class="hljs-attribute">listeners</span>=PLAINTEXT://localhost:<span class="hljs-number">9093</span> <br><span class="hljs-attribute">log</span>.dirs=/Tools/kafka_<span class="hljs-number">2</span>.<span class="hljs-number">13</span>-<span class="hljs-number">2</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span>/logs-<span class="hljs-number">1</span>    //日志位置，该文件夹必须存在，否则启动时会报错<br><span class="hljs-attribute">zookeeper</span>.connect=localhost:<span class="hljs-number">2181</span>     //zookeeper的连接地址，多个地址用逗号分隔<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">broker</span>.id=<span class="hljs-number">2</span>     //如果是单机安装则不用修改，如果是集群安装则要保证每个broker.id配置不同的值<br><span class="hljs-attribute">listeners</span>=PLAINTEXT://localhost:<span class="hljs-number">9094</span> <br><span class="hljs-attribute">log</span>.dirs=/Tools/kafka_<span class="hljs-number">2</span>.<span class="hljs-number">13</span>-<span class="hljs-number">2</span>.<span class="hljs-number">4</span>.<span class="hljs-number">1</span>/logs-<span class="hljs-number">2</span>    //日志位置，该文件夹必须存在，否则启动时会报错<br><span class="hljs-attribute">zookeeper</span>.connect=localhost:<span class="hljs-number">2181</span>     //zookeeper的连接地址，多个地址用逗号分隔<br></code></pre></td></tr></table></figure></li><li><p>分别启动broker实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-server-start.sh -daemon config/server.properties<br>➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-server-start.sh -daemon config/server-<span class="hljs-number">1.</span>properties<br>➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-server-start.sh -daemon config/server-<span class="hljs-number">2.</span>properties<br></code></pre></td></tr></table></figure></li><li><p>查看zookeeper确认集群节点是否都注册成功</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">19</span>]  ls /brokers/ids<br>[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure></li></ol><h2 id="集群使用"><a href="#集群使用" class="headerlink" title="集群使用"></a>集群使用</h2><ol><li><p>创建一个新的topic，副本数设置为3，分区数设置为2： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-topics.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --create --replication-factor <span class="hljs-number">3</span> --partitions <span class="hljs-number">2</span> --topic test6<br></code></pre></td></tr></table></figure></li><li><p>查看下topic的情况</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-topics.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --describe --topic test6<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231644650.png" alt="image-20230228231644650"></p></li><li><p>向新建的 test6 中发送一些message，kafka集群可以加上所有kafka节点</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">➜  kafka_2.<span class="hljs-number">12</span>-<span class="hljs-number">3.2</span>.<span class="hljs-number">1</span>  bin/kafka-console-producer.<span class="hljs-keyword">sh</span> ‐‐broker‐<span class="hljs-keyword">list</span> localhos<span class="hljs-variable">t:9092</span>,localhos<span class="hljs-variable">t:9093</span>,localhos<span class="hljs-variable">t:9094</span> --topic test6  --bootstrap-server localhos<span class="hljs-variable">t:9092</span><br>&gt;my test msg <span class="hljs-number">1</span><br>&gt;my test msg <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure></li><li><p>开始消费</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata">➜  kafka_2.12-3.2.1 bin/kafka-console-consumer.<span class="hljs-keyword">sh</span> --topic test6 --from-beginning --<span class="hljs-keyword">bootstrap</span>-server localhost:9092,localhost:9093,localhost:9094<br>my <span class="hljs-keyword">test</span> msg 1<br>my <span class="hljs-keyword">test</span> msg 2<br></code></pre></td></tr></table></figure></li><li><p>测试容错性，目前broker2 是分区0的leader，现在将他kill</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> ps -ef|grep server‐<span class="hljs-number">2.</span>properties<br>➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> kill -<span class="hljs-number">9</span> <span class="hljs-number">80024</span><br></code></pre></td></tr></table></figure></li><li><p>再次查看topic的情况</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">➜  kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.2</span><span class="hljs-number">.1</span> bin/kafka-topics.sh --bootstrap-server localhost:<span class="hljs-number">9092</span> --describe --topic test6<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231658763.png" alt="image-20230228231658763"></p><p>可以看到，此时分区0的leader变成了broker1，在isr中也已经没有了2号节点。</p></li></ol><p>  此时，依旧可以消费消息：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231708348.png" alt="image-20230228231708348"></p>]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
      <tag>集群</tag>
      
      <tag>消息队列</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之Config+Bus</title>
    <link href="/springCloud%E4%B9%8BConfig-Bus/"/>
    <url>/springCloud%E4%B9%8BConfig-Bus/</url>
    
    <content type="html"><![CDATA[<h1 id="消息总线"><a href="#消息总线" class="headerlink" title="消息总线"></a>消息总线</h1><ul><li><p>在微服务架构的系统中，通常会使用<strong>轻量级的消息代理</strong>来构建一个公用的<strong>消息主题</strong>，并让系统中的所有实例都连接上来。由于该<strong>主题的消息会被所有实例监听和消费</strong>，所以称之为消息总线。</p></li><li><p>在总线上的各个实例，都可以方便的广播一些让其他连接在给主题实例上都知道的消息。</p></li></ul><h1 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h1><ul><li><p>Spring Cloud Bus 又被称为消息总线，它能够通过轻量级的消息代理（例如 RabbitMQ、Kafka 等）将微服务架构中的各个服务连接起来，实现广播状态更改、事件推送等功能，还可以实现微服务之间的通信功能。</p></li><li><p>目前 Spring Cloud Bus 支持两种消息代理：RabbitMQ 和 Kafka。</p></li></ul><h2 id="Spring-Cloud-Bus-的基本原理"><a href="#Spring-Cloud-Bus-的基本原理" class="headerlink" title="Spring Cloud Bus 的基本原理"></a>Spring Cloud Bus 的基本原理</h2><ul><li>Spring Cloud Bus 会使用一个轻量级的消息代理来构建一个公共的消息主题 Topic（默认为“springCloudBus”），<strong>这个 Topic 中的消息会被所有服务实例监听和消费</strong>。</li><li>当其中的一个服务刷新数据时，Spring Cloud Bus 会把信息保存到 Topic 中，这样监听这个 Topic 的服务就收到消息并自动消费。</li></ul><h2 id="Spring-Cloud-Bus-动态刷新配置的原理"><a href="#Spring-Cloud-Bus-动态刷新配置的原理" class="headerlink" title="Spring Cloud Bus 动态刷新配置的原理"></a>Spring Cloud Bus 动态刷新配置的原理</h2><ul><li><p>当 Git 仓库中的配置发生了改变，我们只需要向某一个服务（既可以是 Config 服务端，也可以是 Config 客户端）发送一个 POST 请求，Spring Cloud Bus 就可以通过消息代理通知其他服务重新拉取最新配置，以实现配置的动态刷新。</p></li><li><p>利用 Spring Cloud Bus 的特殊机制可以实现很多功能，其中配合 Spring Cloud Config 实现配置的动态刷新就是最典型的应用场景之一。</p></li></ul><h2 id="Spring-Cloud-Bus-整合Spring-Cloud-Config实现配置的动态刷新"><a href="#Spring-Cloud-Bus-整合Spring-Cloud-Config实现配置的动态刷新" class="headerlink" title="Spring Cloud Bus 整合Spring Cloud Config实现配置的动态刷新"></a>Spring Cloud Bus 整合Spring Cloud Config实现配置的动态刷新</h2><ol><li>当 Git 仓库中的配置发生改变后，运维人员向 Config 服务端发送一个 POST 请求，请求路径为“&#x2F;actuator&#x2F;refresh”。</li><li>Config 服务端接收到请求后，会将该请求转发给服务总线 Spring Cloud Bus。</li><li>Spring Cloud Bus 接到消息后，会通知给所有 Config 客户端。</li><li>Config 客户端接收到通知，请求 Config 服务端拉取最新配置。</li><li>所有 Config 客户端都获取到最新的配置。</li></ol>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>SpringCloud集成consul</title>
    <link href="/SpringCloud%E9%9B%86%E6%88%90consul/"/>
    <url>/SpringCloud%E9%9B%86%E6%88%90consul/</url>
    
    <content type="html"><![CDATA[<h1 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h1><ul><li><p>Consul 是一套开源的分布式服务发现和配置管理系统，由HashCorp公司用Go语言开发</p></li><li><p>它提供了几个关键功能：</p><ul><li>服务发现：Consul client 可以提供服务，例如api或mysql，也可以使用Consul client来发现指定服务的提供者。 使用DNS或HTTP，应用程序可以轻松找到他们所依赖的服务。</li><li>健康检查：Consul client 可以提供任何数量的健康检查，或者与给定的服务（“Web服务器是否返回200 OK”），或与本地节点（“内存利用率是否低于90％”）相关联。 可以使用此信息来监控集群运行状况，服务发现组件使用此信息将流量从有问题的主机中移除出去。</li><li>KV Store：应用程序可以使用Consul的分层键&#x2F;值存储，包括动态配置，功能标记，协调，leader选举等等。 简单的HTTP API使其易于使用。</li><li>多数据中心：Consul支持多个数据中心。 这意味着Consul的用户不必担心构建额外的抽象层以扩展到多个区域。</li></ul></li><li><p>使用场景</p><p>Consul的应用场景包括服务发现、服务隔离、服务配置：</p><ul><li><p>服务发现场景中consul作为注册中心，服务地址被注册到consul中以后，可以使用consul提供的dns、http接口查询，consul支持health check。</p></li><li><p>服务隔离场景中consul支持以服务为单位设置访问策略，能同时支持经典的平台和新兴的平台，支持tls证书分发，service-to-service加密。</p></li><li><p>服务配置场景中consul提供key-value数据存储功能，并且能将变动迅速地通知出去，通过工具consul-template可以更方便地实时渲染配置文件。</p></li></ul></li></ul><h1 id="SpringCloud集成consul"><a href="#SpringCloud集成consul" class="headerlink" title="SpringCloud集成consul"></a>SpringCloud集成consul</h1><p><a href="https://www.springcloud.cc/spring-cloud-consul.html">Spring Cloud Consul 中文文档 参考手册 中文版</a></p><h2 id="1-consul-安装和启动"><a href="#1-consul-安装和启动" class="headerlink" title="1. consul 安装和启动"></a>1. consul 安装和启动</h2><p>参考<a href="https://learn.hashicorp.com/tutorials/consul/get-started-install">Install Consul | Consul - HashiCorp Learn</a></p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs q">➜  ~ consul agent -<span class="hljs-built_in">dev</span><br></code></pre></td></tr></table></figure><p>访问<a href="http://localhost:8500/">http://localhost:8500/</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232955363.png" alt="image-20230228232955363"></p><h2 id="2-引入依赖"><a href="#2-引入依赖" class="headerlink" title="2. 引入依赖"></a>2. 引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs xml">plugins&#123;<br>id &#x27;org.springframework.boot&#x27; version &#x27;2.6.1&#x27;<br>id &#x27;io.spring.dependency-management&#x27; version &#x27;1.0.8.RELEASE&#x27;<br>id &#x27;java&#x27;<br>&#125;<br><br>ext &#123;<br>set(&#x27;springCloudVersion&#x27;, &quot;2021.0.0&quot;)<br>name = &#x27;Eureka Server&#x27;<br>description = &#x27;Eureka Server demo project&#x27;<br>version=&#x27;0.0.1-SNAPSHOT&#x27;<br>sourceEncoding=&#x27;UTF-8&#x27;<br>&#125;<br><br>repositories &#123;<br>mavenCentral()<br>maven &#123; url &#x27;https://repo.spring.io/release/&#x27; &#125;<br>maven &#123; url &quot;https://repo.spring.io/libs-snapshot-local&quot; &#125;<br>maven &#123; url &quot;https://repo.spring.io/libs-milestone-local&quot; &#125;<br>maven &#123; url &quot;https://repo.spring.io/libs-release-local&quot; &#125;<br>maven &#123; url &quot;https://repo.springsource.org/plugins-release&quot; &#125;<br>&#125;<br><br>dependencyManagement &#123;<br>imports &#123;<br>mavenBom &quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;<br>&#125;<br>&#125;<br><br>dependencies &#123;<br>//consul 依赖<br>implementation &#x27;org.springframework.cloud:spring-cloud-starter-consul-discovery&#x27;<br>implementation &#x27;org.springframework.boot:spring-boot-starter-web&#x27;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-修改配置文件"><a href="#3-修改配置文件" class="headerlink" title="3.  修改配置文件"></a>3.  修改配置文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port=9091<br><br>spring.application.name= micro-weather-consul<br>spring.cloud.consul.host= localhost<br>spring.cloud.consul.port= 8500<br>spring.cloud.consul.discovery.service-name= $&#123;spring.application.name&#125;<br># 打开心跳机制<br>spring.cloud.consul.discovery.heartbeat.enabled= true<br></code></pre></td></tr></table></figure><h3 id="3-修改启动类"><a href="#3-修改启动类" class="headerlink" title="3. 修改启动类"></a>3. 修改启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h2><p>再次访问<a href="http://localhost:8500/%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0micro-weather-consul%E6%9C%8D%E5%8A%A1%E5%B7%B2%E7%BB%8F%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F">http://localhost:8500/，可以看到micro-weather-consul服务已经注册成功</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233006492.png" alt="image-20230228233006492"></p>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>注册中心</tag>
      
      <tag>consul</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之Eureka集群搭建</title>
    <link href="/springCloud%E4%B9%8BEureka%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <url>/springCloud%E4%B9%8BEureka%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="springCloud之Eureka集群搭建"><a href="#springCloud之Eureka集群搭建" class="headerlink" title="springCloud之Eureka集群搭建"></a>springCloud之Eureka集群搭建</h1><h2 id="1-搭建3个Eureka-server"><a href="#1-搭建3个Eureka-server" class="headerlink" title="1. 搭建3个Eureka server"></a>1. 搭建3个Eureka server</h2><ul><li><p>参考：<a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>三个eureka-server的application.yml文件如下：</p><ul><li><p>eureka-server</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port: 8761<br><br>eureka.instance.hostname: localhost<br>#false表示不向注册中心注册自己。<br>eureka.client.registerWithEureka: false<br> #false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务<br>eureka.client.fetchRegistry: false<br>#eureka.client.serviceUrl.defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/<br>eureka.client.serviceUrl.defaultZone: http://eureka8762.com:8762/eureka/,http://eureka8763.com:8763/eureka/<br></code></pre></td></tr></table></figure></li><li><p>eureka-server1</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port: 8762<br>spring.application.name = micro-weather-eureka-server2<br><br>eureka.instance.hostname: localhost<br>eureka.client.registerWithEureka: false<br>eureka.client.fetchRegistry: false<br>eureka.client.serviceUrl.defaultZone: http://eureka8761.com:8761/eureka/,http://eureka8763.com:8763/eureka/<br></code></pre></td></tr></table></figure></li><li><p>eureka-server2</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port: 8763<br>spring.application.name = micro-weather-eureka-server1<br><br>eureka.instance.hostname: localhost<br>eureka.client.registerWithEureka: false<br>eureka.client.fetchRegistry: false<br>eureka.client.serviceUrl.defaultZone: http://eureka8761.com:8761/eureka/,http://eureka8762.com:8762/eureka/<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="2-配置三个hostname"><a href="#2-配置三个hostname" class="headerlink" title="2.配置三个hostname"></a>2.配置三个hostname</h2><p>sudo vim &#x2F;etc&#x2F;hosts</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">127.0.0.1       eureka8761.com<br>127.0.0.1       eureka8762.com<br>127.0.0.1       eureka8763.com<br></code></pre></td></tr></table></figure><h2 id="3-启动三个eureka-server，并访问"><a href="#3-启动三个eureka-server，并访问" class="headerlink" title="3. 启动三个eureka-server，并访问"></a>3. 启动三个eureka-server，并访问</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231901993.png" alt="image-20230228231901993"></p><p>注意⚠️：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231913871.png" alt="image-20230228231913871"></p><ul><li><p>这里的意思就是这两个注册中心是当前注册中心的集群节点，当前注册中心会从这两个节点同步服务</p></li><li><p>这里是通过hostname辨别的，所以配置yml参数的时候需要配置不同的hostname。</p></li><li><p>这里有显示配置的集群节点，就证明集群配置成功了。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>eureka</tag>
      
      <tag>集群</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之集成zookeeper</title>
    <link href="/springCloud%E4%B9%8B%E9%9B%86%E6%88%90zookeeper/"/>
    <url>/springCloud%E4%B9%8B%E9%9B%86%E6%88%90zookeeper/</url>
    
    <content type="html"><![CDATA[<h1 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h1><ul><li>zookeeper基本概念：<a href="https://pyr9.github.io/2021/09/22/zookeeper%E7%89%B9%E6%80%A7%E4%B8%8E%E8%8A%82%E7%82%B9%E4%BB%8B%E7%BB%8D/">zookeeper特性与节点介绍 - 楼上有只喵 (pyr9.github.io)</a></li><li>zookeeper 是一个分布式协调服务，可以用来实现注册中心功能，类似eureka</li><li>服务节点是临时结点</li></ul><h1 id="springCloud之集成zookeeper"><a href="#springCloud之集成zookeeper" class="headerlink" title="springCloud之集成zookeeper"></a>springCloud之集成zookeeper</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>启动zookeeper</p><h2 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1.引入依赖"></a>1.引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml">plugins&#123;<br>id &#x27;org.springframework.boot&#x27; version &#x27;2.6.1&#x27;<br>id &#x27;io.spring.dependency-management&#x27; version &#x27;1.0.8.RELEASE&#x27;<br>id &#x27;java&#x27;<br>&#125;<br><br>ext &#123;<br>set(&#x27;springCloudVersion&#x27;, &quot;2021.0.0&quot;)<br>name = &#x27;Eureka Server&#x27;<br>description = &#x27;Eureka Server demo project&#x27;<br>version=&#x27;0.0.1-SNAPSHOT&#x27;<br>sourceEncoding=&#x27;UTF-8&#x27;<br>&#125;<br><br>repositories &#123;<br>mavenCentral()<br>maven &#123; url &#x27;https://repo.spring.io/release/&#x27; &#125;<br>maven &#123; url &quot;https://repo.spring.io/libs-snapshot-local&quot; &#125;<br>maven &#123; url &quot;https://repo.spring.io/libs-milestone-local&quot; &#125;<br>maven &#123; url &quot;https://repo.spring.io/libs-release-local&quot; &#125;<br>maven &#123; url &quot;https://repo.springsource.org/plugins-release&quot; &#125;<br>&#125;<br><br>dependencyManagement &#123;<br>imports &#123;<br>mavenBom &quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;<br>&#125;<br>&#125;<br><br>dependencies &#123;<br>implementation &#x27;org.springframework.cloud:spring-cloud-starter-zookeeper-discovery&#x27;<br>implementation &#x27;org.springframework.boot:spring-boot-starter-web&#x27;<br>&#125;<br><br>test&#123;<br>useJUnitPlatform()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-修改配置文件"><a href="#2-修改配置文件" class="headerlink" title="2. 修改配置文件"></a>2. 修改配置文件</h2><ul><li>配置服务的名称和zookeeper的地址</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port=9091<br><br>spring.application.name: micro-weather-zookeeper<br>spring.cloud.zookeeper.connect-string: localhost:2181<br></code></pre></td></tr></table></figure><h2 id="3-修改启动类"><a href="#3-修改启动类" class="headerlink" title="3. 修改启动类"></a>3. 修改启动类</h2><ul><li>加上@EnableDiscoveryClient注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="4-进入zookeeper客户端，查看已经注册的服务"><a href="#4-进入zookeeper客户端，查看已经注册的服务" class="headerlink" title="4.进入zookeeper客户端，查看已经注册的服务"></a>4.进入zookeeper客户端，查看已经注册的服务</h2><p>可以看到 micro-weather-zookeeper服务已经存在，SpringCloud以[Zookeeper]为注册中心整合成功</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233716687.png" alt="image-20230228233716687"></p>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>注册中心</tag>
      
      <tag>zookeeper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringCloud集成Ribbon</title>
    <link href="/SpringCloud%E9%9B%86%E6%88%90Ribbon/"/>
    <url>/SpringCloud%E9%9B%86%E6%88%90Ribbon/</url>
    
    <content type="html"><![CDATA[<h1 id="负载均衡（load-balance）"><a href="#负载均衡（load-balance）" class="headerlink" title="负载均衡（load balance）"></a>负载均衡（load balance）</h1><ul><li>简单来说负载均衡就是将客户的请求平摊到多个服务上，从而达到系统的高可用，常用的负载均衡方式有Nginx，F5</li><li>常见的负载均衡方式有两种：<ul><li>服务端负载均衡</li><li>客户端负载均衡</li></ul></li></ul><h2 id="服务端负载均衡"><a href="#服务端负载均衡" class="headerlink" title="服务端负载均衡"></a>服务端负载均衡</h2><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>服务端负载均衡是最常见的负载均衡方式，其工作原理如下图。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225113562.png" alt="image-20230228225113562"></p><ul><li>在客户端和服务端之间建立一个独立的负载均衡服务器，该服务器既可以是硬件设备（例如 F5），也可以是软件（例如 Nginx）</li><li>这个负载均衡服务器维护了一份可用服务端清单，然后通过心跳机制来删除故障的服务端节点，以保证清单中的所有服务节点都是可以正常访问的。</li><li>当客户端发送请求时，该请求不会直接发送到服务端进行处理，而是全部交给负载均衡服务器，由负载均衡服务器按照某种算法（例如轮询、随机等），从其维护的可用服务清单中选择一个服务端，然后进行转发。</li></ul><h3 id="服务端负载均衡的特点"><a href="#服务端负载均衡的特点" class="headerlink" title="服务端负载均衡的特点"></a>服务端负载均衡的特点</h3><p>服务端负载均衡具有以下特点：</p><ul><li>需要建立一个独立的负载均衡服务器。</li><li>负载均衡是在客户端发送请求后进行的，因此客户端并不知道到底是哪个服务端提供的服务。</li><li>可用服务端清单存储在负载均衡服务器上。</li></ul><h2 id="客户端负载均衡"><a href="#客户端负载均衡" class="headerlink" title="客户端负载均衡"></a>客户端负载均衡</h2><p>相较于服务端负载均衡，客户端服务是将负载均衡逻辑以代码的形式封装到客户端上</p><h3 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h3><p>客户端负载均衡的工作原理如下图。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225122260.png" alt="image-20230228225122260"></p><ul><li>客户端通过服务注册中心（例如 Eureka Server）获取到一份服务端提供的可用服务清单。</li><li>有了服务清单后，负载均衡器会在客户端发送请求前通过负载均衡算法（如简单轮训，随机连接等）选择一个服务端实例再进行访问</li><li>客户端负载均衡也需要心跳机制去维护服务端清单的有效性，这个过程需要配合服务注册中心一起完成。</li></ul><h3 id="客户端负载均衡的特点："><a href="#客户端负载均衡的特点：" class="headerlink" title="客户端负载均衡的特点："></a>客户端负载均衡的特点：</h3><ul><li><p>负载均衡器位于客户端，不需要单独搭建一个负载均衡服务器。</p></li><li><p>负载均衡是在客户端发送请求前进行的，因此客户端清楚地知道是哪个服务端提供的服务。</p></li><li><p>客户端都维护了一份可用服务清单，而这份清单都是从服务注册中心获取的。</p></li></ul><h2 id="Ribbon和Nginx实现负载均衡的区别"><a href="#Ribbon和Nginx实现负载均衡的区别" class="headerlink" title="Ribbon和Nginx实现负载均衡的区别"></a>Ribbon和Nginx实现负载均衡的区别</h2><ul><li>Ribbon 就是一个基于 HTTP 和 TCP 的客户端负载均衡器，当我们将 Ribbon 和 Eureka 一起使用时，Ribbon 会从 Eureka Server（服务注册中心）中获取服务端列表，然后通过负载均衡策略（如简单轮训，随机连接等），从服务端列表选择一个服务实例进行访问，从而达到负载均衡的目的。</li><li>而Nginx是服务端负载均衡，客户端的所有请求会交给Nginx，然后Nginx实现转发请求</li></ul><h1 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h1><ul><li>ribbon是Netflix开发的一款负载均衡的服务调用组件，具有多种负载均衡调用策略； </li><li>Ribbon 是 Spring Cloud Netflix 模块的子模块，它是 Spring Cloud 对 Netflix Ribbon 的二次封装。通过它，我们可以将面向服务的 RestTemplate请求转换为客户端负载均衡的服务调用。</li><li>简单来说，rubbon &#x3D; 负载均衡+ restTemplate</li></ul><h1 id="Ribbon-实现服务调用"><a href="#Ribbon-实现服务调用" class="headerlink" title="Ribbon 实现服务调用"></a>Ribbon 实现服务调用</h1><ol><li><p>搭建Eureka Client : <a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">implementation &#x27;org.springframework.cloud:spring-cloud-starter-netflix-ribbon&#x27;<br></code></pre></td></tr></table></figure></li><li><p>修改application.properties</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port=8085<br>spring.application.name: micro-weather-eureka-client-ribbon<br>eureka.client.serviceUrl.defaultZone: http://localhost:8761//eureka/<br></code></pre></td></tr></table></figure></li><li><p>修改启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建一个名为 RestConfiguration 的配置类，将 RestTemplate 注入到容器中，代码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.config;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.web.client.RestTemplateBuilder;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RestConfiguration</span> </span>&#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RestTemplateBuilder restTemplateBuilder;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@LoadBalanced</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> restTemplateBuilder.build();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建一个CityController来实现通过restTemplate对服务的调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-keyword">import</span> java.util.Objects;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CityController</span> </span>&#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>  <span class="hljs-comment">//面向微服务编程，即通过微服务的名称来获取调用地址</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String REST_URL_PREFIX = <span class="hljs-string">&quot;http://micro-weather-city-eureka&quot;</span>;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(REST_URL_PREFIX + <span class="hljs-string">&quot;/cities&quot;</span>, String.class);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>访问[localhost:8085&#x2F;cities，可以获取到指定服务接口的返回</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225138488.png" alt="image-20230228225138488"></p></li></ol><h1 id="Ribbon-实现负载均衡"><a href="#Ribbon-实现负载均衡" class="headerlink" title="Ribbon 实现负载均衡"></a>Ribbon 实现负载均衡</h1><p>java -jar msa-weather-city-eureka-0.0.1-SNAPSHOT.jar –server.port&#x3D;8084</p><p>java -jar msa-weather-city-eureka-0.0.1-SNAPSHOT.jar –server.port&#x3D;8083</p><p>java -jar msa-weather-city-eureka-0.0.1-SNAPSHOT.jar –server.port&#x3D;8086</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233156385.png" alt="image-20230228233156385"></p><p>再次访问<a href="http://localhost:8085/cities">localhost:8085&#x2F;cities</a></p>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>负载均衡</tag>
      
      <tag>Ribbon</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之自动扩展</title>
    <link href="/springCloud%E4%B9%8B%E8%87%AA%E5%8A%A8%E6%89%A9%E5%B1%95/"/>
    <url>/springCloud%E4%B9%8B%E8%87%AA%E5%8A%A8%E6%89%A9%E5%B1%95/</url>
    
    <content type="html"><![CDATA[<h1 id="什么是自动扩展？"><a href="#什么是自动扩展？" class="headerlink" title="什么是自动扩展？"></a>什么是自动扩展？</h1><p>自动扩展分为水平扩展和垂直扩展</p><ul><li>水平扩展就是一台机子不够了，就再搞几台</li><li>垂直扩展是硬件层面的，比如双核不够了，就4核</li></ul><h1 id="自动扩展的意义"><a href="#自动扩展的意义" class="headerlink" title="自动扩展的意义"></a>自动扩展的意义</h1><ul><li>提高了高可用性和容错能力。比如某个服务不可用了，自动扩展可以再增加一个新服务来替换他。</li><li>增加了可伸缩性。允许访问流量可以自动选择水平扩展的规模。</li><li>具有最佳使用率，并节约成本。按需使用，需要几台就部署几台</li><li>优先考虑某些服务或服务组。低优先级服务中实例移除，添加到高优先级的服务实例中。</li></ul><h1 id="自动扩展的常用方法"><a href="#自动扩展的常用方法" class="headerlink" title="自动扩展的常用方法"></a>自动扩展的常用方法</h1><ul><li>资源限制。比如Cpu使用率&gt;60%</li><li>特定时间段。指定时间去扩展</li><li>消息长度。消息队列的长度&gt; 设置的长度（此时队列里堆积的消息太多了）就去扩展</li><li>业务事件。比如新产生了10笔订单，就增加一个实例</li><li>根据预测<ul><li>历史信息</li><li>当前趋势</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>自动扩展</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之集成Hystrix</title>
    <link href="/springCloud%E4%B9%8B%E9%9B%86%E6%88%90Hystrix/"/>
    <url>/springCloud%E4%B9%8B%E9%9B%86%E6%88%90Hystrix/</url>
    
    <content type="html"><![CDATA[<h1 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h1><h2 id="什么是服务熔断？"><a href="#什么是服务熔断？" class="headerlink" title="什么是服务熔断？"></a>什么是服务熔断？</h2><ul><li><p>服务熔断就是对服务的调用执行熔断，对于后续的请求，不再调用目标服务，而是直接返回一个合理的信息，比如说请求量太大，返回一个”此时服务过载”，从而可以快速释放资源</p></li><li><p>保护系统</p></li></ul><h2 id="为什么会有这种熔断机制的出现"><a href="#为什么会有这种熔断机制的出现" class="headerlink" title="为什么会有这种熔断机制的出现?"></a>为什么会有这种熔断机制的出现?</h2><p>在微服务相互调用的时候可能会出现服务调用发生异常或调用超时,多此请求造成服务积压导致服务无法使用后接着级联导致调用此服务的消费者也出现异常或调用超时,最后导致整个系统的全部崩溃.这就是雪崩效应.</p><blockquote><p><a href="https://so.csdn.net/so/search?q=%E7%BA%A7%E8%81%94&spm=1001.2101.3001.7020">级联</a>(失败)雪崩：一个服务失败，导致整条链路的服务都失败的情形。</p></blockquote><h2 id="熔断的意义？"><a href="#熔断的意义？" class="headerlink" title="熔断的意义？"></a>熔断的意义？</h2><ul><li>让系统更加稳定</li><li>减少性能损耗<ul><li>响应很简单，所以产生的性能很小。</li><li>用户知道服务有问题了，就不再调用，避免一直重试，也可以减少性能损耗。</li></ul></li><li>及时响应。不需要其他计算，直接就可以返回一个简单的响应。</li><li>阀值可定制，比如请求到达10000，就开启熔断器</li></ul><h2 id="熔断器的功能"><a href="#熔断器的功能" class="headerlink" title="熔断器的功能"></a>熔断器的功能</h2><ul><li>异常处理。需要可以根据异常的类型，去处理异常</li><li>日志记录。记录失败的数目，才可以开启熔断</li><li>测试失败的操作。周期性的检查来测试服务是否健康。</li><li>手动复位。管理员可以强行关闭断路器，重置故障的计数器</li><li>并发。断路器可以支持大并发量</li><li>加速断路：检测出问题的速度要快，及时响应</li><li>重试失败请求：在服务可用时，可以安排重试</li></ul><h2 id="熔断和降级的区别"><a href="#熔断和降级的区别" class="headerlink" title="熔断和降级的区别"></a>熔断和降级的区别</h2><p>相同点：</p><ul><li>目的一致。通过技术手段来保护系统</li><li>表现类似：让用户体验到某些服务暂时不可用</li><li>粒度相同：都是基于服务的</li></ul><p>不同点</p><ul><li>触发条件不同<ul><li>服务熔断：服务熔断由链路上某个服务故障引起的</li><li>服务降级，整体负荷来考虑。比如：原本有一个系统可以承载100个请求，但是后面由于请求数降低，相应的服务数量也需要降低</li></ul></li><li>管理目标层级不同<ul><li>服务熔断：服务熔断是一个框架层次的处理，</li><li>服务降级：服务降级是业务层次的处理。降级一般是从外围服务开始</li></ul></li></ul><h1 id="hystrix"><a href="#hystrix" class="headerlink" title="hystrix"></a>hystrix</h1><h2 id="hystrix是什么？"><a href="#hystrix是什么？" class="headerlink" title="hystrix是什么？"></a>hystrix是什么？</h2><ul><li>Feign是Netflix开发的一款服务容错和保护组件</li></ul><h2 id="SpringCloud-集成hystrix"><a href="#SpringCloud-集成hystrix" class="headerlink" title="SpringCloud 集成hystrix"></a>SpringCloud 集成hystrix</h2><ol><li><p>搭建Eureka Client并集成Feign ：<a href="https://pyr9.github.io/2022/08/18/springCloud%E4%B9%8BFeign%E6%90%AD%E5%BB%BA/">springCloud之Feign搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>导入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-netflix-hystrix&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>启动类加上@EnableCircuitBreaker注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-meta">@EnableCircuitBreaker</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>properties修改配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port=8085<br>spring.application.name: micro-weather-eureka-client-feign-hystrix<br>eureka.client.serviceUrl.defaultZone: http://localhost:8761//eureka/<br>feign.client.config.feignName.connectTimeout: 5000<br>feign.client.config.feignName.readTimeout: 5000<br><br># 开启feign.hystrix<br>feign.hystrix.enabled=true<br></code></pre></td></tr></table></figure></li><li><p>修改CityClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;micro-weather-city-eureka&quot;, fallback = CityClientFallBack.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CityClient</span> </span>&#123;<br>  <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>  <span class="hljs-function">String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义CityClientFallBack实现CityClient</p></li></ol>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.service;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CityClientFallBack</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CityClient</span></span>&#123;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">listCity</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;City is empty!&quot;</span>;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="7"><li><p>访问<a href="http://localhost:8085/cities">localhost:8085&#x2F;cities</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232404189.png" alt="image-20230228232404189"></p></li></ol><p><strong>另一种实现方式</strong></p><ol><li><p>修改业务类，使用@HystrixCommand(fallbackMethod&#x3D;XXX)，指明熔断时调用的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.controller;<br><br><span class="hljs-keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;<br><span class="hljs-keyword">import</span> com.pyr.spring.cloud.weather.service.CityClient;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CityController</span> </span>&#123;<br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> CityClient cityClient;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>  <span class="hljs-meta">@HystrixCommand(fallbackMethod=&quot;defaultCities&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> cityClient.listCity();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">defaultCities</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Micro weather city eureka is down!&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><ul><li><p>CityClient不需要修改</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.service;<br><br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-meta">@FeignClient(name=&quot;micro-weather-city-eureka&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CityClient</span> </span>&#123;<br>  <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>  <span class="hljs-function">String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><ol start="5"><li><p>停止micro-weather-city-eureka服务，访问<a href="http://localhost:8085/cities">localhost:8085&#x2F;cities</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232412332.png" alt="image-20230228232412332"></p></li></ol><p>注：这种方式不需要添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">feign.hystrix.enabled=<span class="hljs-keyword">true</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>服务熔断</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud网关</title>
    <link href="/springCloud%E7%BD%91%E5%85%B3/"/>
    <url>/springCloud%E7%BD%91%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<h1 id="1-网关是什么"><a href="#1-网关是什么" class="headerlink" title="1.网关是什么"></a>1.网关是什么</h1><h2 id="1-1-网关产生的原因？"><a href="#1-1-网关产生的原因？" class="headerlink" title="1.1 网关产生的原因？"></a>1.1 网关产生的原因？</h2><ol><li><p>在微服务架构中，一个系统往往由多个微服务组成，而这些服务可能部署在不同机房、不同地区、不同域名下。这种情况下，客户端想要直接请求这些服务，就需要知道它们具体的地址信息，例如 IP 地址、端口号等。这种客户端直接请求服务的方式存在以下问题：</p><ul><li><p>当服务数量众多时，客户端需要维护大量的服务地址，这对于客户端来说，是非常繁琐复杂的。</p></li><li><p>在某些场景下可能会存在跨域请求的问题。</p></li><li><p>身份认证的难度大，每个微服务需要独立认证。</p></li></ul></li><li><p>在微服务架构中，每个服务都有对外提供服务的地址和端口，都有一些<strong>共同的功能</strong>，比如：<strong>权限校验、日志记录、限流、熔断、监控</strong>等等。如果任由每个服务独立对外提供接口。<strong>协调管理这些接口</strong>就会变得非常麻烦， 且会<strong>造成代码的重复</strong>。</p></li></ol><h2 id="1-2-网关是什么？"><a href="#1-2-网关是什么？" class="headerlink" title="1.2 网关是什么？"></a>1.2 网关是什么？</h2><p>API 网关是一个<strong>搭建在客户端和微服务之间的服务</strong>。</p><ul><li><p>API 网关就像整个微服务系统的门面一样，是系统对外的唯一入口。有了它，客户端会先将请求发送到 API 网关，然后由 API 网关根据请求的标识信息将请求转发到微服务实例。</p></li><li><p>我们可以在 API 网关中处理一些非业务功能的逻辑，例如权限验证、监控、缓存、请求路由等。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232252488.png" alt="image-20230228232252488"></p></li></ul><h2 id="1-3-网关的优点和缺点"><a href="#1-3-网关的优点和缺点" class="headerlink" title="1.3 网关的优点和缺点"></a>1.3 网关的优点和缺点</h2><p><strong>优点：</strong></p><ul><li>集合多个API</li><li>统一API入口，客户端通过 API 网关与微服务交互时，客户端只需要知道 API 网关地址即可，而不需要维护大量的服务地址，简化了客户端的开发。</li><li>客户端直接与 API 网关通信，能够减少客户端与各个服务的交互次数。</li><li>API 网关还提供了安全、流控、过滤、缓存、计费以及监控等 API 管理功能。</li></ul><p><strong>缺点：</strong></p><ul><li>在架构上需要考虑更多的管理，比如哪些API放在哪个网关上</li><li>路由上需要进行统一的配置</li><li>可能引发单点故障，API是一个独立的入口，很容易出现高并发，设计不好，如果API网管不可用，整个系统不可用</li></ul><h2 id="1-4-API网关的实现方式"><a href="#1-4-API网关的实现方式" class="headerlink" title="1.4 API网关的实现方式"></a>1.4 API网关的实现方式</h2><ul><li>Spring Cloud Gateway</li><li>pring Cloud Netflix Zuul</li><li>Nginx</li><li>Traefik</li><li>Kong: 底层也是基于ngin x</li></ul><h1 id="2-Zuul"><a href="#2-Zuul" class="headerlink" title="2 Zuul"></a>2 Zuul</h1><p>Zuul 是Netflix开发的一款API网关组件。</p><p>优点：</p><ol><li>成熟稳定：Zuul 是 Netflix 开源的项目，已经在大规模生产环境中被验证过。</li><li>社区支持：拥有成熟的社区，有大量的文档和案例可供参考。</li><li>易于上手：相对较简单，易于配置和使用。</li></ol><p>缺点：</p><ol><li>阻塞式 I&#x2F;O：Zuul 使用阻塞式 I&#x2F;O，每个请求都会占用一个线程，可能会导致线程资源耗尽。</li><li>动态路由困难：Zuul 在运行时动态更新路由规则比较困难，需要重启服务。</li><li>不支持响应式编程：Zuul 1.x 不支持响应式编程模型，无法充分利用异步和非阻塞的特性。</li></ol><h2 id="2-1-SpringCloud-集成Zuul"><a href="#2-1-SpringCloud-集成Zuul" class="headerlink" title="2.1 SpringCloud 集成Zuul"></a>2.1 SpringCloud 集成Zuul</h2><ol><li><p>搭建Eureka Client : <a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>引入依赖</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-netflix-zuul&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>注：springCloud 版本过高，会存在zuul无法引入的问题，所以本地，将SpringCloud版本降低了，相应的SpringBoot版本也降低了</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">plugins&#123;<br>id <span class="hljs-string">&#x27;org.springframework.boot&#x27;</span> version <span class="hljs-string">&#x27;2.2.0.RELEASE&#x27;</span><br>&#125;<br>ext &#123;<br>set(<span class="hljs-string">&#x27;springCloudVersion&#x27;</span>, <span class="hljs-string">&quot;Hoxton.SR12&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>properties修改配置</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port=9090<br>spring.application.name: micro-weather-eureka-client-zuul<br>eureka.client.serviceUrl.defaultZone: http://localhost:8761//eureka/<br><br># 可配置多对路由<br>zuul.routes.demo.path: /demo/**<br>zuul.routes.demo.serviceId: micro-weather-eureka-client<br><br>#zuul.routes.city.path: /city/**<br>#zuul.routes.city.serviceId: msa-weather-city-eureka<br><br>#zuul.routes.data.path: /data/**<br>#zuul.routes.data.serviceId: msa-weather-data-eureka<br></code></pre></td></tr></table></figure><ol start="4"><li>启动类加入注解@EnableZuulProxy</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableZuulProxy</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>访问<a href="http://localhost:9090/demo/hello">localhost:9090&#x2F;demo&#x2F;hello</a>，得到micro-weather-eureka-client 服务的数据</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232304736.png" alt="image-20230228232304736"></p><h1 id="3-Spring-Cloud-Gateway"><a href="#3-Spring-Cloud-Gateway" class="headerlink" title="3 Spring Cloud Gateway"></a>3 Spring Cloud Gateway</h1><p>在Zulu2 中，zuul的技术方案一直在跳票，spring cloud 自己开发了一个网关Spring Cloud Gateway，用来取代Zuul网关。</p><ul><li><p><strong>响应式编程支持</strong>：Spring Cloud Gateway 是基于 WebFlux 框架实现的，而 WebFlux 框架底层则使用了通信框架 Netty。这意味着它能够更高效地处理大量并发请求，而不会出现线程阻塞和资源浪费的问题。（Netty 使用了 Java NIO 提供的非阻塞 I&#x2F;O 模型，能够处理大量并发的连接和请求，并且不会阻塞线程，提高了系统的并发处理能力和性能。）</p></li><li><p><strong>Spring Cloud 生态集成</strong>：作为 Spring Cloud 生态系统的一部分，Spring Cloud Gateway 与其他 Spring Cloud 组件（如 Eureka、Consul、Ribbon 等）有着良好的集成，可以方便地构建和管理微服务架构。</p></li></ul><h2 id="3-1-Spring-Cloud-Gateway-核心概念"><a href="#3-1-Spring-Cloud-Gateway-核心概念" class="headerlink" title="3.1 Spring Cloud Gateway 核心概念"></a>3.1 Spring Cloud Gateway 核心概念</h2><ul><li>Route（路由）： 网关最基本的模块。它由一个 ID、一个目标 URI、一组断言（Predicate）和一组过滤器（Filter）组成。</li><li>Predicate（断言）:路由转发的判断条件，我们可以通过 Predicate 对 HTTP 请求进行匹配，例如请求方式、请求路径、请求头、参数等，<strong>如果请求与断言匹配成功，则将请求转发到相应的服务。</strong></li><li>Filter（过滤器）:过滤器，使用过滤器，我们可以对请求进行拦截和修改，还可以使用它对上文的响应进行再处理。</li></ul><p><strong>注意：其中 Route 和 Predicate 必须同时声明。</strong></p><p>使用了一个RouteLocatorBuilder的bean去创建路由，除了创建路由 RouteLocatorBuilder可以让你添加各种predicates和filters，predicates断言 的意思，顾名思义就是根据具体的请求的规则，由具体的route去处理，filters 是各种过滤器，用来对请求做各种判断和修改。</p><h2 id="3-2-Spring-Cloud-Gateway-特性"><a href="#3-2-Spring-Cloud-Gateway-特性" class="headerlink" title="3.2 Spring Cloud Gateway 特性"></a>3.2 Spring Cloud Gateway 特性</h2><ul><li>基于 Spring Framework 5、Project Reactor 和 Spring Boot 2.0 构建。</li><li>能够在任意请求属性上匹配路由。</li><li>predicates（断言） 和 filters（过滤器）是特定于路由的。</li><li>集成了 Hystrix 熔断器。</li><li>集成了 Spring Cloud DiscoveryClient（服务发现客户端）。</li><li>易于编写断言和过滤器。</li><li>能够限制请求频率。</li><li>能够重写请求路径。</li></ul><h2 id="3-3-Gateway-的工作流程"><a href="#3-3-Gateway-的工作流程" class="headerlink" title="3.3 Gateway 的工作流程"></a>3.3 Gateway 的工作流程</h2><p><strong>核心逻辑：路由转发+执行过滤器</strong></p><ol><li><p>客户端将请求发送到 Spring Cloud Gateway 上。</p></li><li><p>Spring Cloud Gateway 通过 Gateway Handler Mapping 找到与请求相匹配的路由，将其发送给 Gateway Web Handler。</p></li><li><p>Gateway Web Handler 通过指定的过滤器链（Filter Chain），将请求转发到实际的服务节点中，执行业务逻辑返回响应结果。</p></li><li><p>过滤器之间用虚线分开是因为过滤器可能会在转发请求之前（pre）或之后（post）执行业务逻辑。</p></li><li><p>过滤器（Filter）可以在请求被转发到服务端前，对请求进行拦截和修改，例如参数校验、权限校验、流量监控、日志输出以及协议转换等。</p></li><li><p>过滤器可以在响应返回客户端之前，对响应进行拦截和再处理，例如修改响应内容或响应头、日志输出、流量监控等。</p></li><li><p>响应原路返回给客户端。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224346059.png" alt="image-20230228224346059"></p></li></ol><h2 id="3-4-Spring-Cloud-Gateway-动态路由"><a href="#3-4-Spring-Cloud-Gateway-动态路由" class="headerlink" title="3.4 Spring Cloud Gateway 动态路由"></a>3.4 Spring Cloud Gateway 动态路由</h2><p>默认情况下，Spring Cloud Gateway 会根据服务注册中心（例如 Eureka Server）中维护的服务列表，以服务名（spring.application.name）作为路径创建动态路由进行转发，从而实现动态路由功能。</p><p>我们可以在配置文件中，将 Route 的 uri 地址修改为以下形式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">lb:<span class="hljs-comment">//service-name</span><br></code></pre></td></tr></table></figure><p>以上配置说明如下：</p><ul><li>lb：uri 的协议，表示开启 Spring Cloud Gateway 的负载均衡功能。</li><li>service-name：服务名，Spring Cloud Gateway 会根据它获取到具体的微服务地址。</li></ul><h2 id="3-5-SpringCloud-使用GateWay"><a href="#3-5-SpringCloud-使用GateWay" class="headerlink" title="3.5 SpringCloud 使用GateWay"></a>3.5 SpringCloud 使用GateWay</h2><ol><li><p>搭建Eureka Client : <a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>引入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-gateway&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>修改application.yml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml">server:<br>  port: 9090<br>spring:<br>  application:<br>    name: micro-weather-eureka-client-gateway<br>  cloud:<br>    gateway: #网关路由配置<br>      routes:<br>        #将 micro-service-cloud-provider-dept-8001 提供的服务隐藏起来，不暴露给客户端，只给客户端暴露 API 网关的地址 9527<br>        - id: micro_weather_eureka_client_path #路由 id,没有固定规则，但唯一，建议与服务名对应<br>          uri: http://localhost:9091         #匹配后提供服务的路由地址<br>          predicates:<br>            #以下是断言条件，必选全部符合条件<br>            - Path=/test/**               #断言，路径匹配 注意：Path 中 P 为大写<br>            - Method=GET #只能时 GET 请求时，才能访问<br>eureka:<br>  client:<br>    fetch-registry: true<br>    register-with-eureka: true<br>    service-url:<br>      defaultZone: http://localhost:8761//eureka/<br></code></pre></td></tr></table></figure></li><li><p>修改启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>可以看到根据路由匹配，通过<a href="http://localhost:9090/%E8%AE%BF%E9%97%AE%E5%88%B0%E4%BA%86http://localhost:9091/%E7%9A%84%E6%8E%A5%E5%8F%A3">http://localhost:9090/访问到了http://localhost:9091/的接口</a></p><ul><li>访问<a href="http://localhost:9091/test/%E5%BC%A0%E4%B8%89">localhost:9091&#x2F;test&#x2F;张三</a></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224437860.png" alt="image-20230228224437860"></p><ul><li>访问<a href="http://localhost:9090/test/%E5%BC%A0%E4%B8%89">localhost:9090&#x2F;test&#x2F;张三</a></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224445551.png" alt="image-20230228224445551"></p></li></ol><p><strong>Spring Cloud Gateway 动态路由</strong></p><p>修改application.yml 的配置，使用注册中心中的微服务名创建动态路由进行转发</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224403815.png" alt="image-20230228224403815"></p><h1 id="4-zuul和spring-cloudgateway比较"><a href="#4-zuul和spring-cloudgateway比较" class="headerlink" title="4 zuul和spring cloudgateway比较"></a>4 zuul和spring cloudgateway比较</h1><table><thead><tr><th></th><th>Gateway</th><th>Zuul1</th><th>Zuul2</th></tr></thead><tbody><tr><td>靠谱性</td><td>spring cloud官方支持</td><td>曾经靠谱</td><td>专业放鸽子</td></tr><tr><td>性能</td><td>Netty</td><td>同步阻塞，性能慢</td><td>Netty</td></tr><tr><td>RPS</td><td>&gt;32000</td><td>20000左右</td><td>25000左右</td></tr><tr><td>spring cloud</td><td>已整合</td><td>已整合</td><td>暂无整合计划</td></tr><tr><td>长链接</td><td>支持</td><td>不支持</td><td>支持</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之集成Feign</title>
    <link href="/springCloud%E4%B9%8BFeign%E6%90%AD%E5%BB%BA/"/>
    <url>/springCloud%E4%B9%8BFeign%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Feign是什么？"><a href="#Feign是什么？" class="headerlink" title="Feign是什么？"></a>Feign是什么？</h1><ul><li>Feign是Netflix开发的一款声明式服务调用组件</li><li>Feign可以帮助我们更快捷、优雅地调用HTTP API。</li><li>Feign 是 Spring Cloud Netflix 模块的子模块，它是 Spring Cloud 对 Netflix Feign 的二次封装，主要负责 Spring Cloud 的服务调用功能。</li></ul><h1 id="SpringCloud-集成Feign"><a href="#SpringCloud-集成Feign" class="headerlink" title="SpringCloud 集成Feign"></a>SpringCloud 集成Feign</h1><ol><li><p>搭建Eureka Client : <a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>引入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-openfeign&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>修改application.properties</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port=8085<br>spring.application.name: micro-weather-eureka-client-feign<br>eureka.client.serviceUrl.defaultZone: http://localhost:8761//eureka/<br># 连接的超时时间<br>feign.client.config.feignName.connectTimeout: 5000<br># 读数据的超时时间<br>feign.client.config.feignName.readTimeout: 5000<br></code></pre></td></tr></table></figure></li><li><p>创建一个接口，用FeignClient注解，指明需要调用的服务名和rest接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;micro-weather-city-eureka&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CityClient</span> </span>&#123;<br>  <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>  <span class="hljs-function">String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br>   <br>   <span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br>   <span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br>   <span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br>   <span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;<br>   <br>   <span class="hljs-meta">@SpringBootApplication</span><br>   <span class="hljs-meta">@EnableDiscoveryClient</span><br>   <span class="hljs-meta">@EnableFeignClients</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>   <br>     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>       SpringApplication.run(Application.class, args);<br>     &#125;<br>   &#125;<br>   <br><br><span class="hljs-number">6.</span> 创建一个RestClientController来实现对Feign客户端的调用<br><br>   ```java<br>   <span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.controller;<br>   <br>   <span class="hljs-keyword">import</span> com.pyr.spring.cloud.weather.service.CityClient;<br>   <span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br>   <span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br>   <span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br>   <br>   <span class="hljs-meta">@RestController</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CityController</span> </span>&#123;<br>     <span class="hljs-meta">@Autowired</span><br>     <span class="hljs-keyword">private</span> CityClient cityClient;<br>   <br>     <span class="hljs-meta">@RequestMapping(&quot;/cities&quot;)</span><br>     <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">listCity</span><span class="hljs-params">()</span></span>&#123;<br>       <span class="hljs-keyword">return</span> cityClient.listCity();<br>     &#125;<br>   &#125;<br></code></pre></td></tr></table></figure></li><li><p>查看euraka服务端，可以看到该客户端注册成功，访问[localhost:8085&#x2F;cities，可以获取到指定服务接口的返回</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232728757.png" alt="image-20230228232728757"></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之集成SpringCloud Config</title>
    <link href="/springCloud%E4%B9%8B%E9%9B%86%E6%88%90SpringCloud-Config/"/>
    <url>/springCloud%E4%B9%8B%E9%9B%86%E6%88%90SpringCloud-Config/</url>
    
    <content type="html"><![CDATA[<h1 id="集中化配置"><a href="#集中化配置" class="headerlink" title="集中化配置"></a>集中化配置</h1><h2 id="什么场景会用到配置"><a href="#什么场景会用到配置" class="headerlink" title="什么场景会用到配置"></a>什么场景会用到配置</h2><ul><li>想到某一个地方去读取文件</li><li>Application.yml&#x2F; bootstrap.yml</li><li>环境变量： 比如启动参数</li><li>数据库存储（系统变量）</li></ul><h2 id="为什么要集中化配置？"><a href="#为什么要集中化配置？" class="headerlink" title="为什么要集中化配置？"></a>为什么要集中化配置？</h2><ul><li>微服务数量多，配置多</li><li>没有版本控制（尤其数据库的系统变量）</li><li>分布零散：有的配置在代码里，有的在yml配置文件，有的在数据库</li><li>基于静态的配置：每次修改都需要重新发布</li><li>手工管理配置繁琐</li></ul><h2 id="配置分类"><a href="#配置分类" class="headerlink" title="配置分类"></a>配置分类</h2><p>按照动态静态区分</p><ul><li>静态：<ul><li>环境配置：数据库连接串，eureka注册中心，kāfka连接，应用名称</li><li>安全配置：连接密码，公钥私钥，http连接的证书</li></ul></li><li>动态：<ul><li>应用参数：白名单，缓存过期时间，日志级别</li><li>业务相关：隐私协议内容，动态文案</li><li>功能开关：灰度发布，功能开关</li></ul></li></ul><h2 id="配置中心的要求"><a href="#配置中心的要求" class="headerlink" title="配置中心的要求"></a>配置中心的要求</h2><ul><li><p>版本管理：可以看到修改记录</p></li><li><p>权限控制：某些人可改某些配置</p></li><li><p>配置业务分离：对配置单独进行管理</p></li><li><p>业务需求：动态推送变更，内容加密</p></li><li><p>高可用</p></li><li><p>面向可配置的编码：避免硬编码，设置常量，运行时可读取</p></li><li><p>个理性：生产环境的配置和测试环境配置不一样</p></li><li><p>一致性：相同部署环境下，应该配置相同</p></li><li><p>集中化配置：分布式环境下，应用的配置应该具备可以管理性，提供远程管理的能力。</p></li></ul><h1 id="SpringCloud-Config"><a href="#SpringCloud-Config" class="headerlink" title="SpringCloud Config"></a>SpringCloud Config</h1><h2 id="springCloud-config-是什么？"><a href="#springCloud-config-是什么？" class="headerlink" title="springCloud config 是什么？"></a>springCloud config 是什么？</h2><ul><li>Spring Cloud Config 是由 Spring Cloud 团队开发的项目，它可以为微服务架构中各个微服务提供集中化的外部配置支持。</li><li>Spring Cloud Config 可以将各个微服务的配置文件集中存储在一个外部的存储仓库或系统（例如 Git 、SVN 等）中，对配置的统一管理，以支持各个微服务的运行。</li><li>Spring Cloud Config 包含以下两个部分：<ul><li>Config Server：也被称为分布式配置中心，它是一个独立运行的微服务应用，用来连接配置仓库并为客户端提供获取配置信息、加密信息和解密信息的访问接口。</li><li>Config Client：指的是微服务架构中的各个微服务，它们通过 Config Server 对配置进行管理，并从 Config Sever 中获取和加载配置信息。</li></ul></li></ul><h2 id="搭建-Config-服务端"><a href="#搭建-Config-服务端" class="headerlink" title="搭建 Config 服务端"></a>搭建 Config 服务端</h2><ol><li><p>搭建Eureka Client : <a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>github或者码云上创建一个仓库存储配置信息，github国内不是很稳定，我用了码云</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232125832.png" alt="image-20230228232125832"></p></li><li><p>在config-repo路径下，编写配置文件config-dev.yml</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232134545.png" alt="image-20230228232134545"></p></li><li><p>引入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-config-server&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>properties修改配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">server.port=<span class="hljs-number">8888</span><br>spring.application.name: micro-weather-eureka-server-config<br>eureka.client.serviceUrl.defaultZone: http:<span class="hljs-comment">//localhost:8761//eureka/</span><br><br># git 地址，用来存储配置文件<br>spring.cloud.config.server.git.uri=https:<span class="hljs-comment">//gitee.com/panyuro/spring-cloud-microservice-config.git</span><br><br>#存储配置文件的目录<br>spring.cloud.config.server.git.searchPaths=config-repo<br></code></pre></td></tr></table></figure></li><li><p>启动类加入注解@EnableConfigServer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableConfigServer</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>启动项目，访问<a href="http://localhost:8888/config-dev.yml">localhost:8888&#x2F;config-dev.yml</a>，我们可以看到8888微服务可以成功的读取到远端的配置文件。如下图：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232147874.png" alt="image-20230228232147874"></p></li></ol><p>访问<a href="http://localhost:8888/config/dev/master">localhost:8888&#x2F;config&#x2F;dev&#x2F;master</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232155081.png" alt="image-20230228232155081"></p><h2 id="搭建-Config客户端"><a href="#搭建-Config客户端" class="headerlink" title="搭建 Config客户端"></a>搭建 Config客户端</h2><ol><li><p>搭建Eureka Client : <a href="https://pyr9.github.io/2022/08/17/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/">springCloud之Eureka搭建 - 楼上有只喵 (pyr9.github.io)</a></p></li><li><p>引入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-config-client&#x27;</span><br></code></pre></td></tr></table></figure><p>springcloud 版本较高，无法成功启动项目的时候，需要再引入starter-bootstrap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-bootstrap&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>properties修改配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">server.port=<span class="hljs-number">9091</span><br>spring.application.name: micro-weather-config-client<br>eureka.client.serviceUrl.defaultZone: http:<span class="hljs-comment">//localhost:8761//eureka/</span><br><br>spring.cloud.config.profile=dev<br>spring.cloud.config.uri=http:<span class="hljs-comment">//localhost:8888/</span><br>spring.cloud.config.name=config<br></code></pre></td></tr></table></figure></li><li><p>编写测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigController</span> </span>&#123;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String info;<br><br>  <span class="hljs-meta">@Value(&quot;$&#123;config.version&#125;&quot;)</span><br>  <span class="hljs-keyword">private</span> String version;<br><br>  <span class="hljs-meta">@GetMapping(&quot;/config&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">config</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;info: &quot;</span>+info+<span class="hljs-string">&quot; version: &quot;</span>+version;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试，访问<a href="http://localhost:9091/config">localhost:9091&#x2F;config</a>，可以查询到正确的配置</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232205076.png" alt="image-20230228232205076"></p></li></ol><h1 id="Config客户端之动态刷新"><a href="#Config客户端之动态刷新" class="headerlink" title="Config客户端之动态刷新"></a>Config客户端之动态刷新</h1><p>避免每次修改githib上的配置都需要重启客户端</p><h2 id="手动版"><a href="#手动版" class="headerlink" title="手动版"></a>手动版</h2><p>优点：解决了重启 Config 客户端才能获取最新配置的问题，</p><p>缺点：只要配置仓库中的配置发生改变，就需要我们挨个向 Config 客户端手动发送 POST 请求，通知它们重新拉取配置。</p><p>那么有没有“一次通知，处处生效”的方式呢？答案是肯定的。Spring Cloud Config 配合 Bus 就可以实现配置的动态刷新。</p>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式</tag>
      
      <tag>集中化配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springCloud之Eureka搭建</title>
    <link href="/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/"/>
    <url>/springCloud%E4%B9%8BEureka%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Eureka是什么？"><a href="#Eureka是什么？" class="headerlink" title="Eureka是什么？"></a>Eureka是什么？</h1><ul><li>Eureka是 Netflix 公司开发的一款开源的服务注册与发现组件。</li><li>Spring Cloud 将 Eureka 与 Netflix 中的其他开源服务组件（例如 Ribbon、Feign 以及 Hystrix 等）一起整合进 Spring Cloud Netflix 模块中，整合后的组件全称为 Spring Cloud Netflix Eureka。</li><li>Eureka 是 Spring Cloud Netflix 模块的子模块，它是 Spring Cloud 对 Netflix Eureka 的二次封装，主要负责 Spring Cloud 的服务注册与发现功能。</li></ul><h1 id="Eureka-两大组件"><a href="#Eureka-两大组件" class="headerlink" title="Eureka 两大组件"></a>Eureka 两大组件</h1><p>Eureka 采用 CS（Client&#x2F;Server，客户端&#x2F;服务器） 架构，它包括以下两大组件：</p><ul><li><p><strong>Eureka Server</strong>：Eureka 服务注册中心，主要用于提供服务注册功能。当微服务启动时，会将自己的服务注册到 Eureka Server。Eureka Server 维护了一个可用服务列表，存储了所有注册到 Eureka Server 的可用服务的信息，这些可用服务可以在 Eureka Server 的管理界面中直观看到。</p></li><li><p><strong>Eureka Client</strong>：Eureka 客户端，通常指的是微服务系统中各个微服务，主要用于和 Eureka Server 进行交互。在微服务应用启动后，Eureka Client 会向 Eureka Server 发送心跳（默认周期为 30 秒）。若 Eureka Server 在多个心跳周期内没有接收到某个 Eureka Client 的心跳，Eureka Server 将它从可用服务列表中移除（默认 90 秒</p></li></ul><h1 id="Eureka-自我保护机制"><a href="#Eureka-自我保护机制" class="headerlink" title="Eureka 自我保护机制"></a>Eureka 自我保护机制</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li>默认情况下,EurekaClient会定时向EurekaServer端发送心跳，如果EurekaServer在一定时间内没有收到EurekaClient发送的心跳，便会把该实例从注册服务列表中剔除（默认是90秒)</li><li>但是在短时间内丢失大量的实例心跳，这时候EurekaServer会开启自我保护机制，<a href="https://so.csdn.net/so/search?q=Eureka&spm=1001.2101.3001.7020">Eureka</a>不会踢出该服务，而是会对该服务的信息进行保存。</li><li>Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上 (即保证当前节点依然可用)</li><li>当网络稳定时，当前实例新的注册信息会被同步到其他节点中</li></ul><h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><p>为了防止EurekaClient正常运行，但是与EurekaServer网络不通（延迟、拥堵、卡顿）的情况下，EurekaServer不会对EurekaClient服务进行剔除，因为微服务本身是建康的，此时不应该注销这个微服务。</p><h2 id="何时使用"><a href="#何时使用" class="headerlink" title="何时使用"></a>何时使用</h2><p>本地环境建议禁止自我保护，生产环境建议开启自我保护。</p><h2 id="eureka停止更新了"><a href="#eureka停止更新了" class="headerlink" title="eureka停止更新了"></a>eureka停止更新了</h2><p><a href="https://github.com/Netflix/eureka/wiki">Home · Netflix&#x2F;eureka Wiki (github.com)</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232003650.png" alt="image-20230228232003650"></p><h1 id="Eureka-Server搭建"><a href="#Eureka-Server搭建" class="headerlink" title="Eureka Server搭建"></a>Eureka Server搭建</h1><p>参考<a href="https://github.com/spring-cloud-samples/eureka">GitHub - spring-cloud-samples&#x2F;eureka</a></p><ul><li><p>Step1: 新建一个springBoot项目</p></li><li><p>Step2: 修改依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">plugins&#123;<br>id <span class="hljs-string">&#x27;org.springframework.boot&#x27;</span> version <span class="hljs-string">&#x27;2.6.1&#x27;</span><br>id <span class="hljs-string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="hljs-string">&#x27;1.0.8.RELEASE&#x27;</span><br>id <span class="hljs-string">&#x27;java&#x27;</span><br>&#125;<br><br>ext &#123;<br>set(<span class="hljs-string">&#x27;springCloudVersion&#x27;</span>, <span class="hljs-string">&quot;2021.0.0&quot;</span>)<br>name = <span class="hljs-string">&#x27;Eureka Server&#x27;</span><br>description = <span class="hljs-string">&#x27;Eureka Server demo project&#x27;</span><br>version=<span class="hljs-string">&#x27;0.0.1-SNAPSHOT&#x27;</span><br>sourceEncoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span><br>&#125;<br><br>repositories &#123;<br>mavenCentral()<br>maven &#123; url <span class="hljs-string">&#x27;https://repo.spring.io/release/&#x27;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.spring.io/libs-snapshot-local&quot;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.spring.io/libs-milestone-local&quot;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.spring.io/libs-release-local&quot;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.springsource.org/plugins-release&quot;</span> &#125;<br>&#125;<br><br>dependencyManagement &#123;<br>imports &#123;<br>mavenBom <span class="hljs-string">&quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;</span><br>&#125;<br>&#125;<br><br>dependencies &#123;<br>implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-netflix-eureka-server&#x27;</span><br>testImplementation <span class="hljs-string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Step3: application配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml">server.port: 8761<br><br>eureka.instance.hostname: localhost<br>#eureka可以同时作为服务端和客户端，这里禁用掉他客户端的能力<br>eureka.client.registerWithEureka: false<br>eureka.client.fetchRegistry: false<br>eureka.client.serviceUrl.defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/<br><br>#关闭自我保护机制，以确保注册中心将不可用的实例及时正确剔除<br>eureka.server.enable-self-preservation=false<br></code></pre></td></tr></table></figure></li><li><p>step4.启动类加上@EnableEurekaServer注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaServer</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>启动成功后，访问<a href="http://localhost:8761/">Eureka</a>可以看到如下页面，可以看出此时还没有实例注册到该服务上。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232017385.png" alt="image-20230228232017385"></p></li></ul><h1 id="Eureka-Client搭建"><a href="#Eureka-Client搭建" class="headerlink" title="Eureka Client搭建"></a>Eureka Client搭建</h1><ul><li><p>Step1: 新建一个springBoot项目</p></li><li><p>Step2: 修改依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">plugins&#123;<br>id <span class="hljs-string">&#x27;org.springframework.boot&#x27;</span> version <span class="hljs-string">&#x27;2.6.1&#x27;</span><br>id <span class="hljs-string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="hljs-string">&#x27;1.0.8.RELEASE&#x27;</span><br>id <span class="hljs-string">&#x27;java&#x27;</span><br>&#125;<br><br>ext &#123;<br>set(<span class="hljs-string">&#x27;springCloudVersion&#x27;</span>, <span class="hljs-string">&quot;2021.0.0&quot;</span>)<br>name = <span class="hljs-string">&#x27;Eureka Server&#x27;</span><br>description = <span class="hljs-string">&#x27;Eureka Server demo project&#x27;</span><br>version=<span class="hljs-string">&#x27;0.0.1-SNAPSHOT&#x27;</span><br>    <br>sourceEncoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span><br>&#125;<br><br>repositories &#123;<br>mavenCentral()<br>maven &#123; url <span class="hljs-string">&#x27;https://repo.spring.io/release/&#x27;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.spring.io/libs-snapshot-local&quot;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.spring.io/libs-milestone-local&quot;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.spring.io/libs-release-local&quot;</span> &#125;<br>maven &#123; url <span class="hljs-string">&quot;https://repo.springsource.org/plugins-release&quot;</span> &#125;<br>&#125;<br><br>dependencyManagement &#123;<br>imports &#123;<br>mavenBom <span class="hljs-string">&quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;</span><br>&#125;<br>&#125;<br><br>dependencies &#123;<br>implementation <span class="hljs-string">&#x27;org.springframework.cloud:spring-cloud-starter-netflix-eureka-client&#x27;</span><br>implementation <span class="hljs-string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span><br><br>testImplementation <span class="hljs-string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Step3: application配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.application.name: micro-weather-eureka-client<br>eureka.client.serviceUrl.defaultZone: http:<span class="hljs-comment">//localhost:8761//eureka/</span><br></code></pre></td></tr></table></figure></li><li><p>step4.启动类加上@EnableDiscoveryClient注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    SpringApplication.run(Application.class, args);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>刷新</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232035911.png" alt="image-20230228232035911"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java 反射</title>
    <link href="/java-%E5%8F%8D%E5%B0%84/"/>
    <url>/java-%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h1 id="反射是什么？"><a href="#反射是什么？" class="headerlink" title="反射是什么？"></a>反射是什么？</h1><ul><li><p>反射就是指在运行状态中，对于任何一个类，能够知道这个类的所有属性和方法。</p></li><li><p>对于任何一个对象，都能调用它的任意属性和方法，并且可以改变他的属性。</p></li><li><p>反射是java被市委准动态语言的关键，反射机制允许程序在执行期间借助反射Api来获取任何类的内部信息，并能够直接操作任意对象的内部属性及方法。</p></li><li><p>加载完类后，在堆内存的方法区就产生了一个Class类型的对象，对应这个类。这个对象就包含了这个类的完整结构信息，我们可以通过这个对象看到类的结构。这个对象就像一面镜子，通过这面镜子我们可以看到类的结构，所以我们称之为：反射。</p></li></ul><h1 id="反射可以做什么"><a href="#反射可以做什么" class="headerlink" title="反射可以做什么"></a>反射可以做什么</h1><p>反射允许我们在程序运行时，取得任何一个已知class的内部信息，包括其属性，方法等，并可以在运行时改变他们呢。</p><p>获取class对象的五种方式：<a href="https://pyr9.github.io/2022/07/13/Java%E8%8E%B7%E5%8F%96class%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/">Java获取class的五种方式 - 楼上有只喵 (pyr9.github.io)</a></p><h1 id="反射的具体实现"><a href="#反射的具体实现" class="headerlink" title="反射的具体实现"></a>反射的具体实现</h1><p>查阅 API 可以看到 Class 有很多方法：</p><ul><li><p>getName()：获得类的完整名字。</p></li><li><p>getFields()：获得类的public类型的属性。</p><ul><li>getDeclaredFields()：获得类的所有属性。包括private 声明的和继承类</li><li>getMethods()：获得类的public类型的方法。</li><li>getDeclaredMethods()：获得类的所有方法。包括private 声明的和继承类</li><li>getMethod(String name, Class[] parameterTypes)：获得类的特定方法，name参数指定方法的名字，parameterTypes 参数指定方法的参数类型。</li><li>getConstructors()：获得类的public类型的构造方法。</li><li>getConstructor(Class[] parameterTypes)：获得类的特定构造方法，parameterTypes 参数指定构造方法的参数类</li><li>newInstance()：通过类的不带参数的构造方法创建这个类的一个对象</li></ul></li></ul><p><strong>代码测试：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.my.test.reflection;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Father</span></span>&#123;<br>  <span class="hljs-keyword">public</span> String fatherId;<br>  <span class="hljs-keyword">private</span> String fatherName;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFatherHobbies</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;eat&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFatherWork</span><span class="hljs-params">()</span></span>&#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;computer&quot;</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span></span>&#123;<br>  <span class="hljs-keyword">public</span> String sonId;<br>  <span class="hljs-keyword">private</span> String name;<br>  <span class="hljs-keyword">private</span> Integer age;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSonHobbies</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;study&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getSonWork</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;student&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.my.test.reflection;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException </span>&#123;<br>    <span class="hljs-keyword">final</span> Class&lt;Son&gt; clazz = Son.class;<br>    System.out.println(<span class="hljs-string">&quot;获得类的完整名字-------------------&quot;</span>);<br>    System.out.println(clazz.getName());<br><br>    System.out.println(<span class="hljs-string">&quot;获得类的public类型的属性-------------------&quot;</span>);<br>    <span class="hljs-keyword">for</span> (Field field : clazz.getFields()) &#123;<br>      <span class="hljs-comment">// 由于JDK的安全检查耗时较多.所以通过setAccessible(true)的方式关闭安全检查就可以达到提升反射速度的目的</span><br>      field.setAccessible(<span class="hljs-keyword">true</span>);<br>      System.out.println(field.getName());<br>    &#125;<br><br>    System.out.println(<span class="hljs-string">&quot;获得类的所有属性。包括private的---------------&quot;</span>);<br>    <span class="hljs-keyword">for</span> (Field field : clazz.getDeclaredFields()) &#123;<br>      System.out.println(field.getName());<br>    &#125;<br><br><br>    System.out.println(<span class="hljs-string">&quot;获得类的public类型的方法,包括Object的-------------------&quot;</span>);<br>    <span class="hljs-keyword">for</span> (Method method : clazz.getMethods()) &#123;<br>      System.out.println(method.getName());<br>    &#125;<br><br>    System.out.println(<span class="hljs-string">&quot;获得类的所有方法。-------------------&quot;</span>);<br>    <span class="hljs-keyword">for</span> (Method method : clazz.getDeclaredMethods()) &#123;<br>      System.out.println(method.getName());<br>    &#125;<br><br>    System.out.println(<span class="hljs-string">&quot;获得指定的public属性。-------------------&quot;</span>);<br>    Field sonId = clazz.getField(<span class="hljs-string">&quot;sonId&quot;</span>);<br>    System.out.println(sonId);<br><br>    System.out.println(<span class="hljs-string">&quot;获得指定的private属性。-------------------&quot;</span>);<br>    Field age = clazz.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);<br>    age.setAccessible(<span class="hljs-keyword">true</span>);<br>    System.out.println(age);<br><br>    System.out.println(<span class="hljs-string">&quot;创建这个类的一个对象-------------------&quot;</span>);<br>    <span class="hljs-keyword">final</span> Son son = clazz.getDeclaredConstructor().newInstance();<br>    System.out.println(son);<br><br>    System.out.println(<span class="hljs-string">&quot;将son对象的age属性赋值为19------------&quot;</span>);<br>    age.set(son, <span class="hljs-number">19</span>);<br>    System.out.println(age.get(son));<br><br>    System.out.println(<span class="hljs-string">&quot;获取构造方法-------------&quot;</span>);<br>    <span class="hljs-keyword">final</span> Constructor&lt;?&gt;[] constructors = clazz.getConstructors();<br>    <span class="hljs-keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;<br>      System.out.println(constructor.toString());<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Console:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs stylus">获得类的完整名字-------------------<br>com<span class="hljs-selector-class">.my</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.reflection</span><span class="hljs-selector-class">.Son</span><br>获得类的public类型的属性-------------------<br>sonId<br>fatherId<br>获得类的所有属性。包括private的---------------<br>sonId<br>name<br>age<br>获得类的public类型的方法,包括Object的-------------------<br>getSonHobbies<br>getFatherHobbies<br>wait<br>wait<br>wait<br>equals<br>toString<br>hashCode<br>getClass<br>notify<br>notifyAll<br>获得类的所有方法。-------------------<br>getSonWork<br>getSonHobbies<br>getFatherHobbies<br>获得指定的public属性。-------------------<br>public java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span> com<span class="hljs-selector-class">.my</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.reflection</span><span class="hljs-selector-class">.Son</span><span class="hljs-selector-class">.sonId</span><br>获得指定的private属性。-------------------<br>private java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Integer</span> com<span class="hljs-selector-class">.my</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.reflection</span><span class="hljs-selector-class">.Son</span><span class="hljs-selector-class">.age</span><br>创建这个类的一个对象-------------------<br>com<span class="hljs-selector-class">.my</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.reflection</span>.Son@<span class="hljs-number">1</span>cd072a9<br>将son对象的age属性赋值为<span class="hljs-number">19</span>------------<br><span class="hljs-number">19</span><br>获取构造方法-------------<br>public com<span class="hljs-selector-class">.my</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.reflection</span><span class="hljs-selector-class">.Son</span>()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>isAssignableFrom()</title>
    <link href="/isAssignableFrom-%E5%92%8Cinstanceof/"/>
    <url>/isAssignableFrom-%E5%92%8Cinstanceof/</url>
    
    <content type="html"><![CDATA[<h1 id="isAssignableFrom"><a href="#isAssignableFrom" class="headerlink" title="isAssignableFrom()"></a>isAssignableFrom()</h1><p>A.isAssignableFrom(B)方法可用来判断B是否可以由A转换（赋值得来），即</p><p>1.当A是类时，表示：类A是否为B类的父类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.my.test.isAggsignableFrom;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span></span>&#123;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Parent</span></span>&#123;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Brother</span> </span>&#123;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test01</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    System.out.println(Parent.class.isAssignableFrom(Son1.class));   =&gt; <span class="hljs-keyword">true</span><br>    System.out.println(Parent.class.isAssignableFrom(Brother.class));  =&gt; <span class="hljs-keyword">false</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>2.当A是接口时，表示：接口A是否被类B实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.my.test.isAggsignableFrom;<br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">A</span></span>&#123;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">A</span></span>&#123;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B1</span></span>&#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test02</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    System.out.println(A.class.isAssignableFrom(A1.class));  =&gt; <span class="hljs-keyword">true</span><br>    System.out.println(A.class.isAssignableFrom(B1.class));  =&gt; <span class="hljs-keyword">false</span><br>  &#125; <br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java获取class的五种方式</title>
    <link href="/Java%E8%8E%B7%E5%8F%96class%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/"/>
    <url>/Java%E8%8E%B7%E5%8F%96class%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="获取Class-类实例的五种方式"><a href="#获取Class-类实例的五种方式" class="headerlink" title="获取Class 类实例的五种方式"></a>获取Class 类实例的五种方式</h1><h2 id="1-已知具体的类，直接取该类的class属性-最安全，最可靠"><a href="#1-已知具体的类，直接取该类的class属性-最安全，最可靠" class="headerlink" title="1.已知具体的类，直接取该类的class属性(最安全，最可靠)"></a>1.已知具体的类，直接取该类的class属性(最安全，最可靠)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clazz01 = Person.class;<br></code></pre></td></tr></table></figure><h2 id="2-已知某个类的示例，调用该示例的getClass"><a href="#2-已知某个类的示例，调用该示例的getClass" class="headerlink" title="2.已知某个类的示例，调用该示例的getClass()"></a>2.已知某个类的示例，调用该示例的getClass()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clazz02 = <span class="hljs-keyword">new</span> Person().getClass();<br></code></pre></td></tr></table></figure><h2 id="3-已知该类的全路径，通过Class-forName-获得"><a href="#3-已知该类的全路径，通过Class-forName-获得" class="headerlink" title="3.已知该类的全路径，通过Class.forName() 获得"></a>3.已知该类的全路径，通过Class.forName() 获得</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class class03 = Class.forName(<span class="hljs-string">&quot;com.getClass.pojo.Person&quot;</span>);<br></code></pre></td></tr></table></figure><p>该方式可能会抛出：ClassNotFoundException</p><h2 id="4-已知该类的全路径，通过ClassLoader-loadClass-获得"><a href="#4-已知该类的全路径，通过ClassLoader-loadClass-获得" class="headerlink" title="4.已知该类的全路径，通过ClassLoader.loadClass() 获得"></a>4.已知该类的全路径，通过ClassLoader.loadClass() 获得</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">ClassLoader classLoader = MySpringApplicationContext.class.getClassLoader();<br><span class="hljs-keyword">final</span> Class clazz05 = classLoader.loadClass(<span class="hljs-string">&quot;com.getClass.pojo.Person&quot;</span>);<br></code></pre></td></tr></table></figure><p>该方式可能会抛出：ClassNotFoundException</p><h2 id="5-基本了类型的包装类，直接调用-type"><a href="#5-基本了类型的包装类，直接调用-type" class="headerlink" title="5. 基本了类型的包装类，直接调用.type"></a>5. 基本了类型的包装类，直接调用.type</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clazz04 = Integer.TYPE;<br></code></pre></td></tr></table></figure><p>​</p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring事务失效</title>
    <link href="/spring%E4%BA%8B%E5%8A%A1%E5%A4%B1%E6%95%88/"/>
    <url>/spring%E4%BA%8B%E5%8A%A1%E5%A4%B1%E6%95%88/</url>
    
    <content type="html"><![CDATA[<p>~&#x2F;IdeaProjects&#x2F;hexo_blog&#x2F;source&#x2F;_posts&#x2F;spring事务失效.md</p><p>![image-20220626230019084](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220626230019084.png)</p><p>![image-20220626230308183](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220626230308183.png)</p><p>![image-20220626231230229](&#x2F;Users&#x2F;panyurou&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220626231230229.png)</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>java命令--jstack的使用</title>
    <link href="/java%E5%91%BD%E4%BB%A4-jstack-%E5%B7%A5%E5%85%B7/"/>
    <url>/java%E5%91%BD%E4%BB%A4-jstack-%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<p>jstack用于生成java虚拟机当前时刻的线程快照。可以用来分析线程问题（如死锁），CPU突然飙升问题</p><h1 id="1-案例一-找出死锁"><a href="#1-案例一-找出死锁" class="headerlink" title="1. 案例一 找出死锁"></a>1. 案例一 找出死锁</h1><h2 id="1-1-问题代码"><a href="#1-1-问题代码" class="headerlink" title="1.1 问题代码"></a>1.1 问题代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadLockTest</span> </span>&#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object lock1 = <span class="hljs-keyword">new</span> Object();<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object lock2 = <span class="hljs-keyword">new</span> Object();<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>      <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>         <span class="hljs-keyword">synchronized</span> (lock1) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>               System.out.println(<span class="hljs-string">&quot;thread1 begin&quot;</span>);<br>               Thread.sleep(<span class="hljs-number">5000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            &#125;<br>            <span class="hljs-keyword">synchronized</span> (lock2) &#123;<br>               System.out.println(<span class="hljs-string">&quot;thread1 end&quot;</span>);<br>            &#125;<br>         &#125;<br>      &#125;).start();<br><br>      <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>         <span class="hljs-keyword">synchronized</span> (lock2) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>               System.out.println(<span class="hljs-string">&quot;thread2 begin&quot;</span>);<br>               Thread.sleep(<span class="hljs-number">5000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            &#125;<br>            <span class="hljs-keyword">synchronized</span> (lock1) &#123;<br>               System.out.println(<span class="hljs-string">&quot;thread2 end&quot;</span>);<br>            &#125;<br>         &#125;<br>      &#125;).start();<br><br>      System.out.println(<span class="hljs-string">&quot;main thread end&quot;</span>);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-问题定位"><a href="#1-2-问题定位" class="headerlink" title="1.2 问题定位"></a>1.2 问题定位</h2><h3 id="1-2-1-方式一-jps-jstack"><a href="#1-2-1-方式一-jps-jstack" class="headerlink" title="1.2.1 方式一 jps+jstack"></a>1.2.1 方式一 jps+jstack</h3><ol><li>运行<code>jps</code>，查看当前所有java进程的pid</li><li><code>jstack pid</code> 查看当前进程的堆栈状态，如果有死锁会打印出来found 1 deadLock</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231139474.png" alt="image-20230228231139474"></p><p>​       可以定位出是17行出了死锁问题。</p><h3 id="1-2-2-方式二-jvisualvm自动检测死锁"><a href="#1-2-2-方式二-jvisualvm自动检测死锁" class="headerlink" title="1.2.2 方式二 jvisualvm自动检测死锁"></a>1.2.2 方式二 jvisualvm自动检测死锁</h3><p>代码运行起来后，启动jvisualvm，在线程页面会直接有一个红色的显示：监测到死锁</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231151238.png" alt="image-20230228231151238"></p><h1 id="2-案例二-找出占用cpu最高的线程堆栈信息"><a href="#2-案例二-找出占用cpu最高的线程堆栈信息" class="headerlink" title="2 案例二 找出占用cpu最高的线程堆栈信息"></a>2 案例二 找出占用cpu最高的线程堆栈信息</h1><h2 id="2-1-问题代码"><a href="#2-1-问题代码" class="headerlink" title="2.1 问题代码"></a>2.1 问题代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Math</span> </span>&#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> initData = <span class="hljs-number">666</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User user = <span class="hljs-keyword">new</span> User();<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compute</span><span class="hljs-params">()</span> </span>&#123;  <span class="hljs-comment">//一个方法对应一块栈帧内存区域</span><br>    <span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">int</span> b = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">int</span> c = (a + b) * <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">return</span> c;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>   Math math = <span class="hljs-keyword">new</span> Math();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      math.compute();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-问题定位"><a href="#2-2-问题定位" class="headerlink" title="2.2 问题定位"></a>2.2 问题定位</h2><h3 id="2-2-1-命令top-p-，显示你的java进程的内存情况，找到当前进程的PID"><a href="#2-2-1-命令top-p-，显示你的java进程的内存情况，找到当前进程的PID" class="headerlink" title="2.2.1 命令top -p  ，显示你的java进程的内存情况，找到当前进程的PID"></a>2.2.1 命令top -p <pid> ，显示你的java进程的内存情况，找到当前进程的PID</h3><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231203454.png" alt="image-20230228231203454"></p><h3 id="2-2-2-按H，获取每个线程的内存情况"><a href="#2-2-2-按H，获取每个线程的内存情况" class="headerlink" title="2.2.2 按H，获取每个线程的内存情况"></a>2.2.2 按H，获取每个线程的内存情况</h3><h3 id="2-2-3-找到内存和cpu占用最高的线程tid"><a href="#2-2-3-找到内存和cpu占用最高的线程tid" class="headerlink" title="2.2.3 找到内存和cpu占用最高的线程tid"></a>2.2.3 找到内存和cpu占用最高的线程tid</h3><h3 id="2-2-4-执行-jstack-PID-grep-A-10-4cd0"><a href="#2-2-4-执行-jstack-PID-grep-A-10-4cd0" class="headerlink" title="2.2.4 执行 jstack PID|grep -A 10 4cd0"></a>2.2.4 执行 <code>jstack PID|grep -A 10 4cd0</code></h3><p>比如tid为19664 ，转为十六进制得到 0x4cd0，执行 jstack 19663|grep -A 10 4cd0，得到线程堆栈信息中 4cd0 这个线程所在行的后面10行，从堆栈中可以发现导致cpu飙高的调用方法 </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228231212070.png" alt="image-20230228231212070"></p><p>6，查看对应的堆栈信息找出可能存在问题的代码</p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java命令</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>对象内存回收</title>
    <link href="/%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/"/>
    <url>/%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h1><p>垃圾收集主要是针对<strong>堆和方法区</strong>进行。程序计数器、虚拟机栈和本地方法栈这三个区域属于线程私有的，只存在于线程的生命周期内，线程结束之后就会消失，因此不需要对这三个区域进行垃圾回收。</p><h2 id="判断一个对象是否可被回收"><a href="#判断一个对象是否可被回收" class="headerlink" title="判断一个对象是否可被回收"></a>判断一个对象是否可被回收</h2><p>要对垃圾进行回收，首先得判断这个对象是否可以被回收，有两种方法来判断： </p><h3 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a><strong>引用计数法</strong></h3><p>给对象添加一个引用计数器，当对象增加一个引用时计数器加 1，引用失效时计数器减 1。引用计数为 0 的对象可被回收。<br>在两个对象出现<strong>循环引用</strong>的情况下，此时引用计数器永远不为 0，导致无法对它们进行回收。正是因为循环引用的存在，因此 Java 虚拟机不使用引用计数算法。</p><h3 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h3><p>以 GC Roots 为起始点向下搜索，搜索所走过的路径称为引用链，当一个对象到 GC Roots 没有任何引用链相连，证明此对象是不可的。</p><p><strong>GC Roots</strong>根节点：线程栈的本地变量、静态变量、本地方法栈的变量等等 </p><h1 id="常见引用类型"><a href="#常见引用类型" class="headerlink" title="常见引用类型"></a><strong>常见引用类型</strong></h1><p>java的引用类型一般分为四种：<strong>强引用</strong>、<strong>软引用</strong>、弱引用、虚引用 </p><ul><li><strong>强引用</strong>：普通的变量引用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User user = <span class="hljs-keyword">new</span> User(); <br></code></pre></td></tr></table></figure><ul><li><strong>软引用</strong>：将对象用SoftReference软引用类型的对象包裹，正常情况不会被回收，但是GC做完后发现释放不出空间存放新的对象，则会把这些软引用的对象回收掉。<strong>软引用可用来实现内存敏感的高速缓存。</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SoftReference&lt;User&gt; user = <span class="hljs-keyword">new</span> SoftReference&lt;User&gt;(<span class="hljs-keyword">new</span> User()); <br></code></pre></td></tr></table></figure><ul><li>软引用在实际中有重要的应用，例如浏览器的后退按钮。按后退时，这个后退时显示的网页内容就可以使用软引用存储。</li></ul><p>​（1）如果一个网页在浏览结束时就进行内容的回收，则按后退查看前面浏览过的页面时，需要重新构建 </p><p>​（2）如果将浏览过的网页存储到内存中会造成内存的大量浪费，甚至会造成内存溢出 </p><ul><li><p><strong>弱引用</strong>：将对象用WeakReference软引用类型的对象包裹，弱引用跟没引用差不多，<strong>GC会直接回收掉</strong>，很少用 </p>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WeakReference&lt;User&gt; user = <span class="hljs-keyword">new</span> WeakReference&lt;User&gt;(<span class="hljs-keyword">new</span> User()); <br></code></pre></td></tr></table></figure></li><li><p><strong>虚引用：</strong>虚引用也称为幽灵引用或者幻影引用，它是最弱的一种引用关系，几乎不用</p></li></ul><h1 id="finalize-方法"><a href="#finalize-方法" class="headerlink" title="finalize()方法"></a><strong>finalize()方法</strong></h1><p><strong>从Java9开始，finalize方法已被标注为@Deprecated，也就是过期了</strong></p><p>即使在可达性分析算法中不可达的对象，也并非是“非死不可”的，这时候它们暂时处于“缓刑”阶段，要真正宣告一个对象死亡，至少要经历再次标记过程。 </p><p><strong>标记的前提是对象在进行可达性分析后发现没有与GC Roots相连接的引用链。</strong> </p><p><strong>1. 第一次标记并进行一次筛选。</strong> </p><p>筛选的条件是此对象是否有必要执行finalize()方法。 </p><p>当对象没有覆盖finalize方法，对象将直接被回收。 </p><p><strong>2. 第二次标记</strong> </p><p>如果这个对象覆盖了finalize方法，finalize方法是对象脱逃死亡命运的最后一次机会，如果对象要在finalize()中成功拯救自己，只要重新与引用链上的任何的一个对象建立关联即可，譬如把自己赋值给某个类变量或对象的成员变量，那在第二次标记时它将移除出“即将回收”的集合。如果对象这时候还没逃脱，那基本上它就真的被回收了。 </p><p>注意：一个对象的finalize()方法只会被执行一次，也就是说通过调用finalize方法自我救命的机会就一次。 </p><p>示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> id;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.id=id;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;id&quot;</span>+id);<br>    <span class="hljs-keyword">super</span>.finalize();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OOMTest</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    List&lt;Object&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      list.add(<span class="hljs-keyword">new</span> User(i++));<br>      <span class="hljs-keyword">new</span> User(j--);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228234402806.png" alt="image-20230228234402806"></p><p>可以看出，id为负数的user实例，也就是需要回收的对象，是会调用finalize()方法的！</p><h1 id="如何判断一个类是无用的类"><a href="#如何判断一个类是无用的类" class="headerlink" title="如何判断一个类是无用的类"></a><strong>如何判断一个类是无用的类</strong></h1><p>方法区主要回收的是无用的类，那么如何判断一个类是无用的类的呢？ 类需要同时满足下面3个条件才能算是 <strong>“无用的类”</strong> ： </p><ul><li><p>该类所有的实例都已经被回收，也就是 Java 堆中不存在该类的任何实例。 </p></li><li><p>加载该类的 ClassLoader 已经被回收。 这点就使得大部分的类都没办法回收，因为类加载器很难被回收，自定义类加载器会有可能。</p></li><li><p>该类对应的 java.lang.Class 对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>性能调优</tag>
      
      <tag>垃圾回收</tag>
      
      <tag>常见引用类型</tag>
      
      <tag>如何判断一个类是无用的类</tag>
      
      <tag>finalize()方法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java命令--jinfo&amp;jstat</title>
    <link href="/java%E5%91%BD%E4%BB%A4-jinfo&amp;jstat%E5%B7%A5%E5%85%B7/"/>
    <url>/java%E5%91%BD%E4%BB%A4-jinfo&amp;jstat%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h1 id="Jstat"><a href="#Jstat" class="headerlink" title="Jstat"></a><strong>Jstat</strong></h1><p>jstat命令可以查看堆内存各部分的使用量，以及加载类的数量。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230728148.png" alt="image-20230228230728148"></p><h2 id="垃圾回收统计"><a href="#垃圾回收统计" class="headerlink" title="垃圾回收统计"></a>垃圾回收统计</h2><p><strong>jstat -gc pid 最常用</strong>，可以评估程序内存使用及GC压力整体情况 </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230735468.png" alt="image-20230228230735468"></p><ul><li><p>S0C：第一个幸存区的大小，单位KB</p></li><li><p>S1C：第二个幸存区的大小</p></li><li><p>S0U：第一个幸存区的使用大小</p></li><li><p>S1U：第二个幸存区的使用大小</p></li><li><p>EC：伊甸园区的大小</p></li><li><p>EU：伊甸园区的使用大小</p></li><li><p>OC：老年代大小</p></li><li><p>OU：老年代使用大小</p></li><li><p>MC：方法区大小(元空间)</p></li><li><p>MU：方法区使用大小</p></li><li><p>CCSC:压缩类空间大小</p></li><li><p>CCSU:压缩类空间使用大小</p></li><li><p>YGC：年轻代垃圾回收次数，指的是程序从运行起来到现在的次数</p></li><li><p>YGCT：年轻代垃圾回收消耗时间，单位s</p></li><li><p>FGC：老年代垃圾回收次数 </p></li><li><p>FGCT：老年代垃圾回收消耗时间，单位s</p></li><li><p>GCT：垃圾回收消耗总时间，单位s</p></li></ul><p> <strong>jstat -gc pid 1000 10 (每隔1秒执行1次命令，共执行10次)</strong></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230742585.png" alt="image-20230228230742585"></p><h2 id="堆内存统计"><a href="#堆内存统计" class="headerlink" title="堆内存统计"></a>堆内存统计</h2><p>命令：<code>jstat -gccapacity 3548</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230751160.png"></p><ul><li>NGCMN：新生代最小容量</li><li>NGCMX：新生代最大容量</li><li>NGC：当前新生代容量</li><li>S0C：第一个幸存区大小</li><li>S1C：第二个幸存区的大小</li><li>EC：伊甸园区的大小</li><li>OGCMN：老年代最小容量</li><li>OGCMX：老年代最大容量</li><li>OGC：当前老年代大小</li><li>OC:当前老年代大小</li><li>MCMN:最小元数据容量</li><li>MCMX：最大元数据容量</li><li>MC：当前元数据空间大小</li><li>CCSMN：最小压缩类空间大小</li><li>CCSMX：最大压缩类空间大小</li><li>CCSC：当前压缩类空间大小</li><li>YGC：年轻代gc次数</li><li>FGC：老年代GC次数</li></ul><h2 id="新生代垃圾回收统计"><a href="#新生代垃圾回收统计" class="headerlink" title="新生代垃圾回收统计"></a>新生代垃圾回收统计</h2><p> 命令：<code>jstat -gcnew 3548</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230803600.png" alt="image-20230228230803600"></p><ul><li>S0C：第一个幸存区的大小</li><li>S1C：第二个幸存区的大小</li><li>S0U：第一个幸存区的使用大小</li><li>S1U：第二个幸存区的使用大小</li><li>TT:对象在新生代存活的次数</li><li>MTT:对象在新生代存活的最大次数</li><li>DSS:期望的幸存区大小</li><li>EC：伊甸园区的大小</li><li>EU：伊甸园区的使用大小</li><li>YGC：年轻代垃圾回收次数</li><li>YGCT：年轻代垃圾回收消耗时间</li></ul><h2 id="新生代内存统计"><a href="#新生代内存统计" class="headerlink" title="新生代内存统计"></a>新生代内存统计</h2><p><code>jstat -gcnewcapacity 3548</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230814113.png"></p><ul><li>NGCMN：新生代最小容量</li><li>NGCMX：新生代最大容量</li><li>NGC：当前新生代容量</li><li>S0CMX：最大幸存1区大小</li><li>S0C：当前幸存1区大小</li><li>S1CMX：最大幸存2区大小</li><li>S1C：当前幸存2区大小</li><li>ECMX：最大伊甸园区大小</li><li>EC：当前伊甸园区大小</li><li>YGC：年轻代垃圾回收次数</li><li>FGC：老年代回收次数</li></ul><h2 id="JVM运行情况预估"><a href="#JVM运行情况预估" class="headerlink" title="JVM运行情况预估"></a><strong>JVM运行情况预估</strong></h2><p>用 jstat gc -pid 命令可以计算出如下一些关键数据，有了这些数据就可以采用之前介绍过的优化思路，先给自己的系统设置一些初始性的JVM参数，比如堆内存大小，年轻代大小，Eden和Survivor的比例，老年代的大小，大对象的阈值，大龄对象进入老年代的阈值等。</p><p><strong>年轻代对象增长的速率</strong></p><p>可以执行命令 jstat -gc pid 1000 10 (每隔1秒执行1次命令，共执行10次)，通过观察EU(eden区的使用)来估算每秒eden大概新增多少对象，如果系统负载不高，可以把频率1秒换成1分钟，甚至10分钟来观察整体情况。注意，一般系统可能有高峰期和日常期，所以需要在不同的时间分别估算不同情况下对象增长速率。</p><p><strong>Young GC的触发频率和每次耗时</strong></p><p>知道年轻代对象增长速率我们就能推根据eden区的大小推算出Young GC大概多久触发一次，Young GC的平均耗时可以通过 YGCT&#x2F;YGC 公式算出，根据结果我们大概就能知道<strong>系统大概多久会因为Young GC的执行而卡顿多久。</strong></p><p><strong>每次Young GC后有多少对象存活和进入老年代</strong></p><p>这个因为之前已经大概知道Young GC的频率，假设是每5分钟一次，那么可以执行命令 jstat -gc pid 300000 10 ，观察每次结果eden，survivor和老年代使用的变化情况，在每次gc后eden区使用一般会大幅减少，survivor和老年代都有可能增长，这些增长的对象就是每次Young GC后存活的对象，同时还可以看出每次Young GC后进去老年代大概多少对象，从而可以推算出<strong>老年代对象增长速率。</strong></p><p><strong>Full GC的触发频率和每次耗时</strong></p><p>知道了老年代对象的增长速率就可以推算出Full GC的触发频率了，Full GC的每次耗时可以用公式 FGCT&#x2F;FGC 计算得出。</p><p><strong>优化思路</strong>其实简单来说就是尽量让每次Young GC后的存活对象小于Survivor区域的50%，都留存在年轻代里。尽量别让对象进入老年代。尽量减少Full GC的频率，避免频繁Full GC对JVM性能的影响。</p><h1 id="Jinfo"><a href="#Jinfo" class="headerlink" title="Jinfo"></a><strong>Jinfo</strong></h1><p>查看正在运行的Java应用程序的扩展参数 以及jvm的参数 </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230825681.png" alt="image-20230228230825681"></p><h2 id="flags"><a href="#flags" class="headerlink" title="-flags"></a>-flags</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230833623.png" alt="image-20230228230833623"></p>]]></content>
    
    
    <categories>
      
      <category>JVM</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java命令</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql事务隔离级别</title>
    <link href="/mysql%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
    <url>/mysql%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="mysql-事务"><a href="#mysql-事务" class="headerlink" title="mysql 事务"></a>mysql 事务</h1><h2 id="1-事务定义"><a href="#1-事务定义" class="headerlink" title="1.事务定义"></a>1.事务定义</h2><p>事务是一个操作集合，这些操作要么都执行，要么都不执行，他是一个不可分割的工作单位。</p><h2 id="2-事务的四大特性"><a href="#2-事务的四大特性" class="headerlink" title="2.事务的四大特性"></a>2.事务的四大特性</h2><ul><li>原子性：事务是一个原子操作单元，它对数据的修改，要么都执行，要么都不执行。</li><li>一致性：一个事务执行前和执行后，数据必须保持一致，如：转账前用户AB的钱加在一起时500，转账后也应该是500</li><li>隔离型：事务外的实体不可以知道事务过程中的中间状态</li><li>持久性：对数据库的操作是永久性的，即使系统故障也能保持</li></ul><h2 id="3-不考虑事务的隔离性会产生并发问题"><a href="#3-不考虑事务的隔离性会产生并发问题" class="headerlink" title="3.不考虑事务的隔离性会产生并发问题"></a>3.不考虑事务的隔离性会产生并发问题</h2><ul><li>更新丢失：当两个或者多个事务同时对一行数据进行更新，会发生数据的覆盖，最后的更新覆盖了其他事务的更新。</li><li>脏读：读到了没有提交的数据，一个事务正在写操作，另一个事务进行了读操作，读到了脏数据。如果此时事务回滚，读取到的数据就是无效的。</li><li>不可重复读：读到了已经提交的数据，事务A多次读取同一数据，但在这个过程中，事务B对数据进行了修改并提交，会导致事务A多次读取数据结果不一致。</li><li>幻读：事务A读取到了事务B提交的新增数据。查询某记录是否存在，不存在，准备插入此记录，但执行 insert 时发现此记录已存在，无法插入，此时就发生了幻读。</li></ul><h1 id="mysql-事务隔离级别"><a href="#mysql-事务隔离级别" class="headerlink" title="mysql 事务隔离级别"></a>mysql 事务隔离级别</h1><ul><li><p>脏读”、“不可重复读”和“幻读”,其实都是数据库读一致性问题,必须由数据库提供一定的事务隔离机制来解决。</p></li><li><p>mysql隔离级别越高，性能越差。因为事务的本质就是串行化，这显然与并发是矛盾的。</p></li><li><p><code>RR</code> 级别作为 <code>mysql</code> 事务默认隔离级别，是事务安全与性能的折中。</p></li><li><p>查看当前事务的隔离级别 <code>select @@transaction_isolation;</code></p></li><li><p>设置事务隔离级别</p><ul><li>当前会话： <code>SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</code></li><li>全局：<code>SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</code></li></ul></li></ul><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th align="center">幻读</th></tr></thead><tbody><tr><td>读未提交</td><td>可能</td><td>可能</td><td align="center">可能</td></tr><tr><td>读已提交</td><td>不可能</td><td>可能</td><td align="center">可能</td></tr><tr><td>可重复读</td><td>不可能</td><td>不可能</td><td align="center">可能</td></tr><tr><td>串行化</td><td>不可能</td><td>不可能</td><td align="center">不可能</td></tr></tbody></table><h2 id="1-读未提交"><a href="#1-读未提交" class="headerlink" title="1.读未提交"></a>1.读未提交</h2><ul><li><p>打开两个客户端：客户端A设置当前事务模式为read uncommitted，查询employees 表的初始值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@transaction</span>_isolation;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@transaction</span>_isolation <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-operator">|</span> READ<span class="hljs-operator">-</span>UNCOMMITTED        <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span>  <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name      <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> position <span class="hljs-operator">|</span> hire_time           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> LiLei     <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> mana ger <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> HanMeimei <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Lucy      <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure></li><li><p>客户端B开启事务，并执行更新操作</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">begin</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span>  update employees <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> &quot;newLiLei&quot; <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>Query OK, <span class="hljs-number">1</span> <span class="hljs-type">row</span> affected (<span class="hljs-number">0.00</span> sec)<br><span class="hljs-keyword">Rows</span> matched: <span class="hljs-number">1</span>  Changed: <span class="hljs-number">1</span>  Warnings: <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li><li><p>这时，虽然客户端B的事务还没提交，但是客户端A就可以查询到B已经更新的数据，一旦客户端B的事务因为某种原因回滚，所有的操作都将会被撤销，那客户端A查询到的数据其实就是<strong>脏数据</strong>： </p></li><li><pre><code class="sql">mysql&gt;  select * from employees;+----+-----------+-----+----------+---------------------+| id | name      | age | position | hire_time           |+----+-----------+-----+----------+---------------------+|  4 | newLiLei  |  22 | mana ger | 2021-12-06 21:36:50 ||  5 | HanMeimei |  23 | dev      | 2021-12-06 21:36:50 ||  6 | Lucy      |  23 | dev      | 2021-12-06 21:36:50 |+----+-----------+-----+----------+---------------------+3 rows in set (0.00 sec)<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br>## 读已提交<br><br><span class="hljs-bullet">- </span>打开两个客户端：客户端A设置当前事务模式为read committed，查询employees 表的初始值<br><br><span class="hljs-code">```sql</span><br><span class="hljs-code">mysql&gt; select @@transaction_isolation;</span><br><span class="hljs-code">+-------------------------+</span><br><span class="hljs-code">| @@transaction_isolation |</span><br><span class="hljs-code">+-------------------------+</span><br><span class="hljs-code">| READ-COMMITTED          |</span><br><span class="hljs-code">+-------------------------+</span><br><span class="hljs-code">1 row in set (0.00 sec)</span><br><span class="hljs-code"></span><br><span class="hljs-code"></span>mysql&gt; begin;<br>Query OK, 0 rows affected (0.00 sec)<br><br><span class="hljs-section">mysql&gt; select * from employees;</span><br><span class="hljs-section">+----+-----------+-----+----------+---------------------+</span><br><span class="hljs-section">| id | name      | age | position | hire_time           |</span><br><span class="hljs-section">+----+-----------+-----+----------+---------------------+</span><br>|  4 | LiLei     |  22 | mana ger | 2021-12-06 21:36:50 |<br>|  5 | HanMeimei |  23 | dev      | 2021-12-06 21:36:50 |<br><span class="hljs-section">|  6 | Lucy      |  23 | dev      | 2021-12-06 21:36:50 |</span><br><span class="hljs-section">+----+-----------+-----+----------+---------------------+</span><br>3 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure></code></pre></li><li><p>客户端B开启事务，并执行更新操作</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">begin</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span>  update employees <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> &quot;newLiLei&quot; <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>Query OK, <span class="hljs-number">1</span> <span class="hljs-type">row</span> affected (<span class="hljs-number">0.00</span> sec)<br><span class="hljs-keyword">Rows</span> matched: <span class="hljs-number">1</span>  Changed: <span class="hljs-number">1</span>  Warnings: <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><ul><li>这时，客户端B的事务还没提交，客户端A不能查询到B已经更新的数据，解决了脏读问题：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name      <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> position <span class="hljs-operator">|</span> hire_time           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> LiLei     <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> mana ger <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> HanMeimei <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Lucy      <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><ul><li>客户端B的事务提交</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">commit</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.01</span> sec)<br></code></pre></td></tr></table></figure><ul><li>客户端A再次查询，结果 与上一步不一致，即产生了不可重复读的问题</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name      <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> position <span class="hljs-operator">|</span> hire_time           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> newLiLei  <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> mana ger <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> HanMeimei <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Lucy      <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br></code></pre></td></tr></table></figure><h2 id="可重复读"><a href="#可重复读" class="headerlink" title="可重复读"></a>可重复读</h2><ul><li>打开两个客户端：客户端A设置当前事务模式为REPEATABLE-READ，查询employees 表的初始值</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@transaction</span>_isolation;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@transaction</span>_isolation <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-operator">|</span> REPEATABLE<span class="hljs-operator">-</span>READ         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">begin</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name      <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> position <span class="hljs-operator">|</span> hire_time           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> LiLei     <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> mana ger <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> HanMeimei <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Lucy      <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><ul><li>客户端B开启事务，并执行更新操作, 并提交。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">begin</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br>mysql<span class="hljs-operator">&gt;</span>  update employees <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> &quot;newLiLei&quot; <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>Query OK, <span class="hljs-number">1</span> <span class="hljs-type">row</span> affected (<span class="hljs-number">0.00</span> sec)<br><span class="hljs-keyword">Rows</span> matched: <span class="hljs-number">1</span>  Changed: <span class="hljs-number">1</span>  Warnings: <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><ul><li>在客户端A查询表account的所有记录，与上一次查询结果一致，没出现有出现不可重复读的问题</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name      <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> position <span class="hljs-operator">|</span> hire_time           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> LiLei     <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> mana ger <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> HanMeimei <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Lucy      <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)<br></code></pre></td></tr></table></figure><blockquote><p>Mysql默认级别是repeatable-read，有办法解决幻读问题吗？ </p><p><strong>间隙锁在某些情况下可以解决幻读问题</strong> </p><p>要避免幻读可以用间隙锁在Session_1下面执行update account set name &#x3D; ‘zhuge’ where id &gt; 10 and id &lt;&#x3D;20;，则其他Session没法在这个范围所包含的间隙里插入或修改任何数据</p></blockquote><h2 id="串行化"><a href="#串行化" class="headerlink" title="串行化"></a>串行化</h2><ul><li>打开两个客户端：客户端A设置当前事务模式为SERIALIZABLE，查询employees 表的初始值</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@transaction</span>_isolation;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@transaction</span>_isolation <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-operator">|</span> SERIALIZABLE            <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec) <br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name      <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> position <span class="hljs-operator">|</span> hire_time           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> newLiLei  <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> mana ger <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> HanMeimei <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Lucy123   <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> dev      <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">7</span> <span class="hljs-operator">|</span> wangwu123 <span class="hljs-operator">|</span>  <span class="hljs-number">18</span> <span class="hljs-operator">|</span> super    <span class="hljs-operator">|</span> <span class="hljs-number">2021</span><span class="hljs-number">-12</span><span class="hljs-number">-06</span> <span class="hljs-number">21</span>:<span class="hljs-number">36</span>:<span class="hljs-number">53</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+-----------+-----+----------+---------------------+</span><br></code></pre></td></tr></table></figure><ul><li>打开一个客户端B，并设置当前事务模式为serializable，插入一条记录报错，表被锁了插入失败，mysql中事务隔离级别为serializable时会锁表，因此不会出现幻读的情况，这种隔离级别并发性极低，开发中很少会用到。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">begin</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> employees <span class="hljs-keyword">values</span>(<span class="hljs-number">12</span>,&quot;lili2&quot;,<span class="hljs-number">11</span>,&quot;manager&quot;,&quot;2021-12-06 21:36:55&quot;);<br>ERROR <span class="hljs-number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction<br></code></pre></td></tr></table></figure><h1 id="InnoDB与MYISAM的最大不同有两点："><a href="#InnoDB与MYISAM的最大不同有两点：" class="headerlink" title="InnoDB与MYISAM的最大不同有两点："></a>InnoDB与MYISAM的最大不同有两点：</h1><ol><li>支持事务</li><li>支持行锁</li></ol><h1 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h1><ul><li><p>尽可能低级别事务隔离</p></li><li><p>尽可能减少检索条件范围，避免间隙锁 </p></li><li><p>尽量控制事务大小，减少锁定资源量和时间长度，涉及事务加锁的sql尽量放在事务最后执行 </p></li><li><p>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁 </p><blockquote><p>无索引行锁会升级为表锁：锁主要是加在索引上，如果对非索引字段更新, 行锁可能会变表锁</p></blockquote></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql事务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql事务隔离性的实现</title>
    <link href="/mvcc%E4%BB%8B%E7%BB%8D/"/>
    <url>/mvcc%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="mysql事务隔离性的实现"><a href="#mysql事务隔离性的实现" class="headerlink" title="mysql事务隔离性的实现"></a>mysql事务隔离性的实现</h1><h2 id="MVCC机制（多版本并发控制）"><a href="#MVCC机制（多版本并发控制）" class="headerlink" title="MVCC机制（多版本并发控制）"></a>MVCC机制（多版本并发控制）</h2><ul><li>Mysql在读已提交和可重复读隔离级别下都实现了MVCC机制。 </li><li>主要是保存数据在某个时间点的快照实现的。</li><li>mysql在每行记录后面，保存了两个隐藏列，分别为：创建事务id和删除事务id</li><li>MVCC机制的实现就是通过read-view机制与undo版本链比对机制，使得不同的事务会根据数据版本链对比规则读取同一条数据在版本链上的不同版本数据。</li></ul><ul><li><p>当执行select操作的时候，mysql底层会带上过滤条件：</p><ul><li><p>创建事务id &lt;&#x3D; max(当前事务id, 已提交的最大事务id)，保证该事务读到的数据，要么是开始前就已经存在的，要么是自身插入或修改后的。</p></li><li><p>删除事务id  &gt;  max (当前事务id, 已提交的最大事务id) 或  删除事务id未定义。保证事务读到的行，在事务开始前没有被删除</p></li></ul></li></ul><h2 id="undo日志版本链"><a href="#undo日志版本链" class="headerlink" title="undo日志版本链"></a><strong>undo日志版本链</strong></h2><p>undo日志版本链是指一行数据被多个事务依次修改过后，在每个事务修改完后，Mysql会保留修改前的数据undo回滚日志，并且用两个隐藏字段trx_id和roll_pointer把这些undo日志串联起来形成一个历史记录版本链。</p><ul><li>roll_pointer： 可以根据roll_pointer找到之前的老数据，如果事务失败，就可以找到之前的老数据</li><li>每次修改，就是写进新的事务id,以及把回滚指针指向上一条数据的位置</li></ul><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h385eu22j0j218m0u042n.jpg"></p><h2 id="read-view机制详解"><a href="#read-view机制详解" class="headerlink" title="read view机制详解"></a><strong>read view机制详解</strong></h2><ul><li><p>在<strong>可重复读隔离级别</strong>，当事务开启，执行任何查询sql时会生成当前事务的<strong>一致性视图read-view，</strong>该视图在事务结束 之前都不会变化(<strong>如果是读已提交隔离级别在每次执行查询sql时都会重新生成</strong>)。</p></li><li><p>这个视图由执行查询时所有未提交事务id<strong>数组</strong>（数组里最小的id为min_id）和已创建的最大事务id（max_id）组成，事务里的任何sql查询结果需要从对应版本链里的最新数据开始逐条跟read-view做比对从而得到最终的快照结果。</p></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h385hvu2m4j210w0c2myc.jpg" style="zoom:50%;" /></h2><p>Eg:</p><p>假设当前新开启了一个事务A，事务id为300，在该事务之前有两个事务B和C，均id分别为100和200。</p><p>当事务A执行第一个select的时候，事务B已经提交了，而事务C还没有提交，那么此时的read-view为【200】，300</p><p><strong>版本链比对规则：</strong> </p><ol><li><p>如果 row 的 trx_id 落在绿色部分( trx_id&lt;min_id )，表示这个版本是已提交的事务生成的，这个数据是可见的； </p></li><li><p>如果 row 的 trx_id 落在红色部分( trx_id&gt;max_id )，表示这个版本是由将来启动的事务生成的，是不可见的(若</p></li></ol><p>row 的 trx_id 就是当前自己的事务是可见的）；</p><ol start="3"><li>如果 row 的 trx_id 落在黄色部分(min_id &lt;&#x3D;trx_id&lt;&#x3D; max_id)，那就包括两种情况</li></ol><p>​a. 若 row 的 trx_id 在视图数组中，表示这个版本是由还没提交的事务生成的，不可见(若 row 的 trx_id 就是当前自己的事务是可见的)； </p><p>​b. 若 row 的 trx_id 不在视图数组中，表示这个版本是已经提交了的事务生成的，可见。</p><p><strong>删除的情况</strong>：</p><p>对于删除的情况可以认为是update的特殊情况，会将版本链上最新的数据复制一份，然后将trx_id修改成删除操作的 trx_id，同时在该条记录的头信息（record header）里的（deleted_flag）标记位写上true，来表示当前记录已经被删除，在查询时按照上面的规则查到对应的记录如果delete_flag标记位为true，意味着记录已被删除，则不返回数据。</p><p><strong>注意：</strong></p><p>begin&#x2F;start transaction 命令并不是一个事务的起点，在执行到它们之后的第一个修改操作InnoDB表的语句， </p><p>事务才真正启动，才会向mysql申请事务id，mysql内部是严格按照事务的启动顺序来分配事务id的。 </p><h2 id="加锁"><a href="#加锁" class="headerlink" title="加锁"></a>加锁</h2><p>串行化隔离级别为了保证较高的隔离性是通过将所有操 作加锁互斥来实现的。</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql事务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>postgresql索引基础</title>
    <link href="/postgresql%E5%9F%BA%E7%A1%80/"/>
    <url>/postgresql%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="PostgreSQL索引类型"><a href="#PostgreSQL索引类型" class="headerlink" title="PostgreSQL索引类型"></a>PostgreSQL索引类型</h1><ul><li>PostgreSQL提供了多种索引类型： B-tree、Hash、GiST、SP-GiST 、GIN 和 BRIN。</li><li>每一种索引类型使用了 一种不同的算法来适应不同类型的查询。</li><li>默认情况下，CREATE INDEX命令创建适合于大部分情况的B-tree 索引。</li></ul><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>flex 布局</title>
    <link href="/flex-%E5%B8%83%E5%B1%80/"/>
    <url>/flex-%E5%B8%83%E5%B1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="1-开启flex-布局"><a href="#1-开启flex-布局" class="headerlink" title="1 开启flex 布局"></a>1 开启flex 布局</h1><ul><li>开启flex布局，只需要在最外层容器设置<code> display: flex</code>即可</li><li>采用 Flex 布局的元素，称为 Flex 容器（flex container），简称”容器”。它的所有子元素自动成为容器成员，称为 Flex 项目（flex item），简称”项目”。</li><li>容器默认存在两根轴：水平的主轴（main axis）和垂直的交叉轴（cross axis）。<ul><li>主轴的开始位置（与边框的交叉点）叫做<code>main start</code>，结束位置叫做<code>main end</code>；</li><li>交叉轴的开始位置叫做<code>cross start</code>，结束位置叫做<code>cross end</code></li></ul></li><li>项目默认沿主轴排列。单个项目占据的主轴空间叫做<code>main size</code>，占据的交叉轴空间叫做<code>cross size</code>。</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529192600.png"></p><p><strong>示例</strong>：</p><p>开启flex布局，默认沿主轴排列</p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529194352.png" style="zoom:33%;" /><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"></span><br><span class="css">  <span class="hljs-selector-class">.container</span> &#123;</span><br><span class="css">    <span class="hljs-attribute">width</span>: <span class="hljs-number">400px</span>;</span><br><span class="css">    <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;</span><br><span class="css">    <span class="hljs-attribute">background-color</span>: bisque;</span><br><span class="css">    <span class="hljs-attribute">display</span>: flex;</span><br><span class="css">  &#125;</span><br><span class="css">  <span class="hljs-selector-class">.box</span> &#123;</span><br><span class="css">    <span class="hljs-attribute">background-color</span>: pink;</span><br><span class="css">    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;</span><br><span class="css">    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;</span><br><span class="css">    <span class="hljs-attribute">border</span>: solid <span class="hljs-number">1px</span>;</span><br><span class="css">  &#125;</span><br><span class="css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;box&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;box&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;box&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="2-容器的属性"><a href="#2-容器的属性" class="headerlink" title="2 容器的属性"></a>2 容器的属性</h1><p>以下6个属性设置在容器上。</p><h2 id="2-1-flex-direction"><a href="#2-1-flex-direction" class="headerlink" title="2.1 flex-direction"></a>2.1 flex-direction</h2><p>主轴的方向,（即项目的排列方向）。</p><blockquote><ul><li><code>row</code>（默认值）：主轴为水平方向，起点在左端。</li></ul></blockquote><blockquote><ul><li><code>row-reverse</code>：主轴为水平方向，起点在右端。</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529194849.png" style="zoom:33%;" /><blockquote><ul><li><code>column</code>：主轴为垂直方向，起点在上沿。</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529194940.png" style="zoom:33%;" /><blockquote><ul><li><code>column-reverse</code>：主轴为垂直方向，起点在下沿。</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195014.png" style="zoom:33%;" /><h2 id="2-2-flex-wrap"><a href="#2-2-flex-wrap" class="headerlink" title="2.2 flex-wrap"></a>2.2 flex-wrap</h2><p>默认情况下，项目都排在一条线（又称”轴线”）上。<code>flex-wrap</code>属性定义，如果一条轴线排不下，如何换行。</p><blockquote><ul><li><code>nowrap</code>（默认）：不换行。</li><li><code>wrap</code>：换行，第一行在上方。</li><li><code>wrap-reverse</code>：换行，第一行在下方。</li></ul></blockquote><h2 id="2-3-flex-flow"><a href="#2-3-flex-flow" class="headerlink" title="2.3 flex-flow"></a>2.3 flex-flow</h2><p><code>flex-flow</code>属性是<code>flex-direction</code>属性和<code>flex-wrap</code>属性的简写形式，默认值为<code>row nowrap</code>。</p><h2 id="2-4-justify-content"><a href="#2-4-justify-content" class="headerlink" title="2.4 justify-content"></a>2.4 justify-content</h2><p>定义了项目在主轴上的对齐方式。</p><p>它可能取5个值，具体对齐方式与轴的方向有关。下面假设主轴为从左到右。</p><blockquote><ul><li><code>flex-start</code>（默认值）：左对齐</li></ul></blockquote><blockquote><ul><li><code>flex-end</code>：右对齐</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195131.png" style="zoom:33%;" /><blockquote><ul><li><code>center</code>： 居中</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195153.png" style="zoom:33%;" /><blockquote><ul><li><code>space-between</code>：两端对齐，项目之间的间隔都相等。</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195227.png" style="zoom:33%;" /><blockquote><ul><li><code>space-around</code>：每个项目两侧的间隔相等。所以，项目之间的间隔比项目与边框的间隔大一倍</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195340.png" style="zoom:33%;" /><h2 id="2-5-align-items"><a href="#2-5-align-items" class="headerlink" title="2.5 align-items"></a>2.5 align-items</h2><p>定义项目在交叉轴上如何对齐</p><blockquote><ul><li><code>flex-start</code>：交叉轴的起点对齐。</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195559.png" style="zoom:33%;" /><blockquote><ul><li><code>flex-end</code>：交叉轴的终点对齐。</li></ul></blockquote><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529195624.png" style="zoom:33%;" /><blockquote><ul><li><code>center</code>：交叉轴的中点对齐。</li></ul></blockquote><img src="/Users/yuroupan/Library/Application Support/typora-user-images/image-20220529195658432.png" alt="image-20220529195658432" style="zoom:33%;" /><p><strong>当把<code>justify-content</code>和<code>align-items</code> 都设置为<code>center</code>, 项目将会水平垂直居中</strong></p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529200655.png" style="zoom:33%;" /><blockquote><ul><li><code>baseline</code>: 项目的第一行文字的基线对齐。</li><li><code>stretch</code>（默认值）：如果项目未设置高度或设为auto，将占满整个容器的高度。</li></ul></blockquote><h2 id="2-6-align-content"><a href="#2-6-align-content" class="headerlink" title="2.6 align-content"></a>2.6 align-content</h2><p>定义了多根轴线的对齐方式。如果项目只有一根轴线，该属性不起作用。</p><p>该属性可能取6个值。</p><blockquote><ul><li><code>flex-start</code>：与交叉轴的起点对齐。</li><li><code>flex-end</code>：与交叉轴的终点对齐。</li><li><code>center</code>：与交叉轴的中点对齐。</li><li><code>space-between</code>：与交叉轴两端对齐，轴线之间的间隔平均分布。</li><li><code>space-around</code>：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。</li><li><code>stretch</code>（默认值）：轴线占满整个交叉轴。</li></ul></blockquote><h1 id="3-项目的属性"><a href="#3-项目的属性" class="headerlink" title="3 项目的属性"></a>3 项目的属性</h1><h2 id="3-1-order"><a href="#3-1-order" class="headerlink" title="3.1 order"></a>3.1 order</h2><ul><li><code>order</code>属性定义项目的排列顺序。数值越小，排列越靠前，默认为0。</li></ul><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/20220529201004.png" style="zoom:33%;" /><ul><li><p><code>flex-grow</code>属性定义项目的放大比例，默认为<code>0</code>，即如果存在剩余空间，也不放大。</p><blockquote><p>如果所有项目的<code>flex-grow</code>属性都为1，则它们将等分剩余空间（如果有的话）。如果一个项目的<code>flex-grow</code>属性为2，其他项目都为1，则前者占据的剩余空间将比其他项多一倍。</p></blockquote></li><li><p><code>flex-shrink</code>属性定义了项目的缩小比例，默认为1，即如果空间不足，该项目将缩小。</p><blockquote><p>如果所有项目的<code>flex-shrink</code>属性都为1，当空间不足时，都将等比例缩小。如果一个项目的<code>flex-shrink</code>属性为0，其他项目都为1，则空间不足时，前者不缩小。</p></blockquote></li></ul><p>当把width改成了100，默认项目都会等比例缩小：</p><ul><li><p><code>align-self</code>属性允许单个项目有与其他项目不一样的对齐方式，可覆盖<code>align-items</code>属性。默认值为<code>auto</code>，表示继承父元素的<code>align-items</code>属性，如果没有父元素，则等同于<code>stretch</code>。</p><blockquote><p>该属性可能取6个值，除了auto，其他都与align-items属性完全一致。</p></blockquote></li></ul>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css flex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据库三大范式</title>
    <link href="/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%89%E5%A4%A7%E8%8C%83%E5%BC%8F/"/>
    <url>/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%89%E5%A4%A7%E8%8C%83%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="第一范式-确保每列保持原子性"><a href="#第一范式-确保每列保持原子性" class="headerlink" title="第一范式(确保每列保持原子性)"></a>第一范式(确保每列保持原子性)</h2><p>数据库表中的所有字段值都是不可分解的原子值。</p><ul><li>比如某些数据库系统中需要用到“地址”这个属性，本来直接将“地址”属性设计成一个数据库表的字段就行。</li><li>但是如果系统经常会访问“地址”属性中的“城市”部分，那么就非要将“地址”这个属性重新拆分为省份、城市、详细地址等多个部分进行存储，这样在对地址中某一部分操作的时候将非常方便。</li></ul><h2 id="第二范式-确保表中的每列都和主键相关"><a href="#第二范式-确保表中的每列都和主键相关" class="headerlink" title="第二范式(确保表中的每列都和主键相关)"></a>第二范式(确保表中的每列都和主键相关)</h2><p>第二范式需要确保数据库表中的每一列都和主键相关，而不能只与主键的某一部分相关（主要针对联合主键而言）。比如：</p><ul><li>订单信息表：订单编号，商品编号，商品名称，商品数量，商品单位，商品价格。联合主键为（订单编号，商品编号）</li><li>存在问题：<br>在该表中，商品名称、单位、商品价格等信息不与该表的主键相关，而仅仅是与商品编号相关。就需要单独存在另一张表里。而不应该在订单信息表里。</li><li>修正：<br>订单：订单编号，商品编号<br>商品：商品名称，商品数量，商品单位，商品价格</li></ul><h2 id="第三范式-确保每列都和主键列直接相关-而不是间接相关"><a href="#第三范式-确保每列都和主键列直接相关-而不是间接相关" class="headerlink" title="第三范式(确保每列都和主键列直接相关,而不是间接相关)"></a>第三范式(确保每列都和主键列直接相关,而不是间接相关)</h2><p>第三范式需要确保数据表中的每一列数据都和主键直接相关，而不能间接相关。比如：</p><ul><li>学生信息表：学号，姓名，年龄，所在学院，学院联系方式，学院地点。主键：学号</li><li>存在问题：<br>存在依赖传递：学号 → 学院 → (学院地点，学院联系方式)</li><li>修正：<br>学生信息表：学号，姓名，年龄，所在学院<br>学院信息表：学院，学院联系方式，学院地点<br><img src="/assets/16542362929459.jpg"></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hooks的使用</title>
    <link href="/hooks%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/hooks%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h1><p>案例效果：</p><ul><li>点击按钮，文本title修改</li><li>点击按钮，input聚焦<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> React, &#123; useRef, PureComponent &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestChild</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PureComponent</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>UseRefDemo<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    )<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UseRefDemo</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">const</span> titleRef = useRef()<br>  <span class="hljs-keyword">const</span> inputRef = useRef()<br>  <span class="hljs-keyword">const</span> testChild = useRef()<br>  <span class="hljs-keyword">return</span> (<br>    <span class="xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>UseRefDemo<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>= <span class="hljs-string">&#123;titleRef&#125;</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span> = <span class="hljs-string">&#123;inputRef&#125;</span> <span class="hljs-attr">type</span> = <span class="hljs-string">&quot;text&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">input</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> changeDom()&#125;&gt;按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">TestChild</span> <span class="hljs-attr">ref</span> = <span class="hljs-string">&#123;testChild&#125;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">TestChild</span>&gt;</span></span><br><span class="xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeDom</span>(<span class="hljs-params"></span>)</span>&#123;<br>    titleRef.current.innerHTML = <span class="hljs-string">&quot;改变后的title&quot;</span><br>    inputRef.current.focus()<br>    <span class="hljs-built_in">console</span>.log(testChild)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h261x90pltj20kc0cqmxn.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hook</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git修改指定的提交</title>
    <link href="/git%E4%BF%AE%E6%94%B9%E6%8C%87%E5%AE%9A%E7%9A%84%E6%8F%90%E4%BA%A4/"/>
    <url>/git%E4%BF%AE%E6%94%B9%E6%8C%87%E5%AE%9A%E7%9A%84%E6%8F%90%E4%BA%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="1-git修改指定的提交"><a href="#1-git修改指定的提交" class="headerlink" title="1.  git修改指定的提交"></a>1.  git修改指定的提交</h1><ul><li><code>git rebase --interactive &#39;cffa46f19811496d9165cf2c32250943f94f0099^&#39;</code></li><li>修改</li><li><code>git add .</code></li><li><code>git commit --amend</code></li><li><code>git rebase --continue</code></li></ul><h1 id="2-更新gitignore文件后，git删除仓库中的缓存"><a href="#2-更新gitignore文件后，git删除仓库中的缓存" class="headerlink" title="2. 更新gitignore文件后，git删除仓库中的缓存"></a>2. 更新gitignore文件后，git删除仓库中的缓存</h1><p><code>git rm -r --cached target/ </code></p>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react初体验</title>
    <link href="/react%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
    <url>/react%E5%88%9D%E4%BD%93%E9%AA%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="React是什么？"><a href="#React是什么？" class="headerlink" title="React是什么？"></a>React是什么？</h1><p>React 是一个声明式，高效且灵活的用于构建用户界面的 JavaScript 库。</p><blockquote><p>使用最原生的HTML、CSS、JavaScript可以构建完整的用户界面吗？当然可以，但是会存在很多问题</p><ul><li>操作DOM兼容性的问题；</li><li>过多兼容性代码的冗余问题；</li><li>代码组织和规范的问题；</li></ul></blockquote><h1 id="React的特点"><a href="#React的特点" class="headerlink" title="React的特点"></a>React的特点</h1><h2 id="声明式编程"><a href="#声明式编程" class="headerlink" title="声明式编程"></a>声明式编程</h2><ul><li>声明式编程是目前整个大前端开发的模式：Vue、React、Flutter、SwiftUI</li><li>它允许我们只需要维护自己的状态，当状态改变时，React可以根据最新的状态去渲染我们的UI界面；</li></ul><h2 id="组件化开发"><a href="#组件化开发" class="headerlink" title="组件化开发"></a>组件化开发</h2><ul><li>组件化开发页面目前前端的流行趋势</li></ul><h2 id="多平台适配"><a href="#多平台适配" class="headerlink" title="多平台适配"></a>多平台适配</h2><ul><li>2013年，React发布之初主要是开发Web页面</li><li>2015年，Facebook推出了ReactNative，用于开发移动端跨平台（虽然目前Flutter非常火爆，但是还是有很多公司在使用ReactNative）</li><li>2017年，Facebook推出ReactVR，用于开发虚拟现实Web应用程序</li></ul><h2 id="react-开发依赖"><a href="#react-开发依赖" class="headerlink" title="react 开发依赖"></a>react 开发依赖</h2><h3 id="开发React必须依赖三个库："><a href="#开发React必须依赖三个库：" class="headerlink" title="开发React必须依赖三个库："></a>开发React必须依赖三个库：</h3><ul><li>react：包含react所必须的核心代码</li><li>react-dom：react渲染在不同平台所需要的核心代码</li><li>babel：将jsx转换成React代码的工具</li></ul><h2 id="如何引入"><a href="#如何引入" class="headerlink" title="如何引入"></a>如何引入</h2><ul><li>cdn引入</li><li>下载后，添加本地依赖</li><li>npm依赖（脚手架使用）</li></ul><h2 id="认识Babel"><a href="#认识Babel" class="headerlink" title="认识Babel"></a>认识Babel</h2><ul><li>babel是目前前端使用非常广泛的编辑器、转移器。</li><li>比如当下很多浏览器并不支持ES6的语法，但是确实ES6的语法非常的简洁和方便，我们开发时希望使用它。</li><li>那么编写源码时我们就可以使用ES6来编写，之后通过Babel工具，将ES6转成大多数浏览器都支持的ES5的语法。</li></ul><blockquote><p>React和Babel的关系：</p><ul><li>默认情况下开发React其实可以不使用babel。</li><li>但是前提是我们自己使用React.createElement来编写源代码，它编写的代码非常的繁琐和可读性差。</li><li>那么我们就可以直接编写jsx（JavaScriptXML）的语法，并且让babel帮助我们转换成React.createElement。</li></ul></blockquote><h1 id="Hello-world案例"><a href="#Hello-world案例" class="headerlink" title="Hello world案例"></a>Hello world案例</h1><ul><li>这里我们编写React的script代码中，必须添加type&#x3D;”text&#x2F;babel”，作用是可以让babel解析jsx的语法</li><li>ReactDOM.render函数：<ul><li>参数一：传递要渲染的内容，这个内容可以是HTML元素，也可以是React的组件</li><li>参数二：将渲染的内容，挂载到哪一个HTML元素上</li></ul></li><li>通过{}语法来引入外部的变量或者表达式</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;body&gt;<br>  &lt;!--添加react 依赖--&gt;<br>  &lt;!-- <span class="hljs-comment">// crossorigin 将远程js的一些错误，显示到本地 --&gt;</span><br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://unpkg.com/react@17/umd/react.development.js&quot;</span> <span class="hljs-attr">crossorigin</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://unpkg.com/react-dom@17/umd/react-dom.development.js&quot;</span> <span class="hljs-attr">crossorigin</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://unpkg.com/babel-standalone@6/babel.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span>【内容会被覆盖】<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/babel&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="javascript"><span class="xml">  <span class="hljs-comment">// render（渲染的内容，挂载的位置）</span></span></span><br><span class="javascript"><span class="xml">  <span class="hljs-comment">// ReactDOM.render(&lt;h2&gt;hello World&lt;/h2&gt;,document.getElementById(&quot;app&quot;))</span></span></span><br><span class="javascript"><span class="xml"></span></span><br><span class="javascript"><span class="xml">  <span class="hljs-keyword">let</span> message = <span class="hljs-string">&quot;hello world&quot;</span></span></span><br><span class="javascript"><span class="xml">  ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>&#123;message&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>,<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;app&quot;</span>))</span></span><br><span class="javascript"><span class="xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>&lt;/body&gt;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233834887.png" alt="image-20230228233834887"></p><h1 id="HelloReact–-组件化开发"><a href="#HelloReact–-组件化开发" class="headerlink" title="HelloReact– 组件化开发"></a>HelloReact– 组件化开发</h1><ul><li>这里我们暂时使用类的方式封装组件：<ul><li>1.定义一个类（类名大写，组件的名称是必须大写的，小写会被认为是HTML元素），继承自React.Component</li><li>2.实现当前组件的render函数。render当中返回的jsx内容，就是之后React会帮助我们渲染的内容</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script type=<span class="hljs-string">&quot;text/babel&quot;</span>&gt;<br> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>   <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-keyword">return</span> (<br>        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br>     )<br>   &#125;<br> &#125;<br> ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;app&quot;</span>))<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h2 id="组件化-数据依赖"><a href="#组件化-数据依赖" class="headerlink" title="组件化 - 数据依赖"></a>组件化 - 数据依赖</h2><ul><li>组件中的数据，我们可以分成两类：<ul><li>参与界面更新的数据：当数据变量时，需要更新组件渲染的内容</li><li>不参与界面更新的数据：当数据变量时，不需要更新将组建渲染的内容</li></ul></li><li>参与界面更新的数据我们也可以称之为是参与数据流，这个数据是定义在当前对象的state中<ul><li>我们可以通过在构造函数中this.state&#x3D;{定义的数据}</li><li>当我们的数据发生变化时，我们可以调用this.setState来更新数据，并且通知React进行update操作。</li><li>在进行update操作时，就会重新调用render函数，并且使用最新的数据，来渲染界面</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs react">class App extends React.Component &#123;<br>  constructor()&#123;<br>    super()<br>    this.state = &#123;<br>     message: &quot;hello world&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="组件化-–-事件绑定"><a href="#组件化-–-事件绑定" class="headerlink" title="组件化 – 事件绑定"></a>组件化 – 事件绑定</h2><ul><li><p>在类中直接定义一个函数，并且将这个函数绑定到html原生的onClick事件上，当前这个函数的this指向默认情况下是undefined</p><ul><li>因为在正常的DOM操作中，监听点击，监听函数中的this其实是节点对象（比如说是button对象）；</li><li>React并不是直接渲染成真实的DOM，我们所编写的button只是一个语法糖，它的本质React的Element对象；</li></ul></li><li><p>我们在绑定的函数中，可能想要使用当前对象，比如执行this.setState函数，就必须拿到当前对象的this</p><ul><li><p>我们就需要在传入函数时，给这个函数直接绑定this</p></li><li><p>类似于下面的写法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs react">&lt;button onClick=&#123;this.btnClick.bind(this)&#125;&gt;改变文本&lt;/button&gt;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h1 id="电影列表案例"><a href="#电影列表案例" class="headerlink" title="电影列表案例"></a>电影列表案例</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script type=<span class="hljs-string">&quot;text/babel&quot;</span>&gt;<br> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>   <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-built_in">super</span>()<br>     <span class="hljs-built_in">this</span>.state = &#123;<br>      <span class="hljs-attr">movies</span>: [<span class="hljs-string">&quot;大话西游&quot;</span>, <span class="hljs-string">&quot;开心农场&quot;</span>]<br>     &#125;<br>   &#125;<br>   <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-keyword">return</span> (<br>       <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>电影列表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="xml">          &#123;</span><br><span class="xml">            this.state.movies.map((item, index)=&gt;&#123;</span><br><span class="xml">            return (<span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>&#123;item&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)</span><br><span class="xml">            &#125;)</span><br><span class="xml">          &#125;</span><br><span class="xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="xml">       <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>     )<br>   &#125;<br> &#125;<br> ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;app&quot;</span>))<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233846219.png" alt="image-20230228233846219"></p><h1 id="计数器案例"><a href="#计数器案例" class="headerlink" title="计数器案例"></a>计数器案例</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script type=<span class="hljs-string">&quot;text/babel&quot;</span>&gt;<br> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br>   <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-built_in">super</span>()<br>     <span class="hljs-built_in">this</span>.state = &#123;<br>      <span class="hljs-attr">count</span>: <span class="hljs-number">0</span><br>     &#125;<br>   &#125;<br>   <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-keyword">return</span> (<br>       <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前计数:&#123;this.state.count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span> = <span class="hljs-string">&#123;this.incr.bind(this)&#125;</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span> = <span class="hljs-string">&#123;this.decr.bind(this)&#125;</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="xml">       <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>     )<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-title">incr</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-built_in">this</span>.setState(&#123;<br>       <span class="hljs-attr">count</span>: <span class="hljs-built_in">this</span>.state.count + <span class="hljs-number">1</span><br>     &#125;)<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-title">decr</span>(<span class="hljs-params"></span>)</span>&#123;<br>     <span class="hljs-built_in">this</span>.setState(&#123;<br>       <span class="hljs-attr">count</span>: <span class="hljs-built_in">this</span>.state.count - <span class="hljs-number">1</span><br>     &#125;)<br>   &#125;<br><br> &#125;<br> ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;app&quot;</span>))<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233857215.png" alt="image-20230228233857215"></p><p>2ED3-DF39</p>]]></content>
    
    
    <categories>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>概念</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>重构-改善代码已有的设计</title>
    <link href="/%E9%87%8D%E6%9E%84-%E6%94%B9%E5%96%84%E4%BB%A3%E7%A0%81%E5%B7%B2%E6%9C%89%E7%9A%84%E8%AE%BE%E8%AE%A1/"/>
    <url>/%E9%87%8D%E6%9E%84-%E6%94%B9%E5%96%84%E4%BB%A3%E7%A0%81%E5%B7%B2%E6%9C%89%E7%9A%84%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>如果没有单元测试和重构，我没办法写代码</p></blockquote><h1 id="1-重构的意义"><a href="#1-重构的意义" class="headerlink" title="1 重构的意义"></a>1 重构的意义</h1><ul><li>保持代码易读、易修改</li><li>避免代码太复杂，无法理解，无法调试。（或许一个修改只需要10分钟，但是你得花费1个小时去理解这段代码</li><li>如果没有良好设计，或许某一段时间内你的进展迅速，但恶劣的设计很快就让你的速度慢下来。你会把时间花在 调试上面，无法添加新功能。修改时间越来越长，因为你必须花越来越多的时间去理解系统。</li></ul><h1 id="2-重构的定义"><a href="#2-重构的定义" class="headerlink" title="2 重构的定义"></a>2 重构的定义</h1><p>在不改变代码外在行为的前提下，对代码做出修改，以改进程序的内部结构。</p><h1 id="3-重构的前提"><a href="#3-重构的前提" class="headerlink" title="3 重构的前提"></a>3 重构的前提</h1><p><strong>为即将修改的代码建立一组可靠的测试环境。</strong></p><ul><li>因为尽管遵循重构手法可以使我避免绝大多数引入bug的情形，但我毕竟是人，毕竟有可能犯错。所以我需要可靠的测试。</li></ul><blockquote><p>好的测试是重构的根本。</p></blockquote><h1 id="4-何时重构"><a href="#4-何时重构" class="headerlink" title="4 何时重构"></a>4 何时重构</h1><h2 id="4-1-添加新功能时重构"><a href="#4-1-添加新功能时重构" class="headerlink" title="4.1 添加新功能时重构"></a>4.1 添加新功能时重构</h2><ul><li><p>此时，重构的直接原因往往是为了帮助我理解 需要修改的代码——这些代码可能是别人写的，也可能是我自己写的。</p></li><li><p>无论何时，只要我想理解代码所做的事，我就会问自己：是否能对这段代码进行重构，使我能更快地理解它。然后我就会重构。</p></li><li><p>之所以这么做，部分原因是为了让我下次再看这段代码时容易理解，但最主要的原因是：如果在前进过程中把代码结构理清，我就可以从中理解更多东西</p></li></ul><h2 id="4-2-复审代码时重构"><a href="#4-2-复审代码时重构" class="headerlink" title="4.2 复审代码时重构"></a>4.2 复审代码时重构</h2><p>这种活动有助于在开发团队中传 播知识，也有助于让较有经验的开发者把知识传递给比较欠缺经验的人，并帮助更多人理解大型软件系统中的更多部分。</p><h2 id="4-3-修补错误时重构"><a href="#4-3-修补错误时重构" class="headerlink" title="4.3 修补错误时重构"></a>4.3 修补错误时重构</h2><p>代码还够清晰——没有清晰到让你能一眼看出bug。</p><h1 id="5-代码坏味道"><a href="#5-代码坏味道" class="headerlink" title="5 代码坏味道"></a>5 代码坏味道</h1><h2 id="5-1-命名规范"><a href="#5-1-命名规范" class="headerlink" title="5.1 命名规范"></a>5.1 命名规范</h2><h3 id="错误方式"><a href="#错误方式" class="headerlink" title="错误方式"></a>错误方式</h3><ul><li><p>单词拼写错误</p></li><li><p>自己创造缩写   </p></li><li><p>使用技术术语命名</p><ul><li><p>如：userList , idList</p></li><li><p>编程的一个重要原则是面向接口编程。即接口是稳定的，实现是易变的。</p></li><li><p>假设这里我现在需要的是一个不重复的作品集合，也就是说这里需要把List改成Set，变量类型一定会改，但是你不一定会记得改变量名，一旦遗忘，就会出现一个bookList变量，它的类型是set,就会产生混淆。</p></li></ul></li><li><p>命名中的不一致。</p></li></ul><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><ul><li>命名要有业务含义</li><li>建立团队的词汇表，让团队成员有信息可以参考。</li><li>制定代码规范，比如，类名要用名词，函数名要用动词或动宾短语；</li><li>符合英语语法规则</li><li>类似含义的代码应该有一致的名字，一旦出现了不一致的名字，通常都表示不同的含义</li></ul><h2 id="5-2-Duplicated-Code（重复代码）"><a href="#5-2-Duplicated-Code（重复代码）" class="headerlink" title="5.2 Duplicated Code（重复代码）"></a>5.2 Duplicated Code（重复代码）</h2><ul><li>复制粘贴的代码</li><li>部分重复</li><li>if 和 else 代码块中的语句高度类似。</li></ul><h3 id="优化-1"><a href="#优化-1" class="headerlink" title="优化"></a>优化</h3><ul><li><p>抽方法</p></li><li><p>Template Method（模版方法）： 在一个方法中定义一个算法的骨架，而将一些步骤延迟到子类中</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">createOrder</span><span class="hljs-params">()</span> </span>&#123;<br>    check();<br>    calculate();<br>    pay();<br>    log();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>让 if 语句做真正的选择</li></ul><h2 id="5-3-Long-Method（过长函数）"><a href="#5-3-Long-Method（过长函数）" class="headerlink" title="5.3 Long Method（过长函数）"></a>5.3 <strong>Long Method</strong>（过长函数）</h2><h3 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h3><ul><li><p>把代码平铺直叙地摊在那里</p></li><li><p>一次加一点</p></li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li><p>程序愈长愈难理解</p></li><li><p>把多个业务处理流程放在一个函数里实现；</p></li><li><p>把不同层面的细节放到一个函数里实现。</p></li></ul><h3 id="优化-2"><a href="#优化-2" class="headerlink" title="优化"></a>优化</h3><ul><li>如果代码前方有一行注释，就是在提醒你：可以将这段代码替换成一个函数，而且可以在注释的基础上给这个函数命名。就算只有一行代码，如果它需要以注释来说明，那也值得将它提炼到独立函数去。</li><li>循环常常也是提炼的信号。你应该将循环和其内的代码提炼到一个独立函数中。</li><li>建议30 行，idea屏可以看得完</li></ul><h2 id="5-4-Large-Class（过大的类）"><a href="#5-4-Large-Class（过大的类）" class="headerlink" title="5.4 Large Class（过大的类）"></a>5.4 Large Class（过大的类）</h2><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><p>类内如果有太多代码，也是代码重复、混乱并最终走向死亡的源头</p><h3 id="优化-3"><a href="#优化-3" class="headerlink" title="优化"></a>优化</h3><ul><li>类的职责保证单一</li><li>字段未分组。比如，userId、name、nickname 几项，算是用户的基本信息，而 email、phoneNumber 这些则属于用户的联系方式</li></ul><h2 id="5-5-Long-Parameter-List（过长参数列）"><a href="#5-5-Long-Parameter-List（过长参数列）" class="headerlink" title="5.5 Long Parameter List（过长参数列）"></a>5.5 Long Parameter List（过长参数列）</h2><h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><ul><li>太长的参数列难以理解，太多参数会造成前后不一致、不易使用</li><li>如果有多个重载方法，参数很多的话，有时候你都不知道调哪个</li></ul><h3 id="优化-4"><a href="#优化-4" class="headerlink" title="优化"></a>优化</h3><ul><li>将参数封装成结构或者类</li></ul><h2 id="5-6-Shotgun-Surgery（霰弹式修改）"><a href="#5-6-Shotgun-Surgery（霰弹式修改）" class="headerlink" title="5.6 Shotgun Surgery（霰弹式修改）"></a>5.6 Shotgun Surgery（霰弹式修改）</h2><h3 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h3><ul><li>每遇到某种变化，你都必须在许多不同的类内做出许多小修改，你不但很难找到它们，也很容易忘记某个重要的修改。</li></ul><h3 id="优化-5"><a href="#优化-5" class="headerlink" title="优化"></a>优化</h3><ul><li>把所有需要修改的代码放进同一个类</li></ul><h3 id="5-7-Data-Clumps（数据泥团）"><a href="#5-7-Data-Clumps（数据泥团）" class="headerlink" title="5.7 Data Clumps（数据泥团）"></a>5.7 Data Clumps（数据泥团）</h3><p>数据泥团指的是经常一起出现的数据， 比如：</p><ul><li>两个类中相同的字段</li><li>多个函数签名中相同的参数</li></ul><h3 id="优化-6"><a href="#优化-6" class="headerlink" title="优化"></a>优化</h3><ul><li>提炼到一个独立对象</li></ul><h2 id="5-8-Switch-Statements（switch惊悚现身）"><a href="#5-8-Switch-Statements（switch惊悚现身）" class="headerlink" title="5.8  Switch Statements（switch惊悚现身）"></a>5.8  Switch Statements（switch惊悚现身）</h2><ul><li>少用switch（或case）语句</li></ul><h3 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h3><ul><li>switch语句的问题在于重复。你常会发现同样的switch语句散布于不同地点。</li><li>如果要为它添加一个新的case子句，就必须找到所有switch语句并修改它们</li></ul><h3 id="优化-7"><a href="#优化-7" class="headerlink" title="优化"></a>优化</h3><ul><li><p>构建map</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">function <span class="hljs-title">getDeliverResult</span><span class="hljs-params">(status)</span> </span>&#123;<br>  <span class="hljs-keyword">switch</span> (status) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;待发货&#x27;</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已发货&#x27;</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">const</span> orderStatus = <span class="hljs-keyword">new</span> Map()<br>    .set(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;待发货&#x27;</span>)<br>    .set(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;已发货&#x27;</span>)<br>    .set(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;已完成&#x27;</span>);<br> <br><span class="hljs-function">function <span class="hljs-title">getOrderStatus</span><span class="hljs-params">(statusCode)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> orderStatus.get(statusCode) || [];<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>多态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">double</span> result = <span class="hljs-number">0</span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ChargeFor</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-keyword">switch</span>(PriceCode)&#123;<br><span class="hljs-keyword">case</span> Movie.REGULAR:<br>result = (<span class="hljs-keyword">new</span> RegularPrice()).ChargeFor(daysRented)<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Movie.REGULAR:<br>result += daysRented * <span class="hljs-number">3</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Movie.CHILDRENS:<br>result += <span class="hljs-number">1.5</span>;<br><span class="hljs-keyword">if</span> (daysRented &gt; <span class="hljs-number">3</span>)<br>result += (daysRented - <span class="hljs-number">3</span>) * <span class="hljs-number">1.5</span>;<br><span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MovieBase</span> </span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ChargeFor</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RegularMovie</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MovieBase</span></span>&#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ChargeFor</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RegularPrice()).ChargeFor(daysRented);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="5-9-过深的if-else嵌套"><a href="#5-9-过深的if-else嵌套" class="headerlink" title="5.9 过深的if else嵌套"></a>5.9 过深的if else嵌套</h2><p>圈复杂度不能超过6，3个if else</p><h3 id="缺点-5"><a href="#缺点-5" class="headerlink" title="缺点"></a>缺点</h3><ul><li>看起来很复杂</li></ul><h3 id="优化-8"><a href="#优化-8" class="headerlink" title="优化"></a>优化</h3><ul><li>抽方法</li><li>使用多态</li></ul><h2 id="5-10-过多的注释"><a href="#5-10-过多的注释" class="headerlink" title="5.10 过多的注释"></a>5.10 过多的注释</h2><h3 id="缺点-6"><a href="#缺点-6" class="headerlink" title="缺点"></a>缺点</h3><p>很多注释的存在是因为代码很糟糕</p><h3 id="优化-9"><a href="#优化-9" class="headerlink" title="优化"></a>优化</h3><ul><li><p>方法函数、变量的<strong>命名要规范、浅显易懂</strong>、避免用注释解释代码。</p></li><li><p><strong>关键、复杂的业务</strong>，使用<strong>清晰、简明</strong>的注释</p></li></ul><h2 id="5-11-magic变量"><a href="#5-11-magic变量" class="headerlink" title="5.11 magic变量"></a>5.11 magic变量</h2><h3 id="缺点-7"><a href="#缺点-7" class="headerlink" title="缺点"></a>缺点</h3><ul><li>看了令人迷惑</li></ul><p>如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;3&quot;</span>.equals(emndVo.getStatus())) &#123;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (allId.size() &lt;= <span class="hljs-number">500</span>) <br></code></pre></td></tr></table></figure><h3 id="优化-10"><a href="#优化-10" class="headerlink" title="优化"></a>优化</h3><ul><li><strong>新建个常量</strong></li><li><strong>建一个枚举类</strong>，把相关的魔法数字放到一起管理。</li></ul><h2 id="5-12"><a href="#5-12" class="headerlink" title="5.12"></a>5.12</h2><h1 id="6-其他提升代码可读性的方式"><a href="#6-其他提升代码可读性的方式" class="headerlink" title="6 其他提升代码可读性的方式"></a>6 其他提升代码可读性的方式</h1><h3 id="6-1-Introduce-Explaining-Variable（引入解释性变量）"><a href="#6-1-Introduce-Explaining-Variable（引入解释性变量）" class="headerlink" title="6.1 Introduce Explaining Variable（引入解释性变量）"></a>6.1 Introduce Explaining Variable（引入解释性变量）</h3><ul><li>将该复杂表达式（或其中一部分）的结果放进一个临时变量，以此变量名称来解释表达式用途。</li><li>表达式有可能非常复杂而难以阅读。这种情况下，临时变量可以帮助你将表达式分解为比较容易管理的形式。</li></ul><h3 id="6-2-使用pair"><a href="#6-2-使用pair" class="headerlink" title="6.2 使用pair"></a>6.2 使用pair</h3><h1 id="7-构建单元测试"><a href="#7-构建单元测试" class="headerlink" title="7 构建单元测试"></a>7 构建单元测试</h1>]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>重构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react基础</title>
    <link href="/react%E5%9F%BA%E7%A1%80/"/>
    <url>/react%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="react组件基础"><a href="#react组件基础" class="headerlink" title="react组件基础"></a>react组件基础</h1><h2 id="组件概念"><a href="#组件概念" class="headerlink" title="组件概念"></a>组件概念</h2><ul><li>使用 React 可以将一些简短、独立的代码片段组合成复杂的 UI 界面，这些代码片段被称作“组件”。</li><li>所谓组件，即封装起来的具有独立功能的UI部件。组件就是页面上的一部分，大大小小的各种组件拼在一起就变成了一个完整的页面，就像我们玩的拼图，需要一块一块的拼接在一起才能变成一副完整的拼图。</li></ul><h2 id="函数组件"><a href="#函数组件" class="headerlink" title="函数组件"></a>函数组件</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>使用 JS 的函数（或箭头函数）创建的组件，就叫做<code>函数组件</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs react">function HelloComponent()&#123;<br>  return (<br>    &lt;div&gt;hello Componnet&lt;/div&gt;<br>  )<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>组件的名称<strong>必须首字母大写</strong>，react内部会根据这个来判断是组件还是普通的HTML标签</p></li><li><p>函数组件<strong>必须有返回值</strong>，表示该组件的 UI 结构；如果不需要渲染任何内容，则返回 null</p></li><li><p>组件就像 HTML 标签一样可以被渲染到页面中。组件表示的是一段结构内容，对于函数组件来说，渲染的内容是函数的<strong>返回值</strong>就是对应的内容</p></li><li><p>使用函数名称作为组件标签名称，可以成对出现也可以自闭合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs react">function App() &#123;<br>  return (<br>    &lt;div&gt;<br>    &lt;HelloComponent/&gt;<br>    &lt;HelloComponent&gt;&lt;/HelloComponent&gt;<br>    &lt;/div&gt;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="类组件"><a href="#类组件" class="headerlink" title="类组件"></a>类组件</h2><p>使用 ES6 的 class 创建的组件，叫做类（class）组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs react">class HelloComponent2 extends React.Component&#123;<br>  //必须有一个render方法<br>  //在这个方法里有return UI 结构<br>  render()&#123;<br>    return (<br>      &lt;div&gt;hello Componnet2&lt;/div&gt;<br>    )<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>类名称也必须以大写字母开头</strong></li><li>类组件应该继承 React.Component 父类，从而使用父类中提供的方法或属性</li><li>类组件必须提供 render 方法<strong>render 方法必须有返回值，表示该组件的 UI 结构</strong></li></ul><h2 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h2><p>react事件采用驼峰命名法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs react">// 事件触发函数组件<br>function EventDemoClass1()&#123;<br>  function handle()&#123;<br>    console.log(&quot;事件触发了EventDemoClass1&quot;)<br>  &#125;<br>  return (<br>    &lt;button onClick=&#123;handle&#125;&gt;事件触发函数组件&lt;/button&gt;<br>  )<br>&#125;<br><br><br>//事件触发类组件<br>class EventDemoClass2 extends React.Component&#123;<br>  clickHandler = () =&gt; &#123;<br>    console.log(&quot;事件触发了EventDemoClass2&quot;)<br>  &#125;<br>  render()&#123;<br>    return (<br>      &lt;div&gt;<br>        &lt;button onClick=&#123;this.clickHandler&#125;&gt;事件触发类组件&lt;/button&gt;<br>      &lt;/div&gt;<br>    )<br>  &#125;<br>&#125;<br><br>// 根组件<br>function App() &#123;<br>  return (<br>    &lt;div&gt;<br>      &lt;EventDemoClass1&gt;&lt;/EventDemoClass1&gt;<br>     &lt;EventDemoClass2&gt;&lt;/EventDemoClass2&gt;<br>    &lt;/div&gt;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>组件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>依赖混乱</title>
    <link href="/%E4%BE%9D%E8%B5%96%E6%B7%B7%E4%B9%B1/"/>
    <url>/%E4%BE%9D%E8%B5%96%E6%B7%B7%E4%B9%B1/</url>
    
    <content type="html"><![CDATA[<h1 id="依赖混乱"><a href="#依赖混乱" class="headerlink" title="依赖混乱"></a>依赖混乱</h1>]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>变量的初始化</title>
    <link href="/%E5%8F%98%E9%87%8F%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <url>/%E5%8F%98%E9%87%8F%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="变量初始化"><a href="#变量初始化" class="headerlink" title="变量初始化"></a>变量初始化</h1><blockquote><ul><li><p><strong>重构手法</strong></p><ul><li><p>变量初始化最好一次完成</p></li><li><blockquote><p>能用final的地方建议都用final，包括变量声明，参数声明，类声明，方法声明</p></blockquote></li></ul></li></ul></blockquote><h3 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">EpubStatus status = <span class="hljs-keyword">null</span>;<br>CreateEpubResponse response = createEpub(request);<br><span class="hljs-keyword">if</span> (response.getCode() == <span class="hljs-number">201</span>) &#123;<br>  status = EpubStatus.CREATED;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  status = EpubStatus.TO_CREATE;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>问题：第一行的初始化没有意义，他真正有值是在第4行或者第6行。也就是说声明变量后很久才赋值。变量初始化和业务混在了一起，我们只有在一大堆逻辑中抽丝剥茧，才可以知道变量是如何初始化的。</li><li>修正：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">final</span> CreateEpubResponse response = createEpub(request);<br><span class="hljs-keyword">final</span> EpubStatus status = toEpubStatus(response);<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> EpubStatus <span class="hljs-title">toEpubStatus</span><span class="hljs-params">(<span class="hljs-keyword">final</span> CreateEpubResponse response)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (response.getCode() == <span class="hljs-number">201</span>) &#123;<br>    <span class="hljs-keyword">return</span> EpubStatus.CREATED;<br>  &#125;<br>  <span class="hljs-keyword">return</span> EpubStatus.TO_CREATE;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="案例2（异常处理）"><a href="#案例2（异常处理）" class="headerlink" title="案例2（异常处理）"></a>案例2（异常处理）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">InputStream is = <span class="hljs-keyword">null</span>;<br><br><span class="hljs-keyword">try</span> &#123;<br>  is = <span class="hljs-keyword">new</span> FileInputStream(...);<br>  ...<br>&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>  ...<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>  <span class="hljs-keyword">if</span> (is != <span class="hljs-keyword">null</span>) &#123;<br>    is.close(); <br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里把is单独声明，是为了在finally里面可以访问到，在早期的版本只能写成这样，java7之后的版本，可以采用<code>try-with-resource</code></p><p>的写法，代码更加简洁。</p><p>修正：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> (InputStream is = <span class="hljs-keyword">new</span> FileInputStream(...)) &#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="案例3-集合初始化"><a href="#案例3-集合初始化" class="headerlink" title="案例3 集合初始化"></a>案例3 集合初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Locale, String&gt; CODE_MAPPING = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>...<br><br><br><span class="hljs-keyword">static</span> &#123;<br>  CODE_MAPPING.put(LOCALE.ENGLISH, <span class="hljs-string">&quot;EN&quot;</span>);<br>  CODE_MAPPING.put(LOCALE.CHINESE, <span class="hljs-string">&quot;CH&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>问题： 隔了很久后才向这个集合中添加元素，如果我们可以使用一次性声明的方式，这个static块是不需要的</p><p>修正：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Locale, String&gt; CODE_MAPPING = ImmutableMap.of(<br>  LOCALE.ENGLISH, <span class="hljs-string">&quot;EN&quot;</span>,<br>  LOCALE.CHINESE, <span class="hljs-string">&quot;CH&quot;</span><br>);<br></code></pre></td></tr></table></figure><blockquote><p>前者是命令式的代码，告诉你“怎么做”，比如先创建一个集合，集合中添加一个元素，再添加一个元素。</p><p>后者是声明式代码，告诉你“做什么”，比如我要一个包含了这两个元素的集合。</p></blockquote><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0xl4gnkf5j20u011vn0m.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>漫天飞的setter</title>
    <link href="/%E6%BC%AB%E5%A4%A9%E9%A3%9E%E7%9A%84setter/"/>
    <url>/%E6%BC%AB%E5%A4%A9%E9%A3%9E%E7%9A%84setter/</url>
    
    <content type="html"><![CDATA[<h1 id="漫天飞的setter"><a href="#漫天飞的setter" class="headerlink" title="漫天飞的setter"></a>漫天飞的setter</h1><blockquote><ul><li><strong>重构手法</strong>：<ul><li>方法封装在对应的模型中  </li><li>使用构造函数，移除设值函数。</li><li>编写不变类</li></ul></li></ul></blockquote><h3 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">approve</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> bookId)</span> </span>&#123;<br>  ...<br>  book.setReviewStatus(ReviewStatus.APPROVED);<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>问题：使用到了setter, setter往往是缺乏封装的一种做法。你不知道数据会在何时被哪里修改，造成结果是别人的改动可能会使你的代码崩溃，同时会有并发问题</li><li>修正：使用函数封装了setter方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">approve</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> bookId)</span> </span>&#123;<br>  ...<br>  book.approve();<br>  ...<br>&#125; <br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">approve</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.reviewStatus = ReviewStatus.APPROVED;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>进一步重构</strong></p><blockquote><p>重构手法：编写不变类</p></blockquote><p>改造之前的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">approve</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Book(..., ReviewStatus.APPROVED, ...);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="案例2"><a href="#案例2" class="headerlink" title="案例2"></a>案例2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Book book = <span class="hljs-keyword">new</span> Book();<br>book.setBookId(bookId);<br>book.setTitle(title);<br>book.setIntroduction(introduction);<br></code></pre></td></tr></table></figure><ul><li><p>问题：这种初始化的代码，压根没必要以setter的方式存在</p></li><li><p>修正：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Book book = <span class="hljs-keyword">new</span> Book(bookId, title, introduction);<br></code></pre></td></tr></table></figure></li></ul><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0um32zjp7j20u01560x5.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>过长的消息链和基本类型的偏执</title>
    <link href="/%E8%BF%87%E9%95%BF%E7%9A%84%E6%B6%88%E6%81%AF%E9%93%BE%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%81%8F%E6%89%A7/"/>
    <url>/%E8%BF%87%E9%95%BF%E7%9A%84%E6%B6%88%E6%81%AF%E9%93%BE%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%81%8F%E6%89%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="过长的消息链"><a href="#过长的消息链" class="headerlink" title="过长的消息链"></a>过长的消息链</h1><blockquote><p>想要摆脱初级程序员的水平，首先需要减少暴露细节</p></blockquote><blockquote><p>迪米特法则</p><ul><li>每个单元只能对与他有紧密关系的单元，拥有有限的知识</li><li>每个单元只能和朋友交谈，不与陌生人交谈</li><li>每个单元只能和自己最直接的朋友交谈</li></ul></blockquote><h2 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">String name = book.getAuthor().getName();<br></code></pre></td></tr></table></figure><p>修正方式：隐藏委托关系，即把调用封装起来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> </span>&#123;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAuthorName</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.author.getName();<br>  &#125;<br>  ...<br>&#125;<br><br><br>String name = book.getAuthorName();<br></code></pre></td></tr></table></figure><h1 id="基本类型偏执"><a href="#基本类型偏执" class="headerlink" title="基本类型偏执"></a>基本类型偏执</h1><blockquote><p> <strong>重构手法：以对象取代基本类型</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> highQuality, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> chapterSequence)</span> </span>&#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>问题：虽然价格是用浮点数在存储，但是价格和浮点数本身并不是同一个概念。</p><p><strong>需求1</strong>: </p><p>价格大于0，如果使用了double来存储，你会怎么限制呢？通常会这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (price &lt;= <span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Price should be positive&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这种校验会是很多场景都需要的，因此类似的逻辑需要大量去重复的写。</p><p>假设这里引入了price模型会是怎样呢？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Price</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> price;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Price</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> price)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (price &lt;= <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Price should be positive&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">this</span>.price = price;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这样校验就可以放在初始化的时候进行了。</p><blockquote><p>这种手法叫做对象取代基本模型。</p></blockquote><p><strong>需求2:</strong></p><p>假设我们希望价格对外只呈现2位。</p><p>没有price这个模型的话 ，依旧会是散布在代码的各个地方，一旦有了这个模型，代码就简单多了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDisplayPrice</span><span class="hljs-params">()</span> </span>&#123;<br>  BigDecimal decimal = <span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-keyword">this</span>.price)；<br>  <span class="hljs-keyword">return</span> decimal.setScale(<span class="hljs-number">2</span>, BigDecimal.ROUND_HALF_UP).doubleValue();<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0ulmqnc59j20u014cq73.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>滥用控制语句</title>
    <link href="/%E6%BB%A5%E7%94%A8%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/"/>
    <url>/%E6%BB%A5%E7%94%A8%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="避免滥用控制语句"><a href="#避免滥用控制语句" class="headerlink" title="避免滥用控制语句"></a>避免滥用控制语句</h1><blockquote><p><strong>函数至多有一行锁进</strong></p></blockquote><blockquote><p>不要用else关键字</p></blockquote><h2 id="代码多层嵌套"><a href="#代码多层嵌套" class="headerlink" title="代码多层嵌套"></a>代码多层嵌套</h2><h3 id="if和else"><a href="#if和else" class="headerlink" title="if和else"></a>if和else</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> highQuality, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> chapterSequence)</span> </span>&#123;<br>  <span class="hljs-keyword">double</span> price = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (highQuality &amp;&amp; chapterSequence &gt; START_CHARGING_SEQUENCE) &#123;<br>    price = <span class="hljs-number">4.99</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sequenceNumber &gt; START_CHARGING_SEQUENCE<br>        &amp;&amp; sequenceNumber &lt;= FURTHER_CHARGING_SEQUENCE) &#123;<br>    price = <span class="hljs-number">1.99</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sequenceNumber &gt; FURTHER_CHARGING_SEQUENCE) &#123;<br>    price = <span class="hljs-number">2.99</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    price = <span class="hljs-number">0.99</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> price;<br>&#125;<br></code></pre></td></tr></table></figure><p>修正：消除else，一个简单的做法就是让逻辑提前返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> highQuality, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> chapterSequence)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (highQuality &amp;&amp; chapterSequence &gt; START_CHARGING_SEQUENCE) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4.99</span>;<br>  &#125; <br>  <br>  <span class="hljs-keyword">if</span> (sequenceNumber &gt; START_CHARGING_SEQUENCE<br>        &amp;&amp; sequenceNumber &lt;= FURTHER_CHARGING_SEQUENCE) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1.99</span>;<br>  &#125; <br><br><br>  <span class="hljs-keyword">if</span> (sequenceNumber &gt; FURTHER_CHARGING_SEQUENCE) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2.99</span>;<br>  &#125; <br><br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0.99</span>;<br></code></pre></td></tr></table></figure><h2 id="重复的switch"><a href="#重复的switch" class="headerlink" title="重复的switch"></a>重复的switch</h2><p>之所以出现重复的switch，通常是缺少了模型，重构的方式是：<strong>以多态取代表达式</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> User user, <span class="hljs-keyword">final</span> Book book)</span> </span>&#123;<br>  <span class="hljs-keyword">double</span> price = book.getPrice();<br>  <span class="hljs-keyword">switch</span> (user.getLevel()) &#123;<br>    <span class="hljs-keyword">case</span> UserLevel.SILVER:<br>      <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.9</span>;<br>    <span class="hljs-keyword">case</span> UserLevel.GOLD: <br>      <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.8</span>;<br>    <span class="hljs-keyword">case</span> UserLevel.PLATINUM:<br>      <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.75</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">return</span> price;<br>  &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> User user, <span class="hljs-keyword">final</span> Epub epub)</span> </span>&#123;<br>  <span class="hljs-keyword">double</span> price = epub.getPrice();<br>  <span class="hljs-keyword">switch</span> (user.getLevel()) &#123;<br>    <span class="hljs-keyword">case</span> UserLevel.SILVER:<br>      <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.95</span>;<br>    <span class="hljs-keyword">case</span> UserLevel.GOLD: <br>      <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.85</span>;<br>    <span class="hljs-keyword">case</span> UserLevel.PLATINUM:<br>      <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.8</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">return</span> price;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修正：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserLevel</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(Book book)</span></span>;<br>  <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(Epub epub)</span></span>;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RegularUserLevel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserLevel</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Book book)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> book.getPrice();<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Epub epub)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> epub.getPrice();<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoldUserLevel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserLevel</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Book book)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> book.getPrice() * <span class="hljs-number">0.8</span>;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Epub epub)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> epub.getPrice() * <span class="hljs-number">0.85</span>;<br>  &#125;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilverUserLevel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserLevel</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Book book)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> book.getPrice() * <span class="hljs-number">0.9</span>;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Epub epub)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> epub.getPrice() * <span class="hljs-number">0.85</span>;<br>  &#125;<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlatinumUserLevel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserLevel</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Book book)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> book.getPrice() * <span class="hljs-number">0.75</span>;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Epub epub)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> epub.getPrice() * <span class="hljs-number">0.8</span>; <br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getBookPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> User user, <span class="hljs-keyword">final</span> Book book)</span> </span>&#123;<br>  UserLevel level = user.getUserLevel()<br>  <span class="hljs-keyword">return</span> level.getBookPrice(book);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getEpubPrice</span><span class="hljs-params">(<span class="hljs-keyword">final</span> User user, <span class="hljs-keyword">final</span> Epub epub)</span> </span>&#123;<br>  UserLevel level = user.getUserLevel()<br>  <span class="hljs-keyword">return</span> level.getEpubPrice(epub);<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0tg6oeum7j20u012242l.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>长参数列表</title>
    <link href="/%E9%95%BF%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8/"/>
    <url>/%E9%95%BF%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="消除长参数列表"><a href="#消除长参数列表" class="headerlink" title="消除长参数列表"></a>消除长参数列表</h1><ul><li><blockquote><p><strong>我们应该编写“短小”的代码</strong></p></blockquote></li><li><blockquote><p> <strong>参数列表越少，越好</strong></p></blockquote></li><li><blockquote><p>**一个方法的第一选择是没有参数，第二个选择是只有一个参数，稍次是两个参数。三个以上的参数简直无法忍受。 **– 代码整洁之道</p></blockquote></li></ul><h2 id="将参数列表封装成对象"><a href="#将参数列表封装成对象" class="headerlink" title="将参数列表封装成对象"></a>将参数列表封装成对象</h2><h3 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createBook</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String title, </span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> String introduction,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> URL coverUrl,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> BookType type,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> BookChannel channel,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> String protagonists,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> String tags,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> completed)</span> </span>&#123;<br>  ...<br>  Book book = Book.builder<br>    .title(title) <br>    .introduction(introduction)<br>    .coverUrl(coverUrl)<br>    .type(type)<br>    .channel(channel)<br>    .protagonists(protagonists)<br>    .tags(tags)<br>    .completed(completed)<br>    .build();<br>    <br>  <span class="hljs-keyword">this</span>.repository.save(book);<br>&#125;<br></code></pre></td></tr></table></figure><p>修正：</p><ul><li>增加一个封装类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewBookParamters</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> String title;<br>  <span class="hljs-keyword">private</span> String introduction;<br>  <span class="hljs-keyword">private</span> URL coverUrl;<br>  <span class="hljs-keyword">private</span> BookType type;<br>  <span class="hljs-keyword">private</span> BookChannel channel;<br>  <span class="hljs-keyword">private</span> String protagonists;<br>  <span class="hljs-keyword">private</span> String tags;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> completed;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createBook</span><span class="hljs-params">(<span class="hljs-keyword">final</span> NewBookParamters parameters)</span> </span>&#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="移除标记参数"><a href="#移除标记参数" class="headerlink" title="移除标记参数"></a>移除标记参数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">editChapter</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> chapterId, </span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-keyword">final</span> String title, </span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-keyword">final</span> String content, </span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> apporved)</span> </span>&#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>问题：前几个参数都是章节的必要信息，后面apporved是标记是否审核通过，这个参数其实是一个标记，标记后面的流程可能不同。</p><p>修正：这里我们可以将参数列表代表的不同路径拆分出来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">// 普通的编辑，需要审核</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">editChapter</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> chapterId, </span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-keyword">final</span> String title, </span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-keyword">final</span> String content)</span> </span>&#123;<br>  ...<br>&#125;<br><br><br><span class="hljs-comment">// 直接审核通过的编辑</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">editChapterWithApproval</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> chapterId,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-keyword">final</span> String title,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-keyword">final</span> String content)</span> </span>&#123;<br> ...<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0tf9jp9lvj20u014kq7o.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>避免写出难以理解的大类</title>
    <link href="/%E9%81%BF%E5%85%8D%E5%86%99%E5%87%BA%E9%9A%BE%E4%BB%A5%E7%90%86%E8%A7%A3%E7%9A%84%E5%A4%A7%E7%B1%BB%20/"/>
    <url>/%E9%81%BF%E5%85%8D%E5%86%99%E5%87%BA%E9%9A%BE%E4%BB%A5%E7%90%86%E8%A7%A3%E7%9A%84%E5%A4%A7%E7%B1%BB%20/</url>
    
    <content type="html"><![CDATA[<h2 id="避免写出难以理解的大类"><a href="#避免写出难以理解的大类" class="headerlink" title="避免写出难以理解的大类"></a>避免写出难以理解的大类</h2><ul><li>原因：一个人理解的东西是有限的，没人能面对所有的细节</li><li>大类的产生：<ul><li>职责不单一 </li><li>字段未分组</li></ul></li><li>操作要点：<strong>把类写小，越小越好</strong></li></ul><h3 id="案例1"><a href="#案例1" class="headerlink" title="案例1:"></a>案例1:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> userId;<br>  <span class="hljs-keyword">private</span> String name;<br>  <span class="hljs-keyword">private</span> String nickname;<br>  <span class="hljs-keyword">private</span> String email;<br>  <span class="hljs-keyword">private</span> String phoneNumber;<br>  <span class="hljs-keyword">private</span> AuthorType authorType;<br>  <span class="hljs-keyword">private</span> ReviewStatus authorReviewStatus;<br>  <span class="hljs-keyword">private</span> EditorType editorType;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>问题：userId,name这些是和用户关联的，后面的AuthorType，ReviewStatus，EditorType和用户信息无关</p><p>修正：AuthorType，ReviewStatus，EditorType和用户信息无关 拆成单独的类，通过userId去关联</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Author</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> userId;<br>  <span class="hljs-keyword">private</span> AuthorType authorType;<br>  <span class="hljs-keyword">private</span> ReviewStatus authorReviewStatus;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Editor</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> userId;<br>  <span class="hljs-keyword">private</span> EditorType editorType;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="案例2"><a href="#案例2" class="headerlink" title="案例2"></a>案例2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> userId;<br>  <span class="hljs-keyword">private</span> String name;<br>  <span class="hljs-keyword">private</span> String nickname;<br>  <span class="hljs-keyword">private</span> String email;<br>  <span class="hljs-keyword">private</span> String phoneNumber;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>问题：这个类中userId，name，nickname是属于用户的基本信息，而email，phoneNumber其实是属于用户的联系方式</p><p>修正：对字段进行分组，把email，phoneNumber放在单独的contact类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> userId;<br>  <span class="hljs-keyword">private</span> String name;<br>  <span class="hljs-keyword">private</span> String nickname;<br>  <span class="hljs-keyword">private</span> Contact contact;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Contact</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> String email;<br>  <span class="hljs-keyword">private</span> String phoneNumber;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0tekaz2v6j20u0144gow.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何精准命名</title>
    <link href="/%E4%BB%A3%E7%A0%81%E4%B9%8B%E4%B8%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/%E4%BB%A3%E7%A0%81%E4%B9%8B%E4%B8%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="如何精准命名"><a href="#如何精准命名" class="headerlink" title="如何精准命名"></a>如何精准命名</h1><h2 id="避免命名过于宽泛"><a href="#避免命名过于宽泛" class="headerlink" title="避免命名过于宽泛"></a>避免命名过于宽泛</h2><h3 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processChapter</span><span class="hljs-params">(<span class="hljs-keyword">long</span> chapterId)</span> </span>&#123;<br>  Chapter chapter = <span class="hljs-keyword">this</span>.repository.findByChapterId(chapterId);<br>  <span class="hljs-keyword">if</span> (chapter == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Unknown chapter [&quot;</span> + chapterId + <span class="hljs-string">&quot;]&quot;</span>);  <br>  &#125;<br>  <br>  chapter.setTranslationState(TranslationState.TRANSLATING);<br>  <span class="hljs-keyword">this</span>.repository.save(chapter);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>问题：命名过于宽泛，不能精准描述，只有阅读这段代码，才可以知道这段代码做了什么。</p></li><li><p>修正：具体到这里的业务，其实是把翻译状态改为了翻译中，是因为我们在这里开启了一个翻译过程，所以这段代码应该命名为satrtTranslation</p></li></ul><blockquote><p> 类似的：data,info,handle,build,maintain,modify等等，都是过于宽泛的名词</p></blockquote><blockquote><p>一个好的名字，应该描述意图，而不是细节。</p></blockquote><h2 id="避免使用技术术语命名"><a href="#避免使用技术术语命名" class="headerlink" title="避免使用技术术语命名"></a>避免使用技术术语命名</h2><h3 id="案例1-1"><a href="#案例1-1" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Book&gt; bookList = service.getBooks();<br></code></pre></td></tr></table></figure><ul><li>问题：这是一种基于实现的命名，编程的一个重要原则是面向接口编程。即接口是稳定的，实现是易变的。假设这里我现在需要的是一个不重复的作品集合，也就是说这里需要把List改成Set，变量类型一定会改，但是你不一定会记得改变量名，一旦遗忘，就会出现一个bookList变量，它的类型是set,就会产生混淆。</li><li>修正：这里要表达的是拿到一堆书，所以这个命名改为books。</li></ul><h3 id="案例2"><a href="#案例2" class="headerlink" title="案例2"></a>案例2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">getByIsbn</span><span class="hljs-params">(String isbn)</span> </span>&#123;<br>  Book cachedBook = redisBookStore.get(isbn);<br>  <span class="hljs-keyword">if</span> (cachedBook != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> cachedBook;<br>  &#125;<br>  <br>  Book book = doGetByIsbn(isbn);<br>  redisBookStore.put(isbn, book);<br>  <span class="hljs-keyword">return</span> book;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>问题：这段代码里直接出现了redis，通常来说这里真正需要的只是一个缓存，redi s只是一种实现</li></ul><blockquote><p>缓存只是一种技术术语，不应该出现在业务代码中</p></blockquote><blockquote><p>程序猿之所以喜欢用技术语言去命名，是因为程序员写代码很大程度上会参考别人写的代码，而行业里比较优秀的一些代码，往往是一些开源的技术项目。</p></blockquote><blockquote><p>在一个技术类项目里，这些技术术语其实就是他们的业务语言，但是在业务项目里，这个说法就要另当别论了。</p></blockquote><h2 id="避免违反语法规则的命名"><a href="#避免违反语法规则的命名" class="headerlink" title="避免违反语法规则的命名"></a>避免违反语法规则的命名</h2><h3 id="案例1-2"><a href="#案例1-2" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">completedTranslate</span><span class="hljs-params">(<span class="hljs-keyword">final</span> List&lt;ChapterId&gt; chapterIds)</span> </span>&#123;<br>  List&lt;Chapter&gt; chapters = repository.findByChapterIdIn(chapterIds);<br>  chapters.forEach(Chapter::completedTranslate);<br>  repository.saveAll(chapters); <br>&#125;<br></code></pre></td></tr></table></figure><p>问题：completedTranslate不是一个正常的英语函数名</p><p>修正: completeTranslation</p><blockquote><p>常见的命名规则是：类是一个名词，表示一个对象。方法名是一个动词或者是动宾短语，表示一个动作。</p></blockquote><p>另外还有两个常见的坏味道这里就不举例了。</p><ul><li>不准确的英语词汇（对于业务上会用到的一些名词，可以整个团队一起，建立一个业务词汇表，用集体的智慧）</li><li>单词拼写错误</li></ul><h2 id="用业务语言写代码"><a href="#用业务语言写代码" class="headerlink" title="用业务语言写代码"></a>用业务语言写代码</h2><h3 id="案例1-3"><a href="#案例1-3" class="headerlink" title="案例1"></a>案例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">approveChapter</span><span class="hljs-params">(<span class="hljs-keyword">long</span> chapterId, <span class="hljs-keyword">long</span> userId)</span> </span>&#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>问题：这个函数的意图是确认章节通过，chapterId是章节id，但是userId是什么？了解了背景才知道这里是需要记录下审核人的信息，这个userId就是审核人的userId，</p><p>修正：因为用户在这个场景下的身份是审核人，所以修改userId为reviewerUserId</p><blockquote><p>好的命名，是体现业务含义的命名。</p></blockquote><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0oruapf6nj20u012ggpo.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>代码之丑</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码坏味道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>excel读取操作</title>
    <link href="/excel%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C/"/>
    <url>/excel%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="excel-读取"><a href="#excel-读取" class="headerlink" title="excel 读取"></a>excel 读取</h1><h2 id="HSSF-03"><a href="#HSSF-03" class="headerlink" title="HSSF(03)"></a>HSSF(03)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRead03</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>  InputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(PATH+<span class="hljs-string">&quot;/excel写入.xls&quot;</span>);<br>  <span class="hljs-keyword">final</span> HSSFWorkbook workbook = <span class="hljs-keyword">new</span> HSSFWorkbook(inputStream);<br>  <span class="hljs-keyword">final</span> HSSFSheet sheet = workbook.getSheetAt(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">final</span> HSSFRow row = sheet.getRow(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">final</span> HSSFCell cell = row.getCell(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// 读取值的时候，一定要注意类型！！</span><br>  <span class="hljs-keyword">final</span> String cellValue = cell.getStringCellValue();<br>  System.out.println(cellValue);<br>  inputStream.close();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="XSSF-07"><a href="#XSSF-07" class="headerlink" title="XSSF(07)"></a>XSSF(07)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRead07</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>  InputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(PATH+<span class="hljs-string">&quot;/excel写入.xlsx&quot;</span>);<br>  <span class="hljs-keyword">final</span> XSSFWorkbook workbook = <span class="hljs-keyword">new</span> XSSFWorkbook(inputStream);<br>  <span class="hljs-keyword">final</span> XSSFSheet sheet = workbook.getSheetAt(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">final</span> XSSFRow row = sheet.getRow(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">final</span> XSSFCell cell = row.getCell(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">final</span> String cellValue = cell.getStringCellValue();<br>  System.out.println(cellValue);<br>  inputStream.close();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="读取不同类型的数据"><a href="#读取不同类型的数据" class="headerlink" title="读取不同类型的数据"></a>读取不同类型的数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCellType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>    InputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;/Users/panyurou/IdeaProjects/exceldemo/src/test/resources/明细表.xlsx&quot;</span>);<br>    <span class="hljs-keyword">final</span> XSSFWorkbook workbook = <span class="hljs-keyword">new</span> XSSFWorkbook(inputStream);<br>    <span class="hljs-comment">// 读取标题行</span><br>    <span class="hljs-keyword">final</span> XSSFSheet sheet = workbook.getSheetAt(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">final</span> XSSFRow headerRow = sheet.getRow(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> colCount = headerRow.getPhysicalNumberOfCells();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; colCount; i++) &#123;<br>      <span class="hljs-keyword">final</span> XSSFCell cell = headerRow.getCell(i);<br>      <span class="hljs-keyword">if</span>(cell != <span class="hljs-keyword">null</span>)&#123;<br>        <span class="hljs-keyword">final</span> String cellValue = cell.getStringCellValue();<br>        System.out.print(cellValue + <span class="hljs-string">&quot;|&quot;</span>);<br>      &#125;<br>    &#125;<br>    System.out.println();<br>    <span class="hljs-comment">// 读取内容</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> rowsCount = sheet.getPhysicalNumberOfRows();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; rowsCount; i++) &#123;<br>      <span class="hljs-keyword">final</span> XSSFRow row = sheet.getRow(i);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; colCount; j++) &#123;<br>        <span class="hljs-keyword">final</span> XSSFCell cell = row.getCell(j);<br>        <span class="hljs-keyword">if</span>(cell != <span class="hljs-keyword">null</span>)&#123;<br>          <span class="hljs-keyword">final</span> CellType cellType = cell.getCellType();<br>          String cellValue = getCellValue(cell, cellType);<br>          System.out.print(cellValue + <span class="hljs-string">&quot;|&quot;</span>);<br>        &#125;<br>      &#125;<br>      System.out.println();<br>    &#125;<br>    inputStream.close();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getCellValue</span><span class="hljs-params">(XSSFCell cell, CellType cellType)</span> </span>&#123;<br>    String cellValue = <span class="hljs-string">&quot;&quot;</span>;<br>     <span class="hljs-keyword">switch</span> (cellType)&#123;<br>      <span class="hljs-keyword">case</span> STRING:<br>        cellValue = cell.getStringCellValue();<br>         <span class="hljs-keyword">break</span>;<br>       <span class="hljs-keyword">case</span> NUMERIC:<br>         <span class="hljs-keyword">if</span>(DateUtil.isCellDateFormatted(cell))&#123;<br>           <span class="hljs-keyword">final</span> Date date = cell.getDateCellValue();<br>           cellValue = <span class="hljs-keyword">new</span> DateTime(date).toString(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>         &#125;<span class="hljs-keyword">else</span>&#123;<br>           cellValue = String.valueOf(cell.getNumericCellValue());<br>         &#125;<br>         <span class="hljs-keyword">break</span>;<br>       <span class="hljs-keyword">case</span> FORMULA:<br>        cellValue = cell.getCellFormula();<br>         <span class="hljs-keyword">break</span>;<br>       <span class="hljs-keyword">case</span> BOOLEAN:<br>        cellValue = String.valueOf(cell.getBooleanCellValue());<br>         <span class="hljs-keyword">break</span>;<br>       <span class="hljs-keyword">case</span> ERROR:<br>         System.out.println(<span class="hljs-string">&quot;类型错误&quot;</span>);<br>         <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> cellValue;<br>  &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>excel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>excel大数据量的写入</title>
    <link href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E7%9A%84%E5%86%99%E5%85%A5/"/>
    <url>/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E7%9A%84%E5%86%99%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="大数据量的写入"><a href="#大数据量的写入" class="headerlink" title="大数据量的写入"></a>大数据量的写入</h1><h2 id="HSSF-03版"><a href="#HSSF-03版" class="headerlink" title="HSSF(03版)"></a>HSSF(03版)</h2><ul><li><p>优点：过程中数据全部写入缓存，不操作磁盘，最后一次写入缓存，速度快</p></li><li><p>缺点：最多只能处理65536行，否则会抛出异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">Invalid row <span class="hljs-title">number</span> <span class="hljs-params">(<span class="hljs-number">65536</span>)</span> outside allowable <span class="hljs-title">range</span> <span class="hljs-params">(<span class="hljs-number">0.</span><span class="hljs-number">.65535</span>)</span></span><br><span class="hljs-function">java.lang.IllegalArgumentException: Invalid row <span class="hljs-title">number</span> <span class="hljs-params">(<span class="hljs-number">65536</span>)</span> outside allowable <span class="hljs-title">range</span> <span class="hljs-params">(<span class="hljs-number">0.</span><span class="hljs-number">.65535</span>)</span></span><br></code></pre></td></tr></table></figure></li></ul><h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p><strong>抛出异常测试</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExcelBigData</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String PATH = <span class="hljs-string">&quot;/Users/panyurou/IdeaProjects/exceldemo&quot;</span>;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">excelWrite03</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>    Workbook workbook = <span class="hljs-keyword">new</span> HSSFWorkbook();<br>    <span class="hljs-keyword">final</span> Sheet sheet = workbook.createSheet(<span class="hljs-string">&quot;测试大数据量&quot;</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> begin = System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">65537</span>; i++) &#123;<br>      <span class="hljs-keyword">final</span> Row row = sheet.createRow(i);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10</span>; j++) &#123;<br>        <span class="hljs-keyword">final</span> Cell cell = row.createCell(j);<br>        cell.setCellValue(<span class="hljs-string">&quot;$&#123;i,j&#125;&quot;</span>);<br>      &#125;<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;over!&quot;</span>);<br>    FileOutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(PATH + <span class="hljs-string">&quot;/excel大数据写入01.xls&quot;</span>);<br>    workbook.write(outputStream);<br>    outputStream.close();<br>    System.out.println(<span class="hljs-string">&quot;excel 写入完毕！&quot;</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;写入时间：&quot;</span>+(<span class="hljs-keyword">double</span>) ((end - begin) / <span class="hljs-number">1000</span>));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232505454.png" alt="image-20230228232505454"></p><p>将上面的65537改成65536，输出写入时长，可看出花费了1秒</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232512748.png" alt="image-20230228232512748"></p><h2 id="SXSSFWorkbook"><a href="#SXSSFWorkbook" class="headerlink" title="SXSSFWorkbook"></a>SXSSFWorkbook</h2><ul><li>优点：可以写非常大的数据量，写速度更快，占用更少的内存</li><li>注意：<ul><li>过程中会产生临时文件，需要清理临时文件</li><li>默认100条数据会被保留在内存中，如果超过这数量，则数据会被写入临时文件<ul><li>如果想自定义内存中的数量，可以使用<code>new SXSSFWorkbook(数量);</code></li></ul></li></ul></li></ul><h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">excelWriteSXSSF</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>    SXSSFWorkbook workbook = <span class="hljs-keyword">new</span> SXSSFWorkbook();<br>    <span class="hljs-keyword">final</span> Sheet sheet = workbook.createSheet(<span class="hljs-string">&quot;测试大数据量&quot;</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> begin = System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">65537</span>; i++) &#123;<br>      <span class="hljs-keyword">final</span> Row row = sheet.createRow(i);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">120</span>; j++) &#123;<br>        <span class="hljs-keyword">final</span> Cell cell = row.createCell(j);<br>        cell.setCellValue(<span class="hljs-string">&quot;$&#123;i,j&#125;&quot;</span>);<br>      &#125;<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;over!&quot;</span>);<br>    FileOutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(PATH + <span class="hljs-string">&quot;/excel大数据写入09s.xlsx&quot;</span>);<br>    workbook.write(outputStream);<br>    outputStream.close();<br>    <span class="hljs-comment">// 清除临时文件！！！</span><br>    workbook.dispose();<br>    System.out.println(<span class="hljs-string">&quot;excel 写入完毕！&quot;</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;写入时间：&quot;</span>+(<span class="hljs-keyword">double</span>) ((end - begin) / <span class="hljs-number">1000</span>));<br>  &#125;<br></code></pre></td></tr></table></figure><p>可以看出即使现在有120列，也只需要10秒，速度很快。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228232535340.png" alt="image-20230228232535340"></p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>excel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Excel基本写操作</title>
    <link href="/excel%E6%93%8D%E4%BD%9C/"/>
    <url>/excel%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="Excel基本写操作"><a href="#Excel基本写操作" class="headerlink" title="Excel基本写操作"></a>Excel基本写操作</h1><ul><li>引入依赖</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">implementation <span class="hljs-string">&#x27;org.apache.poi:poi:5.2.0&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExcelWrite</span> </span>&#123;<br>  <span class="hljs-comment">// 项目目录</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String PATH = <span class="hljs-string">&quot;/Users/panyurou/IdeaProjects/exceldemo&quot;</span>;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">excelWrite</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>    <span class="hljs-comment">//1.创建一个工作簿</span><br>    Workbook workbook = <span class="hljs-keyword">new</span> HSSFWorkbook();<br>    <span class="hljs-comment">//2.创建一个工作表</span><br>    Sheet sheet = workbook.createSheet(<span class="hljs-string">&quot;测试excel写入&quot;</span>);<br>    <span class="hljs-comment">//3.创建一行,第0行</span><br>    Row row1 = sheet.createRow(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//4.创建一个单元格</span><br>    Cell cell11 = row1.createCell(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//5.给单元格写入值</span><br>    cell11.setCellValue(<span class="hljs-string">&quot;我是单元格（1，1）&quot;</span>);<br><br>    <span class="hljs-comment">//6.创建新的一行,第1行</span><br>    Row row2 = sheet.createRow(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//7.创建一个单元格</span><br>    Cell cell21 = row2.createCell(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//8.给单元格写入值</span><br>    String time = <span class="hljs-keyword">new</span> DateTime().toString(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>    cell21.setCellValue(time);<br><br>    <span class="hljs-comment">//9.将创建好的工作簿写出</span><br>    FileOutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(PATH + <span class="hljs-string">&quot;/excel写入.xlsx&quot;</span>);<br>    workbook.write(outputStream);<br>    outputStream.close();<br>    System.out.println(<span class="hljs-string">&quot;excel 写入完毕！&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0gpje9k7lj20os0r6jt6.jpg" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>excel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch乐观并发控制</title>
    <link href="/ElasticSearch%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/"/>
    <url>/ElasticSearch%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Elasticsearch乐观并发控制"><a href="#Elasticsearch乐观并发控制" class="headerlink" title="Elasticsearch乐观并发控制"></a>Elasticsearch乐观并发控制</h1><p>Elasticsearch 中使用的这种乐观的方式假定冲突是不可能发生的，并且不会阻塞正在 尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。 </p><blockquote><p>在数据库领域中，有两种方法来确保并发更新，不会丢失数据： 分别为乐观和悲观</p></blockquote><h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>以创建一个文档为例 </p><p>step1: 创建文档</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /test1/_doc/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;Id&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三丰&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span> : <span class="hljs-string">&quot;test1&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span> : <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;result&quot;</span> : <span class="hljs-string">&quot;created&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;total&quot;</span> : <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span> : <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;_seq_no&quot;</span> : <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;_primary_term&quot;</span> : <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>使用if_seq_no&#x3D;版本值 &amp;if_primary_term&#x3D;文档位置进行并发版本控制</strong></p><ul><li><p>_seq_no：文档版本号，<strong>version属于当个文档，而seq_no属于整个index</strong></p></li><li><p>_primary_term：_primary_term也和_seq_no一样都是整数，每当Primary Shard发生重新分配时，比如重启，Primary选举等，_primary_term会递增1</p></li></ul><p>step2: 更新文档</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /test1/_update/<span class="hljs-number">1</span>/?if_seq_no=<span class="hljs-number">0</span>&amp;if_primary_term=<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三丰666&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span> : <span class="hljs-string">&quot;test1&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span> : <span class="hljs-number">2</span>,<br>  <span class="hljs-string">&quot;result&quot;</span> : <span class="hljs-string">&quot;updated&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;total&quot;</span> : <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span> : <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;_seq_no&quot;</span> : <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;_primary_term&quot;</span> : <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch文档映射</title>
    <link href="/ElasticSearch%E6%96%87%E6%A1%A3%E6%98%A0%E5%B0%84/"/>
    <url>/ElasticSearch%E6%96%87%E6%A1%A3%E6%98%A0%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h1 id="文档映射"><a href="#文档映射" class="headerlink" title="文档映射"></a>文档映射</h1><h2 id="映射类型"><a href="#映射类型" class="headerlink" title="映射类型"></a>映射类型</h2><p>ES中映射可以分为动态映射和静态映射 </p><h3 id="动态映射："><a href="#动态映射：" class="headerlink" title="动态映射："></a>动态映射：</h3><p>在关系数据库中，需要事先创建数据库，然后在该数据库下创建数据表，并创建 表字段、类型、长度、主键等，最后才能基于表插入数据。而Elasticsearch中不需要定义Mapping映射（即关系型数据库的表、字段等），在文档写入Elasticsearch时，会根据文档字段自动识别类型，这种机制称之为动态映射。 </p><p>动态映射规则如下： </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228233355466.png" alt="image-20230228233355466"></p><p><strong>操作示例</strong></p><ul><li>创建文档(ES根据数据类型, 会自动创建映射)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db1/_doc/<span class="hljs-number">32</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;王武&quot;</span>,<br>  <span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">28</span>,<br>  <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;remark&quot;</span>: <span class="hljs-string">&quot;java developer&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>获取文档映射</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">GET /es_db1/_mapping<br></code></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;es_db1&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;address&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;keyword&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;keyword&quot;</span>,<br>              <span class="hljs-string">&quot;ignore_above&quot;</span> : <span class="hljs-number">256</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;age&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;long&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;name&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;keyword&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;keyword&quot;</span>,<br>              <span class="hljs-string">&quot;ignore_above&quot;</span> : <span class="hljs-number">256</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;remark&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;keyword&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;keyword&quot;</span>,<br>              <span class="hljs-string">&quot;ignore_above&quot;</span> : <span class="hljs-number">256</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;sex&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;long&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="静态映射："><a href="#静态映射：" class="headerlink" title="静态映射："></a>静态映射：</h3><p>静态映射是在Elasticsearch中也可以事先定义好映射，包含文档的各字段类型、分词器等，这种方式称之为静态映射。 </p><p><strong>操作示例</strong></p><ul><li>创建索引和设置文档映射 <ul><li>index: 是否分词存储</li><li>store: 是否存储在库里</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">PUT /es_db4<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;name&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-keyword">true</span>,<br>        <span class="hljs-string">&quot;store&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;,<br>      <span class="hljs-string">&quot;sex&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-keyword">true</span>,<br>        <span class="hljs-string">&quot;store&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;,<br>      <span class="hljs-string">&quot;age&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-keyword">true</span>,<br>        <span class="hljs-string">&quot;store&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;,<br>      <span class="hljs-string">&quot;book&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-keyword">true</span>,<br>        <span class="hljs-string">&quot;store&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;,<br>      <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-keyword">true</span>,<br>        <span class="hljs-string">&quot;store&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;es_db4&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;address&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;store&quot;</span> : <span class="hljs-keyword">true</span><br>        &#125;,<br>        <span class="hljs-string">&quot;age&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;integer&quot;</span>,<br>          <span class="hljs-string">&quot;store&quot;</span> : <span class="hljs-keyword">true</span><br>        &#125;,<br>        <span class="hljs-string">&quot;book&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;store&quot;</span> : <span class="hljs-keyword">true</span><br>        &#125;,<br>        <span class="hljs-string">&quot;name&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;keyword&quot;</span>,<br>          <span class="hljs-string">&quot;store&quot;</span> : <span class="hljs-keyword">true</span><br>        &#125;,<br>        <span class="hljs-string">&quot;sex&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span> : <span class="hljs-string">&quot;integer&quot;</span>,<br>          <span class="hljs-string">&quot;store&quot;</span> : <span class="hljs-keyword">true</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>根据静态映射创建文档</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">PUT /es_db/_doc/<span class="hljs-number">4</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jack&quot;</span>,<br>  <span class="hljs-string">&quot;sex&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span>,<br>  <span class="hljs-string">&quot;book&quot;</span>: <span class="hljs-string">&quot;elasticSearch入门至精通&quot;</span>,<br>  <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州车陂&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>获取文档映射</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/es_db4/</span>_mapping<br></code></pre></td></tr></table></figure><h2 id="文档核心类型（Core-datatype）"><a href="#文档核心类型（Core-datatype）" class="headerlink" title="文档核心类型（Core datatype）"></a>文档核心类型（Core datatype）</h2><h3 id="类型分类"><a href="#类型分类" class="headerlink" title="类型分类"></a>类型分类</h3><ul><li>字符串：string，string类型包含 text 和 keyword。 </li><li>text：该类型被用来索引长文本，在创建索引前会将这些文本进行分词，转化为词的组合，建立索引；允许es来检索这些词，text类型不能用来排序和聚合。</li><li>keyword：该类型不能分词，可以被用来检索过滤、排序和聚合，keyword类型不可用text进行分词模糊检索。</li><li>数值型：long、integer、short、byte、double、float </li><li>日期型：date </li><li>布尔型：boolean</li></ul><p><strong>通过term 和 match查询数据时细节点以及数据类型keyword与text区别</strong></p><ul><li><strong>term查询</strong><ul><li>term查询keyword字段: term不会分词。而keyword字段也不分词。需要完全匹配才可</li><li>term查询text字段: 因为text字段会分词，而term不分词，所以term查询的条件必须是text字段分词后的某一个</li></ul></li><li><strong>match查询</strong><ul><li>match会被分词，而keyword不会被分词，match的需要跟keyword的完全匹配可以。</li><li>match分词，text也分词，只要match的分词结果和text的分词结果有相同的就匹配</li></ul></li></ul><h2 id="对已存在的mapping映射进行修改"><a href="#对已存在的mapping映射进行修改" class="headerlink" title="对已存在的mapping映射进行修改"></a>对已存在的mapping映射进行修改</h2><ul><li>重新建立一个静态索引 ,把之前索引里的数据导入到新的索引里</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">POST _reindex<br>&#123;<br>  <span class="hljs-string">&quot;source&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;es_db&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;dest&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;es_db_2&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注：_reindex 会同时把之前索引里的数据导入到新的索引里 </p></blockquote><ul><li>删除原创建的索引</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hava">DELETE /es_db<br></code></pre></td></tr></table></figure><ul><li>为新索引起个别名, 为原索引名</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PUT /es_db_2/_alias/es_db<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch-DSL语言高级查询</title>
    <link href="/ElasticSearch-DSL%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2/"/>
    <url>/ElasticSearch-DSL%E8%AF%AD%E8%A8%80%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="DSL语言高级查询"><a href="#DSL语言高级查询" class="headerlink" title="DSL语言高级查询"></a>DSL语言高级查询</h1><ul><li>Elasticsearch提供了基于JSON的DSL来定义查询。 </li><li>DSL由叶子查询子句和复合查询子句两种子句组成</li></ul><blockquote><p>DSL(Domain Specific Language)领域专用语言 </p></blockquote><h2 id="无查询条件"><a href="#无查询条件" class="headerlink" title="无查询条件"></a>无查询条件</h2><p>无查询条件是查询所有，默认是查询所有的，或者使用match_all表示所有 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">GET /es_db/_doc/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="有查询条件"><a href="#有查询条件" class="headerlink" title="有查询条件"></a>有查询条件</h2><h3 id="模糊匹配"><a href="#模糊匹配" class="headerlink" title="模糊匹配"></a>模糊匹配</h3><ul><li><p>模糊匹配主要是针对文本类型的字段</p></li><li><p>文本类型的字段会对内容进行分词，对查询时，也会对搜索条件进行分词，然后通过倒排索引查找到匹配的数据</p></li><li><p>模糊匹配主要通过match等参数来实现 </p><ul><li>match : 通过match关键词模糊匹配条件内容,match会根据该字段的分词器，进行分词查询</li><li>prefix : 前缀匹配</li><li>regexp : 通过正则表达式来匹配数据</li></ul></li></ul><p> <strong>举例:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db/_doc/_search<br>&#123;<br>  <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;广州&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>SQL: select * from user where address like ‘%广州%’ limit 0, 2 </p></blockquote><ul><li>多字段模糊匹配查询 multi_match</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db/_doc/_search<br>&#123;<br>  <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;广州公园&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>: [<br>        <span class="hljs-string">&quot;address&quot;</span>,<br>        <span class="hljs-string">&quot;name&quot;</span><br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>SQL: select * from student where name like ‘%广州公园%’ or address like ‘%广州公园%’ </p></blockquote><ul><li>未指定字段条件查询 query_string , 含 AND 与 OR 条件</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;query_string&quot;: &#123;<br>      &quot;query&quot;: &quot;(广州) OR 长沙&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>指定字段条件查询 query_string , 含 AND 与 OR 条件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db/_doc/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;query_string&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;(广州) OR 长沙&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>:[<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;address&quot;</span>]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>范围查询<ul><li>range：范围关键字 </li><li>gte 大于等于</li><li>lte 小于等于 </li><li>gt 大于 </li><li>lt 小于</li><li>now 当前时间</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db/_doc/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>:&#123;<br>    <span class="hljs-string">&quot;range&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;age&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;gte&quot;</span>:<span class="hljs-number">25</span>,<br>        <span class="hljs-string">&quot;lte&quot;</span>:<span class="hljs-number">28</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>SQL: select * from user where age between 25 and 28 </p></blockquote><ul><li>分页、输出字段、排序综合查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db/_doc/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>:&#123;<br>    <span class="hljs-string">&quot;range&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;age&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;gte&quot;</span>:<span class="hljs-number">25</span>,<br>        <span class="hljs-string">&quot;lte&quot;</span>:<span class="hljs-number">28</span><br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-string">&quot;_source&quot;</span>: [<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-string">&quot;book&quot;</span>],<br>  <span class="hljs-string">&quot;sort&quot;</span>: &#123;<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-string">&quot;desc&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Filter过滤器方式查询"><a href="#Filter过滤器方式查询" class="headerlink" title="Filter过滤器方式查询"></a>Filter过滤器方式查询</h2><p>它的查询不会计算相关性分值，也不会对结果进行排序, 因此效率会高一点，查询的结果可以被缓存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /es_db/_doc/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li><p>match: 模糊匹配，需要指定字段名，但是输入会进行分词，比如”hello world”会进行拆分为hello和world，然后匹配，如果字段中包含hello或者 world，或者都包含的结果都会被查询出来，也就是说match是一个部分匹配的模糊查询。查询条件相对来说比较宽松。 </p></li><li><p>term：这种查询和match在有些时候是等价的，比如我们查询单个的词hello，那么会和match查询结果一样，但是如果查询”hello world”，结果就相差很大，因为这个输入不会进行分词，就是说查询的时候，是查询字段分词结果中是否有”hello world”的字样，而不是查询字段中包含”hello world”的字样。当保存 </p><p>数据”hello world”时，elasticsearch会对字段内容进行分词，”hello world”会被分成hello和world，不存在”hello world”，因此这里的查询结果会为空。这也是term查询和match的区别。</p></li><li><p>query_string：和match类似，但是match需要指定字段名，query_string是在所 </p><p>有字段中搜索，范围更广泛。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch文档批量操作</title>
    <link href="/ElasticSearch%E6%96%87%E6%A1%A3%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/"/>
    <url>/ElasticSearch%E6%96%87%E6%A1%A3%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="文档批量操作"><a href="#文档批量操作" class="headerlink" title="文档批量操作"></a><strong>文档批量操作</strong></h1><h2 id="批量获取文档数据"><a href="#批量获取文档数据" class="headerlink" title="批量获取文档数据"></a>批量获取文档数据</h2><blockquote><p>批量获取文档数据是通过_mget的API来实现的 </p></blockquote><h3 id="在URL中不指定index和type"><a href="#在URL中不指定index和type" class="headerlink" title="在URL中不指定index和type"></a>在URL中不指定index和type</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> _mget<br>&#123;<br>  &quot;docs&quot;: [<br>    &#123;<br>      &quot;_index&quot;: &quot;es_db&quot;,<br>      &quot;_type&quot;: &quot;_doc&quot;,<br>      &quot;_id&quot;: <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>      &quot;_index&quot;: &quot;es_db&quot;,<br>      &quot;_type&quot;: &quot;_doc&quot;,<br>      &quot;_id&quot;: <span class="hljs-number">2</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="在URL中指定index"><a href="#在URL中指定index" class="headerlink" title="在URL中指定index"></a>在URL中指定index</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_mget<br>&#123;<br>  &quot;docs&quot;: [<br>    &#123;<br>      &quot;_type&quot;: &quot;_doc&quot;,<br>      &quot;_id&quot;: <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>      &quot;_type&quot;: &quot;_doc&quot;,<br>      &quot;_id&quot;: <span class="hljs-number">2</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="在URL中指定index和type"><a href="#在URL中指定index和type" class="headerlink" title="在URL中指定index和type"></a>在URL中指定index和type</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_mget<br>&#123;<br>  &quot;docs&quot;: [<br>    &#123;<br>      &quot;_id&quot;: <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>      &quot;_id&quot;: <span class="hljs-number">2</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="批量操作文档数据"><a href="#批量操作文档数据" class="headerlink" title="批量操作文档数据"></a>批量操作文档数据</h2><ul><li><p>批量对文档进行写操作是通过_bulk的API来实现的 </p></li><li><p>通过_bulk操作文档，一般至少有两行参数(或偶数行参数) </p><ul><li>第一行参数为指定操作的类型及操作的对象 (index,type和id) </li><li>第二行参数才是操作的数据</li></ul><p>参数类似于：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;actionName&quot;</span>:&#123;<span class="hljs-string">&quot;_index&quot;</span>:<span class="hljs-string">&quot;indexName&quot;</span>, <span class="hljs-string">&quot;_type&quot;</span>:<span class="hljs-string">&quot;typeName&quot;</span>,<span class="hljs-string">&quot;_id&quot;</span>:<span class="hljs-string">&quot;id&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;field1&quot;</span>:<span class="hljs-string">&quot;value1&quot;</span>, <span class="hljs-string">&quot;field2&quot;</span>:<span class="hljs-string">&quot;value2&quot;</span>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="批量创建文档create"><a href="#批量创建文档create" class="headerlink" title="批量创建文档create"></a>批量创建文档create</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _bulk<br>&#123;<br>  &quot;create&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">3</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;id&quot;: <span class="hljs-number">3</span>,<br>  &quot;title&quot;: &quot;文章1&quot;,<br>  &quot;content&quot;: &quot;内容1&quot;,<br>  &quot;tags&quot;: [<br>    &quot;tag1&quot;,<br>    &quot;tag2&quot;<br>  ],<br>  &quot;create_time&quot;: <span class="hljs-number">1554015482530</span><br>&#125;<br>&#123;<br>  &quot;create&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">4</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;id&quot;: <span class="hljs-number">4</span>,<br>  &quot;title&quot;: &quot;文章2&quot;,<br>  &quot;content&quot;: &quot;内容2&quot;,<br>  &quot;tags&quot;: [<br>    &quot;tag3&quot;,<br>    &quot;tag4&quot;<br>  ],<br>  &quot;create_time&quot;: <span class="hljs-number">1554015482530</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="普通创建或全量替换index"><a href="#普通创建或全量替换index" class="headerlink" title="普通创建或全量替换index"></a>普通创建或全量替换index</h3><ul><li>如果原文档不存在，则是创建 </li><li>如果原文档存在，则是替换(全量修改原文档)</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _bulk<br>&#123;<br>  &quot;index&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">3</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;id&quot;: <span class="hljs-number">3</span>,<br>  &quot;title&quot;: &quot;更新后的文章1&quot;,<br>  &quot;content&quot;: &quot;更新后的内容1&quot;,<br>  &quot;tags&quot;: [<br>    &quot;tag1&quot;,<br>    &quot;tag2&quot;<br>  ],<br>  &quot;create_time&quot;: <span class="hljs-number">1554015482530</span><br>&#125;<br>&#123;<br>  &quot;index&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">5</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;id&quot;: <span class="hljs-number">5</span>,<br>  &quot;title&quot;: &quot;文章5&quot;,<br>  &quot;content&quot;: &quot;内容5&quot;,<br>  &quot;tags&quot;: [<br>    &quot;tag5&quot;,<br>    &quot;tag14&quot;<br>  ],<br>  &quot;create_time&quot;: <span class="hljs-number">1554015482530</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="批量修改update"><a href="#批量修改update" class="headerlink" title="批量修改update"></a>批量修改update</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _bulk<br>&#123;<br>  &quot;update&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">3</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;doc&quot;: &#123;<br>    &quot;title&quot;: &quot;更新后的文章11&quot;,<br>    &quot;content&quot;: &quot;更新后的内容11&quot;<br>  &#125;<br>&#125;<br>&#123;<br>  &quot;update&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">5</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;doc&quot;: &#123;<br>    &quot;title&quot;: &quot;文章51&quot;,<br>    &quot;content&quot;: &quot;内容51&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="批量删除delete"><a href="#批量删除delete" class="headerlink" title="批量删除delete"></a>批量删除delete</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _bulk<br>&#123;<br>  &quot;delete&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">3</span><br>  &#125;<br>&#125;<br>&#123;<br>  &quot;delete&quot;: &#123;<br>    &quot;_index&quot;: &quot;article&quot;,<br>    &quot;_type&quot;: &quot;_doc&quot;,<br>    &quot;_id&quot;: <span class="hljs-number">4</span><br>  &#125;<br>&#125;s<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Elasticsearch数据管理</title>
    <link href="/ES%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/"/>
    <url>/ES%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ES数据管理"><a href="#ES数据管理" class="headerlink" title="ES数据管理"></a>ES数据管理</h1><h2 id="ES数据管理概述"><a href="#ES数据管理概述" class="headerlink" title="ES数据管理概述"></a>ES数据管理概述</h2><ul><li>ES是面向文档(document oriented)的，这意味着它可以存储整个对象或文档 (document)。</li><li>然而它不仅仅是存储，还会索引(index)每个文档的内容使之可以被搜索。</li><li>在ES中，你可以对文档（而非成行成列的数据）进行索引、搜索、排序、过滤。</li><li>ES使用JSON作为文档序列化格式。</li></ul><p><strong>ES存储的一个员工文档的格式示例：</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">&#123; <br> &quot;email&quot;: &quot;584614151@qq.com&quot;,<br> &quot;name&quot;: &quot;张三&quot;, <br> &quot;age&quot;: <span class="hljs-number">30</span>,<br> &quot;interests&quot;: [ &quot;篮球&quot;, &quot;健身&quot; ]<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>JSON现在已经被大多语言所支持，而且已经成为NoSQL领域的标准格式。 </p></blockquote><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p>格式: PUT &#x2F;索引名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">PUT <span class="hljs-operator">/</span>es_db<br></code></pre></td></tr></table></figure><h3 id="查询索引"><a href="#查询索引" class="headerlink" title="查询索引"></a>查询索引</h3><p>格式: GET &#x2F;索引名称 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<br></code></pre></td></tr></table></figure><h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><p>格式: DELETE &#x2F;索引名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-operator">/</span>es_db<br></code></pre></td></tr></table></figure><h3 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h3><ul><li>格式: POST &#x2F;索引名称&#x2F;类型&#x2F;id(可选，不传会创建默认的id)</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<br>&#123;<br>  &quot;name&quot;: &quot;张三&quot;,<br>  &quot;sex&quot;: <span class="hljs-number">1</span>,<br>  &quot;age&quot;: <span class="hljs-number">25</span>,<br>  &quot;address&quot;: &quot;广州天河公园&quot;,<br>  &quot;remark&quot;: &quot;java developer&quot;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>格式: PUT &#x2F;索引名称&#x2F;类型&#x2F;id</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">PUT <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span><span class="hljs-number">1</span><br>&#123;<br>  &quot;name&quot;: &quot;张三&quot;,<br>  &quot;sex&quot;: <span class="hljs-number">1</span>,<br>  &quot;age&quot;: <span class="hljs-number">25</span>,<br>  &quot;address&quot;: &quot;广州天河公园&quot;,<br>  &quot;remark&quot;: &quot;java developer&quot;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h3><ul><li>格式: PUT &#x2F;索引名称&#x2F;类型&#x2F;id</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">PUT <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span><span class="hljs-number">1</span><br>&#123;<br>  &quot;name&quot;: &quot;张三&quot;,<br>  &quot;sex&quot;: <span class="hljs-number">1</span>,<br>  &quot;age&quot;: <span class="hljs-number">25</span>,<br>  &quot;address&quot;: &quot;广州天河公园&quot;,<br>  &quot;remark&quot;: &quot;java developer&quot;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><p>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;id </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p>格式: DELETE &#x2F;索引名称&#x2F;类型&#x2F;id </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h3 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h3><h4 id="查询当前类型中的所有文档-search"><a href="#查询当前类型中的所有文档-search" class="headerlink" title="查询当前类型中的所有文档 _search"></a>查询当前类型中的所有文档 _search</h4><p> 格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search </p><p>举例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search <br></code></pre></td></tr></table></figure><h4 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h4><ul><li><p>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search?q&#x3D;<em>:</em>** </p></li><li><p>SQL: select * from student where age &#x3D; 28</p></li></ul><p>举例：如要查询age等于28岁的 _search?q&#x3D;<em>:</em>** </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?q<span class="hljs-operator">=</span>age:<span class="hljs-number">28</span> <br></code></pre></td></tr></table></figure><h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h4><h5 id="in"><a href="#in" class="headerlink" title="in"></a>in</h5><ul><li>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search?q&#x3D;***[25 TO 26] </li><li>SQL: select * from student where age between 25 and 26</li></ul><p>举例：如要查询age在25至26岁之间的 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?q<span class="hljs-operator">=</span>age[<span class="hljs-number">25</span> <span class="hljs-keyword">TO</span> <span class="hljs-number">26</span>] <br></code></pre></td></tr></table></figure><p><strong>注意: TO 必须为大写</strong> </p><h5 id="大于"><a href="#大于" class="headerlink" title="大于"></a>大于</h5><ul><li>格式:  GET &#x2F;索引名称&#x2F;类型&#x2F;_search?q&#x3D;age:&gt;** </li><li>SQL: select * from student where age &gt; 28</li></ul><p>举例：查询年龄大于28的 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?q<span class="hljs-operator">=</span>age:<span class="hljs-operator">&gt;</span><span class="hljs-number">28</span><br></code></pre></td></tr></table></figure><h5 id="小于等于"><a href="#小于等于" class="headerlink" title="小于等于"></a>小于等于</h5><ul><li>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search?q&#x3D;age:&lt;&#x3D;** </li><li>SQL: select * from student where age &lt;&#x3D; 28</li></ul><p>举例：查询年龄小于等于28岁的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?q<span class="hljs-operator">=</span>age:<span class="hljs-operator">&lt;=</span><span class="hljs-number">28</span><br></code></pre></td></tr></table></figure><h4 id="批量查询"><a href="#批量查询" class="headerlink" title="批量查询"></a>批量查询</h4><ul><li>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_mget </li><li>SQL: select * from student where id in (1,2)</li></ul><p>举例：根据多个ID进行批量查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_mget<br>&#123;<br>  &quot;ids&quot;:[&quot;3&quot;,&quot;2&quot;]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><ul><li><p>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search?q&#x3D;age[25 TO 26]&amp;from&#x3D;0&amp;size&#x3D;1 </p></li><li><p>SQL: select * from student where age between 25 and 26 limit 0, 1</p></li></ul><p>举例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?q<span class="hljs-operator">=</span>age[<span class="hljs-number">25</span> <span class="hljs-keyword">TO</span> <span class="hljs-number">26</span>]<span class="hljs-operator">&amp;</span><span class="hljs-keyword">from</span><span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-operator">&amp;</span>size<span class="hljs-operator">=</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="查询结果只输出某些字段"><a href="#查询结果只输出某些字段" class="headerlink" title="查询结果只输出某些字段"></a>查询结果只输出某些字段</h4><ul><li>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search?_source&#x3D;字段,字段</li><li>SQL: select name,age from student</li></ul><p>举例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?_source<span class="hljs-operator">=</span>name,age<br></code></pre></td></tr></table></figure><h4 id="查询结果排序"><a href="#查询结果排序" class="headerlink" title="查询结果排序"></a>查询结果排序</h4><ul><li>格式: GET &#x2F;索引名称&#x2F;类型&#x2F;_search?sort&#x3D;字段 desc </li><li>SQL: select * from student order by age desc</li></ul><p>举例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>es_db<span class="hljs-operator">/</span>_doc<span class="hljs-operator">/</span>_search?sort<span class="hljs-operator">=</span>age:<span class="hljs-keyword">desc</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Elasticsearch安装</title>
    <link href="/Elasticsearch%E5%AE%89%E8%A3%85/"/>
    <url>/Elasticsearch%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="Elasticsearch安装"><a href="#Elasticsearch安装" class="headerlink" title="Elasticsearch安装"></a>Elasticsearch安装</h1><p>1.下载es.  Es 下载链接： <a href="https://www.elastic.co/cn/downloads/elasticsearch">Download Elasticsearch | Elastic</a></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230445183.png" alt="image-20230228230445183"></p><p>2.解压后在bin路径下，运行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  bin .<span class="hljs-operator">/</span>elasticsearch <span class="hljs-operator">-</span>d<br></code></pre></td></tr></table></figure><p>3.访问<a href="http://localhost:9200/">localhost:9200</a>,看到下面的页面即启动成功</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230454065.png" alt="image-20230228230454065"></p><h1 id="Kibana安装"><a href="#Kibana安装" class="headerlink" title="Kibana安装"></a>Kibana安装</h1><ol><li>Kibana 下载链接：<a href="https://www.elastic.co/cn/downloads/kibana">Download Kibana Free | Get Started Now | Elastic</a></li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230502701.png" alt="image-20230228230502701"></p><ol start="2"><li>修改 kibana.yml</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">server.port: <span class="hljs-number">5601</span><br>server.host: &quot;localhost&quot;<br>elasticsearch.hosts: [&quot;http://localhost:9200&quot;]<br></code></pre></td></tr></table></figure><p>3.访问<a href="http://localhost:5601/app/kibana">http://localhost:5601/app/kibana</a>, 看到下面的页面即启动成功</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230512243.png" alt="image-20230228230512243"></p><h1 id="安装IK分词器"><a href="#安装IK分词器" class="headerlink" title="安装IK分词器"></a>安装IK分词器</h1><p>我们后续也需要使用Elasticsearch来进行中文分词，所以需要单独给Elasticsearch安装IK分词器插件。以下为具体安装步骤：</p><ol><li><p>下载ElasticsearchIK分词器 <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p></li><li><p>在es的安装目录下&#x2F;plugins创建ik，将下载的ik分词器上传并解压到该目录</p></li><li><p>重启Elasticsearch</p></li></ol>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">查找进程命令 ps <span class="hljs-operator">-</span>ef <span class="hljs-operator">|</span> grep elastic<br>杀掉进程 kill <span class="hljs-number">-9</span> <span class="hljs-number">2382</span>（进程号）<br></code></pre></td></tr></table></figure><ol start="4"><li>测试分词效果，访问<a href="http://localhost:5601/app/dev_tools#/console">Dev Tools - Elastic</a></li></ol>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _analyze<br>&#123;<br>&quot;analyzer&quot;:&quot;standard&quot;,<br>&quot;text&quot;:&quot;我爱你中国&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p>   <img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230530722.png" alt="image-20230228230530722"></p><ul><li>ik_smart:会做最粗粒度的拆分</li></ul>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _analyze<br>&#123;<br>&quot;analyzer&quot;:&quot;ik_smart&quot;,<br>&quot;text&quot;:&quot;我爱你中国&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p>   <img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230546771.png" alt="image-20230228230546771"></p><ul><li>k_max_word:会将文本做最细粒度的拆分</li></ul>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST _analyze<br>&#123;<br>&quot;analyzer&quot;:&quot;ik_max_word&quot;,<br>&quot;text&quot;:&quot;我爱你中国&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p>   <img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230556755.png" alt="image-20230228230556755"></p><h1 id="指定IK分词器作为默认分词器"><a href="#指定IK分词器作为默认分词器" class="headerlink" title="指定IK分词器作为默认分词器"></a>指定IK分词器作为默认分词器</h1><p>​        ES的默认分词设置是standard，这个在中文分词时就比较尴尬了，会单字拆分，比如我搜索关键词“清华大学”，这时候会按“清”，“华”，“大”，“学”去分词，然后搜出来的都是些“清清的河水”，“中华儿女”，“地大物博”，“学而不思则罔”之类的莫名其妙的结果，</p><p>​        这里我们就想把这个分词方式修改一下，于是呢，就想到了ik分词器，有两种ik_smart和ik_max_word。ik_smart会将“清华大学”整个分为一个词，而ik_max_word会将“清华大学”分为“清华大学”，“清华”和“大学”，按需选其中之一就可以了。修改默认分词方法(这里修改school_index索引的默认分词为：ik_max_word)：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">PUT <span class="hljs-operator">/</span>school_index<br>&#123;<br>  &quot;settings&quot;:&#123;<br>    &quot;index&quot;:&#123;<br>      &quot;analysis.analyzer.default.type&quot;:&quot;ik_max_word&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230604782.png" alt="image-20230228230604782"></p>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch集群搭建</title>
    <link href="/ElasticSearch%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <url>/ElasticSearch%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="ElasticSearch集群搭建"><a href="#ElasticSearch集群搭建" class="headerlink" title="ElasticSearch集群搭建"></a>ElasticSearch集群搭建</h1><h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><h3 id="集群cluster"><a href="#集群cluster" class="headerlink" title="集群cluster"></a>集群cluster</h3><p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能</p><h3 id="节点node"><a href="#节点node" class="headerlink" title="节点node"></a>节点node</h3><ul><li>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据。参与集群的索引和搜索功能。</li><li>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中。这意味着，如果在网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。</li><li>在一个集群里，可以拥有任意多个节点。而且，如果当前网络中没有运行任何Elasticsearch节点，这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。</li></ul><h3 id="分片和副本shards-amp-replicas"><a href="#分片和副本shards-amp-replicas" class="headerlink" title="分片和副本shards&amp;replicas"></a>分片和副本shards&amp;replicas</h3>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>clickHouse的SQL操作</title>
    <link href="/clickHouse%E7%9A%84SQL%E6%93%8D%E4%BD%9C-1/"/>
    <url>/clickHouse%E7%9A%84SQL%E6%93%8D%E4%BD%9C-1/</url>
    
    <content type="html"><![CDATA[<h1 id="ClickHouse的SQL操作"><a href="#ClickHouse的SQL操作" class="headerlink" title="ClickHouse的SQL操作"></a>ClickHouse的SQL操作</h1><p>基本上来说传统关系型数据库（以 MySQL 为例）的 SQL 语句，ClickHouse 基本都支持，这里不会从头讲解 SQL 语法只介绍 ClickHouse 与标准 SQL（MySQL）不一致的地方</p><h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><p>基本与标准 SQL（MySQL）基本一致</p><p>（1）标准</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> [table_name] <span class="hljs-keyword">values</span>(…),(….)<br></code></pre></td></tr></table></figure><p>（2）从表到表的插入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> [table_name] <span class="hljs-keyword">select</span> a,b,c <span class="hljs-keyword">from</span> [table_name_2]<br></code></pre></td></tr></table></figure><h2 id="Update-和Delete"><a href="#Update-和Delete" class="headerlink" title="Update 和Delete"></a>Update 和Delete</h2><ul><li><p>ClickHouse 提供了 Delete 和 Update 的能力，这类操作被称为 Mutation 查询，它可以看做 Alter 的一种。</p></li><li><p>虽然可以实现修改和删除，但是和一般的 OLTP 数据库不一样，<strong>Mutation</strong> 语句是一种很重的操作，而且不支持事务。</p><blockquote><p>“重”的原因主要是每次修改或者删除都会导致放弃目标数据的原有分区，重建新分区。合并的时候才会删除原有分区，所以尽量做批量的变更，不要进行频繁小数据的操作。</p></blockquote></li></ul><h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t_order_smt <span class="hljs-keyword">delete</span> <span class="hljs-keyword">where</span> sku_id <span class="hljs-operator">=</span><span class="hljs-string">&#x27;sku_001&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="修改操作"><a href="#修改操作" class="headerlink" title="修改操作"></a>修改操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t_order_smt update total_amount<span class="hljs-operator">=</span>toDecimal32(<span class="hljs-number">2000.00</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span><span class="hljs-number">102</span>;<br></code></pre></td></tr></table></figure><h3 id="开发建议"><a href="#开发建议" class="headerlink" title="开发建议"></a>开发建议</h3><p>clickhouse虽然支持 Delete 和 Update 的能力，但是这类操作很重，一般建议不要使用，如果要使用，都可以采用增加数据的方式来实现，如更新的话，可以给列新加版本号；删除的话，可以增加一列删除标记为：delete_at，但这样会造成数据膨胀，可以定期删除失效的数据。</p><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>ClickHouse 基本上与标准 SQL 差别不大</p><p>➢ 支持子查询</p><p>➢ 支持 CTE(Common Table Expression 公用表表达式 with 子句) </p><p>➢ 支持各种 JOIN，但是 JOIN 操作无法使用缓存，所以即使是两次相同的 JOIN 语句，ClickHouse 也会视为两条新 SQL</p><p>➢ 窗口函数</p><p>➢ 不支持自定义函数</p><p>➢ GROUP BY 操作增加了 with rollup\with cube\with total 用来计算小计和总计。</p><p><strong>演示</strong></p><p>（1）插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">bfdf602492c9 :)  <span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t_order_mt <span class="hljs-keyword">delete</span> <span class="hljs-keyword">where</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>bfdf602492c9 :) <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_mt <span class="hljs-keyword">values</span><br>                (<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">103</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">104</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">105</span>,<span class="hljs-string">&#x27;sku_003&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">106</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-04 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">107</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-04 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">108</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-04 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">109</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-04 12:00:00&#x27;</span>),<br>                (<span class="hljs-number">110</span>,<span class="hljs-string">&#x27;sku_003&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure><p>（2）with rollup：从右至左去掉维度进行小计</p><p>可以看出分别根据  【id,sku_id】【id】【(空)】 进行了分组</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">bfdf602492c9 :) <span class="hljs-keyword">select</span> id , sku_id,<span class="hljs-built_in">sum</span>(total_amount) <span class="hljs-keyword">from</span> t_order_mt <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> id,sku_id <span class="hljs-keyword">with</span> <span class="hljs-keyword">rollup</span>;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222258542.png" alt="image-20230228222258542"></p><p>（3）with cube : 从右至左去掉维度进行小计，再从左至右去掉维度进行小计</p><p>可以看出分别根据  【id,sku_id】【id】【sku_id】【(空)】 进行了分组</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222316833.png" alt="image-20230228222316833"></p><p>（4）with totals: 只计算合计</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">bfdf602492c9 :)  <span class="hljs-keyword">select</span> id , sku_id,<span class="hljs-built_in">sum</span>(total_amount) <span class="hljs-keyword">from</span> t_order_mt <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span><br>                id,sku_id <span class="hljs-keyword">with</span> totals;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222331141.png" alt="image-20230228222331141"></p><h2 id="alter操作"><a href="#alter操作" class="headerlink" title="alter操作"></a>alter操作</h2><p>同 MySQL 的修改字段基本一致</p><p>1）新增字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> tableName <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> newcolname String after col1; <br></code></pre></td></tr></table></figure><p>2）修改字段类型</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> tableName modify <span class="hljs-keyword">column</span> newcolname String; <br></code></pre></td></tr></table></figure><p>3）删除字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> tableName <span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> newcolname; <br></code></pre></td></tr></table></figure><blockquote><p>更多语法参考：<a href="https://clickhouse.com/docs/en/sql-reference/">ClickHouse Documentation</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Clickhouse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>clickhouse表引擎</title>
    <link href="/clickhouse%E8%A1%A8%E5%BC%95%E6%93%8E/"/>
    <url>/clickhouse%E8%A1%A8%E5%BC%95%E6%93%8E/</url>
    
    <content type="html"><![CDATA[<h1 id="表引擎介绍"><a href="#表引擎介绍" class="headerlink" title="表引擎介绍"></a>表引擎介绍</h1><p>表引擎是 ClickHouse 的一大特色。不同的引擎有不同的作用，可以说， 表引擎决定了如何存储表的数据。包括：</p><p>➢ 数据的存储方式和位置，写到哪里以及从哪里读取数据。 （一般的引擎都存在磁盘中，但是存在与其他数据库继承的场景，比如和mysql集成，数据放在mysql服务端。）</p><p>➢ 支持哪些查询以及如何支持。（有些语法只有在特定的引擎才可以使用，比如不能在 MergeTree 表中存储多维数组）</p><p>➢ 并发数据访问。（可以多线程执行同一条sql）</p><p>➢ 索引的使用（如果存在）。</p><p>➢ 是否可以执行多线程请求。</p><p>➢ 数据复制参数。</p><blockquote><p>表引擎的使用方式就是必须显式在创建表时定义该表使用的引擎，以及引擎使用的相关参数。</p></blockquote><p><strong>特别注意：引擎的名称大小写敏感</strong></p><h1 id="合并树家族"><a href="#合并树家族" class="headerlink" title="合并树家族"></a>合并树家族</h1><h2 id="MergeTree"><a href="#MergeTree" class="headerlink" title="MergeTree"></a><strong>MergeTree</strong></h2><ul><li>ClickHouse 中最强大的表引擎当属 MergeTree（合并树）引擎及该系列（*MergeTree）</li></ul><p>中的其他引擎，支持索引和分区，地位可以相当于 innodb 之于 Mysql。而且基于 MergeTree，</p><ul><li>还衍生除了很多小弟，也是非常有特色的引擎。</li></ul><ol><li><p>建表语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_mt(<br>id UInt32,<br>sku_id String,<br>total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br>create_time Datetime<br>) engine <span class="hljs-operator">=</span>MergeTree<br><span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br><span class="hljs-keyword">primary</span> key (id)<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id,sku_id);<br></code></pre></td></tr></table></figure></li><li><p><strong>插入数据</strong></p></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_mt <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>) ,<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 11:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h3><h4 id="partition-by-分区"><a href="#partition-by-分区" class="headerlink" title="partition by 分区"></a><strong>partition by</strong> 分区</h4><h5 id="1-目的"><a href="#1-目的" class="headerlink" title="1. 目的"></a>1. 目的</h5><p>分区的目的主要是降低扫描的范围，优化查询速度</p><h5 id="2-可选"><a href="#2-可选" class="headerlink" title="2. 可选"></a>2. 可选</h5><p>可选的，如果不填，只会使用一个分区。</p><h5 id="3-分区目录"><a href="#3-分区目录" class="headerlink" title="3.分区目录"></a>3.<strong>分区目录</strong></h5><p>MergeTree 是以列文件+索引文件+表定义文件组成的，但是如果设定了分区那么这些文</p><p>件就会保存到不同的分区目录中。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225811773.png" alt="image-20230228225811773"></p><h5 id="4-并行"><a href="#4-并行" class="headerlink" title="4.并行"></a>4.<strong>并行</strong></h5><p>分区后，面对涉及跨分区的查询统计，ClickHouse 会以分区为单位并行处理。</p><h5 id="5-数据写入与分区合并"><a href="#5-数据写入与分区合并" class="headerlink" title="5.数据写入与分区合并"></a>5.<strong>数据写入与分区合并</strong></h5><ul><li><p>任何一个批次的数据写入都会产生一个临时分区，不会纳入任何一个已有的分区。</p></li><li><p>写入后的某个时刻（大概 10-15 分钟后），ClickHouse 会自动执行合并操作。</p></li><li><p>也可以手动通过 optimize 执行，把临时分区的数据，合并到已有分区中。语法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">optimize <span class="hljs-keyword">table</span> xxxx <span class="hljs-keyword">final</span>;<br></code></pre></td></tr></table></figure><p>如：</p><ul><li>再次执行上面的插入操作</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_mt <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>) ,<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 11:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure><ul><li>查看数据并没有纳入任何分区</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225822725.png" alt="image-20230228225822725"></p></li><li><p>手动 optimize 之后，再次查询</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225836780.png" alt="image-20230228225836780"></p></li></ul><h4 id="primary-key-主键"><a href="#primary-key-主键" class="headerlink" title="primary key 主键"></a><strong>primary key</strong> <strong>主键</strong></h4><ul><li>ClickHouse 中的主键，和其他数据库不太一样，<strong>它只提供了数据的一级索引，但是却不</strong></li></ul><p><strong>是唯一约束。</strong>这就意味着是可以存在相同 primary key 的数据的。</p><ul><li><p>主键的设定主要依据是查询语句中的 where 条件。</p></li><li><p>根据条件通过对主键进行某种形式的二分查找，能够定位到对应的 index granularity（粒度）,避免了全表扫描。</p><blockquote><p>index granularity： 直接翻译的话就是索引粒度，指在稀疏索引中两个相邻索引对应数据的间隔。ClickHouse 中的 MergeTree 默认是 8192。官方不建议修改这个值，除非该列存在大量重复值，比如在一个分区中几万行才有一个不同数据。</p></blockquote><p><strong>稀疏索引：</strong></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225859455.png" alt="image-20230228225859455"></p><p>稀疏索引的好处就是可以用很少的索引数据，定位更多的数据，代价就是只能定位到索引粒度的第一行，然后再进行进行一点扫描。</p><blockquote><p>比如要查找id为15151的数据，可以判断出他大于10101 小于32343 ，因此会在这个区域内进行查找，类似的根据二分查找定位到具体的值。</p></blockquote></li></ul><h4 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a><strong>order by</strong></h4><ul><li><p>order by 设定了分区内的数据按照哪些字段顺序进行有序保存。</p></li><li><p>order by 是 MergeTree 中唯一一个必填项，甚至比 primary key 还重要，因为当用户不</p><p>设置主键的情况，很多处理会依照 order by 的字段进行处理（比如后面会讲的去重和汇总）。</p></li><li><p><strong>要求：主键必须是 order by 字段的前缀字段</strong>。比如 order by 字段是 (id,sku_id) 那么主键必须是 id 或者(id,sku_id)</p></li></ul><h3 id="跳数索引"><a href="#跳数索引" class="headerlink" title="跳数索引"></a>跳数索引</h3><ul><li><p>MergeTree支持二级索引，又称之为跳数索引，是由数据的聚合信息构建而成。跳数索引的目录也是帮助查询，减少数据扫描的范围。</p></li><li><p>此索引在 <code>CREATE</code> 语句的列部分里定义。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">INDEX index_name expr TYPE type(...) GRANULARITY granularity_value<br></code></pre></td></tr></table></figure><ul><li><p><code>*MergeTree</code> 系列的表可以指定跳数索引。</p></li><li><p>跳数索引是指数据片段按照粒度(建表时指定的<code>index_granularity</code>)分割成小块后，将上述SQL的granularity_value数量的小块组合成一个大的块，对这些大块写入索引信息。</p></li><li><p>这样有助于使用<code>where</code>筛选时跳过大量不必要的数据，减少<code>SELECT</code>需要读取的数据量。</p></li><li><p>如：创建测试表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_mt2(<br>id UInt32,<br>sku_id String,<br>total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br>create_time Datetime,<br>INDEX a total_amount TYPE minmax GRANULARITY <span class="hljs-number">5</span><br>) engine <span class="hljs-operator">=</span>MergeTree<br><span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br><span class="hljs-keyword">primary</span> key (id)<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id, sku_id);<br></code></pre></td></tr></table></figure><blockquote><p>其中 GRANULARITY N 是设定二级索引对于一级索引粒度的粒度。</p><p>即一级索引为[1,3],[3,6],[6,9] ，对应的二级索引范围为[1,9]，将3个一级索引进行了合并，这样查找时就不需要根据一级索引去进行比较，直接根据二级索引就可以。</p></blockquote></li></ul></li></ul><blockquote><p> 目前在 ClickHouse 的官网上二级索引的功能在 v20.1.2.4 之前是被标注为实验性的，在这个版本之后默认是开启的。 </p></blockquote><h3 id="数据-TTL"><a href="#数据-TTL" class="headerlink" title="数据 TTL"></a><strong>数据</strong> <strong>TTL</strong></h3><ul><li><p>TTL 即 Time To Live，TTL用于设置值的生命周期，它既可以为整张表设置，也可以为每个列字段单独设置。表级别的 TTL 还会指定数据在磁盘和卷上自动转移的逻辑（也就是数据过期后可以移动到指定磁盘上）。</p></li><li><p>TTL 表达式的计算结果必须是 <a href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree/">日期</a> 或 <a href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree/">日期时间</a> 类型的字段。</p></li><li><p><code>TTL</code>子句不能被用于主键字段。</p><p>示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">TTL time_column<br>TTL time_column <span class="hljs-operator">+</span> <span class="hljs-type">interval</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="1-列级别-TTL"><a href="#1-列级别-TTL" class="headerlink" title="1.列级别 TTL"></a>1.<strong>列级别</strong> <strong>TTL</strong></h4><p>当列中的值过期时, ClickHouse会将它们替换成该列数据类型的默认值。如果数据片段中列的所有值均已过期，则ClickHouse 会从文件系统中的数据片段中删除此列。</p><h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><p>创建表时指定 <code>TTL</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> example_table<br>(<br>    d DateTime,<br>    a <span class="hljs-type">Int</span> TTL d <span class="hljs-operator">+</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">MONTH</span>,<br>    b <span class="hljs-type">Int</span> TTL d <span class="hljs-operator">+</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">MONTH</span>,<br>    c String<br>)<br>ENGINE <span class="hljs-operator">=</span> MergeTree<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> toYYYYMM(d)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> d;<br></code></pre></td></tr></table></figure><p>为表中已存在的列字段添加 <code>TTL</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> example_table<br>    MODIFY <span class="hljs-keyword">COLUMN</span><br>    c String TTL d <span class="hljs-operator">+</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>;<br></code></pre></td></tr></table></figure><p><strong>案例演示</strong></p><ul><li><p>创建测试表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_mt7(<br>id UInt32,<br>sku_id String,<br>total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>) TTL create_time<span class="hljs-operator">+</span><span class="hljs-type">interval</span> <span class="hljs-number">10</span> <span class="hljs-keyword">SECOND</span>,<br>create_time Datetime <br>) engine <span class="hljs-operator">=</span>MergeTree<br><span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br><span class="hljs-keyword">primary</span> key (id)<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id, sku_id);<br></code></pre></td></tr></table></figure></li><li><p>插入数据（注意：根据实际时间改变）</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_mt7 <span class="hljs-keyword">values</span><br>(<span class="hljs-number">106</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2022-02-03 10:44:32&#x27;</span>),<br>(<span class="hljs-number">107</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2022-02-03 10:44:32&#x27;</span>),<br>(<span class="hljs-number">110</span>,<span class="hljs-string">&#x27;sku_003&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2022-02-04 19:20:30&#x27;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225917132.png" alt="image-20230228225917132"></p><ul><li><p>手动合并，查看效果 到期后，指定的字段数据归 0</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">optimize <span class="hljs-keyword">table</span> t_order_mt7 <span class="hljs-keyword">final</span>;<br></code></pre></td></tr></table></figure></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225930135.png" alt="image-20230228225930135"></p><h4 id="2-表-TTL"><a href="#2-表-TTL" class="headerlink" title="2.表 TTL"></a>2.表 TTL</h4><ul><li><p>表可以设置一个用于移除过期行的表达式，以及多个用于在磁盘或卷上自动转移数据片段的表达式。当表中的行过期时，ClickHouse 会删除所有对应的行。对于数据片段的转移特性，必须所有的行都满足转移条件。</p></li><li><p>下面的这条语句是数据会在 create_time 之后 10 秒丢失</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t_order_mt3 MODIFY TTL create_time <span class="hljs-operator">+</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">10</span> <span class="hljs-keyword">SECOND</span>;<br></code></pre></td></tr></table></figure></li></ul><h5 id="案例演示"><a href="#案例演示" class="headerlink" title="案例演示"></a>案例演示</h5><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225939573.png" alt="image-20230228225939573"></p><h2 id="ReplacingMergeTree"><a href="#ReplacingMergeTree" class="headerlink" title="ReplacingMergeTree"></a>ReplacingMergeTree</h2><ul><li><p>ReplacingMergeTree 是 MergeTree 的一个变种，它存储特性完全继承 MergeTree，只是多了一个去重的功能。 </p></li><li><p>尽管 MergeTree 可以设置主键，但是 primary key 其实没有唯一约束的功能。如果你想处理掉重复的数据，可以借助这个 ReplacingMergeTree。</p></li></ul><h3 id="去重时机"><a href="#去重时机" class="headerlink" title="去重时机"></a><strong>去重时机</strong></h3><p>数据的去重只会在同一批插入（新版本）或合并的过程中出现。合并会在未知的时间在后台进行，所以你无法预</p><p>先作出计划。有一些数据可能仍未被处理。</p><h3 id="去重范围"><a href="#去重范围" class="headerlink" title="去重范围"></a><strong>去重范围</strong></h3><ul><li><p>如果表经过了分区，去重只会在分区内部进行去重，不能执行跨分区的去重。</p></li><li><p>所以 ReplacingMergeTree 能力有限， ReplacingMergeTree 适用于在后台清除重复的数据以节省空间，但是它不保证没有重复的数据出现。</p></li></ul><h3 id="案例演示-1"><a href="#案例演示-1" class="headerlink" title="案例演示"></a><strong>案例演示</strong></h3><p>（1）创建表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_rmt(<br>id UInt32,<br>sku_id String,<br>total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>) ,<br>create_time Datetime <br>) engine <span class="hljs-operator">=</span>ReplacingMergeTree(create_time)<br><span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br><span class="hljs-keyword">primary</span> key (id)<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id, sku_id);<br></code></pre></td></tr></table></figure><ul><li><p>ReplacingMergeTree() 填入的参数为版本字段，重复数据保留版本字段值最大的。</p></li><li><p>如果不填版本字段，默认按照插入顺序保留最后一条。</p></li></ul><p>（2）向表中插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_rmt <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>) ,<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 11:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">12000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure><p>（3）执行第一次查询</p><p>可以看到插入的数据是根据id和sku_id 去重过的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t_order_rmt;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225956910.png"></p><p>（4）再次插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_rmt <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>) ,<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 11:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">12000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure><p>(5) 再次查询，可以看到这次依旧只插入了4条数据，但是和第一次插入的数据没有进行去重，依旧存在重复数据。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230010636.png" alt="image-20230228230010636"></p><p>（6）手动合并</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">OPTIMIZE <span class="hljs-keyword">TABLE</span> t_order_rmt <span class="hljs-keyword">FINAL</span>;<br></code></pre></td></tr></table></figure><p>  (7) 再执行一次查询，此时数据已经根据分区进行了最终去重。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230022485.png" alt="image-20230228230022485"></p><h3 id="案例结论"><a href="#案例结论" class="headerlink" title="案例结论"></a>案例结论</h3><p>➢ 实际上是使用 order by 字段作为唯一键</p><p>➢ 去重不能跨分区</p><p>➢ 只有同一批插入（新版本）或合并分区时才会进行去重</p><p>➢ 认定重复的数据保留，版本字段值最大的</p><p>➢ 如果版本字段相同则按插入顺序保留最后一笔</p><h2 id="SummingMergeTree"><a href="#SummingMergeTree" class="headerlink" title="SummingMergeTree"></a><strong>SummingMergeTree</strong></h2><ul><li><p>对于不查询明细，只关心以维度进行汇总聚合结果的场景。如果只使用普通的MergeTree的话，无论是存储空间的开销，还是查询时临时聚合的开销都比较大。</p></li><li><p>ClickHouse 为了这种场景，提供了一种能够“预聚合”的引擎 SummingMergeTree</p></li><li><p>不支持幂等性，当写入100条，写了50条后挂了，后面再次同步100条数据时，会把前50条的数据聚合两次。</p></li></ul><h3 id="案例演示-2"><a href="#案例演示-2" class="headerlink" title="案例演示"></a><strong>案例演示</strong></h3><p>（1）创建表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_smt(<br>id UInt32,<br>sku_id String,<br>total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>) ,<br>create_time Datetime <br>) engine <span class="hljs-operator">=</span>SummingMergeTree(total_amount)<br><span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br><span class="hljs-keyword">primary</span> key (id)<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id,sku_id );<br></code></pre></td></tr></table></figure><p>（2）插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_smt <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 11:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">12000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure><p>（3）执行第一次查询，可以看到已经做了一次聚合</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t_order_smt;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230039985.png" alt="image-20230228230039985"></p><p>（4）再次插入一条重复数据，并查询。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_smt <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 13:00:00&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230047812.png" alt="image-20230228230047812"></p><p>（5）手动合并,并再次执行查询，可以看到数据已经全部聚合</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">OPTIMIZE <span class="hljs-keyword">TABLE</span> t_order_smt <span class="hljs-keyword">FINAL</span>;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230057295.png" alt="image-20230228230057295"></p><h3 id="案例结论-1"><a href="#案例结论-1" class="headerlink" title="案例结论"></a>案例结论</h3><p>➢ 以 SummingMergeTree（）中指定的列作为汇总数据列 </p><p>➢ 以 order by 的列为准，作为维度列</p><p>➢ 可以填写多列必须数字列，如果不填，以所有非维度列且为数字列的字段为汇总数据列</p><p>➢ 其他的列按插入顺序保留第一行</p><p>➢ 不在一个分区的数据不会被聚合</p><p>➢ 只有在同一批次插入(新版本)或分片合并时才会进行聚合</p><h3 id="能不能直接执行查询-SQL-得到汇总值？"><a href="#能不能直接执行查询-SQL-得到汇总值？" class="headerlink" title="能不能直接执行查询 SQL 得到汇总值？"></a>能不能直接执行查询 SQL 得到汇总值？</h3><p>不行，可能会包含一些还没来得及聚合的临时明细如果要是获取汇总值，还是需要使用 sum 进行聚合，这样效率会有一定的提高，但本身 ClickHouse 是列式存储的，效率提升有限，不会特别明显。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> total_amount <span class="hljs-keyword">from</span> XXX <span class="hljs-keyword">where</span> province_name<span class="hljs-operator">=</span>’’ <span class="hljs-keyword">and</span> create_date<span class="hljs-operator">=</span>’xxx’<br></code></pre></td></tr></table></figure><p>改写为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">sum</span>(total_amount) <span class="hljs-keyword">from</span> province_name<span class="hljs-operator">=</span>’’ <span class="hljs-keyword">and</span> create_date<span class="hljs-operator">=</span>‘xxx’<br></code></pre></td></tr></table></figure><h1 id="集成"><a href="#集成" class="headerlink" title="集成"></a>集成</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>MySQL 引擎可以对存储在远程 MySQL 服务器上的数据执行 <code>SELECT</code> 查询和<code>insert</code>插入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> [IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>] [db.]table_name [<span class="hljs-keyword">ON</span> CLUSTER cluster]<br>(<br>    name1 [type1] [<span class="hljs-keyword">DEFAULT</span><span class="hljs-operator">|</span>MATERIALIZED<span class="hljs-operator">|</span>ALIAS expr1] [TTL expr1],<br>    name2 [type2] [<span class="hljs-keyword">DEFAULT</span><span class="hljs-operator">|</span>MATERIALIZED<span class="hljs-operator">|</span>ALIAS expr2] [TTL expr2],<br>    ...<br>) ENGINE <span class="hljs-operator">=</span> MySQL(<span class="hljs-string">&#x27;host:port&#x27;</span>, <span class="hljs-string">&#x27;database&#x27;</span>, <span class="hljs-string">&#x27;table&#x27;</span>, <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;password&#x27;</span>[, replace_query, <span class="hljs-string">&#x27;on_duplicate_clause&#x27;</span>])<br>SETTINGS<br>    [connection_pool_size<span class="hljs-operator">=</span><span class="hljs-number">16</span>, ]<br>    [connection_max_tries<span class="hljs-operator">=</span><span class="hljs-number">3</span>, ]<br>    [connection_wait_timeout<span class="hljs-operator">=</span><span class="hljs-number">5</span>, ] <span class="hljs-comment">/* 0 -- do not wait */</span><br>    [connection_auto_close<span class="hljs-operator">=</span><span class="hljs-literal">true</span> ]<br>;<br></code></pre></td></tr></table></figure><p>更多见：<a href="https://clickhouse.com/docs/en/engines/table-engines/integrations/mysql/">MySQL | ClickHouse Documentation</a></p><h1 id="日志系列"><a href="#日志系列" class="headerlink" title="日志系列"></a>日志系列</h1><ul><li>这些引擎是为了需要写入许多小数据量（少于一百万行）的表的场景而开发的。</li><li>这系列的引擎有：<ul><li><a href="https://clickhouse.com/docs/zh/engines/table-engines/log-family/stripelog/">StripeLog</a></li><li><a href="https://clickhouse.com/docs/zh/engines/table-engines/log-family/log/">日志</a></li><li><a href="https://clickhouse.com/docs/zh/engines/table-engines/log-family/tinylog/">TinyLog</a></li></ul></li></ul><h2 id="TinyLog"><a href="#TinyLog" class="headerlink" title="TinyLog"></a>TinyLog</h2><p>以列文件的形式保存在磁盘上，不支持索引，没有并发控制。一般保存少量数据的小表，</p><p>生产环境上作用有限。可以用于平时练习测试用。</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
    
    
    <categories>
      
      <category>Clickhouse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>clickhouse基本数据类型</title>
    <link href="/clickhouse%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
    <url>/clickhouse%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="clickhouse基本数据类型"><a href="#clickhouse基本数据类型" class="headerlink" title="clickhouse基本数据类型"></a>clickhouse基本数据类型</h1><h2 id="整型"><a href="#整型" class="headerlink" title="整型"></a><strong>整型</strong></h2><p>固定长度的整型，包括有符号整型或无符号整型。</p><p>整型范围（-2n-1~2n-1-1）：</p><p>Int8 - [-128 : 127]</p><p>Int16 - [-32768 : 32767]</p><p>Int32 - [-2147483648 : 2147483647]</p><p>Int64 - [-9223372036854775808 : 9223372036854775807]</p><p>无符号整型范围（0~2n-1）：</p><p>UInt8 - [0 : 255]</p><p>UInt16 - [0 : 65535]</p><p>UInt32 - [0 : 4294967295]</p><p>UInt64 - [0 : 18446744073709551615]</p><blockquote><p>使用场景： 个数、数量、也可以存储型id</p></blockquote><h2 id="浮点型"><a href="#浮点型" class="headerlink" title="浮点型"></a><strong>浮点型</strong></h2><p>Float32 - float</p><p>Float64 – double</p><p>建议尽可能以整数形式存储数据。例如，将固定精度的数字转换为整数值，如时间用毫秒为单位表示，因为浮点型进行计算时可能引起四舍五入的误差。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">46</span>bb792f7762 :) <span class="hljs-keyword">select</span> <span class="hljs-number">1.0</span><span class="hljs-number">-0.9</span>;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-number">1.</span> <span class="hljs-operator">-</span> <span class="hljs-number">0.9</span><br><br>Query id: <span class="hljs-number">82</span>a9fb29<span class="hljs-number">-9</span>ac3<span class="hljs-number">-41</span>a1<span class="hljs-number">-918</span>d<span class="hljs-operator">-</span>a37ec7bff333<br><br>┌──────minus(<span class="hljs-number">1.</span>, <span class="hljs-number">0.9</span>)─┐<br>│ <span class="hljs-number">0.09999999999999998</span> │<br>└─────────────────────┘<br><br><span class="hljs-number">1</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.010</span> sec.<br></code></pre></td></tr></table></figure><blockquote><p>使用场景：一般数据值比较小，不涉及大量的统计计算，精度要求不高的时候。比如保存商品的重量。</p></blockquote><h2 id="布尔型"><a href="#布尔型" class="headerlink" title="布尔型"></a>布尔型</h2><p>没有单独的类型来存储布尔值。可以使用 UInt8 类型，取值限制为 0 或 1。</p><h2 id="Decimal-型"><a href="#Decimal-型" class="headerlink" title="Decimal 型"></a><strong>Decimal</strong> <strong>型</strong></h2><p>有符号的浮点数，可在加、减和乘法运算过程中保持精度。对于除法，最低有效数字会</p><p>被丢弃（不舍入）。</p><p>有三种声明：</p><p>➢ Decimal32(s)，相当于 Decimal(9-s,s)，有效位数为 1~9</p><p>➢ Decimal64(s)，相当于 Decimal(18-s,s)，有效位数为 1~18</p><p>➢ Decimal128(s)，相当于 Decimal(38-s,s)，有效位数为 1~38</p><p><strong>s 标识小数位</strong></p><blockquote><p>使用场景： 一般金额字段、汇率、利率等字段为了保证小数点精度，都使用 Decimal</p><p>进行存储。</p></blockquote><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a><strong>字符串</strong></h2><ul><li>String</li></ul><p>字符串可以任意长度的。它可以包含任意的字节集，包含空字节。</p><ul><li>FixedString(N)</li></ul><p>固定长度 N 的字符串，N 必须是严格的正自然数。当服务端读取长度小于 N 的字符</p><p>串时候，通过在字符串末尾添加空字节来达到 N 字节长度。 当服务端读取长度大于 N 的</p><p>字符串时候，将返回错误消息。</p><p>与 String 相比，极少会使用 FixedString，因为使用起来不是很方便。</p><blockquote><p>使用场景：名称、文字描述、字符型编码。 固定长度的可以保存一些定长的内容，比</p><p>如一些编码，性别等但是考虑到一定的变化风险，带来收益不够明显，所以定长字符串使用意义有限。</p></blockquote><h2 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a><strong>枚举类型</strong></h2><p>包括 Enum8 和 Enum16 类型。Enum 保存 ‘string’&#x3D; integer 的对应关系。</p><ul><li><p>Enum8 用 ‘String’&#x3D; Int8 对描述。</p></li><li><p>Enum16 用 ‘String’&#x3D; Int16 对描述。</p></li></ul><h3 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h3><ul><li><p>创建一个带有一个枚举 Enum8(‘hello’ &#x3D; 1, ‘world’ &#x3D; 2) 类型的列</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">46</span>bb792f7762 :) <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_enum<br>                (<br>                x Enum8(<span class="hljs-string">&#x27;hello&#x27;</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;world&#x27;</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>)<br>                )<br>                ENGINE <span class="hljs-operator">=</span> TinyLog;<br></code></pre></td></tr></table></figure></li><li><p><strong>这个</strong> <strong>x</strong> 列只能存储类型定义中列出的值：hello或world</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">46</span>bb792f7762 :) <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_enum <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;hello&#x27;</span>), (<span class="hljs-string">&#x27;world&#x27;</span>), (<span class="hljs-string">&#x27;hello&#x27;</span>);<br></code></pre></td></tr></table></figure></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225239055.png" alt="image-20230228225239055"></p><ul><li><strong>如果需要看到对应行的数值，则必须将</strong> <strong>Enum</strong> <strong>值转换为整数类型</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">46</span>bb792f7762 :)  <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CAST</span>(x, <span class="hljs-string">&#x27;Int8&#x27;</span>) <span class="hljs-keyword">FROM</span> t_enum;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225247973.png" alt="image-20230228225247973"></p><blockquote><p>使用场景：对一些状态、类型的字段算是一种空间优化，也算是一种数据约束。但是实</p><p>际使用中往往因为一些数据内容的变化增加一定的维护成本，甚至是数据丢失问题。所以谨慎使用。</p></blockquote><h2 id="时间类型"><a href="#时间类型" class="headerlink" title="时间类型"></a><strong>时间类型</strong></h2><p>目前 ClickHouse 有三种时间类型</p><p>➢ Date 接受<code>年-月-日</code>的字符串比如 ‘2019-12-16’ </p><p>➢ Datetime 接受<code>年-月-日 时:分:秒</code>的字符串比如 ‘2019-12-16 20:50:10’ </p><p>➢ Datetime64 接受<code>年-月-日 时:分:秒.亚秒</code>的字符串比如‘2019-12-16 20:50:10.66’</p><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a><strong>数组</strong></h2><p>Array(T)：由 T 类型元素组成的数组。</p><p>T 可以是任意类型，包含数组类型。 但不推荐使用多维数组，ClickHouse 对多维数组</p><p>的支持有限。例如，不能在 MergeTree 表中存储多维数组。</p><ul><li>创建数组方式 1，使用 array 函数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> x, toTypeName(x) ;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225259859.png" alt="image-20230228225259859"></p><ul><li>创建数组方式 2：使用方括号</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>] <span class="hljs-keyword">AS</span> x, toTypeName(x);<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225307055.png" alt="image-20230228225307055"></p><p>还有很多数据结构，可以参考官方文档：<a href="https://clickhouse.com/docs/zh/sql-reference/data-types/">简介 | ClickHouse文档</a></p>]]></content>
    
    
    <categories>
      
      <category>Clickhouse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker安装clickhouse</title>
    <link href="/docker-%E5%AE%89%E8%A3%85clickhouse/"/>
    <url>/docker-%E5%AE%89%E8%A3%85clickhouse/</url>
    
    <content type="html"><![CDATA[<p>1.启动容器服务，加载镜像</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  <span class="hljs-operator">~</span> docker run <span class="hljs-operator">-</span>d <span class="hljs-comment">--name ch-server --ulimit nofile=262144:262144 -p 8123:8123 -p 9000:9000 -p 9009:9009 yandex/clickhouse-server</span><br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225548754.png" alt="image-20230228225548754"></p><p>2.查看服务</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  <span class="hljs-operator">~</span> docker ps<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225555839.png" alt="image-20230228225555839"></p><p>3.进入docker容器内，使用用户名和密码连接数据库。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">➜  <span class="hljs-operator">~</span> docker <span class="hljs-keyword">exec</span> <span class="hljs-operator">-</span>it <span class="hljs-number">46</span>bb792f7762 <span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash<br>root<span class="hljs-variable">@46bb792f7762</span>:<span class="hljs-operator">/</span># clickhouse<span class="hljs-operator">-</span>client<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225603858.png" alt="image-20230228225603858"></p><blockquote><p>如果有密码，输入下面命令：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">&gt;</span>root<span class="hljs-variable">@46bb792f7762</span>:<span class="hljs-operator">/</span># clickhouse<span class="hljs-operator">-</span>client <span class="hljs-operator">-</span>u <span class="hljs-keyword">default</span> <span class="hljs-comment">--password test</span><br></code></pre></td></tr></table></figure></blockquote><p>4.查看数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">46</span>bb792f7762 :) <span class="hljs-keyword">show</span> databases;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225615339.png" alt="image-20230228225615339"></p><p>5.dbeaver 查看</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225624031.png" alt="image-20230228225624031"></p>]]></content>
    
    
    <categories>
      
      <category>Clickhouse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>clickhouse入门</title>
    <link href="/clickhouse%E5%85%A5%E9%97%A8/"/>
    <url>/clickhouse%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="ClickHouse-是什么？"><a href="#ClickHouse-是什么？" class="headerlink" title="ClickHouse 是什么？"></a><strong>ClickHouse</strong> 是什么？</h1><p>ClickHouse 是俄罗斯的 Yandex 于 2016 年开源的列式存储数据库（DBMS），使用 C++</p><p>语言编写，主要用于在线分析处理查询（OLAP），能够使用 SQL 查询实时生成分析数据报</p><p>告。</p><blockquote><ul><li>OLTP:   联机事务处理（Online Transaction Processing)。是mysql，oracle这种传统的关系型数据库的主要应用，适合做基本的日常的事务处理，增删改查等操作。</li><li>OLAP：联机分析处理（Online Analytical Processing)，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。适合做一次插入多次查询，适合分析，聚合的场景，但是对更新，删除不擅长。</li></ul></blockquote><h1 id="ClickHouse-的特点"><a href="#ClickHouse-的特点" class="headerlink" title="ClickHouse 的特点"></a>ClickHouse <strong>的特点</strong></h1><h2 id="1-列式存储"><a href="#1-列式存储" class="headerlink" title="1.列式存储"></a>1.<strong>列式存储</strong></h2><h3 id="行式存储和列式存储的对比"><a href="#行式存储和列式存储的对比" class="headerlink" title="行式存储和列式存储的对比"></a>行式存储和列式存储的对比</h3><ul><li><p>行式存储的好处是想查某个人所有的属性时，可以通过一次磁盘查找加顺序读取就可以。但是当想查所有人的年龄时，需要不停的查找，或者全表扫描才行，遍历的很多数据都是不需要的。</p></li><li><p>列式存储，想查所有人的年龄只需把年龄那一列拿出来就可以了</p></li></ul><p>以下面的表为例：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230156414.png" alt="image-20230228230156414"></p><ul><li><p>采用行式存储时，数据在磁盘上的组织结构为：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230204375.png"></p></li><li><p>采用列式存储时，数据在磁盘上的组织结构为：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230212410.png"></p></li></ul><h3 id="列式储存的好处："><a href="#列式储存的好处：" class="headerlink" title="列式储存的好处："></a><strong>列式储存的好处：</strong></h3><ul><li><p>对于列的聚合，计数，求和等统计操作原因优于行式存储。</p></li><li><p>由于某一列的数据类型都是相同的，针对于数据存储更容易进行数据压缩，每一列</p><p>选择更优的数据压缩算法，大大提高了数据的压缩比重。</p></li><li><p>由于数据压缩比更好，一方面节省了磁盘空间，另一方面对于 cache 也有了更大的</p></li></ul><p>发挥空间</p><h2 id="DBMS-的功能"><a href="#DBMS-的功能" class="headerlink" title="DBMS 的功能"></a><strong>DBMS</strong> <strong>的功能</strong></h2><p>几乎覆盖了标准 SQL 的大部分语法，包括 DDL 和 DML，以及配套的各种函数，用户管</p><p>理及权限管理，数据的备份与恢复。 </p><blockquote><p>数据库管理系统（英语：database management system，缩写：DBMS）即数据库管理软件，是一种针对对象数据库，为管理数据库而设计的大型计算机软件管理系统。</p><p>具有代表性的数据管理系统有：Oracle、Microsoft SQL Server、Access、MySQL及PostgreSQL等。通常数据库管理师会使用数据库管理系统来创建数据库系统。</p></blockquote><h2 id="多样化引擎"><a href="#多样化引擎" class="headerlink" title="多样化引擎"></a><strong>多样化引擎</strong></h2><p>ClickHouse 和 MySQL 类似，把表级的存储引擎插件化，根据表的不同需求可以设定不同</p><p>的存储引擎。目前包括合并树、日志、接口和其他四大类 20 多种引擎。</p><h2 id="高吞吐写入能力"><a href="#高吞吐写入能力" class="headerlink" title="高吞吐写入能力"></a>高吞吐写入能力</h2><ul><li><p>ClickHouse 采用类 LSM Tree的结构，数据写入后定期在后台 Compaction。通过类 LSM tree的结构，ClickHouse 在数据导入时全部是顺序 append 写，写入后数据段不可更改，在后台compaction 时也是多个段 merge sort 后顺序写回磁盘。顺序写的特性，充分利用了磁盘的吞吐能力，即便在 HDD 上也有着优异的写入性能。</p></li><li><p>官方公开 benchmark 测试显示能够达到 50MB-200MB&#x2F;s 的写入吞吐能力，按照每行</p></li></ul><p>100Byte 估算，大约相当于 50W-200W 条&#x2F;s 的写入速度。</p><p><a href="https://zhuanlan.zhihu.com/p/415799237">深入浅出分析LSM树（日志结构合并树） - 知乎 (zhihu.com)</a></p><blockquote><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230231533.png"></p></blockquote><h3 id="数据分区与线程级并行"><a href="#数据分区与线程级并行" class="headerlink" title="数据分区与线程级并行"></a><strong>数据分区与线程级并行</strong></h3><ul><li>ClickHouse 将数据划分为多个 partition，每个 partition 再进一步划分为多个 index</li></ul><p>granularity(索引粒度)，然后通过多个 CPU核心分别处理其中的一部分来实现并行数据处理。</p><p>在这种设计下，<strong>单条 Query 就能利用整机所有 CPU</strong>。极致的并行处理能力，极大的降低了查</p><p>询延时。</p><ul><li>所以，ClickHouse 即使对于大量数据的查询也能够化整为零平行处理。但是有一个弊端</li></ul><p>就是对于单条查询使用多 cpu，就不利于同时并发多条查询。所以对于高 qps 的查询业务，</p><p>ClickHouse 并不是强项。</p><blockquote><p>QPS（<strong>Query Per Second</strong>）：每秒请求数，就是说服务器在一秒的时间内处理了多少个请求。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Clickhouse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/zookeeper%E5%85%A5%E9%97%A8/"/>
    <url>/zookeeper%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<hr><p>title: zookeeper特性与节点介绍<br>date: 2021-09-22 22:43:51<br>tags:  分布式框架</p><p>categories:  zookeeper</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="1-产生背景"><a href="#1-产生背景" class="headerlink" title="1 产生背景"></a>1 产生背景</h2><ol><li><p>单体向分布式服务转变，会产生多个节点间协同问题，如：</p><blockquote><ul><li><p>假设有3个节点，1个job，该job该由哪个节点执行？</p></li><li><p>若该job由节点1执行，要是1挂了，现在该2还是3执行？</p></li></ul></blockquote></li><li><p>上游和下游服务的发现，如：</p><blockquote><ul><li>上游挂了，下游怎么知道？</li><li>下游服务新增，上游怎么知道？</li></ul></blockquote></li><li><p>多节点的协调问题，如：并发产生了请求，该怎么保证请求的幂等性？</p></li></ol><blockquote><p><strong>由于节点自身协调不可靠，性能不高，故需要一个独立服务来做协调，他必须可靠且保证性能。</strong></p></blockquote><h2 id="2-概要"><a href="#2-概要" class="headerlink" title="2 概要"></a>2 概要</h2><ol><li>zookeeper是用于分布式服务的协调服务。</li><li>它对外公布了一组简单的API，分布式应用程序可以基于这些API，用于同步节点状态，节点配置，服务注册等信息</li><li>它支持java和c两种语言。</li></ol><h2 id="3-工作机制"><a href="#3-工作机制" class="headerlink" title="3 工作机制"></a>3 工作机制</h2><p>从设计模式的角度理解，zookeeper基于观察者模式。他负责存储和管路大家都关心的数据，然后接受观察，一旦数据状态发生变化，zookeeper就通知注册者。</p><h2 id="4-特点"><a href="#4-特点" class="headerlink" title="4 特点"></a>4 特点</h2><ol><li>zookeeper是由一个leader和多个follower组成的集群</li><li>半数以上节点存活，zookeeper 即可以正常服务</li><li>每个server的数据一致</li><li>来自同一个client的请求依次执行</li><li>原子性，数据更新要么成功，要么失败</li><li>zookeeper数据量少，故同步快，一定时间内，client可以读到最新数据</li></ol><h2 id="5-zookeeper-启动"><a href="#5-zookeeper-启动" class="headerlink" title="5 zookeeper 启动"></a>5 zookeeper 启动</h2><ul><li>官网下载最新版本 <a href="https://www.apache.org/dyn/closer.lua/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz">Apache Downloads</a>，并解压</li><li>进入conf目录，拷贝默认配置  <code>cp zoo_sample.cfg   zoo.cfg</code></li><li>进入bin目录，启动服务端<code>./zkServer.sh start</code></li><li>进入bin目录，进入客户端<code>./zkCli.sh</code></li></ul><h2 id="6-常规配置文件说明"><a href="#6-常规配置文件说明" class="headerlink" title="6 常规配置文件说明"></a>6 常规配置文件说明</h2><blockquote><p>tickTime&#x3D;2000   #zookeeper时间配置中的基本单位 (毫秒) </p></blockquote><blockquote><p>initLimit&#x3D;10     #允许follower初始化连接到leader最大时长，它表示tickTime时间倍数 即:initLimit*tickTime</p></blockquote><blockquote><p>syncLimit&#x3D;5 #允许follower与leader数据同步最大时长,它表示tickTime时间倍数</p></blockquote><blockquote><p>dataDir&#x3D;&#x2F;tmp&#x2F;zookeeper  #zookeper 数据存储目录</p></blockquote><blockquote><p>clientPort&#x3D;2181  #对客户端提供的端口号</p></blockquote><blockquote><p>maxClientCnxns&#x3D;60  #单个客户端与zookeeper最大并发连接数</p></blockquote><blockquote><p>autopurge.snapRetainCount&#x3D;3. #保存的数据快照数量，之外的将会被清除</p></blockquote><blockquote><p>autopurge.purgeInterval&#x3D;1  #自动触发清除任务时间间隔，小时为单位。默认为0，表示不自动清除。</p></blockquote><h2 id="7-客户端命令"><a href="#7-客户端命令" class="headerlink" title="7 客户端命令"></a>7 客户端命令</h2><ul><li><p>close     关闭当前会话</p></li><li><p>connect host:port        重新连接指定Zookeeper服务</p></li><li><p>create [-s] [-e] [-c] [-t ttl] path [data] [acl]          创建节点</p></li><li><p>delete [-v version] path             删除节点，(不能存在子节点） </p></li><li><p>deleteall path [-b batch size]      删除路径及所有子节点</p></li><li><p>get [-s] [-w] path.        查看节点数据 -s 包含节点状态 -w 添加监听 </p></li><li><p>getAcl [-s] path.      列出子节点 -s状态 -R 递归查看所有子节点 -w 添加监听</p></li><li><p>history     查看执行的历史记录</p></li><li><p>redo cmdno  重复 执行命令，history 中命令编号确定</p></li><li><p>quit  退出客户端</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs sql">[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">1</span>] ls <span class="hljs-operator">/</span><br>[zookeeper]<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">2</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">/</span>node1<br>Created <span class="hljs-operator">/</span>node1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">3</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<br><span class="hljs-keyword">null</span><br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">4</span>] <span class="hljs-keyword">set</span> <span class="hljs-operator">/</span>node1 &quot;node1 value&quot;<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">5</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<br>node1 <span class="hljs-keyword">value</span><br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">6</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1<br>Created <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">7</span>] <span class="hljs-keyword">set</span>  <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1 &quot;child1&quot;<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">8</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1 &quot;child1&quot;<br><span class="hljs-string">&#x27;get path [watch]&#x27;</span> has been deprecated. Please use <span class="hljs-string">&#x27;get [-s] [-w] path&#x27;</span> instead.<br>child1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">9</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1<br>child1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">10</span>] <span class="hljs-keyword">delete</span> <span class="hljs-operator">/</span>node1<br>Node <span class="hljs-keyword">not</span> <span class="hljs-keyword">empty</span>: <span class="hljs-operator">/</span>node1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">11</span>] deleteall <span class="hljs-operator">/</span>node1<br>WATCHER::<br>WatchedEvent state:SyncConnected type:NodeDeleted path:<span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">12</span>] ls <span class="hljs-operator">/</span><br>[zookeeper]<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">13</span>] history<br><span class="hljs-number">3</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<br><span class="hljs-number">4</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">set</span> <span class="hljs-operator">/</span>node1 &quot;node1 value&quot;<br><span class="hljs-number">5</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<br><span class="hljs-number">6</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">create</span> <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1<br><span class="hljs-number">7</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">set</span>  <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1 &quot;child1&quot;<br><span class="hljs-number">8</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1 &quot;child1&quot;<br><span class="hljs-number">9</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">get</span> <span class="hljs-operator">/</span>node1<span class="hljs-operator">/</span>child1<br><span class="hljs-number">10</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">delete</span> <span class="hljs-operator">/</span>node1<br><span class="hljs-number">11</span> <span class="hljs-operator">-</span> deleteall <span class="hljs-operator">/</span>node1<br><span class="hljs-number">12</span> <span class="hljs-operator">-</span> ls <span class="hljs-operator">/</span><br><span class="hljs-number">13</span> <span class="hljs-operator">-</span> history<br><br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">16</span>] redo <span class="hljs-number">2</span><br>Created <span class="hljs-operator">/</span>node1<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">17</span>] ls <span class="hljs-operator">/</span><br>[node1, zookeeper]<br>[zk: localhost:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">18</span>] <span class="hljs-keyword">get</span> <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>node1<br><span class="hljs-keyword">null</span><br>cZxid <span class="hljs-operator">=</span> <span class="hljs-number">0x8</span><br>ctime <span class="hljs-operator">=</span> Thu Jan <span class="hljs-number">13</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> CST <span class="hljs-number">2022</span><br>mZxid <span class="hljs-operator">=</span> <span class="hljs-number">0x8</span><br>mtime <span class="hljs-operator">=</span> Thu Jan <span class="hljs-number">13</span> <span class="hljs-number">22</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> CST <span class="hljs-number">2022</span><br>pZxid <span class="hljs-operator">=</span> <span class="hljs-number">0x8</span><br>cversion <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>dataVersion <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>aclVersion <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>ephemeralOwner <span class="hljs-operator">=</span> <span class="hljs-number">0x0</span><br>dataLength <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>numChildren <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>数据库实现分布式锁</title>
    <link href="/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="1-什么是分布式锁"><a href="#1-什么是分布式锁" class="headerlink" title="1 什么是分布式锁"></a>1 什么是分布式锁</h1><ul><li>在单体的应用开发场景中涉及并发同步的时候，大家往往采用Synchronized（同步）或者其他同一个JVM内Lock机制来解决多线程间的同步问题。</li><li>在分布式集群工作的开发场景中，就需要一种更加高级的锁机制来处理跨机器的进程之间的数据同步问题，这种跨机器的锁就是分布式锁</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222616394.png" alt="image-20230228222616394"></p><h1 id="2-基于数据库实现分布式锁"><a href="#2-基于数据库实现分布式锁" class="headerlink" title="2 基于数据库实现分布式锁"></a>2 基于数据库实现分布式锁</h1><p>基于数据库实现分布式锁主要是利用数据库的唯一索引来实现，唯一索引天然具有排他性，这刚好符合我们对锁的要求</p><h2 id="2-1-设计原理"><a href="#2-1-设计原理" class="headerlink" title="2.1 设计原理"></a>2.1 设计原理</h2><ul><li>同一时刻只能允许一个竞争者获取锁。加锁时我们在数据库中插入一条记录，利用唯一键进行防重。</li><li>当竞争者A加锁成功后，第竞争者B再来加锁就会抛出唯一索引冲突，如果抛出这个异常，我们就判定竞争者B加锁失败</li><li>竞争者B加锁失败后，会阻塞等待，一直到竞争者A释放锁（也就是删除记录后），再去获取锁</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228222626149.png" alt="image-20230228222626149"></p><h2 id="2-2-实现注意事项"><a href="#2-2-实现注意事项" class="headerlink" title="2.2 实现注意事项"></a>2.2 实现注意事项</h2><ul><li>没有锁超时机制。如果程序发生了异常，将无法删除数据，也就是锁无法被释放掉，需要自己写一套锁超时机制，比如：在表中新增一列，用于记录失效时间，并且需要有定时任务清除这些失效的数据；</li><li>基于数据库实现的，数据库的可用性和性能将直接影响分布式锁的可用性及性能，可以考虑实现数据库的高可用方案</li><li>自旋实现阻塞效果。当获取锁失败时自旋转</li><li>如果使用数据库自增 id ,<strong>规律太明显</strong></li><li><strong>受单表数据量的限制</strong> 在高并发场景下，我们都知道 MySQL 的单张表根本不可能容纳大量数据（性能等原因的限制）；如果是将单表拆成多表，还是用数据库自增 id 的话，就存在了 id 重复的情况了，很显然这是业务不允许的。</li></ul><blockquote><p>db操作性能较差，并且有锁表的风险，一般不考虑。</p></blockquote><h2 id="2-3-代码示例"><a href="#2-3-代码示例" class="headerlink" title="2.3 代码示例"></a>2.3 代码示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"> */<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span></span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁，增加重试逻辑</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//尝试获取锁</span><br>        <span class="hljs-keyword">if</span>(tryLock())&#123;<br>            System.out.println(<span class="hljs-string">&quot;---------获取锁---------&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//等待锁 阻塞</span><br>            waitLock();<br>            <span class="hljs-comment">//重试</span><br>            lock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MysqlDistributedLock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLock</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MethodlockMapper baseMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//插入一条数据   insert into</span><br>            baseMapper.insert(<span class="hljs-keyword">new</span> Methodlock(<span class="hljs-string">&quot;lock&quot;</span>));<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            <span class="hljs-comment">//插入失败</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">waitLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">10</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//删除数据   delete</span><br>        baseMapper.deleteByMethodlock(<span class="hljs-string">&quot;lock&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;-------释放锁------&quot;</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
      <tag>zookeeper</tag>
      
      <tag>redis</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis缓存问题</title>
    <link href="/Redis%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/"/>
    <url>/Redis%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-缓存穿透"><a href="#1-缓存穿透" class="headerlink" title="1 缓存穿透"></a>1 <strong>缓存穿透</strong></h1><h2 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h2><p>缓存穿透是指查询一个根本不存在的数据， 缓存层和存储层都不会命中， 导致不存在的数据每次请求都要到存储层去查询， 失去了缓存保护后端存储的意义。 </p><h2 id="1-2-产生原因"><a href="#1-2-产生原因" class="headerlink" title="1.2 产生原因"></a>1.2 产生原因</h2><ul><li>自身业务代码或者数据出现问题。 </li><li>一些恶意攻击、 爬虫等造成大量空命中。</li></ul><h2 id="1-3-解决方案"><a href="#1-3-解决方案" class="headerlink" title="1.3 解决方案"></a>1.3 解决方案</h2><h3 id="1-3-1-缓存空对象"><a href="#1-3-1-缓存空对象" class="headerlink" title="1.3.1 缓存空对象"></a>1.3.1 缓存空对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;<br>    <span class="hljs-comment">// 从缓存中获取数据</span><br>    String cacheValue = cache.get(key);<br>    <span class="hljs-comment">// 缓存为空</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(cacheValue)) &#123;<br>        <span class="hljs-comment">// 从存储中获取</span><br>        String storageValue = storage.get(key);<br>        cache.set(key, storageValue);<br>        <span class="hljs-comment">// 如果存储数据为空， 需要设置一个过期时间(300秒)</span><br>        <span class="hljs-keyword">if</span> (storageValue == <span class="hljs-keyword">null</span>) &#123;<br>            cache.expire(key, <span class="hljs-number">60</span> * <span class="hljs-number">5</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> storageValue;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 缓存非空</span><br>        <span class="hljs-keyword">return</span> cacheValue;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-2-布隆过滤器"><a href="#1-3-2-布隆过滤器" class="headerlink" title="1.3.2 布隆过滤器"></a>1.3.2 布隆过滤器</h3><p>在访问缓存前，先用布隆过滤器先做一次过滤。对于不存在的数据布隆过滤器一般都能够过滤掉，不让请求再往后端发送。</p><p>布隆过滤器底层就是实现了一个大型的二进制数组，我们需要在使用前将所有的数据放入布隆过滤器，并且在增加数据时也要往布隆过滤器里放，布隆过滤器可以根据多个hash算法对key进行hash+数组长度取模的方式，给每一条数据计算出多个位置。</p><p>所以在访问数据是否存在时，他也会把这几个位置算出来，如果这几个位置有一个为0，那么就说明这个数据一定不存在。因为存在hash碰撞，所以如果所有位都为1，不能说明这个key一定存在。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225351935.png" alt="image-20230228225351935"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.redisson;<br><br><span class="hljs-keyword">import</span> org.redisson.Redisson;<br><span class="hljs-keyword">import</span> org.redisson.api.RBloomFilter;<br><span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;<br><span class="hljs-keyword">import</span> org.redisson.config.Config;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedissonBloomFilter</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Config config = <span class="hljs-keyword">new</span> Config();<br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://localhost:6379&quot;</span>);<br>        <span class="hljs-comment">//构造Redisson</span><br>        RedissonClient redisson = Redisson.create(config);<br><br>        RBloomFilter&lt;String&gt; bloomFilter = redisson.getBloomFilter(<span class="hljs-string">&quot;nameList&quot;</span>);<br>        <span class="hljs-comment">//初始化布隆过滤器：预计元素为100000000L,误差率为3%,根据这两个参数会计算出底层的bit数组大小</span><br>        bloomFilter.tryInit(<span class="hljs-number">100000000L</span>,<span class="hljs-number">0.03</span>);<br>      <br>        <span class="hljs-comment">//把所有数据存入布隆过滤器</span><br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>            <span class="hljs-keyword">for</span> (String key: keys) &#123;<br>                bloomFilter.put(key);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;<br>            <span class="hljs-comment">// 从布隆过滤器这一级缓存判断下key是否存在</span><br>            Boolean exist = bloomFilter.contains(key);<br>            <span class="hljs-keyword">if</span>(!exist)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>            <span class="hljs-comment">// 从缓存中获取数据</span><br>            String cacheValue = cache.get(key);<br>            <span class="hljs-comment">// 缓存为空</span><br>            <span class="hljs-keyword">if</span> (StringUtils.isBlank(cacheValue)) &#123;<br>                <span class="hljs-comment">// 从存储中获取</span><br>                String storageValue = storage.get(key);<br>                cache.set(key, storageValue);<br>                <span class="hljs-comment">// 如果存储数据为空， 需要设置一个过期时间(300秒)</span><br>                <span class="hljs-keyword">if</span> (storageValue == <span class="hljs-keyword">null</span>) &#123;<br>                    cache.expire(key, <span class="hljs-number">60</span> * <span class="hljs-number">5</span>);<br>                &#125;<br>                <span class="hljs-keyword">return</span> storageValue;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 缓存非空</span><br>                <span class="hljs-keyword">return</span> cacheValue;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-缓存失效-击穿"><a href="#2-缓存失效-击穿" class="headerlink" title="2 缓存失效(击穿)"></a>2 <strong>缓存失效(击穿)</strong></h1><h2 id="2-1-定义"><a href="#2-1-定义" class="headerlink" title="2.1 定义"></a>2.1 定义</h2><p>由于大批量缓存在同一时间失效可能导致大量请求同时穿透缓存直达数据库，可能会造成数据库瞬间压力过大 甚至挂掉。</p><h2 id="2-2-产生原因"><a href="#2-2-产生原因" class="headerlink" title="2.2 产生原因"></a>2.2 产生原因</h2><p>大批量缓存在同一时间失效</p><h2 id="2-3-解决方案"><a href="#2-3-解决方案" class="headerlink" title="2.3 解决方案"></a>2.3 解决方案</h2><h3 id="2-3-1-将这一批数据的缓存过期时间设置为一个时间段内的不同时间。"><a href="#2-3-1-将这一批数据的缓存过期时间设置为一个时间段内的不同时间。" class="headerlink" title="2.3.1 将这一批数据的缓存过期时间设置为一个时间段内的不同时间。"></a>2.3.1 将这一批数据的缓存过期时间设置为一个时间段内的不同时间。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;<br>    <span class="hljs-comment">// 从缓存中获取数据</span><br>    String cacheValue = cache.get(key);<br>    <span class="hljs-comment">// 缓存为空</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(cacheValue)) &#123;<br>        <span class="hljs-comment">// 从存储中获取</span><br>        String storageValue = storage.get(key);<br>        cache.set(key, storageValue);<br>        <span class="hljs-comment">//设置一个过期时间(300到600之间的一个随机数)</span><br>        <span class="hljs-keyword">int</span> expireTime = <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">300</span>)  + <span class="hljs-number">300</span>;<br>        <span class="hljs-keyword">if</span> (storageValue == <span class="hljs-keyword">null</span>) &#123;<br>            cache.expire(key, expireTime);<br>        &#125;<br>        <span class="hljs-keyword">return</span> storageValue;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 缓存非空</span><br>        <span class="hljs-keyword">return</span> cacheValue;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-缓存雪崩"><a href="#3-缓存雪崩" class="headerlink" title="3 缓存雪崩"></a>3 <strong>缓存雪崩</strong></h1><h2 id="3-1-定义"><a href="#3-1-定义" class="headerlink" title="3.1 定义"></a>3.1 定义</h2><p>缓存雪崩指的是缓存层支撑不住或宕掉后， 流量打向后端存储层 ，存储层的调用量会暴增， 造成存储层也会级联宕机的情况。</p><h2 id="3-2-产生原因"><a href="#3-2-产生原因" class="headerlink" title="3.2 产生原因"></a>3.2 产生原因</h2><ul><li>redis集群挂了</li><li>请求数量大于redis可承受的最大数量</li></ul><h2 id="3-3-解决方案"><a href="#3-3-解决方案" class="headerlink" title="3.3 解决方案"></a>3.3 解决方案</h2><h3 id="3-3-1-保证缓存层服务高可用性"><a href="#3-3-1-保证缓存层服务高可用性" class="headerlink" title="3.3.1 保证缓存层服务高可用性"></a>3.3.1 保证缓存层服务高可用性</h3><p>比如使用Redis Sentinel或Redis Cluster。 </p><h3 id="3-3-2-后端限流熔断并降级。"><a href="#3-3-2-后端限流熔断并降级。" class="headerlink" title="3.3.2 后端限流熔断并降级。"></a>3.3.2 后端限流熔断并降级。</h3><p>比如使用Sentinel或Hystrix限流降级组件。 </p><ul><li>比如服务降级，我们可以针对不同的数据采取不同的处理方式。<ul><li>当业务应用访问的是非核心数据（例如电商商 品属性，用户信息等）时，暂时停止从缓存中查询这些数据，而是直接返回预定义的默认降级信息、空值或是错误提示信息；</li><li>当业务应用访问的是核心数据（例如电商商品库存）时，仍然允许查询缓存，如果缓存缺失， 也可以继续通过数据库读取。</li></ul></li></ul><h1 id="4-Redis热key问题"><a href="#4-Redis热key问题" class="headerlink" title="4 Redis热key问题"></a>4 Redis热key问题</h1><h2 id="4-1定义"><a href="#4-1定义" class="headerlink" title="4.1定义"></a>4.1定义</h2><p>在Redis中，我们把访问频率高的Key，称为热Key（例如一个热门的娱乐新闻））。热key问题就是，突然有几十万的请求去访问redis上的某个特定key。那么这样会造成redis服务器短时间流量过于集中，很可能导致redis的服务器宕机。那么接下来对这个Key的请求，都会直接请求到我们的后端数据库中，数据库性能本来就不高，这样就可能直接压垮数据库，进而导致后端服务不可用。</p><h2 id="4-2-产生原因"><a href="#4-2-产生原因" class="headerlink" title="4.2 产生原因"></a>4.2 产生原因</h2><p>用户消费的数据远大于生产的数据，如商品秒杀、热点新闻、热点评论等读多写少的场景</p><p>双十一秒杀商品，短时间内某个爆款商品可能被点击&#x2F;购买上百万次，或者某条爆炸性新闻等被大量浏览，此时会造成一个较大的请求Redis量，这种情况下就会造成热点Key问题。</p><h2 id="4-3-怎么发现热key"><a href="#4-3-怎么发现热key" class="headerlink" title="4.3 怎么发现热key"></a>4.3 怎么发现热key</h2><ol><li><p>凭借业务经验，进行预估哪些是热key<br>其实这个方法还是挺有可行性的。比如某商品在做秒杀，那这个商品的key就可以判断出是热key。缺点很明显，并非所有业务都能预估出哪些key是热key。</p></li><li><p><em>在客户端进行收集</em>。</p><p>操作redis之前，加入一行代码进行数据统计。那么这个数据统计的方式有很多种，也可以是给外部的通讯系统发送一个通知信息。缺点就是对客户端代码造成入侵。</p></li><li><p>用redis自带命令</p><p>(1). monitor命令，该命令可以实时抓取出redis服务器接收到的命令，然后写代码统计出热key是啥。当然，也有现成的分析工具可以给你使用，比如<code>redis-faina</code>。但是该命令在高并发的条件下，有内存增暴增的隐患，还会降低redis的性能。<br>(2). hotkeys参数，redis 4.0.3提供了redis-cli的热点key发现功能，执行redis-cli时加上–hotkeys选项即可。但是该参数在执行的时候，如果key比较多，执行起来比较慢。</p></li><li><p><em>自己抓包评估</em></p><p>自己写程序监听端口，按照RESP协议规则解析数据，进行分析。缺点就是开发成本高，维护困难，有丢包可能性。</p></li></ol><h2 id="4-4-如何解决"><a href="#4-4-如何解决" class="headerlink" title="4.4 如何解决"></a>4.4 如何解决</h2><ol><li>Redis集群扩容：增加分片副本，分摊客户端发过来的读请求；**</li><li>使用二级缓存，即JVM本地缓存，减少Redis的读请求。比如利用<code>HashMap</code>。在你发现热key以后，把热key加载到系统的JVM中。针对这种热key请求，会直接从jvm中取，而不会走到redis层。</li></ol><h3 id="4-3-1-互斥锁"><a href="#4-3-1-互斥锁" class="headerlink" title="4.3.1 互斥锁"></a>4.3.1 互斥锁</h3><p>利用互斥锁来解决，此方法只允许一个线程重建缓存， 其他线程等待重建缓存的线程执行完， 重新从缓存获取数据即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;<br>    <span class="hljs-comment">// 从Redis中获取数据</span><br>    String value = redis.get(key);<br>    <span class="hljs-comment">// 如果value为空， 则开始重构缓存</span><br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">// 只允许一个线程重建缓存， 使用nx， 并设置过期时间ex</span><br>        String mutexKey = <span class="hljs-string">&quot;mutext:key:&quot;</span> + key;<br>        <span class="hljs-keyword">if</span> (redis.set(mutexKey, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;ex 180&quot;</span>, <span class="hljs-string">&quot;nx&quot;</span>)) &#123;<br>             <span class="hljs-comment">// 从数据源获取数据</span><br>            value = db.get(key);<br>            <span class="hljs-comment">// 回写Redis， 并设置过期时间</span><br>            redis.setex(key, timeout, value);<br>            <span class="hljs-comment">// 删除key_mutex</span><br>            redis.delete(mutexKey);<br>        &#125;<span class="hljs-comment">// 其他线程休息50毫秒后重试</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>            get(key);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="5-缓存与数据库不一致"><a href="#5-缓存与数据库不一致" class="headerlink" title="5 缓存与数据库不一致"></a>5 <strong>缓存与数据库不一致</strong></h1><h2 id="5-1-定义"><a href="#5-1-定义" class="headerlink" title="5.1 定义"></a>5.1 定义</h2><p>在大并发下，同时操作数据库与缓存会存在数据不一致性问题</p><h2 id="5-2-缓存一致性的解决方案"><a href="#5-2-缓存一致性的解决方案" class="headerlink" title="5.2 缓存一致性的解决方案"></a>5.2 缓存一致性的解决方案</h2><table><thead><tr><th>方案</th><th>一致性类型</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>合理设置缓存时间</td><td></td><td></td><td></td></tr><tr><td>消息队列</td><td>最终一致性</td><td>实现简单，适合异步场景</td><td>存在短暂不一致状态</td></tr><tr><td>在数据库中增加时间戳&#x2F;版本号</td><td>最终一致性</td><td>简单易实现</td><td>需要额外字段</td></tr><tr><td>双写 + 延迟双删</td><td>最终一致性</td><td>实现简单</td><td>存在短暂不一致状态</td></tr><tr><td>Binlog 同步</td><td>最终一致性</td><td>自动化程度高</td><td>需要额外的工具支持</td></tr><tr><td>分布式锁</td><td>最终一致性</td><td></td><td></td></tr></tbody></table><h3 id="5-2-1-合理设置缓存过期时间"><a href="#5-2-1-合理设置缓存过期时间" class="headerlink" title="5.2.1 合理设置缓存过期时间"></a>5.2.1 合理设置缓存过期时间</h3><p>对于并发几率很小的数据(如个人维度的订单数据、用户数据等)，这种几乎不用考虑这个问题，很少会发生缓存不一致，可以给缓存数据加上过期时间，每隔一段时间触发读的主动更新即可。</p><h3 id="5-2-2-异步消息队列"><a href="#5-2-2-异步消息队列" class="headerlink" title="5.2.2 异步消息队列"></a>5.2.2 <strong>异步消息队列</strong></h3><ol><li>更新数据库中的数据，并将更新事件发送到消息队列。</li><li>消息队列中的消费者接收到事件后，更新 Redis 中的数据。</li><li>如果 Redis 更新失败，可以通过重试机制或人工干预解决问题。</li></ol><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a><strong>优点</strong></h5><ul><li>实现简单，适合异步场景。</li><li>减少了数据库的压力。</li></ul><h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a><strong>缺点</strong></h5><ul><li>存在短暂的不一致状态。</li><li>需要额外的消息队列组件。</li><li>需要保证消息的<a href="https://pyr9.github.io/kafka%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%B6%E4%B8%A2%E5%A4%B1%E6%96%B9%E6%A1%88/">可靠性</a>、<a href="https://pyr9.github.io/kafka%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#%E6%B6%88%E8%B4%B9%E9%A1%BA%E5%BA%8F%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%EF%BC%9F">顺序性</a>、<a href="https://pyr9.github.io/kafka%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#kafka-%E5%A6%82%E4%BD%95%E4%B8%8D%E6%B6%88%E8%B4%B9%E9%87%8D%E5%A4%8D%E6%95%B0%E6%8D%AE%EF%BC%9F">幂等性</a></li></ul><h3 id="5-2-2基于时间戳或版本号的冲突检测"><a href="#5-2-2基于时间戳或版本号的冲突检测" class="headerlink" title="5.2.2基于时间戳或版本号的冲突检测"></a>5.2.2<strong>基于时间戳或版本号的冲突检测</strong></h3><p>通过在数据库和 Redis 中记录时间戳或版本号，可以检测和解决数据冲突。</p><h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a><strong>流程</strong></h5><ol><li>在数据库中增加一个 <code>version</code> 或 <code>timestamp</code> 字段。</li><li>更新数据库时，同时更新该字段。</li><li>更新 Redis 时，检查其版本号或时间戳是否与数据库一致。</li><li>如果不一致，则以数据库为准进行修正。</li></ol><h5 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a><strong>优点</strong></h5><ul><li>简单易实现，适合中小型系统。</li><li>不需要额外的组件。</li></ul><h3 id="5-2-2-双写策略-延迟双删"><a href="#5-2-2-双写策略-延迟双删" class="headerlink" title="5.2.2 双写策略+ 延迟双删"></a>5.2.2 <strong>双写策略</strong>+ 延迟双删</h3><p>这是一种常见的缓存更新策略，适用于读多写少的场景。</p><h5 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a><strong>流程</strong></h5><ol><li>写操作<ul><li>先更新数据库。</li><li>再更新 Redis。</li></ul></li><li>删除操作<ul><li>先删除 Redis 中的数据。</li><li>延迟一段时间后再删除数据库中的数据（防止 Redis 删除后未及时同步）。</li></ul></li></ol><h5 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a><strong>优点</strong></h5><ul><li>实现简单，适合大多数场景。</li><li>不需要额外的组件。</li></ul><h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a><strong>缺点</strong></h5><ul><li>存在短暂的不一致状态。</li><li>删除操作需要延迟处理。</li></ul><h3 id="5-2-1-使用分布式锁"><a href="#5-2-1-使用分布式锁" class="headerlink" title="5.2.1 使用分布式锁"></a>5.2.1 <strong>使用分布式锁</strong></h3><p>在高并发场景下，使用分布式锁（如Redis，zookeeper分布式锁）来控制缓存的更新操作，确保数据的一致性。</p><h3 id="5-5-4-基于数据库-Binlog-的自动同步"><a href="#5-5-4-基于数据库-Binlog-的自动同步" class="headerlink" title="5.5.4 基于数据库 Binlog 的自动同步"></a>5.5.4 <strong>基于数据库 Binlog 的自动同步</strong></h3><p>通过订阅数据库的 Binlog（二进制日志），可以实时将数据同步到 Redis。</p><h5 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a><strong>流程</strong></h5><ol><li>数据库写入数据时，生成 Binlog。</li><li>使用工具（如 Canal、Debezium）订阅 Binlog，捕获数据变更。</li><li>根据捕获的变更事件，自动更新 Redis。</li></ol><h5 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a><strong>优点</strong></h5><ul><li>自动化程度高，无需修改业务代码。</li><li>实时性强，适合对一致性要求较高的场景。</li></ul><h5 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a><strong>缺点</strong></h5><ul><li>对数据库性能有一定影响。</li><li>需要额外的工具支持。</li></ul><p><strong>选择哪种方案取决于具体需求：</strong></p><ul><li><p>如果可以容忍短暂的不一致，可以选择 <strong>消息队列</strong> 或 <strong>双写 + 延迟双删</strong>。</p></li><li><p>如果需要强一致性，可以选择 <strong>Binlog 同步</strong>或<strong>分布式锁</strong>。</p></li></ul><p>注：<strong>放入缓存的数据应该是对实时性、一致性要求不是很高的数据。</strong>如果<strong>写多读多</strong>的情况又不能容忍缓存数据不一致，那就没必要加缓存了，可以直接操作数据库。如果数据库抗不住压力，还可以把缓存作为数据读写的主存储，异步将数据同步到数据库，数据库只是作为数据的备份。</p>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>缓存</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis集群三种方式</title>
    <link href="/Redis%E9%9B%86%E7%BE%A4%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/"/>
    <url>/Redis%E9%9B%86%E7%BE%A4%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="为什么要有集群"><a href="#为什么要有集群" class="headerlink" title="为什么要有集群"></a>为什么要有集群</h1><ul><li>单个Redis存在不稳定性，当Redis服务宕机或硬盘故障，系统崩溃之后，就没有可用的服务了，还会造成数据的丢失</li><li>单个Redis的读写能力也是有限的</li><li>还由于互联网的三高<a href="https://so.csdn.net/so/search?q=%E6%9E%B6%E6%9E%84&spm=1001.2101.3001.7020">架构</a>，高并发，高性能，高可用</li></ul><blockquote><p>通过添加服务器的数量，提供相同的服务，从而让服务器达到一个稳定，高效的状态</p></blockquote><h1 id="Redis集群的三种模式"><a href="#Redis集群的三种模式" class="headerlink" title="Redis集群的三种模式"></a>Redis集群的三种模式</h1><h2 id="1-主从模式"><a href="#1-主从模式" class="headerlink" title="1. 主从模式"></a>1. 主从模式</h2><h3 id="产生的原因"><a href="#产生的原因" class="headerlink" title="产生的原因"></a>产生的原因</h3><ul><li>避免单点Redis服务器故障。数据丢失，可能对业务造成灾难性打击</li><li>容量瓶颈。内存不足，一台redis内存是有限的</li></ul><h3 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h3><ul><li><p>一个master可以拥有多个slave，一个slave只对应一个master</p></li><li><p><strong>一主多从，主负责写，并且将数据复制到其它的 slave 节点，从节点负责读</strong>。</p></li><li><p>所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑<strong>读高并发</strong>。</p></li><li><p>slave挂了不影响其他slave的读和master的读和写，重新启动后会将数据从master同步过来。可以使用全量复制和部分复制</p></li><li><p>master挂了以后，不影响slave的读，但redis不再提供写服务，master重启后redis将重新对外提供写服务</p></li><li><p>master挂了以后，不会在slave节点中重新选一个master，只能手动的一个一个改，不合适，就有了之后的哨兵</p></li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224935732.png" alt="image-20230228224935732"></p><h3 id="Redis主从复制工作原理"><a href="#Redis主从复制工作原理" class="headerlink" title="Redis主从复制工作原理"></a><strong>Redis主从复制工作原理</strong></h3><h4 id="1-全量复制流程："><a href="#1-全量复制流程：" class="headerlink" title="1. 全量复制流程："></a>1. 全量复制流程：</h4><p>Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份，具体步骤如下：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224944541.png" alt="image-20230228224944541"></p><ol><li>如果你为master配置了一个slave，不管这个slave是否是第一次连接上Master，它都会发送一个<strong>SYNC</strong>命令(redis2.8版本之前的命令)master请求复制数据。</li><li>master收到SYNC命令后，会在后台进行数据持久化通过bgsave生成最新的rdb快照文件。</li><li>master将生成的rdb数据发给slave。</li><li>Master由于从执行bgsave到生成rdb数据存在时间，在此时间间隔内，可能有新的客户端请求，master会把这些最近的请求缓存在内存中。（也就是一个最近数据的缓冲区，默认大小为1M）</li><li>当第3步的rdb数据发完后，他会把这些缓存的数据也发给slave</li><li>当slave有老的rdb数据，就会先把老的数据清掉。重新生成包含缓存的rd b数据，并加载到内存中。</li><li>之后，master和slave通过socket长连接，持续进行命令同步，从而保证主从数据一致。</li></ol><blockquote><p>当master与slave之间的连接由于某些原因而断开时，slave能够自动重连Master。</p></blockquote><blockquote><p>如果master收到了多个slave并发连接请求，它只会进行一次持久化，而不是一个连接一次，然后再把这一份持久化的数据发送给多个并发连接的slave。  </p></blockquote><p><strong>当master和slave断开重连后，一般都会对整份数据进行复制。但从redis2.8版本开始，master和slave断开重连后支持部分复制</strong>。</p><h4 id="2-部分复制流程"><a href="#2-部分复制流程" class="headerlink" title="2. 部分复制流程"></a>2. 部分复制流程</h4><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224955344.png" alt="image-20230228224955344"></p><ol><li>从2.8版本开始，slave与master能够在网络连接断开<strong>重连后只进行部分数据复制。</strong> </li><li>master会在其内存中创建一个复制数据用的缓存队列，缓存最近一段时间的数据。master和它所有的slave都维护了复制的数据下标offset和master的进程id。</li><li>当网络连接断开后，slave会请求master继续进行未完成的复制。<ul><li>从节点数据下标 offset还在缓存队列里，那么将会从slave记录的数据下标开始从缓存区复制。</li><li>如果master进程id变化了，或者从节点数据下标 offset太旧，已经不在master的缓存队列里了，那么将会进行一次全量数据的复制</li></ul></li></ol><h4 id="3-增量复制"><a href="#3-增量复制" class="headerlink" title="3 增量复制"></a>3 增量复制</h4><ul><li><p>是指在初始化的全量复制并开始正常工作之后，master服务器将发生的写操作同步到slave服务器的过程</p></li><li><p>增量复制的过程主要是master服务器每执行一个写命令就会向slave服务器发送相同的写命令，slave服务器接收并执行收到的写命令。</p></li></ul><h2 id="2-哨兵模式"><a href="#2-哨兵模式" class="headerlink" title="2. 哨兵模式"></a>2. 哨兵模式</h2><h3 id="产生的原因-1"><a href="#产生的原因-1" class="headerlink" title="产生的原因"></a>产生的原因</h3><p>主从模式下，主机宕机，需要人为去设置master，哨兵模式就是解决：不用人为进行干预，高可用的恢复正常。</p><blockquote><p>哨兵（sentinel）是一个分布式系统，用于对主从结构中的每台服务器进行监控，当出现故障时通过投票机制选择新的master并将所有slave连接到新的master</p></blockquote><h3 id="特征-1"><a href="#特征-1" class="headerlink" title="特征"></a>特征</h3><ul><li>监控：sentinel哨兵是特殊的redis服务，不提供读写服务，主要用来不断地检查master和slave是否正常运行。 </li><li>自动故障转移：当master出现问题时，选取一个slave作为master，将其他slave连接到新地master，并告知客户端新地服务器地址</li><li>通知：当redis的主节点发生变化，哨兵会第一时间感知到，并且将新的redis主节点通知给client端(这里面redis的client端一般都实现了订阅功能，订阅sentinel发布的节点变动消息)</li></ul><p><strong>注⚠️：</strong></p><ul><li>哨兵架构下client端第一次从哨兵找出redis的主节点，后续就直接访问redis的主节点，不会每次都通过sentinel代理访问redis的主节点。</li><li>哨兵也是一台redis服务器，只是不提供数据服务</li><li>为了高可用一般都推荐至少部署三个哨兵节点</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225006830.png" alt="image-20230228225006830"></p><h3 id="哨兵leader选举流程"><a href="#哨兵leader选举流程" class="headerlink" title="哨兵leader选举流程"></a><strong>哨兵leader选举流程</strong></h3><p>当一个master服务器被某sentinel视为下线状态后，该sentinel会与其他sentinel协商选出sentinel的leader进行故障转移工作。</p><ol><li>每个发现master服务器进入下线的sentinel都可以要求其他sentinel选自己为sentinel的 leader，选举是先到先得。</li><li>超过一半的sentinel选举某sentinel作为leader。之后该sentinel进行故障转移操作，从存活的slave中选举出新的master</li></ol><h2 id="3-Cluster模式"><a href="#3-Cluster模式" class="headerlink" title="3. Cluster模式"></a>3. Cluster模式</h2><h3 id="产生的原因-2"><a href="#产生的原因-2" class="headerlink" title="产生的原因"></a>产生的原因</h3><ul><li>哨兵模式，如果master节点异常，在主从切换的瞬间，存在不可用的情况。</li><li>哨兵模式只有单个主节点可以用来写，没法支持很高的并发。</li><li>哨兵模式单个节点的内存也不宜设的太大，会导致持久化文件过大，影响数据恢复主从效率。</li></ul><h3 id="特征-2"><a href="#特征-2" class="headerlink" title="特征"></a>特征</h3><ul><li>Redis-Cluster采用无中心结构，每个节点保存数据和整个集群状态。</li><li>提供多个master节点提供写服务，每个master节点中存储的数据都不一样，这些数据通过数据分片的方式被自动分割到不同的master节点上。</li><li>每个master节点下面还需要添加至少1个slave节点，这样当某个master节点发生故障后，可以从它的slave节点中选举一个作为新的master节点继续提供服务</li><li>Redis Cluster 将所有数据划分为 16384 个 slots(槽位)，每个节点负责其中一部分槽位。槽位的信息存储于每 个节点中。当 Redis Cluster 的客户端来连接集群时，它也会得到一份集群的槽位配置信息并将其缓存在客户端本地。这样当客户端要查找某个 key 时，可以直接定位到目标节点。</li></ul><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228225016550.png" alt="image-20230228225016550"></p><h3 id="槽位定位算法"><a href="#槽位定位算法" class="headerlink" title="槽位定位算法"></a><strong>槽位定位算法</strong></h3><p>Cluster 默认会对 key 值使用 crc16 算法进行 hash 得到一个整数值，然后用这个整数值对 16384 进行取模 来得到具体槽位。 </p><p><code>HASH_SLOT = CRC16(key) mod 16384</code> </p><h3 id="网络抖动"><a href="#网络抖动" class="headerlink" title="网络抖动"></a><strong>网络抖动</strong></h3><ul><li><p>Redis Cluster 提供了一种选项<code>cluster-­node-­timeout</code>，表示当某个节点持续 timeout 的时间失联时，才可以认定该节点出现故障，需要进行主从切换。</p></li><li><p>如果没有这个选项，网络抖动会导致主从频 繁切换 (数据的重新复制)。</p></li></ul><h3 id="Redis集群选举原理分析"><a href="#Redis集群选举原理分析" class="headerlink" title="Redis集群选举原理分析"></a><strong>Redis集群选举原理分析</strong></h3><p>当slave发现自己的master变为FAIL状态时，便尝试进行Failover，以期成为新的master。由于挂掉的master可能会有多个slave，从而存在多个slave竞争成为master节点的过程， 其过程如下： </p><ol><li><p>slave发现自己的master变为FAIL </p></li><li><p>将自己记录的集群currentEpoch加1，并广播FAILOVER_AUTH_REQUEST 信息</p></li><li><p>其他节点收到该信息，只有master响应，判断请求者的合法性，并发送FAILOVER_AUTH_ACK，对每一个 slaver只发送一次ack </p></li><li><p>slave收到超过半数master的ack后变成新Master</p></li><li><p>.slave广播Pong消息通知其他集群节点。</p></li></ol><p>注意⚠️：</p><ul><li>从节点并不是在主节点一进入 FAIL 状态就马上尝试发起选举，而是有一定延迟。一定的延迟确保我们等待 FAIL状态在集群中传播，slave如果立即尝试选举，其它masters或许尚未意识到FAIL状态，可能会拒绝投票</li><li>延迟计算公式： DELAY &#x3D; 500ms + random(0 ~ 500ms) + SLAVE_RANK * 1000ms</li></ul><p>​       SLAVE_RANK表示此slave已经从master复制数据的总量的rank。Rank越小代表已复制的数据越新。这种方式下，持有最新数据的slave将会首先发起选举（理论上）。</p><h3 id="集群脑裂数据丢失问题"><a href="#集群脑裂数据丢失问题" class="headerlink" title="集群脑裂数据丢失问题"></a><strong>集群脑裂数据丢失问题</strong></h3><p>网络分区导致脑裂后多个主节点对外提供写服务，一旦网络分区恢复， 会将其中一个主节点变为从节点，这时会有大量数据丢失。</p><p>规避方法可以在redis配置里加上参数(这种方法不可能百分百避免数据丢失，参考集群leader选举机制）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">min‐replicas‐to‐write <span class="hljs-number">1</span> <span class="hljs-comment">//写数据成功最少同步的slave数量，这个数量可以模仿大于半数机制配置，比如 集群总共三个节点可以配置1，加上leader就是2，超过了半数</span><br></code></pre></td></tr></table></figure><p>这个配置在一定程度上会影响集群的可用性，比如slave要是少于1个，这个集群就算leader正常也不能提供服务了，需要具体场景权衡选择。 </p><h3 id="Redis集群为什么至少需要三个master节点，并且推荐节点数为奇数"><a href="#Redis集群为什么至少需要三个master节点，并且推荐节点数为奇数" class="headerlink" title="Redis集群为什么至少需要三个master节点，并且推荐节点数为奇数"></a><strong>Redis集群为什么至少需要三个master节点，并且推荐节点数为奇数</strong></h3><ul><li>因为新master的选举需要大于半数的集群master节点同意才能选举成功</li><li>奇数个master节点可以在满足选举该条件的基础上节省一个节点，比如三个master节点和四个master节点的集群相比，都只允许挂一个节点，否则集群不可用。所以奇数的master节点更多的是<strong>从节省机器资源角度出发</strong>说的。</li></ul><h3 id="Redis集群对批量操作命令的支持"><a href="#Redis集群对批量操作命令的支持" class="headerlink" title="Redis集群对批量操作命令的支持"></a><strong>Redis集群对批量操作命令的支持</strong></h3><p>对于类似mset，mget这样的多个key的原生批量操作命令，redis集群只支持所有key落在同一slot的情况，如 果有多个key一定要用mset命令在redis集群上操作，则可以在key的前面加上{XX}，这样参数数据分片hash计算的只会是大括号里的值，这样能确保不同的key能落到同一slot里去，示例如下： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">mset &#123;user1&#125;:<span class="hljs-number">1</span>:name zhuge &#123;user1&#125;:<span class="hljs-number">1</span>:age <span class="hljs-number">18</span><br></code></pre></td></tr></table></figure><p>假设name和age计算的hash slot值不一样，但是这条命令在集群下执行，redis只会用大括号里的 user1 做 hash slot计算，所以算出来的slot值肯定相同，最后都能落在同一slot</p>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis主从架构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis持久化</title>
    <link href="/redis%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <url>/redis%E6%8C%81%E4%B9%85%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>redis 持久化主要有2种方式：RDB 和AOF</p></blockquote><h1 id="RDB快照"><a href="#RDB快照" class="headerlink" title="RDB快照"></a>RDB快照</h1><h2 id="什么是RDB快照"><a href="#什么是RDB快照" class="headerlink" title="什么是RDB快照"></a>什么是RDB快照</h2><ul><li>rdb就是快照，是redis默认的持久化方式，就是把所有的数据持久化到磁盘，隔一段时间持久化一次到 dump.rdb 的二进制文件中，在服务器重启后只需要把文件中的数据恢复即可。 </li><li>你可以对 Redis 进行设置， 让它在“ N 秒内数据集至少有 M 个改动”这一条件被满足时， 自动保存一次数据集。 比如说， <code>save 60 1000</code>会让 Redis 在满足“ 60 秒内有至少有 1000 个键被改动”这一条件时， 自动保存一次数据集</li></ul><h2 id="RDB-文件的创建"><a href="#RDB-文件的创建" class="headerlink" title="RDB 文件的创建"></a>RDB 文件的创建</h2><blockquote><p>有两种方式：手动触发和自动触发</p></blockquote><h3 id="手动触发"><a href="#手动触发" class="headerlink" title="手动触发"></a>手动触发</h3><ul><li>save命令会阻塞当前Redis服务器，直到RDB过程完成为止。在服务器进程阻塞期间，服务器不能处理任何命令请求。因此，当save命令正在执行时，客户端发送的所有命令都会被拒绝，知道save命令执行完毕。（不建议使用）</li><li>bgsave 命令会fork出一个子进程(而不是线程)，由子进程进行RDB文件创建，而父进程继续处理命令。</li></ul><blockquote><p>进入redis客户端执行命令<strong>save</strong>或<strong>bgsave</strong>可以生成dump.rdb文件， 每次命令执行都会将所有redis内存快照到一个新的rdb文件里，并覆盖原有rdb快照文件。 </p></blockquote><h3 id="自动触发"><a href="#自动触发" class="headerlink" title="自动触发"></a>自动触发</h3><p>redis通过配置文件进行配置，redis可以通过设置服务器配置的save选项，服务器每隔一段时间自动执行一次bgsave命令。</p><h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p><strong>优点：</strong></p><ul><li>适合大规模的数据恢复，恢复速度快！</li><li>体积小，相较于aof他只是保存了结果，不需要保存每一次命令操作。</li></ul><p><strong>缺点：</strong></p><ul><li>数据需要一定的时间间隔进程操作！ 如果 Redis 因为某些原因而造成故障停机， 那么服务器将丢失最近写入、且仍未保存到快照中的那些数据就没有了。</li></ul><h1 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h1><ul><li>以独立日志的方式记录每次写命令，每当 Redis 执行一个改变数据集的命令时（比如 SET）， 这个命令就会被追加到 appendonly.aof文 件的末尾，并在 Redis 重启时在重新执行 AOF 文件中的命令以达到恢复数据的目的。</li><li>AOF 的主要作用是解决数据持久化的实时性。</li><li>你可以通过修改配置文件来打开 AOF 功能：  <code>appendonly yes </code></li><li>你可以配置 Redis 多久才将数据 fsync 到磁盘一次。 <ul><li><strong>appendfsync always</strong>：每次有新命令追加到 AOF 文件时就执行一次 fsync ，非常慢，也非常安全。</li><li><strong>appendfsync everysec</strong>：每秒 fsync 一次，足够快（和使用 RDB 持久化差不多），并且在 故障时只会丢失 1 秒钟的数据。</li><li><strong>appendfsync no</strong>：：从不 fsync ，将数据交给操作系统来处理。更快，也更不安全的选择。因为你不清楚不同的操作系统底层是怎么去刷磁盘的。</li></ul></li></ul><h2 id="AOF-重写"><a href="#AOF-重写" class="headerlink" title="AOF 重写"></a>AOF 重写</h2><ul><li><p>AOF文件里可能有太多没用指令，比如3次递增readcount, 重写后直接会变成readcount:3，AOF会定期根据<strong>内存的最新数据</strong>生成aof文件</p></li><li><p>进入redis客户端执行命令<strong>bgrewriteaof</strong>重写AOF </p></li><li><p>AOF重写redis会fork出一个子进程去做，不会对redis正常命令处理有太多影响</p></li><li><p>如下两个配置可以控制AOF自动重写频率 </p><ul><li>auto-aof-rewrite-min-size 64mb &#x2F;&#x2F;aof文件至少要达到64M才会自动重写，文件太小恢复速度本来就很快，重写的意义不大</li><li>auto-aof-rewrite-percentage 100 &#x2F;&#x2F;aof文件自上一次重写后文件大小增长了100%则再次触发重写</li></ul></li></ul><h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><p><strong>优点</strong>：</p><ul><li>每一次修改都同步，文件的完整性会更加好！</li></ul><p><strong>缺点：</strong></p><ul><li>相对于数据文件来说，aof远远大于 rdb，修复的速度也比 rdb慢！</li></ul><h1 id="Redis-4-0-混合持久化"><a href="#Redis-4-0-混合持久化" class="headerlink" title="Redis 4.0 混合持久化"></a><strong>Redis 4.0 混合持久化</strong></h1><blockquote><p>重启 Redis 时，我们很少使用 RDB来恢复内存状态，因为会丢失大量数据。我们通常使用 AOF 日志存放，但是存放 AOF 日志性能相对 RDB来说要慢很多，这样在 Redis 实例很大的情况下，启动需要花费很长的时间。</p><p>Redis 4.0 为了解决这个问题，带来了一个新的持久化选项——混合持久化。 通过配置 <code> aof-use-rdb-preamble yes</code>可以开启混合持久化。   </p></blockquote><h2 id="混合持久化流程"><a href="#混合持久化流程" class="headerlink" title="混合持久化流程"></a>混合持久化流程</h2><ul><li>如果开启了混合持久化。<strong>AOF在重写时</strong>，不再是单纯将内存数据转换为命令写入AOF文件，而是根据aof命令重写<strong>这一刻之前</strong>的内存做RDB快照处理，并且将RDB快照内容和<strong>增量的</strong>AOF修改内存数据的命令存在一起，都写入新的AOF文件。</li><li>新的文件一开始不叫appendonly.aof，等到重写完新的AOF文件才会进行改名，原子的覆盖原有的AOF文件，完成新旧两个AOF文件的替换。</li><li>于是在 Redis 重启的时候，可以先加载 RDB 的内容，然后再加载增量 AOF 日志就可以完全替代之前的 AOF 全量文件的加载，因此重启效率大幅得到提升。</li></ul><h2 id="混合持久化AOF文件结构"><a href="#混合持久化AOF文件结构" class="headerlink" title="混合持久化AOF文件结构"></a>混合持久化AOF文件结构</h2><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gxtx3e8tbhj30r40i23zd.jpg" style="zoom:50%;" /><img src="https://tva1.sinaimg.cn/large/008i3skNly1gxtx4ka5e8j31ey0q6myv.jpg" style="zoom: 33%;" /></p>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis持久化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis常见面试题</title>
    <link href="/redis/"/>
    <url>/redis/</url>
    
    <content type="html"><![CDATA[<blockquote><p>redis是一个高性能的key-value 数据库，它可以用来存储字符串，哈希，列表，集合，有序集合。</p></blockquote><h1 id="1-redis常见数据结构"><a href="#1-redis常见数据结构" class="headerlink" title="1. redis常见数据结构"></a>1. redis常见数据结构</h1><h2 id="1-String"><a href="#1-String" class="headerlink" title="1 String"></a>1 String</h2><p>String 是redis中最基础的数据结构，主要用在常规计数，如：统计网站访问数据量，当前在线人数等</p><h3 id="1-应用场景"><a href="#1-应用场景" class="headerlink" title="1.应用场景"></a>1.<strong>应用场景</strong></h3><h4 id="1-单值缓存"><a href="#1-单值缓存" class="headerlink" title="1 单值缓存"></a>1 单值缓存</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">set</span> key1 &quot;zhangsan&quot;<br></code></pre></td></tr></table></figure><h4 id="2-计数器"><a href="#2-计数器" class="headerlink" title="2 计数器"></a>2 计数器</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">set</span> article:readcount:mysql<span class="hljs-operator">-</span>tutorial <span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><h4 id="3-分布式系统全局序列号"><a href="#3-分布式系统全局序列号" class="headerlink" title="3. 分布式系统全局序列号"></a>3. 分布式系统全局序列号</h4><p>INCRBY  orderId  1000&#x2F;&#x2F;redis批量生成序列号提升性能</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> incrby orderId  <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><h4 id="4-分布式锁-redisson"><a href="#4-分布式锁-redisson" class="headerlink" title="4. 分布式锁(redisson)"></a>4. 分布式锁(redisson)</h4><ul><li>SETNX  product:10001   </li><li>执行业务操作。。。</li><li>DEL  product:10001。                                     &#x2F;&#x2F;执行完业务释放锁</li><li>SET product:10001 true  ex  10  nx          &#x2F;&#x2F;防止程序意外终止导致死</li></ul><blockquote><p>SETNX（ <strong>SET</strong> if <strong>N</strong>ot e<strong>X</strong>ists ）</p><ul><li><p>在指定的 key 不存在时，为 key 设置指定的值，这种情况下等同 <a href="https://www.redis.com.cn/commands/set.html">SET</a> 命令。当 <code>key</code>存在时，什么也不做。</p></li><li><p>返回值</p><ul><li><code>1</code> 如果key被设置了</li><li><code>0</code> 如果key没有被设置</li></ul></li></ul></blockquote><h2 id="2-hash"><a href="#2-hash" class="headerlink" title="2. hash"></a>2. hash</h2><p>Hash是一个field 和value 的映射表，特别适合存储对象，比如存储用户信息，商品信息等。</p><h3 id="1-优缺点："><a href="#1-优缺点：" class="headerlink" title="1. 优缺点："></a>1. 优缺点：</h3><ul><li>优点<ul><li>同类数据归类整合储存，方便数据管理</li><li>相比string操作消耗内存与cpu更小</li><li>相比string储存更节省空间</li></ul></li><li>缺点<ul><li>过期功能不能使用在field上，只能用在key上</li></ul></li></ul><h3 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2. 应用场景"></a>2. <strong>应用场景</strong></h3><h4 id="1-对象缓存"><a href="#1-对象缓存" class="headerlink" title="1 对象缓存"></a>1 对象缓存</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> HMSET  <span class="hljs-keyword">user</span>  <span class="hljs-number">1</span>:name  zhuge <span class="hljs-number">1</span>:balance  <span class="hljs-number">1888</span><br></code></pre></td></tr></table></figure><h4 id="2-电商购物车"><a href="#2-电商购物车" class="headerlink" title="2 电商购物车"></a>2 电商购物车</h4><ul><li>以用户id为key；     商品id为field；    商品数量为value；</li><li>购物车操作<ul><li>添加商品 <code> hset cart:user2 &quot;apple&quot; 1</code></li><li>增加数量  <code> hincrby cart:user2 &quot;apple&quot; 3</code></li><li>商品总数 <code>hlen cart:user2</code></li><li>删除商品 <code>hdel cart:user2 &quot;apple&quot;</code></li><li>获取购物车所有商品 <code>hgetall cart:user2</code></li></ul></li></ul><h2 id="3-list"><a href="#3-list" class="headerlink" title="3. list"></a>3. list</h2><p>list是一个链表结构，主要功能是push和pop（添加和弹出集合元素），获取一个范围的值等。常用于：粉丝列表，最新消息排行。</p><h3 id="1-应用场景-1"><a href="#1-应用场景-1" class="headerlink" title="1. 应用场景"></a>1. <strong>应用场景</strong></h3><h4 id="1-微博消息和微信公号消息"><a href="#1-微博消息和微信公号消息" class="headerlink" title="1. 微博消息和微信公号消息"></a>1. 微博消息和微信公号消息</h4><p>张三关注了2 个订阅号，美食专栏和娱乐周边</p><ul><li><p>美食专栏发推送</p><p> <code>lpush msg:zhangSan &quot;apple is yammy!&quot;</code></p></li><li><p>娱乐周边发推送.</p><p><code>lpush msg:zhangSan &quot;YangMi is beautiful!&quot;</code></p></li><li><p>查看张三关注的最新订阅号消息.</p><p> <code>lrange msg:zhangSan 0 5</code></p></li></ul><h2 id="4-set"><a href="#4-set" class="headerlink" title="4 set"></a>4 set</h2><p>Redis 中的set集合是无序且不可重复的，它最大的优势可以进行交集，丙级，差集等，常用来求共同好友等。</p><h3 id="1-应用场景-2"><a href="#1-应用场景-2" class="headerlink" title="1. 应用场景"></a>1. <strong>应用场景</strong></h3><h4 id="1-微信抽奖小程序"><a href="#1-微信抽奖小程序" class="headerlink" title="1  微信抽奖小程序"></a>1  微信抽奖小程序</h4><ul><li>点击参与抽奖加入集合</li></ul><p>​      <code>sadd iphone13 zhangsan</code></p><ul><li>查看参与抽奖所有用户</li></ul><p>​      <code>smembers iphone13</code>  </p><ul><li><p>抽取count名中奖者  </p><ul><li><p>返回集合中2个随机数.</p><p><code>srandmember iphone13 2</code></p></li><li><p>移除并返回集合中的2个随机元素 </p><p> <code>spop iphone13 2</code></p></li></ul></li></ul><h4 id="2-微信微博点赞，收藏，标签"><a href="#2-微信微博点赞，收藏，标签" class="headerlink" title="2. 微信微博点赞，收藏，标签"></a>2. 微信微博点赞，收藏，标签</h4><ul><li>点赞<br>SADD  like:{消息ID}  {用户ID}</li><li>取消点赞<br>SREM like:{消息ID}  {用户ID}</li><li>检查用户是否点过赞<br>SISMEMBER  like:{消息ID}  {用户ID}</li><li>获取点赞的用户列表<br>SMEMBERS like:{消息ID}</li><li>获取点赞用户数<br>SCARD like:{消息ID}</li></ul><h3 id="2-集合操作"><a href="#2-集合操作" class="headerlink" title="2.集合操作"></a>2.集合操作</h3><ul><li>交集：SINTER set1 set2 set3 </li><li>并集：SUNION set1 set2 set3</li><li>差集：SDIFF set1 set2 set3</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> sadd set1 <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span><br>(<span class="hljs-type">integer</span>) <span class="hljs-number">4</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> sadd set2 <span class="hljs-number">1</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span><br>(<span class="hljs-type">integer</span>) <span class="hljs-number">4</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> sinter set1 set2<br><span class="hljs-number">1</span>) &quot;1&quot;<br><span class="hljs-number">2</span>) &quot;3&quot;<br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> sunion set1 set2<br><span class="hljs-number">1</span>) &quot;1&quot;<br><span class="hljs-number">2</span>) &quot;2&quot;<br><span class="hljs-number">3</span>) &quot;3&quot;<br><span class="hljs-number">4</span>) &quot;4&quot;<br><span class="hljs-number">5</span>) &quot;5&quot;<br><span class="hljs-number">6</span>) &quot;6&quot;<br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6379</span><span class="hljs-operator">&gt;</span> sdiff set1 set2<br><span class="hljs-number">1</span>) &quot;2&quot;<br><span class="hljs-number">2</span>) &quot;4&quot;<br></code></pre></td></tr></table></figure><h2 id="5-zset"><a href="#5-zset" class="headerlink" title="5 zset"></a>5 zset</h2><p>在set的基础上，增加了一个权重系数score，使集合中的元素可以按照score进行有序排列，常用于实现排行榜。</p><h3 id="1-应用场景-3"><a href="#1-应用场景-3" class="headerlink" title="1. 应用场景"></a>1. <strong>应用场景</strong></h3><h4 id="1-Zset集合操作实现排行榜"><a href="#1-Zset集合操作实现排行榜" class="headerlink" title="1. Zset集合操作实现排行榜"></a>1. Zset集合操作实现排行榜</h4><ul><li><p>点击新闻   </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ZINCRBY</span>  hotNews:<span class="hljs-number">20190819</span>  <span class="hljs-number">1</span>  守护香港<br></code></pre></td></tr></table></figure></li><li><p>展示当日排行前十 </p> <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ZREVRANGE</span>  hotNews:<span class="hljs-number">20190819</span>  <span class="hljs-number">0</span>  <span class="hljs-number">10</span>  WITHSCORES <br></code></pre></td></tr></table></figure></li><li><p>七日搜索榜单计算</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ZUNIONSTORE</span>  hotNews:<span class="hljs-number">20190813</span>-<span class="hljs-number">20190819</span>  <span class="hljs-number">7</span> <br><span class="hljs-attribute">hotNews</span>:<span class="hljs-number">20190813</span>  hotNews:<span class="hljs-number">20190814</span>... hotNews:<span class="hljs-number">20190819</span><br></code></pre></td></tr></table></figure><blockquote><p>[ZUNIONSTORE destination numkeys key <a href="https://www.runoob.com/redis/sorted-sets-zunionstore.html">key …]</a><br>计算给定的一个或多个有序集的并集，并存储在新的 key 中</p></blockquote></li><li><p>展示七日排行前十</p><p><code>ZREVRANGE hotNews:20190813-20190819  0  10  WITHSCORES</code></p><blockquote><p>[ ZREVRANGE key start stop <a href="https://www.runoob.com/redis/sorted-sets-zrevrange.html">WITHSCORES]</a> 返回有序集中指定区间内的成员，通过索引，分数从高到低</p></blockquote></li></ul><h1 id="2-redis-为什么快"><a href="#2-redis-为什么快" class="headerlink" title="2. redis 为什么快"></a>2. redis 为什么快</h1><p>Redis 是一个高性能的键值存储数据库，以其快速的读写速度而著称。其速度主要得益于以下几个关键因素：</p><h3 id="1-内存存储"><a href="#1-内存存储" class="headerlink" title="1. 内存存储"></a>1. 内存存储</h3><p>Redis 将所有数据存储在内存中（RAM），而不是传统数据库那样存储在磁盘上。内存的读写速度远远快于磁盘，因此 Redis 的操作速度非常快。</p><h3 id="2-简单的数据结构"><a href="#2-简单的数据结构" class="headerlink" title="2. 简单的数据结构"></a>2. 简单的数据结构</h3><p>Redis 提供了一些简单且高效的数据结构，例如字符串、哈希、列表、集合、有序集合、位图、HyperLogLog、地理空间索引和流。每种数据结构都经过优化，可以快速地执行常见操作。</p><h3 id="3-单线程架构"><a href="#3-单线程架构" class="headerlink" title="3. 单线程架构"></a>3. 单线程架构</h3><p>Redis 使用单线程模型处理客户端请求。这种设计避免了多线程环境中的上下文切换和竞态条件，从而减少了复杂性和开销。尽管单线程可能看起来是个瓶颈，但由于 Redis 的核心操作非常快且大部分是在内存中完成的，因此单线程模型在大多数情况下性能非常高。</p><h3 id="4-非阻塞-I-x2F-O"><a href="#4-非阻塞-I-x2F-O" class="headerlink" title="4. 非阻塞 I&#x2F;O"></a>4. 非阻塞 I&#x2F;O</h3><p>Redis 使用了基于事件驱动的 I&#x2F;O 多路复用机制（如 epoll 和 kqueue），使得它能够同时处理大量客户端连接而不会出现阻塞。这种非阻塞 I&#x2F;O 模型使得 Redis 能够有效地处理并发请求。</p><h3 id="5-紧凑的内存管理"><a href="#5-紧凑的内存管理" class="headerlink" title="5. 紧凑的内存管理"></a>5. 紧凑的内存管理</h3><p>Redis 对内存使用进行了高度优化。例如，它使用了一种高效的内存分配机制来最小化内存碎片，并提供了一些数据压缩选项（如 ziplist 和 quicklist）来节省内存空间。</p><h3 id="6-高效的序列化和反序列化"><a href="#6-高效的序列化和反序列化" class="headerlink" title="6. 高效的序列化和反序列化"></a>6. 高效的序列化和反序列化</h3><p>Redis 的 RDB 和 AOF 两种持久化机制都经过优化，可以快速地将数据从内存保存到磁盘并恢复。这种高效的序列化和反序列化过程减少了持久化操作对性能的影响。</p><h3 id="7-高效的网络协议"><a href="#7-高效的网络协议" class="headerlink" title="7. 高效的网络协议"></a>7. 高效的网络协议</h3><p>Redis 使用了一个简单、高效的二进制协议 RESP（Redis Serialization Protocol），来进行客户端和服务器之间的数据交换。这个协议设计简单，解析速度非常快，进一步提高了 Redis 的性能。</p><h3 id="8-本地化的数据处理"><a href="#8-本地化的数据处理" class="headerlink" title="8. 本地化的数据处理"></a>8. 本地化的数据处理</h3><p>Redis 提供了丰富的原子操作，可以在服务器端完成复杂的数据处理任务，减少了网络往返次数。例如，可以在 Redis 内部执行复杂的集合操作，而不需要将数据传输到客户端进行处理。</p><h3 id="9-数据分片（Sharding）"><a href="#9-数据分片（Sharding）" class="headerlink" title="9. 数据分片（Sharding）"></a>9. 数据分片（Sharding）</h3><p>虽然 Redis 本身是单线程的，但它支持数据分片（sharding），即将数据分布在多个 Redis 实例上。通过这种方式，Redis 能够水平扩展，处理更大的数据量和更高的并发请求。</p><h1 id="3-Redis-内存淘汰策略"><a href="#3-Redis-内存淘汰策略" class="headerlink" title="3. Redis 内存淘汰策略"></a>3. Redis 内存淘汰策略</h1><p>在 Redis 中，淘汰策略（也称为内存回收策略）决定了在 Redis 实例达到内存限制时，应该如何处理新写入的数据。主要包括以下几种：</p><ul><li><p><strong>noeviction</strong>：对于写请求不再提供服务，会直接返回错误。这是<strong>默认策略</strong>。</p></li><li><p><strong>allkeys-random</strong>：从<strong>所有key</strong>中<strong>随机</strong>移除某个键。</p></li><li><p><strong>volatile-random</strong>：从<strong>设置了过期时间的键</strong>中<strong>随机</strong>移除某个键。</p></li><li><p><strong>volatile-ttl</strong>：从<strong>设置了过期时间的键</strong>中移除<strong>剩余寿命最短的键</strong>（即将过期的键）。</p></li><li><p><strong>allkeys-lru</strong>：使用LRU（Least Recently Used，最近最少使用）算法，从<strong>所有key</strong>中选取<strong>使用最少</strong>的进行淘汰。</p></li><li><p><strong>volatile-lru</strong>：使用LRU（Least Recently Used，最近最少使用）算法，从设<strong>置了过期时间的key</strong>中移除<strong>最近最少使用</strong>的键。</p></li><li><p><strong>allkeys-lfu:</strong> 使用LFU（Least Frequently Used，最不经常使用），从<strong>所有key中</strong>选择<strong>某段时间之内使用频次最少</strong>的键值对清除</p></li><li><p><strong>volatile-lfu</strong>: 使用LFU（Least Frequently Used，最不经常使用），从<strong>设置了过期时间的key</strong>中选择<strong>某段时间之内使用频次最小</strong>的键值对清除掉</p></li></ul><blockquote><p>Redis 的淘汰算法有多种:</p><ul><li>随机</li><li>TTL: 从设置了过期时间的 Keys 中获取最早过期的 一批 Keys</li><li>LRU (Least Recently Used) 算法: 所有的 Keys 都根据最后被访问的时间来进行排序的，所以在淘汰时只需要按照所有 Keys 的最后被访问时间，由小到大来进行即可</li><li>LFU（Least Frequently Used）算法: 照被访问次数降序排列，访问次数相同的按最近访问时间降序排列，链表满的时候从链表尾部移出数据。</li></ul></blockquote><h1 id="4-Redis-常见使用场景"><a href="#4-Redis-常见使用场景" class="headerlink" title="4. Redis 常见使用场景"></a>4. Redis 常见使用场景</h1><ol><li>缓存: DB缓存，减轻DB服务器压力, 提高系统响应。需保证缓存内容与数据库的一致性</li><li>分布式锁：利用Redis的<code>SETNX key value</code>这个命令获取锁，并设置过期时间。需处理：a.增加ID的复杂性，满足安全性 b.合理设置一个超时时间, 不要太长或太短，还需考虑锁续命。推荐使用第三方库<code>redisson</code></li><li>分布式ID：利用Redis的原子性递增操作，生成分布式唯一ID。优点速度快，缺点需保证redis的高可用和持久化</li><li>计数器：利用incr方法，实现文章的阅读量，微博点赞数，IP限流等</li><li>排行榜：利用zset, 记录条目的同时，记录成绩</li><li>实现消息队列：利用list&#x2F;set</li></ol>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis 核心数据结构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第一个SpringBoot项目</title>
    <link href="/%E7%AC%AC%E4%B8%80%E4%B8%AAspringboot%E9%A1%B9%E7%9B%AE/"/>
    <url>/%E7%AC%AC%E4%B8%80%E4%B8%AAspringboot%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h1><ul><li>进入官网 <a href="https://start.spring.io/">Spring Initializr</a> 初始化项目</li><li>编写控制HelloController</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">helloController</span> </span>&#123;<br><br>  <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello World!&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="编写测试用例"><a href="#编写测试用例" class="headerlink" title="编写测试用例"></a>编写测试用例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pyr.spring.cloud.weather.controller;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.test.web.servlet.MockMvc;<br><span class="hljs-keyword">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.hamcrest.Matchers.equalTo;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;<br><br><span class="hljs-meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="hljs-meta">@AutoConfigureMockMvc</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">helloControllerTest</span> </span>&#123;<br><br>  <span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> MockMvc mockMvc;<br><br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    mockMvc.perform(MockMvcRequestBuilders.get(<span class="hljs-string">&quot;/hello&quot;</span>).accept(MediaType.APPLICATION_JSON))<br>      .andExpect(status().isOk())<br>      .andExpect(content().string(equalTo(<span class="hljs-string">&quot;hello World!&quot;</span>)));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h1><ul><li>idea 里面右击项目</li><li>build&#x2F;libs下运行 <code>Java -jar xxx</code></li><li>项目目录下运行：<code>gradle bootRun</code></li></ul><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gxr8m9n86ij30sq08ujrx.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql锁</title>
    <link href="/mysql%E9%94%81%E4%B8%8E%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
    <url>/mysql%E9%94%81%E4%B8%8E%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="锁是什么？"><a href="#锁是什么？" class="headerlink" title="锁是什么？"></a>锁是什么？</h1><ul><li>锁是计算机协调多个线程或进程并发访问同一资源的机制。</li><li>在数据库中，数据是一种共享的资源，因此也需要保证数据并发访问的一致性和有效性。</li></ul><h1 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h1><ul><li><p>从性能上来分为：<code>乐观锁</code>和<code>悲观锁</code></p><ul><li><p>乐观锁：每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在提交更新的时候会判断一下在此期间别人有没有去更新这个数据。</p><blockquote><p>乐观锁一般通过版本比对的方式来实现的：</p><ul><li><p>当读取数据时，将version字段的值一同读出，数据每更新一次，对此version值加1。</p></li><li><p>当我们提交更新的时候，判断数据库表对应记录的当前版本信息与我们第一次取出的version值进行比对，如果数据库表当前版本号与第一次取出来的version值相等，则予以更新，否则认为是过期数据。那么更新操作就会失败。</p></li></ul></blockquote></li><li><p>悲观锁：每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。</p></li></ul></li><li><p>从操作类型来分为：<code>读锁</code>和<code>写锁</code></p><ul><li>读锁：也称为共享锁，多个读操作可以同时进行，且互不影响。</li><li>写锁：也称为拍他锁，他可以阻断其他读操作或者写操作。</li></ul></li><li><p>从可操作的粒度来分为：<code>表锁</code>和<code>行锁</code></p><ul><li><p>表锁：每次操作锁住整张表。开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲 </p><p>突的概率最高，并发度最低；</p></li><li><p>行锁：每次操作锁住一行数据。开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁 </p><p>冲突的概率最低，并发度最高。</p></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql锁</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常见sql优化(二)</title>
    <link href="/%E5%B8%B8%E8%A7%81sql%E4%BC%98%E5%8C%96-%E4%BA%8C/"/>
    <url>/%E5%B8%B8%E8%A7%81sql%E4%BC%98%E5%8C%96-%E4%BA%8C/</url>
    
    <content type="html"><![CDATA[<h2 id="一-分页查询优化"><a href="#一-分页查询优化" class="headerlink" title="一  分页查询优化"></a>一  <strong>分页查询优化</strong></h2><h3 id="1-根据自增且连续的主键排序的分页查询"><a href="#1-根据自增且连续的主键排序的分页查询" class="headerlink" title="1. 根据自增且连续的主键排序的分页查询"></a>1. 根据自增且连续的主键排序的分页查询</h3><blockquote><p>原则：按照主键去查询</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees limit <span class="hljs-number">90000</span>,<span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p>表示从表 employees 中取出从 10001 行开始的 10 行记录。看似只查询了 10 条记录，实际这条 SQL 是先读取 10010 条记录，然后抛弃前 10000 条记录，然后读到后面 10 条想要的数据。因此要查询一张大表比较靠后的数据，执行效率是非常低的。因为主键是自增并且连续的，所以可以改写成按照主键去查询从第 90001开始的五行数据，如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">90000</span> limit <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p>显然改写后的 SQL 走了索引，而且扫描的行数大大减少，执行效率更高。 </p><p>但是，这条改写的SQL 在很多场景并不实用，因为表中可能某些记录被删后，主键空缺，导致结果不一致，如：先删除一条前面的记录，然后再测试原 SQL 和优化后的 SQL</p><h3 id="2-根据非主键字段排序的分页查询"><a href="#2-根据非主键字段排序的分页查询" class="headerlink" title="2.根据非主键字段排序的分页查询"></a>2.根据非主键字段排序的分页查询</h3><blockquote><p>原则： 让排序和分页操作先查出主键，然后根据主键查到对应的记录，这样排序时返回的字段会少很多，从而会执行索引排序。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> name limit <span class="hljs-number">90000</span>,<span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p>表示根据非主键字段name排序的分页查询，发现并没有使用 name 字段的索引（key 字段对应的值为 null），具体原因为：扫描整个索引并查找到没索引的行(可能要遍历多个索引树)的成本比扫描全表的成本更高，所以优化器放弃使用索引。</p><p>改写后：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> employees e <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name limit <span class="hljs-number">90000</span>,<span class="hljs-number">5</span>) ed <span class="hljs-keyword">on</span> e.id <span class="hljs-operator">=</span> ed.id;<br></code></pre></td></tr></table></figure><h2 id="二-Join关联查询优化"><a href="#二-Join关联查询优化" class="headerlink" title="二   Join关联查询优化"></a>二   <strong>Join关联查询优化</strong></h2><h3 id="mysql的表关联常见有两种算法"><a href="#mysql的表关联常见有两种算法" class="headerlink" title="mysql的表关联常见有两种算法"></a>mysql的表关联常见有两种算法</h3><h4 id="1-嵌套循环连接（Nested-Loop-Join）-算法"><a href="#1-嵌套循环连接（Nested-Loop-Join）-算法" class="headerlink" title="1.嵌套循环连接（Nested-Loop Join） 算法"></a>1.嵌套循环连接（Nested-Loop Join） 算法</h4><ul><li><p>一次一行循环地从第一张表（称为<strong>驱动表</strong>）中读取行，在这行数据中取到关联字段，根据关联字段在另一张表（<strong>被驱动</strong>表）里取出满足条件的行，然后取出两张表的结果合集。</p></li><li><p>大致流程是：</p><ol><li><p>第一步：从表 t2 中读取一行数据，根据关联字段 到表 t1 中查找</p></li><li><p>第二步：取出表 t1 中满足条件的行，跟 t2 中获取到的结果合并，作为结果返回给客户端； </p></li><li><p>第三部：重复第二步</p></li></ol><blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> EXPLAIN <span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.a<span class="hljs-operator">=</span> t2.a;<br></code></pre></td></tr></table></figure><p>假设t2有100条数据，t1有10000条。整个过程会读取 t2 表的所有数据(扫描100行)，然后遍历这每行数据中字段 a 的值，根据 t2 表中 a 的值索引扫描 t1 表 中的对应行(<strong>扫描100次 t1 表的索引，1次扫描可以认为最终只扫描 t1 表一行完整数据（扫描索引很快，可以忽略），也就是总共 t1 表也扫描了100</strong> 行**)。因此整个过程扫描了 **200 行。</p></blockquote></li><li><p>优化器一般会优先选择小表做驱动表。<strong>所以使用 inner join 时，排在前面的表并不一定就是驱动表。</strong></p></li></ul><h4 id="2-基于块的嵌套循环连接（Block-Nested-Loop-Join）-算法"><a href="#2-基于块的嵌套循环连接（Block-Nested-Loop-Join）-算法" class="headerlink" title="2.基于块的嵌套循环连接（Block Nested-Loop Join） 算法"></a>2.基于块的嵌套循环连接（Block Nested-Loop Join） 算法</h4><ul><li><p>把<strong>驱动表</strong>的数据读入到 join_buffer 中，然后扫描<strong>被驱动表</strong>，把<strong>被驱动表</strong>每一行取出来跟 join_buffer 中的数据做对比。 </p></li><li><p>大致流程是：</p><ol><li><p>第一步：把t2中的所有数据放在join_buffer中</p></li><li><p>第二步：依次取出t1中的每一行，跟join_buffer中的数据做对比</p></li><li><p>第三部：返回满足条件的数据</p></li></ol><blockquote><p>整个过程对表 t1 和 t2 都做了一次全表扫描，因此扫描的总行数为10000(表 t1 的数据总量) + 100(表 t2 的数据总量) &#x3D; <strong>10100</strong>。并且 join_buffer 里的数据是无序的，因此对表 t1 中的每一行，都要做 100 次判断，所以内存中的判断次数是 100 * 10000&#x3D; <strong>100 万次</strong>。</p></blockquote></li></ul><h3 id="对于关联sql的优化"><a href="#对于关联sql的优化" class="headerlink" title="对于关联sql的优化"></a>对于关联sql的优化</h3><ul><li><p>关联字段加索引，让mysql做join操作时，尽量选择嵌套循环算法。</p><blockquote><p>从上面的例子可以对比看出，嵌套循环算法因为有索引，每次进行查找时，只需根据索引，查找一条匹配的数据，即扫描一次。但基于块的嵌套循环连接却因为没有索引，每次都需要进行一次全表扫描。</p></blockquote></li><li><p>小表驱动大表。写多表连接sql时如果<strong>明确知道</strong>哪张表是小表可以用straight_join写法固定连接驱动方式，省去mysql优化器自己判断的时间。</p><blockquote><p>straight_join同inner join类似，但是可以指定左边的表来驱动右边的表。但是使用它一定要慎重，因为大部分情况优化器是比人聪明的，人为指定的顺序不一定比搜索引擎靠谱。</p></blockquote></li></ul><h2 id="三-in和exsits优化"><a href="#三-in和exsits优化" class="headerlink" title="三  in和exsits优化"></a>三  <strong>in和exsits优化</strong></h2><blockquote><p> 原则：<strong>小表驱动大表</strong>，即小的数据集驱动大的数据集 </p></blockquote><ul><li><p>当B表的数据集 &lt; A表的数据集时，in优于exists</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> id <span class="hljs-keyword">in</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> B) <br>#等价于：  <br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> B)&#123; <br>    <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> A.id <span class="hljs-operator">=</span> B.id<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>当B表的数据集 &gt; B表的数据集时，exists优于in</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> <span class="hljs-keyword">exists</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> b.id <span class="hljs-operator">=</span> A.id) <br>#等价于：  <br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> A)&#123;<br>     <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> B.id <span class="hljs-operator">=</span> A.id<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>EXISTS (subquery)只返回TRUE或FALSE,因此子查询中的SELECT * 也可以用SELECT 1替换,官方说法是实际执行时会忽略SELECT清单,因此没有区别</p></blockquote></li></ul><h2 id="四-count-查询优化"><a href="#四-count-查询优化" class="headerlink" title="四  count(*)查询优化"></a>四  <strong>count(*)查询优化</strong></h2><h3 id="查询mysql自己维护的总行数"><a href="#查询mysql自己维护的总行数" class="headerlink" title="查询mysql自己维护的总行数"></a>查询mysql自己维护的总行数</h3><ul><li>对于<strong>myisam存储引擎</strong>的表做不带where条件的count查询性能是很高的，因为myisam存储引擎的表的总行数会被 mysql存储在磁盘上查询不需要计算 。</li><li>对于<strong>innodb存储引擎</strong>的表mysql不会存储表的总记录行数，查询count需要实时计算</li></ul><h3 id="show-table-status"><a href="#show-table-status" class="headerlink" title="show table status"></a><strong>show table status</strong></h3><ul><li><p>如果只需要知道表总行数的估计值可以用如下sql查询，性能很高 .</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gxdq94vfa1j31rk088q4o.jpg"></p></li></ul><h3 id="count-优化方式"><a href="#count-优化方式" class="headerlink" title="count(*)优化方式"></a>count(*)优化方式</h3><ul><li><p><strong>将总数维护到Redis里</strong> </p><p>插入或删除表数据行的时候同时维护redis里的表总行数key的计数值(用incr或decr命令)，但是这种方式可能不准（如mysql执行成功了，redis没有更新成功），很难保证表操作和redis操作的事务一致性 ，可能得考虑分布式事务，适用于准确度要求不高的场景。</p></li><li><p><strong>增加计数表</strong></p><p>插入或删除表数据行的时候同时维护计数表（如新建一个表，该表增加一个字段user_count，insert user 的同时更新该字段），让他们在同一个事务里操作，让mysql的事务来保证一致性。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql索引</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sql优化方式</title>
    <link href="/%E5%B8%B8%E8%A7%81sql%E4%BC%98%E5%8C%96/"/>
    <url>/%E5%B8%B8%E8%A7%81sql%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="1-sql优化方式"><a href="#1-sql优化方式" class="headerlink" title="1. sql优化方式"></a>1. sql优化方式</h1><h3 id="1-创建和使用索引"><a href="#1-创建和使用索引" class="headerlink" title="1. 创建和使用索引"></a>1. <strong>创建和使用索引</strong></h3><ul><li><strong>索引常用查询字段</strong>：对经常出现在<code>WHERE</code>、<code>JOIN</code>、<code>ORDER BY</code>、<code>GROUP BY</code>中的字段建立索引。</li><li><strong>组合索引</strong>：创建包含多个列的组合索引，以满足多个条件查询的需求。</li><li><strong>覆盖索引</strong>：选择性地创建覆盖索引，使查询可以直接从索引中获取数据而无需访问表数据。</li><li><strong>避免过多索引</strong>：过多的索引会影响写操作的性能，应在查询和写操作之间找到平衡。</li><li><strong>遵守最左前缀法则</strong>：如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。</li></ul><h3 id="2-优化查询语句"><a href="#2-优化查询语句" class="headerlink" title="2. 优化查询语句"></a>2. <strong>优化查询语句</strong></h3><ul><li>**避免SELECT ***：只查询需要的字段，避免使用<code>SELECT *</code>。</li><li><strong>减少子查询</strong>：在可能的情况下，使用<code>JOIN</code>代替子查询。</li><li>**使用<code>EXISTS</code>替代<code>IN</code>**：对于子查询，使用<code>EXISTS</code>可能比<code>IN</code>更高效。</li><li><strong>避免函数索引</strong>：在<code>WHERE</code>子句中避免对列使用函数，尽量在应用层处理数据。</li><li><strong>避免索引失效，导致全表扫描</strong>：尽量不使用不等于（！&#x3D;或者&lt;&gt;）like，这些无法使用索引，会导致全表扫描 </li><li>不在索引列上做任何操作。（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描。</li></ul><h3 id="4-表设计优化"><a href="#4-表设计优化" class="headerlink" title="4. 表设计优化"></a>4. <strong>表设计优化</strong></h3><ul><li><strong>规范化</strong>：确保表设计符合第三范式，减少数据冗余。</li><li><strong>适当反规范化</strong>：在读操作频繁的情况下，可以适当反规范化，减少<code>JOIN</code>操作。</li></ul><h3 id="5-优化JOIN操作"><a href="#5-优化JOIN操作" class="headerlink" title="5. 优化JOIN操作"></a>5. <strong>优化<code>JOIN</code>操作</strong></h3><ul><li><strong>选择适当的<code>JOIN</code>类型</strong>：根据需求选择<code>INNER JOIN</code>、<code>LEFT JOIN</code>等，避免不必要的全表扫描。</li><li><strong>确保<code>JOIN</code>字段索引</strong>：确保<code>JOIN</code>操作中使用的字段上有索引。</li><li><strong>减少<code>JOIN</code>数量</strong>：避免多个表的<code>JOIN</code>，减少复杂度。</li></ul><h3 id="6-分页查询优化"><a href="#6-分页查询优化" class="headerlink" title="6. 分页查询优化"></a>6. <strong>分页查询优化</strong></h3><ul><li><strong>限制返回数据量</strong>：使用<code>LIMIT</code>和<code>OFFSET</code>进行分页查询，避免一次性返回大量数据。</li><li><strong>优化分页</strong>：使用高效的分页查询方式，如基于索引的分页或通过ID范围查询。</li></ul><h3 id="7-批量操作"><a href="#7-批量操作" class="headerlink" title="7. 批量操作"></a>7. <strong>批量操作</strong></h3><ul><li><strong>批量插入和更新</strong>：使用批量插入或更新操作，减少单次SQL操作的开销。</li><li><strong>避免逐行处理</strong>：尽量使用批量操作代替逐行处理，提高效率。</li></ul><h3 id="8-分析查询性能"><a href="#8-分析查询性能" class="headerlink" title="8. 分析查询性能"></a>8. <strong>分析查询性能</strong></h3><ul><li>**使用<code>EXPLAIN</code>**：使用<code>EXPLAIN</code>命令分析查询执行计划，识别性能瓶颈。</li><li><strong>查询日志分析</strong>：启用慢查询日志，分析执行时间较长的查询，进行针对性优化。</li></ul><h3 id="9-使用缓存"><a href="#9-使用缓存" class="headerlink" title="9. 使用缓存"></a>9. <strong>使用缓存</strong></h3><ul><li><strong>应用层缓存</strong>：使用Redis或Memcached等缓存频繁查询的数据。</li><li><strong>数据库层缓存</strong>：利用数据库的查询缓存机制（如MySQL Query Cache）。</li></ul><h3 id="11-使用合适的存储引擎"><a href="#11-使用合适的存储引擎" class="headerlink" title="11. 使用合适的存储引擎"></a>11. <strong>使用合适的存储引擎</strong></h3><ul><li><strong>选择合适的存储引擎</strong>：根据具体需求选择适合的存储引擎（如InnoDB、MyISAM）。</li></ul><h3 id="12-避免死锁"><a href="#12-避免死锁" class="headerlink" title="12. 避免死锁"></a>12. <strong>避免死锁</strong></h3><ul><li><strong>合理的事务管理</strong>：控制事务的粒度，避免长时间持有锁。</li><li><strong>避免资源竞争</strong>：尽量减少并发操作中对相同资源的竞争。</li></ul><h3 id="13-选择合适的数据库中间件"><a href="#13-选择合适的数据库中间件" class="headerlink" title="13. 选择合适的数据库中间件"></a>13. 选择合适的数据库中间件</h3><ul><li><p>如数据量大时采用归档或者CH等，提高查询效率</p><ul><li>在线查询系统OLTP</li><li>离线分析系统OLAP：常见报表</li></ul></li><li><p>和时间相关的数据数据采集这种，可以考虑influxDb</p></li><li><p>搜索相关的，elasticsearch</p></li></ul><p>1GB，数据条数在1千万以内：常见的数据库都可以应对：mysql, postgresql</p><p>1GB~10Gb, 亿级 -&gt; 单机</p><p>超过了10GB以及亿级 -》 数据分片， 多台物理机</p><p>（同时也考虑技术人才）</p><h3 id="14-分库分表"><a href="#14-分库分表" class="headerlink" title="14. 分库分表"></a>14. 分库分表</h3><ul><li>使用一些分库分表组件如：ShardingSphere，mycat， DBLE</li></ul><p>但是使用这些组件会一定程度限制SQL，需要你在使用前明确后续对SQL的操作</p><p><a href="https://pyr9.github.io/mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表要解决哪些问题</a></p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql索引</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Explain详解</title>
    <link href="/Explain%E8%AF%A6%E8%A7%A3/"/>
    <url>/Explain%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="explain使用介绍"><a href="#explain使用介绍" class="headerlink" title="explain使用介绍"></a>explain使用介绍</h1><ul><li><p>使用EXPLAIN关键字可以模拟优化器执行SQL语句，分析你的查询语句或是结构的性能瓶颈 </p></li><li><p>在 select 语句之前增加 explain 关键字，MySQL 会在查询上设置一个标记，执行查询会返回执行计划的信息，而不是执行这条SQL （如果 from 中包含子查询，仍会执行该子查询，将结果放入临时表中）。</p></li><li><p>在查询中的每个表会输出一行，如果有两个表通过 join 连接查询，那么会输出两行。表的意义相当广泛：可以是子查询、一个 union 结果等。</p></li></ul><p><strong>下面是使用explain的例子：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223313016.png" alt="image-20230228223313016"></p><h2 id="explain中的列"><a href="#explain中的列" class="headerlink" title="explain中的列"></a>explain中的列</h2><h3 id="id列"><a href="#id列" class="headerlink" title="id列"></a>id列</h3><ul><li><p>id列的编号就是select的序列号，有几个select就有几个id</p></li><li><p>id的顺序是按select 出现的顺序增长的</p></li><li><p>Id列越大执行优先级越高，id相同则从上往下执行，id为NULL最后执行</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> actor limit <span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223320796.png" alt="image-20230228223320796"></p><h3 id="select-type列"><a href="#select-type列" class="headerlink" title="select_type列"></a>select_type列</h3><ul><li>simple: 简单查询。查询中不含子查询和联合查询。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> film <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223331408.png" alt="image-20230228223331408"></p><ul><li>primary : 复杂查询中最外层的select。</li></ul> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> actor limit <span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure><p>中的：<code>select *** from film </code> </p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223341496.png" alt="image-20230228223341496"></p><ul><li>subsquery: 复杂查询中的子查询（不在from子句中）。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> actor limit <span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure><p>中的：<code>select 1 from actor limit 1</code></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223405616.png"></p><ul><li>derived([dɪˈraɪv]) : 包含在from子句中的子查询。Mysql将把结果存放在一个临时表中，也称为派生表。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span>  <span class="hljs-keyword">set</span> session optimizer_switch<span class="hljs-operator">=</span><span class="hljs-string">&#x27;derived_merge=off&#x27;</span>;<br>mysql<span class="hljs-operator">&gt;</span>  explain <span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> film <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>) der;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223416134.png"></p><ul><li>union ：在union后的select。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> id, name <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223426632.png" alt="image-20230228223426632"></p><blockquote><ul><li>union 用于把来自多个select  语句的结果组合到一个结果集合中。语法为：</li></ul>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"> <span class="hljs-keyword">select</span>  <span class="hljs-keyword">column</span>,......<span class="hljs-keyword">from</span> table1<br><span class="hljs-keyword">union</span> [<span class="hljs-keyword">all</span>]<br> <span class="hljs-keyword">select</span>  <span class="hljs-keyword">column</span>,...... <span class="hljs-keyword">from</span> table2<br></code></pre></td></tr></table></figure></blockquote><h3 id="table列"><a href="#table列" class="headerlink" title="table列"></a>table列</h3><ul><li>这一列表示explain的这一行在执行哪个表</li><li>当form后有子查询时，table列为<code>&lt;derivedN&gt;</code>格式，表示当前查询依赖id &#x3D; N的查询，于是先执行id&#x3D; N的查询。</li></ul><h3 id="type-列"><a href="#type-列" class="headerlink" title="type 列"></a>type 列</h3><ul><li><p>这一列表示访问类型，即mysql决定如何查找表中的行。</p></li><li><p>性能排序从好到坏依次为：<code>system &gt;const&gt; eq_ref&gt; ref&gt; range &gt; index &gt; all</code>，一般来说，得保证查询至少到range级别，最好到ref。</p></li><li><p>具体的类型介绍。</p><blockquote><ul><li><p>NULL：mysql在窒息感阶段用不着访问表或者索引。例如索引列中取最小值，可以单独查找索引来完成，不需要执行时访问表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(id) <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223438382.png" alt="image-20230228223438382"></p></li></ul></blockquote><blockquote><ul><li><p>const：直接按 primary key 或 unique key读取，将该列与常数比较，所以表最多有一个匹配行，读取1次，速度比较快</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> id, name <span class="hljs-keyword">from</span> film <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223446506.png" alt="image-20230228223446506"></p></li></ul></blockquote><blockquote><ul><li><p>eq_ref：primary key 或 unique key 索引的所有部分被连接使用 ，最多只会返回一条符合 条件的记录。这可能是在 const 之外最好的联接类型了，简单的 select 查询不会出现这种 type。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span>  explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> film_actor <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> film <span class="hljs-keyword">on</span> film_actor.film_id <span class="hljs-operator">=</span> film.id;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223459495.png" alt="image-20230228223459495"></p></li></ul></blockquote><blockquote><ul><li>ref：相比 eq_ref，不使用唯一索引，而是使用普通索引或者联合索引的部分前缀，索引要 和某个值相比较，可能会找到多个符合条件的行。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> film <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;film1&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223509760.png" alt="image-20230228223509760"></p></blockquote><blockquote><ul><li>range：范围扫描通常出现在 in(), between ,&gt; ,&lt;, &gt;&#x3D; 等操作中。使用一个索引来检索给定范围的行。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223520759.png" alt="image-20230228223520759"></p></blockquote><blockquote><ul><li>index：扫描全表索引，这通常比ALL快一些。即查询的字段都是索引列。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span>  explain <span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223531307.png" alt="image-20230228223531307"></p></blockquote><p>​</p><blockquote><ul><li>ALL：即全表扫描，意味着mysql需要从头到尾去查找所需要的行。通常情况下这需要增加索引来进行优化了。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span>  explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor;<br></code></pre></td></tr></table></figure><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223546942.png" alt="image-20230228223546942"></p></blockquote></li></ul><h3 id="possible-keys列"><a href="#possible-keys列" class="headerlink" title="possible_keys列"></a><strong>possible_keys列</strong></h3><ul><li>这一列显示查询可能使用哪些索引来查找。 </li><li>explain 时可能出现 possible_keys 有列，而 key 显示 NULL 的情况，这种情况是因为表中 数据不多，mysql认为索引对此查询帮助不大，选择了全表查询。 </li><li>如果该列是NULL，则没有相关的索引。在这种情况下，可以通过检查 where 子句看是否可以创造一个适当的索引来提高查询性能，然后用 explain 查看效果。</li></ul><h3 id="key列"><a href="#key列" class="headerlink" title="key列"></a>key列</h3><ul><li>这一列显示mysql实际采用哪个索引来优化对该表的访问。 </li><li>如果没有使用索引，则该列是 NULL。如果想强制mysql使用或忽视possible_keys列中的索 引，在查询中使用 force index、ignore index。</li></ul><h3 id="key-len列"><a href="#key-len列" class="headerlink" title="key_len列"></a>key_len列</h3><ul><li>这一列显示了mysql在索引里使用的字节数，通过这个值可以算出具体使用了索引中的哪些列。 </li><li>举例来说，film_actor的联合索引 idx_film_actor_id 由 film_id 和 actor_id 两个int列组成， 并且每个int是4字节。通过结果中的key_len&#x3D;4可推断出查询使用了第一个列：film_id列来执行索引查找。</li></ul><blockquote><p>key_len计算规则如下： </p><ul><li><p>字符串 </p><ul><li><p>char(n)：n字节长度</p></li><li><p>varchar(n)：2字节存储字符串长度，如果是utf-8，则长度 3n </p><p>+ 2</p></li></ul></li><li><p>数值类型</p><ul><li>tinyint：1字节 </li><li>smallint：2字节</li><li>int：4字节 </li><li>bigint：8字节</li></ul></li><li><p>时间类型</p><ul><li>date：3字节 </li><li>timestamp：4字节 </li><li>datetime：8字节</li></ul></li><li><p>如果字段允许为 NULL，需要1字节记录是否为 NULL</p></li></ul></blockquote><h3 id="ref列"><a href="#ref列" class="headerlink" title="ref列"></a><strong>ref列</strong></h3><ul><li>这一列显示了在key列记录的索引中，表查找值所用到的列或常量，常见的有：const（常量），字段名（例：film.id）</li></ul><h3 id="rows列"><a href="#rows列" class="headerlink" title="rows列"></a><strong>rows列</strong></h3><ul><li>这一列是mysql估计要读取并检测的行数，注意这个不是结果集里的行数。</li></ul><h3 id="Extra列"><a href="#Extra列" class="headerlink" title="Extra列"></a><strong>Extra列</strong></h3><p>这一列展示的是额外信息。常见的重要值如下： </p><ul><li><p>Using index：使用覆盖索引（覆盖索引指一个查询语句的执行只用从索引中就能够取得，不必从数据表中读取。 ）</p></li><li><p>Using where：使用 where 语句来处理结果，查询的列未被索引覆盖</p></li><li><p>Using index condition：会先条件过滤索引，过滤完索引后找到所有符合索引条件的数据行，随后用 WHERE 子句中的其他条件去过滤这些数据行；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> film_actor <span class="hljs-keyword">where</span> film_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li><li><p>Using temporary：mysql需要创建一张临时表来处理查询。出现这种情况一般是要进行优化的，首先是想到用索引来优化。 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> name <span class="hljs-keyword">from</span> actor;<br></code></pre></td></tr></table></figure><ul><li>actor.name没有索引，此时创建了张临时表来distinct</li></ul></li><li><p>Using filesort：将用外部排序而不是索引排序，数据较小时从内存排序，否则需要在磁盘完成排序。这种情况下一般也是要考虑使用索引来优化的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> actor <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> name;<br></code></pre></td></tr></table></figure><ul><li>actor.name未创建索引，会浏览actor整个表，保存排序关键字name和对应的id，然后排 序name并检索行记录</li></ul></li><li><p>Select tables optimized away：使用某些聚合函数（比如 max、min）来访问存在索引的某个字段.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> explain <span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(id) <span class="hljs-keyword">from</span> film;<br></code></pre></td></tr></table></figure></li></ul><blockquote><p> Extra 的介绍不是一定的，需要综合当时的场景考虑，不需要记住哪个场景使用的是哪个，只是需要当出现Using filesort, Using temporary：Using where：时，考虑需要优化。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Explain详解</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mysql索引介绍</title>
    <link href="/mysql%E7%B4%A2%E5%BC%95%E4%BB%8B%E7%BB%8D/"/>
    <url>/mysql%E7%B4%A2%E5%BC%95%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="1-索引的本质"><a href="#1-索引的本质" class="headerlink" title="1. 索引的本质"></a>1. 索引的本质</h1><blockquote><p>索引是帮助Mysql高效获取数据的排好序的数据结构</p></blockquote><h1 id="2-索引的数据结构"><a href="#2-索引的数据结构" class="headerlink" title="2. 索引的数据结构"></a>2. 索引的数据结构</h1><h4 id="二叉树：单边增长的场景会导致全表扫描。"><a href="#二叉树：单边增长的场景会导致全表扫描。" class="headerlink" title="二叉树：单边增长的场景会导致全表扫描。"></a>二叉树：单边增长的场景会导致全表扫描。</h4><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230316043.png" alt="image-20230228230316043"></p><span id="more"></span><h4 id="红黑树：相对平衡，比二叉树性能好，大数据下，红黑树的高度过高，会造成磁盘IO频繁。"><a href="#红黑树：相对平衡，比二叉树性能好，大数据下，红黑树的高度过高，会造成磁盘IO频繁。" class="headerlink" title="红黑树：相对平衡，比二叉树性能好，大数据下，红黑树的高度过高，会造成磁盘IO频繁。"></a>红黑树：相对平衡，比二叉树性能好，大数据下，红黑树的高度过高，会造成磁盘IO频繁。</h4><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230321402.png" alt="image-20230228230321402"></p><h4 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h4><p>一次hash算法就可以定位到文件的位置，但存在缺点：</p><ul><li>不支持范围查找</li><li>不支持排序</li></ul><p>数据库如果比较大，只用到精确查找就可以用hash</p><h4 id="B-tree："><a href="#B-tree：" class="headerlink" title="B-tree："></a>B-tree：</h4><ol><li><strong>特点：</strong></li></ol><blockquote><ul><li>叶子结点具有相同的深度，叶子结点指针为空。</li><li>所有索引元素不重复</li><li>节点中的数据索引从左到右递增</li></ul></blockquote><ol start="2"><li>如果使用了innoDb存储引擎，结点的data元素就可能存储的是除了索引外的其他所有列，会占用比较大的存储空间，对于一个大结点而言，可以存放的结点数量就会比较小</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230329788.png" alt="image-20230228230329788"></p><h4 id="B-tree-B-tree变种"><a href="#B-tree-B-tree变种" class="headerlink" title="B+tree(B-tree变种)"></a>B+tree(B-tree变种)</h4><ol><li><p>特点：</p><blockquote><ul><li>非叶子结点不存储data ,只存储索引（冗余），可以存放更多的索引。</li><li>叶子结点包含所有的索引字段。</li><li>叶子结点用指针连接，提高区间访问的性能。</li></ul></blockquote><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228230339454.png" alt="image-20230228230339454"></p></li></ol><p><strong>索引是怎么支持千万级表快速查找？</strong></p><p>mysql建议一个结点大小为16kb,这样一次iO速度比较快，一个大结点下的一个索引元素大约是14b，所以一个大结点里面约有1170个索引元素，对于一个高度为3的b+树，可以存储<code>16* 1170* 1170 </code>&#x3D; 2000万。</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql索引</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ的7种工作模式</title>
    <link href="/RabbitMQ%E7%9A%847%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F/"/>
    <url>/RabbitMQ%E7%9A%847%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ的7种工作模式"><a href="#RabbitMQ的7种工作模式" class="headerlink" title="RabbitMQ的7种工作模式"></a><strong>RabbitMQ的7种工作模式</strong></h1><h2 id="1-simple模式"><a href="#1-simple模式" class="headerlink" title="1. simple模式"></a>1. simple模式</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223058625.png" alt="image-20230228223058625"></p><ul><li><p>最简单的收发模式。生产者发送一个消息到一个指定的queue，中间不需要任何exchange规则。消费者端通过queue方式进行消费。</p></li><li><p>代码</p><ul><li><p>producer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>String message = <span class="hljs-string">&quot;hello world&quot;</span>;<br>channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, QUEUE_NAME, <span class="hljs-keyword">null</span>, message.getBytes(StandardCharsets.UTF_8));<br></code></pre></td></tr></table></figure></li><li><p>consumer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="2-work工作模式-资源的竞争"><a href="#2-work工作模式-资源的竞争" class="headerlink" title="2. work工作模式(资源的竞争)"></a>2. work工作模式(资源的竞争)</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223108418.png" alt="image-20230228223108418"></p><ul><li><p>一个生产者，多个消费者。</p></li><li><p>consumer1, consumer2 同时监听同一 个队列,消息被消费。服务器根据负载方案决定把消息发给一个指定的consumer处理。work主要有两种模式：</p><blockquote><ul><li><strong>轮询分发</strong>：一个消费者消费一条，<strong>按均分配</strong>，woek模式下默认是采用轮询分发方式。比较简单，比如生产费者发送了6条消息到队列中，如果有3个消费者同时监听着这一个队列，那么这3个消费者每人就会分得2条消息。</li><li>公平分发<strong>：根据消费者的消费能力进行公平分发，处理得快的分得多，处理的慢的分得少，</strong>能者多劳。</li></ul></blockquote></li><li><p>隐患：高并发情况下,默认会产生某一个消息被多个消费者共同使用,可以设置一个开关(syncronize) 保证一条消息只能被一个消费者使用。</p></li></ul><h2 id="3-publish-x2F-subscribe发布订阅-共享资源"><a href="#3-publish-x2F-subscribe发布订阅-共享资源" class="headerlink" title="3. publish&#x2F;subscribe发布订阅(共享资源)"></a>3. publish&#x2F;subscribe发布订阅(共享资源)</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223121109.png"></p><ul><li><p>type为**”fanout”** 的exchange</p></li><li><p>每个消费者监听自己的队列； 生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收到消息。</p></li><li><p>代码</p><ul><li><p>producer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);<br>channel.basicPublish(EXCHANGE_NAME, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes(StandardCharsets.UTF_8));<br></code></pre></td></tr></table></figure></li><li><p>consumer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.exchangeDeclare(EXCHANGE_NAME, <span class="hljs-string">&quot;fanout&quot;</span>);<br>channel.queueDeclare(<span class="hljs-string">&quot;queue1&quot;</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>channel.queueBind(<span class="hljs-string">&quot;queue1&quot;</span>, EXCHANGE_NAME, <span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="4-Routing路由模式"><a href="#4-Routing路由模式" class="headerlink" title="4. Routing路由模式"></a><strong>4. Routing路由模式</strong></h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223131996.png" alt="image-20230228223131996"></p><ul><li><p>type为”<strong>direct</strong>” 的exchange</p></li><li><p>根据routing_key 进行匹配，生产者，发送消息的时候会制定routing_key，交换机根据routing_key，去匹配绑定改routing_key的队列,只能匹配上路由key对应 的消息队列,对应的消费者才能消费消息</p></li><li><p>代码</p><ul><li><p>producer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.exchangeDeclare(DIRECT_EXCHANGE_NAME, BuiltinExchangeType.DIRECT);<br>channel.basicPublish(DIRECT_EXCHANGE_NAME, ROUTING_KEY, <span class="hljs-keyword">null</span>,message.getBytes(StandardCharsets.UTF_8));<br></code></pre></td></tr></table></figure></li><li><p>consumer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.exchangeDeclare(DIRECT_EXCHANGE_NAME, BuiltinExchangeType.DIRECT);<br>channel.queueDeclare(DIRECT_QUEUE_NAME, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>channel.queueBind(DIRECT_QUEUE_NAME, DIRECT_EXCHANGE_NAME, ROUTING_KEY);<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="5-topic-主题模式-路由模式的一种"><a href="#5-topic-主题模式-路由模式的一种" class="headerlink" title="5.topic 主题模式(路由模式的一种)"></a><strong>5.topic 主题模式(路由模式的一种)</strong></h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223142678.png"></p><ul><li><p>type为”<strong>topic</strong>“ 的exchange</p></li><li><p>交换机根据key的规则模糊匹配到对应的队列，由队列的监听消费者接收消息消费。类似sql的模糊匹配</p></li><li><p>* 代表一个具体的单词。# 代表0个或多个单词</p></li><li><p>代码</p><ul><li><p>producer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.exchangeDeclare(TOPIC_EXCHANGE, BuiltinExchangeType.TOPIC);<br>String message = <span class="hljs-string">&quot;hello world topic!&quot;</span>;<br>channel.basicPublish(TOPIC_EXCHANGE, <span class="hljs-string">&quot;hello.info&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes(StandardCharsets.UTF_8));<br></code></pre></td></tr></table></figure></li><li><p>consumer:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ROUTING_KEY = <span class="hljs-string">&quot;*.info&quot;</span>;<br>channel.exchangeDeclare(TOPIC_EXCHANGE, BuiltinExchangeType.TOPIC);<br>channel.queueDeclare(TOPIC_QUEUE_1, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>channel.queueBind(TOPIC_QUEUE_1, TOPIC_EXCHANGE, ROUTING_KEY);<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="6-RPC模式-路由模式的一种"><a href="#6-RPC模式-路由模式的一种" class="headerlink" title="6. RPC模式(路由模式的一种)"></a>6. RPC模式(路由模式的一种)</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223151956.png" alt="image-20230228223151956"></p><p>实现不同服务间的远程调用。 springCloud feign</p><h2 id="7-Publisher-Confirms-发送者消息确认"><a href="#7-Publisher-Confirms-发送者消息确认" class="headerlink" title="7. Publisher Confirms 发送者消息确认"></a>7. Publisher Confirms <strong>发送者消息确认</strong></h2><ul><li><p>这个模块就是通过给发送者提供一些确认机制，来保证这个消息发送的过程是成功的</p></li><li><p>发送者确认模式默认是不开启的，所以如果需要开启发送者确认模式，需要手动在channel中进行声明</p><p> <code>channel.confirmSelect() </code></p></li><li><p>在官网的示例中，重点解释了三种策略</p><ul><li><p><strong>1. 发布单条消息</strong></p><p>channel.waitForConfirmsOrDie(5_000);这个方法就会在channel端等待RabbitMQ给出一个响应，用来表明这个消息已经正确发送到了RabbitMQ服务端。但是要注意，这个方法会同步阻塞channel，在等待确认期间，channel将不能再继续发送消息，也就是说会明显降低集群的发送速度即吞吐量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">while</span> (thereAreMessagesToPublish()) &#123;<br>    <span class="hljs-keyword">byte</span>[] body = ...;<br>    BasicProperties properties = ...;<br>    channel.basicPublish(exchange, queue, properties, body);<br>    <span class="hljs-comment">// uses a 5 second timeout</span><br>    channel.waitForConfirmsOrDie(<span class="hljs-number">5_000</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>2. 发送批量消息</strong></p><p>之前单条确认的机制会对系统的吞吐量造成很大的影响，所以稍微中和一点的方式就是发送一批消息后，再一起确认。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">int</span> batchSize = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">int</span> outstandingMessageCount = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (thereAreMessagesToPublish()) &#123;<br>    <span class="hljs-keyword">byte</span>[] body = ...;<br>    BasicProperties properties = ...;<br>    channel.basicPublish(exchange, queue, properties, body);<br>    outstandingMessageCount++;<br>    <span class="hljs-keyword">if</span> (outstandingMessageCount == batchSize) &#123;<br>        channel.waitForConfirmsOrDie(<span class="hljs-number">5_000</span>);<br>        outstandingMessageCount = <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (outstandingMessageCount &gt; <span class="hljs-number">0</span>) &#123;<br>    channel.waitForConfirmsOrDie(<span class="hljs-number">5_000</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>3. 异步确认消息</strong></p><p>Producer在channel中注册监听器来对消息进行确认。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.addConfirmListener(ConfirmCallback var1, ConfirmCallback var2); <br></code></pre></td></tr></table></figure><p>发送者在发送完消息后，就会执行第一个监听器callback1，然后等服务端发过来的反馈后，再执行第二个监听器callback2</p></li></ul></li></ul><h2 id="常用的四种交换器："><a href="#常用的四种交换器：" class="headerlink" title="常用的四种交换器："></a>常用的四种交换器：</h2><ul><li><p>fanout：如果交换器收到消息，将会广播到所有绑定的队列上 </p></li><li><p>direct：如果路由键完全匹配，消息就被投递到相应的队列 </p></li><li><p>topic：可以使来自不同源头的消息能够到达同一个队列。 使用 topic 交换器时，可以使用通配符， * 代表一个具体的单词。# 代表0个或多个单词</p></li><li><p>header: 不处理路由键，根据发送的消息内容中的headers属性进行匹配</p></li></ul><h2 id="消息的分发策略"><a href="#消息的分发策略" class="headerlink" title="消息的分发策略"></a>消息的分发策略</h2><ul><li><p>消息的分发策略</p><p>  假设队列里有100条消息，有 A,B,C   3个队列</p><ul><li>发布订阅。三个队列都收到100条</li><li>轮训分发。3个队列都是至少33条，剩下一条随机，不论你数据库性能怎么样，大家接受的都是公平的</li><li>公平分发。根据服务器性能，去分发，哪个性能高，哪个处理的消息可能就多，能者多劳，会造成数据倾斜</li><li>重发。发送消息中出现了异常后，消息没有得到应答，就会重发，kafka不支持</li><li>消息拉取。就是RPC去拉取数据</li></ul><blockquote><p>Rabbitmq以上集中策略都支持，且是开源的</p><p>kafka速度最快</p></blockquote></li></ul><h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><ul><li>中间件<ul><li>是一种应用于分布式系统的基础软件。</li><li>常见的中间件：mysql，rabbit MQ</li></ul></li><li>怎么选择中间件<ul><li>可以通信，跨平台。比方两个项目一个java，一个go之间要通信，就要遵循同一种协议</li><li>高可用<ul><li>是否拥有持久化。比方中间件挂了，重启后是否可以把消息重新存储起来的能力</li><li>支持集群。系统cpu不够用了，就得搭集群</li></ul></li><li>有分发能力，多个系统，往那个系统去发送消息</li></ul></li></ul><h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><ul><li><p>网络协议三要素：</p><ul><li>语法：用户数据的结构与形式，如：http中规定了请求和响应报文的格式</li><li>语义：规定了何种信息需要对应发出何种响应，如：请求get要把参数放在url中，post把参数放在body中</li><li>时序：事件的执行顺序，如：先有请求后有响应</li></ul></li><li><p>为什么消息中间件不用http？</p><ul><li>http的请求和响应报文比较复杂，有cookie, 状态码，响应码这些，但消息中间件：只需要接受消息，存储消息，分发消息，不需要这么复杂</li><li>http大部分是短链接，不利于出现故障时消息持久化</li></ul></li><li><p>AMQP（advanced message. Queuing protocol） 高级消息队列协议</p><ul><li>采用Erlang，底层是C，速度很快</li><li>特性<ul><li>支持分布式事务</li><li>消息持久化</li><li>高性能高可靠的消息处理优势</li></ul></li></ul></li><li><p>kafka 协议</p><ul><li>基于TCP&#x2F;IP的二进制协议，消息内部由长度分割，由基本数据类型构成</li><li>特性<ul><li>结构简单</li><li>解析速度快</li><li>消息持久化</li><li>不支持事务</li></ul></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>消息中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>秒杀模块学习</title>
    <link href="/%E7%A7%92%E6%9D%80%E6%A8%A1%E5%9D%97%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87/"/>
    <url>/%E7%A7%92%E6%9D%80%E6%A8%A1%E5%9D%97%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<h1 id="秒杀模块"><a href="#秒杀模块" class="headerlink" title="秒杀模块"></a>秒杀模块</h1><h2 id="1-秒杀接口优化"><a href="#1-秒杀接口优化" class="headerlink" title="1. 秒杀接口优化"></a>1. 秒杀接口优化</h2><ul><li>用户是否登陆</li><li>判断库存（备份在redis中一份）<ul><li>在初始化contoller接口的时候，就把商品id和对应的库存数存入到redis</li></ul></li><li>判断是否已经秒杀到了</li><li>减缓存， 下订单（订单和秒杀订单）<ul><li>队列里面存的消息message，有两个变量用户和商品id,</li><li>receiver监听该队列，减库存，减库存成功了，根据用户和商品id,下订单</li><li>contoller需要的就是给队列发消息，最终给前端返回一个状态值（排队中）</li></ul></li></ul><span id="more"></span><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwn32zi2y7j30o40n0wfo.jpg" style="zoom: 67%;" /><ul><li>前端轮询：是否生成了订单<ul><li>查询该笔订单是否存在<ul><li>存在，生成订单</li><li>不存在，查看商品是否已经秒杀完了：<ul><li>没秒杀完，就是排队中</li><li>完了，就返回该商品已经卖完了，并且在缓存中记录下该商品已经售罄了。goods_over+goodsId, true</li></ul></li></ul></li></ul></li></ul><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwn3541p3cj30qk0hkq4d.jpg" style="zoom:50%;" /><h2 id="2-秒杀接口地址隐藏"><a href="#2-秒杀接口地址隐藏" class="headerlink" title="2. 秒杀接口地址隐藏:"></a>2. 秒杀接口地址隐藏:</h2><p>针对不同的用户，生成不同的秒杀地址，即秒杀地址上带一个参数，参数根据当前【用户id，商品id】随机生成，并保存在redis中，做秒杀的时候，先检查该参数是否匹配，只有匹配了才可以进行秒杀，不匹配是非法请求。</p><h2 id="3-验证码生成"><a href="#3-验证码生成" class="headerlink" title="3. 验证码生成"></a>3. 验证码生成</h2><p>点击秒杀之前，先让用户输入验证码。有2个目的：</p><ul><li>防止机器人</li><li>用户输入验证码结果时间不同，因此分散用户的请求。</li></ul><p>实现：</p><ul><li>生成秒杀验证码，放在redis中</li><li>在秒杀的时候，先验证验证码，验证成功，删除ke y</li></ul><h2 id="4-接口限流防刷"><a href="#4-接口限流防刷" class="headerlink" title="4. 接口限流防刷"></a>4. 接口限流防刷</h2><p>思路：</p><p>把每个用户访问接口的次数写入到缓存中，并设置失效时长s，因为可能每个方法设置的参数可能不同，所以可以通过注解+拦截器实现。</p><p>实现在 <strong>Controller</strong> 处理请求之前 先判断是否已经超过了设置的最大访问次数。</p><p>具体实现：</p><p>Step1: 在需要防刷的方法上加注解annotation，注解里设置两个参数时间seconds和最大访问次数maxCount</p><p>Step2: 添加拦截器(Interceptor)，在拦截器里先判断该方法上是否加了对应注解</p><p>Step3: 通过request中取得的method uri, 用户id 可以得到当前用户访问的该方法的次数</p><p>step4: 将该次数和注解里存的最大访问次数进行比较，看是否已经超过了限制的最大次数</p><p>Step5: redis中存放的key设置最大过期时间为注解的时间</p><p>Step5: 注册该拦截器</p><h2 id="5-分布式session"><a href="#5-分布式session" class="headerlink" title="5. 分布式session"></a>5. 分布式session</h2><p>用户登陆成功后，给用户生成一个session_id标识这个用户，写在客户端cookie中，客户端访问服务器的时候会带上cookie，服务端在处理的时候，会从cookie中解码出session_id，从而取到用户信息。</p><hr/><h2 id="为什么要使用分布式Session"><a href="#为什么要使用分布式Session" class="headerlink" title="为什么要使用分布式Session"></a>为什么要使用分布式Session</h2><p>Web应用在单机部署的情况下，Session是被单个应用服务器存储管理的，由于只有一个应用服务器，用户的所有请求都是通过它进行响应处理的，所以能够很容易实现会话跟踪和保持。随着业务量的增长，系统架构需要做出调整以适应发展的需要，可能会使用分布式架构或微服务架构，无论使用哪种架构方式，应用系统单机部署的模式已经不能满足需求，所以会将应用系统部署到多台应用服务器上，用户的请求也会通过负载均衡转发到某个具体应用服务器上执行，可能会出现在A1系统登录后创建并保存Session，再次发起请求，请求被转发到A2系统上显示未登录的情况，此时单机部署模式下的Session机制已不能满足要求。所以，在分布式架构或微服务架构下，必须保证一个应用服务器上保存Session后，其它应用服务器可以同步或共享这个Session。</p><h2 id="分布式session管理实现方案"><a href="#分布式session管理实现方案" class="headerlink" title="分布式session管理实现方案"></a>分布式session管理实现方案</h2><p>分布式Session有如下几种实现方式。</p><h2 id="1-Session复制"><a href="#1-Session复制" class="headerlink" title="1.Session复制"></a>1.Session复制</h2><p>在支持Session复制的Web服务器上，通过修改Web服务器的配置，可以实现将Session同步到其它Web服务器上，达到每个Web服务器上都保存一致的Session。<br>优点：代码上不需要做支持和修改。<br>缺点：需要依赖支持的Web服务器，一旦更换成不支持的Web服务器就不能使用了，在数据量很大的情况下不仅占用网络资源，而且会导致延迟。<br>适用场景：只适用于Web服务器比较少且Session数据量少的情况。<br>可用方案：开源方案tomcat-redis-session-manager，暂不支持Tomcat8。</p><h2 id="2-Session粘滞"><a href="#2-Session粘滞" class="headerlink" title="2.Session粘滞"></a>2.Session粘滞</h2><p>将用户的每次请求都通过某种方法强制分发到某一个Web服务器上，只要这个Web服务器上存储了对应Session数据，就可以实现会话跟踪。<br>优点：使用简单，没有额外开销。<br>缺点：一旦某个Web服务器重启或宕机，相对应的Session数据将会丢失，而且需要依赖负载均衡机制。<br>适用场景：对稳定性要求不是很高的业务情景。</p><h2 id="3-Session集中管理"><a href="#3-Session集中管理" class="headerlink" title="3.Session集中管理"></a>3.Session集中管理</h2><p>在单独的服务器或服务器集群上使用缓存技术，如Redis存储Session数据，集中管理所有的Session，所有的Web服务器都从这个存储介质中存取对应的Session，实现Session共享。<br>优点：可靠性高，减少Web服务器的资源开销。<br>缺点：实现上有些复杂，配置较多。<br>适用场景：Web服务器较多、要求高可用性的情况。<br>可用方案：开源方案Spring Session，也可以自己实现，主要是重写HttpServletRequestWrapper中的getSession方法，博主也动手写了一个，github搜索joincat用户，然后自取。</p><h2 id="4-基于Cookie管理"><a href="#4-基于Cookie管理" class="headerlink" title="4.基于Cookie管理"></a>4.基于Cookie管理</h2><p>这种方式每次发起请求的时候都需要将Session数据放到Cookie中传递给服务端。<br>优点：不需要依赖额外外部存储，不需要额外配置。<br>缺点：不安全，易被盗取或篡改；Cookie数量和长度有限制，需要消耗更多网络带宽。<br>适用场景：数据不重要、不敏感且数据量小的情况。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这四种方式，相对来说，Session集s管理更加可靠，使用也是最多的。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>使用Spock框架编写测试代码</title>
    <link href="/%E4%BD%BF%E7%94%A8Spock%E6%A1%86%E6%9E%B6%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/"/>
    <url>/%E4%BD%BF%E7%94%A8Spock%E6%A1%86%E6%9E%B6%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<h2 id="Spock-介绍"><a href="#Spock-介绍" class="headerlink" title="Spock 介绍"></a>Spock 介绍</h2><blockquote><ul><li><p>Spock是一个为groovy和java语言应用程序来测试和规范的框架。</p></li><li><p>这个框架的突出点在于它美妙和高效表达规范的语言。</p></li><li><p>得益于JUnit runner，Spock能够在大多数IDE、编译工具、持续集成服务下工作。</p></li><li><p>Spock的灵感源于JUnit,jMock, RSpec, Groovy, Scala, Vulcans以及其他优秀的框架形态。</p></li></ul></blockquote><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><ul><li>a simple assertion</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should be a simple assertion&quot;</span>() &#123;<br>    <span class="hljs-symbol">expect:</span><br>    <span class="hljs-number">1</span> == <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><span id="more"></span><ul><li>given when then 使用</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should demo given-when-then&quot;</span>()&#123;<br>     <span class="hljs-symbol">given:</span><br>     <span class="hljs-keyword">def</span> user = <span class="hljs-keyword">new</span> Polygon(<span class="hljs-number">10</span>)<br><br>     <span class="hljs-symbol">when:</span><br>     <span class="hljs-keyword">int</span> age = user.numberOfSides<br><br>     <span class="hljs-symbol">then:</span><br>     age == <span class="hljs-number">10</span><br> &#125;<br></code></pre></td></tr></table></figure><ul><li>expecting exceptions</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should expect exceptions&quot;</span>()&#123;<br>     <span class="hljs-symbol">when:</span><br>     <span class="hljs-keyword">new</span> Polygon(<span class="hljs-number">0</span>)<br><br>     <span class="hljs-symbol">then:</span><br>     thrown(TooFewSidesException)<br> &#125;<br></code></pre></td></tr></table></figure><ul><li>data pipes.     where设置所有期望值</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should expect an exception to be throw for a number of invalid inputs&quot;</span>()&#123;<br>       <span class="hljs-symbol">when:</span><br>       <span class="hljs-keyword">new</span> Polygon(sides)<br><br>       <span class="hljs-symbol">then:</span><br>       thrown(TooFewSidesException)<br><br>       <span class="hljs-comment">//The where block says &quot;run this test with each of the following values: a negative value, zero, one and two&quot;.</span><br>       <span class="hljs-comment">// where设置所有期望值</span><br>       <span class="hljs-symbol">where:</span><br>       sides &lt;&lt; [<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]<br>   &#125;<br></code></pre></td></tr></table></figure><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should be able to create polygon with valid inputs&quot;</span>()&#123;<br>      <span class="hljs-symbol">expect:</span><br>      <span class="hljs-keyword">new</span> Polygon(sides).numberOfSides == sides<br><br>      <span class="hljs-comment">//The where block says &quot;run this test with each of the following values: a negative value, zero, one and two&quot;.</span><br>      <span class="hljs-symbol">where:</span><br>      sides &lt;&lt; [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]<br>  &#125;<br></code></pre></td></tr></table></figure><ul><li>data tables</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should use data tables for calculating max&quot;</span>()&#123;<br>      <span class="hljs-comment">// 如果我们只有一条语句设置了测试和断言，我们可以直接使用`expect`标签</span><br>      <span class="hljs-symbol">expect:</span><br>      Math.max(a,b) == max<br><br>      <span class="hljs-symbol">where:</span><br>      a | b | max<br>      <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">2</span><br>      <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">4</span><br>      <span class="hljs-number">5</span> | <span class="hljs-number">9</span> | <span class="hljs-number">9</span><br>  &#125;<br></code></pre></td></tr></table></figure><ul><li>mocks 模拟出类或API来声明预期的行为</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should be able to mock a specific class&quot;</span>() &#123;<br>        <span class="hljs-symbol">given:</span><br>        Renderer renderer = Mock()<br><br>        <span class="hljs-comment">//@Subject只是为了标记我们正在测试的对象，对代码没有任何影响</span><br>        <span class="hljs-meta">@Subject</span><br>        <span class="hljs-keyword">def</span> ploygon = <span class="hljs-keyword">new</span> Polygon(<span class="hljs-number">4</span>, renderer)<br><br>        <span class="hljs-symbol">when:</span><br>        ploygon.draw()<br><br>        <span class="hljs-symbol">then:</span><br>        <span class="hljs-number">4</span> * renderer.drawLine()<br>    &#125;<br></code></pre></td></tr></table></figure><ul><li>stubs 在测试的代码里提供数据或者值</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should be able to create a stubs&quot;</span>() &#123;<br>       <span class="hljs-symbol">given:</span><br>       Palette palette = Stub()<br>       palette.getPrimaryColor() &gt;&gt; Color.red<br><br>       <span class="hljs-keyword">def</span> renderer =  <span class="hljs-keyword">new</span> Renderer(palette)<br><br>       <span class="hljs-symbol">expect:</span><br>       renderer.getForeGroundColor() == Color.red<br>   &#125;<br></code></pre></td></tr></table></figure><ul><li>help methods</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should use a helper methods&quot;</span>() &#123;<br>    <span class="hljs-symbol">given:</span><br>    Renderer renderer = Mock()<br>    <span class="hljs-keyword">def</span> shapeFactory = <span class="hljs-keyword">new</span> ShapeFactory(renderer)<br><br>    <span class="hljs-symbol">when:</span><br>    <span class="hljs-keyword">def</span> polygon = shapeFactory.createDefaultPolygon()<br><br>    <span class="hljs-symbol">then:</span><br>    checkDefaultShape(polygon, renderer)<br>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-keyword">void</span> checkDefaultShape(Polygon polygon, Renderer renderer) &#123;<br>    <span class="hljs-keyword">assert</span> polygon.numberOfSides == <span class="hljs-number">4</span><br>    <span class="hljs-keyword">assert</span> renderer == renderer<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>with 测试但个对象的多个属性</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should use #with()&quot;</span>() &#123;<br>        <span class="hljs-symbol">given:</span><br>        Renderer renderer = Mock()<br>        <span class="hljs-keyword">def</span> shapeFactory = <span class="hljs-keyword">new</span> ShapeFactory(renderer)<br><br>        <span class="hljs-symbol">when:</span><br>        <span class="hljs-keyword">def</span> polygon = shapeFactory.createDefaultPolygon()<br><br>        <span class="hljs-symbol">then:</span><br>        with(polygon)&#123;<br>            numberOfSides == <span class="hljs-number">4</span><br>            renderer == render<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><ul><li><p>verifyAll() 确保所有断言都在执行，而不管其中之一是否失败了。</p><p>当使用with时，第一行测试失败了，第二行测试就不会执行了，而verifyAll 会运行所有行测试</p></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;should use #verifyAll()&quot;</span>() &#123;<br>       <span class="hljs-symbol">given:</span><br>       Renderer renderer = Mock()<br>       <span class="hljs-keyword">def</span> shapeFactory = <span class="hljs-keyword">new</span> ShapeFactory(renderer)<br><br>       <span class="hljs-symbol">when:</span><br>       <span class="hljs-keyword">def</span> polygon = shapeFactory.createDefaultPolygon()<br><br>       <span class="hljs-symbol">then:</span><br>       verifyAll(polygon)&#123;<br>           numberOfSides == <span class="hljs-number">5</span><br>           renderer == <span class="hljs-literal">null</span><br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><ul><li><p>setup-and-teardown</p><ul><li>setupSpec():  在规范的开始设置状态一次，这是为了在各个测试方法之间不应该改变的东西</li><li>setup(): 将在该类中的每个单独测试方法之前运行。这可用于在每次测试开始时设置干净状态。</li><li>cleanup(): 在每个测试方法结束时清理数据或状态</li><li>cleanupSpec() :  对于最终的分解代码，该方法将在运行所有测试的最后调用一次。</li></ul></li><li><p>and可以增加多个使代码根据可读性：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">given: <span class="hljs-string">&quot;test method&quot;</span><br><span class="hljs-regexp">//</span> code ....<br><br>and: <span class="hljs-string">&quot;test method with user1&quot;</span><br><span class="hljs-regexp">//</span> code ...<br><br>and: <span class="hljs-string">&quot;test method with user2&quot;</span><br><span class="hljs-regexp">//</span> code ...<br></code></pre></td></tr></table></figure></li></ul><p>​</p>]]></content>
    
    
    <categories>
      
      <category>测试框架</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spock</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kotlin基础</title>
    <link href="/kotlin%E5%AD%A6%E4%B9%A0/"/>
    <url>/kotlin%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="1-Kotlin-是什么？"><a href="#1-Kotlin-是什么？" class="headerlink" title="1.Kotlin 是什么？"></a>1.Kotlin 是什么？</h2><p>Kotlin 是一种在 Java 虚拟机上运行的静态类型编程语言，被称之为 Android 世界的Swift，由 JetBrains 设计开发并开源。</p><p>在Google I&#x2F;O 2017中，Google 宣布 Kotlin 成为 Android 官方开发语言。</p><h2 id="2-为什么选择-Kotlin？"><a href="#2-为什么选择-Kotlin？" class="headerlink" title="2.为什么选择 Kotlin？"></a>2.为什么选择 Kotlin？</h2><ul><li>简洁: 大大减少样板代码的数量。</li><li>安全: 避免空指针异常等整个类的错误。</li><li>互操作性: 充分利用 JVM、Android 和浏览器的现有库。</li><li>工具友好: 可用任何 Java IDE 或者使用命令行构建。</li></ul><span id="more"></span><h2 id="3-我的第一个-Kotlin-程序"><a href="#3-我的第一个-Kotlin-程序" class="headerlink" title="3.我的第一个 Kotlin 程序"></a>3.我的第一个 Kotlin 程序</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">(args: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> &#123;<br>    println(<span class="hljs-string">&quot;hello word!&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Kotlin 程序文件以 <strong>.kt</strong> 结尾，如：hello.kt 、app.kt。</p></blockquote><h2 id="4-基础语法"><a href="#4-基础语法" class="headerlink" title="4.基础语法"></a>4.基础语法</h2><ul><li>函数定义</li></ul><p>格式：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> 方法名<span class="hljs-params">(参数A : 类型<span class="hljs-type">A</span>, 参数B : 类型<span class="hljs-type">B</span>)</span></span>: 返回值类型(可以为空) &#123;<br>   函数体<br>&#125;<br></code></pre></td></tr></table></figure><p>如：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sum</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> &#123;   <span class="hljs-comment">// Int 参数，返回值 Int</span><br>    <span class="hljs-keyword">return</span> a + b<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   <span class="hljs-keyword">var</span> result = add(<span class="hljs-number">3</span>,<span class="hljs-number">5</span>)<br>    println(result)<br>&#125;<br><br><span class="hljs-comment">//fun add(x: Int, y: Int): Int &#123;</span><br><span class="hljs-comment">//  return x+ y</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> = x+ y<br></code></pre></td></tr></table></figure><ul><li>可变长参数</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">vars</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> v:<span class="hljs-type">Int</span>)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(vt <span class="hljs-keyword">in</span> v)&#123;<br>        print(vt)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">(args: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> &#123;<br>    vars(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)  <span class="hljs-comment">// 输出12345</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>默认参数和具名参数</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calThePerimeterOfCircle</span><span class="hljs-params">(pi: <span class="hljs-type">Float</span> = Pi, r: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>* pi * r<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    println(<span class="hljs-string">&quot;圆的周长为：<span class="hljs-subst">$&#123;calThePerimeterOfCircle(r = <span class="hljs-number">2.0</span>f)&#125;</span>&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>函数表达式</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   <span class="hljs-keyword">var</span> i = &#123;x: <span class="hljs-built_in">Int</span>, y: <span class="hljs-built_in">Int</span> -&gt; x+ y&#125;<br>    println(i(<span class="hljs-number">3</span>,<span class="hljs-number">5</span>))<br><br>    <span class="hljs-comment">// 输入类型是两个int ，返回值是int，输入参数为x,y 表达式为x+y</span><br>    <span class="hljs-keyword">var</span> j:(<span class="hljs-built_in">Int</span>,<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> = &#123;x,y -&gt; x+y&#125;<br>    println(i(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>))<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>条件控制 if</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">returnBigValue</span><span class="hljs-params">(a:<span class="hljs-type">Int</span>,b:<span class="hljs-type">Int</span>)</span></span>:<span class="hljs-built_in">Int</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (a&gt;b) a <span class="hljs-keyword">else</span> b<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">(args: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a= <span class="hljs-number">3</span><br>    <span class="hljs-keyword">var</span> b = <span class="hljs-number">5</span><br>    println(<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;a&#125;</span>和<span class="hljs-subst">$&#123;b&#125;</span>中较大的数是<span class="hljs-subst">$&#123;returnBigValue(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)&#125;</span>&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>When 表达式</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">gradeStudent</span><span class="hljs-params">(score:<span class="hljs-type">Int</span>)</span></span>&#123;<br>    <span class="hljs-keyword">when</span>(score)&#123;<br>        <span class="hljs-number">10</span> -&gt; println(<span class="hljs-string">&quot;优秀！&quot;</span>)<br>        <span class="hljs-number">1</span> -&gt; println(<span class="hljs-string">&quot;差劲！&quot;</span>)<br>        <span class="hljs-keyword">else</span> -&gt; println(<span class="hljs-string">&quot;努力努力！&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    println(gradeStudent(<span class="hljs-number">9</span>))<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>list</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> items = listOf&lt;String&gt;(<span class="hljs-string">&quot;语文&quot;</span>,<span class="hljs-string">&quot;数学&quot;</span>,<span class="hljs-string">&quot;英语&quot;</span>);<br>    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> items)&#123;<br>        println(<span class="hljs-string">&quot;科目有：<span class="hljs-subst">$&#123;i&#125;</span>&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">for</span> ((i,index) <span class="hljs-keyword">in</span> items.withIndex())&#123;<br>        println(<span class="hljs-string">&quot;科目为：<span class="hljs-subst">$&#123;i&#125;</span>，序号为<span class="hljs-subst">$&#123;index&#125;</span>&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>map</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   <span class="hljs-keyword">var</span> map = TreeMap&lt;String,String&gt;()<br>    map[<span class="hljs-string">&quot;好&quot;</span>] = <span class="hljs-string">&quot;good&quot;</span><br>    map[<span class="hljs-string">&quot;坏&quot;</span>] = <span class="hljs-string">&quot;bad&quot;</span><br>    println(map[<span class="hljs-string">&quot;好&quot;</span>])<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>字符串和数字的转换</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a = <span class="hljs-string">&quot;string&quot;</span><br>    <span class="hljs-keyword">var</span> b = <span class="hljs-number">1</span><br>    println(<span class="hljs-string">&quot;字符串转数字：<span class="hljs-subst">$&#123;a.toString()&#125;</span>&quot;</span>)<br>    println(<span class="hljs-string">&quot;数字转字符串：<span class="hljs-subst">$&#123;b.toInt()&#125;</span>&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>控制台输入变量</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    println(<span class="hljs-string">&quot;请输入第一个数字：&quot;</span>)<br>    <span class="hljs-keyword">var</span> str1 = readLine()<br>    println(<span class="hljs-string">&quot;请输入第二个数字：&quot;</span>)<br>    <span class="hljs-keyword">var</span> str2 = readLine()<br><br>    <span class="hljs-keyword">var</span> num1 = str1!!.toInt()<br>    <span class="hljs-keyword">var</span> num2 = str2!!.toInt()<br>    println(<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;num1&#125;</span>+<span class="hljs-subst">$&#123;num2&#125;</span>=<span class="hljs-subst">$&#123;num1+num2&#125;</span>&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>处理异常-&gt; try…catch()</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    println(<span class="hljs-string">&quot;请输入第一个数字：&quot;</span>)<br>    <span class="hljs-keyword">var</span> str1 = readLine()<br>    println(<span class="hljs-string">&quot;请输入第二个数字：&quot;</span>)<br>    <span class="hljs-keyword">var</span> str2 = readLine()<br>    <span class="hljs-keyword">try</span>&#123;<br>        <span class="hljs-keyword">var</span> num1 = str1!!.toInt()<br>        <span class="hljs-keyword">var</span> num2 = str2!!.toInt()<br>        println(<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;num1&#125;</span>+<span class="hljs-subst">$&#123;num2&#125;</span>=<span class="hljs-subst">$&#123;num1+num2&#125;</span>&quot;</span>)<br>    &#125;<span class="hljs-keyword">catch</span> (e: Exception)&#123;<br>        println(<span class="hljs-string">&quot;输入的数据有误！&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>字符串模板</p><p>$ 表示一个变量名或者变量值</p><p>$varName 表示变量值</p><p>${varName.fun()} 表示变量的方法返回值:</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">(args: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span><br><br><span class="hljs-comment">// 模板中的简单名称：</span><br>    <span class="hljs-keyword">val</span> s1 = <span class="hljs-string">&quot;a is <span class="hljs-variable">$a</span>&quot;</span><br><br>    a = <span class="hljs-number">2</span><br><span class="hljs-comment">// 模板中的任意表达式：</span><br>    <span class="hljs-keyword">val</span> s2 = <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;s1.replace(<span class="hljs-string">&quot;is&quot;</span>, <span class="hljs-string">&quot;was&quot;</span>)&#125;</span>, but now is <span class="hljs-variable">$a</span>&quot;</span><br>    println(s2)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>空值处理</p><p>Kotlin的空安全设计对于声明可为空的参数，在使用时要进行空判断处理，有两种处理方式。</p><ul><li><p>字段后加!!像Java一样抛出空异常</p></li><li><p>字段后加?可不做处理返回值为 null或配合?:做空判断处理</p></li></ul></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//类型后面加?表示可为空</span><br><span class="hljs-keyword">var</span> age: String? = <span class="hljs-string">&quot;23&quot;</span> <br><span class="hljs-comment">//抛出空指针异常</span><br><span class="hljs-keyword">val</span> ages = age!!.toInt()<br><span class="hljs-comment">//不做处理返回 null</span><br><span class="hljs-keyword">val</span> ages1 = age?.toInt()<br><span class="hljs-comment">//age为空返回-1</span><br><span class="hljs-keyword">val</span> ages2 = age?.toInt() ?: -<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="5-类"><a href="#5-类" class="headerlink" title="5.类"></a>5.类</h2><h3 id="5-1-类的创建"><a href="#5-1-类的创建" class="headerlink" title="5.1 类的创建"></a>5.1 类的创建</h3><p>Kotlin 中没有 new 关键字</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rectangular</span></span>&#123;<br>    <span class="hljs-keyword">var</span> width:<span class="hljs-built_in">Int</span> = <span class="hljs-number">10</span><br>    <span class="hljs-keyword">var</span> height:<span class="hljs-built_in">Int</span> = <span class="hljs-number">5</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> rectangular = Rectangular()<br>    println(rectangular.height)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-枚举类"><a href="#5-2-枚举类" class="headerlink" title="5.2 枚举类"></a>5.2 枚举类</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Color</span></span>&#123;<br>    RED,BLACK,BLUE,GREEN,WHITE<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-Kotlin-继承"><a href="#6-Kotlin-继承" class="headerlink" title="6. Kotlin 继承"></a>6. Kotlin 继承</h3><p>Kotlin 中所有类都继承该 Any 类，它是所有类的超类，对于没有超类型声明的类是默认超类：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">class</span> <span class="hljs-symbol">Example</span> // 从 <span class="hljs-symbol">Any</span> 隐式继承<br></code></pre></td></tr></table></figure><p>Any 默认提供了三个函数：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">equals</span><span class="hljs-params">()</span></span><br><br><span class="hljs-function"><span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><br><span class="hljs-function"><span class="hljs-title">toString</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure><p>注意：Any 不是 java.lang.Object。</p><p>如果一个类要被继承，可以使用 open 关键字进行修饰。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">open <span class="hljs-keyword">class</span> <span class="hljs-symbol">Base</span>(<span class="hljs-symbol">p: <span class="hljs-symbol">Int</span></span>)           // 定义基类<br><br><span class="hljs-symbol">class</span> <span class="hljs-symbol">Derived</span>(<span class="hljs-symbol">p: <span class="hljs-symbol">Int</span></span>) : <span class="hljs-symbol">Base</span>(<span class="hljs-symbol">p</span>)<br></code></pre></td></tr></table></figure><h1 id="7-Kotlin-接口"><a href="#7-Kotlin-接口" class="headerlink" title="7.Kotlin 接口"></a>7.Kotlin 接口</h1><p>Kotlin 接口与 Java 8 类似，使用 interface 关键字定义接口，允许方法有默认实现：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MyInterface</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bar</span><span class="hljs-params">()</span></span>    <span class="hljs-comment">// 未实现</span><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> &#123;  <span class="hljs-comment">//已实现</span><br>      <span class="hljs-comment">// 可选的方法体</span><br>      println(<span class="hljs-string">&quot;foo&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> : <span class="hljs-type">MyInterface1</span>,<span class="hljs-type">MyInterface2 &#123;</span></span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bar1</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">// 方法体</span><br>    &#125;<br>   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bar2</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">// 方法体</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kotlin</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>springboot整合graphql</title>
    <link href="/springboot%E6%95%B4%E5%90%88graphql/"/>
    <url>/springboot%E6%95%B4%E5%90%88graphql/</url>
    
    <content type="html"><![CDATA[<p>GraphQL是比REST更高效、强大和灵活的<strong>新一代API标准</strong>。详细的可以看官网<a href="https://graphql.cn/">GraphQL</a>。</p><p>下面介绍一个Spring boot整合graphql简单的例子。</p><span id="more"></span><ul><li><p>项目准备：相关依赖的引入：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">&lt;dependencies&gt;</span><br><span class="hljs-meta">&lt;!--web</span> <span class="hljs-string">--&gt;</span><br><span class="hljs-attr">&lt;dependency&gt;</span><br><span class="hljs-attr">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="hljs-attr">&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="hljs-attr">&lt;/dependency&gt;</span><br><span class="hljs-meta">&lt;!--lombok</span> <span class="hljs-string">--&gt;</span><br><span class="hljs-attr">&lt;dependency&gt;</span><br><span class="hljs-attr">&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="hljs-attr">&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="hljs-attr">&lt;optional&gt;true&lt;/optional&gt;</span><br><span class="hljs-attr">&lt;/dependency&gt;</span><br><span class="hljs-meta">&lt;!--graphql</span> <span class="hljs-string">--&gt;</span><br><span class="hljs-attr">&lt;dependency&gt;</span><br><span class="hljs-attr">&lt;groupId&gt;com.graphql-java-kickstart&lt;/groupId&gt;</span><br><span class="hljs-attr">&lt;artifactId&gt;graphql-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="hljs-attr">&lt;version&gt;11.0.0&lt;/version&gt;</span><br><span class="hljs-attr">&lt;/dependency&gt;</span><br><span class="hljs-meta">&lt;!--playground</span> <span class="hljs-string">--&gt;</span><br><span class="hljs-attr">&lt;dependency&gt;</span><br><span class="hljs-attr">&lt;groupId&gt;com.graphql-java-kickstart&lt;/groupId&gt;</span><br><span class="hljs-attr">&lt;artifactId&gt;playground-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="hljs-attr">&lt;version&gt;11.0.0&lt;/version&gt;</span><br><span class="hljs-attr">&lt;/dependency&gt;</span><br><span class="hljs-attr">&lt;/dependencies&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><ul><li><p>定义schema，分别为：</p><p><code>query.graphqls</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">type Query&#123;<br>  billingAccount(id: ID): BillingAccount<br>&#125;<br></code></pre></td></tr></table></figure><p><code>billingAccount.graphqls</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">type BillingAccount &#123;<br>  id: ID!<br>  name: String!<br>  currency: Currency<br>&#125;<br></code></pre></td></tr></table></figure><p><code>currency.graphqls</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Currency</span></span>&#123;<br>    RMB,<br>    USD<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义基础要操作的模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@Value</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BillingAccount</span> </span>&#123;<br>    UUID id;<br>    String name;<br>    Currency currency;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Currency</span> </span>&#123;<br>    RMB, USD<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义resolver</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BillingAccountResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GraphQLQueryResolver</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> BillingAccount <span class="hljs-title">billingAccount</span><span class="hljs-params">(UUID id)</span></span>&#123;<br>        log.info(<span class="hljs-string">&quot;receive billingAccount id is: &quot;</span>+ id);<br>        <span class="hljs-keyword">return</span> BillingAccount.builder()<br>                .id(id)<br>                .currency(Currency.RMB)<br>                .name(<span class="hljs-string">&quot;张三&quot;</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>效果图</p></li></ul><p><img src="/images/resolver.png" alt="img"></p><h4 id="mutation"><a href="#mutation" class="headerlink" title="mutation"></a>mutation</h4><ul><li>定义schema</li></ul><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">type</span> <span class="hljs-type">Mutation</span>&#123;<br>    createBillingAccount(input: <span class="hljs-type">CreateBillingAccountInput</span>): <span class="hljs-type">BillingAccount</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>定义input</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">input</span> CreateBillingAccountInput&#123;<br>    name: String<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>定义input 对应的model</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateBillingAccountInput</span> </span>&#123;<br>  String name;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>定义mutationResolver</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BillingAccountMutation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GraphQLMutationResolver</span> </span>&#123;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> BillingAccount <span class="hljs-title">createBillingAccount</span><span class="hljs-params">(CreateBillingAccountInput input)</span></span>&#123;<br><br>    <span class="hljs-keyword">return</span> BillingAccount.builder()<br>      .id(UUID.randomUUID())<br>      .currency(Currency.RMB)<br>      .name(input.getName())<br>      .build();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>效果图</p><p>!<img src="/images/mutation.png" alt="mutation"></p>]]></content>
    
    
    <categories>
      
      <category>Springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>graphql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>响应式编程</title>
    <link href="/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"/>
    <url>/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p><strong>1.响应式编程是什么？</strong></p><ul><li><p>响应式编程（<strong>reactive programming</strong>）是一种基于数据流和变化传递的声明式的编程范式</p><p>本来数据是我们自行处理的，后来我们把要处理的数据抽象出来（变成了数据流），然后通过<strong>API</strong>去处理数据流中的数据（是声明式的,如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">int</span> sum2 = IntStream.of(nums).parallel().sum();<br></code></pre></td></tr></table></figure></li></ul><p>​      将数组中的数据变成数据流，通过显式声明调用**.sum()**来处理数据流中的数据，得到最终的结果。</p><ul><li><p>响应式编程是关于非阻塞应用程序的，这些应用程序是异步的、事件驱动的，并且需要少量的线程来垂直伸缩(即在 JVM 中)，而不是水平伸缩(即通过集群)。</p><blockquote><p>工作太多，做不完时，水平伸缩就相当于加人，垂直伸缩相当于加班。</p></blockquote></li></ul><h3 id="2-响应式流（Reactive-Streams）-是什么"><a href="#2-响应式流（Reactive-Streams）-是什么" class="headerlink" title="2.响应式流（Reactive Streams） 是什么?"></a>2.响应式流（Reactive Streams） 是什么?</h3><span id="more"></span><ul><li><p>响应式流是JDK9引入的，基于发布-订阅者模式的一套数据处理的机制。</p></li><li><p>响应式流从2013年开始，作为提供非阻塞背压的异步流处理标准的倡议。 它旨在解决处理元素流的问题——如何将元素流从发布者传递到订阅者，而不需要发布者阻塞，或订阅者有无限制的缓冲区或丢弃。</p></li></ul><blockquote><p>背压：说白了就是一种反馈，发布者和订阅者之间的一种互动</p></blockquote><blockquote><p>之前的老模式，订阅者很被动，发布者给订阅者多少他就消费多少，不能多也不能多少。</p><p>Reactive Streams就可以做到发布者和订阅者之间可以进行交流，订阅者可以告诉发布者我需要多少数据，订阅者处理完了，可以再向发布者要，没处理完就不要给我。</p><p>起到了一种调节流量的作用，不会导致发布者数据太多，订阅者处理不完浪费，或者直接把订阅者压垮的场景。</p></blockquote><h3 id="2-Spring-Webflux-是什么？"><a href="#2-Spring-Webflux-是什么？" class="headerlink" title="2. Spring Webflux 是什么？"></a>2. Spring Webflux 是什么？</h3><p>Spring WebFlux是<a href="https://rumenz.com/java-topic/spring-mvc-tutorial/index.html">Spring MVC</a>并行版本，并支持完全无阻塞的反应流的web框架。 它支持背压概念，可以处理大量的并发连接，并使用**<a href="https://netty.io/">Netty</a>**作为内置服务器来运行响应式应用程序。 </p><h3 id="3-Spring-Webflux-和Spring-mvc-的关系"><a href="#3-Spring-Webflux-和Spring-mvc-的关系" class="headerlink" title="3.Spring Webflux 和Spring mvc 的关系"></a>3.Spring Webflux 和Spring mvc 的关系</h3><img src="https://spring.io/images/diagram-reactive-1290533f3f01ec9c57baf2cc9ea9fa2f.svg" style="zoom: 25%;" /><p>Spring MVC</p><ul><li>构建于 Servlet API 之上</li><li>同步阻塞 I&#x2F;O 模型, 认为应用会阻塞当前线程，所以一个 Request 对应一个 Thread，需要有一个含有大量线程的线程池</li></ul><p>Spring WebFlux</p><ul><li>构建于 Reactive Streams Adapters 之上</li><li>异步非阻塞 I&#x2F;O 模型，认为应用不会阻塞当前线程，所以只是需要一个包含少数固定线程数的线程池 (event loop workers) 来处理请求</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java8新特性之Stream流</title>
    <link href="/Java8%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8BStream%E6%B5%81/"/>
    <url>/Java8%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8BStream%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h3 id="Java8新特性之Stream流"><a href="#Java8新特性之Stream流" class="headerlink" title="Java8新特性之Stream流"></a>Java8新特性之Stream流</h3><h3 id="1-什么是Stream？"><a href="#1-什么是Stream？" class="headerlink" title="1.什么是Stream？"></a>1.什么是Stream？</h3><p>Java 8 API添加了一个新的抽象称为流Stream，可以让你以一种声明的方式处理数据。通过声明性方式，能够对集合中的每个元素进行一系列并行或串行的流水线操作。例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamDemo1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] numbers = &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;;<br>        <span class="hljs-keyword">int</span> num2 = IntStream.of(numbers).sum();<br>        System.out.println(num2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-创建流的几种方式"><a href="#2-创建流的几种方式" class="headerlink" title="2.创建流的几种方式"></a>2.创建流的几种方式</h3><span id="more"></span><h4 id="2-1-使用集合"><a href="#2-1-使用集合" class="headerlink" title="2.1 使用集合"></a>2.1 使用集合</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">ArrayList arrayList = <span class="hljs-keyword">new</span> ArrayList();<br>arrayList.stream();<br>arrayList.parallelStream();  <br></code></pre></td></tr></table></figure><h4 id="2-2-使用数组"><a href="#2-2-使用数组" class="headerlink" title="2.2 使用数组"></a>2.2 使用数组</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Arrays.stream(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[]&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;);<br></code></pre></td></tr></table></figure><h4 id="2-3-数字Stream"><a href="#2-3-数字Stream" class="headerlink" title="2.3 数字Stream"></a>2.3 数字Stream</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">IntStream.of(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br>IntStream.rangeClosed(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>);<br></code></pre></td></tr></table></figure><h4 id="2-4-使用Stream-generate"><a href="#2-4-使用Stream-generate" class="headerlink" title="2.4 使用Stream.generate()"></a>2.4 使用Stream.generate()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Stream.generate(()-&gt; <span class="hljs-string">&quot;stream&quot;</span>).limit(<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure><h3 id="3-常用方法"><a href="#3-常用方法" class="headerlink" title="3. 常用方法"></a>3. 常用方法</h3><p>流模型的操作很丰富，这里介绍一些常用的API。这些方法可以被分成两种：</p><blockquote><ul><li>延迟方法：返回值任然是Stream接口自身类型的方法，因此支持链式调用(除了终结方法外，其他都是方法均为延迟方法)</li><li>终结方法：返回值类型不再是Stream接口自身类型的方法。</li></ul></blockquote><h4 id="3-1-延迟方法"><a href="#3-1-延迟方法" class="headerlink" title="3.1 延迟方法"></a>3.1 延迟方法</h4><h5 id="1-filter"><a href="#1-filter" class="headerlink" title="1. filter"></a>1. filter</h5><p>可以通过<code>filter</code>方法将一个流转换成另一个子集流。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Stream.of(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>).filter(i -&gt; i&gt;<span class="hljs-number">2</span>).forEach(System.out::println);<br></code></pre></td></tr></table></figure><h5 id="2-peek"><a href="#2-peek" class="headerlink" title="2.peek"></a>2.peek</h5><p>用于debug，foreach是最终操作</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Stream</span>.</span></span><span class="hljs-keyword">of</span>(<span class="hljs-string">&quot;张三&quot;</span>,<span class="hljs-string">&quot;李四&quot;</span>,<span class="hljs-string">&quot;王麻子&quot;</span>).peek(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out::println).<span class="hljs-keyword">for</span><span class="hljs-constructor">Each(System.<span class="hljs-params">out</span>::<span class="hljs-params">println</span>)</span>;<br></code></pre></td></tr></table></figure><h5 id="3-map"><a href="#3-map" class="headerlink" title="3.map"></a>3.map</h5><p>将流中的元素映射到另一个流中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Stream.of(<span class="hljs-string">&quot;张三&quot;</span>,<span class="hljs-string">&quot;李四&quot;</span>,<span class="hljs-string">&quot;王麻子&quot;</span>).map(String::length).forEach(System.out::println);<br></code></pre></td></tr></table></figure><h5 id="4-limit"><a href="#4-limit" class="headerlink" title="4.limit"></a>4.limit</h5><p>对流进行截取，只取用前n个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Stream.of(<span class="hljs-string">&quot;张三&quot;</span>,<span class="hljs-string">&quot;李四&quot;</span>,<span class="hljs-string">&quot;王麻子&quot;</span>).limit(<span class="hljs-number">2</span>).forEach(System.out::println);<br></code></pre></td></tr></table></figure><h5 id="5-skip"><a href="#5-skip" class="headerlink" title="5.skip"></a>5.skip</h5><p>跳过前几个</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Stream</span>.</span></span><span class="hljs-keyword">of</span>(<span class="hljs-string">&quot;张三&quot;</span>,<span class="hljs-string">&quot;李四&quot;</span>,<span class="hljs-string">&quot;王麻子&quot;</span>).skip(<span class="hljs-number">2</span>).<span class="hljs-keyword">for</span><span class="hljs-constructor">Each(System.<span class="hljs-params">out</span>::<span class="hljs-params">println</span>)</span>;<br></code></pre></td></tr></table></figure><h4 id="3-2-终止方法"><a href="#3-2-终止方法" class="headerlink" title="3.2 终止方法"></a>3.2 终止方法</h4><h5 id="1-forEach"><a href="#1-forEach" class="headerlink" title="1.forEach"></a>1.forEach</h5><p>迭代</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Stream.of(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>).forEach(System.out::println);<br></code></pre></td></tr></table></figure><h5 id="2-count"><a href="#2-count" class="headerlink" title="2.count"></a>2.count</h5><p>计算个数</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Stream</span>.</span></span><span class="hljs-keyword">of</span>(<span class="hljs-string">&quot;张三&quot;</span>,<span class="hljs-string">&quot;李四&quot;</span>,<span class="hljs-string">&quot;王麻子&quot;</span>).count<span class="hljs-literal">()</span>);<br></code></pre></td></tr></table></figure><h5 id="3-collect"><a href="#3-collect" class="headerlink" title="3.collect"></a>3.collect</h5><p>收集到list</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; list = Stream.of(str.split(<span class="hljs-string">&quot; &quot;</span>)).collect(Collectors.toList());<br>System.out.println(<span class="hljs-string">&quot;收集到list:&quot;</span>+list);<br></code></pre></td></tr></table></figure><h5 id="4-reduce"><a href="#4-reduce" class="headerlink" title="4.reduce"></a>4.reduce</h5><p>从Stream中生成一个值</p><ul><li>使用reduce拼接字符串</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Optional&lt;String&gt; newStr = Stream.of(str.split(<span class="hljs-string">&quot;&quot;</span>)).reduce((str1, str2) -&gt; str1 + <span class="hljs-string">&quot;-&quot;</span> + str2);<br>System.out.println(newStr.orElse(<span class="hljs-string">&quot;&quot;</span>));<br></code></pre></td></tr></table></figure><ul><li>使用reduce拼接字符串-+ 带有初始值</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">String newStr2 = Stream.of(str.split(<span class="hljs-string">&quot;&quot;</span>)).reduce(<span class="hljs-string">&quot;&quot;</span>, (str1, str2) -&gt; str1 + <span class="hljs-string">&quot;-&quot;</span> + str2);<br>System.out.println(newStr2);<br></code></pre></td></tr></table></figure><ul><li>使用reduce计算所有单词总长度</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Optional&lt;Integer&gt; length = Stream.of(str.split(<span class="hljs-string">&quot; &quot;</span>)).map(s -&gt; s.length()).reduce((len1, len2) -&gt; len1 + len2);<br>System.out.println(<span class="hljs-string">&quot;length:&quot;</span> + length.get());<br></code></pre></td></tr></table></figure><h5 id="5-max"><a href="#5-max" class="headerlink" title="5.max"></a>5.max</h5><p>求最大值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Optional&lt;String&gt; maxValue = Stream.of(str.split(<span class="hljs-string">&quot; &quot;</span>)).max((str1, str2) -&gt; str1.length() - str2.length());<br>System.out.println(<span class="hljs-string">&quot;maxValue:&quot;</span> + maxValue.get());<br></code></pre></td></tr></table></figure><h5 id="6-findFirst"><a href="#6-findFirst" class="headerlink" title="6.findFirst"></a>6.findFirst</h5><p>找第一个元素</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Optional&lt;String&gt; firstValue = Stream.of(str.split(<span class="hljs-string">&quot; &quot;</span>)).findFirst();<br>System.out.println(<span class="hljs-string">&quot;firstValue:&quot;</span> + firstValue.get());<br></code></pre></td></tr></table></figure><h3 id="4-惰性求值"><a href="#4-惰性求值" class="headerlink" title="4. 惰性求值"></a>4. 惰性求值</h3><p>惰性求值：终结没有调用的情况下，延迟方法不会执行。例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.stream.IntStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamDemo1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] numbers = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;;<br>        <span class="hljs-keyword">int</span> num2 = IntStream.of(numbers).map(StreamDemo1::doubleNum).sum();<br>        System.out.println(num2);<br>      <br>      <span class="hljs-comment">// 这里没有执行中间操作</span><br>        IntStream.of(numbers).map(StreamDemo1::doubleNum);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doubleNum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行了乘以2&quot;</span>);<br>        <span class="hljs-keyword">return</span> i * <span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">Task :StreamDemo1.main()</span><br>执行了乘以2<br>执行了乘以2<br>执行了乘以2<br>12<br></code></pre></td></tr></table></figure><p>中间操作就是：返回stream的操作，如：map</p><p>终止操作就是：sum()</p><p>从输出结果可以看出doubleNum执行了3次</p><h3 id="5-并行流"><a href="#5-并行流" class="headerlink" title="5.并行流"></a>5.并行流</h3><h4 id="5-1-创建一个并行流"><a href="#5-1-创建一个并行流" class="headerlink" title="5.1 创建一个并行流"></a>5.1 创建一个并行流</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParallelStream</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        IntStream.range(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>).parallel().peek(ParallelStream::debugger).count();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">debugger</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;debugger&quot;</span>+i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出：</p><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">Task :ParallelStream.main()</span><br>debugger90<br>debugger81<br>debugger82<br>debugger83<br>debugger84<br>debugger85<br>debugger86<br>debugger65<br>debugger66<br>debugger67<br><span class="hljs-meta">...</span><br></code></pre></td></tr></table></figure><ul><li>多次调用parallel &#x2F; sequential，以最后一个为准，如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParallelStream</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        IntStream.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>                .parallel().peek(ParallelStream::debugger)<br>                .sequential().peek(ParallelStream::debugger2)<br>                .count();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">debugger2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>        System.err.println(<span class="hljs-string">&quot;debugger2: &quot;</span> + i);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">debugger</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;debugger1: &quot;</span> + i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-并行流使用自己定义的线程池"><a href="#5-2-并行流使用自己定义的线程池" class="headerlink" title="5.2 并行流使用自己定义的线程池"></a>5.2 并行流使用自己定义的线程池</h4><blockquote><p>原因：避免使用默认线程池，防止任务被阻塞</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.ForkJoinPool;<br><span class="hljs-keyword">import</span> java.util.stream.IntStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParallelStream</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ForkJoinPool forkJoinPool = <span class="hljs-keyword">new</span> ForkJoinPool(<span class="hljs-number">20</span>);<br>        forkJoinPool.submit(() -&gt; IntStream.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>                .parallel().peek(ParallelStream::debugger)<br>                .count());<br>        forkJoinPool.shutdown();<br><br>        <span class="hljs-keyword">synchronized</span> (forkJoinPool) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                forkJoinPool.wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">debugger</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;debugger1: &quot;</span> + i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-Stream-流的运行机制"><a href="#6-Stream-流的运行机制" class="headerlink" title="6. Stream 流的运行机制"></a>6. Stream 流的运行机制</h3><p>所有的操作都是链式调用，每个操作只会对每个元素操作一次；（是通过维护一个链表实现的。）具体实现：</p><blockquote><ul><li>每个中间操作都会返回一个新的流，每个流里面都会有一个SourceStage属性，所有流的SourceStage属性都指向同一个地方head【就是原始流的头部】；</li><li>如果一个中间操作之后还有中间操作，那么这个中间操作对应的流中nextStage属性就会执行下一个中间操作对应的流，否则就是null</li></ul></blockquote><p>注：parallel &#x2F; sequential也是中间操作，但是他们呢不创建流，只是修改head 里的并行标志：parallel</p>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>stream流</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java8的新特性之lambda表达式</title>
    <link href="/Java8%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8Blambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <url>/Java8%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8Blambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h3 id="1-函数接口"><a href="#1-函数接口" class="headerlink" title="1.函数接口"></a>1.函数接口</h3><p>函数接口（<code>@FunctionalInterface</code>）需要满足两个条件：</p><ul><li>类型是接口</li><li>有且只有一个抽象方法</li></ul><p>例如：Runnable接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实这也是要求我们接口的设计尽量小，符合单一责任制，一个接口只做一个事，这样使用lambda就会比较方便。</p><h3 id="2-lambda表达式是个啥？"><a href="#2-lambda表达式是个啥？" class="headerlink" title="2. lambda表达式是个啥？"></a>2. lambda表达式是个啥？</h3><p><strong>lambda表达式</strong>是<strong>Java8</strong>的新特性，它就是就是一个匿名函数，箭头左边是函数的参数，右边是函数的执行体。</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>      <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>          <span class="hljs-meta">@Override</span><br>          <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>              System.out.println(<span class="hljs-string">&quot;正常创建一个线程&quot;</span>);<br>          &#125;<br>      &#125;).start();<br>      # 实际上是返回了一个实现了Runnable的实例，箭头左边是参数，右边是方法体<br>      <span class="hljs-keyword">new</span> Thread(()-&gt; System.out.println(<span class="hljs-string">&quot;Lambda创建一个线程&quot;</span>)).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上面的代码为例，Runnable接口仅有一个run方法，并且该方法没有参数，所以编译器可以自动推断出箭头后的内容为run方法的方法体。</p><p>如果Runnable接口中含有多个方法，编译器将无法编译lambda表达式，可以看出，lambda表达式是根据编译器的隐式推断来简化代码的。所以，<strong>lambda表达式需要函数式接口的支持。</strong></p><p><strong>实例:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MoneyFormat</span></span>&#123;<br>    <span class="hljs-function">String <span class="hljs-title">format</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoneyDemo</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> money;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MoneyDemo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> money)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.money = money;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printMoney</span><span class="hljs-params">(MoneyFormat moneyFormat)</span></span>&#123;<br>        System.out.println(String.format(<span class="hljs-string">&quot;金额数为：&quot;</span> + moneyFormat.format(<span class="hljs-keyword">this</span>.money)));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MoneyDemo moneyDemo = <span class="hljs-keyword">new</span> MoneyDemo(<span class="hljs-number">999</span>);<br>        moneyDemo.printMoney(i -&gt; <span class="hljs-keyword">new</span> DecimalFormat(<span class="hljs-string">&quot;#,##&quot;</span>).format(i));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>由上可见，我们不关心接口的名字是什么，只关心输入是int，输出 是string，因此上面代码可优化为：</p><p>删除interface MoneyFormat，使用jdk8带的函数接口Function&lt;Integer,String&gt;替代</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoneyDemo</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> money;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MoneyDemo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> money)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.money = money;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printMoney</span><span class="hljs-params">(Function&lt;Integer,String&gt; moneyFormat)</span></span>&#123;<br>        System.out.println(String.format(<span class="hljs-string">&quot;金额数为：&quot;</span> + moneyFormat.apply(<span class="hljs-keyword">this</span>.money)));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MoneyDemo moneyDemo = <span class="hljs-keyword">new</span> MoneyDemo(<span class="hljs-number">999</span>);<br>        moneyDemo.printMoney(i -&gt; <span class="hljs-keyword">new</span> DecimalFormat(<span class="hljs-string">&quot;#,##&quot;</span>).format(i));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="3-lambda表达式常用的函数式接口"><a href="#3-lambda表达式常用的函数式接口" class="headerlink" title="3. lambda表达式常用的函数式接口"></a>3. lambda表达式常用的函数式接口</h2><p>主要是分布在java.util.function包中，下面只简单列举2种：</p><h4 id="2-1-Supplier接口"><a href="#2-1-Supplier接口" class="headerlink" title="2.1 Supplier接口"></a>2.1 Supplier接口</h4><ul><li><code>java.util.function.Supplier&lt;T&gt;</code> 接口仅含有一个无参方法,<code>T get()</code></li><li><code>Supplier&lt;T&gt;</code> 接口是生产型接口,接口泛型指定什么类型,就返回什么泛型</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.function.Supplier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SupplierDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">supplyName</span><span class="hljs-params">(Supplier&lt;String&gt; supplier)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> supplier.get();<br>    &#125;<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SupplierDemo supplierDemo = <span class="hljs-keyword">new</span> SupplierDemo();<br>        String name = supplierDemo.supplyName(() -&gt; <span class="hljs-string">&quot;张三&quot;</span>);<br>        System.out.println(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-Consumer接口"><a href="#3-2-Consumer接口" class="headerlink" title="3.2 Consumer接口"></a>3.2 Consumer接口</h3><ul><li><code>java.util.function.Consumer接口&lt;T&gt;</code> 接口仅含有一个有参方法,<code>void accept(T t)</code></li><li><code>Consumer接口&lt;T&gt;</code> 接口是消费型接口,接口泛型制定什么类型,就接受什么泛型</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.function.Consumer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerDemo</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printName</span><span class="hljs-params">(String name, Consumer&lt;String&gt; consumer)</span> </span>&#123;<br>        consumer.accept(name);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ConsumerDemo consumerDemo = <span class="hljs-keyword">new</span> ConsumerDemo();<br>        consumerDemo.printName(<span class="hljs-string">&quot;张三&quot;</span>, (String name) -&gt; System.out.println(<span class="hljs-string">&quot;姓名为 : &quot;</span> + name));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>lambda表达式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java8的新特性之方法引用</title>
    <link href="/Java8%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8B%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8/"/>
    <url>/Java8%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7%E4%B9%8B%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="1-方法引用是什么？"><a href="#1-方法引用是什么？" class="headerlink" title="1.方法引用是什么？"></a>1.方法引用是什么？</h3><blockquote><p>Java8的新特性之二：方法引用。方法引用其实也离不开Lambda表达式。</p></blockquote><ul><li><p>方法引用通过方法的名字来指向一个方法。</p></li><li><p>方法引用可以使语言的构造更紧凑简洁，减少冗余代码。</p></li><li><p>方法引用使用一对冒号 <strong>::</strong> 。</p></li></ul><h2 id="2、方法引用的分类"><a href="#2、方法引用的分类" class="headerlink" title="2、方法引用的分类"></a>2、方法引用的分类</h2><p>下面，我们在 Car 类中定义了 4 个方法作为例子来区分 Java 中 4 种不同方法的引用。</p><span id="more"></span><table><thead><tr><th align="center">类型</th><th>语法</th><th>对应lambda表达式</th></tr></thead><tbody><tr><td align="center">静态方法引用</td><td>类名::staticMethod</td><td>(args) -&gt; 类名.staticMethod(args)</td></tr><tr><td align="center">实例方法引用</td><td>instance::instance_Method</td><td>(args) -&gt; instance.instance_Method(args)</td></tr><tr><td align="center">对象方法引用</td><td>类名::instance_Method</td><td>(inst,args) -&gt; 类名.instance_Method(args)</td></tr><tr><td align="center">构建方法引用</td><td>类名::new</td><td>(args) -&gt; new 类名(args)</td></tr></tbody></table><h3 id="3、方法引用举例"><a href="#3、方法引用举例" class="headerlink" title="3、方法引用举例"></a>3、方法引用举例</h3><h4 id="3-1-静态方法引用"><a href="#3-1-静态方法引用" class="headerlink" title="3.1 静态方法引用"></a>3.1 静态方法引用</h4><ul><li><p>实例1:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>  <span class="hljs-comment">//Consumer&lt;String&gt; consumer = s -&gt; System.out.println(s); 输出的参数和输入的参数一致，可以缩写</span><br>    Consumer&lt;String&gt; consumer = System.out::println;<br>    consumer.accept(<span class="hljs-string">&quot;接受的数据&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p> 实例中我们将 System.out::println 方法作为静态方法来引用。</p></li><li><p>实例2:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodReferenceDemo</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> String name = <span class="hljs-string">&quot;啸天犬&quot;</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bark</span><span class="hljs-params">(Dog dog)</span> </span>&#123;<br>            System.out.println(dog + <span class="hljs-string">&quot;狗叫了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;<br>        &#125;<br>    &#125;<br>     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>       <span class="hljs-comment">//静态方法</span><br>        Dog dog = <span class="hljs-keyword">new</span> Dog();<br>        Consumer&lt;Dog&gt; consumer2 = Dog::bark;<br>        consumer2.accept(dog);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="3-2-实例方法引用"><a href="#3-2-实例方法引用" class="headerlink" title="3.2 实例方法引用"></a>3.2 实例方法引用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.function.Function;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodReferenceDemo</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> food_weight = <span class="hljs-number">10</span>;<br>        <br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">eat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> weight)</span> </span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;小狗吃了&quot;</span> + weight + <span class="hljs-string">&quot;斤狗粮&quot;</span>);<br>            <span class="hljs-keyword">this</span>.food_weight -= weight;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.food_weight;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Dog dog = <span class="hljs-keyword">new</span> Dog();<br>        <span class="hljs-comment">// Function&lt;Integer, Integer&gt; function = dog::eat;</span><br>        <span class="hljs-comment">// UnaryOperator&lt;Integer&gt; function = dog::eat;</span><br>        <span class="hljs-comment">// int weight = function.apply(3);</span><br>        IntUnaryOperator function = dog::eat;<br>        <span class="hljs-keyword">int</span> weight = function.applyAsInt(<span class="hljs-number">3</span>);<br>        System.out.println(<span class="hljs-string">&quot;还剩余&quot;</span> + weight + <span class="hljs-string">&quot;斤狗粮&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的eat方法，页可改写为<code>public int eat(Dog this, int weight) </code>编译也不会报错。因此&#x3D;》</p><blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">JDk会默认把当前实例传入到非静态方法，参数名为<span class="hljs-keyword">this</span>，位置是第一个<br></code></pre></td></tr></table></figure></blockquote><h4 id="3-3-构建方法引用"><a href="#3-3-构建方法引用" class="headerlink" title="3.3 构建方法引用"></a>3.3 构建方法引用</h4><ul><li>无参数的构造方法引用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.function.Supplier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodReferenceDemo</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> String name = <span class="hljs-string">&quot;啸天犬&quot;</span>;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Supplier&lt;Dog&gt; supplier = Dog::<span class="hljs-keyword">new</span>;<br>        System.out.println(supplier.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>有参数的构造方法的引用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.function.Function;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodReferenceDemo</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> String name = <span class="hljs-string">&quot;啸天犬&quot;</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Dog</span><span class="hljs-params">(String name)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.name = name;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Function&lt;String,Dog&gt; function2 =  Dog::<span class="hljs-keyword">new</span>;;<br>        System.out.println(function2.apply(<span class="hljs-string">&quot;小杂毛&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>方法引用</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ElasticSearch简介</title>
    <link href="/ElasticSearch%E7%AE%80%E4%BB%8B/"/>
    <url>/ElasticSearch%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="ElasticSearch简介"><a href="#ElasticSearch简介" class="headerlink" title="ElasticSearch简介"></a>ElasticSearch简介</h1><h2 id="Es是什么？"><a href="#Es是什么？" class="headerlink" title="Es是什么？"></a>Es是什么？</h2><ul><li>Elasticsearch是用Java开发并且是当前最流行的开源的企业级搜索引擎。</li><li>能够达到实时搜索，稳定，可靠，快速，安装使用方便。</li><li>客户端支持Java、.NET（C#）、PHP、Python、Ruby等多种语言。</li></ul><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>关键词搜索。</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224603261.png" alt="image-20230228224603261"></p><blockquote><p>从上面的搜索结果，可以看出不是根据模糊匹配去进行搜索的</p></blockquote><h2 id="ElasticSearch与Lucene的关系"><a href="#ElasticSearch与Lucene的关系" class="headerlink" title="ElasticSearch与Lucene的关系"></a>ElasticSearch与Lucene的关系</h2><ul><li>Lucene可以被认为是迄今为止最先进、性能最好的、功能最全的搜索引擎库（框架）</li></ul><h3 id="Lucene缺点："><a href="#Lucene缺点：" class="headerlink" title="Lucene缺点："></a>Lucene缺点：</h3><ul><li>想要使用Lucene，必须使用Java来作为开发语言并将其直接集成到你的应用中。</li><li>Lucene的配置及使用非常复杂，你需要深入了解检索的相关知识来理解它是如何工作的。</li><li>使用非常复杂-创建索引和搜索索引代码繁杂。</li><li>不支持集群环境-索引数据不同步（不支持大型项目）</li><li>索引数据如果太多就不行，索引库和应用所在同一个服务器,共同占用硬盘.共用空间少.</li></ul><p><strong>上述Lucene框架中的缺点,ES全部都能解决.</strong></p><h2 id="哪些公司在使用Elasticsearch"><a href="#哪些公司在使用Elasticsearch" class="headerlink" title="哪些公司在使用Elasticsearch"></a>哪些公司在使用Elasticsearch</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224612979.png" alt="image-20230228224612979"></p><h2 id="ES-vs-Solr比较"><a href="#ES-vs-Solr比较" class="headerlink" title="ES vs Solr比较"></a>ES vs Solr比较</h2><ul><li>当单纯的对已有数据进行搜索时，Solr更快。</li><li>当实时建立索引时,Solr会产生io阻塞，查询性能较差,Elasticsearch具有明显的优势。</li><li>Solr利用Zookeeper进行分布式管理，而Elasticsearch自身带有分布式协调管理功能。</li><li>Solr支持更多格式的数据，比如JSON、XML、CSV，而Elasticsearch仅支持json文件格式。</li><li>Solr在传统的搜索应用中表现好于Elasticsearch，但在处理实时搜索应用时效率明显低于Elasticsearch。</li><li>Solr是传统搜索应用的有力解决方案，但Elasticsearch更适用于新兴的实时搜索应用。</li></ul><h2 id="ESvs关系型数据库"><a href="#ESvs关系型数据库" class="headerlink" title="ESvs关系型数据库"></a>ESvs关系型数据库</h2><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224621969.png" alt="image-20230228224621969"></p><h2 id="Lucene全文检索框架"><a href="#Lucene全文检索框架" class="headerlink" title="Lucene全文检索框架"></a>Lucene全文检索框架</h2><h3 id="什么是全文检索"><a href="#什么是全文检索" class="headerlink" title="什么是全文检索"></a>什么是全文检索</h3><ul><li>全文检索是指：通过一个程序扫描文本中的每一个单词，针对单词建立索引，并保存该单词在文本中的位置、以及出现的次数。</li><li>用户查询时，通过之前建立好的索引来查询，将索引中单词对应的文本位置、出现的次数返回给用户，因为有了具体文本的位置，所以就可以将具体内容读取出来了</li></ul><h3 id="词原理之倒排索引"><a href="#词原理之倒排索引" class="headerlink" title="词原理之倒排索引"></a>词原理之倒排索引</h3><p>对于关系型数据库mysql来说，<strong>普通的索引结构就是“id-&gt;题目-&gt;内容”，</strong>在我们搜索的时候，如果我们知道id或者题目<strong>，那么检索效率是很高效的，因为“id”、“题目”是很方便创建索引的。</strong></p><p>那么<strong>倒排序索引</strong>的结构是怎样的呢？简单来讲<strong>就是“以内容的关键词”建立索引，</strong>映射关系为<strong>“内容的关键词-&gt;ID”。</strong>这样的话，我们只需要在“关键词”中进行检索</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228224640464.png" alt="image-20230228224640464"></p><blockquote><p>对于上面的场景，输入为hello，会根据hello定位到此时数据的id为1和2，进而查出对应的数据。</p></blockquote><h2 id="Elasticsearch中的核心概念"><a href="#Elasticsearch中的核心概念" class="headerlink" title="Elasticsearch中的核心概念"></a>Elasticsearch中的核心概念</h2><h3 id="索引index"><a href="#索引index" class="headerlink" title="索引index"></a>索引index</h3><ul><li>一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引</li><li>一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字</li></ul><h3 id="映射mapping"><a href="#映射mapping" class="headerlink" title="映射mapping"></a>映射mapping</h3><ul><li><p>ElasticSearch中的映射（Mapping）用来定义一个文档</p></li><li><p>mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分词器、是否被索引等等，这些都是映射里面可以设置的</p></li></ul><h3 id="字段Field"><a href="#字段Field" class="headerlink" title="字段Field"></a>字段Field</h3><ul><li>相当于是数据表的字段|列</li></ul><h3 id="字段类型Type"><a href="#字段类型Type" class="headerlink" title="字段类型Type"></a>字段类型Type</h3><p>每一个字段都应该有一个对应的类型，例如：Text、Keyword、Byte等</p><h3 id="文档document"><a href="#文档document" class="headerlink" title="文档document"></a>文档document</h3><p>一个文档是一个可被索引的基础信息单元，类似一条记录。文档以JSON（JavascriptObjectNotation）格式来表示；</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
    
    
    <categories>
      
      <category>ElasticSearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Oauth2</title>
    <link href="/oauth2/"/>
    <url>/oauth2/</url>
    
    <content type="html"><![CDATA[<hr><h1 id="oauth2-0"><a href="#oauth2-0" class="headerlink" title="oauth2.0"></a>oauth2.0</h1><h2 id="一-oauth2-0-产生"><a href="#一-oauth2-0-产生" class="headerlink" title="一. oauth2.0 产生"></a>一. oauth2.0 产生</h2><ol><li>传统方式：用户和第三方共享密码<ul><li>不安全。未来可能会持久访问资源，第三方存储用户密码不安全，因为他可以访问用户的所有资源</li><li>改密码的话，第三方会失效</li></ul></li></ol><h2 id="二-oauth2-0是什么？"><a href="#二-oauth2-0是什么？" class="headerlink" title="二. oauth2.0是什么？"></a>二. oauth2.0是什么？</h2><blockquote><ul><li><p>oauth2.0 是一种授权方式，使第三方可以获得对用户资源的访问</p></li><li><p>他的核心就是：向第三方应用颁发令牌</p></li><li><p>不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：客户端 ID（client ID）和客户端密钥（client secret）</p></li></ul></blockquote><h2 id="三-OAuth-2-0-规定了四种获得令牌的流程"><a href="#三-OAuth-2-0-规定了四种获得令牌的流程" class="headerlink" title="三.OAuth 2.0 规定了四种获得令牌的流程"></a>三.OAuth 2.0 规定了四种获得令牌的流程</h2><span id="more"></span><h3 id="3-1-授权码模式"><a href="#3-1-授权码模式" class="headerlink" title="3.1 授权码模式"></a>3.1 授权码模式</h3><p><strong>第三方应用先申请一个授权码，然后再用该码获取令牌。</strong></p><ol><li><p>第一步，A 网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">https:<span class="hljs-comment">//b.com/oauth/authorize?</span><br>  response_type=code&amp;                        <br>  client_id=CLIENT_ID&amp;<br>  redirect_uri=CALLBACK_URL&amp;<br>  scope=read<br></code></pre></td></tr></table></figure><ul><li>response_type表示要求返回授权码</li><li>client_id让B网站知道是谁在请求</li><li>redirect_uri 是B网站接受或处理后跳转的URL</li><li>scope 表示授权的范围，这里是只读</li></ul></li><li><p>第二步，此时B网站会询问用户是否给予A网站授权，用户表示同意，这时B网站就会跳转到上一步<code>redirect_uri</code> 中的地址（也就是我们常说的callback地址），同时返回一个授权码，如下面的地址，其中，<code>code</code>参数就是授权码</p></li></ol><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">https:</span><span class="hljs-comment">//a.com/callback?code=AUTHORIZATION_CODE</span><br></code></pre></td></tr></table></figure><ol start="3"><li>第三步，A网站拿到授权码后，就可以根据该授权码，在后端向B网站请求<strong>令牌</strong></li></ol><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">https</span>:<span class="hljs-string">//b.com/oauth/token?</span><br> <span class="hljs-attr">client_id</span>=<span class="hljs-string">CLIENT_ID&amp;</span><br> <span class="hljs-attr">client_secret</span>=<span class="hljs-string">CLIENT_SECRET&amp;</span><br> <span class="hljs-attr">grant_type</span>=<span class="hljs-string">authorization_code&amp;</span><br> <span class="hljs-attr">code</span>=<span class="hljs-string">AUTHORIZATION_CODE&amp;</span><br> <span class="hljs-attr">redirect_uri</span>=<span class="hljs-string">CALLBACK_URL</span><br></code></pre></td></tr></table></figure><ul><li><p><code>client_id</code>参数和<code>client_secret</code>参数用来让 B 确认 A 的身份（<code>client_secret</code>参数是保密的，因此只能在后端发请求）</p></li><li><p><code>grant_type</code>参数的值是<code>AUTHORIZATION_CODE</code>，表示采用的授权方式是授权码</p></li><li><p><code>code</code>参数是上一步拿到的授权码</p></li><li><p><code>redirect_uri</code>参数是令牌颁发后的回调网址。</p></li></ul><ol start="4"><li><p>第四步，B 网站收到请求以后，就会颁发令牌。具体做法是向<code>redirect_uri</code>指定的网址，发送一段 JSON 数据。</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nim">&#123;    <br>  <span class="hljs-string">&quot;access_token&quot;</span>:<span class="hljs-string">&quot;ACCESS_TOKEN&quot;</span>,<br>  <span class="hljs-string">&quot;token_type&quot;</span>:<span class="hljs-string">&quot;bearer&quot;</span>,<br>  <span class="hljs-string">&quot;expires_in&quot;</span>:<span class="hljs-number">2592000</span>,<br>  <span class="hljs-string">&quot;refresh_token&quot;</span>:<span class="hljs-string">&quot;REFRESH_TOKEN&quot;</span>,<br>  <span class="hljs-string">&quot;scope&quot;</span>:<span class="hljs-string">&quot;read&quot;</span>,<br>  <span class="hljs-string">&quot;uid&quot;</span>:<span class="hljs-number">100101</span>,<br>  <span class="hljs-string">&quot;info&quot;</span>:<span class="hljs-meta">&#123;...&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>上面 JSON 数据中，<code>access_token</code>字段就是令牌，A 网站在后端拿到了。</p></li></ol><h4 id="3-2-隐藏式模式（适合没有后台的第三方）"><a href="#3-2-隐藏式模式（适合没有后台的第三方）" class="headerlink" title="3.2 隐藏式模式（适合没有后台的第三方）"></a>3.2 隐藏式模式（适合没有后台的第三方）</h4><p>第一步，A 网站提供一个链接，要求用户跳转到 B 网站，授权用户数据给 A 网站使用。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">https</span>:<span class="hljs-string">//b.com/oauth/authorize?</span><br>  <span class="hljs-attr">response_type</span>=<span class="hljs-string">token&amp;</span><br>  <span class="hljs-attr">client_id</span>=<span class="hljs-string">CLIENT_ID&amp;</span><br>  <span class="hljs-attr">redirect_uri</span>=<span class="hljs-string">CALLBACK_URL&amp;</span><br>  <span class="hljs-attr">scope</span>=<span class="hljs-string">read</span><br></code></pre></td></tr></table></figure><p>第二步，用户跳转到 B 网站，登录后同意给予 A 网站授权。这时，B 网站就会跳回<code>redirect_uri</code>参数指定的跳转网址，并且把令牌作为 URL 参数，传给 A 网站。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>a.com/callback<span class="hljs-comment">#token=ACCESS_TOKEN</span><br></code></pre></td></tr></table></figure><p>上面 URL 中，<code>token</code>参数就是令牌，A 网站因此直接在前端拿到令牌。</p><ol><li>点击链接，跳转至第三方</li><li>第三方直接把令牌给客户端</li></ol><p>注意，令牌的位置是 URL 锚点（fragment），而不是查询字符串（querystring），这是因为 OAuth 2.0 允许跳转网址是 HTTP 协议，因此存在”中间人攻击”的风险，而浏览器跳转时，锚点不会发到服务器，就减少了泄漏令牌的风险。</p><p>这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p><h4 id="3-3-密码模式（风险极大，适合于用户极其信任第三方）"><a href="#3-3-密码模式（风险极大，适合于用户极其信任第三方）" class="headerlink" title="3.3 密码模式（风险极大，适合于用户极其信任第三方）"></a>3.3 密码模式（风险极大，适合于用户极其信任第三方）</h4><p><strong>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌</strong></p><ol><li>第一步，A 网站要求用户提供 B 网站的用户名和密码。拿到以后，A 就直接向 B 请求令牌。、</li></ol><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">https</span>:<span class="hljs-string">//oauth.b.com/token?</span><br>  <span class="hljs-attr">grant_type</span>=<span class="hljs-string">password&amp;</span><br>  <span class="hljs-attr">username</span>=<span class="hljs-string">USERNAME&amp;</span><br>  <span class="hljs-attr">password</span>=<span class="hljs-string">PASSWORD&amp;</span><br>  <span class="hljs-attr">client_id</span>=<span class="hljs-string">CLIENT_ID</span><br></code></pre></td></tr></table></figure><p>上面 URL 中，<code>grant_type</code>参数是授权方式，这里的<code>password</code>表示”密码式”，<code>username</code>和<code>password</code>是 B 的用户名和密码。</p><ol start="2"><li>第二步，B 网站验证身份通过后，直接给出令牌。注意，这时不需要跳转，而是把令牌放在 JSON 数据里面，作为 HTTP 回应，A 因此拿到令牌。</li></ol><h4 id="3-4-凭证式模式（适合没有前端的第三方）"><a href="#3-4-凭证式模式（适合没有前端的第三方）" class="headerlink" title="3.4 凭证式模式（适合没有前端的第三方）"></a>3.4 凭证式模式（适合没有前端的第三方）</h4><p><strong>命令行下请求令牌。</strong>这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。</p><ol><li>第一步，A 应用在命令行向 B 发出请求。</li></ol><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">https</span>:<span class="hljs-string">//oauth.b.com/token?</span><br>  <span class="hljs-attr">grant_type</span>=<span class="hljs-string">client_credentials&amp;</span><br>  <span class="hljs-attr">client_id</span>=<span class="hljs-string">CLIENT_ID&amp;</span><br>  <span class="hljs-attr">client_secret</span>=<span class="hljs-string">CLIENT_SECRET</span><br></code></pre></td></tr></table></figure><ul><li><p><code>grant_type</code>参数等于<code>client_credentials</code>表示采用凭证式</p></li><li><p><code>client_id</code>和<code>client_secret</code>用来让 B 确认 A 的身份。</p></li></ul><ol start="2"><li>第二步，B 网站验证通过以后，直接返回令牌。</li></ol><p>适合场景：向该平台所有用户发送消息提醒</p><h2 id="四、令牌的使用"><a href="#四、令牌的使用" class="headerlink" title="四、令牌的使用"></a>四、令牌的使用</h2><p>A 网站拿到令牌以后，就可以向 B 网站的 API 请求数据了。</p><p>此时，每个发到 API 的请求，都必须带有令牌。具体做法是在请求的头信息，加上一个<code>Authorization</code>字段，令牌就放在这个字段里面。</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livescript">curl -H <span class="hljs-string">&quot;Authorization: Bearer ACCESS_TOKEN&quot;</span> <span class="hljs-string">\</span><br><span class="hljs-string">&quot;https://api.b.com&quot;</span><br></code></pre></td></tr></table></figure><p>上面命令中，<code>ACCESS_TOKEN</code>就是拿到的令牌。</p><h2 id="五、更新令牌"><a href="#五、更新令牌" class="headerlink" title="五、更新令牌"></a>五、更新令牌</h2><p>令牌的有效期到了，如果让用户重新走一遍上面的流程，再申请一个新的令牌，很可能体验不好，而且也没有必要。OAuth 2.0 允许用户自动更新令牌。</p><p>具体方法是，B 网站颁发令牌的时候，一次性颁发两个令牌，一个用于获取数据，另一个用于获取新的令牌（refresh token 字段）。令牌到期前，用户使用 refresh token 发一个请求，去更新令牌。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">https</span>:<span class="hljs-string">//b.com/oauth/token?</span><br>  <span class="hljs-attr">grant_type</span>=<span class="hljs-string">refresh_token&amp;</span><br>  <span class="hljs-attr">client_id</span>=<span class="hljs-string">CLIENT_ID&amp;</span><br>  <span class="hljs-attr">client_secret</span>=<span class="hljs-string">CLIENT_SECRET&amp;</span><br>  <span class="hljs-attr">refresh_token</span>=<span class="hljs-string">REFRESH_TOKEN</span><br></code></pre></td></tr></table></figure><p>上面 URL 中，<code>grant_type</code>参数为<code>refresh_token</code>表示要求更新令牌，<code>client_id</code>参数和<code>client_secret</code>参数用于确认身份，<code>refresh_token</code>参数就是用于更新令牌的令牌。</p><p>B 网站验证通过以后，就会颁发新的令牌。</p>]]></content>
    
    
    <categories>
      
      <category>Oauth2</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Oauth2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>zookeeper集群特性</title>
    <link href="/zookeeper%E9%9B%86%E7%BE%A4%E7%89%B9%E6%80%A7/"/>
    <url>/zookeeper%E9%9B%86%E7%BE%A4%E7%89%B9%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<hr><h2 id="1-集群的目的"><a href="#1-集群的目的" class="headerlink" title="1 集群的目的"></a>1 集群的目的</h2><p>zookeeper集群是为了保证系统的性能，能够承载更多的客户端连接。通过集群(主从模式可以实现以下功能：</p><ul><li>读写分离：提高承载，为更多的客户端提供连接，并保障性能。</li><li>主从自动切换：提高服务容错性，部分节点故障不会影响整个服务集群。</li></ul><h2 id="2-半数以上运行机制说明"><a href="#2-半数以上运行机制说明" class="headerlink" title="2 半数以上运行机制说明"></a>2 半数以上运行机制说明</h2><p>集群至少需要三台服务器，并且强烈建议使用奇数个服务器。</p><p>因为zookeeper 通过判断大多数节点的存活来判断整个服务是否可用。比如3个节点，挂掉了2个表示整个集群挂掉，而用偶数4个，挂掉了2个也表示其并不是大部分存活，因此也会挂掉。</p><h2 id="3-集群部署"><a href="#3-集群部署" class="headerlink" title="3 集群部署"></a>3 集群部署</h2><h3 id="配置语法："><a href="#配置语法：" class="headerlink" title="配置语法："></a>配置语法：</h3><p><code>server.&lt;节点ID&gt;=&lt;ip&gt;:&lt;数据同步端口&gt;:&lt;选举端口&gt;</code></p><ul><li>节点ID：服务id手动指定1至125之间的数字，并写到对应服务节点的 {dataDir}&#x2F;myid 文件中。</li><li>IP地址：节点的远程IP地址，可以相同。但生产环境就不能这么做了，因为在同一台机器就无法达到容错的目的。所以这种称作为伪集群。</li><li>数据同步端口：主从同时数据复制端口，（做伪集群时端口号不能重复）。</li><li>远举端口：主从节点选举端口，（做伪集群时端口号不能重复）。</li></ul><p><strong>配置文件示例：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tickTime</span>=<span class="hljs-number">2000</span><br><span class="hljs-attribute">dataDir</span>=/var/lib/zookeeper/<br><span class="hljs-attribute">clientPort</span>=<span class="hljs-number">2181</span><br><span class="hljs-attribute">initLimit</span>=<span class="hljs-number">5</span><br><span class="hljs-attribute">syncLimit</span>=<span class="hljs-number">2</span><br><span class="hljs-comment">#以下为集群配置，必须配置在所有节点的zoo.cfg文件中</span><br><span class="hljs-attribute">server</span>.<span class="hljs-number">1</span>=zoo<span class="hljs-number">1</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span><br><span class="hljs-attribute">server</span>.<span class="hljs-number">2</span>=zoo<span class="hljs-number">2</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span><br><span class="hljs-attribute">server</span>.<span class="hljs-number">3</span>=zoo<span class="hljs-number">3</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span><br></code></pre></td></tr></table></figure><h3 id="集群配置流程："><a href="#集群配置流程：" class="headerlink" title="集群配置流程："></a>集群配置流程：</h3><ol><li>分别创建3个data目录用于存储各节点数据</li></ol><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">mkdir</span> <span class="hljs-class"><span class="hljs-keyword">data</span></span><br><span class="hljs-title">mkdir</span> <span class="hljs-class"><span class="hljs-keyword">data</span>/1</span><br><span class="hljs-title">mkdir</span> <span class="hljs-class"><span class="hljs-keyword">data</span>/3</span><br><span class="hljs-title">mkdir</span> <span class="hljs-class"><span class="hljs-keyword">data</span>/3</span><br></code></pre></td></tr></table></figure><ol start="2"><li>编写myid文件</li></ol><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">echo</span> <span class="hljs-number">1</span> &gt; data/<span class="hljs-number">1</span>/myid<br><span class="hljs-attribute">echo</span> <span class="hljs-number">3</span> &gt; data/<span class="hljs-number">3</span>/myid<br><span class="hljs-attribute">echo</span> <span class="hljs-number">2</span> &gt; data/<span class="hljs-number">2</span>/myid<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">ls -R data<br><span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span><br><br>data/<span class="hljs-number">1</span>:<br>myid<br><br>data/<span class="hljs-number">2</span>:<br>myid<br><br>data/<span class="hljs-number">3</span>:<br>myid<br></code></pre></td></tr></table></figure><p>3、编写配置文件</p><ul><li><code>vim conf/zoo1.cfg</code></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">tickTime</span>=<span class="hljs-number">2000</span><br><span class="hljs-attr">initLimit</span>=<span class="hljs-number">10</span><br><span class="hljs-attr">syncLimit</span>=<span class="hljs-number">5</span><br><span class="hljs-attr">dataDir</span>=data/<span class="hljs-number">1</span><br><span class="hljs-attr">clientPort</span>=<span class="hljs-number">2181</span><br><span class="hljs-comment">#集群配置</span><br><span class="hljs-attr">server.1</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2887</span>:<span class="hljs-number">3887</span><br><span class="hljs-attr">server.2</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span><br><span class="hljs-attr">server.3</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2889</span>:<span class="hljs-number">3889</span><br></code></pre></td></tr></table></figure><ul><li><code>vim conf/zoo2.cfg</code></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">tickTime</span>=<span class="hljs-number">2000</span><br><span class="hljs-attr">initLimit</span>=<span class="hljs-number">10</span><br><span class="hljs-attr">syncLimit</span>=<span class="hljs-number">5</span><br><span class="hljs-attr">dataDir</span>=data/<span class="hljs-number">2</span><br><span class="hljs-attr">clientPort</span>=<span class="hljs-number">2182</span><br><span class="hljs-comment">#集群配置</span><br><span class="hljs-attr">server.1</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2887</span>:<span class="hljs-number">3887</span><br><span class="hljs-attr">server.2</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span><br><span class="hljs-attr">server.3</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2889</span>:<span class="hljs-number">3889</span><br></code></pre></td></tr></table></figure><ul><li><code>vim conf/zoo3.cfg</code></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">tickTime</span>=<span class="hljs-number">2000</span><br><span class="hljs-attr">initLimit</span>=<span class="hljs-number">10</span><br><span class="hljs-attr">syncLimit</span>=<span class="hljs-number">5</span><br><span class="hljs-attr">dataDir</span>=data/<span class="hljs-number">3</span><br><span class="hljs-attr">clientPort</span>=<span class="hljs-number">2183</span><br><span class="hljs-comment">#集群配置</span><br><span class="hljs-attr">server.1</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2887</span>:<span class="hljs-number">3887</span><br><span class="hljs-attr">server.2</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span><br><span class="hljs-attr">server.3</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2889</span>:<span class="hljs-number">3889</span><br></code></pre></td></tr></table></figure><p>4.分别启动</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">.<span class="hljs-regexp">/bin/</span>zkServer.sh start conf/zoo1.cfg<br>.<span class="hljs-regexp">/bin/</span>zkServer.sh start conf/zoo2.cfg<br>.<span class="hljs-regexp">/bin/</span>zkServer.sh start conf/zoo3.cfg<br></code></pre></td></tr></table></figure><p>5.分别查看状态</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">.<span class="hljs-regexp">/bin/</span>zkServer.sh status conf/zoo1.cfg<br>Mode: follower<br>.<span class="hljs-regexp">/bin/</span>zkServer.sh status conf/zoo2.cfg<br>Mode: follower<br>.<span class="hljs-regexp">/bin/</span>zkServer.sh status conf/zoo3.cfg<br>Mode: leader<br></code></pre></td></tr></table></figure><ol start="6"><li>进入客户端，在server1中创建节点，server 3查看节点是否同步</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">.<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>zkCli.sh <span class="hljs-operator">-</span>server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2181</span>,<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2182</span><br><br>[zk: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2181</span>,<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2182</span>(CONNECTED) <span class="hljs-number">0</span>] ls <span class="hljs-operator">/</span><br>[zookeeper]<br>[zk: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2181</span>,<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2182</span>(CONNECTED) <span class="hljs-number">1</span>] <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>e <span class="hljs-operator">-</span>s <span class="hljs-operator">/</span>tt<br>Created <span class="hljs-operator">/</span>tt0000000001<br>[zk: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2181</span>,<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2182</span>(CONNECTED) <span class="hljs-number">2</span>] ls <span class="hljs-operator">/</span><br>[tt0000000001, zookeeper]<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">.<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>zkCli.sh <span class="hljs-operator">-</span>server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2183</span><br><br>[zk: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2183</span>(CONNECTED) <span class="hljs-number">1</span>] ls <span class="hljs-operator">/</span><br>[tt0000000001, zookeeper]<br></code></pre></td></tr></table></figure><h2 id="4-集群角色说明"><a href="#4-集群角色说明" class="headerlink" title="4 集群角色说明"></a>4 集群角色说明</h2><p>zookeeper 集群中总共有三种角色，分别是leader（主节点）follower(子节点) observer（次级子节点）</p><table><thead><tr><th align="left">角色</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>leader</strong></td><td align="left">主节点，又名领导者。用于写入数据，通过选举产生，如果宕机将会选举新的主节点。</td></tr><tr><td align="left"><strong>follower</strong></td><td align="left">子节点，又名追随者。用于实现数据的读取。同时他也是主节点的备选节点，并用拥有投票权。</td></tr><tr><td align="left"><strong>observer</strong></td><td align="left">次级子节点，又名观察者。用于读取数据，与fllower区别在于没有投票权，不能选为主节点。并且在计算集群可用状态时不会将observer计算入内。</td></tr></tbody></table><p><strong>observer配置：</strong><br>只要在集群配置中加上observer后缀即可，示例如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">server</span>.<span class="hljs-number">3</span>=<span class="hljs-number">127.0.0.1:2889</span>:<span class="hljs-number">3889</span>:observer<br></code></pre></td></tr></table></figure><h2 id="5-集群选举机制"><a href="#5-集群选举机制" class="headerlink" title="5 集群选举机制"></a>5 集群选举机制</h2><p>通过 .&#x2F;bin&#x2F;zkServer.sh status &lt;zoo配置文件&gt; 命令可以查看到节点状态，可以发现中间的2182 是leader状态</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">.<span class="hljs-regexp">/bin/</span>zkServer.sh status conf/zoo1.cfg<br>Mode: follower<br>.<span class="hljs-regexp">/bin/</span>zkServer.sh status conf/zoo2.cfg<br>Mode: leader<br>.<span class="hljs-regexp">/bin/</span>zkServer.sh status conf/zoo3.cfg<br>Mode: follower<br></code></pre></td></tr></table></figure><h2 id="5-1-投票机制说明"><a href="#5-1-投票机制说明" class="headerlink" title="5.1 投票机制说明"></a>5.1 投票机制说明</h2><ol><li><p>第一轮投票全部投给自己</p></li><li><p>第二轮投票给myid比自己大的相邻节点，</p></li><li><p>如果得票超过半数，选举结束。</p></li></ol><p>其选举机制如下图：</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223714485.png" alt="image-20230228223714485"></p><h2 id="5-2-选举触发："><a href="#5-2-选举触发：" class="headerlink" title="5.2 选举触发："></a>5.2 <strong>选举触发：</strong></h2><p>当集群中的服务器出现已下两种情况时会进行Leader的选举</p><ol><li>服务节点初始化启动。当节点初始起动时会在集群中寻找Leader节点，如果找到则与Leader建立连接，其自身状态变化<strong>follower</strong>或<strong>observer。</strong>如果没有找到Leader，当前节点状态将变化LOOKING，进入选举流程。</li><li>半数以上的节点无法和Leader建立连接。在集群运行其间如果有follower或observer节点宕机只要不超过半数并不会影响整个集群服务的正常运行。但如果leader宕机，将暂停对外服务，所有follower将进入LOOKING 状态，进入选举流程。</li></ol><h2 id="5-3-数据同步机制"><a href="#5-3-数据同步机制" class="headerlink" title="5.3 数据同步机制"></a>5.3 数据同步机制</h2><p>zookeeper 的数据同步是为了保证各节点中数据的一至性，同步时涉及两个流程，一个是正常的客户端数据提交，另一个是集群某个节点宕机在恢复后的数据同步。</p><h2 id="5-3-1-客户端写入请求"><a href="#5-3-1-客户端写入请求" class="headerlink" title="5.3.1 客户端写入请求"></a>5.3.1 客户端写入请求</h2><p>当我们使用zookeeper客户端向Zookeeper 集群的某一个 Server 发送事务请求时，也就是对 Znode 节点的增删改操作时。</p><ol><li>如果该server不是leader，则会将该写请求转发给leader server，leader将请求事务以proposal（建议）形式分发给follower；</li><li>当follower收到收到leader的proposal时，根据接收的先后顺序处理proposal；</li><li>当Leader收到follower针对某个proposal过半的ack后，（即follower过半都已经同步完成）则发起事务提交，重新发起一个commit的proposal</li><li>Follower收到commit的proposal后，记录事务提交，并把数据更新到内存数据库；</li><li>当写成功后，反馈给client。</li></ol><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223852985.png" alt="image-20230228223852985"></p><h2 id="5-3-2-服务节点初始化同步"><a href="#5-3-2-服务节点初始化同步" class="headerlink" title="5.3.2 服务节点初始化同步"></a>5.3.2 服务节点初始化同步</h2><ul><li><p>在集群运行过程当中如果有一个follower节点宕机，由于宕机节点没过半，集群仍然能正常服务。</p></li><li><p>当leader 收到新的客户端请求，此时无法同步给宕机的节点。造成数据不一致。为了解决这个问题，当节点启动时，第一件事情就是找当前的Leader，比对数据是否一致。不一致则开始同步,同步完成之后在进行对外提供服务。故在节点同步数据期间，该节点不会对外提供服务。</p></li><li><p>Leader挂了后，选举leader的过程中，集群不可以对外提供服务。</p></li></ul><h1 id="6-四字运维命令"><a href="#6-四字运维命令" class="headerlink" title="6 四字运维命令"></a>6 四字运维命令</h1><p>ZooKeeper响应少量命令。每个命令由四个字母组成。可通过telnet或nc向ZooKeeper发出命令。<br>这些命令默认是关闭的，需要配置4lw.commands.whitelist来打开，可打开部分或全部示例如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#打开指定命令</span><br>4lw.commands.<span class="hljs-attribute">whitelist</span>=stat, ruok, conf, isro<br><span class="hljs-comment">#打开全部</span><br>4lw.commands.<span class="hljs-attribute">whitelist</span>=*<br><span class="hljs-comment">#查看服务器及客户端连接状态</span><br>echo stat | nc localhost 2181<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin echo stat | nc localhost <span class="hljs-number">2181</span><br>stat is not executed because it is not in the whitelist.<br><br>## 打开全部nc命令<br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin echo <span class="hljs-string">&quot;4lw.commands.whitelist=*&quot;</span> &gt;&gt; conf/zoo1.cfg<br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin echo <span class="hljs-string">&quot;4lw.commands.whitelist=*&quot;</span> &gt;&gt; conf/zoo2.cfg<br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin echo <span class="hljs-string">&quot;4lw.commands.whitelist=*&quot;</span> &gt;&gt; conf/zoo3.cfg<br><br>## 重启服务<br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin ./bin/zkServer.sh restart conf/zoo1.cfg<br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin ./bin/zkServer.sh restart conf/zoo2.cfg<br>➜  apache-zookeeper-<span class="hljs-number">3.7</span><span class="hljs-number">.0</span>-bin ./bin/zkServer.sh restart conf/zoo3.cfg<br></code></pre></td></tr></table></figure><h3 id="ZXID说明"><a href="#ZXID说明" class="headerlink" title="ZXID说明"></a>ZXID说明</h3><blockquote><p>如何比对Leader的数据版本呢，这里通过ZXID事物ID来确认。比Leader小就需要同步。</p></blockquote><ul><li><p>ZXID是一个长度64位的数字，其中低32位是按照数字递增，任何数据的变更都会导致低32位的数字加1。</p></li><li><p>高32位是leader周期编号，每当选举出一个新的leader时，新的leader就从本地事物日志中取出ZXID,然后解析出高32位的周期编号，进行加1，再将低32位的全部设置为0。这样就保证了每次新选举的leader后，保证了ZXID的唯一性而且是保证递增的。</p></li></ul><p> </p><p>eg1: 节点数据的变更</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223906822.png" alt="image-20230228223906822"></p><p>Eg2: 某个节点挂掉重新选举</p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223916530.png" alt="image-20230228223916530"></p><p><img src="https://panyuro.oss-cn-beijing.aliyuncs.com/image-20230228223927521.png" alt="image-20230228223927521"></p><p><strong>思考题：</strong><br>如果leader 节点宕机，在恢复后它还能被选为leader吗？</p><p>不会，因为它的数据不是最新的。</p>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>zookeeper客户端使用</title>
    <link href="/zookeeper%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8/"/>
    <url>/zookeeper%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="客户端API常规应用"><a href="#客户端API常规应用" class="headerlink" title="客户端API常规应用"></a>客户端API常规应用</h2><hr><p>zookeeper 提供了java与C两种语言的客户端。我们要学习的就是java客户端。引入最新的maven依赖：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>  &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;<br>  &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;<br>  &lt;version&gt;<span class="hljs-number">3.6</span><span class="hljs-number">.2</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><h2 id="初始连接"><a href="#初始连接" class="headerlink" title="初始连接"></a>初始连接</h2><p>常规的客户端类是 org.apache.zookeeper.ZooKeeper，实例化该类之后将会自动与集群建立连接。</p><ul><li>connectString    连接串，包括ip+端口 ,集群模式下用逗号隔开</li><li>sessionTimeout  会话超时时间，该值不能超过服务端所设置的 minSessionTimeout 和maxSessionTimeout</li><li>watcher 会话监听器，服务端事件将会触该监听</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">zooKeeper = <span class="hljs-keyword">new</span> ZooKeeper(<span class="hljs-string">&quot;192.168.2.103:2181&quot;</span>, <span class="hljs-number">4000</span>, <span class="hljs-keyword">new</span> Watcher() &#123;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;init:&quot;</span>+watchedEvent.getPath());<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="创建、查看节点"><a href="#创建、查看节点" class="headerlink" title="创建、查看节点"></a>创建、查看节点</h2><h3 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h3><p>通过org.apache.zookeeper.ZooKeeper#create()即可创建节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>  List&lt;ACL&gt; aclList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  <span class="hljs-keyword">int</span> perm = ZooDefs.Perms.ADMIN | ZooDefs.Perms.READ;<br>  <br>  <span class="hljs-comment">// perms 对应权限位permission</span><br>  <span class="hljs-comment">// id 对应权限模式scheme + id</span><br>  ACL acl1 = <span class="hljs-keyword">new</span> ACL(perm, <span class="hljs-keyword">new</span> Id(<span class="hljs-string">&quot;world&quot;</span>,<span class="hljs-string">&quot;anyone&quot;</span>));<br>  ACL acl2 = <span class="hljs-keyword">new</span> ACL(perm, <span class="hljs-keyword">new</span> Id(<span class="hljs-string">&quot;ip&quot;</span>,<span class="hljs-string">&quot;192.168.2.103&quot;</span>));<br>  ACL acl3 = <span class="hljs-keyword">new</span> ACL(perm, <span class="hljs-keyword">new</span> Id(<span class="hljs-string">&quot;ip&quot;</span>,<span class="hljs-string">&quot;127.0.0.1&quot;</span>));<br><br>  aclList.add(acl1);<br>  aclList.add(acl2);<br>  aclList.add(acl3);<br>  zooKeeper.create(<span class="hljs-string">&quot;/hello&quot;</span>, <span class="hljs-string">&quot;hello word!&quot;</span>.getBytes(), aclList, CreateMode.PERSISTENT);<br>&#125;<br></code></pre></td></tr></table></figure><p>运行完成后，在zookeeper进行查看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">[zk: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">64</span>] getAcl /hello<br><span class="hljs-string">&#x27;world,&#x27;</span>anyone<br>: ra<br><span class="hljs-string">&#x27;ip,&#x27;</span><span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.103</span><br>: ra<br><span class="hljs-string">&#x27;ip,&#x27;</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>: ra<br>[zk: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">2181</span>(CONNECTED) <span class="hljs-number">65</span>] get /hello<br>hello word<br></code></pre></td></tr></table></figure><h3 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h3><h4 id="查看当前节点"><a href="#查看当前节点" class="headerlink" title="查看当前节点"></a>查看当前节点</h4><p>通过org.apache.zookeeper.ZooKeeper#getData()即可查看节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>  <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] keeperData = zooKeeper.getData(<span class="hljs-string">&quot;/pyr&quot;</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>  System.out.println(<span class="hljs-string">&quot;testData:&quot;</span> + <span class="hljs-keyword">new</span> String(keeperData));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="查看子节点"><a href="#查看子节点" class="headerlink" title="查看子节点"></a>查看子节点</h4><p>通过org.apache.zookeeper.ZooKeeper#getChildren()即可获取子节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetChildrenWithoutWatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>  <span class="hljs-keyword">final</span> List&lt;String&gt; children = zooKeeper.getChildren(<span class="hljs-string">&quot;/pyr&quot;</span>, <span class="hljs-keyword">false</span>);<br>  children.stream().forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="监听节点"><a href="#监听节点" class="headerlink" title="监听节点"></a>监听节点</h2><ul><li><p>在getData() 与getChildren()两个方法中可分别设置监听数据变化和子节点变化。</p></li><li><p>通过设置watch为true，当前事件触发时会调用zookeeper()构建函数中Watcher.process()方法。也可以添加watcher参数来实现自定义监听。一般采用后者。</p></li><li><p>所有的监听都是一次性的，如果要持续监听需要触发后在添加一次监听。</p></li></ul><p><strong>使用默认监听</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetDataWithWatcher</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>  <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] keeperData = zooKeeper.getData(<span class="hljs-string">&quot;/pyr&quot;</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">null</span>);<br>  System.out.println(<span class="hljs-string">&quot;testGetDataWithWatcher:&quot;</span> + <span class="hljs-keyword">new</span> String(keeperData));<br>  Thread.sleep(Long.MAX_VALUE);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>自定义监听</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetDataWithCustomWatcher</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>  <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] keeperData = zooKeeper.getData(<span class="hljs-string">&quot;/pyr&quot;</span>, <span class="hljs-keyword">new</span> Watcher() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> </span>&#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        zooKeeper.getData(<span class="hljs-string">&quot;/temp&quot;</span>, <span class="hljs-keyword">this</span>, <span class="hljs-keyword">null</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (KeeperException | InterruptedException e) &#123;<br>        e.printStackTrace();<br>      &#125;<br>      System.out.println(<span class="hljs-string">&quot;testGetDataWithCustomWatcher:&quot;</span> + watchedEvent.getPath());<br><br>    &#125;<br>  &#125;, <span class="hljs-keyword">null</span>);<br>  Thread.sleep(Long.MAX_VALUE);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="第三方客户端ZkClient"><a href="#第三方客户端ZkClient" class="headerlink" title="第三方客户端ZkClient"></a>第三方客户端ZkClient</h2><p>zkClient 是在zookeeper客户端基础之上封装的，使用上更加友好。主要变化如下：</p><ul><li>可以设置持久监听，或删除某个监听</li><li>可以插入JAVA对象，自动进行序列化和反序列化</li><li>简化了基本的增删改查操作。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Zookeeper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式框架</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
